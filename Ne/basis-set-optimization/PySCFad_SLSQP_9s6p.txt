#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.0968187         1
[INPUT] 0    0    [1    /1   ]  617.498599923        1
[INPUT] 0    0    [1    /1   ]  174.90601681         1
[INPUT] 0    0    [1    /1   ]  20.4948782521        1
[INPUT] 0    0    [1    /1   ]  56.9617567584        1
[INPUT] 0    0    [1    /1   ]  0.487430605889       1
[INPUT] 0    0    [1    /1   ]  7.82750196851        1
[INPUT] 0    0    [1    /1   ]  1.65422572399        1
[INPUT] 1    0    [1    /1   ]  3.68193862965        1
[INPUT] 1    0    [1    /1   ]  12.4401062697        1
[INPUT] 1    0    [1    /1   ]  54.752648301         1
[INPUT] 1    0    [1    /1   ]  0.330845310349       1
[INPUT] 1    0    [1    /1   ]  1.14437726912        1
[INPUT] 1    0    [1    /1   ]  0.5                  1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730068942, 1.0]], [0, [2712.096818701675, 1.0]], [0, [617.4985999230122, 1.0]], [0, [174.9060168103256, 1.0]], [0, [20.494878252052462, 1.0]], [0, [56.96175675843163, 1.0]], [0, [0.4874306058886835, 1.0]], [0, [7.82750196851329, 1.0]], [0, [1.6542257239856788, 1.0]], [1, [3.6819386296497383, 1.0]], [1, [12.440106269745918, 1.0]], [1, [54.752648300984625, 1.0]], [1, [0.3308453103493317, 1.0]], [1, [1.1443772691236038, 1.0]], [1, [0.5, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.0968187]
bas 2, expnt(s) = [617.49859992]
bas 3, expnt(s) = [174.90601681]
bas 4, expnt(s) = [20.49487825]
bas 5, expnt(s) = [56.96175676]
bas 6, expnt(s) = [0.48743061]
bas 7, expnt(s) = [7.82750197]
bas 8, expnt(s) = [1.65422572]
bas 9, expnt(s) = [3.68193863]
bas 10, expnt(s) = [12.44010627]
bas 11, expnt(s) = [54.7526483]
bas 12, expnt(s) = [0.33084531]
bas 13, expnt(s) = [1.14437727]
bas 14, expnt(s) = [0.5]
CPU time:         1.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906017e+02 1.21511837e+02
 2.04948783e+01 2.43359907e+01 5.69617568e+01 5.23844701e+01
 4.87430606e-01 1.47383756e+00 7.82750197e+00 1.18231286e+01
 1.65422572e+00 3.68520033e+00 3.68193863e+00 1.48792169e+01
 1.24401063e+01 6.81576339e+01 5.47526483e+01 4.34501025e+02
 3.30845310e-01 7.32007653e-01 1.14437727e+00 3.45299477e+00
 5.00000000e-01 1.22658288e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998015676870843
cond(S) = 325.7532865108946
E1 = -183.57466382822508  E_coul = 55.07978288198817
init E= -128.494880946237
    CPU time for initialize scf      0.12 sec, wall time      0.12 sec
  HOMO = -0.773876182733408  LUMO = 0.771492370805583
  mo_energy =
[-3.25545019e+01 -1.85135721e+00 -7.73876183e-01 -7.73876183e-01
 -7.73876183e-01  7.71492371e-01  7.71492371e-01  7.71492371e-01
  2.06094029e+00  2.63925106e+00  2.63925106e+00  2.63925106e+00
  7.45839012e+00  7.45839012e+00  7.45839012e+00  1.94435846e+01
  2.55594938e+01  2.55594938e+01  2.55594938e+01  9.39007241e+01
  1.19931572e+02  1.19931572e+02  1.19931572e+02  3.56250130e+02
  1.34961970e+03  5.83606151e+03  3.50986752e+04]
E1 = -182.12266195327686  E_coul = 53.59767060117638
cycle= 1 E= -128.5249913521  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.171
    CPU time for cycle= 1      0.26 sec, wall time      0.27 sec
diis-norm(errvec)=0.543977
diis-c [-0.29591137  1.        ]
  HOMO = -0.878073672123735  LUMO = 0.753244459224809
  mo_energy =
[-3.28714265e+01 -1.96052024e+00 -8.78073672e-01 -8.78073672e-01
 -8.78073672e-01  7.53244459e-01  7.53244459e-01  7.53244459e-01
  1.98744796e+00  2.58818854e+00  2.58818854e+00  2.58818854e+00
  7.33788915e+00  7.33788915e+00  7.33788915e+00  1.92275335e+01
  2.53303451e+01  2.53303451e+01  2.53303451e+01  9.36024924e+01
  1.19613056e+02  1.19613056e+02  1.19613056e+02  3.55904213e+02
  1.34923548e+03  5.83564540e+03  3.50982374e+04]
E1 = -182.8553044358513  E_coul = 54.327814989657945
cycle= 2 E= -128.527489446193  delta_E= -0.0025  |g|= 0.0996  |ddm|= 0.0967
    CPU time for cycle= 2      0.09 sec, wall time      0.09 sec
diis-norm(errvec)=0.27067
diis-c [-5.67347433e-04  3.31605143e-01  6.68394857e-01]
  HOMO = -0.843624418032871  LUMO = 0.759637877976388
  mo_energy =
[-3.27665319e+01 -1.92418951e+00 -8.43624418e-01 -8.43624418e-01
 -8.43624418e-01  7.59637878e-01  7.59637878e-01  7.59637878e-01
  2.01189962e+00  2.60518050e+00  2.60518050e+00  2.60518050e+00
  7.37764980e+00  7.37764980e+00  7.37764980e+00  1.92995452e+01
  2.54065327e+01  2.54065327e+01  2.54065327e+01  9.37015187e+01
  1.19717774e+02  1.19717774e+02  1.19717774e+02  3.56015796e+02
  1.34935321e+03  5.83576605e+03  3.50983592e+04]
E1 = -182.61145643928094  E_coul = 54.083129518924046
cycle= 3 E= -128.528326920357  delta_E= -0.000837  |g|= 0.000391  |ddm|= 0.0302
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000938712
diis-c [-1.15125817e-07 -1.86751521e-03 -5.17096952e-04  1.00238461e+00]
  HOMO = -0.84373151350036  LUMO = 0.759661942655066
  mo_energy =
[-3.27667932e+01 -1.92421979e+00 -8.43731514e-01 -8.43731514e-01
 -8.43731514e-01  7.59661943e-01  7.59661943e-01  7.59661943e-01
  2.01192984e+00  2.60518329e+00  2.60518329e+00  2.60518329e+00
  7.37759170e+00  7.37759170e+00  7.37759170e+00  1.92994226e+01
  2.54063736e+01  2.54063736e+01  2.54063736e+01  9.37012846e+01
  1.19717501e+02  1.19717501e+02  1.19717501e+02  3.56015449e+02
  1.34935273e+03  5.83576546e+03  3.50983586e+04]
E1 = -182.6119471209245  E_coul = 54.083620182377295
cycle= 4 E= -128.528326938547  delta_E= -1.82e-08  |g|= 6.56e-05  |ddm|= 0.000573
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000171413
diis-c [-1.02194198e-09  2.52558891e-04  6.03146359e-04 -1.87810927e-01
  1.18695522e+00]
  HOMO = -0.843746654449807  LUMO = 0.759661337345341
  mo_energy =
[-3.27668343e+01 -1.92422097e+00 -8.43746654e-01 -8.43746654e-01
 -8.43746654e-01  7.59661337e-01  7.59661337e-01  7.59661337e-01
  2.01193159e+00  2.60517861e+00  2.60517861e+00  2.60517861e+00
  7.37757658e+00  7.37757658e+00  7.37757658e+00  1.92993984e+01
  2.54063439e+01  2.54063439e+01  2.54063439e+01  9.37012462e+01
  1.19717459e+02  1.19717459e+02  1.19717459e+02  3.56015400e+02
  1.34935267e+03  5.83576539e+03  3.50983585e+04]
E1 = -182.61208804402852  E_coul = 54.08376110478332
cycle= 5 E= -128.528326939245  delta_E= -6.98e-10  |g|= 4.57e-06  |ddm|= 0.000107
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61208804402852  E_coul = 54.08376110478332
  HOMO = -0.843744709929088  LUMO = 0.759661763815514
  mo_energy =
[-3.27668307e+01 -1.92421813e+00 -8.43744710e-01 -8.43744710e-01
 -8.43744710e-01  7.59661764e-01  7.59661764e-01  7.59661764e-01
  2.01193381e+00  2.60517978e+00  2.60517978e+00  2.60517978e+00
  7.37757892e+00  7.37757892e+00  7.37757892e+00  1.92994020e+01
  2.54063474e+01  2.54063474e+01  2.54063474e+01  9.37012498e+01
  1.19717463e+02  1.19717463e+02  1.19717463e+02  3.56015403e+02
  1.34935267e+03  5.83576539e+03  3.50983585e+04]
E1 = -182.6120802577478  E_coul = 54.08375331850046
Extra cycle  E= -128.528326939247  delta_E= -2.13e-12  |g|= 1.23e-06  |ddm|= 2.59e-06
    CPU time for scf_cycle      0.52 sec, wall time      0.53 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906017e+02
 2.04948783e+01 5.69617568e+01 4.87430606e-01 7.82750197e+00
 1.65422572e+00 3.68193863e+00 1.24401063e+01 5.47526483e+01
 3.30845310e-01 1.14437727e+00 5.00000000e-01]
E = -128.52832693924734
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.0968187         1
[INPUT] 0    0    [1    /1   ]  617.498599923        1
[INPUT] 0    0    [1    /1   ]  174.90601681         1
[INPUT] 0    0    [1    /1   ]  20.4948782521        1
[INPUT] 0    0    [1    /1   ]  56.9617567584        1
[INPUT] 0    0    [1    /1   ]  0.487430605889       1
[INPUT] 0    0    [1    /1   ]  7.82750196851        1
[INPUT] 0    0    [1    /1   ]  1.65422572399        1
[INPUT] 1    0    [1    /1   ]  3.68193862965        1
[INPUT] 1    0    [1    /1   ]  12.4401062697        1
[INPUT] 1    0    [1    /1   ]  54.752648301         1
[INPUT] 1    0    [1    /1   ]  0.330845310349       1
[INPUT] 1    0    [1    /1   ]  1.14437726912        1
[INPUT] 1    0    [1    /1   ]  0.5                  1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730068942, 1.0]], [0, [2712.096818701675, 1.0]], [0, [617.4985999230122, 1.0]], [0, [174.9060168103256, 1.0]], [0, [20.494878252052462, 1.0]], [0, [56.96175675843163, 1.0]], [0, [0.4874306058886835, 1.0]], [0, [7.82750196851329, 1.0]], [0, [1.6542257239856788, 1.0]], [1, [3.6819386296497383, 1.0]], [1, [12.440106269745918, 1.0]], [1, [54.752648300984625, 1.0]], [1, [0.3308453103493317, 1.0]], [1, [1.1443772691236038, 1.0]], [1, [0.5, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.0968187]
bas 2, expnt(s) = [617.49859992]
bas 3, expnt(s) = [174.90601681]
bas 4, expnt(s) = [20.49487825]
bas 5, expnt(s) = [56.96175676]
bas 6, expnt(s) = [0.48743061]
bas 7, expnt(s) = [7.82750197]
bas 8, expnt(s) = [1.65422572]
bas 9, expnt(s) = [3.68193863]
bas 10, expnt(s) = [12.44010627]
bas 11, expnt(s) = [54.7526483]
bas 12, expnt(s) = [0.33084531]
bas 13, expnt(s) = [1.14437727]
bas 14, expnt(s) = [0.5]
CPU time:         1.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906017e+02 1.21511837e+02
 2.04948783e+01 2.43359907e+01 5.69617568e+01 5.23844701e+01
 4.87430606e-01 1.47383756e+00 7.82750197e+00 1.18231286e+01
 1.65422572e+00 3.68520033e+00 3.68193863e+00 1.48792169e+01
 1.24401063e+01 6.81576339e+01 5.47526483e+01 4.34501025e+02
 3.30845310e-01 7.32007653e-01 1.14437727e+00 3.45299477e+00
 5.00000000e-01 1.22658288e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998015676870843
cond(S) = 325.7532865108946
E1 = -183.57466382822508  E_coul = 55.07978288198817
init E= -128.494880946237
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.773876182733408  LUMO = 0.771492370805583
  mo_energy =
[-3.25545019e+01 -1.85135721e+00 -7.73876183e-01 -7.73876183e-01
 -7.73876183e-01  7.71492371e-01  7.71492371e-01  7.71492371e-01
  2.06094029e+00  2.63925106e+00  2.63925106e+00  2.63925106e+00
  7.45839012e+00  7.45839012e+00  7.45839012e+00  1.94435846e+01
  2.55594938e+01  2.55594938e+01  2.55594938e+01  9.39007241e+01
  1.19931572e+02  1.19931572e+02  1.19931572e+02  3.56250130e+02
  1.34961970e+03  5.83606151e+03  3.50986752e+04]
E1 = -182.12266195327686  E_coul = 53.59767060117638
cycle= 1 E= -128.5249913521  delta_E= -0.0301  |g|=  0.2  |ddm|= 0.171
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.543977
diis-c [-0.29591137  1.        ]
  HOMO = -0.878073672123735  LUMO = 0.753244459224809
  mo_energy =
[-3.28714265e+01 -1.96052024e+00 -8.78073672e-01 -8.78073672e-01
 -8.78073672e-01  7.53244459e-01  7.53244459e-01  7.53244459e-01
  1.98744796e+00  2.58818854e+00  2.58818854e+00  2.58818854e+00
  7.33788915e+00  7.33788915e+00  7.33788915e+00  1.92275335e+01
  2.53303451e+01  2.53303451e+01  2.53303451e+01  9.36024924e+01
  1.19613056e+02  1.19613056e+02  1.19613056e+02  3.55904213e+02
  1.34923548e+03  5.83564540e+03  3.50982374e+04]
E1 = -182.8553044358513  E_coul = 54.327814989657945
cycle= 2 E= -128.527489446193  delta_E= -0.0025  |g|= 0.0996  |ddm|= 0.0967
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27067
diis-c [-5.67347433e-04  3.31605143e-01  6.68394857e-01]
  HOMO = -0.843624418032871  LUMO = 0.759637877976388
  mo_energy =
[-3.27665319e+01 -1.92418951e+00 -8.43624418e-01 -8.43624418e-01
 -8.43624418e-01  7.59637878e-01  7.59637878e-01  7.59637878e-01
  2.01189962e+00  2.60518050e+00  2.60518050e+00  2.60518050e+00
  7.37764980e+00  7.37764980e+00  7.37764980e+00  1.92995452e+01
  2.54065327e+01  2.54065327e+01  2.54065327e+01  9.37015187e+01
  1.19717774e+02  1.19717774e+02  1.19717774e+02  3.56015796e+02
  1.34935321e+03  5.83576605e+03  3.50983592e+04]
E1 = -182.61145643928094  E_coul = 54.083129518924046
cycle= 3 E= -128.528326920357  delta_E= -0.000837  |g|= 0.000391  |ddm|= 0.0302
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000938712
diis-c [-1.15125817e-07 -1.86751521e-03 -5.17096952e-04  1.00238461e+00]
  HOMO = -0.84373151350036  LUMO = 0.759661942655066
  mo_energy =
[-3.27667932e+01 -1.92421979e+00 -8.43731514e-01 -8.43731514e-01
 -8.43731514e-01  7.59661943e-01  7.59661943e-01  7.59661943e-01
  2.01192984e+00  2.60518329e+00  2.60518329e+00  2.60518329e+00
  7.37759170e+00  7.37759170e+00  7.37759170e+00  1.92994226e+01
  2.54063736e+01  2.54063736e+01  2.54063736e+01  9.37012846e+01
  1.19717501e+02  1.19717501e+02  1.19717501e+02  3.56015449e+02
  1.34935273e+03  5.83576546e+03  3.50983586e+04]
E1 = -182.6119471209245  E_coul = 54.083620182377295
cycle= 4 E= -128.528326938547  delta_E= -1.82e-08  |g|= 6.56e-05  |ddm|= 0.000573
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000171413
diis-c [-1.02194198e-09  2.52558891e-04  6.03146359e-04 -1.87810927e-01
  1.18695522e+00]
  HOMO = -0.843746654449807  LUMO = 0.759661337345341
  mo_energy =
[-3.27668343e+01 -1.92422097e+00 -8.43746654e-01 -8.43746654e-01
 -8.43746654e-01  7.59661337e-01  7.59661337e-01  7.59661337e-01
  2.01193159e+00  2.60517861e+00  2.60517861e+00  2.60517861e+00
  7.37757658e+00  7.37757658e+00  7.37757658e+00  1.92993984e+01
  2.54063439e+01  2.54063439e+01  2.54063439e+01  9.37012462e+01
  1.19717459e+02  1.19717459e+02  1.19717459e+02  3.56015400e+02
  1.34935267e+03  5.83576539e+03  3.50983585e+04]
E1 = -182.61208804402852  E_coul = 54.08376110478332
cycle= 5 E= -128.528326939245  delta_E= -6.98e-10  |g|= 4.57e-06  |ddm|= 0.000107
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.61208804402852  E_coul = 54.08376110478332
  HOMO = -0.843744709929088  LUMO = 0.759661763815514
  mo_energy =
[-3.27668307e+01 -1.92421813e+00 -8.43744710e-01 -8.43744710e-01
 -8.43744710e-01  7.59661764e-01  7.59661764e-01  7.59661764e-01
  2.01193381e+00  2.60517978e+00  2.60517978e+00  2.60517978e+00
  7.37757892e+00  7.37757892e+00  7.37757892e+00  1.92994020e+01
  2.54063474e+01  2.54063474e+01  2.54063474e+01  9.37012498e+01
  1.19717463e+02  1.19717463e+02  1.19717463e+02  3.56015403e+02
  1.34935267e+03  5.83576539e+03  3.50983585e+04]
E1 = -182.6120802577478  E_coul = 54.08375331850046
Extra cycle  E= -128.528326939247  delta_E= -2.13e-12  |g|= 1.23e-06  |ddm|= 2.59e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 325.7532865108946
E1 = -182.6120802577478  E_coul = 54.08375331850046
init E= -128.528326939247
    CPU time for initialize scf      0.51 sec, wall time      0.60 sec
  HOMO = -0.843745266478717  LUMO = 0.759661672888641
  mo_energy =
[-3.27668325e+01 -1.92421855e+00 -8.43745266e-01 -8.43745266e-01
 -8.43745266e-01  7.59661673e-01  7.59661673e-01  7.59661673e-01
  2.01193357e+00  2.60517954e+00  2.60517954e+00  2.60517954e+00
  7.37757830e+00  7.37757830e+00  7.37757830e+00  1.92994009e+01
  2.54063461e+01  2.54063461e+01  2.54063461e+01  9.37012481e+01
  1.19717461e+02  1.19717461e+02  1.19717461e+02  3.56015401e+02
  1.34935267e+03  5.83576539e+03  3.50983585e+04]
E1 = -182.6120848116062  E_coul = 54.08375787235849
cycle= 1 E= -128.528326939248  delta_E= -3.69e-13  |g|= 6.37e-07  |ddm|= 8.81e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.6120848116062  E_coul = 54.08375787235849
  HOMO = -0.843744948649333  LUMO = 0.759661734085676
  mo_energy =
[-3.27668315e+01 -1.92421818e+00 -8.43744949e-01 -8.43744949e-01
 -8.43744949e-01  7.59661734e-01  7.59661734e-01  7.59661734e-01
  2.01193382e+00  2.60517970e+00  2.60517970e+00  2.60517970e+00
  7.37757867e+00  7.37757867e+00  7.37757867e+00  1.92994016e+01
  2.54063468e+01  2.54063468e+01  2.54063468e+01  9.37012490e+01
  1.19717462e+02  1.19717462e+02  1.19717462e+02  3.56015402e+02
  1.34935267e+03  5.83576539e+03  3.50983585e+04]
E1 = -182.61208264019425  E_coul = 54.08375570094676
Extra cycle  E= -128.528326939247  delta_E= 2.27e-13  |g|= 2.95e-07  |ddm|= 2.77e-07
    CPU time for scf_cycle      1.31 sec, wall time      1.40 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906017e+02
 2.04948783e+01 5.69617568e+01 4.87430606e-01 7.82750197e+00
 1.65422572e+00 3.68193863e+00 1.24401063e+01 5.47526483e+01
 3.30845310e-01 1.14437727e+00 5.00000000e-01]
grad_E = [-1.93362455e-11  1.26180586e-09 -3.02476327e-08  4.49725576e-07
  4.75434000e-06 -3.60473424e-06 -5.04429640e-05  3.65827280e-06
 -3.88160010e-05  2.21119656e-03 -2.02684317e-04  6.71508753e-06
  2.66682780e-02 -1.16055491e-02 -2.43767528e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.0968187         1
[INPUT] 0    0    [1    /1   ]  617.498599953        1
[INPUT] 0    0    [1    /1   ]  174.906016361        1
[INPUT] 0    0    [1    /1   ]  20.4948734977        1
[INPUT] 0    0    [1    /1   ]  56.9617603632        1
[INPUT] 0    0    [1    /1   ]  0.487481048853       1
[INPUT] 0    0    [1    /1   ]  7.82749831024        1
[INPUT] 0    0    [1    /1   ]  1.65426453999        1
[INPUT] 1    0    [1    /1   ]  3.67972743309        1
[INPUT] 1    0    [1    /1   ]  12.4403089541        1
[INPUT] 1    0    [1    /1   ]  54.7526415859        1
[INPUT] 1    0    [1    /1   ]  0.304177032335       1
[INPUT] 1    0    [1    /1   ]  1.15598281825        1
[INPUT] 1    0    [1    /1   ]  0.500243767528       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873006896, 1.0]], [0, [2712.096818700413, 1.0]], [0, [617.4985999532598, 1.0]], [0, [174.90601636060003, 1.0]], [0, [20.49487349771246, 1.0]], [0, [56.96176036316587, 1.0]], [0, [0.4874810488527115, 1.0]], [0, [7.827498310240493, 1.0]], [0, [1.6542645399866878, 1.0]], [1, [3.6797274330867618, 1.0]], [1, [12.440308954062848, 1.0]], [1, [54.7526415858971, 1.0]], [1, [0.3041770323353102, 1.0]], [1, [1.1559828182503882, 1.0]], [1, [0.5002437675275084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.0968187]
bas 2, expnt(s) = [617.49859995]
bas 3, expnt(s) = [174.90601636]
bas 4, expnt(s) = [20.4948735]
bas 5, expnt(s) = [56.96176036]
bas 6, expnt(s) = [0.48748105]
bas 7, expnt(s) = [7.82749831]
bas 8, expnt(s) = [1.65426454]
bas 9, expnt(s) = [3.67972743]
bas 10, expnt(s) = [12.44030895]
bas 11, expnt(s) = [54.75264159]
bas 12, expnt(s) = [0.30417703]
bas 13, expnt(s) = [1.15598282]
bas 14, expnt(s) = [0.50024377]
CPU time:         7.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906016e+02 1.21511837e+02
 2.04948735e+01 2.43359865e+01 5.69617604e+01 5.23844726e+01
 4.87481049e-01 1.47395195e+00 7.82749831e+00 1.18231245e+01
 1.65426454e+00 3.68526519e+00 3.67972743e+00 1.48680480e+01
 1.24403090e+01 6.81590220e+01 5.47526416e+01 4.34500958e+02
 3.04177032e-01 6.59010623e-01 1.15598282e+00 3.49682273e+00
 5.00243768e-01 1.22733043e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998384162852231
cond(S) = 239.67481505128197
E1 = -183.57563006114626  E_coul = 55.07968940085626
init E= -128.49594066029
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77405174144718  LUMO = 0.730939287383828
  mo_energy =
[-3.25545129e+01 -1.85136324e+00 -7.74051741e-01 -7.74051741e-01
 -7.74051741e-01  7.30939287e-01  7.30939287e-01  7.30939287e-01
  2.06113447e+00  2.56259180e+00  2.56259180e+00  2.56259180e+00
  7.38686187e+00  7.38686187e+00  7.38686187e+00  1.94439958e+01
  2.55087653e+01  2.55087653e+01  2.55087653e+01  9.39010611e+01
  1.19898364e+02  1.19898364e+02  1.19898364e+02  3.56250414e+02
  1.34961996e+03  5.83606176e+03  3.50986754e+04]
E1 = -182.10160922828737  E_coul = 53.5758769079951
cycle= 1 E= -128.525732320292  delta_E= -0.0298  |g|= 0.202  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.547021
diis-c [-0.29923188  1.        ]
  HOMO = -0.879943267481292  LUMO = 0.713229329421666
  mo_energy =
[-3.28752029e+01 -1.96247793e+00 -8.79943267e-01 -8.79943267e-01
 -8.79943267e-01  7.13229329e-01  7.13229329e-01  7.13229329e-01
  1.98613781e+00  2.51071370e+00  2.51071370e+00  2.51071370e+00
  7.26383551e+00  7.26383551e+00  7.26383551e+00  1.92248784e+01
  2.52763373e+01  2.52763373e+01  2.52763373e+01  9.35991829e+01
  1.19576098e+02  1.19576098e+02  1.19576098e+02  3.55900655e+02
  1.34923182e+03  5.83564171e+03  3.50982337e+04]
E1 = -182.8474005091924  E_coul = 54.319108751554026
cycle= 2 E= -128.528291757638  delta_E= -0.00256  |g|= 0.101  |ddm|= 0.0808
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273605
diis-c [-5.73249874e-04  3.32769673e-01  6.67230327e-01]
  HOMO = -0.844917322732729  LUMO = 0.719373997260644
  mo_energy =
[-3.27687012e+01 -1.92552527e+00 -8.44917323e-01 -8.44917323e-01
 -8.44917323e-01  7.19373997e-01  7.19373997e-01  7.19373997e-01
  2.01102063e+00  2.52791423e+00  2.52791423e+00  2.52791423e+00
  7.30443723e+00  7.30443723e+00  7.30443723e+00  1.92980432e+01
  2.53537914e+01  2.53537914e+01  2.53537914e+01  9.36997345e+01
  1.19682423e+02  1.19682423e+02  1.19682423e+02  3.56013926e+02
  1.34935132e+03  5.83576415e+03  3.50983573e+04]
E1 = -182.5982337728659  E_coul = 54.06907193359665
cycle= 3 E= -128.529161839269  delta_E= -0.00087  |g|= 0.000348  |ddm|= 0.0266
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000907302
diis-c [-9.20751730e-08 -1.81692737e-03 -5.05246738e-04  1.00232217e+00]
  HOMO = -0.845035452489035  LUMO = 0.719391826230326
  mo_energy =
[-3.27689768e+01 -1.92557579e+00 -8.45035452e-01 -8.45035452e-01
 -8.45035452e-01  7.19391826e-01  7.19391826e-01  7.19391826e-01
  2.01103361e+00  2.52790781e+00  2.52790781e+00  2.52790781e+00
  7.30436583e+00  7.30436583e+00  7.30436583e+00  1.92979053e+01
  2.53536182e+01  2.53536182e+01  2.53536182e+01  9.36994857e+01
  1.19682135e+02  1.19682135e+02  1.19682135e+02  3.56013565e+02
  1.34935083e+03  5.83576355e+03  3.50983566e+04]
E1 = -182.59867613862562  E_coul = 54.06951428738828
cycle= 4 E= -128.529161851237  delta_E= -1.2e-08  |g|= 5.94e-05  |ddm|= 0.000289
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000167551
diis-c [-8.75978241e-10  2.00192260e-04  5.65374126e-04 -1.64708263e-01
  1.16394270e+00]
  HOMO = -0.845053807766144  LUMO = 0.719389880652076
  mo_energy =
[-3.27690217e+01 -1.92558324e+00 -8.45053808e-01 -8.45053808e-01
 -8.45053808e-01  7.19389881e-01  7.19389881e-01  7.19389881e-01
  2.01102981e+00  2.52790026e+00  2.52790026e+00  2.52790026e+00
  7.30434645e+00  7.30434645e+00  7.30434645e+00  1.92978758e+01
  2.53535840e+01  2.53535840e+01  2.53535840e+01  9.36994433e+01
  1.19682090e+02  1.19682090e+02  1.19682090e+02  3.56013513e+02
  1.34935077e+03  5.83576348e+03  3.50983565e+04]
E1 = -182.5988122422759  E_coul = 54.069650390545476
cycle= 5 E= -128.52916185173  delta_E= -4.93e-10  |g|= 4.22e-06  |ddm|= 5.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5988122422759  E_coul = 54.069650390545476
  HOMO = -0.845052128039858  LUMO = 0.719390258964138
  mo_energy =
[-3.27690187e+01 -1.92558067e+00 -8.45052128e-01 -8.45052128e-01
 -8.45052128e-01  7.19390259e-01  7.19390259e-01  7.19390259e-01
  2.01103183e+00  2.52790130e+00  2.52790130e+00  2.52790130e+00
  7.30434849e+00  7.30434849e+00  7.30434849e+00  1.92978790e+01
  2.53535870e+01  2.53535870e+01  2.53535870e+01  9.36994464e+01
  1.19682093e+02  1.19682093e+02  1.19682093e+02  3.56013516e+02
  1.34935077e+03  5.83576348e+03  3.50983565e+04]
E1 = -182.59880605594722  E_coul = 54.06964420421495
Extra cycle  E= -128.529161851732  delta_E= -1.88e-12  |g|= 1.06e-06  |ddm|= 2.72e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906016e+02
 2.04948735e+01 5.69617604e+01 4.87481049e-01 7.82749831e+00
 1.65426454e+00 3.67972743e+00 1.24403090e+01 5.47526416e+01
 3.04177032e-01 1.15598282e+00 5.00243768e-01]
E = -128.52916185173228
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.0968187         1
[INPUT] 0    0    [1    /1   ]  617.498599953        1
[INPUT] 0    0    [1    /1   ]  174.906016361        1
[INPUT] 0    0    [1    /1   ]  20.4948734977        1
[INPUT] 0    0    [1    /1   ]  56.9617603632        1
[INPUT] 0    0    [1    /1   ]  0.487481048853       1
[INPUT] 0    0    [1    /1   ]  7.82749831024        1
[INPUT] 0    0    [1    /1   ]  1.65426453999        1
[INPUT] 1    0    [1    /1   ]  3.67972743309        1
[INPUT] 1    0    [1    /1   ]  12.4403089541        1
[INPUT] 1    0    [1    /1   ]  54.7526415859        1
[INPUT] 1    0    [1    /1   ]  0.304177032335       1
[INPUT] 1    0    [1    /1   ]  1.15598281825        1
[INPUT] 1    0    [1    /1   ]  0.500243767528       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873006896, 1.0]], [0, [2712.096818700413, 1.0]], [0, [617.4985999532598, 1.0]], [0, [174.90601636060003, 1.0]], [0, [20.49487349771246, 1.0]], [0, [56.96176036316587, 1.0]], [0, [0.4874810488527115, 1.0]], [0, [7.827498310240493, 1.0]], [0, [1.6542645399866878, 1.0]], [1, [3.6797274330867618, 1.0]], [1, [12.440308954062848, 1.0]], [1, [54.7526415858971, 1.0]], [1, [0.3041770323353102, 1.0]], [1, [1.1559828182503882, 1.0]], [1, [0.5002437675275084, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.0968187]
bas 2, expnt(s) = [617.49859995]
bas 3, expnt(s) = [174.90601636]
bas 4, expnt(s) = [20.4948735]
bas 5, expnt(s) = [56.96176036]
bas 6, expnt(s) = [0.48748105]
bas 7, expnt(s) = [7.82749831]
bas 8, expnt(s) = [1.65426454]
bas 9, expnt(s) = [3.67972743]
bas 10, expnt(s) = [12.44030895]
bas 11, expnt(s) = [54.75264159]
bas 12, expnt(s) = [0.30417703]
bas 13, expnt(s) = [1.15598282]
bas 14, expnt(s) = [0.50024377]
CPU time:         7.96
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906016e+02 1.21511837e+02
 2.04948735e+01 2.43359865e+01 5.69617604e+01 5.23844726e+01
 4.87481049e-01 1.47395195e+00 7.82749831e+00 1.18231245e+01
 1.65426454e+00 3.68526519e+00 3.67972743e+00 1.48680480e+01
 1.24403090e+01 6.81590220e+01 5.47526416e+01 4.34500958e+02
 3.04177032e-01 6.59010623e-01 1.15598282e+00 3.49682273e+00
 5.00243768e-01 1.22733043e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.998384162852231
cond(S) = 239.67481505128197
E1 = -183.57563006114626  E_coul = 55.07968940085626
init E= -128.49594066029
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77405174144718  LUMO = 0.730939287383828
  mo_energy =
[-3.25545129e+01 -1.85136324e+00 -7.74051741e-01 -7.74051741e-01
 -7.74051741e-01  7.30939287e-01  7.30939287e-01  7.30939287e-01
  2.06113447e+00  2.56259180e+00  2.56259180e+00  2.56259180e+00
  7.38686187e+00  7.38686187e+00  7.38686187e+00  1.94439958e+01
  2.55087653e+01  2.55087653e+01  2.55087653e+01  9.39010611e+01
  1.19898364e+02  1.19898364e+02  1.19898364e+02  3.56250414e+02
  1.34961996e+03  5.83606176e+03  3.50986754e+04]
E1 = -182.10160922828737  E_coul = 53.5758769079951
cycle= 1 E= -128.525732320292  delta_E= -0.0298  |g|= 0.202  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.547021
diis-c [-0.29923188  1.        ]
  HOMO = -0.879943267481292  LUMO = 0.713229329421666
  mo_energy =
[-3.28752029e+01 -1.96247793e+00 -8.79943267e-01 -8.79943267e-01
 -8.79943267e-01  7.13229329e-01  7.13229329e-01  7.13229329e-01
  1.98613781e+00  2.51071370e+00  2.51071370e+00  2.51071370e+00
  7.26383551e+00  7.26383551e+00  7.26383551e+00  1.92248784e+01
  2.52763373e+01  2.52763373e+01  2.52763373e+01  9.35991829e+01
  1.19576098e+02  1.19576098e+02  1.19576098e+02  3.55900655e+02
  1.34923182e+03  5.83564171e+03  3.50982337e+04]
E1 = -182.8474005091924  E_coul = 54.319108751554026
cycle= 2 E= -128.528291757638  delta_E= -0.00256  |g|= 0.101  |ddm|= 0.0808
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273605
diis-c [-5.73249874e-04  3.32769673e-01  6.67230327e-01]
  HOMO = -0.844917322732729  LUMO = 0.719373997260644
  mo_energy =
[-3.27687012e+01 -1.92552527e+00 -8.44917323e-01 -8.44917323e-01
 -8.44917323e-01  7.19373997e-01  7.19373997e-01  7.19373997e-01
  2.01102063e+00  2.52791423e+00  2.52791423e+00  2.52791423e+00
  7.30443723e+00  7.30443723e+00  7.30443723e+00  1.92980432e+01
  2.53537914e+01  2.53537914e+01  2.53537914e+01  9.36997345e+01
  1.19682423e+02  1.19682423e+02  1.19682423e+02  3.56013926e+02
  1.34935132e+03  5.83576415e+03  3.50983573e+04]
E1 = -182.5982337728659  E_coul = 54.06907193359665
cycle= 3 E= -128.529161839269  delta_E= -0.00087  |g|= 0.000348  |ddm|= 0.0266
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000907302
diis-c [-9.20751730e-08 -1.81692737e-03 -5.05246738e-04  1.00232217e+00]
  HOMO = -0.845035452489035  LUMO = 0.719391826230326
  mo_energy =
[-3.27689768e+01 -1.92557579e+00 -8.45035452e-01 -8.45035452e-01
 -8.45035452e-01  7.19391826e-01  7.19391826e-01  7.19391826e-01
  2.01103361e+00  2.52790781e+00  2.52790781e+00  2.52790781e+00
  7.30436583e+00  7.30436583e+00  7.30436583e+00  1.92979053e+01
  2.53536182e+01  2.53536182e+01  2.53536182e+01  9.36994857e+01
  1.19682135e+02  1.19682135e+02  1.19682135e+02  3.56013565e+02
  1.34935083e+03  5.83576355e+03  3.50983566e+04]
E1 = -182.59867613862562  E_coul = 54.06951428738828
cycle= 4 E= -128.529161851237  delta_E= -1.2e-08  |g|= 5.94e-05  |ddm|= 0.000289
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000167551
diis-c [-8.75978241e-10  2.00192260e-04  5.65374126e-04 -1.64708263e-01
  1.16394270e+00]
  HOMO = -0.845053807766144  LUMO = 0.719389880652076
  mo_energy =
[-3.27690217e+01 -1.92558324e+00 -8.45053808e-01 -8.45053808e-01
 -8.45053808e-01  7.19389881e-01  7.19389881e-01  7.19389881e-01
  2.01102981e+00  2.52790026e+00  2.52790026e+00  2.52790026e+00
  7.30434645e+00  7.30434645e+00  7.30434645e+00  1.92978758e+01
  2.53535840e+01  2.53535840e+01  2.53535840e+01  9.36994433e+01
  1.19682090e+02  1.19682090e+02  1.19682090e+02  3.56013513e+02
  1.34935077e+03  5.83576348e+03  3.50983565e+04]
E1 = -182.5988122422759  E_coul = 54.069650390545476
cycle= 5 E= -128.52916185173  delta_E= -4.93e-10  |g|= 4.22e-06  |ddm|= 5.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5988122422759  E_coul = 54.069650390545476
  HOMO = -0.845052128039858  LUMO = 0.719390258964138
  mo_energy =
[-3.27690187e+01 -1.92558067e+00 -8.45052128e-01 -8.45052128e-01
 -8.45052128e-01  7.19390259e-01  7.19390259e-01  7.19390259e-01
  2.01103183e+00  2.52790130e+00  2.52790130e+00  2.52790130e+00
  7.30434849e+00  7.30434849e+00  7.30434849e+00  1.92978790e+01
  2.53535870e+01  2.53535870e+01  2.53535870e+01  9.36994464e+01
  1.19682093e+02  1.19682093e+02  1.19682093e+02  3.56013516e+02
  1.34935077e+03  5.83576348e+03  3.50983565e+04]
E1 = -182.59880605594722  E_coul = 54.06964420421495
Extra cycle  E= -128.529161851732  delta_E= -1.88e-12  |g|= 1.06e-06  |ddm|= 2.72e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.67481505128197
E1 = -182.59880605594722  E_coul = 54.06964420421495
init E= -128.529161851732
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.845052571029388  LUMO = 0.719390196264109
  mo_energy =
[-3.27690201e+01 -1.92558098e+00 -8.45052571e-01 -8.45052571e-01
 -8.45052571e-01  7.19390196e-01  7.19390196e-01  7.19390196e-01
  2.01103167e+00  2.52790112e+00  2.52790112e+00  2.52790112e+00
  7.30434800e+00  7.30434800e+00  7.30434800e+00  1.92978781e+01
  2.53535859e+01  2.53535859e+01  2.53535859e+01  9.36994450e+01
  1.19682091e+02  1.19682091e+02  1.19682091e+02  3.56013514e+02
  1.34935077e+03  5.83576348e+03  3.50983565e+04]
E1 = -182.59880988437695  E_coul = 54.06964803264428
cycle= 1 E= -128.529161851733  delta_E= -3.98e-13  |g|= 5.4e-07  |ddm|= 7.08e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59880988437695  E_coul = 54.06964803264428
  HOMO = -0.845052303695623  LUMO = 0.719390245982086
  mo_energy =
[-3.27690193e+01 -1.92558066e+00 -8.45052304e-01 -8.45052304e-01
 -8.45052304e-01  7.19390246e-01  7.19390246e-01  7.19390246e-01
  2.01103189e+00  2.52790126e+00  2.52790126e+00  2.52790126e+00
  7.30434831e+00  7.30434831e+00  7.30434831e+00  1.92978787e+01
  2.53535865e+01  2.53535865e+01  2.53535865e+01  9.36994458e+01
  1.19682092e+02  1.19682092e+02  1.19682092e+02  3.56013515e+02
  1.34935077e+03  5.83576348e+03  3.50983565e+04]
E1 = -182.59880808277737  E_coul = 54.06964623104458
Extra cycle  E= -128.529161851733  delta_E= -1.14e-13  |g|= 2.45e-07  |ddm|= 2.29e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906016e+02
 2.04948735e+01 5.69617604e+01 4.87481049e-01 7.82749831e+00
 1.65426454e+00 3.67972743e+00 1.24403090e+01 5.47526416e+01
 3.04177032e-01 1.15598282e+00 5.00243768e-01]
grad_E = [-1.99525616e-11  1.29425886e-09 -3.08959035e-08  4.57481479e-07
  5.02516367e-06 -3.66357545e-06 -1.18848851e-04  3.20583782e-06
 -2.38745108e-05  2.33633672e-03 -1.61551769e-04  4.54534132e-06
  2.39757698e-02 -1.43304674e-02 -1.07556104e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681869        1
[INPUT] 0    0    [1    /1   ]  617.498600118        1
[INPUT] 0    0    [1    /1   ]  174.906013923        1
[INPUT] 0    0    [1    /1   ]  20.4948467852        1
[INPUT] 0    0    [1    /1   ]  56.9617798841        1
[INPUT] 0    0    [1    /1   ]  0.4880921279         1
[INPUT] 0    0    [1    /1   ]  7.82748106014        1
[INPUT] 0    0    [1    /1   ]  1.65439686696        1
[INPUT] 1    0    [1    /1   ]  3.6673077866         1
[INPUT] 1    0    [1    /1   ]  12.4411843566        1
[INPUT] 1    0    [1    /1   ]  54.7526166181        1
[INPUT] 1    0    [1    /1   ]  0.175397934473       1
[INPUT] 1    0    [1    /1   ]  1.23150838168        1
[INPUT] 1    0    [1    /1   ]  0.50570292749        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069066, 1.0]], [0, [2712.0968186935206, 1.0]], [0, [617.4986001178341, 1.0]], [0, [174.9060139231016, 1.0]], [0, [20.494846785184688, 1.0]], [0, [56.9617798840841, 1.0]], [0, [0.48809212790024004, 1.0]], [0, [7.827481060142512, 1.0]], [0, [1.654396866960208, 1.0]], [1, [3.6673077865980073, 1.0]], [1, [12.441184356600607, 1.0]], [1, [54.75261661810285, 1.0]], [1, [0.17539793447255217, 1.0]], [1, [1.2315083816848078, 1.0]], [1, [0.5057029274897096, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681869]
bas 2, expnt(s) = [617.49860012]
bas 3, expnt(s) = [174.90601392]
bas 4, expnt(s) = [20.49484679]
bas 5, expnt(s) = [56.96177988]
bas 6, expnt(s) = [0.48809213]
bas 7, expnt(s) = [7.82748106]
bas 8, expnt(s) = [1.65439687]
bas 9, expnt(s) = [3.66730779]
bas 10, expnt(s) = [12.44118436]
bas 11, expnt(s) = [54.75261662]
bas 12, expnt(s) = [0.17539793]
bas 13, expnt(s) = [1.23150838]
bas 14, expnt(s) = [0.50570293]
CPU time:        10.71
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906014e+02 1.21511835e+02
 2.04948468e+01 2.43359627e+01 5.69617799e+01 5.23844861e+01
 4.88092128e-01 1.47533748e+00 7.82748106e+00 1.18231049e+01
 1.65439687e+00 3.68548628e+00 3.66730779e+00 1.48053471e+01
 1.24411844e+01 6.81650173e+01 5.47526166e+01 4.34500711e+02
 1.75397934e-01 3.31142548e-01 1.23150838e+00 3.78469693e+00
 5.05702927e-01 1.24409552e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999176180194542
cond(S) = 239.72052384058273
E1 = -183.57529279170828  E_coul = 55.07820365391154
init E= -128.497089137797
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77452015696025  LUMO = 0.482224838122227
  mo_energy =
[-3.25546496e+01 -1.85153665e+00 -7.74520157e-01 -7.74520157e-01
 -7.74520157e-01  4.82224838e-01  4.82224838e-01  4.82224838e-01
  2.06307246e+00  2.16454457e+00  2.16454457e+00  2.16454457e+00
  7.10908458e+00  7.10908458e+00  7.10908458e+00  1.94474047e+01
  2.53601223e+01  2.53601223e+01  2.53601223e+01  9.39038286e+01
  1.19808757e+02  1.19808757e+02  1.19808757e+02  3.56252752e+02
  1.34962211e+03  5.83606367e+03  3.50986770e+04]
E1 = -182.0333508395724  E_coul = 53.50633998009293
cycle= 1 E= -128.527010859479  delta_E= -0.0299  |g|= 0.21  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.535193
diis-c [-0.28643127  1.        ]
  HOMO = -0.885803523438907  LUMO = 0.469511528772997
  mo_energy =
[-3.28869162e+01 -1.96884423e+00 -8.85803523e-01 -8.85803523e-01
 -8.85803523e-01  4.69511529e-01  4.69511529e-01  4.69511529e-01
  1.98324112e+00  2.10895780e+00  2.10895780e+00  2.10895780e+00
  6.97604720e+00  6.97604720e+00  6.97604720e+00  1.92186424e+01
  2.51172980e+01  2.51172980e+01  2.51172980e+01  9.35906851e+01
  1.19474990e+02  1.19474990e+02  1.19474990e+02  3.55891193e+02
  1.34922191e+03  5.83563147e+03  3.50982231e+04]
E1 = -182.82373061419955  E_coul = 54.29396779755814
cycle= 2 E= -128.529762816641  delta_E= -0.00275  |g|= 0.107  |ddm|= 0.0725
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273569
diis-c [-5.97069447e-04  3.37594109e-01  6.62405891e-01]
  HOMO = -0.848857383757684  LUMO = 0.473740538864999
  mo_energy =
[-3.27752838e+01 -1.92981129e+00 -8.48857384e-01 -8.48857384e-01
 -8.48857384e-01  4.73740539e-01  4.73740539e-01  4.73740539e-01
  2.00959789e+00  2.12714823e+00  2.12714823e+00  2.12714823e+00
  7.02009640e+00  7.02009640e+00  7.02009640e+00  1.92955520e+01
  2.51989102e+01  2.51989102e+01  2.51989102e+01  9.36961166e+01
  1.19586446e+02  1.19586446e+02  1.19586446e+02  3.56009830e+02
  1.34934699e+03  5.83575960e+03  3.50983524e+04]
E1 = -182.55463164293334  E_coul = 54.02388035892797
cycle= 3 E= -128.530751284005  delta_E= -0.000988  |g|= 0.000538  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000980673
diis-c [-2.66066290e-07 -2.19507079e-03 -1.25102132e-03  1.00344609e+00]
  HOMO = -0.849096944423644  LUMO = 0.473709429882867
  mo_energy =
[-3.27757168e+01 -1.93002712e+00 -8.49096944e-01 -8.49096944e-01
 -8.49096944e-01  4.73709430e-01  4.73709430e-01  4.73709430e-01
  2.00946419e+00  2.12703454e+00  2.12703454e+00  2.12703454e+00
  7.01987766e+00  7.01987766e+00  7.01987766e+00  1.92952524e+01
  2.51985794e+01  2.51985794e+01  2.51985794e+01  9.36957092e+01
  1.19586002e+02  1.19586002e+02  1.19586002e+02  3.56009316e+02
  1.34934636e+03  5.83575886e+03  3.50983516e+04]
E1 = -182.5547488018315  E_coul = 54.02399745993967
cycle= 4 E= -128.530751341892  delta_E= -5.79e-08  |g|= 0.000102  |ddm|= 0.000494
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185493
diis-c [-1.39598008e-09  1.67256745e-04  4.92350426e-04 -1.79187588e-01
  1.17852798e+00]
  HOMO = -0.849150669389767  LUMO = 0.473697420408119
  mo_energy =
[-3.27758061e+01 -1.93008538e+00 -8.49150669e-01 -8.49150669e-01
 -8.49150669e-01  4.73697420e-01  4.73697420e-01  4.73697420e-01
  2.00941473e+00  2.12699583e+00  2.12699583e+00  2.12699583e+00
  7.01981380e+00  7.01981380e+00  7.01981380e+00  1.92951728e+01
  2.51984975e+01  2.51984975e+01  2.51984975e+01  9.36956215e+01
  1.19585913e+02  1.19585913e+02  1.19585913e+02  3.56009225e+02
  1.34934626e+03  5.83575877e+03  3.50983515e+04]
E1 = -182.55484474185755  E_coul = 54.024093398084915
cycle= 5 E= -128.530751343773  delta_E= -1.88e-09  |g|= 5.46e-06  |ddm|= 9.81e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.50494e-05
diis-c [-1.44391722e-11  4.66414917e-06 -6.57097935e-05  8.08568203e-03
 -7.24297261e-02  1.06440509e+00]
  HOMO = -0.849149608052991  LUMO = 0.473697403269495
  mo_energy =
[-3.27758025e+01 -1.93008512e+00 -8.49149608e-01 -8.49149608e-01
 -8.49149608e-01  4.73697403e-01  4.73697403e-01  4.73697403e-01
  2.00941461e+00  2.12699603e+00  2.12699603e+00  2.12699603e+00
  7.01981494e+00  7.01981494e+00  7.01981494e+00  1.92951751e+01
  2.51985001e+01  2.51985001e+01  2.51985001e+01  9.36956248e+01
  1.19585916e+02  1.19585916e+02  1.19585916e+02  3.56009229e+02
  1.34934627e+03  5.83575877e+03  3.50983515e+04]
E1 = -182.5548303457104  E_coul = 54.02407900193305
cycle= 6 E= -128.530751343777  delta_E= -4.72e-12  |g|= 5.4e-07  |ddm|= 3.16e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.5548303457104  E_coul = 54.02407900193305
  HOMO = -0.849149562383736  LUMO = 0.473697401465452
  mo_energy =
[-3.27758023e+01 -1.93008522e+00 -8.49149562e-01 -8.49149562e-01
 -8.49149562e-01  4.73697401e-01  4.73697401e-01  4.73697401e-01
  2.00941452e+00  2.12699603e+00  2.12699603e+00  2.12699603e+00
  7.01981498e+00  7.01981498e+00  7.01981498e+00  1.92951751e+01
  2.51985002e+01  2.51985002e+01  2.51985002e+01  9.36956250e+01
  1.19585916e+02  1.19585916e+02  1.19585916e+02  3.56009229e+02
  1.34934627e+03  5.83575877e+03  3.50983515e+04]
E1 = -182.55482965454323  E_coul = 54.0240783107656
Extra cycle  E= -128.530751343778  delta_E= -2.84e-13  |g|= 1.48e-07  |ddm|= 3.25e-07
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906014e+02
 2.04948468e+01 5.69617799e+01 4.88092128e-01 7.82748106e+00
 1.65439687e+00 3.66730779e+00 1.24411844e+01 5.47526166e+01
 1.75397934e-01 1.23150838e+00 5.05702927e-01]
E = -128.53075134377764
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681869        1
[INPUT] 0    0    [1    /1   ]  617.498600118        1
[INPUT] 0    0    [1    /1   ]  174.906013923        1
[INPUT] 0    0    [1    /1   ]  20.4948467852        1
[INPUT] 0    0    [1    /1   ]  56.9617798841        1
[INPUT] 0    0    [1    /1   ]  0.4880921279         1
[INPUT] 0    0    [1    /1   ]  7.82748106014        1
[INPUT] 0    0    [1    /1   ]  1.65439686696        1
[INPUT] 1    0    [1    /1   ]  3.6673077866         1
[INPUT] 1    0    [1    /1   ]  12.4411843566        1
[INPUT] 1    0    [1    /1   ]  54.7526166181        1
[INPUT] 1    0    [1    /1   ]  0.175397934473       1
[INPUT] 1    0    [1    /1   ]  1.23150838168        1
[INPUT] 1    0    [1    /1   ]  0.50570292749        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069066, 1.0]], [0, [2712.0968186935206, 1.0]], [0, [617.4986001178341, 1.0]], [0, [174.9060139231016, 1.0]], [0, [20.494846785184688, 1.0]], [0, [56.9617798840841, 1.0]], [0, [0.48809212790024004, 1.0]], [0, [7.827481060142512, 1.0]], [0, [1.654396866960208, 1.0]], [1, [3.6673077865980073, 1.0]], [1, [12.441184356600607, 1.0]], [1, [54.75261661810285, 1.0]], [1, [0.17539793447255217, 1.0]], [1, [1.2315083816848078, 1.0]], [1, [0.5057029274897096, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681869]
bas 2, expnt(s) = [617.49860012]
bas 3, expnt(s) = [174.90601392]
bas 4, expnt(s) = [20.49484679]
bas 5, expnt(s) = [56.96177988]
bas 6, expnt(s) = [0.48809213]
bas 7, expnt(s) = [7.82748106]
bas 8, expnt(s) = [1.65439687]
bas 9, expnt(s) = [3.66730779]
bas 10, expnt(s) = [12.44118436]
bas 11, expnt(s) = [54.75261662]
bas 12, expnt(s) = [0.17539793]
bas 13, expnt(s) = [1.23150838]
bas 14, expnt(s) = [0.50570293]
CPU time:        10.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906014e+02 1.21511835e+02
 2.04948468e+01 2.43359627e+01 5.69617799e+01 5.23844861e+01
 4.88092128e-01 1.47533748e+00 7.82748106e+00 1.18231049e+01
 1.65439687e+00 3.68548628e+00 3.66730779e+00 1.48053471e+01
 1.24411844e+01 6.81650173e+01 5.47526166e+01 4.34500711e+02
 1.75397934e-01 3.31142548e-01 1.23150838e+00 3.78469693e+00
 5.05702927e-01 1.24409552e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999176180194542
cond(S) = 239.72052384058273
E1 = -183.57529279170828  E_coul = 55.07820365391154
init E= -128.497089137797
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77452015696025  LUMO = 0.482224838122227
  mo_energy =
[-3.25546496e+01 -1.85153665e+00 -7.74520157e-01 -7.74520157e-01
 -7.74520157e-01  4.82224838e-01  4.82224838e-01  4.82224838e-01
  2.06307246e+00  2.16454457e+00  2.16454457e+00  2.16454457e+00
  7.10908458e+00  7.10908458e+00  7.10908458e+00  1.94474047e+01
  2.53601223e+01  2.53601223e+01  2.53601223e+01  9.39038286e+01
  1.19808757e+02  1.19808757e+02  1.19808757e+02  3.56252752e+02
  1.34962211e+03  5.83606367e+03  3.50986770e+04]
E1 = -182.0333508395724  E_coul = 53.50633998009293
cycle= 1 E= -128.527010859479  delta_E= -0.0299  |g|= 0.21  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.535193
diis-c [-0.28643127  1.        ]
  HOMO = -0.885803523438907  LUMO = 0.469511528772997
  mo_energy =
[-3.28869162e+01 -1.96884423e+00 -8.85803523e-01 -8.85803523e-01
 -8.85803523e-01  4.69511529e-01  4.69511529e-01  4.69511529e-01
  1.98324112e+00  2.10895780e+00  2.10895780e+00  2.10895780e+00
  6.97604720e+00  6.97604720e+00  6.97604720e+00  1.92186424e+01
  2.51172980e+01  2.51172980e+01  2.51172980e+01  9.35906851e+01
  1.19474990e+02  1.19474990e+02  1.19474990e+02  3.55891193e+02
  1.34922191e+03  5.83563147e+03  3.50982231e+04]
E1 = -182.82373061419955  E_coul = 54.29396779755814
cycle= 2 E= -128.529762816641  delta_E= -0.00275  |g|= 0.107  |ddm|= 0.0725
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273569
diis-c [-5.97069447e-04  3.37594109e-01  6.62405891e-01]
  HOMO = -0.848857383757684  LUMO = 0.473740538864999
  mo_energy =
[-3.27752838e+01 -1.92981129e+00 -8.48857384e-01 -8.48857384e-01
 -8.48857384e-01  4.73740539e-01  4.73740539e-01  4.73740539e-01
  2.00959789e+00  2.12714823e+00  2.12714823e+00  2.12714823e+00
  7.02009640e+00  7.02009640e+00  7.02009640e+00  1.92955520e+01
  2.51989102e+01  2.51989102e+01  2.51989102e+01  9.36961166e+01
  1.19586446e+02  1.19586446e+02  1.19586446e+02  3.56009830e+02
  1.34934699e+03  5.83575960e+03  3.50983524e+04]
E1 = -182.55463164293334  E_coul = 54.02388035892797
cycle= 3 E= -128.530751284005  delta_E= -0.000988  |g|= 0.000538  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000980673
diis-c [-2.66066290e-07 -2.19507079e-03 -1.25102132e-03  1.00344609e+00]
  HOMO = -0.849096944423644  LUMO = 0.473709429882867
  mo_energy =
[-3.27757168e+01 -1.93002712e+00 -8.49096944e-01 -8.49096944e-01
 -8.49096944e-01  4.73709430e-01  4.73709430e-01  4.73709430e-01
  2.00946419e+00  2.12703454e+00  2.12703454e+00  2.12703454e+00
  7.01987766e+00  7.01987766e+00  7.01987766e+00  1.92952524e+01
  2.51985794e+01  2.51985794e+01  2.51985794e+01  9.36957092e+01
  1.19586002e+02  1.19586002e+02  1.19586002e+02  3.56009316e+02
  1.34934636e+03  5.83575886e+03  3.50983516e+04]
E1 = -182.5547488018315  E_coul = 54.02399745993967
cycle= 4 E= -128.530751341892  delta_E= -5.79e-08  |g|= 0.000102  |ddm|= 0.000494
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185493
diis-c [-1.39598008e-09  1.67256745e-04  4.92350426e-04 -1.79187588e-01
  1.17852798e+00]
  HOMO = -0.849150669389767  LUMO = 0.473697420408119
  mo_energy =
[-3.27758061e+01 -1.93008538e+00 -8.49150669e-01 -8.49150669e-01
 -8.49150669e-01  4.73697420e-01  4.73697420e-01  4.73697420e-01
  2.00941473e+00  2.12699583e+00  2.12699583e+00  2.12699583e+00
  7.01981380e+00  7.01981380e+00  7.01981380e+00  1.92951728e+01
  2.51984975e+01  2.51984975e+01  2.51984975e+01  9.36956215e+01
  1.19585913e+02  1.19585913e+02  1.19585913e+02  3.56009225e+02
  1.34934626e+03  5.83575877e+03  3.50983515e+04]
E1 = -182.55484474185755  E_coul = 54.024093398084915
cycle= 5 E= -128.530751343773  delta_E= -1.88e-09  |g|= 5.46e-06  |ddm|= 9.81e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=1.50494e-05
diis-c [-1.44391722e-11  4.66414917e-06 -6.57097935e-05  8.08568203e-03
 -7.24297261e-02  1.06440509e+00]
  HOMO = -0.849149608052991  LUMO = 0.473697403269495
  mo_energy =
[-3.27758025e+01 -1.93008512e+00 -8.49149608e-01 -8.49149608e-01
 -8.49149608e-01  4.73697403e-01  4.73697403e-01  4.73697403e-01
  2.00941461e+00  2.12699603e+00  2.12699603e+00  2.12699603e+00
  7.01981494e+00  7.01981494e+00  7.01981494e+00  1.92951751e+01
  2.51985001e+01  2.51985001e+01  2.51985001e+01  9.36956248e+01
  1.19585916e+02  1.19585916e+02  1.19585916e+02  3.56009229e+02
  1.34934627e+03  5.83575877e+03  3.50983515e+04]
E1 = -182.5548303457104  E_coul = 54.02407900193305
cycle= 6 E= -128.530751343777  delta_E= -4.72e-12  |g|= 5.4e-07  |ddm|= 3.16e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.5548303457104  E_coul = 54.02407900193305
  HOMO = -0.849149562383736  LUMO = 0.473697401465452
  mo_energy =
[-3.27758023e+01 -1.93008522e+00 -8.49149562e-01 -8.49149562e-01
 -8.49149562e-01  4.73697401e-01  4.73697401e-01  4.73697401e-01
  2.00941452e+00  2.12699603e+00  2.12699603e+00  2.12699603e+00
  7.01981498e+00  7.01981498e+00  7.01981498e+00  1.92951751e+01
  2.51985002e+01  2.51985002e+01  2.51985002e+01  9.36956250e+01
  1.19585916e+02  1.19585916e+02  1.19585916e+02  3.56009229e+02
  1.34934627e+03  5.83575877e+03  3.50983515e+04]
E1 = -182.55482965454323  E_coul = 54.0240783107656
Extra cycle  E= -128.530751343778  delta_E= -2.84e-13  |g|= 1.48e-07  |ddm|= 3.25e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.72052384058273
E1 = -182.55482965454323  E_coul = 54.0240783107656
init E= -128.530751343778
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.849149608076689  LUMO = 0.473697394516265
  mo_energy =
[-3.27758024e+01 -1.93008529e+00 -8.49149608e-01 -8.49149608e-01
 -8.49149608e-01  4.73697395e-01  4.73697395e-01  4.73697395e-01
  2.00941447e+00  2.12699600e+00  2.12699600e+00  2.12699600e+00
  7.01981492e+00  7.01981492e+00  7.01981492e+00  1.92951750e+01
  2.51985001e+01  2.51985001e+01  2.51985001e+01  9.36956249e+01
  1.19585916e+02  1.19585916e+02  1.19585916e+02  3.56009229e+02
  1.34934627e+03  5.83575877e+03  3.50983515e+04]
E1 = -182.55482991466894  E_coul = 54.02407857089122
cycle= 1 E= -128.530751343778  delta_E= -8.53e-14  |g|= 4.14e-08  |ddm|= 8.96e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.55482991466894  E_coul = 54.02407857089122
  HOMO = -0.84914958910688  LUMO = 0.473697396298621
  mo_energy =
[-3.27758023e+01 -1.93008528e+00 -8.49149589e-01 -8.49149589e-01
 -8.49149589e-01  4.73697396e-01  4.73697396e-01  4.73697396e-01
  2.00941448e+00  2.12699601e+00  2.12699601e+00  2.12699601e+00
  7.01981494e+00  7.01981494e+00  7.01981494e+00  1.92951750e+01
  2.51985001e+01  2.51985001e+01  2.51985001e+01  9.36956250e+01
  1.19585916e+02  1.19585916e+02  1.19585916e+02  3.56009229e+02
  1.34934627e+03  5.83575877e+03  3.50983515e+04]
E1 = -182.55482975805637  E_coul = 54.02407841427847
Extra cycle  E= -128.530751343778  delta_E= -1.71e-13  |g|= 2.18e-08  |ddm|= 1.51e-08
    CPU time for scf_cycle      0.31 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906014e+02
 2.04948468e+01 5.69617799e+01 4.88092128e-01 7.82748106e+00
 1.65439687e+00 3.66730779e+00 1.24411844e+01 5.47526166e+01
 1.75397934e-01 1.23150838e+00 5.05702927e-01]
grad_E = [-2.59900191e-11  1.61855325e-09 -3.71884833e-08  5.36261506e-07
  8.46857656e-06 -4.24368768e-06  1.75743646e-05 -3.84818432e-06
 -1.81728522e-04  1.57950711e-03  2.96556594e-04 -1.58447485e-05
 -5.14158181e-02 -2.95057563e-02  4.40751380e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681869        1
[INPUT] 0    0    [1    /1   ]  617.498600104        1
[INPUT] 0    0    [1    /1   ]  174.90601413         1
[INPUT] 0    0    [1    /1   ]  20.4948478706        1
[INPUT] 0    0    [1    /1   ]  56.9617782046        1
[INPUT] 0    0    [1    /1   ]  0.487948168409       1
[INPUT] 0    0    [1    /1   ]  7.82748601812        1
[INPUT] 0    0    [1    /1   ]  1.65446294724        1
[INPUT] 1    0    [1    /1   ]  3.66893645315        1
[INPUT] 1    0    [1    /1   ]  12.4408898329        1
[INPUT] 1    0    [1    /1   ]  54.7526282459        1
[INPUT] 1    0    [1    /1   ]  0.223431274024       1
[INPUT] 1    0    [1    /1   ]  1.23051276706        1
[INPUT] 1    0    [1    /1   ]  0.483411186779       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873006906, 1.0]], [0, [2712.09681869406, 1.0]], [0, [617.4986001043029, 1.0]], [0, [174.90601412989702, 1.0]], [0, [20.49484787061637, 1.0]], [0, [56.961778204590324, 1.0]], [0, [0.4879481684093461, 1.0]], [0, [7.827486018123319, 1.0]], [0, [1.6544629472404815, 1.0]], [1, [3.668936453148328, 1.0]], [1, [12.440889832876815, 1.0]], [1, [54.752628245883294, 1.0]], [1, [0.22343127402376947, 1.0]], [1, [1.2305127670612277, 1.0]], [1, [0.4834111867789178, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681869]
bas 2, expnt(s) = [617.4986001]
bas 3, expnt(s) = [174.90601413]
bas 4, expnt(s) = [20.49484787]
bas 5, expnt(s) = [56.9617782]
bas 6, expnt(s) = [0.48794817]
bas 7, expnt(s) = [7.82748602]
bas 8, expnt(s) = [1.65446295]
bas 9, expnt(s) = [3.66893645]
bas 10, expnt(s) = [12.44088983]
bas 11, expnt(s) = [54.75262825]
bas 12, expnt(s) = [0.22343127]
bas 13, expnt(s) = [1.23051277]
bas 14, expnt(s) = [0.48341119]
CPU time:        13.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906014e+02 1.21511836e+02
 2.04948479e+01 2.43359637e+01 5.69617782e+01 5.23844849e+01
 4.87948168e-01 1.47501112e+00 7.82748602e+00 1.18231105e+01
 1.65446295e+00 3.68559668e+00 3.66893645e+00 1.48135664e+01
 1.24408898e+01 6.81630002e+01 5.47526282e+01 4.34500826e+02
 2.23431274e-01 4.48140655e-01 1.23051277e+00 3.78087263e+00
 4.83411187e-01 1.17592673e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999243549468021
cond(S) = 239.7142038145955
E1 = -183.57893292135108  E_coul = 55.08008987612105
init E= -128.49884304523
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774469079355455  LUMO = 0.579461475324063
  mo_energy =
[-3.25544729e+01 -1.85130438e+00 -7.74469079e-01 -7.74469079e-01
 -7.74469079e-01  5.79461475e-01  5.79461475e-01  5.79461475e-01
  2.06297853e+00  2.29085801e+00  2.29085801e+00  2.29085801e+00
  7.20570431e+00  7.20570431e+00  7.20570431e+00  1.94467593e+01
  2.54295808e+01  2.54295808e+01  2.54295808e+01  9.39035902e+01
  1.19854347e+02  1.19854347e+02  1.19854347e+02  3.56252663e+02
  1.34962189e+03  5.83606339e+03  3.50986767e+04]
E1 = -182.05761108471046  E_coul = 53.529648722526254
cycle= 1 E= -128.527962362184  delta_E= -0.0291  |g|= 0.207  |ddm|= 0.153
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.541927
diis-c [-0.29368534  1.        ]
  HOMO = -0.883980903258262  LUMO = 0.564931007652492
  mo_energy =
[-3.28833257e+01 -1.96663489e+00 -8.83980903e-01 -8.83980903e-01
 -8.83980903e-01  5.64931008e-01  5.64931008e-01  5.64931008e-01
  1.98456610e+00  2.23695210e+00  2.23695210e+00  2.23695210e+00
  7.07559338e+00  7.07559338e+00  7.07559338e+00  1.92213490e+01
  2.51900996e+01  2.51900996e+01  2.51900996e+01  9.35939068e+01
  1.19523910e+02  1.19523910e+02  1.19523910e+02  3.55894609e+02
  1.34922539e+03  5.83563499e+03  3.50982267e+04]
E1 = -182.8328991675735  E_coul = 54.30225341413612
cycle= 2 E= -128.530645753437  delta_E= -0.00268  |g|= 0.105  |ddm|= 0.0699
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.274982
diis-c [-5.90172846e-04  3.35962892e-01  6.64037108e-01]
  HOMO = -0.847680424994118  LUMO = 0.569884392607027
  mo_energy =
[-3.27734237e+01 -1.92830077e+00 -8.47680425e-01 -8.47680425e-01
 -8.47680425e-01  5.69884393e-01  5.69884393e-01  5.69884393e-01
  2.01042482e+00  2.25468727e+00  2.25468727e+00  2.25468727e+00
  7.11860754e+00  7.11860754e+00  7.11860754e+00  1.92970008e+01
  2.52703123e+01  2.52703123e+01  2.52703123e+01  9.36976954e+01
  1.19633635e+02  1.19633635e+02  1.19633635e+02  3.56011445e+02
  1.34934861e+03  5.83576123e+03  3.50983541e+04]
E1 = -182.57129151555023  E_coul = 54.03969990571811
cycle= 3 E= -128.531591609832  delta_E= -0.000946  |g|= 0.0003  |ddm|= 0.024
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000769442
diis-c [-6.27619188e-08 -1.71675250e-03 -7.39531081e-04  1.00245628e+00]
  HOMO = -0.847826618542783  LUMO = 0.569890987317584
  mo_energy =
[-3.27737230e+01 -1.92840107e+00 -8.47826619e-01 -8.47826619e-01
 -8.47826619e-01  5.69890987e-01  5.69890987e-01  5.69890987e-01
  2.01039381e+00  2.25465867e+00  2.25465867e+00  2.25465867e+00
  7.11850229e+00  7.11850229e+00  7.11850229e+00  1.92968304e+01
  2.52701102e+01  2.52701102e+01  2.52701102e+01  9.36974224e+01
  1.19633325e+02  1.19633325e+02  1.19633325e+02  3.56011068e+02
  1.34934811e+03  5.83576063e+03  3.50983534e+04]
E1 = -182.57157535966542  E_coul = 54.039983743786294
cycle= 4 E= -128.531591615879  delta_E= -6.05e-09  |g|= 5.28e-05  |ddm|= 6.34e-05
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000147248
diis-c [-4.68706712e-10  6.61448989e-05  4.45319801e-04 -9.90145044e-02
  1.09850304e+00]
  HOMO = -0.847851387546664  LUMO = 0.569887134772601
  mo_energy =
[-3.27737726e+01 -1.92842175e+00 -8.47851388e-01 -8.47851388e-01
 -8.47851388e-01  5.69887135e-01  5.69887135e-01  5.69887135e-01
  2.01037801e+00  2.25464495e+00  2.25464495e+00  2.25464495e+00
  7.11847398e+00  7.11847398e+00  7.11847398e+00  1.92967915e+01
  2.52700683e+01  2.52700683e+01  2.52700683e+01  9.36973747e+01
  1.19633275e+02  1.19633275e+02  1.19633275e+02  3.56011015e+02
  1.34934806e+03  5.83576057e+03  3.50983533e+04]
E1 = -182.57169010618216  E_coul = 54.040098490049644
cycle= 5 E= -128.531591616133  delta_E= -2.53e-10  |g|= 2.14e-06  |ddm|= 1.09e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57169010618216  E_coul = 54.040098490049644
  HOMO = -0.84785112967548  LUMO = 0.56988716474015
  mo_energy =
[-3.27737722e+01 -1.92842097e+00 -8.47851130e-01 -8.47851130e-01
 -8.47851130e-01  5.69887165e-01  5.69887165e-01  5.69887165e-01
  2.01037860e+00  2.25464510e+00  2.25464510e+00  2.25464510e+00
  7.11847435e+00  7.11847435e+00  7.11847435e+00  1.92967922e+01
  2.52700689e+01  2.52700689e+01  2.52700689e+01  9.36973751e+01
  1.19633276e+02  1.19633276e+02  1.19633276e+02  3.56011014e+02
  1.34934806e+03  5.83576056e+03  3.50983533e+04]
E1 = -182.57168870465551  E_coul = 54.04009708852291
Extra cycle  E= -128.531591616133  delta_E= -8.53e-14  |g|= 4.08e-07  |ddm|= 1.31e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906014e+02
 2.04948479e+01 5.69617782e+01 4.87948168e-01 7.82748602e+00
 1.65446295e+00 3.66893645e+00 1.24408898e+01 5.47526282e+01
 2.23431274e-01 1.23051277e+00 4.83411187e-01]
E = -128.5315916161326
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681869        1
[INPUT] 0    0    [1    /1   ]  617.498600104        1
[INPUT] 0    0    [1    /1   ]  174.90601413         1
[INPUT] 0    0    [1    /1   ]  20.4948478706        1
[INPUT] 0    0    [1    /1   ]  56.9617782046        1
[INPUT] 0    0    [1    /1   ]  0.487948168409       1
[INPUT] 0    0    [1    /1   ]  7.82748601812        1
[INPUT] 0    0    [1    /1   ]  1.65446294724        1
[INPUT] 1    0    [1    /1   ]  3.66893645315        1
[INPUT] 1    0    [1    /1   ]  12.4408898329        1
[INPUT] 1    0    [1    /1   ]  54.7526282459        1
[INPUT] 1    0    [1    /1   ]  0.223431274024       1
[INPUT] 1    0    [1    /1   ]  1.23051276706        1
[INPUT] 1    0    [1    /1   ]  0.483411186779       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873006906, 1.0]], [0, [2712.09681869406, 1.0]], [0, [617.4986001043029, 1.0]], [0, [174.90601412989702, 1.0]], [0, [20.49484787061637, 1.0]], [0, [56.961778204590324, 1.0]], [0, [0.4879481684093461, 1.0]], [0, [7.827486018123319, 1.0]], [0, [1.6544629472404815, 1.0]], [1, [3.668936453148328, 1.0]], [1, [12.440889832876815, 1.0]], [1, [54.752628245883294, 1.0]], [1, [0.22343127402376947, 1.0]], [1, [1.2305127670612277, 1.0]], [1, [0.4834111867789178, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681869]
bas 2, expnt(s) = [617.4986001]
bas 3, expnt(s) = [174.90601413]
bas 4, expnt(s) = [20.49484787]
bas 5, expnt(s) = [56.9617782]
bas 6, expnt(s) = [0.48794817]
bas 7, expnt(s) = [7.82748602]
bas 8, expnt(s) = [1.65446295]
bas 9, expnt(s) = [3.66893645]
bas 10, expnt(s) = [12.44088983]
bas 11, expnt(s) = [54.75262825]
bas 12, expnt(s) = [0.22343127]
bas 13, expnt(s) = [1.23051277]
bas 14, expnt(s) = [0.48341119]
CPU time:        13.86
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906014e+02 1.21511836e+02
 2.04948479e+01 2.43359637e+01 5.69617782e+01 5.23844849e+01
 4.87948168e-01 1.47501112e+00 7.82748602e+00 1.18231105e+01
 1.65446295e+00 3.68559668e+00 3.66893645e+00 1.48135664e+01
 1.24408898e+01 6.81630002e+01 5.47526282e+01 4.34500826e+02
 2.23431274e-01 4.48140655e-01 1.23051277e+00 3.78087263e+00
 4.83411187e-01 1.17592673e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999243549468021
cond(S) = 239.7142038145955
E1 = -183.57893292135108  E_coul = 55.08008987612105
init E= -128.49884304523
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774469079355455  LUMO = 0.579461475324063
  mo_energy =
[-3.25544729e+01 -1.85130438e+00 -7.74469079e-01 -7.74469079e-01
 -7.74469079e-01  5.79461475e-01  5.79461475e-01  5.79461475e-01
  2.06297853e+00  2.29085801e+00  2.29085801e+00  2.29085801e+00
  7.20570431e+00  7.20570431e+00  7.20570431e+00  1.94467593e+01
  2.54295808e+01  2.54295808e+01  2.54295808e+01  9.39035902e+01
  1.19854347e+02  1.19854347e+02  1.19854347e+02  3.56252663e+02
  1.34962189e+03  5.83606339e+03  3.50986767e+04]
E1 = -182.05761108471046  E_coul = 53.529648722526254
cycle= 1 E= -128.527962362184  delta_E= -0.0291  |g|= 0.207  |ddm|= 0.153
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.541927
diis-c [-0.29368534  1.        ]
  HOMO = -0.883980903258262  LUMO = 0.564931007652492
  mo_energy =
[-3.28833257e+01 -1.96663489e+00 -8.83980903e-01 -8.83980903e-01
 -8.83980903e-01  5.64931008e-01  5.64931008e-01  5.64931008e-01
  1.98456610e+00  2.23695210e+00  2.23695210e+00  2.23695210e+00
  7.07559338e+00  7.07559338e+00  7.07559338e+00  1.92213490e+01
  2.51900996e+01  2.51900996e+01  2.51900996e+01  9.35939068e+01
  1.19523910e+02  1.19523910e+02  1.19523910e+02  3.55894609e+02
  1.34922539e+03  5.83563499e+03  3.50982267e+04]
E1 = -182.8328991675735  E_coul = 54.30225341413612
cycle= 2 E= -128.530645753437  delta_E= -0.00268  |g|= 0.105  |ddm|= 0.0699
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.274982
diis-c [-5.90172846e-04  3.35962892e-01  6.64037108e-01]
  HOMO = -0.847680424994118  LUMO = 0.569884392607027
  mo_energy =
[-3.27734237e+01 -1.92830077e+00 -8.47680425e-01 -8.47680425e-01
 -8.47680425e-01  5.69884393e-01  5.69884393e-01  5.69884393e-01
  2.01042482e+00  2.25468727e+00  2.25468727e+00  2.25468727e+00
  7.11860754e+00  7.11860754e+00  7.11860754e+00  1.92970008e+01
  2.52703123e+01  2.52703123e+01  2.52703123e+01  9.36976954e+01
  1.19633635e+02  1.19633635e+02  1.19633635e+02  3.56011445e+02
  1.34934861e+03  5.83576123e+03  3.50983541e+04]
E1 = -182.57129151555023  E_coul = 54.03969990571811
cycle= 3 E= -128.531591609832  delta_E= -0.000946  |g|= 0.0003  |ddm|= 0.024
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000769442
diis-c [-6.27619188e-08 -1.71675250e-03 -7.39531081e-04  1.00245628e+00]
  HOMO = -0.847826618542783  LUMO = 0.569890987317584
  mo_energy =
[-3.27737230e+01 -1.92840107e+00 -8.47826619e-01 -8.47826619e-01
 -8.47826619e-01  5.69890987e-01  5.69890987e-01  5.69890987e-01
  2.01039381e+00  2.25465867e+00  2.25465867e+00  2.25465867e+00
  7.11850229e+00  7.11850229e+00  7.11850229e+00  1.92968304e+01
  2.52701102e+01  2.52701102e+01  2.52701102e+01  9.36974224e+01
  1.19633325e+02  1.19633325e+02  1.19633325e+02  3.56011068e+02
  1.34934811e+03  5.83576063e+03  3.50983534e+04]
E1 = -182.57157535966542  E_coul = 54.039983743786294
cycle= 4 E= -128.531591615879  delta_E= -6.05e-09  |g|= 5.28e-05  |ddm|= 6.34e-05
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000147248
diis-c [-4.68706712e-10  6.61448989e-05  4.45319801e-04 -9.90145044e-02
  1.09850304e+00]
  HOMO = -0.847851387546664  LUMO = 0.569887134772601
  mo_energy =
[-3.27737726e+01 -1.92842175e+00 -8.47851388e-01 -8.47851388e-01
 -8.47851388e-01  5.69887135e-01  5.69887135e-01  5.69887135e-01
  2.01037801e+00  2.25464495e+00  2.25464495e+00  2.25464495e+00
  7.11847398e+00  7.11847398e+00  7.11847398e+00  1.92967915e+01
  2.52700683e+01  2.52700683e+01  2.52700683e+01  9.36973747e+01
  1.19633275e+02  1.19633275e+02  1.19633275e+02  3.56011015e+02
  1.34934806e+03  5.83576057e+03  3.50983533e+04]
E1 = -182.57169010618216  E_coul = 54.040098490049644
cycle= 5 E= -128.531591616133  delta_E= -2.53e-10  |g|= 2.14e-06  |ddm|= 1.09e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57169010618216  E_coul = 54.040098490049644
  HOMO = -0.84785112967548  LUMO = 0.56988716474015
  mo_energy =
[-3.27737722e+01 -1.92842097e+00 -8.47851130e-01 -8.47851130e-01
 -8.47851130e-01  5.69887165e-01  5.69887165e-01  5.69887165e-01
  2.01037860e+00  2.25464510e+00  2.25464510e+00  2.25464510e+00
  7.11847435e+00  7.11847435e+00  7.11847435e+00  1.92967922e+01
  2.52700689e+01  2.52700689e+01  2.52700689e+01  9.36973751e+01
  1.19633276e+02  1.19633276e+02  1.19633276e+02  3.56011014e+02
  1.34934806e+03  5.83576056e+03  3.50983533e+04]
E1 = -182.57168870465551  E_coul = 54.04009708852291
Extra cycle  E= -128.531591616133  delta_E= -8.53e-14  |g|= 4.08e-07  |ddm|= 1.31e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.7142038145955
E1 = -182.57168870465551  E_coul = 54.04009708852291
init E= -128.531591616133
    CPU time for initialize scf      0.26 sec, wall time      0.25 sec
  HOMO = -0.847851248273893  LUMO = 0.56988714832287
  mo_energy =
[-3.27737725e+01 -1.92842100e+00 -8.47851248e-01 -8.47851248e-01
 -8.47851248e-01  5.69887148e-01  5.69887148e-01  5.69887148e-01
  2.01037860e+00  2.25464505e+00  2.25464505e+00  2.25464505e+00
  7.11847422e+00  7.11847422e+00  7.11847422e+00  1.92967921e+01
  2.52700686e+01  2.52700686e+01  2.52700686e+01  9.36973748e+01
  1.19633275e+02  1.19633275e+02  1.19633275e+02  3.56011014e+02
  1.34934805e+03  5.83576056e+03  3.50983533e+04]
E1 = -182.57168953492769  E_coul = 54.04009791879484
cycle= 1 E= -128.531591616133  delta_E= -2.56e-13  |g|= 1.41e-07  |ddm|= 2e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57168953492769  E_coul = 54.04009791879484
  HOMO = -0.847851193131835  LUMO = 0.56988715619306
  mo_energy =
[-3.27737724e+01 -1.92842092e+00 -8.47851193e-01 -8.47851193e-01
 -8.47851193e-01  5.69887156e-01  5.69887156e-01  5.69887156e-01
  2.01037865e+00  2.25464508e+00  2.25464508e+00  2.25464508e+00
  7.11847429e+00  7.11847429e+00  7.11847429e+00  1.92967922e+01
  2.52700688e+01  2.52700688e+01  2.52700688e+01  9.36973749e+01
  1.19633275e+02  1.19633275e+02  1.19633275e+02  3.56011014e+02
  1.34934805e+03  5.83576056e+03  3.50983533e+04]
E1 = -182.57168914290136  E_coul = 54.040097526768896
Extra cycle  E= -128.531591616132  delta_E= 3.98e-13  |g|= 5.41e-08  |ddm|= 7.3e-08
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906014e+02
 2.04948479e+01 5.69617782e+01 4.87948168e-01 7.82748602e+00
 1.65446295e+00 3.66893645e+00 1.24408898e+01 5.47526282e+01
 2.23431274e-01 1.23051277e+00 4.83411187e-01]
grad_E = [-2.58478566e-11  1.60321071e-09 -3.70504094e-08  5.28791395e-07
  7.34318413e-06 -4.18310765e-06  6.70107118e-04 -1.86690418e-06
 -2.22522557e-04 -6.54825917e-03  1.12533743e-03 -4.28426796e-05
  1.85490101e-02 -2.58528195e-03 -4.88428632e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681869        1
[INPUT] 0    0    [1    /1   ]  617.498600179        1
[INPUT] 0    0    [1    /1   ]  174.906013036        1
[INPUT] 0    0    [1    /1   ]  20.4948339943        1
[INPUT] 0    0    [1    /1   ]  56.9617869125        1
[INPUT] 0    0    [1    /1   ]  0.487551149764       1
[INPUT] 0    0    [1    /1   ]  7.82748465412        1
[INPUT] 0    0    [1    /1   ]  1.65471599785        1
[INPUT] 1    0    [1    /1   ]  3.67085225703        1
[INPUT] 1    0    [1    /1   ]  12.4401344326        1
[INPUT] 1    0    [1    /1   ]  54.7526600271        1
[INPUT] 1    0    [1    /1   ]  0.194332942001       1
[INPUT] 1    0    [1    /1   ]  1.25695188871        1
[INPUT] 1    0    [1    /1   ]  0.476277574436       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873006911, 1.0]], [0, [2712.096818690856, 1.0]], [0, [617.4986001794675, 1.0]], [0, [174.90601303587457, 1.0]], [0, [20.494833994299942, 1.0]], [0, [56.96178691247383, 1.0]], [0, [0.48755114976395775, 1.0]], [0, [7.827484654117159, 1.0]], [0, [1.6547159978451882, 1.0]], [1, [3.6708522570316706, 1.0]], [1, [12.440134432606081, 1.0]], [1, [54.752660027109044, 1.0]], [1, [0.19433294200131102, 1.0]], [1, [1.2569518887062907, 1.0]], [1, [0.47627757443579716, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681869]
bas 2, expnt(s) = [617.49860018]
bas 3, expnt(s) = [174.90601304]
bas 4, expnt(s) = [20.49483399]
bas 5, expnt(s) = [56.96178691]
bas 6, expnt(s) = [0.48755115]
bas 7, expnt(s) = [7.82748465]
bas 8, expnt(s) = [1.654716]
bas 9, expnt(s) = [3.67085226]
bas 10, expnt(s) = [12.44013443]
bas 11, expnt(s) = [54.75266003]
bas 12, expnt(s) = [0.19433294]
bas 13, expnt(s) = [1.25695189]
bas 14, expnt(s) = [0.47627757]
CPU time:        16.56
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906013e+02 1.21511835e+02
 2.04948340e+01 2.43359513e+01 5.69617869e+01 5.23844909e+01
 4.87551150e-01 1.47411092e+00 7.82748465e+00 1.18231090e+01
 1.65471600e+00 3.68601946e+00 3.67085226e+00 1.48232360e+01
 1.24401344e+01 6.81578268e+01 5.47526600e+01 4.34501141e+02
 1.94332942e-01 3.76415436e-01 1.25695189e+00 3.88268995e+00
 4.76277574e-01 1.15427572e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99941536746304
cond(S) = 239.69939729069208
E1 = -183.57949044966796  E_coul = 55.08018332877208
init E= -128.499307120896
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774543411090983  LUMO = 0.516539181228406
  mo_energy =
[-3.25544534e+01 -1.85129582e+00 -7.74543411e-01 -7.74543411e-01
 -7.74543411e-01  5.16539181e-01  5.16539181e-01  5.16539181e-01
  2.06186515e+00  2.18125724e+00  2.18125724e+00  2.18125724e+00
  7.14036294e+00  7.14036294e+00  7.14036294e+00  1.94459214e+01
  2.54159222e+01  2.54159222e+01  2.54159222e+01  9.39030358e+01
  1.19853342e+02  1.19853342e+02  1.19853342e+02  3.56252214e+02
  1.34962147e+03  5.83606302e+03  3.50986764e+04]
E1 = -182.04456401255325  E_coul = 53.51624095582629
cycle= 1 E= -128.528323056727  delta_E= -0.029  |g|= 0.209  |ddm|= 0.154
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.536491
diis-c [-0.28782263  1.        ]
  HOMO = -0.88512664516216  LUMO = 0.503542000846528
  mo_energy =
[-3.28856143e+01 -1.96783926e+00 -8.85126645e-01 -8.85126645e-01
 -8.85126645e-01  5.03542001e-01  5.03542001e-01  5.03542001e-01
  1.98248115e+00  2.12674814e+00  2.12674814e+00  2.12674814e+00
  7.00775757e+00  7.00775757e+00  7.00775757e+00  1.92187039e+01
  2.51743531e+01  2.51743531e+01  2.51743531e+01  9.35911440e+01
  1.19520594e+02  1.19520594e+02  1.19520594e+02  3.55891818e+02
  1.34922263e+03  5.83563227e+03  3.50982240e+04]
E1 = -182.82803024961086  E_coul = 54.296990185536366
cycle= 2 E= -128.531040064074  delta_E= -0.00272  |g|= 0.106  |ddm|= 0.0702
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.273347
diis-c [-5.95511899e-04  3.36869896e-01  6.63130104e-01]
  HOMO = -0.848475933754294  LUMO = 0.50794712588529
  mo_energy =
[-3.27747820e+01 -1.92912483e+00 -8.48475934e-01 -8.48475934e-01
 -8.48475934e-01  5.07947126e-01  5.07947126e-01  5.07947126e-01
  2.00860059e+00  2.14462526e+00  2.14462526e+00  2.14462526e+00
  7.05159516e+00  7.05159516e+00  7.05159516e+00  1.92950389e+01
  2.52553506e+01  2.52553506e+01  2.52553506e+01  9.36958187e+01
  1.19631249e+02  1.19631249e+02  1.19631249e+02  3.56009628e+02
  1.34934686e+03  5.83575954e+03  3.50983524e+04]
E1 = -182.5627791171569  E_coul = 54.03077113157108
cycle= 3 E= -128.532007985586  delta_E= -0.000968  |g|= 0.000315  |ddm|= 0.0242
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000759529
diis-c [-7.40396085e-08 -1.74269896e-03 -8.29408943e-04  1.00257211e+00]
  HOMO = -0.848641827543468  LUMO = 0.507947963740563
  mo_energy =
[-3.27751028e+01 -1.92925096e+00 -8.48641828e-01 -8.48641828e-01
 -8.48641828e-01  5.07947964e-01  5.07947964e-01  5.07947964e-01
  2.00854654e+00  2.14458173e+00  2.14458173e+00  2.14458173e+00
  7.05146636e+00  7.05146636e+00  7.05146636e+00  1.92948442e+01
  2.52551252e+01  2.52551252e+01  2.52551252e+01  9.36955241e+01
  1.19630917e+02  1.19630917e+02  1.19630917e+02  3.56009232e+02
  1.34934635e+03  5.83575892e+03  3.50983518e+04]
E1 = -182.5630121427451  E_coul = 54.03100414915102
cycle= 4 E= -128.532007993594  delta_E= -8.01e-09  |g|= 5.68e-05  |ddm|= 0.000108
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000145007
diis-c [-4.42566318e-10  6.40092168e-05  4.29850861e-04 -1.03226067e-01
  1.10273221e+00]
  HOMO = -0.848671186916454  LUMO = 0.50794319913181
  mo_energy =
[-3.27751575e+01 -1.92927823e+00 -8.48671187e-01 -8.48671187e-01
 -8.48671187e-01  5.07943199e-01  5.07943199e-01  5.07943199e-01
  2.00852480e+00  2.14456414e+00  2.14456414e+00  2.14456414e+00
  7.05143216e+00  7.05143216e+00  7.05143216e+00  1.92947990e+01
  2.52550774e+01  2.52550774e+01  2.52550774e+01  9.36954710e+01
  1.19630862e+02  1.19630862e+02  1.19630862e+02  3.56009174e+02
  1.34934629e+03  5.83575886e+03  3.50983517e+04]
E1 = -182.56312109604826  E_coul = 54.03111310214996
cycle= 5 E= -128.532007993898  delta_E= -3.04e-10  |g|= 1.85e-06  |ddm|= 2.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56312109604826  E_coul = 54.03111310214996
  HOMO = -0.848670977568854  LUMO = 0.507943147029576
  mo_energy =
[-3.27751567e+01 -1.92927782e+00 -8.48670978e-01 -8.48670978e-01
 -8.48670978e-01  5.07943147e-01  5.07943147e-01  5.07943147e-01
  2.00852502e+00  2.14456411e+00  2.14456411e+00  2.14456411e+00
  7.05143243e+00  7.05143243e+00  7.05143243e+00  1.92947998e+01
  2.52550781e+01  2.52550781e+01  2.52550781e+01  9.36954717e+01
  1.19630863e+02  1.19630863e+02  1.19630863e+02  3.56009175e+02
  1.34934629e+03  5.83575886e+03  3.50983517e+04]
E1 = -182.5631167265858  E_coul = 54.031108732686775
Extra cycle  E= -128.532007993899  delta_E= -7.11e-13  |g|= 5.82e-07  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906013e+02
 2.04948340e+01 5.69617869e+01 4.87551150e-01 7.82748465e+00
 1.65471600e+00 3.67085226e+00 1.24401344e+01 5.47526600e+01
 1.94332942e-01 1.25695189e+00 4.76277574e-01]
E = -128.53200799389901
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681869        1
[INPUT] 0    0    [1    /1   ]  617.498600179        1
[INPUT] 0    0    [1    /1   ]  174.906013036        1
[INPUT] 0    0    [1    /1   ]  20.4948339943        1
[INPUT] 0    0    [1    /1   ]  56.9617869125        1
[INPUT] 0    0    [1    /1   ]  0.487551149764       1
[INPUT] 0    0    [1    /1   ]  7.82748465412        1
[INPUT] 0    0    [1    /1   ]  1.65471599785        1
[INPUT] 1    0    [1    /1   ]  3.67085225703        1
[INPUT] 1    0    [1    /1   ]  12.4401344326        1
[INPUT] 1    0    [1    /1   ]  54.7526600271        1
[INPUT] 1    0    [1    /1   ]  0.194332942001       1
[INPUT] 1    0    [1    /1   ]  1.25695188871        1
[INPUT] 1    0    [1    /1   ]  0.476277574436       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873006911, 1.0]], [0, [2712.096818690856, 1.0]], [0, [617.4986001794675, 1.0]], [0, [174.90601303587457, 1.0]], [0, [20.494833994299942, 1.0]], [0, [56.96178691247383, 1.0]], [0, [0.48755114976395775, 1.0]], [0, [7.827484654117159, 1.0]], [0, [1.6547159978451882, 1.0]], [1, [3.6708522570316706, 1.0]], [1, [12.440134432606081, 1.0]], [1, [54.752660027109044, 1.0]], [1, [0.19433294200131102, 1.0]], [1, [1.2569518887062907, 1.0]], [1, [0.47627757443579716, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681869]
bas 2, expnt(s) = [617.49860018]
bas 3, expnt(s) = [174.90601304]
bas 4, expnt(s) = [20.49483399]
bas 5, expnt(s) = [56.96178691]
bas 6, expnt(s) = [0.48755115]
bas 7, expnt(s) = [7.82748465]
bas 8, expnt(s) = [1.654716]
bas 9, expnt(s) = [3.67085226]
bas 10, expnt(s) = [12.44013443]
bas 11, expnt(s) = [54.75266003]
bas 12, expnt(s) = [0.19433294]
bas 13, expnt(s) = [1.25695189]
bas 14, expnt(s) = [0.47627757]
CPU time:        16.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906013e+02 1.21511835e+02
 2.04948340e+01 2.43359513e+01 5.69617869e+01 5.23844909e+01
 4.87551150e-01 1.47411092e+00 7.82748465e+00 1.18231090e+01
 1.65471600e+00 3.68601946e+00 3.67085226e+00 1.48232360e+01
 1.24401344e+01 6.81578268e+01 5.47526600e+01 4.34501141e+02
 1.94332942e-01 3.76415436e-01 1.25695189e+00 3.88268995e+00
 4.76277574e-01 1.15427572e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99941536746304
cond(S) = 239.69939729069208
E1 = -183.57949044966796  E_coul = 55.08018332877208
init E= -128.499307120896
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774543411090983  LUMO = 0.516539181228406
  mo_energy =
[-3.25544534e+01 -1.85129582e+00 -7.74543411e-01 -7.74543411e-01
 -7.74543411e-01  5.16539181e-01  5.16539181e-01  5.16539181e-01
  2.06186515e+00  2.18125724e+00  2.18125724e+00  2.18125724e+00
  7.14036294e+00  7.14036294e+00  7.14036294e+00  1.94459214e+01
  2.54159222e+01  2.54159222e+01  2.54159222e+01  9.39030358e+01
  1.19853342e+02  1.19853342e+02  1.19853342e+02  3.56252214e+02
  1.34962147e+03  5.83606302e+03  3.50986764e+04]
E1 = -182.04456401255325  E_coul = 53.51624095582629
cycle= 1 E= -128.528323056727  delta_E= -0.029  |g|= 0.209  |ddm|= 0.154
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.536491
diis-c [-0.28782263  1.        ]
  HOMO = -0.88512664516216  LUMO = 0.503542000846528
  mo_energy =
[-3.28856143e+01 -1.96783926e+00 -8.85126645e-01 -8.85126645e-01
 -8.85126645e-01  5.03542001e-01  5.03542001e-01  5.03542001e-01
  1.98248115e+00  2.12674814e+00  2.12674814e+00  2.12674814e+00
  7.00775757e+00  7.00775757e+00  7.00775757e+00  1.92187039e+01
  2.51743531e+01  2.51743531e+01  2.51743531e+01  9.35911440e+01
  1.19520594e+02  1.19520594e+02  1.19520594e+02  3.55891818e+02
  1.34922263e+03  5.83563227e+03  3.50982240e+04]
E1 = -182.82803024961086  E_coul = 54.296990185536366
cycle= 2 E= -128.531040064074  delta_E= -0.00272  |g|= 0.106  |ddm|= 0.0702
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.273347
diis-c [-5.95511899e-04  3.36869896e-01  6.63130104e-01]
  HOMO = -0.848475933754294  LUMO = 0.50794712588529
  mo_energy =
[-3.27747820e+01 -1.92912483e+00 -8.48475934e-01 -8.48475934e-01
 -8.48475934e-01  5.07947126e-01  5.07947126e-01  5.07947126e-01
  2.00860059e+00  2.14462526e+00  2.14462526e+00  2.14462526e+00
  7.05159516e+00  7.05159516e+00  7.05159516e+00  1.92950389e+01
  2.52553506e+01  2.52553506e+01  2.52553506e+01  9.36958187e+01
  1.19631249e+02  1.19631249e+02  1.19631249e+02  3.56009628e+02
  1.34934686e+03  5.83575954e+03  3.50983524e+04]
E1 = -182.5627791171569  E_coul = 54.03077113157108
cycle= 3 E= -128.532007985586  delta_E= -0.000968  |g|= 0.000315  |ddm|= 0.0242
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000759529
diis-c [-7.40396085e-08 -1.74269896e-03 -8.29408943e-04  1.00257211e+00]
  HOMO = -0.848641827543468  LUMO = 0.507947963740563
  mo_energy =
[-3.27751028e+01 -1.92925096e+00 -8.48641828e-01 -8.48641828e-01
 -8.48641828e-01  5.07947964e-01  5.07947964e-01  5.07947964e-01
  2.00854654e+00  2.14458173e+00  2.14458173e+00  2.14458173e+00
  7.05146636e+00  7.05146636e+00  7.05146636e+00  1.92948442e+01
  2.52551252e+01  2.52551252e+01  2.52551252e+01  9.36955241e+01
  1.19630917e+02  1.19630917e+02  1.19630917e+02  3.56009232e+02
  1.34934635e+03  5.83575892e+03  3.50983518e+04]
E1 = -182.5630121427451  E_coul = 54.03100414915102
cycle= 4 E= -128.532007993594  delta_E= -8.01e-09  |g|= 5.68e-05  |ddm|= 0.000108
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000145007
diis-c [-4.42566318e-10  6.40092168e-05  4.29850861e-04 -1.03226067e-01
  1.10273221e+00]
  HOMO = -0.848671186916454  LUMO = 0.50794319913181
  mo_energy =
[-3.27751575e+01 -1.92927823e+00 -8.48671187e-01 -8.48671187e-01
 -8.48671187e-01  5.07943199e-01  5.07943199e-01  5.07943199e-01
  2.00852480e+00  2.14456414e+00  2.14456414e+00  2.14456414e+00
  7.05143216e+00  7.05143216e+00  7.05143216e+00  1.92947990e+01
  2.52550774e+01  2.52550774e+01  2.52550774e+01  9.36954710e+01
  1.19630862e+02  1.19630862e+02  1.19630862e+02  3.56009174e+02
  1.34934629e+03  5.83575886e+03  3.50983517e+04]
E1 = -182.56312109604826  E_coul = 54.03111310214996
cycle= 5 E= -128.532007993898  delta_E= -3.04e-10  |g|= 1.85e-06  |ddm|= 2.18e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.56312109604826  E_coul = 54.03111310214996
  HOMO = -0.848670977568854  LUMO = 0.507943147029576
  mo_energy =
[-3.27751567e+01 -1.92927782e+00 -8.48670978e-01 -8.48670978e-01
 -8.48670978e-01  5.07943147e-01  5.07943147e-01  5.07943147e-01
  2.00852502e+00  2.14456411e+00  2.14456411e+00  2.14456411e+00
  7.05143243e+00  7.05143243e+00  7.05143243e+00  1.92947998e+01
  2.52550781e+01  2.52550781e+01  2.52550781e+01  9.36954717e+01
  1.19630863e+02  1.19630863e+02  1.19630863e+02  3.56009175e+02
  1.34934629e+03  5.83575886e+03  3.50983517e+04]
E1 = -182.5631167265858  E_coul = 54.031108732686775
Extra cycle  E= -128.532007993899  delta_E= -7.11e-13  |g|= 5.82e-07  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.69939729069208
E1 = -182.5631167265858  E_coul = 54.031108732686775
init E= -128.532007993899
    CPU time for initialize scf      0.30 sec, wall time      0.29 sec
  HOMO = -0.848671313713854  LUMO = 0.507943092455492
  mo_energy =
[-3.27751575e+01 -1.92927814e+00 -8.48671314e-01 -8.48671314e-01
 -8.48671314e-01  5.07943092e-01  5.07943092e-01  5.07943092e-01
  2.00852477e+00  2.14456392e+00  2.14456392e+00  2.14456392e+00
  7.05143203e+00  7.05143203e+00  7.05143203e+00  1.92947992e+01
  2.52550774e+01  2.52550774e+01  2.52550774e+01  9.36954709e+01
  1.19630862e+02  1.19630862e+02  1.19630862e+02  3.56009174e+02
  1.34934629e+03  5.83575886e+03  3.50983517e+04]
E1 = -182.5631184800799  E_coul = 54.031110486181035
cycle= 1 E= -128.532007993899  delta_E= 1.42e-13  |g|= 2.52e-07  |ddm|= 3.07e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5631184800799  E_coul = 54.031110486181035
  HOMO = -0.848671194404423  LUMO = 0.507943104393455
  mo_energy =
[-3.27751572e+01 -1.92927801e+00 -8.48671194e-01 -8.48671194e-01
 -8.48671194e-01  5.07943104e-01  5.07943104e-01  5.07943104e-01
  2.00852486e+00  2.14456398e+00  2.14456398e+00  2.14456398e+00
  7.05143217e+00  7.05143217e+00  7.05143217e+00  1.92947994e+01
  2.52550777e+01  2.52550777e+01  2.52550777e+01  9.36954713e+01
  1.19630863e+02  1.19630863e+02  1.19630863e+02  3.56009174e+02
  1.34934629e+03  5.83575886e+03  3.50983517e+04]
E1 = -182.56311749035734  E_coul = 54.031109496458285
Extra cycle  E= -128.532007993899  delta_E= -1.99e-13  |g|= 1.32e-07  |ddm|= 1.05e-07
    CPU time for scf_cycle      0.38 sec, wall time      0.37 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906013e+02
 2.04948340e+01 5.69617869e+01 4.87551150e-01 7.82748465e+00
 1.65471600e+00 3.67085226e+00 1.24401344e+01 5.47526600e+01
 1.94332942e-01 1.25695189e+00 4.76277574e-01]
grad_E = [-2.15959856e-11  1.36573149e-09 -3.26708285e-08  4.68162066e-07
  3.86513458e-06 -3.74919639e-06 -3.57386922e-04  5.05767475e-06
  5.64059381e-05 -9.50143097e-03  1.53224956e-03 -5.66552263e-05
  1.02324603e-02  2.32475061e-03 -5.00730496e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681869        1
[INPUT] 0    0    [1    /1   ]  617.498600265        1
[INPUT] 0    0    [1    /1   ]  174.906011792        1
[INPUT] 0    0    [1    /1   ]  20.494821696         1
[INPUT] 0    0    [1    /1   ]  56.961796859         1
[INPUT] 0    0    [1    /1   ]  0.488175015858       1
[INPUT] 0    0    [1    /1   ]  7.82747514452        1
[INPUT] 0    0    [1    /1   ]  1.65469779314        1
[INPUT] 1    0    [1    /1   ]  3.68420052633        1
[INPUT] 1    0    [1    /1   ]  12.4376875011        1
[INPUT] 1    0    [1    /1   ]  54.7527527724        1
[INPUT] 1    0    [1    /1   ]  0.171331883252       1
[INPUT] 1    0    [1    /1   ]  1.27107604804        1
[INPUT] 1    0    [1    /1   ]  0.474714033355       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069168, 1.0]], [0, [2712.0968186872424, 1.0]], [0, [617.4986002654394, 1.0]], [0, [174.90601179205842, 1.0]], [0, [20.49482169595911, 1.0]], [0, [56.96179685896671, 1.0]], [0, [0.488175015858189, 1.0]], [0, [7.82747514452457, 1.0]], [0, [1.6546977931360982, 1.0]], [1, [3.684200526326023, 1.0]], [1, [12.4376875011103, 1.0]], [1, [54.752752772394366, 1.0]], [1, [0.1713318832522711, 1.0]], [1, [1.2710760480392513, 1.0]], [1, [0.4747140333545902, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681869]
bas 2, expnt(s) = [617.49860027]
bas 3, expnt(s) = [174.90601179]
bas 4, expnt(s) = [20.4948217]
bas 5, expnt(s) = [56.96179686]
bas 6, expnt(s) = [0.48817502]
bas 7, expnt(s) = [7.82747514]
bas 8, expnt(s) = [1.65469779]
bas 9, expnt(s) = [3.68420053]
bas 10, expnt(s) = [12.4376875]
bas 11, expnt(s) = [54.75275277]
bas 12, expnt(s) = [0.17133188]
bas 13, expnt(s) = [1.27107605]
bas 14, expnt(s) = [0.47471403]
CPU time:        19.55
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906012e+02 1.21511834e+02
 2.04948217e+01 2.43359404e+01 5.69617969e+01 5.23844978e+01
 4.88175016e-01 1.47552539e+00 7.82747514e+00 1.18230982e+01
 1.65469779e+00 3.68598904e+00 3.68420053e+00 1.48906436e+01
 1.24376875e+01 6.81410692e+01 5.47527528e+01 4.34502061e+02
 1.71331883e-01 3.21574889e-01 1.27107605e+00 3.93730276e+00
 4.74714033e-01 1.14954104e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999450687784249
cond(S) = 239.73942541333258
E1 = -183.5796677796371  E_coul = 55.0801313189529
init E= -128.499536460684
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774572659687476  LUMO = 0.464777387841805
  mo_energy =
[-3.25544705e+01 -1.85130459e+00 -7.74572660e-01 -7.74572660e-01
 -7.74572660e-01  4.64777388e-01  4.64777388e-01  4.64777388e-01
  2.06394386e+00  2.09786762e+00  2.09786762e+00  2.09786762e+00
  7.09579845e+00  7.09579845e+00  7.09579845e+00  1.94487345e+01
  2.54291370e+01  2.54291370e+01  2.54291370e+01  9.39053640e+01
  1.19875916e+02  1.19875916e+02  1.19875916e+02  3.56254214e+02
  1.34962327e+03  5.83606461e+03  3.50986777e+04]
E1 = -182.03937580101922  E_coul = 53.51092075951513
cycle= 1 E= -128.528455041504  delta_E= -0.0289  |g|= 0.209  |ddm|= 0.153
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53016
diis-c [-0.2810693  1.       ]
  HOMO = -0.885591226530925  LUMO = 0.453066867852221
  mo_energy =
[-3.28864346e+01 -1.96837034e+00 -8.85591227e-01 -8.85591227e-01
 -8.85591227e-01  4.53066868e-01  4.53066868e-01  4.53066868e-01
  1.98411042e+00  2.04302018e+00  2.04302018e+00  2.04302018e+00
  6.96164082e+00  6.96164082e+00  6.96164082e+00  1.92207618e+01
  2.51866292e+01  2.51866292e+01  2.51866292e+01  9.35926659e+01
  1.19542383e+02  1.19542383e+02  1.19542383e+02  3.55892990e+02
  1.34922356e+03  5.83563297e+03  3.50982244e+04]
E1 = -182.8263682301597  E_coul = 54.29518376095568
cycle= 2 E= -128.531184469204  delta_E= -0.00273  |g|= 0.107  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.270761
diis-c [-5.96380779e-04  3.37386192e-01  6.62613808e-01]
  HOMO = -0.848794832532125  LUMO = 0.457009165788231
  mo_energy =
[-3.27752306e+01 -1.92949744e+00 -8.48794833e-01 -8.48794833e-01
 -8.48794833e-01  4.57009166e-01  4.57009166e-01  4.57009166e-01
  2.01035533e+00  2.06096784e+00  2.06096784e+00  2.06096784e+00
  7.00599389e+00  7.00599389e+00  7.00599389e+00  1.92973712e+01
  2.52679871e+01  2.52679871e+01  2.52679871e+01  9.36976943e+01
  1.19653408e+02  1.19653408e+02  1.19653408e+02  3.56011186e+02
  1.34934819e+03  5.83576065e+03  3.50983533e+04]
E1 = -182.5592338114899  E_coul = 54.02707117152433
cycle= 3 E= -128.532162639966  delta_E= -0.000978  |g|= 0.000358  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000785015
diis-c [-1.17535636e-07 -1.83889210e-03 -9.97814453e-04  1.00283671e+00]
  HOMO = -0.848986759629455  LUMO = 0.457000813712091
  mo_energy =
[-3.27755852e+01 -1.92965809e+00 -8.48986760e-01 -8.48986760e-01
 -8.48986760e-01  4.57000814e-01  4.57000814e-01  4.57000814e-01
  2.01027033e+00  2.06090125e+00  2.06090125e+00  2.06090125e+00
  7.00583245e+00  7.00583245e+00  7.00583245e+00  1.92971412e+01
  2.52677270e+01  2.52677270e+01  2.52677270e+01  9.36973655e+01
  1.19653043e+02  1.19653043e+02  1.19653043e+02  3.56010757e+02
  1.34934765e+03  5.83576001e+03  3.50983526e+04]
E1 = -182.55940403618922  E_coul = 54.02724137911617
cycle= 4 E= -128.532162657073  delta_E= -1.71e-08  |g|= 6.79e-05  |ddm|= 0.000218
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000147085
diis-c [-6.88923894e-10  1.08303953e-04  4.38661207e-04 -1.37699407e-01
  1.13715244e+00]
  HOMO = -0.849024066754138  LUMO = 0.456994225081883
  mo_energy =
[-3.27756499e+01 -1.92969617e+00 -8.49024067e-01 -8.49024067e-01
 -8.49024067e-01  4.56994225e-01  4.56994225e-01  4.56994225e-01
  2.01023887e+00  2.06087677e+00  2.06087677e+00  2.06087677e+00
  7.00578825e+00  7.00578825e+00  7.00578825e+00  1.92970850e+01
  2.52676685e+01  2.52676685e+01  2.52676685e+01  9.36973022e+01
  1.19652979e+02  1.19652979e+02  1.19652979e+02  3.56010691e+02
  1.34934758e+03  5.83575993e+03  3.50983525e+04]
E1 = -182.5595033023533  E_coul = 54.02734064466793
cycle= 5 E= -128.532162657685  delta_E= -6.12e-10  |g|= 3.44e-06  |ddm|= 4.63e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5595033023533  E_coul = 54.02734064466793
  HOMO = -0.849023048376182  LUMO = 0.456994198200705
  mo_energy =
[-3.27756465e+01 -1.92969537e+00 -8.49023048e-01 -8.49023048e-01
 -8.49023048e-01  4.56994198e-01  4.56994198e-01  4.56994198e-01
  2.01023923e+00  2.06087701e+00  2.06087701e+00  2.06087701e+00
  7.00578943e+00  7.00578943e+00  7.00578943e+00  1.92970874e+01
  2.52676710e+01  2.52676710e+01  2.52676710e+01  9.36973054e+01
  1.19652982e+02  1.19652982e+02  1.19652982e+02  3.56010694e+02
  1.34934758e+03  5.83575994e+03  3.50983525e+04]
E1 = -182.55949064056355  E_coul = 54.02732798287578
Extra cycle  E= -128.532162657688  delta_E= -2.39e-12  |g|= 1.71e-06  |ddm|= 2.88e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906012e+02
 2.04948217e+01 5.69617969e+01 4.88175016e-01 7.82747514e+00
 1.65469779e+00 3.68420053e+00 1.24376875e+01 5.47527528e+01
 1.71331883e-01 1.27107605e+00 4.74714033e-01]
E = -128.53216265768776
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681869        1
[INPUT] 0    0    [1    /1   ]  617.498600265        1
[INPUT] 0    0    [1    /1   ]  174.906011792        1
[INPUT] 0    0    [1    /1   ]  20.494821696         1
[INPUT] 0    0    [1    /1   ]  56.961796859         1
[INPUT] 0    0    [1    /1   ]  0.488175015858       1
[INPUT] 0    0    [1    /1   ]  7.82747514452        1
[INPUT] 0    0    [1    /1   ]  1.65469779314        1
[INPUT] 1    0    [1    /1   ]  3.68420052633        1
[INPUT] 1    0    [1    /1   ]  12.4376875011        1
[INPUT] 1    0    [1    /1   ]  54.7527527724        1
[INPUT] 1    0    [1    /1   ]  0.171331883252       1
[INPUT] 1    0    [1    /1   ]  1.27107604804        1
[INPUT] 1    0    [1    /1   ]  0.474714033355       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069168, 1.0]], [0, [2712.0968186872424, 1.0]], [0, [617.4986002654394, 1.0]], [0, [174.90601179205842, 1.0]], [0, [20.49482169595911, 1.0]], [0, [56.96179685896671, 1.0]], [0, [0.488175015858189, 1.0]], [0, [7.82747514452457, 1.0]], [0, [1.6546977931360982, 1.0]], [1, [3.684200526326023, 1.0]], [1, [12.4376875011103, 1.0]], [1, [54.752752772394366, 1.0]], [1, [0.1713318832522711, 1.0]], [1, [1.2710760480392513, 1.0]], [1, [0.4747140333545902, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681869]
bas 2, expnt(s) = [617.49860027]
bas 3, expnt(s) = [174.90601179]
bas 4, expnt(s) = [20.4948217]
bas 5, expnt(s) = [56.96179686]
bas 6, expnt(s) = [0.48817502]
bas 7, expnt(s) = [7.82747514]
bas 8, expnt(s) = [1.65469779]
bas 9, expnt(s) = [3.68420053]
bas 10, expnt(s) = [12.4376875]
bas 11, expnt(s) = [54.75275277]
bas 12, expnt(s) = [0.17133188]
bas 13, expnt(s) = [1.27107605]
bas 14, expnt(s) = [0.47471403]
CPU time:        19.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906012e+02 1.21511834e+02
 2.04948217e+01 2.43359404e+01 5.69617969e+01 5.23844978e+01
 4.88175016e-01 1.47552539e+00 7.82747514e+00 1.18230982e+01
 1.65469779e+00 3.68598904e+00 3.68420053e+00 1.48906436e+01
 1.24376875e+01 6.81410692e+01 5.47527528e+01 4.34502061e+02
 1.71331883e-01 3.21574889e-01 1.27107605e+00 3.93730276e+00
 4.74714033e-01 1.14954104e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999450687784249
cond(S) = 239.73942541333258
E1 = -183.5796677796371  E_coul = 55.0801313189529
init E= -128.499536460684
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774572659687476  LUMO = 0.464777387841805
  mo_energy =
[-3.25544705e+01 -1.85130459e+00 -7.74572660e-01 -7.74572660e-01
 -7.74572660e-01  4.64777388e-01  4.64777388e-01  4.64777388e-01
  2.06394386e+00  2.09786762e+00  2.09786762e+00  2.09786762e+00
  7.09579845e+00  7.09579845e+00  7.09579845e+00  1.94487345e+01
  2.54291370e+01  2.54291370e+01  2.54291370e+01  9.39053640e+01
  1.19875916e+02  1.19875916e+02  1.19875916e+02  3.56254214e+02
  1.34962327e+03  5.83606461e+03  3.50986777e+04]
E1 = -182.03937580101922  E_coul = 53.51092075951513
cycle= 1 E= -128.528455041504  delta_E= -0.0289  |g|= 0.209  |ddm|= 0.153
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53016
diis-c [-0.2810693  1.       ]
  HOMO = -0.885591226530925  LUMO = 0.453066867852221
  mo_energy =
[-3.28864346e+01 -1.96837034e+00 -8.85591227e-01 -8.85591227e-01
 -8.85591227e-01  4.53066868e-01  4.53066868e-01  4.53066868e-01
  1.98411042e+00  2.04302018e+00  2.04302018e+00  2.04302018e+00
  6.96164082e+00  6.96164082e+00  6.96164082e+00  1.92207618e+01
  2.51866292e+01  2.51866292e+01  2.51866292e+01  9.35926659e+01
  1.19542383e+02  1.19542383e+02  1.19542383e+02  3.55892990e+02
  1.34922356e+03  5.83563297e+03  3.50982244e+04]
E1 = -182.8263682301597  E_coul = 54.29518376095568
cycle= 2 E= -128.531184469204  delta_E= -0.00273  |g|= 0.107  |ddm|= 0.0712
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.270761
diis-c [-5.96380779e-04  3.37386192e-01  6.62613808e-01]
  HOMO = -0.848794832532125  LUMO = 0.457009165788231
  mo_energy =
[-3.27752306e+01 -1.92949744e+00 -8.48794833e-01 -8.48794833e-01
 -8.48794833e-01  4.57009166e-01  4.57009166e-01  4.57009166e-01
  2.01035533e+00  2.06096784e+00  2.06096784e+00  2.06096784e+00
  7.00599389e+00  7.00599389e+00  7.00599389e+00  1.92973712e+01
  2.52679871e+01  2.52679871e+01  2.52679871e+01  9.36976943e+01
  1.19653408e+02  1.19653408e+02  1.19653408e+02  3.56011186e+02
  1.34934819e+03  5.83576065e+03  3.50983533e+04]
E1 = -182.5592338114899  E_coul = 54.02707117152433
cycle= 3 E= -128.532162639966  delta_E= -0.000978  |g|= 0.000358  |ddm|= 0.0245
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000785015
diis-c [-1.17535636e-07 -1.83889210e-03 -9.97814453e-04  1.00283671e+00]
  HOMO = -0.848986759629455  LUMO = 0.457000813712091
  mo_energy =
[-3.27755852e+01 -1.92965809e+00 -8.48986760e-01 -8.48986760e-01
 -8.48986760e-01  4.57000814e-01  4.57000814e-01  4.57000814e-01
  2.01027033e+00  2.06090125e+00  2.06090125e+00  2.06090125e+00
  7.00583245e+00  7.00583245e+00  7.00583245e+00  1.92971412e+01
  2.52677270e+01  2.52677270e+01  2.52677270e+01  9.36973655e+01
  1.19653043e+02  1.19653043e+02  1.19653043e+02  3.56010757e+02
  1.34934765e+03  5.83576001e+03  3.50983526e+04]
E1 = -182.55940403618922  E_coul = 54.02724137911617
cycle= 4 E= -128.532162657073  delta_E= -1.71e-08  |g|= 6.79e-05  |ddm|= 0.000218
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000147085
diis-c [-6.88923894e-10  1.08303953e-04  4.38661207e-04 -1.37699407e-01
  1.13715244e+00]
  HOMO = -0.849024066754138  LUMO = 0.456994225081883
  mo_energy =
[-3.27756499e+01 -1.92969617e+00 -8.49024067e-01 -8.49024067e-01
 -8.49024067e-01  4.56994225e-01  4.56994225e-01  4.56994225e-01
  2.01023887e+00  2.06087677e+00  2.06087677e+00  2.06087677e+00
  7.00578825e+00  7.00578825e+00  7.00578825e+00  1.92970850e+01
  2.52676685e+01  2.52676685e+01  2.52676685e+01  9.36973022e+01
  1.19652979e+02  1.19652979e+02  1.19652979e+02  3.56010691e+02
  1.34934758e+03  5.83575993e+03  3.50983525e+04]
E1 = -182.5595033023533  E_coul = 54.02734064466793
cycle= 5 E= -128.532162657685  delta_E= -6.12e-10  |g|= 3.44e-06  |ddm|= 4.63e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5595033023533  E_coul = 54.02734064466793
  HOMO = -0.849023048376182  LUMO = 0.456994198200705
  mo_energy =
[-3.27756465e+01 -1.92969537e+00 -8.49023048e-01 -8.49023048e-01
 -8.49023048e-01  4.56994198e-01  4.56994198e-01  4.56994198e-01
  2.01023923e+00  2.06087701e+00  2.06087701e+00  2.06087701e+00
  7.00578943e+00  7.00578943e+00  7.00578943e+00  1.92970874e+01
  2.52676710e+01  2.52676710e+01  2.52676710e+01  9.36973054e+01
  1.19652982e+02  1.19652982e+02  1.19652982e+02  3.56010694e+02
  1.34934758e+03  5.83575994e+03  3.50983525e+04]
E1 = -182.55949064056355  E_coul = 54.02732798287578
Extra cycle  E= -128.532162657688  delta_E= -2.39e-12  |g|= 1.71e-06  |ddm|= 2.88e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.73942541333258
E1 = -182.55949064056355  E_coul = 54.02732798287578
init E= -128.532162657688
    CPU time for initialize scf      0.31 sec, wall time      0.30 sec
  HOMO = -0.849023970802774  LUMO = 0.456994071970132
  mo_energy =
[-3.27756490e+01 -1.92969642e+00 -8.49023971e-01 -8.49023971e-01
 -8.49023971e-01  4.56994072e-01  4.56994072e-01  4.56994072e-01
  2.01023846e+00  2.06087650e+00  2.06087650e+00  2.06087650e+00
  7.00578831e+00  7.00578831e+00  7.00578831e+00  1.92970855e+01
  2.52676691e+01  2.52676691e+01  2.52676691e+01  9.36973030e+01
  1.19652980e+02  1.19652980e+02  1.19652980e+02  3.56010692e+02
  1.34934758e+03  5.83575993e+03  3.50983525e+04]
E1 = -182.5594960249823  E_coul = 54.0273333672943
cycle= 1 E= -128.532162657688  delta_E= -2.56e-13  |g|= 7.51e-07  |ddm|= 8.21e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5594960249823  E_coul = 54.0273333672943
  HOMO = -0.849023594821055  LUMO = 0.456994107167416
  mo_energy =
[-3.27756478e+01 -1.92969605e+00 -8.49023595e-01 -8.49023595e-01
 -8.49023595e-01  4.56994107e-01  4.56994107e-01  4.56994107e-01
  2.01023871e+00  2.06087667e+00  2.06087667e+00  2.06087667e+00
  7.00578876e+00  7.00578876e+00  7.00578876e+00  1.92970863e+01
  2.52676700e+01  2.52676700e+01  2.52676700e+01  9.36973041e+01
  1.19652981e+02  1.19652981e+02  1.19652981e+02  3.56010693e+02
  1.34934758e+03  5.83575994e+03  3.50983525e+04]
E1 = -182.55949301888896  E_coul = 54.02733036120111
Extra cycle  E= -128.532162657688  delta_E= 1.71e-13  |g|= 4.05e-07  |ddm|= 2.64e-07
    CPU time for scf_cycle      0.38 sec, wall time      0.38 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906012e+02
 2.04948217e+01 5.69617969e+01 4.88175016e-01 7.82747514e+00
 1.65469779e+00 3.68420053e+00 1.24376875e+01 5.47527528e+01
 1.71331883e-01 1.27107605e+00 4.74714033e-01]
grad_E = [-2.69079953e-11  1.65831358e-09 -3.81884534e-08  5.42411465e-07
  7.86956750e-06 -4.29746837e-06  7.79151135e-04 -3.32497173e-06
 -2.69693898e-04 -8.52963441e-03  1.34498918e-03 -4.84729280e-05
 -8.07419102e-03 -1.13728409e-03  6.60067530e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681869        1
[INPUT] 0    0    [1    /1   ]  617.498600316        1
[INPUT] 0    0    [1    /1   ]  174.906011076        1
[INPUT] 0    0    [1    /1   ]  20.4948121748        1
[INPUT] 0    0    [1    /1   ]  56.9618025377        1
[INPUT] 0    0    [1    /1   ]  0.487438477818       1
[INPUT] 0    0    [1    /1   ]  7.82747714024        1
[INPUT] 0    0    [1    /1   ]  1.65496783036        1
[INPUT] 1    0    [1    /1   ]  3.69596241094        1
[INPUT] 1    0    [1    /1   ]  12.4358087802        1
[INPUT] 1    0    [1    /1   ]  54.7528213563        1
[INPUT] 1    0    [1    /1   ]  0.172091210201       1
[INPUT] 1    0    [1    /1   ]  1.27156138837        1
[INPUT] 1    0    [1    /1   ]  0.471444982135       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069204, 1.0]], [0, [2712.0968186850732, 1.0]], [0, [617.4986003157412, 1.0]], [0, [174.90601107642223, 1.0]], [0, [20.49481217477209, 1.0]], [0, [56.96180253774756, 1.0]], [0, [0.4874384778184619, 1.0]], [0, [7.827477140236061, 1.0]], [0, [1.6549678303626107, 1.0]], [1, [3.695962410938013, 1.0]], [1, [12.435808780161272, 1.0]], [1, [54.75282135632853, 1.0]], [1, [0.17209121020149265, 1.0]], [1, [1.2715613883722918, 1.0]], [1, [0.4714449821351369, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681869]
bas 2, expnt(s) = [617.49860032]
bas 3, expnt(s) = [174.90601108]
bas 4, expnt(s) = [20.49481217]
bas 5, expnt(s) = [56.96180254]
bas 6, expnt(s) = [0.48743848]
bas 7, expnt(s) = [7.82747714]
bas 8, expnt(s) = [1.65496783]
bas 9, expnt(s) = [3.69596241]
bas 10, expnt(s) = [12.43580878]
bas 11, expnt(s) = [54.75282136]
bas 12, expnt(s) = [0.17209121]
bas 13, expnt(s) = [1.27156139]
bas 14, expnt(s) = [0.47144498]
CPU time:        22.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906011e+02 1.21511834e+02
 2.04948122e+01 2.43359319e+01 5.69618025e+01 5.23845017e+01
 4.87438478e-01 1.47385541e+00 7.82747714e+00 1.18231005e+01
 1.65496783e+00 3.68644018e+00 3.69596241e+00 1.49500906e+01
 1.24358088e+01 6.81282035e+01 5.47528214e+01 4.34502742e+02
 1.72091210e-01 3.23357362e-01 1.27156139e+00 3.93918210e+00
 4.71444982e-01 1.13965438e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999458270516012
cond(S) = 239.70307920686855
E1 = -183.57992673621274  E_coul = 55.08025913713025
init E= -128.499667599082
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774583089917517  LUMO = 0.465692070575084
  mo_energy =
[-3.25544492e+01 -1.85129430e+00 -7.74583090e-01 -7.74583090e-01
 -7.74583090e-01  4.65692071e-01  4.65692071e-01  4.65692071e-01
  2.06169219e+00  2.09301492e+00  2.09301492e+00  2.09301492e+00
  7.09617097e+00  7.09617097e+00  7.09617097e+00  1.94464936e+01
  2.54541196e+01  2.54541196e+01  2.54541196e+01  9.39035957e+01
  1.19901446e+02  1.19901446e+02  1.19901446e+02  3.56252699e+02
  1.34962195e+03  5.83606346e+03  3.50986767e+04]
E1 = -182.039091131182  E_coul = 53.510516583440335
cycle= 1 E= -128.528574547742  delta_E= -0.0289  |g|= 0.209  |ddm|= 0.154
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.530702
diis-c [-0.28164504  1.        ]
  HOMO = -0.885666758793844  LUMO = 0.453998362705836
  mo_energy =
[-3.28864520e+01 -1.96838995e+00 -8.85666759e-01 -8.85666759e-01
 -8.85666759e-01  4.53998363e-01  4.53998363e-01  4.53998363e-01
  1.98187368e+00  2.03828541e+00  2.03828541e+00  2.03828541e+00
  6.96174076e+00  6.96174076e+00  6.96174076e+00  1.92184359e+01
  2.52114869e+01  2.52114869e+01  2.52114869e+01  9.35908522e+01
  1.19567880e+02  1.19567880e+02  1.19567880e+02  3.55891429e+02
  1.34922218e+03  5.83563177e+03  3.50982234e+04]
E1 = -182.82637947630255  E_coul = 54.29507391916434
cycle= 2 E= -128.531305557138  delta_E= -0.00273  |g|= 0.107  |ddm|= 0.0711
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.271006
diis-c [-5.95931593e-04  3.37361390e-01  6.62638610e-01]
  HOMO = -0.848855355738835  LUMO = 0.457939158671593
  mo_energy =
[-3.27752018e+01 -1.92950060e+00 -8.48855356e-01 -8.48855356e-01
 -8.48855356e-01  4.57939159e-01  4.57939159e-01  4.57939159e-01
  2.00811947e+00  2.05619912e+00  2.05619912e+00  2.05619912e+00
  7.00618371e+00  7.00618371e+00  7.00618371e+00  1.92950788e+01
  2.52929028e+01  2.52929028e+01  2.52929028e+01  9.36959247e+01
  1.19678949e+02  1.19678949e+02  1.19678949e+02  3.56009673e+02
  1.34934687e+03  5.83575950e+03  3.50983523e+04]
E1 = -182.55920201416927  E_coul = 54.02691767822828
cycle= 3 E= -128.532284335941  delta_E= -0.000979  |g|= 0.000351  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000791168
diis-c [-1.09191460e-07 -1.81457455e-03 -9.04880773e-04  1.00271946e+00]
  HOMO = -0.849043365534421  LUMO = 0.457932586332398
  mo_energy =
[-3.27755516e+01 -1.92965314e+00 -8.49043366e-01 -8.49043366e-01
 -8.49043366e-01  4.57932586e-01  4.57932586e-01  4.57932586e-01
  2.00804180e+00  2.05613712e+00  2.05613712e+00  2.05613712e+00
  7.00602751e+00  7.00602751e+00  7.00602751e+00  1.92948548e+01
  2.52926482e+01  2.52926482e+01  2.52926482e+01  9.36956007e+01
  1.19678588e+02  1.19678588e+02  1.19678588e+02  3.56009247e+02
  1.34934632e+03  5.83575885e+03  3.50983516e+04]
E1 = -182.5593906450212  E_coul = 54.027106293998465
cycle= 4 E= -128.532284351023  delta_E= -1.51e-08  |g|= 6.64e-05  |ddm|= 0.000198
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000150093
diis-c [-6.21737436e-10  1.01437071e-04  4.46553716e-04 -1.32711691e-01
  1.13216370e+00]
  HOMO = -0.849079555482381  LUMO = 0.457926400495275
  mo_energy =
[-3.27756154e+01 -1.92968900e+00 -8.49079555e-01 -8.49079555e-01
 -8.49079555e-01  4.57926400e-01  4.57926400e-01  4.57926400e-01
  2.00801237e+00  2.05611384e+00  2.05611384e+00  2.05611384e+00
  7.00598473e+00  7.00598473e+00  7.00598473e+00  1.92948003e+01
  2.52925911e+01  2.52925911e+01  2.52925911e+01  9.36955385e+01
  1.19678524e+02  1.19678524e+02  1.19678524e+02  3.56009181e+02
  1.34934625e+03  5.83575878e+03  3.50983516e+04]
E1 = -182.55949482507927  E_coul = 54.02721047351157
cycle= 5 E= -128.532284351568  delta_E= -5.45e-10  |g|= 3.03e-06  |ddm|= 4.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.55949482507927  E_coul = 54.02721047351157
  HOMO = -0.849078715733792  LUMO = 0.457926364851231
  mo_energy =
[-3.27756125e+01 -1.92968826e+00 -8.49078716e-01 -8.49078716e-01
 -8.49078716e-01  4.57926365e-01  4.57926365e-01  4.57926365e-01
  2.00801271e+00  2.05611402e+00  2.05611402e+00  2.05611402e+00
  7.00598572e+00  7.00598572e+00  7.00598572e+00  1.92948023e+01
  2.52925932e+01  2.52925932e+01  2.52925932e+01  9.36955411e+01
  1.19678527e+02  1.19678527e+02  1.19678527e+02  3.56009184e+02
  1.34934626e+03  5.83575878e+03  3.50983516e+04]
E1 = -182.55948390006586  E_coul = 54.02719954849657
Extra cycle  E= -128.532284351569  delta_E= -1.59e-12  |g|= 1.46e-06  |ddm|= 2.68e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906011e+02
 2.04948122e+01 5.69618025e+01 4.87438478e-01 7.82747714e+00
 1.65496783e+00 3.69596241e+00 1.24358088e+01 5.47528214e+01
 1.72091210e-01 1.27156139e+00 4.71444982e-01]
E = -128.53228435156927
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:52:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681869        1
[INPUT] 0    0    [1    /1   ]  617.498600316        1
[INPUT] 0    0    [1    /1   ]  174.906011076        1
[INPUT] 0    0    [1    /1   ]  20.4948121748        1
[INPUT] 0    0    [1    /1   ]  56.9618025377        1
[INPUT] 0    0    [1    /1   ]  0.487438477818       1
[INPUT] 0    0    [1    /1   ]  7.82747714024        1
[INPUT] 0    0    [1    /1   ]  1.65496783036        1
[INPUT] 1    0    [1    /1   ]  3.69596241094        1
[INPUT] 1    0    [1    /1   ]  12.4358087802        1
[INPUT] 1    0    [1    /1   ]  54.7528213563        1
[INPUT] 1    0    [1    /1   ]  0.172091210201       1
[INPUT] 1    0    [1    /1   ]  1.27156138837        1
[INPUT] 1    0    [1    /1   ]  0.471444982135       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069204, 1.0]], [0, [2712.0968186850732, 1.0]], [0, [617.4986003157412, 1.0]], [0, [174.90601107642223, 1.0]], [0, [20.49481217477209, 1.0]], [0, [56.96180253774756, 1.0]], [0, [0.4874384778184619, 1.0]], [0, [7.827477140236061, 1.0]], [0, [1.6549678303626107, 1.0]], [1, [3.695962410938013, 1.0]], [1, [12.435808780161272, 1.0]], [1, [54.75282135632853, 1.0]], [1, [0.17209121020149265, 1.0]], [1, [1.2715613883722918, 1.0]], [1, [0.4714449821351369, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681869]
bas 2, expnt(s) = [617.49860032]
bas 3, expnt(s) = [174.90601108]
bas 4, expnt(s) = [20.49481217]
bas 5, expnt(s) = [56.96180254]
bas 6, expnt(s) = [0.48743848]
bas 7, expnt(s) = [7.82747714]
bas 8, expnt(s) = [1.65496783]
bas 9, expnt(s) = [3.69596241]
bas 10, expnt(s) = [12.43580878]
bas 11, expnt(s) = [54.75282136]
bas 12, expnt(s) = [0.17209121]
bas 13, expnt(s) = [1.27156139]
bas 14, expnt(s) = [0.47144498]
CPU time:        22.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498600e+02 3.12962287e+02 1.74906011e+02 1.21511834e+02
 2.04948122e+01 2.43359319e+01 5.69618025e+01 5.23845017e+01
 4.87438478e-01 1.47385541e+00 7.82747714e+00 1.18231005e+01
 1.65496783e+00 3.68644018e+00 3.69596241e+00 1.49500906e+01
 1.24358088e+01 6.81282035e+01 5.47528214e+01 4.34502742e+02
 1.72091210e-01 3.23357362e-01 1.27156139e+00 3.93918210e+00
 4.71444982e-01 1.13965438e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999458270516012
cond(S) = 239.70307920686855
E1 = -183.57992673621274  E_coul = 55.08025913713025
init E= -128.499667599082
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774583089917517  LUMO = 0.465692070575084
  mo_energy =
[-3.25544492e+01 -1.85129430e+00 -7.74583090e-01 -7.74583090e-01
 -7.74583090e-01  4.65692071e-01  4.65692071e-01  4.65692071e-01
  2.06169219e+00  2.09301492e+00  2.09301492e+00  2.09301492e+00
  7.09617097e+00  7.09617097e+00  7.09617097e+00  1.94464936e+01
  2.54541196e+01  2.54541196e+01  2.54541196e+01  9.39035957e+01
  1.19901446e+02  1.19901446e+02  1.19901446e+02  3.56252699e+02
  1.34962195e+03  5.83606346e+03  3.50986767e+04]
E1 = -182.039091131182  E_coul = 53.510516583440335
cycle= 1 E= -128.528574547742  delta_E= -0.0289  |g|= 0.209  |ddm|= 0.154
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.530702
diis-c [-0.28164504  1.        ]
  HOMO = -0.885666758793844  LUMO = 0.453998362705836
  mo_energy =
[-3.28864520e+01 -1.96838995e+00 -8.85666759e-01 -8.85666759e-01
 -8.85666759e-01  4.53998363e-01  4.53998363e-01  4.53998363e-01
  1.98187368e+00  2.03828541e+00  2.03828541e+00  2.03828541e+00
  6.96174076e+00  6.96174076e+00  6.96174076e+00  1.92184359e+01
  2.52114869e+01  2.52114869e+01  2.52114869e+01  9.35908522e+01
  1.19567880e+02  1.19567880e+02  1.19567880e+02  3.55891429e+02
  1.34922218e+03  5.83563177e+03  3.50982234e+04]
E1 = -182.82637947630255  E_coul = 54.29507391916434
cycle= 2 E= -128.531305557138  delta_E= -0.00273  |g|= 0.107  |ddm|= 0.0711
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.271006
diis-c [-5.95931593e-04  3.37361390e-01  6.62638610e-01]
  HOMO = -0.848855355738835  LUMO = 0.457939158671593
  mo_energy =
[-3.27752018e+01 -1.92950060e+00 -8.48855356e-01 -8.48855356e-01
 -8.48855356e-01  4.57939159e-01  4.57939159e-01  4.57939159e-01
  2.00811947e+00  2.05619912e+00  2.05619912e+00  2.05619912e+00
  7.00618371e+00  7.00618371e+00  7.00618371e+00  1.92950788e+01
  2.52929028e+01  2.52929028e+01  2.52929028e+01  9.36959247e+01
  1.19678949e+02  1.19678949e+02  1.19678949e+02  3.56009673e+02
  1.34934687e+03  5.83575950e+03  3.50983523e+04]
E1 = -182.55920201416927  E_coul = 54.02691767822828
cycle= 3 E= -128.532284335941  delta_E= -0.000979  |g|= 0.000351  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000791168
diis-c [-1.09191460e-07 -1.81457455e-03 -9.04880773e-04  1.00271946e+00]
  HOMO = -0.849043365534421  LUMO = 0.457932586332398
  mo_energy =
[-3.27755516e+01 -1.92965314e+00 -8.49043366e-01 -8.49043366e-01
 -8.49043366e-01  4.57932586e-01  4.57932586e-01  4.57932586e-01
  2.00804180e+00  2.05613712e+00  2.05613712e+00  2.05613712e+00
  7.00602751e+00  7.00602751e+00  7.00602751e+00  1.92948548e+01
  2.52926482e+01  2.52926482e+01  2.52926482e+01  9.36956007e+01
  1.19678588e+02  1.19678588e+02  1.19678588e+02  3.56009247e+02
  1.34934632e+03  5.83575885e+03  3.50983516e+04]
E1 = -182.5593906450212  E_coul = 54.027106293998465
cycle= 4 E= -128.532284351023  delta_E= -1.51e-08  |g|= 6.64e-05  |ddm|= 0.000198
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000150093
diis-c [-6.21737436e-10  1.01437071e-04  4.46553716e-04 -1.32711691e-01
  1.13216370e+00]
  HOMO = -0.849079555482381  LUMO = 0.457926400495275
  mo_energy =
[-3.27756154e+01 -1.92968900e+00 -8.49079555e-01 -8.49079555e-01
 -8.49079555e-01  4.57926400e-01  4.57926400e-01  4.57926400e-01
  2.00801237e+00  2.05611384e+00  2.05611384e+00  2.05611384e+00
  7.00598473e+00  7.00598473e+00  7.00598473e+00  1.92948003e+01
  2.52925911e+01  2.52925911e+01  2.52925911e+01  9.36955385e+01
  1.19678524e+02  1.19678524e+02  1.19678524e+02  3.56009181e+02
  1.34934625e+03  5.83575878e+03  3.50983516e+04]
E1 = -182.55949482507927  E_coul = 54.02721047351157
cycle= 5 E= -128.532284351568  delta_E= -5.45e-10  |g|= 3.03e-06  |ddm|= 4.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.55949482507927  E_coul = 54.02721047351157
  HOMO = -0.849078715733792  LUMO = 0.457926364851231
  mo_energy =
[-3.27756125e+01 -1.92968826e+00 -8.49078716e-01 -8.49078716e-01
 -8.49078716e-01  4.57926365e-01  4.57926365e-01  4.57926365e-01
  2.00801271e+00  2.05611402e+00  2.05611402e+00  2.05611402e+00
  7.00598572e+00  7.00598572e+00  7.00598572e+00  1.92948023e+01
  2.52925932e+01  2.52925932e+01  2.52925932e+01  9.36955411e+01
  1.19678527e+02  1.19678527e+02  1.19678527e+02  3.56009184e+02
  1.34934626e+03  5.83575878e+03  3.50983516e+04]
E1 = -182.55948390006586  E_coul = 54.02719954849657
Extra cycle  E= -128.532284351569  delta_E= -1.59e-12  |g|= 1.46e-06  |ddm|= 2.68e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.70307920686855
E1 = -182.55948390006586  E_coul = 54.02719954849657
init E= -128.532284351569
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.849079516997768  LUMO = 0.457926254110755
  mo_energy =
[-3.27756147e+01 -1.92968916e+00 -8.49079517e-01 -8.49079517e-01
 -8.49079517e-01  4.57926254e-01  4.57926254e-01  4.57926254e-01
  2.00801206e+00  2.05611357e+00  2.05611357e+00  2.05611357e+00
  7.00598475e+00  7.00598475e+00  7.00598475e+00  1.92948007e+01
  2.52925915e+01  2.52925915e+01  2.52925915e+01  9.36955391e+01
  1.19678525e+02  1.19678525e+02  1.19678525e+02  3.56009182e+02
  1.34934625e+03  5.83575878e+03  3.50983516e+04]
E1 = -182.55948851153374  E_coul = 54.027204159964036
cycle= 1 E= -128.53228435157  delta_E= -4.26e-13  |g|= 6.45e-07  |ddm|= 7.06e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.55948851153374  E_coul = 54.027204159964036
  HOMO = -0.849079195974143  LUMO = 0.457926283878914
  mo_energy =
[-3.27756137e+01 -1.92968884e+00 -8.49079196e-01 -8.49079196e-01
 -8.49079196e-01  4.57926284e-01  4.57926284e-01  4.57926284e-01
  2.00801227e+00  2.05611372e+00  2.05611372e+00  2.05611372e+00
  7.00598513e+00  7.00598513e+00  7.00598513e+00  1.92948014e+01
  2.52925923e+01  2.52925923e+01  2.52925923e+01  9.36955400e+01
  1.19678526e+02  1.19678526e+02  1.19678526e+02  3.56009183e+02
  1.34934625e+03  5.83575878e+03  3.50983516e+04]
E1 = -182.55948593111563  E_coul = 54.027201579546336
Extra cycle  E= -128.532284351569  delta_E= 3.98e-13  |g|= 3.47e-07  |ddm|= 2.31e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498600e+02 1.74906011e+02
 2.04948122e+01 5.69618025e+01 4.87438478e-01 7.82747714e+00
 1.65496783e+00 3.69596241e+00 1.24358088e+01 5.47528214e+01
 1.72091210e-01 1.27156139e+00 4.71444982e-01]
grad_E = [-1.83129567e-11  1.18879956e-09 -2.93013562e-08  4.26790772e-07
  2.17382659e-06 -3.46946802e-06 -9.23866302e-04  8.26207342e-06
  2.02994064e-04 -7.80461534e-03  1.14345606e-03 -3.95724098e-05
 -5.07323047e-03 -1.01498683e-03  4.30688652e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681867        1
[INPUT] 0    0    [1    /1   ]  617.498600664        1
[INPUT] 0    0    [1    /1   ]  174.906006062        1
[INPUT] 0    0    [1    /1   ]  20.4947668325        1
[INPUT] 0    0    [1    /1   ]  56.9618428025        1
[INPUT] 0    0    [1    /1   ]  0.490696595501       1
[INPUT] 0    0    [1    /1   ]  7.82743213025        1
[INPUT] 0    0    [1    /1   ]  1.65460955421        1
[INPUT] 1    0    [1    /1   ]  3.77714431817        1
[INPUT] 1    0    [1    /1   ]  12.42307561          1
[INPUT] 1    0    [1    /1   ]  54.7532796303        1
[INPUT] 1    0    [1    /1   ]  0.161058284096       1
[INPUT] 1    0    [1    /1   ]  1.28725180249        1
[INPUT] 1    0    [1    /1   ]  0.450520031779       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069433, 1.0]], [0, [2712.0968186705268, 1.0]], [0, [617.4986006635926, 1.0]], [0, [174.90600606157125, 1.0]], [0, [20.494766832528526, 1.0]], [0, [56.96184280251998, 1.0]], [0, [0.4906965955010678, 1.0]], [0, [7.827432130251259, 1.0]], [0, [1.65460955420773, 1.0]], [1, [3.7771443181680873, 1.0]], [1, [12.423075610024583, 1.0]], [1, [54.75327963027457, 1.0]], [1, [0.16105828409591602, 1.0]], [1, [1.2872518024856174, 1.0]], [1, [0.45052003177895683, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681867]
bas 2, expnt(s) = [617.49860066]
bas 3, expnt(s) = [174.90600606]
bas 4, expnt(s) = [20.49476683]
bas 5, expnt(s) = [56.9618428]
bas 6, expnt(s) = [0.4906966]
bas 7, expnt(s) = [7.82743213]
bas 8, expnt(s) = [1.65460955]
bas 9, expnt(s) = [3.77714432]
bas 10, expnt(s) = [12.42307561]
bas 11, expnt(s) = [54.75327963]
bas 12, expnt(s) = [0.16105828]
bas 13, expnt(s) = [1.2872518]
bas 14, expnt(s) = [0.45052003]
CPU time:        25.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498601e+02 3.12962288e+02 1.74906006e+02 1.21511831e+02
 2.04947668e+01 2.43358915e+01 5.69618428e+01 5.23845295e+01
 4.90696596e-01 1.48123787e+00 7.82743213e+00 1.18230495e+01
 1.65460955e+00 3.68584162e+00 3.77714432e+00 1.53616854e+01
 1.24230756e+01 6.80410181e+01 5.47532796e+01 4.34507288e+02
 1.61058284e-01 2.97655031e-01 1.28725180e+00 4.00003488e+00
 4.50520032e-01 1.07678011e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999452556995525
cond(S) = 239.90076603686384
E1 = -183.58024217159337  E_coul = 55.080238010048845
init E= -128.500004161545
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774627706389994  LUMO = 0.434888719550583
  mo_energy =
[-3.25545565e+01 -1.85126328e+00 -7.74627706e-01 -7.74627706e-01
 -7.74627706e-01  4.34888720e-01  4.34888720e-01  4.34888720e-01
  2.00664278e+00  2.00664278e+00  2.00664278e+00  2.07248948e+00
  7.07722160e+00  7.07722160e+00  7.07722160e+00  1.94597681e+01
  2.56286113e+01  2.56286113e+01  2.56286113e+01  9.39146110e+01
  1.20084624e+02  1.20084624e+02  1.20084624e+02  3.56262197e+02
  1.34963039e+03  5.83607086e+03  3.50986829e+04]
E1 = -182.0447616029284  E_coul = 53.51571255817974
cycle= 1 E= -128.529049044749  delta_E= -0.029  |g|= 0.208  |ddm|= 0.153
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.524797
diis-c [-0.27541146  1.        ]
  HOMO = -0.885319792143621  LUMO = 0.424360884134102
  mo_energy =
[-3.28854193e+01 -1.96808267e+00 -8.85319792e-01 -8.85319792e-01
 -8.85319792e-01  4.24360884e-01  4.24360884e-01  4.24360884e-01
  1.95290544e+00  1.95290544e+00  1.95290544e+00  1.99265705e+00
  6.94113050e+00  6.94113050e+00  6.94113050e+00  1.92325453e+01
  2.53862578e+01  2.53862578e+01  2.53862578e+01  9.36029349e+01
  1.19752236e+02  1.19752236e+02  1.19752236e+02  3.55902044e+02
  1.34923170e+03  5.83564023e+03  3.50982306e+04]
E1 = -182.82927760675406  E_coul = 54.29751712667206
cycle= 2 E= -128.531760480082  delta_E= -0.00271  |g|= 0.106  |ddm|= 0.0716
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.268075
diis-c [-5.90028762e-04  3.37424111e-01  6.62575889e-01]
  HOMO = -0.84864295724233  LUMO = 0.427927559001251
  mo_energy =
[-3.27745635e+01 -1.92933637e+00 -8.48642957e-01 -8.48642957e-01
 -8.48642957e-01  4.27927559e-01  4.27927559e-01  4.27927559e-01
  1.97051298e+00  1.97051298e+00  1.97051298e+00  2.01886680e+00
  6.98611634e+00  6.98611634e+00  6.98611634e+00  1.93089014e+01
  2.54675708e+01  2.54675708e+01  2.54675708e+01  9.37076320e+01
  1.19862895e+02  1.19862895e+02  1.19862895e+02  3.56019871e+02
  1.34935595e+03  5.83576752e+03  3.50983591e+04]
E1 = -182.56316124567732  E_coul = 54.03042907166441
cycle= 3 E= -128.532732174013  delta_E= -0.000972  |g|= 0.000319  |ddm|= 0.0245
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000711379
diis-c [-8.98253584e-08 -1.75340029e-03 -1.03299629e-03  1.00278640e+00]
  HOMO = -0.848818927393752  LUMO = 0.427925306896381
  mo_energy =
[-3.27748940e+01 -1.92948618e+00 -8.48818927e-01 -8.48818927e-01
 -8.48818927e-01  4.27925307e-01  4.27925307e-01  4.27925307e-01
  1.97046181e+00  1.97046181e+00  1.97046181e+00  2.01879225e+00
  6.98597063e+00  6.98597063e+00  6.98597063e+00  1.93086902e+01
  2.54673301e+01  2.54673301e+01  2.54673301e+01  9.37073260e+01
  1.19862554e+02  1.19862554e+02  1.19862554e+02  3.56019469e+02
  1.34935544e+03  5.83576691e+03  3.50983584e+04]
E1 = -182.5633460152051  E_coul = 54.03061383033846
cycle= 4 E= -128.532732184867  delta_E= -1.09e-08  |g|= 5.73e-05  |ddm|= 0.00015
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000125095
diis-c [-5.57897836e-10  8.08732074e-05  3.72759440e-04 -1.17745805e-01
  1.11729217e+00]
  HOMO = -0.84885047023935  LUMO = 0.427920472094008
  mo_energy =
[-3.27749490e+01 -1.92951903e+00 -8.48850470e-01 -8.48850470e-01
 -8.48850470e-01  4.27920472e-01  4.27920472e-01  4.27920472e-01
  1.97044185e+00  1.97044185e+00  1.97044185e+00  2.01876532e+00
  6.98593274e+00  6.98593274e+00  6.98593274e+00  1.93086419e+01
  2.54672800e+01  2.54672800e+01  2.54672800e+01  9.37072721e+01
  1.19862499e+02  1.19862499e+02  1.19862499e+02  3.56019413e+02
  1.34935538e+03  5.83576685e+03  3.50983583e+04]
E1 = -182.56343675433493  E_coul = 54.030704569071965
cycle= 5 E= -128.532732185263  delta_E= -3.96e-10  |g|= 3.13e-06  |ddm|= 3.41e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56343675433493  E_coul = 54.030704569071965
  HOMO = -0.848849702670755  LUMO = 0.427920416710427
  mo_energy =
[-3.27749462e+01 -1.92951847e+00 -8.48849703e-01 -8.48849703e-01
 -8.48849703e-01  4.27920417e-01  4.27920417e-01  4.27920417e-01
  1.97044195e+00  1.97044195e+00  1.97044195e+00  2.01876551e+00
  6.98593365e+00  6.98593365e+00  6.98593365e+00  1.93086438e+01
  2.54672820e+01  2.54672820e+01  2.54672820e+01  9.37072747e+01
  1.19862502e+02  1.19862502e+02  1.19862502e+02  3.56019415e+02
  1.34935538e+03  5.83576685e+03  3.50983583e+04]
E1 = -182.563425634446  E_coul = 54.03069344918064
Extra cycle  E= -128.532732185265  delta_E= -2.39e-12  |g|= 1.5e-06  |ddm|= 2.83e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.13 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498601e+02 1.74906006e+02
 2.04947668e+01 5.69618428e+01 4.90696596e-01 7.82743213e+00
 1.65460955e+00 3.77714432e+00 1.24230756e+01 5.47532796e+01
 1.61058284e-01 1.28725180e+00 4.50520032e-01]
E = -128.53273218526536
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681867        1
[INPUT] 0    0    [1    /1   ]  617.498600664        1
[INPUT] 0    0    [1    /1   ]  174.906006062        1
[INPUT] 0    0    [1    /1   ]  20.4947668325        1
[INPUT] 0    0    [1    /1   ]  56.9618428025        1
[INPUT] 0    0    [1    /1   ]  0.490696595501       1
[INPUT] 0    0    [1    /1   ]  7.82743213025        1
[INPUT] 0    0    [1    /1   ]  1.65460955421        1
[INPUT] 1    0    [1    /1   ]  3.77714431817        1
[INPUT] 1    0    [1    /1   ]  12.42307561          1
[INPUT] 1    0    [1    /1   ]  54.7532796303        1
[INPUT] 1    0    [1    /1   ]  0.161058284096       1
[INPUT] 1    0    [1    /1   ]  1.28725180249        1
[INPUT] 1    0    [1    /1   ]  0.450520031779       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069433, 1.0]], [0, [2712.0968186705268, 1.0]], [0, [617.4986006635926, 1.0]], [0, [174.90600606157125, 1.0]], [0, [20.494766832528526, 1.0]], [0, [56.96184280251998, 1.0]], [0, [0.4906965955010678, 1.0]], [0, [7.827432130251259, 1.0]], [0, [1.65460955420773, 1.0]], [1, [3.7771443181680873, 1.0]], [1, [12.423075610024583, 1.0]], [1, [54.75327963027457, 1.0]], [1, [0.16105828409591602, 1.0]], [1, [1.2872518024856174, 1.0]], [1, [0.45052003177895683, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681867]
bas 2, expnt(s) = [617.49860066]
bas 3, expnt(s) = [174.90600606]
bas 4, expnt(s) = [20.49476683]
bas 5, expnt(s) = [56.9618428]
bas 6, expnt(s) = [0.4906966]
bas 7, expnt(s) = [7.82743213]
bas 8, expnt(s) = [1.65460955]
bas 9, expnt(s) = [3.77714432]
bas 10, expnt(s) = [12.42307561]
bas 11, expnt(s) = [54.75327963]
bas 12, expnt(s) = [0.16105828]
bas 13, expnt(s) = [1.2872518]
bas 14, expnt(s) = [0.45052003]
CPU time:        26.04
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498601e+02 3.12962288e+02 1.74906006e+02 1.21511831e+02
 2.04947668e+01 2.43358915e+01 5.69618428e+01 5.23845295e+01
 4.90696596e-01 1.48123787e+00 7.82743213e+00 1.18230495e+01
 1.65460955e+00 3.68584162e+00 3.77714432e+00 1.53616854e+01
 1.24230756e+01 6.80410181e+01 5.47532796e+01 4.34507288e+02
 1.61058284e-01 2.97655031e-01 1.28725180e+00 4.00003488e+00
 4.50520032e-01 1.07678011e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999452556995525
cond(S) = 239.90076603686384
E1 = -183.58024217159337  E_coul = 55.080238010048845
init E= -128.500004161545
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774627706389994  LUMO = 0.434888719550583
  mo_energy =
[-3.25545565e+01 -1.85126328e+00 -7.74627706e-01 -7.74627706e-01
 -7.74627706e-01  4.34888720e-01  4.34888720e-01  4.34888720e-01
  2.00664278e+00  2.00664278e+00  2.00664278e+00  2.07248948e+00
  7.07722160e+00  7.07722160e+00  7.07722160e+00  1.94597681e+01
  2.56286113e+01  2.56286113e+01  2.56286113e+01  9.39146110e+01
  1.20084624e+02  1.20084624e+02  1.20084624e+02  3.56262197e+02
  1.34963039e+03  5.83607086e+03  3.50986829e+04]
E1 = -182.0447616029284  E_coul = 53.51571255817974
cycle= 1 E= -128.529049044749  delta_E= -0.029  |g|= 0.208  |ddm|= 0.153
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.524797
diis-c [-0.27541146  1.        ]
  HOMO = -0.885319792143621  LUMO = 0.424360884134102
  mo_energy =
[-3.28854193e+01 -1.96808267e+00 -8.85319792e-01 -8.85319792e-01
 -8.85319792e-01  4.24360884e-01  4.24360884e-01  4.24360884e-01
  1.95290544e+00  1.95290544e+00  1.95290544e+00  1.99265705e+00
  6.94113050e+00  6.94113050e+00  6.94113050e+00  1.92325453e+01
  2.53862578e+01  2.53862578e+01  2.53862578e+01  9.36029349e+01
  1.19752236e+02  1.19752236e+02  1.19752236e+02  3.55902044e+02
  1.34923170e+03  5.83564023e+03  3.50982306e+04]
E1 = -182.82927760675406  E_coul = 54.29751712667206
cycle= 2 E= -128.531760480082  delta_E= -0.00271  |g|= 0.106  |ddm|= 0.0716
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.268075
diis-c [-5.90028762e-04  3.37424111e-01  6.62575889e-01]
  HOMO = -0.84864295724233  LUMO = 0.427927559001251
  mo_energy =
[-3.27745635e+01 -1.92933637e+00 -8.48642957e-01 -8.48642957e-01
 -8.48642957e-01  4.27927559e-01  4.27927559e-01  4.27927559e-01
  1.97051298e+00  1.97051298e+00  1.97051298e+00  2.01886680e+00
  6.98611634e+00  6.98611634e+00  6.98611634e+00  1.93089014e+01
  2.54675708e+01  2.54675708e+01  2.54675708e+01  9.37076320e+01
  1.19862895e+02  1.19862895e+02  1.19862895e+02  3.56019871e+02
  1.34935595e+03  5.83576752e+03  3.50983591e+04]
E1 = -182.56316124567732  E_coul = 54.03042907166441
cycle= 3 E= -128.532732174013  delta_E= -0.000972  |g|= 0.000319  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000711379
diis-c [-8.98253584e-08 -1.75340029e-03 -1.03299629e-03  1.00278640e+00]
  HOMO = -0.848818927393752  LUMO = 0.427925306896381
  mo_energy =
[-3.27748940e+01 -1.92948618e+00 -8.48818927e-01 -8.48818927e-01
 -8.48818927e-01  4.27925307e-01  4.27925307e-01  4.27925307e-01
  1.97046181e+00  1.97046181e+00  1.97046181e+00  2.01879225e+00
  6.98597063e+00  6.98597063e+00  6.98597063e+00  1.93086902e+01
  2.54673301e+01  2.54673301e+01  2.54673301e+01  9.37073260e+01
  1.19862554e+02  1.19862554e+02  1.19862554e+02  3.56019469e+02
  1.34935544e+03  5.83576691e+03  3.50983584e+04]
E1 = -182.5633460152051  E_coul = 54.03061383033846
cycle= 4 E= -128.532732184867  delta_E= -1.09e-08  |g|= 5.73e-05  |ddm|= 0.00015
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000125095
diis-c [-5.57897836e-10  8.08732074e-05  3.72759440e-04 -1.17745805e-01
  1.11729217e+00]
  HOMO = -0.84885047023935  LUMO = 0.427920472094008
  mo_energy =
[-3.27749490e+01 -1.92951903e+00 -8.48850470e-01 -8.48850470e-01
 -8.48850470e-01  4.27920472e-01  4.27920472e-01  4.27920472e-01
  1.97044185e+00  1.97044185e+00  1.97044185e+00  2.01876532e+00
  6.98593274e+00  6.98593274e+00  6.98593274e+00  1.93086419e+01
  2.54672800e+01  2.54672800e+01  2.54672800e+01  9.37072721e+01
  1.19862499e+02  1.19862499e+02  1.19862499e+02  3.56019413e+02
  1.34935538e+03  5.83576685e+03  3.50983583e+04]
E1 = -182.56343675433493  E_coul = 54.030704569071965
cycle= 5 E= -128.532732185263  delta_E= -3.96e-10  |g|= 3.13e-06  |ddm|= 3.41e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56343675433493  E_coul = 54.030704569071965
  HOMO = -0.848849702670755  LUMO = 0.427920416710427
  mo_energy =
[-3.27749462e+01 -1.92951847e+00 -8.48849703e-01 -8.48849703e-01
 -8.48849703e-01  4.27920417e-01  4.27920417e-01  4.27920417e-01
  1.97044195e+00  1.97044195e+00  1.97044195e+00  2.01876551e+00
  6.98593365e+00  6.98593365e+00  6.98593365e+00  1.93086438e+01
  2.54672820e+01  2.54672820e+01  2.54672820e+01  9.37072747e+01
  1.19862502e+02  1.19862502e+02  1.19862502e+02  3.56019415e+02
  1.34935538e+03  5.83576685e+03  3.50983583e+04]
E1 = -182.563425634446  E_coul = 54.03069344918064
Extra cycle  E= -128.532732185265  delta_E= -2.39e-12  |g|= 1.5e-06  |ddm|= 2.83e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.90076603686384
E1 = -182.563425634446  E_coul = 54.03069344918064
init E= -128.532732185265
    CPU time for initialize scf      0.27 sec, wall time      0.26 sec
  HOMO = -0.848850517917428  LUMO = 0.427920311298701
  mo_energy =
[-3.27749484e+01 -1.92951940e+00 -8.48850518e-01 -8.48850518e-01
 -8.48850518e-01  4.27920311e-01  4.27920311e-01  4.27920311e-01
  1.97044150e+00  1.97044150e+00  1.97044150e+00  2.01876483e+00
  6.98593265e+00  6.98593265e+00  6.98593265e+00  1.93086423e+01
  2.54672804e+01  2.54672804e+01  2.54672804e+01  9.37072726e+01
  1.19862500e+02  1.19862500e+02  1.19862500e+02  3.56019413e+02
  1.34935538e+03  5.83576685e+03  3.50983583e+04]
E1 = -182.5634302058544  E_coul = 54.03069802058875
cycle= 1 E= -128.532732185266  delta_E= -2.84e-13  |g|= 6.43e-07  |ddm|= 7.77e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5634302058544  E_coul = 54.03069802058875
  HOMO = -0.84885019997402  LUMO = 0.427920337181847
  mo_energy =
[-3.27749474e+01 -1.92951908e+00 -8.48850200e-01 -8.48850200e-01
 -8.48850200e-01  4.27920337e-01  4.27920337e-01  4.27920337e-01
  1.97044164e+00  1.97044164e+00  1.97044164e+00  2.01876503e+00
  6.98593304e+00  6.98593304e+00  6.98593304e+00  1.93086429e+01
  2.54672811e+01  2.54672811e+01  2.54672811e+01  9.37072736e+01
  1.19862501e+02  1.19862501e+02  1.19862501e+02  3.56019414e+02
  1.34935538e+03  5.83576685e+03  3.50983583e+04]
E1 = -182.56342761313437  E_coul = 54.03069542786846
Extra cycle  E= -128.532732185266  delta_E= -2.56e-13  |g|= 3.49e-07  |ddm|= 2.31e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.34 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498601e+02 1.74906006e+02
 2.04947668e+01 5.69618428e+01 4.90696596e-01 7.82743213e+00
 1.65460955e+00 3.77714432e+00 1.24230756e+01 5.47532796e+01
 1.61058284e-01 1.28725180e+00 4.50520032e-01]
grad_E = [-4.68051290e-11  2.76137277e-09 -5.88667929e-08  8.26435464e-07
  2.38875785e-05 -6.40801497e-06  6.22553122e-03 -3.66722295e-05
 -1.64535575e-03 -3.99939420e-03 -2.08432752e-05  1.52548634e-05
  1.05321264e-03  6.57789530e-04 -6.12403197e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681866        1
[INPUT] 0    0    [1    /1   ]  617.498600939        1
[INPUT] 0    0    [1    /1   ]  174.906002118        1
[INPUT] 0    0    [1    /1   ]  20.4947084287        1
[INPUT] 0    0    [1    /1   ]  56.9618741461        1
[INPUT] 0    0    [1    /1   ]  0.483925095943       1
[INPUT] 0    0    [1    /1   ]  7.82745789274        1
[INPUT] 0    0    [1    /1   ]  1.65668726114        1
[INPUT] 1    0    [1    /1   ]  3.82859756765        1
[INPUT] 1    0    [1    /1   ]  12.4158506133        1
[INPUT] 1    0    [1    /1   ]  54.7535207684        1
[INPUT] 1    0    [1    /1   ]  0.155241179505       1
[INPUT] 1    0    [1    /1   ]  1.29507550182        1
[INPUT] 1    0    [1    /1   ]  0.445987709107       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069626, 1.0]], [0, [2712.0968186585737, 1.0]], [0, [617.4986009394219, 1.0]], [0, [174.9060021176192, 1.0]], [0, [20.494708428737386, 1.0]], [0, [56.96187414614434, 1.0]], [0, [0.4839250959431168, 1.0]], [0, [7.827457892736441, 1.0]], [0, [1.656687261135041, 1.0]], [1, [3.8285975676481794, 1.0]], [1, [12.415850613294667, 1.0]], [1, [54.75352076835407, 1.0]], [1, [0.15524117950499255, 1.0]], [1, [1.2950755018231181, 1.0]], [1, [0.4459877091066051, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681866]
bas 2, expnt(s) = [617.49860094]
bas 3, expnt(s) = [174.90600212]
bas 4, expnt(s) = [20.49470843]
bas 5, expnt(s) = [56.96187415]
bas 6, expnt(s) = [0.4839251]
bas 7, expnt(s) = [7.82745789]
bas 8, expnt(s) = [1.65668726]
bas 9, expnt(s) = [3.82859757]
bas 10, expnt(s) = [12.41585061]
bas 11, expnt(s) = [54.75352077]
bas 12, expnt(s) = [0.15524118]
bas 13, expnt(s) = [1.2950755]
bas 14, expnt(s) = [0.44598771]
CPU time:        29.12
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498601e+02 3.12962288e+02 1.74906002e+02 1.21511829e+02
 2.04947084e+01 2.43358395e+01 5.69618741e+01 5.23845511e+01
 4.83925096e-01 1.46588072e+00 7.82745789e+00 1.18230787e+01
 1.65668726e+00 3.68931233e+00 3.82859757e+00 1.56237054e+01
 1.24158506e+01 6.79915576e+01 5.47535208e+01 4.34509680e+02
 1.55241180e-01 2.84277875e-01 1.29507550e+00 4.03044735e+00
 4.45987709e-01 1.06325640e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999444251181984
cond(S) = 239.54882797354097
E1 = -183.58083531753806  E_coul = 55.08077400739606
init E= -128.500061310142
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774624226163777  LUMO = 0.420336141104914
  mo_energy =
[-3.25543968e+01 -1.85124343e+00 -7.74624226e-01 -7.74624226e-01
 -7.74624226e-01  4.20336141e-01  4.20336141e-01  4.20336141e-01
  1.97581536e+00  1.97581536e+00  1.97581536e+00  2.05129208e+00
  7.09598863e+00  7.09598863e+00  7.09598863e+00  1.94375565e+01
  2.57640914e+01  2.57640914e+01  2.57640914e+01  9.38967370e+01
  1.20220239e+02  1.20220239e+02  1.20220239e+02  3.56246826e+02
  1.34961693e+03  5.83605917e+03  3.50986733e+04]
E1 = -182.03557513866437  E_coul = 53.50649059300913
cycle= 1 E= -128.529084545655  delta_E= -0.029  |g|= 0.21  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.526458
diis-c [-0.27715797  1.        ]
  HOMO = -0.886238704166888  LUMO = 0.410163778631897
  mo_energy =
[-3.28866946e+01 -1.96871497e+00 -8.86238704e-01 -8.86238704e-01
 -8.86238704e-01  4.10163779e-01  4.10163779e-01  4.10163779e-01
  1.92174379e+00  1.92174379e+00  1.92174379e+00  1.97135973e+00
  6.95773143e+00  6.95773143e+00  6.95773143e+00  1.92087682e+01
  2.55201405e+01  2.55201405e+01  2.55201405e+01  9.35836131e+01
  1.19886468e+02  1.19886468e+02  1.19886468e+02  3.55885174e+02
  1.34921668e+03  5.83562695e+03  3.50982194e+04]
E1 = -182.82574641208714  E_coul = 54.29391941970166
cycle= 2 E= -128.531826992385  delta_E= -0.00274  |g|= 0.107  |ddm|= 0.0718
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.268981
diis-c [-5.90927441e-04  3.37475765e-01  6.62524235e-01]
  HOMO = -0.849295789082854  LUMO = 0.4136094794324
  mo_energy =
[-3.27750736e+01 -1.92968072e+00 -8.49295789e-01 -8.49295789e-01
 -8.49295789e-01  4.13609479e-01  4.13609479e-01  4.13609479e-01
  1.93945796e+00  1.93945796e+00  1.93945796e+00  1.99766599e+00
  7.00344274e+00  7.00344274e+00  7.00344274e+00  1.92856811e+01
  2.56021246e+01  2.56021246e+01  2.56021246e+01  9.36890385e+01
  1.19997873e+02  1.19997873e+02  1.19997873e+02  3.56003796e+02
  1.34934175e+03  5.83575506e+03  3.50983487e+04]
E1 = -182.55754772538367  E_coul = 54.02473472340193
cycle= 3 E= -128.532813001982  delta_E= -0.000986  |g|= 0.000353  |ddm|= 0.0248
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000852537
diis-c [-1.06757657e-07 -1.75735643e-03 -5.11011386e-04  1.00226837e+00]
  HOMO = -0.849476366202577  LUMO = 0.413608055574553
  mo_energy =
[-3.27754153e+01 -1.92980698e+00 -8.49476366e-01 -8.49476366e-01
 -8.49476366e-01  4.13608056e-01  4.13608056e-01  4.13608056e-01
  1.93940953e+00  1.93940953e+00  1.93940953e+00  1.99761248e+00
  7.00329596e+00  7.00329596e+00  7.00329596e+00  1.92854704e+01
  2.56018808e+01  2.56018808e+01  2.56018808e+01  9.36887225e+01
  1.19997519e+02  1.19997519e+02  1.19997519e+02  3.56003370e+02
  1.34934119e+03  5.83575440e+03  3.50983480e+04]
E1 = -182.55781089764085  E_coul = 54.024997883079486
cycle= 4 E= -128.532813014561  delta_E= -1.26e-08  |g|= 6.76e-05  |ddm|= 0.000152
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000169415
diis-c [-6.10096433e-10  1.12298141e-04  5.04709096e-04 -1.38880822e-01
  1.13826381e+00]
  HOMO = -0.849511182233094  LUMO = 0.413603299080897
  mo_energy =
[-3.27754803e+01 -1.92983685e+00 -8.49511182e-01 -8.49511182e-01
 -8.49511182e-01  4.13603299e-01  4.13603299e-01  4.13603299e-01
  1.93938880e+00  1.93938880e+00  1.93938880e+00  1.99758867e+00
  7.00325470e+00  7.00325470e+00  7.00325470e+00  1.92854181e+01
  2.56018245e+01  2.56018245e+01  2.56018245e+01  9.36886595e+01
  1.19997454e+02  1.19997454e+02  1.19997454e+02  3.56003301e+02
  1.34934112e+03  5.83575432e+03  3.50983479e+04]
E1 = -182.55793750586741  E_coul = 54.02512449080963
cycle= 5 E= -128.532813015058  delta_E= -4.96e-10  |g|= 2.74e-06  |ddm|= 3.13e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.55793750586741  E_coul = 54.02512449080963
  HOMO = -0.849510257830482  LUMO = 0.413603320964481
  mo_energy =
[-3.27754779e+01 -1.92983559e+00 -8.49510258e-01 -8.49510258e-01
 -8.49510258e-01  4.13603321e-01  4.13603321e-01  4.13603321e-01
  1.93938915e+00  1.93938915e+00  1.93938915e+00  1.99758951e+00
  7.00325586e+00  7.00325586e+00  7.00325586e+00  1.92854202e+01
  2.56018266e+01  2.56018266e+01  2.56018266e+01  9.36886618e+01
  1.19997456e+02  1.19997456e+02  1.19997456e+02  3.56003302e+02
  1.34934112e+03  5.83575432e+03  3.50983479e+04]
E1 = -182.55792920893822  E_coul = 54.02511619387925
Extra cycle  E= -128.532813015059  delta_E= -1.17e-12  |g|= 1.09e-06  |ddm|= 1.91e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498601e+02 1.74906002e+02
 2.04947084e+01 5.69618741e+01 4.83925096e-01 7.82745789e+00
 1.65668726e+00 3.82859757e+00 1.24158506e+01 5.47535208e+01
 1.55241180e-01 1.29507550e+00 4.45987709e-01]
E = -128.53281301505896
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681866        1
[INPUT] 0    0    [1    /1   ]  617.498600939        1
[INPUT] 0    0    [1    /1   ]  174.906002118        1
[INPUT] 0    0    [1    /1   ]  20.4947084287        1
[INPUT] 0    0    [1    /1   ]  56.9618741461        1
[INPUT] 0    0    [1    /1   ]  0.483925095943       1
[INPUT] 0    0    [1    /1   ]  7.82745789274        1
[INPUT] 0    0    [1    /1   ]  1.65668726114        1
[INPUT] 1    0    [1    /1   ]  3.82859756765        1
[INPUT] 1    0    [1    /1   ]  12.4158506133        1
[INPUT] 1    0    [1    /1   ]  54.7535207684        1
[INPUT] 1    0    [1    /1   ]  0.155241179505       1
[INPUT] 1    0    [1    /1   ]  1.29507550182        1
[INPUT] 1    0    [1    /1   ]  0.445987709107       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069626, 1.0]], [0, [2712.0968186585737, 1.0]], [0, [617.4986009394219, 1.0]], [0, [174.9060021176192, 1.0]], [0, [20.494708428737386, 1.0]], [0, [56.96187414614434, 1.0]], [0, [0.4839250959431168, 1.0]], [0, [7.827457892736441, 1.0]], [0, [1.656687261135041, 1.0]], [1, [3.8285975676481794, 1.0]], [1, [12.415850613294667, 1.0]], [1, [54.75352076835407, 1.0]], [1, [0.15524117950499255, 1.0]], [1, [1.2950755018231181, 1.0]], [1, [0.4459877091066051, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681866]
bas 2, expnt(s) = [617.49860094]
bas 3, expnt(s) = [174.90600212]
bas 4, expnt(s) = [20.49470843]
bas 5, expnt(s) = [56.96187415]
bas 6, expnt(s) = [0.4839251]
bas 7, expnt(s) = [7.82745789]
bas 8, expnt(s) = [1.65668726]
bas 9, expnt(s) = [3.82859757]
bas 10, expnt(s) = [12.41585061]
bas 11, expnt(s) = [54.75352077]
bas 12, expnt(s) = [0.15524118]
bas 13, expnt(s) = [1.2950755]
bas 14, expnt(s) = [0.44598771]
CPU time:        29.39
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498601e+02 3.12962288e+02 1.74906002e+02 1.21511829e+02
 2.04947084e+01 2.43358395e+01 5.69618741e+01 5.23845511e+01
 4.83925096e-01 1.46588072e+00 7.82745789e+00 1.18230787e+01
 1.65668726e+00 3.68931233e+00 3.82859757e+00 1.56237054e+01
 1.24158506e+01 6.79915576e+01 5.47535208e+01 4.34509680e+02
 1.55241180e-01 2.84277875e-01 1.29507550e+00 4.03044735e+00
 4.45987709e-01 1.06325640e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999444251181984
cond(S) = 239.54882797354097
E1 = -183.58083531753806  E_coul = 55.08077400739606
init E= -128.500061310142
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774624226163777  LUMO = 0.420336141104914
  mo_energy =
[-3.25543968e+01 -1.85124343e+00 -7.74624226e-01 -7.74624226e-01
 -7.74624226e-01  4.20336141e-01  4.20336141e-01  4.20336141e-01
  1.97581536e+00  1.97581536e+00  1.97581536e+00  2.05129208e+00
  7.09598863e+00  7.09598863e+00  7.09598863e+00  1.94375565e+01
  2.57640914e+01  2.57640914e+01  2.57640914e+01  9.38967370e+01
  1.20220239e+02  1.20220239e+02  1.20220239e+02  3.56246826e+02
  1.34961693e+03  5.83605917e+03  3.50986733e+04]
E1 = -182.03557513866437  E_coul = 53.50649059300913
cycle= 1 E= -128.529084545655  delta_E= -0.029  |g|= 0.21  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.526458
diis-c [-0.27715797  1.        ]
  HOMO = -0.886238704166888  LUMO = 0.410163778631897
  mo_energy =
[-3.28866946e+01 -1.96871497e+00 -8.86238704e-01 -8.86238704e-01
 -8.86238704e-01  4.10163779e-01  4.10163779e-01  4.10163779e-01
  1.92174379e+00  1.92174379e+00  1.92174379e+00  1.97135973e+00
  6.95773143e+00  6.95773143e+00  6.95773143e+00  1.92087682e+01
  2.55201405e+01  2.55201405e+01  2.55201405e+01  9.35836131e+01
  1.19886468e+02  1.19886468e+02  1.19886468e+02  3.55885174e+02
  1.34921668e+03  5.83562695e+03  3.50982194e+04]
E1 = -182.82574641208714  E_coul = 54.29391941970166
cycle= 2 E= -128.531826992385  delta_E= -0.00274  |g|= 0.107  |ddm|= 0.0718
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.268981
diis-c [-5.90927441e-04  3.37475765e-01  6.62524235e-01]
  HOMO = -0.849295789082854  LUMO = 0.4136094794324
  mo_energy =
[-3.27750736e+01 -1.92968072e+00 -8.49295789e-01 -8.49295789e-01
 -8.49295789e-01  4.13609479e-01  4.13609479e-01  4.13609479e-01
  1.93945796e+00  1.93945796e+00  1.93945796e+00  1.99766599e+00
  7.00344274e+00  7.00344274e+00  7.00344274e+00  1.92856811e+01
  2.56021246e+01  2.56021246e+01  2.56021246e+01  9.36890385e+01
  1.19997873e+02  1.19997873e+02  1.19997873e+02  3.56003796e+02
  1.34934175e+03  5.83575506e+03  3.50983487e+04]
E1 = -182.55754772538367  E_coul = 54.02473472340193
cycle= 3 E= -128.532813001982  delta_E= -0.000986  |g|= 0.000353  |ddm|= 0.0248
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000852537
diis-c [-1.06757657e-07 -1.75735643e-03 -5.11011386e-04  1.00226837e+00]
  HOMO = -0.849476366202577  LUMO = 0.413608055574553
  mo_energy =
[-3.27754153e+01 -1.92980698e+00 -8.49476366e-01 -8.49476366e-01
 -8.49476366e-01  4.13608056e-01  4.13608056e-01  4.13608056e-01
  1.93940953e+00  1.93940953e+00  1.93940953e+00  1.99761248e+00
  7.00329596e+00  7.00329596e+00  7.00329596e+00  1.92854704e+01
  2.56018808e+01  2.56018808e+01  2.56018808e+01  9.36887225e+01
  1.19997519e+02  1.19997519e+02  1.19997519e+02  3.56003370e+02
  1.34934119e+03  5.83575440e+03  3.50983480e+04]
E1 = -182.55781089764085  E_coul = 54.024997883079486
cycle= 4 E= -128.532813014561  delta_E= -1.26e-08  |g|= 6.76e-05  |ddm|= 0.000152
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000169415
diis-c [-6.10096433e-10  1.12298141e-04  5.04709096e-04 -1.38880822e-01
  1.13826381e+00]
  HOMO = -0.849511182233094  LUMO = 0.413603299080897
  mo_energy =
[-3.27754803e+01 -1.92983685e+00 -8.49511182e-01 -8.49511182e-01
 -8.49511182e-01  4.13603299e-01  4.13603299e-01  4.13603299e-01
  1.93938880e+00  1.93938880e+00  1.93938880e+00  1.99758867e+00
  7.00325470e+00  7.00325470e+00  7.00325470e+00  1.92854181e+01
  2.56018245e+01  2.56018245e+01  2.56018245e+01  9.36886595e+01
  1.19997454e+02  1.19997454e+02  1.19997454e+02  3.56003301e+02
  1.34934112e+03  5.83575432e+03  3.50983479e+04]
E1 = -182.55793750586741  E_coul = 54.02512449080963
cycle= 5 E= -128.532813015058  delta_E= -4.96e-10  |g|= 2.74e-06  |ddm|= 3.13e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.55793750586741  E_coul = 54.02512449080963
  HOMO = -0.849510257830482  LUMO = 0.413603320964481
  mo_energy =
[-3.27754779e+01 -1.92983559e+00 -8.49510258e-01 -8.49510258e-01
 -8.49510258e-01  4.13603321e-01  4.13603321e-01  4.13603321e-01
  1.93938915e+00  1.93938915e+00  1.93938915e+00  1.99758951e+00
  7.00325586e+00  7.00325586e+00  7.00325586e+00  1.92854202e+01
  2.56018266e+01  2.56018266e+01  2.56018266e+01  9.36886618e+01
  1.19997456e+02  1.19997456e+02  1.19997456e+02  3.56003302e+02
  1.34934112e+03  5.83575432e+03  3.50983479e+04]
E1 = -182.55792920893822  E_coul = 54.02511619387925
Extra cycle  E= -128.532813015059  delta_E= -1.17e-12  |g|= 1.09e-06  |ddm|= 1.91e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.54882797354097
E1 = -182.55792920893822  E_coul = 54.02511619387925
init E= -128.532813015059
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.8495108722223  LUMO = 0.413603250852643
  mo_energy =
[-3.27754796e+01 -1.92983619e+00 -8.49510872e-01 -8.49510872e-01
 -8.49510872e-01  4.13603251e-01  4.13603251e-01  4.13603251e-01
  1.93938883e+00  1.93938883e+00  1.93938883e+00  1.99758909e+00
  7.00325511e+00  7.00325511e+00  7.00325511e+00  1.92854190e+01
  2.56018253e+01  2.56018253e+01  2.56018253e+01  9.36886602e+01
  1.19997454e+02  1.19997454e+02  1.19997454e+02  3.56003301e+02
  1.34934112e+03  5.83575432e+03  3.50983479e+04]
E1 = -182.55793304692872  E_coul = 54.02512003186975
cycle= 1 E= -128.532813015059  delta_E= -2.84e-14  |g|= 5.35e-07  |ddm|= 4.31e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.55793304692872  E_coul = 54.02512003186975
  HOMO = -0.84951060605466  LUMO = 0.413603273450278
  mo_energy =
[-3.27754788e+01 -1.92983591e+00 -8.49510606e-01 -8.49510606e-01
 -8.49510606e-01  4.13603273e-01  4.13603273e-01  4.13603273e-01
  1.93938895e+00  1.93938895e+00  1.93938895e+00  1.99758928e+00
  7.00325544e+00  7.00325544e+00  7.00325544e+00  1.92854196e+01
  2.56018259e+01  2.56018259e+01  2.56018259e+01  9.36886609e+01
  1.19997455e+02  1.19997455e+02  1.19997455e+02  3.56003302e+02
  1.34934112e+03  5.83575432e+03  3.50983479e+04]
E1 = -182.55793097974762  E_coul = 54.02511796468854
Extra cycle  E= -128.532813015059  delta_E= -8.53e-14  |g|= 2.78e-07  |ddm|= 2e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.34 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498601e+02 1.74906002e+02
 2.04947084e+01 5.69618741e+01 4.83925096e-01 7.82745789e+00
 1.65668726e+00 3.82859757e+00 1.24158506e+01 5.47535208e+01
 1.55241180e-01 1.29507550e+00 4.45987709e-01]
grad_E = [ 2.78997579e-11 -1.32508378e-09  1.84281970e-08 -1.84808588e-07
 -2.67819304e-05  8.72236301e-07 -9.56269652e-03  6.73999704e-05
  2.63137409e-03 -1.42479101e-04 -8.96486951e-04  5.62918296e-05
 -1.94620571e-03 -4.31899875e-03 -3.12023760e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681866        1
[INPUT] 0    0    [1    /1   ]  617.498600983        1
[INPUT] 0    0    [1    /1   ]  174.906001445        1
[INPUT] 0    0    [1    /1   ]  20.4947135483        1
[INPUT] 0    0    [1    /1   ]  56.9618798959        1
[INPUT] 0    0    [1    /1   ]  0.488512806342       1
[INPUT] 0    0    [1    /1   ]  7.82742052204        1
[INPUT] 0    0    [1    /1   ]  1.65544735573        1
[INPUT] 1    0    [1    /1   ]  3.83760794238        1
[INPUT] 1    0    [1    /1   ]  12.4153734306        1
[INPUT] 1    0    [1    /1   ]  54.7535141373        1
[INPUT] 1    0    [1    /1   ]  0.155817059478       1
[INPUT] 1    0    [1    /1   ]  1.29969364777        1
[INPUT] 1    0    [1    /1   ]  0.448059422048       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069648, 1.0]], [0, [2712.0968186570394, 1.0]], [0, [617.4986009826702, 1.0]], [0, [174.9060014446099, 1.0]], [0, [20.494713548272152, 1.0]], [0, [56.96187989591187, 1.0]], [0, [0.4885128063415256, 1.0]], [0, [7.827420522038673, 1.0]], [0, [1.655447355731998, 1.0]], [1, [3.837607942376739, 1.0]], [1, [12.415373430635478, 1.0]], [1, [54.75351413729963, 1.0]], [1, [0.15581705947767438, 1.0]], [1, [1.299693647771032, 1.0]], [1, [0.4480594220478184, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681866]
bas 2, expnt(s) = [617.49860098]
bas 3, expnt(s) = [174.90600144]
bas 4, expnt(s) = [20.49471355]
bas 5, expnt(s) = [56.9618799]
bas 6, expnt(s) = [0.48851281]
bas 7, expnt(s) = [7.82742052]
bas 8, expnt(s) = [1.65544736]
bas 9, expnt(s) = [3.83760794]
bas 10, expnt(s) = [12.41537343]
bas 11, expnt(s) = [54.75351414]
bas 12, expnt(s) = [0.15581706]
bas 13, expnt(s) = [1.29969365]
bas 14, expnt(s) = [0.44805942]
CPU time:        32.39
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498601e+02 3.12962288e+02 1.74906001e+02 1.21511829e+02
 2.04947135e+01 2.43358441e+01 5.69618799e+01 5.23845551e+01
 4.88512806e-01 1.47629106e+00 7.82742052e+00 1.18230363e+01
 1.65544736e+00 3.68724126e+00 3.83760794e+00 1.56696807e+01
 1.24153734e+01 6.79882912e+01 5.47535141e+01 4.34509614e+02
 1.55817059e-01 2.85596676e-01 1.29969365e+00 4.04842071e+00
 4.48059422e-01 1.06943381e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999448214753484
cond(S) = 239.79352755985516
E1 = -183.58054052478147  E_coul = 55.08041976086511
init E= -128.500120763916
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774632782691075  LUMO = 0.422272234001126
  mo_energy =
[-3.25545313e+01 -1.85126093e+00 -7.74632783e-01 -7.74632783e-01
 -7.74632783e-01  4.22272234e-01  4.22272234e-01  4.22272234e-01
  1.98509241e+00  1.98509241e+00  1.98509241e+00  2.06582217e+00
  7.12355452e+00  7.12355452e+00  7.12355452e+00  1.94533040e+01
  2.58133518e+01  2.58133518e+01  2.58133518e+01  9.39094130e+01
  1.20263981e+02  1.20263981e+02  1.20263981e+02  3.56257707e+02
  1.34962652e+03  5.83606753e+03  3.50986801e+04]
E1 = -182.0418881924506  E_coul = 53.51272615119025
cycle= 1 E= -128.52916204126  delta_E= -0.029  |g|= 0.209  |ddm|= 0.155
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.524508
diis-c [-0.27510835  1.        ]
  HOMO = -0.885652781666335  LUMO = 0.412072520997895
  mo_energy =
[-3.28857515e+01 -1.96831390e+00 -8.85652782e-01 -8.85652782e-01
 -8.85652782e-01  4.12072521e-01  4.12072521e-01  4.12072521e-01
  1.93107136e+00  1.93107136e+00  1.93107136e+00  1.98594892e+00
  6.98570913e+00  6.98570913e+00  6.98570913e+00  1.92255230e+01
  2.55703114e+01  2.55703114e+01  2.55703114e+01  9.35973361e+01
  1.19931305e+02  1.19931305e+02  1.19931305e+02  3.55897145e+02
  1.34922735e+03  5.83563640e+03  3.50982274e+04]
E1 = -182.8285173743885  E_coul = 54.29663323441459
cycle= 2 E= -128.531884139974  delta_E= -0.00272  |g|= 0.107  |ddm|= 0.0719
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.267994
diis-c [-5.87679928e-04  3.37482011e-01  6.62517989e-01]
  HOMO = -0.848878464263222  LUMO = 0.415525587482463
  mo_energy =
[-3.27746173e+01 -1.92946153e+00 -8.48878464e-01 -8.48878464e-01
 -8.48878464e-01  4.15525587e-01  4.15525587e-01  4.15525587e-01
  1.94877628e+00  1.94877628e+00  1.94877628e+00  2.01220433e+00
  7.03128966e+00  7.03128966e+00  7.03128966e+00  1.93020800e+01
  2.56519305e+01  2.56519305e+01  2.56519305e+01  9.37022977e+01
  1.20042220e+02  1.20042220e+02  1.20042220e+02  3.56015258e+02
  1.34935190e+03  5.83576398e+03  3.50983561e+04]
E1 = -182.56160264050615  E_coul = 54.02874145827889
cycle= 3 E= -128.532861182227  delta_E= -0.000977  |g|= 0.000327  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000757961
diis-c [-9.69424773e-08 -1.74328875e-03 -8.36952943e-04  1.00258024e+00]
  HOMO = -0.849055728174586  LUMO = 0.415523011503278
  mo_energy =
[-3.27749510e+01 -1.92960277e+00 -8.49055728e-01 -8.49055728e-01
 -8.49055728e-01  4.15523012e-01  4.15523012e-01  4.15523012e-01
  1.94872560e+00  1.94872560e+00  1.94872560e+00  2.01213746e+00
  7.03114290e+00  7.03114290e+00  7.03114290e+00  1.93018692e+01
  2.56516889e+01  2.56516889e+01  2.56516889e+01  9.37019885e+01
  1.20041875e+02  1.20041875e+02  1.20041875e+02  3.56014848e+02
  1.34935137e+03  5.83576335e+03  3.50983555e+04]
E1 = -182.56180624747756  E_coul = 54.028945053359124
cycle= 4 E= -128.532861194118  delta_E= -1.19e-08  |g|= 6.13e-05  |ddm|= 0.00016
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000140825
diis-c [-5.55023812e-10  9.19277671e-05  4.21284023e-04 -1.26430335e-01
  1.12591712e+00]
  HOMO = -0.849088994526836  LUMO = 0.415518084343282
  mo_energy =
[-3.27750104e+01 -1.92963529e+00 -8.49088995e-01 -8.49088995e-01
 -8.49088995e-01  4.15518084e-01  4.15518084e-01  4.15518084e-01
  1.94870478e+00  1.94870478e+00  1.94870478e+00  2.01211098e+00
  7.03110293e+00  7.03110293e+00  7.03110293e+00  1.93018187e+01
  2.56516358e+01  2.56516358e+01  2.56516358e+01  9.37019306e+01
  1.20041816e+02  1.20041816e+02  1.20041816e+02  3.56014786e+02
  1.34935130e+03  5.83576328e+03  3.50983554e+04]
E1 = -182.56190841882153  E_coul = 54.029047224255024
cycle= 5 E= -128.532861194567  delta_E= -4.48e-10  |g|= 2.89e-06  |ddm|= 3.5e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.03 sec
E1 = -182.56190841882153  E_coul = 54.029047224255024
  HOMO = -0.849088225575479  LUMO = 0.415518042022655
  mo_energy =
[-3.27750078e+01 -1.92963454e+00 -8.49088226e-01 -8.49088226e-01
 -8.49088226e-01  4.15518042e-01  4.15518042e-01  4.15518042e-01
  1.94870492e+00  1.94870492e+00  1.94870492e+00  2.01211134e+00
  7.03110389e+00  7.03110389e+00  7.03110389e+00  1.93018207e+01
  2.56516378e+01  2.56516378e+01  2.56516378e+01  9.37019330e+01
  1.20041819e+02  1.20041819e+02  1.20041819e+02  3.56014789e+02
  1.34935130e+03  5.83576328e+03  3.50983554e+04]
E1 = -182.56189810579713  E_coul = 54.029036911229184
Extra cycle  E= -128.532861194568  delta_E= -1.42e-12  |g|= 1.37e-06  |ddm|= 2.54e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498601e+02 1.74906001e+02
 2.04947135e+01 5.69618799e+01 4.88512806e-01 7.82742052e+00
 1.65544736e+00 3.83760794e+00 1.24153734e+01 5.47535141e+01
 1.55817059e-01 1.29969365e+00 4.48059422e-01]
E = -128.53286119456794
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681866        1
[INPUT] 0    0    [1    /1   ]  617.498600983        1
[INPUT] 0    0    [1    /1   ]  174.906001445        1
[INPUT] 0    0    [1    /1   ]  20.4947135483        1
[INPUT] 0    0    [1    /1   ]  56.9618798959        1
[INPUT] 0    0    [1    /1   ]  0.488512806342       1
[INPUT] 0    0    [1    /1   ]  7.82742052204        1
[INPUT] 0    0    [1    /1   ]  1.65544735573        1
[INPUT] 1    0    [1    /1   ]  3.83760794238        1
[INPUT] 1    0    [1    /1   ]  12.4153734306        1
[INPUT] 1    0    [1    /1   ]  54.7535141373        1
[INPUT] 1    0    [1    /1   ]  0.155817059478       1
[INPUT] 1    0    [1    /1   ]  1.29969364777        1
[INPUT] 1    0    [1    /1   ]  0.448059422048       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069648, 1.0]], [0, [2712.0968186570394, 1.0]], [0, [617.4986009826702, 1.0]], [0, [174.9060014446099, 1.0]], [0, [20.494713548272152, 1.0]], [0, [56.96187989591187, 1.0]], [0, [0.4885128063415256, 1.0]], [0, [7.827420522038673, 1.0]], [0, [1.655447355731998, 1.0]], [1, [3.837607942376739, 1.0]], [1, [12.415373430635478, 1.0]], [1, [54.75351413729963, 1.0]], [1, [0.15581705947767438, 1.0]], [1, [1.299693647771032, 1.0]], [1, [0.4480594220478184, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681866]
bas 2, expnt(s) = [617.49860098]
bas 3, expnt(s) = [174.90600144]
bas 4, expnt(s) = [20.49471355]
bas 5, expnt(s) = [56.9618799]
bas 6, expnt(s) = [0.48851281]
bas 7, expnt(s) = [7.82742052]
bas 8, expnt(s) = [1.65544736]
bas 9, expnt(s) = [3.83760794]
bas 10, expnt(s) = [12.41537343]
bas 11, expnt(s) = [54.75351414]
bas 12, expnt(s) = [0.15581706]
bas 13, expnt(s) = [1.29969365]
bas 14, expnt(s) = [0.44805942]
CPU time:        32.78
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498601e+02 3.12962288e+02 1.74906001e+02 1.21511829e+02
 2.04947135e+01 2.43358441e+01 5.69618799e+01 5.23845551e+01
 4.88512806e-01 1.47629106e+00 7.82742052e+00 1.18230363e+01
 1.65544736e+00 3.68724126e+00 3.83760794e+00 1.56696807e+01
 1.24153734e+01 6.79882912e+01 5.47535141e+01 4.34509614e+02
 1.55817059e-01 2.85596676e-01 1.29969365e+00 4.04842071e+00
 4.48059422e-01 1.06943381e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999448214753484
cond(S) = 239.79352755985516
E1 = -183.58054052478147  E_coul = 55.08041976086511
init E= -128.500120763916
    CPU time for initialize scf      0.03 sec, wall time      0.04 sec
  HOMO = -0.774632782691075  LUMO = 0.422272234001126
  mo_energy =
[-3.25545313e+01 -1.85126093e+00 -7.74632783e-01 -7.74632783e-01
 -7.74632783e-01  4.22272234e-01  4.22272234e-01  4.22272234e-01
  1.98509241e+00  1.98509241e+00  1.98509241e+00  2.06582217e+00
  7.12355452e+00  7.12355452e+00  7.12355452e+00  1.94533040e+01
  2.58133518e+01  2.58133518e+01  2.58133518e+01  9.39094130e+01
  1.20263981e+02  1.20263981e+02  1.20263981e+02  3.56257707e+02
  1.34962652e+03  5.83606753e+03  3.50986801e+04]
E1 = -182.0418881924506  E_coul = 53.51272615119025
cycle= 1 E= -128.52916204126  delta_E= -0.029  |g|= 0.209  |ddm|= 0.155
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.524508
diis-c [-0.27510835  1.        ]
  HOMO = -0.885652781666335  LUMO = 0.412072520997895
  mo_energy =
[-3.28857515e+01 -1.96831390e+00 -8.85652782e-01 -8.85652782e-01
 -8.85652782e-01  4.12072521e-01  4.12072521e-01  4.12072521e-01
  1.93107136e+00  1.93107136e+00  1.93107136e+00  1.98594892e+00
  6.98570913e+00  6.98570913e+00  6.98570913e+00  1.92255230e+01
  2.55703114e+01  2.55703114e+01  2.55703114e+01  9.35973361e+01
  1.19931305e+02  1.19931305e+02  1.19931305e+02  3.55897145e+02
  1.34922735e+03  5.83563640e+03  3.50982274e+04]
E1 = -182.8285173743885  E_coul = 54.29663323441459
cycle= 2 E= -128.531884139974  delta_E= -0.00272  |g|= 0.107  |ddm|= 0.0719
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.267994
diis-c [-5.87679928e-04  3.37482011e-01  6.62517989e-01]
  HOMO = -0.848878464263222  LUMO = 0.415525587482463
  mo_energy =
[-3.27746173e+01 -1.92946153e+00 -8.48878464e-01 -8.48878464e-01
 -8.48878464e-01  4.15525587e-01  4.15525587e-01  4.15525587e-01
  1.94877628e+00  1.94877628e+00  1.94877628e+00  2.01220433e+00
  7.03128966e+00  7.03128966e+00  7.03128966e+00  1.93020800e+01
  2.56519305e+01  2.56519305e+01  2.56519305e+01  9.37022977e+01
  1.20042220e+02  1.20042220e+02  1.20042220e+02  3.56015258e+02
  1.34935190e+03  5.83576398e+03  3.50983561e+04]
E1 = -182.56160264050615  E_coul = 54.02874145827889
cycle= 3 E= -128.532861182227  delta_E= -0.000977  |g|= 0.000327  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000757961
diis-c [-9.69424773e-08 -1.74328875e-03 -8.36952943e-04  1.00258024e+00]
  HOMO = -0.849055728174586  LUMO = 0.415523011503278
  mo_energy =
[-3.27749510e+01 -1.92960277e+00 -8.49055728e-01 -8.49055728e-01
 -8.49055728e-01  4.15523012e-01  4.15523012e-01  4.15523012e-01
  1.94872560e+00  1.94872560e+00  1.94872560e+00  2.01213746e+00
  7.03114290e+00  7.03114290e+00  7.03114290e+00  1.93018692e+01
  2.56516889e+01  2.56516889e+01  2.56516889e+01  9.37019885e+01
  1.20041875e+02  1.20041875e+02  1.20041875e+02  3.56014848e+02
  1.34935137e+03  5.83576335e+03  3.50983555e+04]
E1 = -182.56180624747756  E_coul = 54.028945053359124
cycle= 4 E= -128.532861194118  delta_E= -1.19e-08  |g|= 6.13e-05  |ddm|= 0.00016
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000140825
diis-c [-5.55023812e-10  9.19277671e-05  4.21284023e-04 -1.26430335e-01
  1.12591712e+00]
  HOMO = -0.849088994526836  LUMO = 0.415518084343282
  mo_energy =
[-3.27750104e+01 -1.92963529e+00 -8.49088995e-01 -8.49088995e-01
 -8.49088995e-01  4.15518084e-01  4.15518084e-01  4.15518084e-01
  1.94870478e+00  1.94870478e+00  1.94870478e+00  2.01211098e+00
  7.03110293e+00  7.03110293e+00  7.03110293e+00  1.93018187e+01
  2.56516358e+01  2.56516358e+01  2.56516358e+01  9.37019306e+01
  1.20041816e+02  1.20041816e+02  1.20041816e+02  3.56014786e+02
  1.34935130e+03  5.83576328e+03  3.50983554e+04]
E1 = -182.56190841882153  E_coul = 54.029047224255024
cycle= 5 E= -128.532861194567  delta_E= -4.48e-10  |g|= 2.89e-06  |ddm|= 3.5e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56190841882153  E_coul = 54.029047224255024
  HOMO = -0.849088225575479  LUMO = 0.415518042022655
  mo_energy =
[-3.27750078e+01 -1.92963454e+00 -8.49088226e-01 -8.49088226e-01
 -8.49088226e-01  4.15518042e-01  4.15518042e-01  4.15518042e-01
  1.94870492e+00  1.94870492e+00  1.94870492e+00  2.01211134e+00
  7.03110389e+00  7.03110389e+00  7.03110389e+00  1.93018207e+01
  2.56516378e+01  2.56516378e+01  2.56516378e+01  9.37019330e+01
  1.20041819e+02  1.20041819e+02  1.20041819e+02  3.56014789e+02
  1.34935130e+03  5.83576328e+03  3.50983554e+04]
E1 = -182.56189810579713  E_coul = 54.029036911229184
Extra cycle  E= -128.532861194568  delta_E= -1.42e-12  |g|= 1.37e-06  |ddm|= 2.54e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.79352755985516
E1 = -182.56189810579713  E_coul = 54.029036911229184
init E= -128.532861194568
    CPU time for initialize scf      0.26 sec, wall time      0.26 sec
  HOMO = -0.849088986264552  LUMO = 0.415517947576207
  mo_energy =
[-3.27750098e+01 -1.92963538e+00 -8.49088986e-01 -8.49088986e-01
 -8.49088986e-01  4.15517948e-01  4.15517948e-01  4.15517948e-01
  1.94870450e+00  1.94870450e+00  1.94870450e+00  2.01211073e+00
  7.03110294e+00  7.03110294e+00  7.03110294e+00  1.93018192e+01
  2.56516363e+01  2.56516363e+01  2.56516363e+01  9.37019311e+01
  1.20041817e+02  1.20041817e+02  1.20041817e+02  3.56014786e+02
  1.34935130e+03  5.83576328e+03  3.50983554e+04]
E1 = -182.56190242840162  E_coul = 54.02904123383323
cycle= 1 E= -128.532861194568  delta_E= -4.55e-13  |g|= 6.07e-07  |ddm|= 6.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.56190242840162  E_coul = 54.02904123383323
  HOMO = -0.849088686380773  LUMO = 0.415517971382468
  mo_energy =
[-3.27750088e+01 -1.92963507e+00 -8.49088686e-01 -8.49088686e-01
 -8.49088686e-01  4.15517971e-01  4.15517971e-01  4.15517971e-01
  1.94870464e+00  1.94870464e+00  1.94870464e+00  2.01211093e+00
  7.03110332e+00  7.03110332e+00  7.03110332e+00  1.93018198e+01
  2.56516369e+01  2.56516369e+01  2.56516369e+01  9.37019320e+01
  1.20041818e+02  1.20041818e+02  1.20041818e+02  3.56014788e+02
  1.34935130e+03  5.83576328e+03  3.50983554e+04]
E1 = -182.5618999976576  E_coul = 54.02903880308906
Extra cycle  E= -128.532861194569  delta_E= -1.42e-13  |g|= 3.27e-07  |ddm|= 2.2e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.32 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498601e+02 1.74906001e+02
 2.04947135e+01 5.69618799e+01 4.88512806e-01 7.82742052e+00
 1.65544736e+00 3.83760794e+00 1.24153734e+01 5.47535141e+01
 1.55817059e-01 1.29969365e+00 4.48059422e-01]
grad_E = [-2.01857199e-11  1.31056894e-09 -3.13750671e-08  4.72093498e-07
  6.89720013e-06 -3.89165974e-06  1.03091634e-03 -2.36988011e-06
 -2.24154382e-04  1.92666738e-04 -9.93254224e-04  6.12072922e-05
 -2.33510622e-03 -4.70680968e-03 -2.52908739e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681865        1
[INPUT] 0    0    [1    /1   ]  617.498601078        1
[INPUT] 0    0    [1    /1   ]  174.906000007        1
[INPUT] 0    0    [1    /1   ]  20.4947043105        1
[INPUT] 0    0    [1    /1   ]  56.9618918297        1
[INPUT] 0    0    [1    /1   ]  0.490290201778       1
[INPUT] 0    0    [1    /1   ]  7.82739570839        1
[INPUT] 0    0    [1    /1   ]  1.65490960293        1
[INPUT] 1    0    [1    /1   ]  3.84639273241        1
[INPUT] 1    0    [1    /1   ]  12.416098924         1
[INPUT] 1    0    [1    /1   ]  54.7534327624        1
[INPUT] 1    0    [1    /1   ]  0.156252067975       1
[INPUT] 1    0    [1    /1   ]  1.31199008765        1
[INPUT] 1    0    [1    /1   ]  0.452799673675       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069703, 1.0]], [0, [2712.096818653258, 1.0]], [0, [617.4986010777417, 1.0]], [0, [174.9060000073666, 1.0]], [0, [20.494704310488995, 1.0]], [0, [56.96189182974471, 1.0]], [0, [0.49029020177770577, 1.0]], [0, [7.827395708391252, 1.0]], [0, [1.654909602928611, 1.0]], [1, [3.8463927324082112, 1.0]], [1, [12.416098923972976, 1.0]], [1, [54.753432762417454, 1.0]], [1, [0.15625206797548505, 1.0]], [1, [1.3119900876470632, 1.0]], [1, [0.4527996736750107, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681865]
bas 2, expnt(s) = [617.49860108]
bas 3, expnt(s) = [174.90600001]
bas 4, expnt(s) = [20.49470431]
bas 5, expnt(s) = [56.96189183]
bas 6, expnt(s) = [0.4902902]
bas 7, expnt(s) = [7.82739571]
bas 8, expnt(s) = [1.6549096]
bas 9, expnt(s) = [3.84639273]
bas 10, expnt(s) = [12.41609892]
bas 11, expnt(s) = [54.75343276]
bas 12, expnt(s) = [0.15625207]
bas 13, expnt(s) = [1.31199009]
bas 14, expnt(s) = [0.45279967]
CPU time:        35.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498601e+02 3.12962288e+02 1.74906000e+02 1.21511828e+02
 2.04947043e+01 2.43358358e+01 5.69618918e+01 5.23845633e+01
 4.90290202e-01 1.48031771e+00 7.82739571e+00 1.18230082e+01
 1.65490960e+00 3.68634291e+00 3.84639273e+00 1.57145310e+01
 1.24160989e+01 6.79932574e+01 5.47534328e+01 4.34508807e+02
 1.56252068e-01 2.86593681e-01 1.31199009e+00 4.09635498e+00
 4.52799674e-01 1.08359508e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999447388915678
cond(S) = 239.88584271209274
E1 = -183.58049007231608  E_coul = 55.08032927101534
init E= -128.500160801301
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774640216548494  LUMO = 0.424548560736293
  mo_energy =
[-3.25545755e+01 -1.85125516e+00 -7.74640217e-01 -7.74640217e-01
 -7.74640217e-01  4.24548561e-01  4.24548561e-01  4.24548561e-01
  2.00382538e+00  2.00382538e+00  2.00382538e+00  2.07138578e+00
  7.17982605e+00  7.17982605e+00  7.17982605e+00  1.94591350e+01
  2.58980519e+01  2.58980519e+01  2.58980519e+01  9.39140376e+01
  1.20336664e+02  1.20336664e+02  1.20336664e+02  3.56261664e+02
  1.34963000e+03  5.83607056e+03  3.50986826e+04]
E1 = -182.04459526277984  E_coul = 53.51536270854075
cycle= 1 E= -128.529232554239  delta_E= -0.0291  |g|= 0.209  |ddm|= 0.154
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.523615
diis-c [-0.27417235  1.        ]
  HOMO = -0.885417538302833  LUMO = 0.414253865967047
  mo_energy =
[-3.28853423e+01 -1.96813519e+00 -8.85417538e-01 -8.85417538e-01
 -8.85417538e-01  4.14253866e-01  4.14253866e-01  4.14253866e-01
  1.94935868e+00  1.94935868e+00  1.94935868e+00  1.99153267e+00
  7.04187240e+00  7.04187240e+00  7.04187240e+00  1.92318011e+01
  2.56554520e+01  2.56554520e+01  2.56554520e+01  9.36024095e+01
  1.20004466e+02  1.20004466e+02  1.20004466e+02  3.55901566e+02
  1.34923131e+03  5.83563990e+03  3.50982304e+04]
E1 = -182.82958056927026  E_coul = 54.2976357203412
cycle= 2 E= -128.531944848929  delta_E= -0.00271  |g|= 0.106  |ddm|= 0.0719
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.267556
diis-c [-5.86758654e-04  3.37496333e-01  6.62503667e-01]
  HOMO = -0.848722009474977  LUMO = 0.417737377634973
  mo_energy =
[-3.27744360e+01 -1.92936791e+00 -8.48722009e-01 -8.48722009e-01
 -8.48722009e-01  4.17737378e-01  4.17737378e-01  4.17737378e-01
  1.96720367e+00  1.96720367e+00  1.96720367e+00  2.01775609e+00
  7.08748163e+00  7.08748163e+00  7.08748163e+00  1.93081929e+01
  2.57368839e+01  2.57368839e+01  2.57368839e+01  9.37071544e+01
  1.20115145e+02  1.20115145e+02  1.20115145e+02  3.56019441e+02
  1.34935560e+03  5.83576723e+03  3.50983588e+04]
E1 = -182.5632164118562  E_coul = 54.0302984845952
cycle= 3 E= -128.532917927261  delta_E= -0.000973  |g|= 0.000324  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000728431
diis-c [-9.72619177e-08 -1.75349822e-03 -9.77291116e-04  1.00273079e+00]
  HOMO = -0.848900261996242  LUMO = 0.417734106602281
  mo_energy =
[-3.27747691e+01 -1.92951772e+00 -8.48900262e-01 -8.48900262e-01
 -8.48900262e-01  4.17734107e-01  4.17734107e-01  4.17734107e-01
  1.96715008e+00  1.96715008e+00  1.96715008e+00  2.01768155e+00
  7.08733182e+00  7.08733182e+00  7.08733182e+00  1.93079792e+01
  2.57366404e+01  2.57366404e+01  2.57366404e+01  9.37068454e+01
  1.20114802e+02  1.20114802e+02  1.20114802e+02  3.56019035e+02
  1.34935508e+03  5.83576662e+03  3.50983582e+04]
E1 = -182.56339928640037  E_coul = 54.03048134691257
cycle= 4 E= -128.532917939488  delta_E= -1.22e-08  |g|= 5.99e-05  |ddm|= 0.000165
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130612
diis-c [-5.94972177e-10  9.09945903e-05  3.90805398e-04 -1.25903736e-01
  1.12542194e+00]
  HOMO = -0.84893324092499  LUMO = 0.417729040286378
  mo_energy =
[-3.27748268e+01 -1.92955166e+00 -8.48933241e-01 -8.48933241e-01
 -8.48933241e-01  4.17729040e-01  4.17729040e-01  4.17729040e-01
  1.96712887e+00  1.96712887e+00  1.96712887e+00  2.01765370e+00
  7.08729192e+00  7.08729192e+00  7.08729192e+00  1.93079290e+01
  2.57365882e+01  2.57365882e+01  2.57365882e+01  9.37067890e+01
  1.20114744e+02  1.20114744e+02  1.20114744e+02  3.56018976e+02
  1.34935502e+03  5.83576656e+03  3.50983581e+04]
E1 = -182.56349254669152  E_coul = 54.03057460675016
cycle= 5 E= -128.532917939941  delta_E= -4.54e-10  |g|= 3.29e-06  |ddm|= 3.7e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56349254669152  E_coul = 54.03057460675016
  HOMO = -0.848932354001114  LUMO = 0.417728994459097
  mo_energy =
[-3.27748236e+01 -1.92955096e+00 -8.48932354e-01 -8.48932354e-01
 -8.48932354e-01  4.17728994e-01  4.17728994e-01  4.17728994e-01
  1.96712904e+00  1.96712904e+00  1.96712904e+00  2.01765398e+00
  7.08729301e+00  7.08729301e+00  7.08729301e+00  1.93079311e+01
  2.57365904e+01  2.57365904e+01  2.57365904e+01  9.37067919e+01
  1.20114747e+02  1.20114747e+02  1.20114747e+02  3.56018979e+02
  1.34935502e+03  5.83576656e+03  3.50983581e+04]
E1 = -182.5634805901224  E_coul = 54.03056265017828
Extra cycle  E= -128.532917939944  delta_E= -2.76e-12  |g|= 1.61e-06  |ddm|= 2.81e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498601e+02 1.74906000e+02
 2.04947043e+01 5.69618918e+01 4.90290202e-01 7.82739571e+00
 1.65490960e+00 3.84639273e+00 1.24160989e+01 5.47534328e+01
 1.56252068e-01 1.31199009e+00 4.52799674e-01]
E = -128.53291793994413
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681865        1
[INPUT] 0    0    [1    /1   ]  617.498601078        1
[INPUT] 0    0    [1    /1   ]  174.906000007        1
[INPUT] 0    0    [1    /1   ]  20.4947043105        1
[INPUT] 0    0    [1    /1   ]  56.9618918297        1
[INPUT] 0    0    [1    /1   ]  0.490290201778       1
[INPUT] 0    0    [1    /1   ]  7.82739570839        1
[INPUT] 0    0    [1    /1   ]  1.65490960293        1
[INPUT] 1    0    [1    /1   ]  3.84639273241        1
[INPUT] 1    0    [1    /1   ]  12.416098924         1
[INPUT] 1    0    [1    /1   ]  54.7534327624        1
[INPUT] 1    0    [1    /1   ]  0.156252067975       1
[INPUT] 1    0    [1    /1   ]  1.31199008765        1
[INPUT] 1    0    [1    /1   ]  0.452799673675       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069703, 1.0]], [0, [2712.096818653258, 1.0]], [0, [617.4986010777417, 1.0]], [0, [174.9060000073666, 1.0]], [0, [20.494704310488995, 1.0]], [0, [56.96189182974471, 1.0]], [0, [0.49029020177770577, 1.0]], [0, [7.827395708391252, 1.0]], [0, [1.654909602928611, 1.0]], [1, [3.8463927324082112, 1.0]], [1, [12.416098923972976, 1.0]], [1, [54.753432762417454, 1.0]], [1, [0.15625206797548505, 1.0]], [1, [1.3119900876470632, 1.0]], [1, [0.4527996736750107, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681865]
bas 2, expnt(s) = [617.49860108]
bas 3, expnt(s) = [174.90600001]
bas 4, expnt(s) = [20.49470431]
bas 5, expnt(s) = [56.96189183]
bas 6, expnt(s) = [0.4902902]
bas 7, expnt(s) = [7.82739571]
bas 8, expnt(s) = [1.6549096]
bas 9, expnt(s) = [3.84639273]
bas 10, expnt(s) = [12.41609892]
bas 11, expnt(s) = [54.75343276]
bas 12, expnt(s) = [0.15625207]
bas 13, expnt(s) = [1.31199009]
bas 14, expnt(s) = [0.45279967]
CPU time:        36.03
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498601e+02 3.12962288e+02 1.74906000e+02 1.21511828e+02
 2.04947043e+01 2.43358358e+01 5.69618918e+01 5.23845633e+01
 4.90290202e-01 1.48031771e+00 7.82739571e+00 1.18230082e+01
 1.65490960e+00 3.68634291e+00 3.84639273e+00 1.57145310e+01
 1.24160989e+01 6.79932574e+01 5.47534328e+01 4.34508807e+02
 1.56252068e-01 2.86593681e-01 1.31199009e+00 4.09635498e+00
 4.52799674e-01 1.08359508e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999447388915678
cond(S) = 239.88584271209274
E1 = -183.58049007231608  E_coul = 55.08032927101534
init E= -128.500160801301
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774640216548494  LUMO = 0.424548560736293
  mo_energy =
[-3.25545755e+01 -1.85125516e+00 -7.74640217e-01 -7.74640217e-01
 -7.74640217e-01  4.24548561e-01  4.24548561e-01  4.24548561e-01
  2.00382538e+00  2.00382538e+00  2.00382538e+00  2.07138578e+00
  7.17982605e+00  7.17982605e+00  7.17982605e+00  1.94591350e+01
  2.58980519e+01  2.58980519e+01  2.58980519e+01  9.39140376e+01
  1.20336664e+02  1.20336664e+02  1.20336664e+02  3.56261664e+02
  1.34963000e+03  5.83607056e+03  3.50986826e+04]
E1 = -182.04459526277984  E_coul = 53.51536270854075
cycle= 1 E= -128.529232554239  delta_E= -0.0291  |g|= 0.209  |ddm|= 0.154
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.523615
diis-c [-0.27417235  1.        ]
  HOMO = -0.885417538302833  LUMO = 0.414253865967047
  mo_energy =
[-3.28853423e+01 -1.96813519e+00 -8.85417538e-01 -8.85417538e-01
 -8.85417538e-01  4.14253866e-01  4.14253866e-01  4.14253866e-01
  1.94935868e+00  1.94935868e+00  1.94935868e+00  1.99153267e+00
  7.04187240e+00  7.04187240e+00  7.04187240e+00  1.92318011e+01
  2.56554520e+01  2.56554520e+01  2.56554520e+01  9.36024095e+01
  1.20004466e+02  1.20004466e+02  1.20004466e+02  3.55901566e+02
  1.34923131e+03  5.83563990e+03  3.50982304e+04]
E1 = -182.82958056927026  E_coul = 54.2976357203412
cycle= 2 E= -128.531944848929  delta_E= -0.00271  |g|= 0.106  |ddm|= 0.0719
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.267556
diis-c [-5.86758654e-04  3.37496333e-01  6.62503667e-01]
  HOMO = -0.848722009474977  LUMO = 0.417737377634973
  mo_energy =
[-3.27744360e+01 -1.92936791e+00 -8.48722009e-01 -8.48722009e-01
 -8.48722009e-01  4.17737378e-01  4.17737378e-01  4.17737378e-01
  1.96720367e+00  1.96720367e+00  1.96720367e+00  2.01775609e+00
  7.08748163e+00  7.08748163e+00  7.08748163e+00  1.93081929e+01
  2.57368839e+01  2.57368839e+01  2.57368839e+01  9.37071544e+01
  1.20115145e+02  1.20115145e+02  1.20115145e+02  3.56019441e+02
  1.34935560e+03  5.83576723e+03  3.50983588e+04]
E1 = -182.5632164118562  E_coul = 54.0302984845952
cycle= 3 E= -128.532917927261  delta_E= -0.000973  |g|= 0.000324  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000728431
diis-c [-9.72619177e-08 -1.75349822e-03 -9.77291116e-04  1.00273079e+00]
  HOMO = -0.848900261996242  LUMO = 0.417734106602281
  mo_energy =
[-3.27747691e+01 -1.92951772e+00 -8.48900262e-01 -8.48900262e-01
 -8.48900262e-01  4.17734107e-01  4.17734107e-01  4.17734107e-01
  1.96715008e+00  1.96715008e+00  1.96715008e+00  2.01768155e+00
  7.08733182e+00  7.08733182e+00  7.08733182e+00  1.93079792e+01
  2.57366404e+01  2.57366404e+01  2.57366404e+01  9.37068454e+01
  1.20114802e+02  1.20114802e+02  1.20114802e+02  3.56019035e+02
  1.34935508e+03  5.83576662e+03  3.50983582e+04]
E1 = -182.56339928640037  E_coul = 54.03048134691257
cycle= 4 E= -128.532917939488  delta_E= -1.22e-08  |g|= 5.99e-05  |ddm|= 0.000165
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000130612
diis-c [-5.94972177e-10  9.09945903e-05  3.90805398e-04 -1.25903736e-01
  1.12542194e+00]
  HOMO = -0.84893324092499  LUMO = 0.417729040286378
  mo_energy =
[-3.27748268e+01 -1.92955166e+00 -8.48933241e-01 -8.48933241e-01
 -8.48933241e-01  4.17729040e-01  4.17729040e-01  4.17729040e-01
  1.96712887e+00  1.96712887e+00  1.96712887e+00  2.01765370e+00
  7.08729192e+00  7.08729192e+00  7.08729192e+00  1.93079290e+01
  2.57365882e+01  2.57365882e+01  2.57365882e+01  9.37067890e+01
  1.20114744e+02  1.20114744e+02  1.20114744e+02  3.56018976e+02
  1.34935502e+03  5.83576656e+03  3.50983581e+04]
E1 = -182.56349254669152  E_coul = 54.03057460675016
cycle= 5 E= -128.532917939941  delta_E= -4.54e-10  |g|= 3.29e-06  |ddm|= 3.7e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56349254669152  E_coul = 54.03057460675016
  HOMO = -0.848932354001114  LUMO = 0.417728994459097
  mo_energy =
[-3.27748236e+01 -1.92955096e+00 -8.48932354e-01 -8.48932354e-01
 -8.48932354e-01  4.17728994e-01  4.17728994e-01  4.17728994e-01
  1.96712904e+00  1.96712904e+00  1.96712904e+00  2.01765398e+00
  7.08729301e+00  7.08729301e+00  7.08729301e+00  1.93079311e+01
  2.57365904e+01  2.57365904e+01  2.57365904e+01  9.37067919e+01
  1.20114747e+02  1.20114747e+02  1.20114747e+02  3.56018979e+02
  1.34935502e+03  5.83576656e+03  3.50983581e+04]
E1 = -182.5634805901224  E_coul = 54.03056265017828
Extra cycle  E= -128.532917939944  delta_E= -2.76e-12  |g|= 1.61e-06  |ddm|= 2.81e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.88584271209274
E1 = -182.5634805901224  E_coul = 54.03056265017828
init E= -128.532917939944
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.848933229371862  LUMO = 0.417728885008988
  mo_energy =
[-3.27748260e+01 -1.92955195e+00 -8.48933229e-01 -8.48933229e-01
 -8.48933229e-01  4.17728885e-01  4.17728885e-01  4.17728885e-01
  1.96712855e+00  1.96712855e+00  1.96712855e+00  2.01765326e+00
  7.08729191e+00  7.08729191e+00  7.08729191e+00  1.93079294e+01
  2.57365886e+01  2.57365886e+01  2.57365886e+01  9.37067896e+01
  1.20114745e+02  1.20114745e+02  1.20114745e+02  3.56018976e+02
  1.34935502e+03  5.83576656e+03  3.50983581e+04]
E1 = -182.5634855782795  E_coul = 54.030567638335064
cycle= 1 E= -128.532917939944  delta_E= -3.13e-13  |g|= 7e-07  |ddm|= 8.05e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5634855782795  E_coul = 54.030567638335064
  HOMO = -0.848932882175175  LUMO = 0.417728912908191
  mo_energy =
[-3.27748249e+01 -1.92955160e+00 -8.48932882e-01 -8.48932882e-01
 -8.48932882e-01  4.17728913e-01  4.17728913e-01  4.17728913e-01
  1.96712871e+00  1.96712871e+00  1.96712871e+00  2.01765348e+00
  7.08729235e+00  7.08729235e+00  7.08729235e+00  1.93079302e+01
  2.57365894e+01  2.57365894e+01  2.57365894e+01  9.37067907e+01
  1.20114746e+02  1.20114746e+02  1.20114746e+02  3.56018978e+02
  1.34935502e+03  5.83576656e+03  3.50983581e+04]
E1 = -182.56348276521504  E_coul = 54.030564825270766
Extra cycle  E= -128.532917939944  delta_E= 1.71e-13  |g|= 3.79e-07  |ddm|= 2.49e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498601e+02 1.74906000e+02
 2.04947043e+01 5.69618918e+01 4.90290202e-01 7.82739571e+00
 1.65490960e+00 3.84639273e+00 1.24160989e+01 5.47534328e+01
 1.56252068e-01 1.31199009e+00 4.52799674e-01]
grad_E = [-3.88850632e-11  2.33655863e-09 -5.07387508e-08  7.28149583e-07
  2.00337266e-05 -5.74419689e-06  5.12175086e-03 -2.91042767e-05
 -1.32643784e-03 -5.72976687e-04 -9.29108461e-04  5.95927838e-05
 -2.74337992e-03 -2.53493822e-03 -3.69192444e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681863        1
[INPUT] 0    0    [1    /1   ]  617.498601541        1
[INPUT] 0    0    [1    /1   ]  174.905993026        1
[INPUT] 0    0    [1    /1   ]  20.4946479533        1
[INPUT] 0    0    [1    /1   ]  56.9619496178        1
[INPUT] 0    0    [1    /1   ]  0.494256867774       1
[INPUT] 0    0    [1    /1   ]  7.82730589692        1
[INPUT] 0    0    [1    /1   ]  1.65348873902        1
[INPUT] 1    0    [1    /1   ]  3.89004522279        1
[INPUT] 1    0    [1    /1   ]  12.4200131063        1
[INPUT] 1    0    [1    /1   ]  54.7530141897        1
[INPUT] 1    0    [1    /1   ]  0.168642762293       1
[INPUT] 1    0    [1    /1   ]  1.35822574131        1
[INPUT] 1    0    [1    /1   ]  0.482230558753       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069983, 1.0]], [0, [2712.096818634605, 1.0]], [0, [617.4986015411135, 1.0]], [0, [174.905993026237, 1.0]], [0, [20.494647953277642, 1.0]], [0, [56.96194961780683, 1.0]], [0, [0.49425686777416183, 1.0]], [0, [7.8273058969180225, 1.0]], [0, [1.6534887390163446, 1.0]], [1, [3.890045222794519, 1.0]], [1, [12.42001310634856, 1.0]], [1, [54.75301418972736, 1.0]], [1, [0.16864276229273995, 1.0]], [1, [1.3582257413142633, 1.0]], [1, [0.4822305587527564, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681863]
bas 2, expnt(s) = [617.49860154]
bas 3, expnt(s) = [174.90599303]
bas 4, expnt(s) = [20.49464795]
bas 5, expnt(s) = [56.96194962]
bas 6, expnt(s) = [0.49425687]
bas 7, expnt(s) = [7.8273059]
bas 8, expnt(s) = [1.65348874]
bas 9, expnt(s) = [3.89004522]
bas 10, expnt(s) = [12.42001311]
bas 11, expnt(s) = [54.75301419]
bas 12, expnt(s) = [0.16864276]
bas 13, expnt(s) = [1.35822574]
bas 14, expnt(s) = [0.48223056]
CPU time:        39.02
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498602e+02 3.12962288e+02 1.74905993e+02 1.21511825e+02
 2.04946480e+01 2.43357856e+01 5.69619496e+01 5.23846032e+01
 4.94256868e-01 1.48929098e+00 7.82730590e+00 1.18229065e+01
 1.65348874e+00 3.68396890e+00 3.89004522e+00 1.59377755e+01
 1.24200131e+01 6.80200521e+01 5.47530142e+01 4.34504654e+02
 1.68642762e-01 3.15278261e-01 1.35822574e+00 4.27759180e+00
 4.82230559e-01 1.17233789e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999456142936262
cond(S) = 240.08148776657958
E1 = -183.58032765867858  E_coul = 55.08008618398006
init E= -128.500241474699
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774672749923564  LUMO = 0.461819217533963
  mo_energy =
[-3.25546942e+01 -1.85122913e+00 -7.74672750e-01 -7.74672750e-01
 -7.74672750e-01  4.61819218e-01  4.61819218e-01  4.61819218e-01
  2.08355355e+00  2.14353830e+00  2.14353830e+00  2.14353830e+00
  7.47828715e+00  7.47828715e+00  7.47828715e+00  1.94712494e+01
  2.63157924e+01  2.63157924e+01  2.63157924e+01  9.39232898e+01
  1.20693512e+02  1.20693512e+02  1.20693512e+02  3.56269497e+02
  1.34963692e+03  5.83607659e+03  3.50986876e+04]
E1 = -182.05153420071952  E_coul = 53.52207779306155
cycle= 1 E= -128.529456407658  delta_E= -0.0292  |g|= 0.208  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.526193
diis-c [-0.27687879  1.        ]
  HOMO = -0.884838566651676  LUMO = 0.450191071587312
  mo_energy =
[-3.28843016e+01 -1.96764285e+00 -8.84838567e-01 -8.84838567e-01
 -8.84838567e-01  4.50191072e-01  4.50191072e-01  4.50191072e-01
  2.00384758e+00  2.08661686e+00  2.08661686e+00  2.08661686e+00
  7.33978096e+00  7.33978096e+00  7.33978096e+00  1.92449687e+01
  2.60744645e+01  2.60744645e+01  2.60744645e+01  9.36127857e+01
  1.20362621e+02  1.20362621e+02  1.20362621e+02  3.55910566e+02
  1.34923938e+03  5.83564710e+03  3.50982365e+04]
E1 = -182.83264617961947  E_coul = 54.300499166238744
cycle= 2 E= -128.532147013381  delta_E= -0.00269  |g|= 0.106  |ddm|= 0.0714
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.268856
diis-c [-5.83337018e-04  3.37492335e-01  6.62507665e-01]
  HOMO = -0.848327329171333  LUMO = 0.454107380171411
  mo_energy =
[-3.27739228e+01 -1.92907535e+00 -8.48327329e-01 -8.48327329e-01
 -8.48327329e-01  4.54107380e-01  4.54107380e-01  4.54107380e-01
  2.02999007e+00  2.10525694e+00  2.10525694e+00  2.10525694e+00
  7.38557661e+00  7.38557661e+00  7.38557661e+00  1.93209761e+01
  2.61554002e+01  2.61554002e+01  2.61554002e+01  9.37170288e+01
  1.20472727e+02  1.20472727e+02  1.20472727e+02  3.56027890e+02
  1.34936310e+03  5.83577385e+03  3.50983644e+04]
E1 = -182.5676078688045  E_coul = 54.03449716801603
cycle= 3 E= -128.533110700788  delta_E= -0.000964  |g|= 0.00033  |ddm|= 0.0244
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000678151
diis-c [-1.07758626e-07 -1.78904751e-03 -1.30658261e-03  1.00309563e+00]
  HOMO = -0.848507587352726  LUMO = 0.454100554732118
  mo_energy =
[-3.27742544e+01 -1.92924367e+00 -8.48507587e-01 -8.48507587e-01
 -8.48507587e-01  4.54100555e-01  4.54100555e-01  4.54100555e-01
  2.02989863e+00  2.10519322e+00  2.10519322e+00  2.10519322e+00
  7.38541937e+00  7.38541937e+00  7.38541937e+00  1.93207564e+01
  2.61551529e+01  2.61551529e+01  2.61551529e+01  9.37167202e+01
  1.20472386e+02  1.20472386e+02  1.20472386e+02  3.56027492e+02
  1.34936260e+03  5.83577326e+03  3.50983638e+04]
E1 = -182.56773190085647  E_coul = 54.03462118462261
cycle= 4 E= -128.533110716234  delta_E= -1.54e-08  |g|= 6.17e-05  |ddm|= 0.000206
    CPU time for cycle= 4      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000115419
diis-c [-8.50197668e-10  1.02724102e-04  3.47704845e-04 -1.35392182e-01
  1.13494175e+00]
  HOMO = -0.848541250144742  LUMO = 0.454094370595608
  mo_energy =
[-3.27743106e+01 -1.92928220e+00 -8.48541250e-01 -8.48541250e-01
 -8.48541250e-01  4.54094371e-01  4.54094371e-01  4.54094371e-01
  2.02986649e+00  2.10516970e+00  2.10516970e+00  2.10516970e+00
  7.38537794e+00  7.38537794e+00  7.38537794e+00  1.93207047e+01
  2.61551003e+01  2.61551003e+01  2.61551003e+01  9.37166647e+01
  1.20472330e+02  1.20472330e+02  1.20472330e+02  3.56027437e+02
  1.34936255e+03  5.83577320e+03  3.50983637e+04]
E1 = -182.56780772793724  E_coul = 54.0346970111377
cycle= 5 E= -128.5331107168  delta_E= -5.66e-10  |g|= 4.52e-06  |ddm|= 4.64e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.56780772793724  E_coul = 54.0346970111377
  HOMO = -0.848539851996754  LUMO = 0.454094364346147
  mo_energy =
[-3.27743060e+01 -1.92928134e+00 -8.48539852e-01 -8.48539852e-01
 -8.48539852e-01  4.54094364e-01  4.54094364e-01  4.54094364e-01
  2.02986683e+00  2.10517009e+00  2.10517009e+00  2.10517009e+00
  7.38537963e+00  7.38537963e+00  7.38537963e+00  1.93207077e+01
  2.61551036e+01  2.61551036e+01  2.61551036e+01  9.37166691e+01
  1.20472335e+02  1.20472335e+02  1.20472335e+02  3.56027442e+02
  1.34936255e+03  5.83577321e+03  3.50983637e+04]
E1 = -182.56779126738581  E_coul = 54.03468055058228
Extra cycle  E= -128.533110716804  delta_E= -4.01e-12  |g|= 2.27e-06  |ddm|= 3.27e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498602e+02 1.74905993e+02
 2.04946480e+01 5.69619496e+01 4.94256868e-01 7.82730590e+00
 1.65348874e+00 3.89004522e+00 1.24200131e+01 5.47530142e+01
 1.68642762e-01 1.35822574e+00 4.82230559e-01]
E = -128.53311071680355
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681863        1
[INPUT] 0    0    [1    /1   ]  617.498601541        1
[INPUT] 0    0    [1    /1   ]  174.905993026        1
[INPUT] 0    0    [1    /1   ]  20.4946479533        1
[INPUT] 0    0    [1    /1   ]  56.9619496178        1
[INPUT] 0    0    [1    /1   ]  0.494256867774       1
[INPUT] 0    0    [1    /1   ]  7.82730589692        1
[INPUT] 0    0    [1    /1   ]  1.65348873902        1
[INPUT] 1    0    [1    /1   ]  3.89004522279        1
[INPUT] 1    0    [1    /1   ]  12.4200131063        1
[INPUT] 1    0    [1    /1   ]  54.7530141897        1
[INPUT] 1    0    [1    /1   ]  0.168642762293       1
[INPUT] 1    0    [1    /1   ]  1.35822574131        1
[INPUT] 1    0    [1    /1   ]  0.482230558753       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730069983, 1.0]], [0, [2712.096818634605, 1.0]], [0, [617.4986015411135, 1.0]], [0, [174.905993026237, 1.0]], [0, [20.494647953277642, 1.0]], [0, [56.96194961780683, 1.0]], [0, [0.49425686777416183, 1.0]], [0, [7.8273058969180225, 1.0]], [0, [1.6534887390163446, 1.0]], [1, [3.890045222794519, 1.0]], [1, [12.42001310634856, 1.0]], [1, [54.75301418972736, 1.0]], [1, [0.16864276229273995, 1.0]], [1, [1.3582257413142633, 1.0]], [1, [0.4822305587527564, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681863]
bas 2, expnt(s) = [617.49860154]
bas 3, expnt(s) = [174.90599303]
bas 4, expnt(s) = [20.49464795]
bas 5, expnt(s) = [56.96194962]
bas 6, expnt(s) = [0.49425687]
bas 7, expnt(s) = [7.8273059]
bas 8, expnt(s) = [1.65348874]
bas 9, expnt(s) = [3.89004522]
bas 10, expnt(s) = [12.42001311]
bas 11, expnt(s) = [54.75301419]
bas 12, expnt(s) = [0.16864276]
bas 13, expnt(s) = [1.35822574]
bas 14, expnt(s) = [0.48223056]
CPU time:        39.41
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498602e+02 3.12962288e+02 1.74905993e+02 1.21511825e+02
 2.04946480e+01 2.43357856e+01 5.69619496e+01 5.23846032e+01
 4.94256868e-01 1.48929098e+00 7.82730590e+00 1.18229065e+01
 1.65348874e+00 3.68396890e+00 3.89004522e+00 1.59377755e+01
 1.24200131e+01 6.80200521e+01 5.47530142e+01 4.34504654e+02
 1.68642762e-01 3.15278261e-01 1.35822574e+00 4.27759180e+00
 4.82230559e-01 1.17233789e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999456142936262
cond(S) = 240.08148776657958
E1 = -183.58032765867858  E_coul = 55.08008618398006
init E= -128.500241474699
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774672749923564  LUMO = 0.461819217533963
  mo_energy =
[-3.25546942e+01 -1.85122913e+00 -7.74672750e-01 -7.74672750e-01
 -7.74672750e-01  4.61819218e-01  4.61819218e-01  4.61819218e-01
  2.08355355e+00  2.14353830e+00  2.14353830e+00  2.14353830e+00
  7.47828715e+00  7.47828715e+00  7.47828715e+00  1.94712494e+01
  2.63157924e+01  2.63157924e+01  2.63157924e+01  9.39232898e+01
  1.20693512e+02  1.20693512e+02  1.20693512e+02  3.56269497e+02
  1.34963692e+03  5.83607659e+03  3.50986876e+04]
E1 = -182.05153420071952  E_coul = 53.52207779306155
cycle= 1 E= -128.529456407658  delta_E= -0.0292  |g|= 0.208  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.526193
diis-c [-0.27687879  1.        ]
  HOMO = -0.884838566651676  LUMO = 0.450191071587312
  mo_energy =
[-3.28843016e+01 -1.96764285e+00 -8.84838567e-01 -8.84838567e-01
 -8.84838567e-01  4.50191072e-01  4.50191072e-01  4.50191072e-01
  2.00384758e+00  2.08661686e+00  2.08661686e+00  2.08661686e+00
  7.33978096e+00  7.33978096e+00  7.33978096e+00  1.92449687e+01
  2.60744645e+01  2.60744645e+01  2.60744645e+01  9.36127857e+01
  1.20362621e+02  1.20362621e+02  1.20362621e+02  3.55910566e+02
  1.34923938e+03  5.83564710e+03  3.50982365e+04]
E1 = -182.83264617961947  E_coul = 54.300499166238744
cycle= 2 E= -128.532147013381  delta_E= -0.00269  |g|= 0.106  |ddm|= 0.0714
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.268856
diis-c [-5.83337018e-04  3.37492335e-01  6.62507665e-01]
  HOMO = -0.848327329171333  LUMO = 0.454107380171411
  mo_energy =
[-3.27739228e+01 -1.92907535e+00 -8.48327329e-01 -8.48327329e-01
 -8.48327329e-01  4.54107380e-01  4.54107380e-01  4.54107380e-01
  2.02999007e+00  2.10525694e+00  2.10525694e+00  2.10525694e+00
  7.38557661e+00  7.38557661e+00  7.38557661e+00  1.93209761e+01
  2.61554002e+01  2.61554002e+01  2.61554002e+01  9.37170288e+01
  1.20472727e+02  1.20472727e+02  1.20472727e+02  3.56027890e+02
  1.34936310e+03  5.83577385e+03  3.50983644e+04]
E1 = -182.5676078688045  E_coul = 54.03449716801603
cycle= 3 E= -128.533110700788  delta_E= -0.000964  |g|= 0.00033  |ddm|= 0.0244
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000678151
diis-c [-1.07758626e-07 -1.78904751e-03 -1.30658261e-03  1.00309563e+00]
  HOMO = -0.848507587352726  LUMO = 0.454100554732118
  mo_energy =
[-3.27742544e+01 -1.92924367e+00 -8.48507587e-01 -8.48507587e-01
 -8.48507587e-01  4.54100555e-01  4.54100555e-01  4.54100555e-01
  2.02989863e+00  2.10519322e+00  2.10519322e+00  2.10519322e+00
  7.38541937e+00  7.38541937e+00  7.38541937e+00  1.93207564e+01
  2.61551529e+01  2.61551529e+01  2.61551529e+01  9.37167202e+01
  1.20472386e+02  1.20472386e+02  1.20472386e+02  3.56027492e+02
  1.34936260e+03  5.83577326e+03  3.50983638e+04]
E1 = -182.56773190085647  E_coul = 54.03462118462261
cycle= 4 E= -128.533110716234  delta_E= -1.54e-08  |g|= 6.17e-05  |ddm|= 0.000206
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000115419
diis-c [-8.50197668e-10  1.02724102e-04  3.47704845e-04 -1.35392182e-01
  1.13494175e+00]
  HOMO = -0.848541250144742  LUMO = 0.454094370595608
  mo_energy =
[-3.27743106e+01 -1.92928220e+00 -8.48541250e-01 -8.48541250e-01
 -8.48541250e-01  4.54094371e-01  4.54094371e-01  4.54094371e-01
  2.02986649e+00  2.10516970e+00  2.10516970e+00  2.10516970e+00
  7.38537794e+00  7.38537794e+00  7.38537794e+00  1.93207047e+01
  2.61551003e+01  2.61551003e+01  2.61551003e+01  9.37166647e+01
  1.20472330e+02  1.20472330e+02  1.20472330e+02  3.56027437e+02
  1.34936255e+03  5.83577320e+03  3.50983637e+04]
E1 = -182.56780772793724  E_coul = 54.0346970111377
cycle= 5 E= -128.5331107168  delta_E= -5.66e-10  |g|= 4.52e-06  |ddm|= 4.64e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56780772793724  E_coul = 54.0346970111377
  HOMO = -0.848539851996754  LUMO = 0.454094364346147
  mo_energy =
[-3.27743060e+01 -1.92928134e+00 -8.48539852e-01 -8.48539852e-01
 -8.48539852e-01  4.54094364e-01  4.54094364e-01  4.54094364e-01
  2.02986683e+00  2.10517009e+00  2.10517009e+00  2.10517009e+00
  7.38537963e+00  7.38537963e+00  7.38537963e+00  1.93207077e+01
  2.61551036e+01  2.61551036e+01  2.61551036e+01  9.37166691e+01
  1.20472335e+02  1.20472335e+02  1.20472335e+02  3.56027442e+02
  1.34936255e+03  5.83577321e+03  3.50983637e+04]
E1 = -182.56779126738581  E_coul = 54.03468055058228
Extra cycle  E= -128.533110716804  delta_E= -4.01e-12  |g|= 2.27e-06  |ddm|= 3.27e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.08148776657958
E1 = -182.56779126738581  E_coul = 54.03468055058228
init E= -128.533110716804
    CPU time for initialize scf      0.26 sec, wall time      0.25 sec
  HOMO = -0.848541036908658  LUMO = 0.454094205156449
  mo_energy =
[-3.27743092e+01 -1.92928274e+00 -8.48541037e-01 -8.48541037e-01
 -8.48541037e-01  4.54094205e-01  4.54094205e-01  4.54094205e-01
  2.02986581e+00  2.10516942e+00  2.10516942e+00  2.10516942e+00
  7.38537813e+00  7.38537813e+00  7.38537813e+00  1.93207053e+01
  2.61551011e+01  2.61551011e+01  2.61551011e+01  9.37166660e+01
  1.20472332e+02  1.20472332e+02  1.20472332e+02  3.56027438e+02
  1.34936255e+03  5.83577320e+03  3.50983637e+04]
E1 = -182.56779832925073  E_coul = 54.03468761244681
cycle= 1 E= -128.533110716804  delta_E= -3.69e-13  |g|= 9.82e-07  |ddm|= 1.09e-06
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.56779832925073  E_coul = 54.03468761244681
  HOMO = -0.848540541447775  LUMO = 0.454094252147697
  mo_energy =
[-3.27743077e+01 -1.92928225e+00 -8.48540541e-01 -8.48540541e-01
 -8.48540541e-01  4.54094252e-01  4.54094252e-01  4.54094252e-01
  2.02986613e+00  2.10516966e+00  2.10516966e+00  2.10516966e+00
  7.38537875e+00  7.38537875e+00  7.38537875e+00  1.93207063e+01
  2.61551023e+01  2.61551023e+01  2.61551023e+01  9.37166674e+01
  1.20472333e+02  1.20472333e+02  1.20472333e+02  3.56027440e+02
  1.34936255e+03  5.83577320e+03  3.50983637e+04]
E1 = -182.56779439698633  E_coul = 54.03468368018225
Extra cycle  E= -128.533110716804  delta_E= -1.71e-13  |g|= 5.31e-07  |ddm|= 3.35e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498602e+02 1.74905993e+02
 2.04946480e+01 5.69619496e+01 4.94256868e-01 7.82730590e+00
 1.65348874e+00 3.89004522e+00 1.24200131e+01 5.47530142e+01
 1.68642762e-01 1.35822574e+00 4.82230559e-01]
grad_E = [-8.03128080e-11  4.61738620e-09 -9.36351862e-08  1.30116722e-06
  5.00031266e-05 -9.88946228e-06  1.41123230e-02 -8.88441468e-05
 -3.77224408e-03 -7.95890896e-04 -1.06459131e-03  6.86808334e-05
 -4.59990575e-03 -1.90313456e-03 -1.11886251e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.0968186         1
[INPUT] 0    0    [1    /1   ]  617.498602308        1
[INPUT] 0    0    [1    /1   ]  174.905981539        1
[INPUT] 0    0    [1    /1   ]  20.4945339076        1
[INPUT] 0    0    [1    /1   ]  56.962044119         1
[INPUT] 0    0    [1    /1   ]  0.493600642565       1
[INPUT] 0    0    [1    /1   ]  7.82721240239        1
[INPUT] 0    0    [1    /1   ]  1.65321425532        1
[INPUT] 1    0    [1    /1   ]  3.96364746866        1
[INPUT] 1    0    [1    /1   ]  12.4251094842        1
[INPUT] 1    0    [1    /1   ]  54.75240185          1
[INPUT] 1    0    [1    /1   ]  0.186181269323       1
[INPUT] 1    0    [1    /1   ]  1.4286636211         1
[INPUT] 1    0    [1    /1   ]  0.520292785151       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873007046, 1.0]], [0, [2712.0968186032374, 1.0]], [0, [617.4986023081228, 1.0]], [0, [174.9059815388861, 1.0]], [0, [20.49453390762646, 1.0]], [0, [56.962044119008794, 1.0]], [0, [0.4936006425647307, 1.0]], [0, [7.827212402390525, 1.0]], [0, [1.6532142553204534, 1.0]], [1, [3.9636474686567937, 1.0]], [1, [12.425109484224203, 1.0]], [1, [54.75240184995354, 1.0]], [1, [0.18618126932301288, 1.0]], [1, [1.4286636210976362, 1.0]], [1, [0.5202927851508322, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.0968186]
bas 2, expnt(s) = [617.49860231]
bas 3, expnt(s) = [174.90598154]
bas 4, expnt(s) = [20.49453391]
bas 5, expnt(s) = [56.96204412]
bas 6, expnt(s) = [0.49360064]
bas 7, expnt(s) = [7.8272124]
bas 8, expnt(s) = [1.65321426]
bas 9, expnt(s) = [3.96364747]
bas 10, expnt(s) = [12.42510948]
bas 11, expnt(s) = [54.75240185]
bas 12, expnt(s) = [0.18618127]
bas 13, expnt(s) = [1.42866362]
bas 14, expnt(s) = [0.52029279]
CPU time:        42.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498602e+02 3.12962288e+02 1.74905982e+02 1.21511819e+02
 2.04945339e+01 2.43356841e+01 5.69620441e+01 5.23846683e+01
 4.93600643e-01 1.48780773e+00 7.82721240e+00 1.18228006e+01
 1.65321426e+00 3.68351023e+00 3.96364747e+00 1.63156045e+01
 1.24251095e+01 6.80549427e+01 5.47524018e+01 4.34498580e+02
 1.86181269e-01 3.56783183e-01 1.42866362e+00 4.55666263e+00
 5.20292785e-01 1.28912238e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999465284930373
cond(S) = 240.02107740995694
E1 = -183.58072947814247  E_coul = 55.08023920655211
init E= -128.50049027159
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774688935258553  LUMO = 0.514331400531676
  mo_energy =
[-3.25546813e+01 -1.85121817e+00 -7.74688935e-01 -7.74688935e-01
 -7.74688935e-01  5.14331401e-01  5.14331401e-01  5.14331401e-01
  2.08109673e+00  2.33408519e+00  2.33408519e+00  2.33408519e+00
  7.90767365e+00  7.90767365e+00  7.90767365e+00  1.94669858e+01
  2.69483503e+01  2.69483503e+01  2.69483503e+01  9.39190925e+01
  1.21245601e+02  1.21245601e+02  1.21245601e+02  3.56265722e+02
  1.34963361e+03  5.83607371e+03  3.50986852e+04]
E1 = -182.05339566062233  E_coul = 53.52372027017397
cycle= 1 E= -128.529675390448  delta_E= -0.0292  |g|= 0.208  |ddm|= 0.15
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.531864
diis-c [-0.28287941  1.        ]
  HOMO = -0.884751315635143  LUMO = 0.50080903484405
  mo_energy =
[-3.28840090e+01 -1.96747932e+00 -8.84751316e-01 -8.84751316e-01
 -8.84751316e-01  5.00809035e-01  5.00809035e-01  5.00809035e-01
  2.00155044e+00  2.27360448e+00  2.27360448e+00  2.27360448e+00
  7.76731063e+00  7.76731063e+00  7.76731063e+00  1.92409270e+01
  2.67075612e+01  2.67075612e+01  2.67075612e+01  9.36088601e+01
  1.20915200e+02  1.20915200e+02  1.20915200e+02  3.55907057e+02
  1.34923633e+03  5.83564447e+03  3.50982344e+04]
E1 = -182.83332117840237  E_coul = 54.30095990609779
cycle= 2 E= -128.532361272305  delta_E= -0.00269  |g|= 0.106  |ddm|= 0.0707
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.271579
diis-c [-5.81534034e-04  3.37364192e-01  6.62635808e-01]
  HOMO = -0.84829215807826  LUMO = 0.505352327077752
  mo_energy =
[-3.27737594e+01 -1.92896941e+00 -8.48292158e-01 -8.48292158e-01
 -8.48292158e-01  5.05352327e-01  5.05352327e-01  5.05352327e-01
  2.02763429e+00  2.29340193e+00  2.29340193e+00  2.29340193e+00
  7.81371861e+00  7.81371861e+00  7.81371861e+00  1.93168383e+01
  2.67882922e+01  2.67882922e+01  2.67882922e+01  9.37129808e+01
  1.21025105e+02  1.21025105e+02  1.21025105e+02  3.56024245e+02
  1.34935992e+03  5.83577108e+03  3.50983621e+04]
E1 = -182.56880452878602  E_coul = 54.03548244840086
cycle= 3 E= -128.533322080385  delta_E= -0.000961  |g|= 0.000322  |ddm|= 0.0242
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000691253
diis-c [-9.25053617e-08 -1.77309028e-03 -1.19633041e-03  1.00296942e+00]
  HOMO = -0.848469031097376  LUMO = 0.505345837870544
  mo_energy =
[-3.27740856e+01 -1.92913094e+00 -8.48469031e-01 -8.48469031e-01
 -8.48469031e-01  5.05345838e-01  5.05345838e-01  5.05345838e-01
  2.02754872e+00  2.29333693e+00  2.29333693e+00  2.29333693e+00
  7.81356344e+00  7.81356344e+00  7.81356344e+00  1.93166240e+01
  2.67880504e+01  2.67880504e+01  2.67880504e+01  9.37126777e+01
  1.21024770e+02  1.21024770e+02  1.21024770e+02  3.56023853e+02
  1.34935942e+03  5.83577049e+03  3.50983615e+04]
E1 = -182.56894854088208  E_coul = 54.03562644761967
cycle= 4 E= -128.533322093262  delta_E= -1.29e-08  |g|= 5.99e-05  |ddm|= 0.000184
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000121199
diis-c [-6.89768338e-10  8.09410526e-05  3.55421558e-04 -1.20460897e-01
  1.12002453e+00]
  HOMO = -0.848501433539884  LUMO = 0.505339376779315
  mo_energy =
[-3.27741413e+01 -1.92916720e+00 -8.48501434e-01 -8.48501434e-01
 -8.48501434e-01  5.05339377e-01  5.05339377e-01  5.05339377e-01
  2.02751874e+00  2.29331375e+00  2.29331375e+00  2.29331375e+00
  7.81352326e+00  7.81352326e+00  7.81352326e+00  1.93165739e+01
  2.67879990e+01  2.67879990e+01  2.67879990e+01  9.37126229e+01
  1.21024714e+02  1.21024714e+02  1.21024714e+02  3.56023797e+02
  1.34935936e+03  5.83577044e+03  3.50983614e+04]
E1 = -182.5690324520055  E_coul = 54.03571035828653
cycle= 5 E= -128.533322093719  delta_E= -4.57e-10  |g|= 3.78e-06  |ddm|= 3.93e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5690324520055  E_coul = 54.03571035828653
  HOMO = -0.848500461058138  LUMO = 0.505339343373145
  mo_energy =
[-3.27741378e+01 -1.92916669e+00 -8.48500461e-01 -8.48500461e-01
 -8.48500461e-01  5.05339343e-01  5.05339343e-01  5.05339343e-01
  2.02751884e+00  2.29331398e+00  2.29331398e+00  2.29331398e+00
  7.81352445e+00  7.81352445e+00  7.81352445e+00  1.93165761e+01
  2.67880015e+01  2.67880015e+01  2.67880015e+01  9.37126261e+01
  1.21024718e+02  1.21024718e+02  1.21024718e+02  3.56023801e+02
  1.34935937e+03  5.83577044e+03  3.50983614e+04]
E1 = -182.56901925084773  E_coul = 54.03569715712587
Extra cycle  E= -128.533322093722  delta_E= -2.9e-12  |g|= 1.83e-06  |ddm|= 2.97e-06
    CPU time for scf_cycle      0.16 sec, wall time      0.16 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498602e+02 1.74905982e+02
 2.04945339e+01 5.69620441e+01 4.93600643e-01 7.82721240e+00
 1.65321426e+00 3.96364747e+00 1.24251095e+01 5.47524018e+01
 1.86181269e-01 1.42866362e+00 5.20292785e-01]
E = -128.53332209372186
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.0968186         1
[INPUT] 0    0    [1    /1   ]  617.498602308        1
[INPUT] 0    0    [1    /1   ]  174.905981539        1
[INPUT] 0    0    [1    /1   ]  20.4945339076        1
[INPUT] 0    0    [1    /1   ]  56.962044119         1
[INPUT] 0    0    [1    /1   ]  0.493600642565       1
[INPUT] 0    0    [1    /1   ]  7.82721240239        1
[INPUT] 0    0    [1    /1   ]  1.65321425532        1
[INPUT] 1    0    [1    /1   ]  3.96364746866        1
[INPUT] 1    0    [1    /1   ]  12.4251094842        1
[INPUT] 1    0    [1    /1   ]  54.75240185          1
[INPUT] 1    0    [1    /1   ]  0.186181269323       1
[INPUT] 1    0    [1    /1   ]  1.4286636211         1
[INPUT] 1    0    [1    /1   ]  0.520292785151       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873007046, 1.0]], [0, [2712.0968186032374, 1.0]], [0, [617.4986023081228, 1.0]], [0, [174.9059815388861, 1.0]], [0, [20.49453390762646, 1.0]], [0, [56.962044119008794, 1.0]], [0, [0.4936006425647307, 1.0]], [0, [7.827212402390525, 1.0]], [0, [1.6532142553204534, 1.0]], [1, [3.9636474686567937, 1.0]], [1, [12.425109484224203, 1.0]], [1, [54.75240184995354, 1.0]], [1, [0.18618126932301288, 1.0]], [1, [1.4286636210976362, 1.0]], [1, [0.5202927851508322, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.0968186]
bas 2, expnt(s) = [617.49860231]
bas 3, expnt(s) = [174.90598154]
bas 4, expnt(s) = [20.49453391]
bas 5, expnt(s) = [56.96204412]
bas 6, expnt(s) = [0.49360064]
bas 7, expnt(s) = [7.8272124]
bas 8, expnt(s) = [1.65321426]
bas 9, expnt(s) = [3.96364747]
bas 10, expnt(s) = [12.42510948]
bas 11, expnt(s) = [54.75240185]
bas 12, expnt(s) = [0.18618127]
bas 13, expnt(s) = [1.42866362]
bas 14, expnt(s) = [0.52029279]
CPU time:        42.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498602e+02 3.12962288e+02 1.74905982e+02 1.21511819e+02
 2.04945339e+01 2.43356841e+01 5.69620441e+01 5.23846683e+01
 4.93600643e-01 1.48780773e+00 7.82721240e+00 1.18228006e+01
 1.65321426e+00 3.68351023e+00 3.96364747e+00 1.63156045e+01
 1.24251095e+01 6.80549427e+01 5.47524018e+01 4.34498580e+02
 1.86181269e-01 3.56783183e-01 1.42866362e+00 4.55666263e+00
 5.20292785e-01 1.28912238e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999465284930373
cond(S) = 240.02107740995694
E1 = -183.58072947814247  E_coul = 55.08023920655211
init E= -128.50049027159
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774688935258553  LUMO = 0.514331400531676
  mo_energy =
[-3.25546813e+01 -1.85121817e+00 -7.74688935e-01 -7.74688935e-01
 -7.74688935e-01  5.14331401e-01  5.14331401e-01  5.14331401e-01
  2.08109673e+00  2.33408519e+00  2.33408519e+00  2.33408519e+00
  7.90767365e+00  7.90767365e+00  7.90767365e+00  1.94669858e+01
  2.69483503e+01  2.69483503e+01  2.69483503e+01  9.39190925e+01
  1.21245601e+02  1.21245601e+02  1.21245601e+02  3.56265722e+02
  1.34963361e+03  5.83607371e+03  3.50986852e+04]
E1 = -182.05339566062233  E_coul = 53.52372027017397
cycle= 1 E= -128.529675390448  delta_E= -0.0292  |g|= 0.208  |ddm|= 0.15
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.531864
diis-c [-0.28287941  1.        ]
  HOMO = -0.884751315635143  LUMO = 0.50080903484405
  mo_energy =
[-3.28840090e+01 -1.96747932e+00 -8.84751316e-01 -8.84751316e-01
 -8.84751316e-01  5.00809035e-01  5.00809035e-01  5.00809035e-01
  2.00155044e+00  2.27360448e+00  2.27360448e+00  2.27360448e+00
  7.76731063e+00  7.76731063e+00  7.76731063e+00  1.92409270e+01
  2.67075612e+01  2.67075612e+01  2.67075612e+01  9.36088601e+01
  1.20915200e+02  1.20915200e+02  1.20915200e+02  3.55907057e+02
  1.34923633e+03  5.83564447e+03  3.50982344e+04]
E1 = -182.83332117840237  E_coul = 54.30095990609779
cycle= 2 E= -128.532361272305  delta_E= -0.00269  |g|= 0.106  |ddm|= 0.0707
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.271579
diis-c [-5.81534034e-04  3.37364192e-01  6.62635808e-01]
  HOMO = -0.84829215807826  LUMO = 0.505352327077752
  mo_energy =
[-3.27737594e+01 -1.92896941e+00 -8.48292158e-01 -8.48292158e-01
 -8.48292158e-01  5.05352327e-01  5.05352327e-01  5.05352327e-01
  2.02763429e+00  2.29340193e+00  2.29340193e+00  2.29340193e+00
  7.81371861e+00  7.81371861e+00  7.81371861e+00  1.93168383e+01
  2.67882922e+01  2.67882922e+01  2.67882922e+01  9.37129808e+01
  1.21025105e+02  1.21025105e+02  1.21025105e+02  3.56024245e+02
  1.34935992e+03  5.83577108e+03  3.50983621e+04]
E1 = -182.56880452878602  E_coul = 54.03548244840086
cycle= 3 E= -128.533322080385  delta_E= -0.000961  |g|= 0.000322  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691253
diis-c [-9.25053617e-08 -1.77309028e-03 -1.19633041e-03  1.00296942e+00]
  HOMO = -0.848469031097376  LUMO = 0.505345837870544
  mo_energy =
[-3.27740856e+01 -1.92913094e+00 -8.48469031e-01 -8.48469031e-01
 -8.48469031e-01  5.05345838e-01  5.05345838e-01  5.05345838e-01
  2.02754872e+00  2.29333693e+00  2.29333693e+00  2.29333693e+00
  7.81356344e+00  7.81356344e+00  7.81356344e+00  1.93166240e+01
  2.67880504e+01  2.67880504e+01  2.67880504e+01  9.37126777e+01
  1.21024770e+02  1.21024770e+02  1.21024770e+02  3.56023853e+02
  1.34935942e+03  5.83577049e+03  3.50983615e+04]
E1 = -182.56894854088208  E_coul = 54.03562644761967
cycle= 4 E= -128.533322093262  delta_E= -1.29e-08  |g|= 5.99e-05  |ddm|= 0.000184
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000121199
diis-c [-6.89768338e-10  8.09410526e-05  3.55421558e-04 -1.20460897e-01
  1.12002453e+00]
  HOMO = -0.848501433539884  LUMO = 0.505339376779315
  mo_energy =
[-3.27741413e+01 -1.92916720e+00 -8.48501434e-01 -8.48501434e-01
 -8.48501434e-01  5.05339377e-01  5.05339377e-01  5.05339377e-01
  2.02751874e+00  2.29331375e+00  2.29331375e+00  2.29331375e+00
  7.81352326e+00  7.81352326e+00  7.81352326e+00  1.93165739e+01
  2.67879990e+01  2.67879990e+01  2.67879990e+01  9.37126229e+01
  1.21024714e+02  1.21024714e+02  1.21024714e+02  3.56023797e+02
  1.34935936e+03  5.83577044e+03  3.50983614e+04]
E1 = -182.5690324520055  E_coul = 54.03571035828653
cycle= 5 E= -128.533322093719  delta_E= -4.57e-10  |g|= 3.78e-06  |ddm|= 3.93e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5690324520055  E_coul = 54.03571035828653
  HOMO = -0.848500461058138  LUMO = 0.505339343373145
  mo_energy =
[-3.27741378e+01 -1.92916669e+00 -8.48500461e-01 -8.48500461e-01
 -8.48500461e-01  5.05339343e-01  5.05339343e-01  5.05339343e-01
  2.02751884e+00  2.29331398e+00  2.29331398e+00  2.29331398e+00
  7.81352445e+00  7.81352445e+00  7.81352445e+00  1.93165761e+01
  2.67880015e+01  2.67880015e+01  2.67880015e+01  9.37126261e+01
  1.21024718e+02  1.21024718e+02  1.21024718e+02  3.56023801e+02
  1.34935937e+03  5.83577044e+03  3.50983614e+04]
E1 = -182.56901925084773  E_coul = 54.03569715712587
Extra cycle  E= -128.533322093722  delta_E= -2.9e-12  |g|= 1.83e-06  |ddm|= 2.97e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.02107740995694
E1 = -182.56901925084773  E_coul = 54.03569715712587
init E= -128.533322093722
    CPU time for initialize scf      0.30 sec, wall time      0.29 sec
  HOMO = -0.848501415565379  LUMO = 0.505339193932555
  mo_energy =
[-3.27741404e+01 -1.92916783e+00 -8.48501416e-01 -8.48501416e-01
 -8.48501416e-01  5.05339194e-01  5.05339194e-01  5.05339194e-01
  2.02751801e+00  2.29331340e+00  2.29331340e+00  2.29331340e+00
  7.81352323e+00  7.81352323e+00  7.81352323e+00  1.93165742e+01
  2.67879995e+01  2.67879995e+01  2.67879995e+01  9.37126237e+01
  1.21024715e+02  1.21024715e+02  1.21024715e+02  3.56023798e+02
  1.34935936e+03  5.83577044e+03  3.50983614e+04]
E1 = -182.56902478607972  E_coul = 54.0357026923575
cycle= 1 E= -128.533322093722  delta_E= -3.69e-13  |g|= 7.73e-07  |ddm|= 8.91e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.56902478607972  E_coul = 54.0357026923575
  HOMO = -0.848501027676324  LUMO = 0.505339236577516
  mo_energy =
[-3.27741392e+01 -1.92916745e+00 -8.48501028e-01 -8.48501028e-01
 -8.48501028e-01  5.05339237e-01  5.05339237e-01  5.05339237e-01
  2.02751825e+00  2.29331360e+00  2.29331360e+00  2.29331360e+00
  7.81352372e+00  7.81352372e+00  7.81352372e+00  1.93165750e+01
  2.67880004e+01  2.67880004e+01  2.67880004e+01  9.37126248e+01
  1.21024716e+02  1.21024716e+02  1.21024716e+02  3.56023799e+02
  1.34935936e+03  5.83577044e+03  3.50983614e+04]
E1 = -182.56902168423017  E_coul = 54.03569959050781
Extra cycle  E= -128.533322093722  delta_E= -1.14e-13  |g|= 4.19e-07  |ddm|= 2.66e-07
    CPU time for scf_cycle      0.37 sec, wall time      0.37 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498602e+02 1.74905982e+02
 2.04945339e+01 5.69620441e+01 4.93600643e-01 7.82721240e+00
 1.65321426e+00 3.96364747e+00 1.24251095e+01 5.47524018e+01
 1.86181269e-01 1.42866362e+00 5.20292785e-01]
grad_E = [-7.29768679e-11  4.22374982e-09 -8.61294184e-08  1.21065111e-06
  4.63992461e-05 -9.28066154e-06  1.29844444e-02 -8.13292362e-05
 -3.48964501e-03 -1.13051381e-03 -1.28495245e-03  8.42180154e-05
 -3.94800272e-04  9.95762327e-04 -2.72371122e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681857        1
[INPUT] 0    0    [1    /1   ]  617.49860309         1
[INPUT] 0    0    [1    /1   ]  174.905969818        1
[INPUT] 0    0    [1    /1   ]  20.4944077712        1
[INPUT] 0    0    [1    /1   ]  56.9621405047        1
[INPUT] 0    0    [1    /1   ]  0.489664219582       1
[INPUT] 0    0    [1    /1   ]  7.82713988869        1
[INPUT] 0    0    [1    /1   ]  1.65385902425        1
[INPUT] 1    0    [1    /1   ]  4.03613600367        1
[INPUT] 1    0    [1    /1   ]  12.4314378079        1
[INPUT] 1    0    [1    /1   ]  54.7517161414        1
[INPUT] 1    0    [1    /1   ]  0.201930104476       1
[INPUT] 1    0    [1    /1   ]  1.4956539318         1
[INPUT] 1    0    [1    /1   ]  0.559176975592       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873007095, 1.0]], [0, [2712.0968185711267, 1.0]], [0, [617.4986030899655, 1.0]], [0, [174.90596981810552, 1.0]], [0, [20.494407771249655, 1.0]], [0, [56.96214050474643, 1.0]], [0, [0.4896642195823106, 1.0]], [0, [7.827139888692188, 1.0]], [0, [1.6538590242456641, 1.0]], [1, [4.036136003666582, 1.0]], [1, [12.431437807870662, 1.0]], [1, [54.751716141355914, 1.0]], [1, [0.20193010447594734, 1.0]], [1, [1.4956539318037967, 1.0]], [1, [0.5591769755919561, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681857]
bas 2, expnt(s) = [617.49860309]
bas 3, expnt(s) = [174.90596982]
bas 4, expnt(s) = [20.49440777]
bas 5, expnt(s) = [56.9621405]
bas 6, expnt(s) = [0.48966422]
bas 7, expnt(s) = [7.82713989]
bas 8, expnt(s) = [1.65385902]
bas 9, expnt(s) = [4.036136]
bas 10, expnt(s) = [12.43143781]
bas 11, expnt(s) = [54.75171614]
bas 12, expnt(s) = [0.2019301]
bas 13, expnt(s) = [1.49565393]
bas 14, expnt(s) = [0.55917698]
CPU time:        45.77
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498603e+02 3.12962288e+02 1.74905970e+02 1.21511812e+02
 2.04944078e+01 2.43355717e+01 5.69621405e+01 5.23847348e+01
 4.89664220e-01 1.47889998e+00 7.82713989e+00 1.18227184e+01
 1.65385902e+00 3.68458763e+00 4.03613600e+00 1.66894349e+01
 1.24314378e+01 6.80982724e+01 5.47517161e+01 4.34491778e+02
 2.01930104e-01 3.94898724e-01 1.49565393e+00 4.82528855e+00
 5.59176976e-01 1.41065559e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999464903995
cond(S) = 239.7853188528492
E1 = -183.58134441384246  E_coul = 55.080615928798345
init E= -128.500728485044
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774681792619164  LUMO = 0.563551765721548
  mo_energy =
[-3.25545837e+01 -1.85122129e+00 -7.74681793e-01 -7.74681793e-01
 -7.74681793e-01  5.63551766e-01  5.63551766e-01  5.63551766e-01
  2.06833762e+00  2.51760218e+00  2.51760218e+00  2.51760218e+00
  8.32289152e+00  8.32289152e+00  8.32289152e+00  1.94516198e+01
  2.75668301e+01  2.75668301e+01  2.75668301e+01  9.39059242e+01
  1.21794238e+02  1.21794238e+02  1.21794238e+02  3.56254232e+02
  1.34962352e+03  5.83606493e+03  3.50986780e+04]
E1 = -182.05143117546052  E_coul = 53.52164899866554
cycle= 1 E= -128.529782176795  delta_E= -0.0291  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.537752
diis-c [-0.28917708  1.        ]
  HOMO = -0.885004595002499  LUMO = 0.548144832710292
  mo_energy =
[-3.28842737e+01 -1.96755209e+00 -8.85004595e-01 -8.85004595e-01
 -8.85004595e-01  5.48144833e-01  5.48144833e-01  5.48144833e-01
  1.98897806e+00  2.45360426e+00  2.45360426e+00  2.45360426e+00
  8.18040871e+00  8.18040871e+00  8.18040871e+00  1.92251243e+01
  2.73259494e+01  2.73259494e+01  2.73259494e+01  9.35953255e+01
  1.21463686e+02  1.21463686e+02  1.21463686e+02  3.55895175e+02
  1.34922583e+03  5.83563526e+03  3.50982267e+04]
E1 = -182.83229508404943  E_coul = 54.29981804451491
cycle= 2 E= -128.532477039535  delta_E= -0.00269  |g|= 0.106  |ddm|= 0.0702
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274325
diis-c [-5.81028390e-04  3.37164913e-01  6.62835087e-01]
  HOMO = -0.848494001294011  LUMO = 0.553307902720161
  mo_energy =
[-3.27738449e+01 -1.92898838e+00 -8.48494001e-01 -8.48494001e-01
 -8.48494001e-01  5.53307903e-01  5.53307903e-01  5.53307903e-01
  2.01502870e+00  2.47454156e+00  2.47454156e+00  2.47454156e+00
  8.22751993e+00  8.22751993e+00  8.22751993e+00  1.93011627e+01
  2.74067265e+01  2.74067265e+01  2.74067265e+01  9.36996171e+01
  1.21573698e+02  1.21573698e+02  1.21573698e+02  3.56012550e+02
  1.34934961e+03  5.83576206e+03  3.50983547e+04]
E1 = -182.5675607957355  E_coul = 54.03412058122085
cycle= 3 E= -128.533440214515  delta_E= -0.000963  |g|= 0.000327  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000773911
diis-c [-8.52049625e-08 -1.76291707e-03 -8.46045970e-04  1.00260896e+00]
  HOMO = -0.848670905836832  LUMO = 0.553301713652913
  mo_energy =
[-3.27741730e+01 -1.92913350e+00 -8.48670906e-01 -8.48670906e-01
 -8.48670906e-01  5.53301714e-01  5.53301714e-01  5.53301714e-01
  2.01495740e+00  2.47447528e+00  2.47447528e+00  2.47447528e+00
  8.22736569e+00  8.22736569e+00  8.22736569e+00  1.93009526e+01
  2.74064872e+01  2.74064872e+01  2.74064872e+01  9.36993128e+01
  1.21573360e+02  1.21573360e+02  1.21573360e+02  3.56012149e+02
  1.34934909e+03  5.83576146e+03  3.50983540e+04]
E1 = -182.56775826855832  E_coul = 54.03431804290672
cycle= 4 E= -128.533440225652  delta_E= -1.11e-08  |g|= 6.22e-05  |ddm|= 0.000159
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000148439
diis-c [-4.84438932e-10  7.06282746e-05  4.29618096e-04 -1.12646523e-01
  1.11214628e+00]
  HOMO = -0.848703841457688  LUMO = 0.553294908717798
  mo_energy =
[-3.27742331e+01 -1.92916654e+00 -8.48703841e-01 -8.48703841e-01
 -8.48703841e-01  5.53294909e-01  5.53294909e-01  5.53294909e-01
  2.01493060e+00  2.47445178e+00  2.47445178e+00  2.47445178e+00
  8.22732497e+00  8.22732497e+00  8.22732497e+00  1.93009017e+01
  2.74064339e+01  2.74064339e+01  2.74064339e+01  9.36992543e+01
  1.21573300e+02  1.21573300e+02  1.21573300e+02  3.56012087e+02
  1.34934903e+03  5.83576139e+03  3.50983539e+04]
E1 = -182.56786505904466  E_coul = 54.03442483299391
cycle= 5 E= -128.533440226051  delta_E= -3.99e-10  |g|= 2.28e-06  |ddm|= 3.03e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56786505904466  E_coul = 54.03442483299391
  HOMO = -0.848703398919032  LUMO = 0.55329485493791
  mo_energy =
[-3.27742313e+01 -1.92916618e+00 -8.48703399e-01 -8.48703399e-01
 -8.48703399e-01  5.53294855e-01  5.53294855e-01  5.53294855e-01
  2.01493069e+00  2.47445183e+00  2.47445183e+00  2.47445183e+00
  8.22732555e+00  8.22732555e+00  8.22732555e+00  1.93009030e+01
  2.74064352e+01  2.74064352e+01  2.74064352e+01  9.36992559e+01
  1.21573302e+02  1.21573302e+02  1.21573302e+02  3.56012089e+02
  1.34934903e+03  5.83576139e+03  3.50983539e+04]
E1 = -182.5678573612328  E_coul = 54.03441713518076
Extra cycle  E= -128.533440226052  delta_E= -1.31e-12  |g|= 1.03e-06  |ddm|= 2.03e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498603e+02 1.74905970e+02
 2.04944078e+01 5.69621405e+01 4.89664220e-01 7.82713989e+00
 1.65385902e+00 4.03613600e+00 1.24314378e+01 5.47517161e+01
 2.01930104e-01 1.49565393e+00 5.59176976e-01]
E = -128.53344022605205
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681857        1
[INPUT] 0    0    [1    /1   ]  617.49860309         1
[INPUT] 0    0    [1    /1   ]  174.905969818        1
[INPUT] 0    0    [1    /1   ]  20.4944077712        1
[INPUT] 0    0    [1    /1   ]  56.9621405047        1
[INPUT] 0    0    [1    /1   ]  0.489664219582       1
[INPUT] 0    0    [1    /1   ]  7.82713988869        1
[INPUT] 0    0    [1    /1   ]  1.65385902425        1
[INPUT] 1    0    [1    /1   ]  4.03613600367        1
[INPUT] 1    0    [1    /1   ]  12.4314378079        1
[INPUT] 1    0    [1    /1   ]  54.7517161414        1
[INPUT] 1    0    [1    /1   ]  0.201930104476       1
[INPUT] 1    0    [1    /1   ]  1.4956539318         1
[INPUT] 1    0    [1    /1   ]  0.559176975592       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873007095, 1.0]], [0, [2712.0968185711267, 1.0]], [0, [617.4986030899655, 1.0]], [0, [174.90596981810552, 1.0]], [0, [20.494407771249655, 1.0]], [0, [56.96214050474643, 1.0]], [0, [0.4896642195823106, 1.0]], [0, [7.827139888692188, 1.0]], [0, [1.6538590242456641, 1.0]], [1, [4.036136003666582, 1.0]], [1, [12.431437807870662, 1.0]], [1, [54.751716141355914, 1.0]], [1, [0.20193010447594734, 1.0]], [1, [1.4956539318037967, 1.0]], [1, [0.5591769755919561, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681857]
bas 2, expnt(s) = [617.49860309]
bas 3, expnt(s) = [174.90596982]
bas 4, expnt(s) = [20.49440777]
bas 5, expnt(s) = [56.9621405]
bas 6, expnt(s) = [0.48966422]
bas 7, expnt(s) = [7.82713989]
bas 8, expnt(s) = [1.65385902]
bas 9, expnt(s) = [4.036136]
bas 10, expnt(s) = [12.43143781]
bas 11, expnt(s) = [54.75171614]
bas 12, expnt(s) = [0.2019301]
bas 13, expnt(s) = [1.49565393]
bas 14, expnt(s) = [0.55917698]
CPU time:        46.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498603e+02 3.12962288e+02 1.74905970e+02 1.21511812e+02
 2.04944078e+01 2.43355717e+01 5.69621405e+01 5.23847348e+01
 4.89664220e-01 1.47889998e+00 7.82713989e+00 1.18227184e+01
 1.65385902e+00 3.68458763e+00 4.03613600e+00 1.66894349e+01
 1.24314378e+01 6.80982724e+01 5.47517161e+01 4.34491778e+02
 2.01930104e-01 3.94898724e-01 1.49565393e+00 4.82528855e+00
 5.59176976e-01 1.41065559e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999464903995
cond(S) = 239.7853188528492
E1 = -183.58134441384246  E_coul = 55.080615928798345
init E= -128.500728485044
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774681792619164  LUMO = 0.563551765721548
  mo_energy =
[-3.25545837e+01 -1.85122129e+00 -7.74681793e-01 -7.74681793e-01
 -7.74681793e-01  5.63551766e-01  5.63551766e-01  5.63551766e-01
  2.06833762e+00  2.51760218e+00  2.51760218e+00  2.51760218e+00
  8.32289152e+00  8.32289152e+00  8.32289152e+00  1.94516198e+01
  2.75668301e+01  2.75668301e+01  2.75668301e+01  9.39059242e+01
  1.21794238e+02  1.21794238e+02  1.21794238e+02  3.56254232e+02
  1.34962352e+03  5.83606493e+03  3.50986780e+04]
E1 = -182.05143117546052  E_coul = 53.52164899866554
cycle= 1 E= -128.529782176795  delta_E= -0.0291  |g|= 0.208  |ddm|= 0.152
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.537752
diis-c [-0.28917708  1.        ]
  HOMO = -0.885004595002499  LUMO = 0.548144832710292
  mo_energy =
[-3.28842737e+01 -1.96755209e+00 -8.85004595e-01 -8.85004595e-01
 -8.85004595e-01  5.48144833e-01  5.48144833e-01  5.48144833e-01
  1.98897806e+00  2.45360426e+00  2.45360426e+00  2.45360426e+00
  8.18040871e+00  8.18040871e+00  8.18040871e+00  1.92251243e+01
  2.73259494e+01  2.73259494e+01  2.73259494e+01  9.35953255e+01
  1.21463686e+02  1.21463686e+02  1.21463686e+02  3.55895175e+02
  1.34922583e+03  5.83563526e+03  3.50982267e+04]
E1 = -182.83229508404943  E_coul = 54.29981804451491
cycle= 2 E= -128.532477039535  delta_E= -0.00269  |g|= 0.106  |ddm|= 0.0702
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.274325
diis-c [-5.81028390e-04  3.37164913e-01  6.62835087e-01]
  HOMO = -0.848494001294011  LUMO = 0.553307902720161
  mo_energy =
[-3.27738449e+01 -1.92898838e+00 -8.48494001e-01 -8.48494001e-01
 -8.48494001e-01  5.53307903e-01  5.53307903e-01  5.53307903e-01
  2.01502870e+00  2.47454156e+00  2.47454156e+00  2.47454156e+00
  8.22751993e+00  8.22751993e+00  8.22751993e+00  1.93011627e+01
  2.74067265e+01  2.74067265e+01  2.74067265e+01  9.36996171e+01
  1.21573698e+02  1.21573698e+02  1.21573698e+02  3.56012550e+02
  1.34934961e+03  5.83576206e+03  3.50983547e+04]
E1 = -182.5675607957355  E_coul = 54.03412058122085
cycle= 3 E= -128.533440214515  delta_E= -0.000963  |g|= 0.000327  |ddm|= 0.0242
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000773911
diis-c [-8.52049625e-08 -1.76291707e-03 -8.46045970e-04  1.00260896e+00]
  HOMO = -0.848670905836832  LUMO = 0.553301713652913
  mo_energy =
[-3.27741730e+01 -1.92913350e+00 -8.48670906e-01 -8.48670906e-01
 -8.48670906e-01  5.53301714e-01  5.53301714e-01  5.53301714e-01
  2.01495740e+00  2.47447528e+00  2.47447528e+00  2.47447528e+00
  8.22736569e+00  8.22736569e+00  8.22736569e+00  1.93009526e+01
  2.74064872e+01  2.74064872e+01  2.74064872e+01  9.36993128e+01
  1.21573360e+02  1.21573360e+02  1.21573360e+02  3.56012149e+02
  1.34934909e+03  5.83576146e+03  3.50983540e+04]
E1 = -182.56775826855832  E_coul = 54.03431804290672
cycle= 4 E= -128.533440225652  delta_E= -1.11e-08  |g|= 6.22e-05  |ddm|= 0.000159
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000148439
diis-c [-4.84438932e-10  7.06282746e-05  4.29618096e-04 -1.12646523e-01
  1.11214628e+00]
  HOMO = -0.848703841457688  LUMO = 0.553294908717798
  mo_energy =
[-3.27742331e+01 -1.92916654e+00 -8.48703841e-01 -8.48703841e-01
 -8.48703841e-01  5.53294909e-01  5.53294909e-01  5.53294909e-01
  2.01493060e+00  2.47445178e+00  2.47445178e+00  2.47445178e+00
  8.22732497e+00  8.22732497e+00  8.22732497e+00  1.93009017e+01
  2.74064339e+01  2.74064339e+01  2.74064339e+01  9.36992543e+01
  1.21573300e+02  1.21573300e+02  1.21573300e+02  3.56012087e+02
  1.34934903e+03  5.83576139e+03  3.50983539e+04]
E1 = -182.56786505904466  E_coul = 54.03442483299391
cycle= 5 E= -128.533440226051  delta_E= -3.99e-10  |g|= 2.28e-06  |ddm|= 3.03e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.56786505904466  E_coul = 54.03442483299391
  HOMO = -0.848703398919032  LUMO = 0.55329485493791
  mo_energy =
[-3.27742313e+01 -1.92916618e+00 -8.48703399e-01 -8.48703399e-01
 -8.48703399e-01  5.53294855e-01  5.53294855e-01  5.53294855e-01
  2.01493069e+00  2.47445183e+00  2.47445183e+00  2.47445183e+00
  8.22732555e+00  8.22732555e+00  8.22732555e+00  1.93009030e+01
  2.74064352e+01  2.74064352e+01  2.74064352e+01  9.36992559e+01
  1.21573302e+02  1.21573302e+02  1.21573302e+02  3.56012089e+02
  1.34934903e+03  5.83576139e+03  3.50983539e+04]
E1 = -182.5678573612328  E_coul = 54.03441713518076
Extra cycle  E= -128.533440226052  delta_E= -1.31e-12  |g|= 1.03e-06  |ddm|= 2.03e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.7853188528492
E1 = -182.5678573612328  E_coul = 54.03441713518076
init E= -128.533440226052
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.848703967968245  LUMO = 0.553294752901967
  mo_energy =
[-3.27742328e+01 -1.92916682e+00 -8.48703968e-01 -8.48703968e-01
 -8.48703968e-01  5.53294753e-01  5.53294753e-01  5.53294753e-01
  2.01493022e+00  2.47445146e+00  2.47445146e+00  2.47445146e+00
  8.22732482e+00  8.22732482e+00  8.22732482e+00  1.93009019e+01
  2.74064340e+01  2.74064340e+01  2.74064340e+01  9.36992545e+01
  1.21573301e+02  1.21573301e+02  1.21573301e+02  3.56012087e+02
  1.34934903e+03  5.83576139e+03  3.50983539e+04]
E1 = -182.5678605188232  E_coul = 54.034420292771316
cycle= 1 E= -128.533440226052  delta_E= 1.71e-13  |g|= 4.43e-07  |ddm|= 4.78e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5678605188232  E_coul = 54.034420292771316
  HOMO = -0.848703748579601  LUMO = 0.553294780210251
  mo_energy =
[-3.27742321e+01 -1.92916660e+00 -8.48703749e-01 -8.48703749e-01
 -8.48703749e-01  5.53294780e-01  5.53294780e-01  5.53294780e-01
  2.01493036e+00  2.47445158e+00  2.47445158e+00  2.47445158e+00
  8.22732510e+00  8.22732510e+00  8.22732510e+00  1.93009023e+01
  2.74064345e+01  2.74064345e+01  2.74064345e+01  9.36992551e+01
  1.21573301e+02  1.21573301e+02  1.21573301e+02  3.56012088e+02
  1.34934903e+03  5.83576139e+03  3.50983539e+04]
E1 = -182.56785874567703  E_coul = 54.03441851962537
Extra cycle  E= -128.533440226052  delta_E= 2.27e-13  |g|= 2.39e-07  |ddm|= 1.6e-07
    CPU time for scf_cycle      0.37 sec, wall time      0.36 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498603e+02 1.74905970e+02
 2.04944078e+01 5.69621405e+01 4.89664220e-01 7.82713989e+00
 1.65385902e+00 4.03613600e+00 1.24314378e+01 5.47517161e+01
 2.01930104e-01 1.49565393e+00 5.59176976e-01]
grad_E = [-3.11675639e-11  1.93809733e-09 -4.29646543e-08  6.49090372e-07
  1.87590467e-05 -5.28360097e-06  4.45700222e-03 -2.55337270e-05
 -1.21709344e-03 -6.06228302e-04 -1.57400752e-03  1.02024679e-04
  1.50858050e-03  9.83741038e-04 -1.74126190e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681856        1
[INPUT] 0    0    [1    /1   ]  617.498603385        1
[INPUT] 0    0    [1    /1   ]  174.90596535         1
[INPUT] 0    0    [1    /1   ]  20.4943572583        1
[INPUT] 0    0    [1    /1   ]  56.9621774376        1
[INPUT] 0    0    [1    /1   ]  0.487624163932       1
[INPUT] 0    0    [1    /1   ]  7.82711604943        1
[INPUT] 0    0    [1    /1   ]  1.65430754236        1
[INPUT] 1    0    [1    /1   ]  4.06205660261        1
[INPUT] 1    0    [1    /1   ]  12.435105791         1
[INPUT] 1    0    [1    /1   ]  54.7513806042        1
[INPUT] 1    0    [1    /1   ]  0.205537974645       1
[INPUT] 1    0    [1    /1   ]  1.51865268795        1
[INPUT] 1    0    [1    /1   ]  0.572229727754       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730071132, 1.0]], [0, [2712.0968185590323, 1.0]], [0, [617.4986033854256, 1.0]], [0, [174.90596535007245, 1.0]], [0, [20.494357258315464, 1.0]], [0, [56.96217743756859, 1.0]], [0, [0.48762416393222097, 1.0]], [0, [7.827116049433707, 1.0]], [0, [1.65430754236046, 1.0]], [1, [4.062056602610382, 1.0]], [1, [12.435105791004425, 1.0]], [1, [54.75138060421348, 1.0]], [1, [0.20553797464466028, 1.0]], [1, [1.5186526879450928, 1.0]], [1, [0.572229727754294, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681856]
bas 2, expnt(s) = [617.49860339]
bas 3, expnt(s) = [174.90596535]
bas 4, expnt(s) = [20.49435726]
bas 5, expnt(s) = [56.96217744]
bas 6, expnt(s) = [0.48762416]
bas 7, expnt(s) = [7.82711605]
bas 8, expnt(s) = [1.65430754]
bas 9, expnt(s) = [4.0620566]
bas 10, expnt(s) = [12.43510579]
bas 11, expnt(s) = [54.7513806]
bas 12, expnt(s) = [0.20553797]
bas 13, expnt(s) = [1.51865269]
bas 14, expnt(s) = [0.57222973]
CPU time:        49.10
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498603e+02 3.12962289e+02 1.74905965e+02 1.21511810e+02
 2.04943573e+01 2.43355268e+01 5.69621774e+01 5.23847603e+01
 4.87624164e-01 1.47427648e+00 7.82711605e+00 1.18226914e+01
 1.65430754e+00 3.68533704e+00 4.06205660e+00 1.68235195e+01
 1.24351058e+01 6.81233895e+01 5.47513806e+01 4.34488450e+02
 2.05537975e-01 4.03737866e-01 1.51865269e+00 4.91821456e+00
 5.72229728e-01 1.45193580e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999461723802701
cond(S) = 239.66958613330175
E1 = -183.5815424957276  E_coul = 55.080785443481936
init E= -128.500757052246
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774676243447509  LUMO = 0.576250185970345
  mo_energy =
[-3.25545347e+01 -1.85121847e+00 -7.74676243e-01 -7.74676243e-01
 -7.74676243e-01  5.76250186e-01  5.76250186e-01  5.76250186e-01
  2.06180593e+00  2.57299529e+00  2.57299529e+00  2.57299529e+00
  8.45830825e+00  8.45830825e+00  8.45830825e+00  1.94441471e+01
  2.77776884e+01  2.77776884e+01  2.77776884e+01  9.38996430e+01
  1.21987523e+02  1.21987523e+02  1.21987523e+02  3.56248774e+02
  1.34961873e+03  5.83606076e+03  3.50986746e+04]
E1 = -182.04918306741965  E_coul = 53.519396513508326
cycle= 1 E= -128.529786553911  delta_E= -0.029  |g|= 0.208  |ddm|= 0.154
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.539577
diis-c [-0.29114355  1.        ]
  HOMO = -0.885228870079692  LUMO = 0.560278486926049
  mo_energy =
[-3.28845966e+01 -1.96769299e+00 -8.85228870e-01 -8.85228870e-01
 -8.85228870e-01  5.60278487e-01  5.60278487e-01  5.60278487e-01
  1.98245638e+00  2.50774804e+00  2.50774804e+00  2.50774804e+00
  8.31489797e+00  8.31489797e+00  8.31489797e+00  1.92172600e+01
  2.75365166e+01  2.75365166e+01  2.75365166e+01  9.35886732e+01
  1.21656673e+02  1.21656673e+02  1.21656673e+02  3.55889329e+02
  1.34922064e+03  5.83563069e+03  3.50982229e+04]
E1 = -182.8312163795404  E_coul = 54.298727466105774
cycle= 2 E= -128.532488913435  delta_E= -0.0027  |g|= 0.106  |ddm|= 0.0701
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.275213
diis-c [-5.81427557e-04  3.37133918e-01  6.62866082e-01]
  HOMO = -0.848662238183032  LUMO = 0.565622323871404
  mo_energy =
[-3.27739967e+01 -1.92906943e+00 -8.48662238e-01 -8.48662238e-01
 -8.48662238e-01  5.65622324e-01  5.65622324e-01  5.65622324e-01
  2.00851338e+00  2.52908198e+00  2.52908198e+00  2.52908198e+00
  8.36231328e+00  8.36231328e+00  8.36231328e+00  1.92934215e+01
  2.76174053e+01  2.76174053e+01  2.76174053e+01  9.36931277e+01
  1.21766831e+02  1.21766831e+02  1.21766831e+02  3.56006883e+02
  1.34934460e+03  5.83575767e+03  3.50983510e+04]
E1 = -182.56603380051732  E_coul = 54.03257860129748
cycle= 3 E= -128.53345519922  delta_E= -0.000966  |g|= 0.000341  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000826193
diis-c [-9.10461292e-08 -1.77862482e-03 -6.93148926e-04  1.00247177e+00]
  HOMO = -0.84884334607671  LUMO = 0.565615121580564
  mo_energy =
[-3.27743317e+01 -1.92921122e+00 -8.48843346e-01 -8.48843346e-01
 -8.48843346e-01  5.65615122e-01  5.65615122e-01  5.65615122e-01
  2.00844492e+00  2.52901219e+00  2.52901219e+00  2.52901219e+00
  8.36215482e+00  8.36215482e+00  8.36215482e+00  1.92932078e+01
  2.76171614e+01  2.76171614e+01  2.76171614e+01  9.36928168e+01
  1.21766486e+02  1.21766486e+02  1.21766486e+02  3.56006473e+02
  1.34934407e+03  5.83575705e+03  3.50983503e+04]
E1 = -182.56625429218496  E_coul = 54.03279908104002
cycle= 4 E= -128.533455211145  delta_E= -1.19e-08  |g|= 6.57e-05  |ddm|= 0.000162
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000163602
diis-c [-4.90930835e-10  8.08337606e-05  4.73472111e-04 -1.19243303e-01
  1.11868900e+00]
  HOMO = -0.848877748414555  LUMO = 0.565607938631928
  mo_energy =
[-3.27743955e+01 -1.92924411e+00 -8.48877748e-01 -8.48877748e-01
 -8.48877748e-01  5.65607939e-01  5.65607939e-01  5.65607939e-01
  2.00841841e+00  2.52898762e+00  2.52898762e+00  2.52898762e+00
  8.36211238e+00  8.36211238e+00  8.36211238e+00  1.92931549e+01
  2.76171055e+01  2.76171055e+01  2.76171055e+01  9.36927548e+01
  1.21766422e+02  1.21766422e+02  1.21766422e+02  3.56006406e+02
  1.34934400e+03  5.83575697e+03  3.50983503e+04]
E1 = -182.56637219498322  E_coul = 54.03291698340522
cycle= 5 E= -128.533455211578  delta_E= -4.33e-10  |g|= 2.05e-06  |ddm|= 2.93e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56637219498322  E_coul = 54.03291698340522
  HOMO = -0.848877252214874  LUMO = 0.565607919673732
  mo_energy =
[-3.27743938e+01 -1.92924354e+00 -8.48877252e-01 -8.48877252e-01
 -8.48877252e-01  5.65607920e-01  5.65607920e-01  5.65607920e-01
  2.00841869e+00  2.52898777e+00  2.52898777e+00  2.52898777e+00
  8.36211304e+00  8.36211304e+00  8.36211304e+00  1.92931562e+01
  2.76171069e+01  2.76171069e+01  2.76171069e+01  9.36927564e+01
  1.21766424e+02  1.21766424e+02  1.21766424e+02  3.56006407e+02
  1.34934400e+03  5.83575698e+03  3.50983503e+04]
E1 = -182.56636530380004  E_coul = 54.032910092221535
Extra cycle  E= -128.533455211579  delta_E= -5.12e-13  |g|= 9.02e-07  |ddm|= 1.67e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498603e+02 1.74905965e+02
 2.04943573e+01 5.69621774e+01 4.87624164e-01 7.82711605e+00
 1.65430754e+00 4.06205660e+00 1.24351058e+01 5.47513806e+01
 2.05537975e-01 1.51865269e+00 5.72229728e-01]
E = -128.5334552115785
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681856        1
[INPUT] 0    0    [1    /1   ]  617.498603385        1
[INPUT] 0    0    [1    /1   ]  174.90596535         1
[INPUT] 0    0    [1    /1   ]  20.4943572583        1
[INPUT] 0    0    [1    /1   ]  56.9621774376        1
[INPUT] 0    0    [1    /1   ]  0.487624163932       1
[INPUT] 0    0    [1    /1   ]  7.82711604943        1
[INPUT] 0    0    [1    /1   ]  1.65430754236        1
[INPUT] 1    0    [1    /1   ]  4.06205660261        1
[INPUT] 1    0    [1    /1   ]  12.435105791         1
[INPUT] 1    0    [1    /1   ]  54.7513806042        1
[INPUT] 1    0    [1    /1   ]  0.205537974645       1
[INPUT] 1    0    [1    /1   ]  1.51865268795        1
[INPUT] 1    0    [1    /1   ]  0.572229727754       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730071132, 1.0]], [0, [2712.0968185590323, 1.0]], [0, [617.4986033854256, 1.0]], [0, [174.90596535007245, 1.0]], [0, [20.494357258315464, 1.0]], [0, [56.96217743756859, 1.0]], [0, [0.48762416393222097, 1.0]], [0, [7.827116049433707, 1.0]], [0, [1.65430754236046, 1.0]], [1, [4.062056602610382, 1.0]], [1, [12.435105791004425, 1.0]], [1, [54.75138060421348, 1.0]], [1, [0.20553797464466028, 1.0]], [1, [1.5186526879450928, 1.0]], [1, [0.572229727754294, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681856]
bas 2, expnt(s) = [617.49860339]
bas 3, expnt(s) = [174.90596535]
bas 4, expnt(s) = [20.49435726]
bas 5, expnt(s) = [56.96217744]
bas 6, expnt(s) = [0.48762416]
bas 7, expnt(s) = [7.82711605]
bas 8, expnt(s) = [1.65430754]
bas 9, expnt(s) = [4.0620566]
bas 10, expnt(s) = [12.43510579]
bas 11, expnt(s) = [54.7513806]
bas 12, expnt(s) = [0.20553797]
bas 13, expnt(s) = [1.51865269]
bas 14, expnt(s) = [0.57222973]
CPU time:        49.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498603e+02 3.12962289e+02 1.74905965e+02 1.21511810e+02
 2.04943573e+01 2.43355268e+01 5.69621774e+01 5.23847603e+01
 4.87624164e-01 1.47427648e+00 7.82711605e+00 1.18226914e+01
 1.65430754e+00 3.68533704e+00 4.06205660e+00 1.68235195e+01
 1.24351058e+01 6.81233895e+01 5.47513806e+01 4.34488450e+02
 2.05537975e-01 4.03737866e-01 1.51865269e+00 4.91821456e+00
 5.72229728e-01 1.45193580e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999461723802701
cond(S) = 239.66958613330175
E1 = -183.5815424957276  E_coul = 55.080785443481936
init E= -128.500757052246
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774676243447509  LUMO = 0.576250185970345
  mo_energy =
[-3.25545347e+01 -1.85121847e+00 -7.74676243e-01 -7.74676243e-01
 -7.74676243e-01  5.76250186e-01  5.76250186e-01  5.76250186e-01
  2.06180593e+00  2.57299529e+00  2.57299529e+00  2.57299529e+00
  8.45830825e+00  8.45830825e+00  8.45830825e+00  1.94441471e+01
  2.77776884e+01  2.77776884e+01  2.77776884e+01  9.38996430e+01
  1.21987523e+02  1.21987523e+02  1.21987523e+02  3.56248774e+02
  1.34961873e+03  5.83606076e+03  3.50986746e+04]
E1 = -182.04918306741965  E_coul = 53.519396513508326
cycle= 1 E= -128.529786553911  delta_E= -0.029  |g|= 0.208  |ddm|= 0.154
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.539577
diis-c [-0.29114355  1.        ]
  HOMO = -0.885228870079692  LUMO = 0.560278486926049
  mo_energy =
[-3.28845966e+01 -1.96769299e+00 -8.85228870e-01 -8.85228870e-01
 -8.85228870e-01  5.60278487e-01  5.60278487e-01  5.60278487e-01
  1.98245638e+00  2.50774804e+00  2.50774804e+00  2.50774804e+00
  8.31489797e+00  8.31489797e+00  8.31489797e+00  1.92172600e+01
  2.75365166e+01  2.75365166e+01  2.75365166e+01  9.35886732e+01
  1.21656673e+02  1.21656673e+02  1.21656673e+02  3.55889329e+02
  1.34922064e+03  5.83563069e+03  3.50982229e+04]
E1 = -182.8312163795404  E_coul = 54.298727466105774
cycle= 2 E= -128.532488913435  delta_E= -0.0027  |g|= 0.106  |ddm|= 0.0701
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.275213
diis-c [-5.81427557e-04  3.37133918e-01  6.62866082e-01]
  HOMO = -0.848662238183032  LUMO = 0.565622323871404
  mo_energy =
[-3.27739967e+01 -1.92906943e+00 -8.48662238e-01 -8.48662238e-01
 -8.48662238e-01  5.65622324e-01  5.65622324e-01  5.65622324e-01
  2.00851338e+00  2.52908198e+00  2.52908198e+00  2.52908198e+00
  8.36231328e+00  8.36231328e+00  8.36231328e+00  1.92934215e+01
  2.76174053e+01  2.76174053e+01  2.76174053e+01  9.36931277e+01
  1.21766831e+02  1.21766831e+02  1.21766831e+02  3.56006883e+02
  1.34934460e+03  5.83575767e+03  3.50983510e+04]
E1 = -182.56603380051732  E_coul = 54.03257860129748
cycle= 3 E= -128.53345519922  delta_E= -0.000966  |g|= 0.000341  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000826193
diis-c [-9.10461292e-08 -1.77862482e-03 -6.93148926e-04  1.00247177e+00]
  HOMO = -0.84884334607671  LUMO = 0.565615121580564
  mo_energy =
[-3.27743317e+01 -1.92921122e+00 -8.48843346e-01 -8.48843346e-01
 -8.48843346e-01  5.65615122e-01  5.65615122e-01  5.65615122e-01
  2.00844492e+00  2.52901219e+00  2.52901219e+00  2.52901219e+00
  8.36215482e+00  8.36215482e+00  8.36215482e+00  1.92932078e+01
  2.76171614e+01  2.76171614e+01  2.76171614e+01  9.36928168e+01
  1.21766486e+02  1.21766486e+02  1.21766486e+02  3.56006473e+02
  1.34934407e+03  5.83575705e+03  3.50983503e+04]
E1 = -182.56625429218496  E_coul = 54.03279908104002
cycle= 4 E= -128.533455211145  delta_E= -1.19e-08  |g|= 6.57e-05  |ddm|= 0.000162
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000163602
diis-c [-4.90930835e-10  8.08337606e-05  4.73472111e-04 -1.19243303e-01
  1.11868900e+00]
  HOMO = -0.848877748414555  LUMO = 0.565607938631928
  mo_energy =
[-3.27743955e+01 -1.92924411e+00 -8.48877748e-01 -8.48877748e-01
 -8.48877748e-01  5.65607939e-01  5.65607939e-01  5.65607939e-01
  2.00841841e+00  2.52898762e+00  2.52898762e+00  2.52898762e+00
  8.36211238e+00  8.36211238e+00  8.36211238e+00  1.92931549e+01
  2.76171055e+01  2.76171055e+01  2.76171055e+01  9.36927548e+01
  1.21766422e+02  1.21766422e+02  1.21766422e+02  3.56006406e+02
  1.34934400e+03  5.83575697e+03  3.50983503e+04]
E1 = -182.56637219498322  E_coul = 54.03291698340522
cycle= 5 E= -128.533455211578  delta_E= -4.33e-10  |g|= 2.05e-06  |ddm|= 2.93e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56637219498322  E_coul = 54.03291698340522
  HOMO = -0.848877252214874  LUMO = 0.565607919673732
  mo_energy =
[-3.27743938e+01 -1.92924354e+00 -8.48877252e-01 -8.48877252e-01
 -8.48877252e-01  5.65607920e-01  5.65607920e-01  5.65607920e-01
  2.00841869e+00  2.52898777e+00  2.52898777e+00  2.52898777e+00
  8.36211304e+00  8.36211304e+00  8.36211304e+00  1.92931562e+01
  2.76171069e+01  2.76171069e+01  2.76171069e+01  9.36927564e+01
  1.21766424e+02  1.21766424e+02  1.21766424e+02  3.56006407e+02
  1.34934400e+03  5.83575698e+03  3.50983503e+04]
E1 = -182.56636530380004  E_coul = 54.032910092221535
Extra cycle  E= -128.533455211579  delta_E= -5.12e-13  |g|= 9.02e-07  |ddm|= 1.67e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.66958613330175
E1 = -182.56636530380004  E_coul = 54.032910092221535
init E= -128.533455211579
    CPU time for initialize scf      0.30 sec, wall time      0.29 sec
  HOMO = -0.84887776345072  LUMO = 0.565607828182776
  mo_energy =
[-3.27743952e+01 -1.92924409e+00 -8.48877763e-01 -8.48877763e-01
 -8.48877763e-01  5.65607828e-01  5.65607828e-01  5.65607828e-01
  2.00841829e+00  2.52898744e+00  2.52898744e+00  2.52898744e+00
  8.36211238e+00  8.36211238e+00  8.36211238e+00  1.92931552e+01
  2.76171058e+01  2.76171058e+01  2.76171058e+01  9.36927551e+01
  1.21766423e+02  1.21766423e+02  1.21766423e+02  3.56006405e+02
  1.34934400e+03  5.83575697e+03  3.50983503e+04]
E1 = -182.5663682615839  E_coul = 54.0329130500051
cycle= 1 E= -128.533455211579  delta_E= -2.84e-13  |g|= 4.13e-07  |ddm|= 3.68e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5663682615839  E_coul = 54.0329130500051
  HOMO = -0.848877558121104  LUMO = 0.565607855455836
  mo_energy =
[-3.27743945e+01 -1.92924388e+00 -8.48877558e-01 -8.48877558e-01
 -8.48877558e-01  5.65607855e-01  5.65607855e-01  5.65607855e-01
  2.00841843e+00  2.52898755e+00  2.52898755e+00  2.52898755e+00
  8.36211265e+00  8.36211265e+00  8.36211265e+00  1.92931557e+01
  2.76171063e+01  2.76171063e+01  2.76171063e+01  9.36927557e+01
  1.21766423e+02  1.21766423e+02  1.21766423e+02  3.56006406e+02
  1.34934400e+03  5.83575697e+03  3.50983503e+04]
E1 = -182.5663666348545  E_coul = 54.03291142327558
Extra cycle  E= -128.533455211579  delta_E= -1.14e-13  |g|= 2.19e-07  |ddm|= 1.5e-07
    CPU time for scf_cycle      0.38 sec, wall time      0.38 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498603e+02 1.74905965e+02
 2.04943573e+01 5.69621774e+01 4.87624164e-01 7.82711605e+00
 1.65430754e+00 4.06205660e+00 1.24351058e+01 5.47513806e+01
 2.05537975e-01 1.51865269e+00 5.72229728e-01]
grad_E = [-9.24561434e-12  7.39144200e-10 -2.03108586e-08  3.53481955e-07
  4.05633732e-06 -3.16784392e-06 -1.41582211e-04  4.47941635e-06
  1.61113589e-05 -2.54997226e-04 -1.69069354e-03  1.08668441e-04
 -1.87973150e-04  3.56145993e-04  5.79028757e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681855        1
[INPUT] 0    0    [1    /1   ]  617.498603497        1
[INPUT] 0    0    [1    /1   ]  174.905963599        1
[INPUT] 0    0    [1    /1   ]  20.4943379394        1
[INPUT] 0    0    [1    /1   ]  56.9621922281        1
[INPUT] 0    0    [1    /1   ]  0.487298421733       1
[INPUT] 0    0    [1    /1   ]  7.82710225684        1
[INPUT] 0    0    [1    /1   ]  1.65436589339        1
[INPUT] 1    0    [1    /1   ]  4.06926955271        1
[INPUT] 1    0    [1    /1   ]  12.4384600885        1
[INPUT] 1    0    [1    /1   ]  54.7511396291        1
[INPUT] 1    0    [1    /1   ]  0.20798186526        1
[INPUT] 1    0    [1    /1   ]  1.52545500841        1
[INPUT] 1    0    [1    /1   ]  0.577225652489       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730071198, 1.0]], [0, [2712.096818554571, 1.0]], [0, [617.4986034974331, 1.0]], [0, [174.90596359858327, 1.0]], [0, [20.494337939382657, 1.0]], [0, [56.96219222813316, 1.0]], [0, [0.4872984217325086, 1.0]], [0, [7.827102256835618, 1.0]], [0, [1.6543658933908802, 1.0]], [1, [4.069269552706125, 1.0]], [1, [12.438460088518358, 1.0]], [1, [54.75113962906022, 1.0]], [1, [0.20798186525979342, 1.0]], [1, [1.5254550084110756, 1.0]], [1, [0.5772256524890783, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681855]
bas 2, expnt(s) = [617.4986035]
bas 3, expnt(s) = [174.9059636]
bas 4, expnt(s) = [20.49433794]
bas 5, expnt(s) = [56.96219223]
bas 6, expnt(s) = [0.48729842]
bas 7, expnt(s) = [7.82710226]
bas 8, expnt(s) = [1.65436589]
bas 9, expnt(s) = [4.06926955]
bas 10, expnt(s) = [12.43846009]
bas 11, expnt(s) = [54.75113963]
bas 12, expnt(s) = [0.20798187]
bas 13, expnt(s) = [1.52545501]
bas 14, expnt(s) = [0.57722565]
CPU time:        52.67
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498603e+02 3.12962289e+02 1.74905964e+02 1.21511809e+02
 2.04943379e+01 2.43355095e+01 5.69621922e+01 5.23847705e+01
 4.87298422e-01 1.47353779e+00 7.82710226e+00 1.18226758e+01
 1.65436589e+00 3.68543453e+00 4.06926955e+00 1.68608695e+01
 1.24384601e+01 6.81463601e+01 5.47511396e+01 4.34486060e+02
 2.07981865e-01 4.09747421e-01 1.52545501e+00 4.94576693e+00
 5.77225652e-01 1.46779844e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999458399187738
cond(S) = 239.65011969871273
E1 = -183.58158094547497  E_coul = 55.080816143266226
init E= -128.500764802209
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774675203816046  LUMO = 0.583627179439348
  mo_energy =
[-3.25545262e+01 -1.85121695e+00 -7.74675204e-01 -7.74675204e-01
 -7.74675204e-01  5.83627179e-01  5.83627179e-01  5.83627179e-01
  2.06075033e+00  2.59723684e+00  2.59723684e+00  2.59723684e+00
  8.50700382e+00  8.50700382e+00  8.50700382e+00  1.94428810e+01
  2.78490935e+01  2.78490935e+01  2.78490935e+01  9.38985322e+01
  1.22055763e+02  1.22055763e+02  1.22055763e+02  3.56247798e+02
  1.34961787e+03  5.83606002e+03  3.50986740e+04]
E1 = -182.04950209325338  E_coul = 53.519710335672656
cycle= 1 E= -128.529791757581  delta_E= -0.029  |g|= 0.208  |ddm|= 0.154
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540209
diis-c [-0.29182583  1.        ]
  HOMO = -0.885209749903738  LUMO = 0.56739442482479
  mo_energy =
[-3.28845395e+01 -1.96765224e+00 -8.85209750e-01 -8.85209750e-01
 -8.85209750e-01  5.67394425e-01  5.67394425e-01  5.67394425e-01
  1.98145343e+00  2.53162981e+00  2.53162981e+00  2.53162981e+00
  8.36346011e+00  8.36346011e+00  8.36346011e+00  1.92160226e+01
  2.76079813e+01  2.76079813e+01  2.76079813e+01  9.35876082e+01
  1.21724983e+02  1.21724983e+02  1.21724983e+02  3.55888401e+02
  1.34921984e+03  5.83562999e+03  3.50982223e+04]
E1 = -182.83131008909504  E_coul = 54.29881632586593
cycle= 2 E= -128.532493763229  delta_E= -0.0027  |g|= 0.106  |ddm|= 0.0701
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.275469
diis-c [-5.81298036e-04  3.37081426e-01  6.62918574e-01]
  HOMO = -0.848651825680438  LUMO = 0.572825277762505
  mo_energy =
[-3.27739582e+01 -1.92903832e+00 -8.48651826e-01 -8.48651826e-01
 -8.48651826e-01  5.72825278e-01  5.72825278e-01  5.72825278e-01
  2.00749758e+00  2.55308241e+00  2.55308241e+00  2.55308241e+00
  8.41092004e+00  8.41092004e+00  8.41092004e+00  1.92921699e+01
  2.76888473e+01  2.76888473e+01  2.76888473e+01  9.36920450e+01
  1.21835115e+02  1.21835115e+02  1.21835115e+02  3.56005936e+02
  1.34934377e+03  5.83575696e+03  3.50983504e+04]
E1 = -182.5662499594711  E_coul = 54.03279052912021
cycle= 3 E= -128.533459430351  delta_E= -0.000966  |g|= 0.000341  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0008335
diis-c [-9.03345530e-08 -1.77624663e-03 -6.61371238e-04  1.00243762e+00]
  HOMO = -0.848831973255273  LUMO = 0.572818350829424
  mo_energy =
[-3.27742921e+01 -1.92917746e+00 -8.48831973e-01 -8.48831973e-01
 -8.48831973e-01  5.72818351e-01  5.72818351e-01  5.72818351e-01
  2.00743142e+00  2.55301321e+00  2.55301321e+00  2.55301321e+00
  8.41076282e+00  8.41076282e+00  8.41076282e+00  1.92919578e+01
  2.76886049e+01  2.76886049e+01  2.76886049e+01  9.36917352e+01
  1.21834771e+02  1.21834771e+02  1.21834771e+02  3.56005525e+02
  1.34934325e+03  5.83575633e+03  3.50983498e+04]
E1 = -182.56647664917782  E_coul = 54.03301720714993
cycle= 4 E= -128.533459442028  delta_E= -1.17e-08  |g|= 6.59e-05  |ddm|= 0.000159
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000166181
diis-c [-4.88806343e-10  8.18087503e-05  4.81872729e-04 -1.19457882e-01
  1.11889420e+00]
  HOMO = -0.848866239864847  LUMO = 0.572811165309129
  mo_energy =
[-3.27743561e+01 -1.92920981e+00 -8.48866240e-01 -8.48866240e-01
 -8.48866240e-01  5.72811165e-01  5.72811165e-01  5.72811165e-01
  2.00740542e+00  2.55298877e+00  2.55298877e+00  2.55298877e+00
  8.41072057e+00  8.41072057e+00  8.41072057e+00  1.92919051e+01
  2.76885491e+01  2.76885491e+01  2.76885491e+01  9.36916731e+01
  1.21834707e+02  1.21834707e+02  1.21834707e+02  3.56005458e+02
  1.34934317e+03  5.83575625e+03  3.50983497e+04]
E1 = -182.56659688485217  E_coul = 54.033137442395805
cycle= 5 E= -128.533459442456  delta_E= -4.28e-10  |g|= 1.98e-06  |ddm|= 2.82e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56659688485217  E_coul = 54.033137442395805
  HOMO = -0.848865749833159  LUMO = 0.572811154781745
  mo_energy =
[-3.27743546e+01 -1.92920920e+00 -8.48865750e-01 -8.48865750e-01
 -8.48865750e-01  5.72811155e-01  5.72811155e-01  5.72811155e-01
  2.00740575e+00  2.55298893e+00  2.55298893e+00  2.55298893e+00
  8.41072123e+00  8.41072123e+00  8.41072123e+00  1.92919065e+01
  2.76885504e+01  2.76885504e+01  2.76885504e+01  9.36916746e+01
  1.21834709e+02  1.21834709e+02  1.21834709e+02  3.56005459e+02
  1.34934317e+03  5.83575626e+03  3.50983497e+04]
E1 = -182.56659040680333  E_coul = 54.03313096434598
Extra cycle  E= -128.533459442457  delta_E= -9.66e-13  |g|= 8.45e-07  |ddm|= 1.57e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498603e+02 1.74905964e+02
 2.04943379e+01 5.69621922e+01 4.87298422e-01 7.82710226e+00
 1.65436589e+00 4.06926955e+00 1.24384601e+01 5.47511396e+01
 2.07981865e-01 1.52545501e+00 5.77225652e-01]
E = -128.53345944245734
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681855        1
[INPUT] 0    0    [1    /1   ]  617.498603497        1
[INPUT] 0    0    [1    /1   ]  174.905963599        1
[INPUT] 0    0    [1    /1   ]  20.4943379394        1
[INPUT] 0    0    [1    /1   ]  56.9621922281        1
[INPUT] 0    0    [1    /1   ]  0.487298421733       1
[INPUT] 0    0    [1    /1   ]  7.82710225684        1
[INPUT] 0    0    [1    /1   ]  1.65436589339        1
[INPUT] 1    0    [1    /1   ]  4.06926955271        1
[INPUT] 1    0    [1    /1   ]  12.4384600885        1
[INPUT] 1    0    [1    /1   ]  54.7511396291        1
[INPUT] 1    0    [1    /1   ]  0.20798186526        1
[INPUT] 1    0    [1    /1   ]  1.52545500841        1
[INPUT] 1    0    [1    /1   ]  0.577225652489       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730071198, 1.0]], [0, [2712.096818554571, 1.0]], [0, [617.4986034974331, 1.0]], [0, [174.90596359858327, 1.0]], [0, [20.494337939382657, 1.0]], [0, [56.96219222813316, 1.0]], [0, [0.4872984217325086, 1.0]], [0, [7.827102256835618, 1.0]], [0, [1.6543658933908802, 1.0]], [1, [4.069269552706125, 1.0]], [1, [12.438460088518358, 1.0]], [1, [54.75113962906022, 1.0]], [1, [0.20798186525979342, 1.0]], [1, [1.5254550084110756, 1.0]], [1, [0.5772256524890783, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681855]
bas 2, expnt(s) = [617.4986035]
bas 3, expnt(s) = [174.9059636]
bas 4, expnt(s) = [20.49433794]
bas 5, expnt(s) = [56.96219223]
bas 6, expnt(s) = [0.48729842]
bas 7, expnt(s) = [7.82710226]
bas 8, expnt(s) = [1.65436589]
bas 9, expnt(s) = [4.06926955]
bas 10, expnt(s) = [12.43846009]
bas 11, expnt(s) = [54.75113963]
bas 12, expnt(s) = [0.20798187]
bas 13, expnt(s) = [1.52545501]
bas 14, expnt(s) = [0.57722565]
CPU time:        53.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498603e+02 3.12962289e+02 1.74905964e+02 1.21511809e+02
 2.04943379e+01 2.43355095e+01 5.69621922e+01 5.23847705e+01
 4.87298422e-01 1.47353779e+00 7.82710226e+00 1.18226758e+01
 1.65436589e+00 3.68543453e+00 4.06926955e+00 1.68608695e+01
 1.24384601e+01 6.81463601e+01 5.47511396e+01 4.34486060e+02
 2.07981865e-01 4.09747421e-01 1.52545501e+00 4.94576693e+00
 5.77225652e-01 1.46779844e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999458399187738
cond(S) = 239.65011969871273
E1 = -183.58158094547497  E_coul = 55.080816143266226
init E= -128.500764802209
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774675203816046  LUMO = 0.583627179439348
  mo_energy =
[-3.25545262e+01 -1.85121695e+00 -7.74675204e-01 -7.74675204e-01
 -7.74675204e-01  5.83627179e-01  5.83627179e-01  5.83627179e-01
  2.06075033e+00  2.59723684e+00  2.59723684e+00  2.59723684e+00
  8.50700382e+00  8.50700382e+00  8.50700382e+00  1.94428810e+01
  2.78490935e+01  2.78490935e+01  2.78490935e+01  9.38985322e+01
  1.22055763e+02  1.22055763e+02  1.22055763e+02  3.56247798e+02
  1.34961787e+03  5.83606002e+03  3.50986740e+04]
E1 = -182.04950209325338  E_coul = 53.519710335672656
cycle= 1 E= -128.529791757581  delta_E= -0.029  |g|= 0.208  |ddm|= 0.154
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540209
diis-c [-0.29182583  1.        ]
  HOMO = -0.885209749903738  LUMO = 0.56739442482479
  mo_energy =
[-3.28845395e+01 -1.96765224e+00 -8.85209750e-01 -8.85209750e-01
 -8.85209750e-01  5.67394425e-01  5.67394425e-01  5.67394425e-01
  1.98145343e+00  2.53162981e+00  2.53162981e+00  2.53162981e+00
  8.36346011e+00  8.36346011e+00  8.36346011e+00  1.92160226e+01
  2.76079813e+01  2.76079813e+01  2.76079813e+01  9.35876082e+01
  1.21724983e+02  1.21724983e+02  1.21724983e+02  3.55888401e+02
  1.34921984e+03  5.83562999e+03  3.50982223e+04]
E1 = -182.83131008909504  E_coul = 54.29881632586593
cycle= 2 E= -128.532493763229  delta_E= -0.0027  |g|= 0.106  |ddm|= 0.0701
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.275469
diis-c [-5.81298036e-04  3.37081426e-01  6.62918574e-01]
  HOMO = -0.848651825680438  LUMO = 0.572825277762505
  mo_energy =
[-3.27739582e+01 -1.92903832e+00 -8.48651826e-01 -8.48651826e-01
 -8.48651826e-01  5.72825278e-01  5.72825278e-01  5.72825278e-01
  2.00749758e+00  2.55308241e+00  2.55308241e+00  2.55308241e+00
  8.41092004e+00  8.41092004e+00  8.41092004e+00  1.92921699e+01
  2.76888473e+01  2.76888473e+01  2.76888473e+01  9.36920450e+01
  1.21835115e+02  1.21835115e+02  1.21835115e+02  3.56005936e+02
  1.34934377e+03  5.83575696e+03  3.50983504e+04]
E1 = -182.5662499594711  E_coul = 54.03279052912021
cycle= 3 E= -128.533459430351  delta_E= -0.000966  |g|= 0.000341  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0008335
diis-c [-9.03345530e-08 -1.77624663e-03 -6.61371238e-04  1.00243762e+00]
  HOMO = -0.848831973255273  LUMO = 0.572818350829424
  mo_energy =
[-3.27742921e+01 -1.92917746e+00 -8.48831973e-01 -8.48831973e-01
 -8.48831973e-01  5.72818351e-01  5.72818351e-01  5.72818351e-01
  2.00743142e+00  2.55301321e+00  2.55301321e+00  2.55301321e+00
  8.41076282e+00  8.41076282e+00  8.41076282e+00  1.92919578e+01
  2.76886049e+01  2.76886049e+01  2.76886049e+01  9.36917352e+01
  1.21834771e+02  1.21834771e+02  1.21834771e+02  3.56005525e+02
  1.34934325e+03  5.83575633e+03  3.50983498e+04]
E1 = -182.56647664917782  E_coul = 54.03301720714993
cycle= 4 E= -128.533459442028  delta_E= -1.17e-08  |g|= 6.59e-05  |ddm|= 0.000159
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000166181
diis-c [-4.88806343e-10  8.18087503e-05  4.81872729e-04 -1.19457882e-01
  1.11889420e+00]
  HOMO = -0.848866239864847  LUMO = 0.572811165309129
  mo_energy =
[-3.27743561e+01 -1.92920981e+00 -8.48866240e-01 -8.48866240e-01
 -8.48866240e-01  5.72811165e-01  5.72811165e-01  5.72811165e-01
  2.00740542e+00  2.55298877e+00  2.55298877e+00  2.55298877e+00
  8.41072057e+00  8.41072057e+00  8.41072057e+00  1.92919051e+01
  2.76885491e+01  2.76885491e+01  2.76885491e+01  9.36916731e+01
  1.21834707e+02  1.21834707e+02  1.21834707e+02  3.56005458e+02
  1.34934317e+03  5.83575625e+03  3.50983497e+04]
E1 = -182.56659688485217  E_coul = 54.033137442395805
cycle= 5 E= -128.533459442456  delta_E= -4.28e-10  |g|= 1.98e-06  |ddm|= 2.82e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56659688485217  E_coul = 54.033137442395805
  HOMO = -0.848865749833159  LUMO = 0.572811154781745
  mo_energy =
[-3.27743546e+01 -1.92920920e+00 -8.48865750e-01 -8.48865750e-01
 -8.48865750e-01  5.72811155e-01  5.72811155e-01  5.72811155e-01
  2.00740575e+00  2.55298893e+00  2.55298893e+00  2.55298893e+00
  8.41072123e+00  8.41072123e+00  8.41072123e+00  1.92919065e+01
  2.76885504e+01  2.76885504e+01  2.76885504e+01  9.36916746e+01
  1.21834709e+02  1.21834709e+02  1.21834709e+02  3.56005459e+02
  1.34934317e+03  5.83575626e+03  3.50983497e+04]
E1 = -182.56659040680333  E_coul = 54.03313096434598
Extra cycle  E= -128.533459442457  delta_E= -9.66e-13  |g|= 8.45e-07  |ddm|= 1.57e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.65011969871273
E1 = -182.56659040680333  E_coul = 54.03313096434598
init E= -128.533459442457
    CPU time for initialize scf      0.26 sec, wall time      0.25 sec
  HOMO = -0.848866231467493  LUMO = 0.572811068065593
  mo_energy =
[-3.27743558e+01 -1.92920970e+00 -8.48866231e-01 -8.48866231e-01
 -8.48866231e-01  5.72811068e-01  5.72811068e-01  5.72811068e-01
  2.00740539e+00  2.55298862e+00  2.55298862e+00  2.55298862e+00
  8.41072061e+00  8.41072061e+00  8.41072061e+00  1.92919055e+01
  2.76885494e+01  2.76885494e+01  2.76885494e+01  9.36916733e+01
  1.21834707e+02  1.21834707e+02  1.21834707e+02  3.56005458e+02
  1.34934317e+03  5.83575625e+03  3.50983497e+04]
E1 = -182.56659322162557  E_coul = 54.033133779168324
cycle= 1 E= -128.533459442457  delta_E= 1.14e-13  |g|= 3.92e-07  |ddm|= 3.29e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.56659322162557  E_coul = 54.033133779168324
  HOMO = -0.848866036208177  LUMO = 0.572811094660205
  mo_energy =
[-3.27743552e+01 -1.92920950e+00 -8.48866036e-01 -8.48866036e-01
 -8.48866036e-01  5.72811095e-01  5.72811095e-01  5.72811095e-01
  2.00740552e+00  2.55298873e+00  2.55298873e+00  2.55298873e+00
  8.41072086e+00  8.41072086e+00  8.41072086e+00  1.92919060e+01
  2.76885498e+01  2.76885498e+01  2.76885498e+01  9.36916739e+01
  1.21834708e+02  1.21834708e+02  1.21834708e+02  3.56005459e+02
  1.34934317e+03  5.83575625e+03  3.50983497e+04]
E1 = -182.56659168318083  E_coul = 54.03313224072346
Extra cycle  E= -128.533459442457  delta_E= -1.42e-13  |g|= 2.07e-07  |ddm|= 1.44e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.32 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498603e+02 1.74905964e+02
 2.04943379e+01 5.69621922e+01 4.87298422e-01 7.82710226e+00
 1.65436589e+00 4.06926955e+00 1.24384601e+01 5.47511396e+01
 2.07981865e-01 1.52545501e+00 5.77225652e-01]
grad_E = [-5.64421988e-12  5.42788748e-10 -1.65958377e-08  3.05613710e-07
  1.74988055e-06 -2.82853942e-06 -8.63529256e-04  9.20430135e-06
  2.09943902e-04 -1.95296907e-04 -1.70939601e-03  1.09416072e-04
  5.96092980e-04  2.74922970e-04  6.59958901e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681854        1
[INPUT] 0    0    [1    /1   ]  617.498603794        1
[INPUT] 0    0    [1    /1   ]  174.905958845        1
[INPUT] 0    0    [1    /1   ]  20.4942836918        1
[INPUT] 0    0    [1    /1   ]  56.9622329367        1
[INPUT] 0    0    [1    /1   ]  0.486623467834       1
[INPUT] 0    0    [1    /1   ]  7.82706272203        1
[INPUT] 0    0    [1    /1   ]  1.65456065457        1
[INPUT] 1    0    [1    /1   ]  4.08463509687        1
[INPUT] 1    0    [1    /1   ]  12.4508015759        1
[INPUT] 1    0    [1    /1   ]  54.7502959214        1
[INPUT] 1    0    [1    /1   ]  0.211827079249       1
[INPUT] 1    0    [1    /1   ]  1.53883417817        1
[INPUT] 1    0    [1    /1   ]  0.587090916079       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873007136, 1.0]], [0, [2712.096818542949, 1.0]], [0, [617.4986037942317, 1.0]], [0, [174.90595884465506, 1.0]], [0, [20.494283691807784, 1.0]], [0, [56.96223293673165, 1.0]], [0, [0.4866234678335548, 1.0]], [0, [7.827062722029076, 1.0]], [0, [1.6545606545737188, 1.0]], [1, [4.084635096865044, 1.0]], [1, [12.450801575900954, 1.0]], [1, [54.7502959214051, 1.0]], [1, [0.2118270792486372, 1.0]], [1, [1.5388341781696633, 1.0]], [1, [0.5870909160790899, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681854]
bas 2, expnt(s) = [617.49860379]
bas 3, expnt(s) = [174.90595884]
bas 4, expnt(s) = [20.49428369]
bas 5, expnt(s) = [56.96223294]
bas 6, expnt(s) = [0.48662347]
bas 7, expnt(s) = [7.82706272]
bas 8, expnt(s) = [1.65456065]
bas 9, expnt(s) = [4.0846351]
bas 10, expnt(s) = [12.45080158]
bas 11, expnt(s) = [54.75029592]
bas 12, expnt(s) = [0.21182708]
bas 13, expnt(s) = [1.53883418]
bas 14, expnt(s) = [0.58709092]
CPU time:        56.25
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498604e+02 3.12962289e+02 1.74905959e+02 1.21511807e+02
 2.04942837e+01 2.43354612e+01 5.69622329e+01 5.23847986e+01
 4.86623468e-01 1.47200678e+00 7.82706272e+00 1.18226310e+01
 1.65456065e+00 3.68575993e+00 4.08463510e+00 1.69404902e+01
 1.24508016e+01 6.82308894e+01 5.47502959e+01 4.34477690e+02
 2.11827079e-01 4.19238579e-01 1.53883418e+00 5.00004798e+00
 5.87090916e-01 1.49922251e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999451656732061
cond(S) = 239.61273059857993
E1 = -183.58165548085762  E_coul = 55.08087851759831
init E= -128.500776963259
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77467416330183  LUMO = 0.595894745553108
  mo_energy =
[-3.25545090e+01 -1.85121380e+00 -7.74674163e-01 -7.74674163e-01
 -7.74674163e-01  5.95894746e-01  5.95894746e-01  5.95894746e-01
  2.05862760e+00  2.64137224e+00  2.64137224e+00  2.64137224e+00
  8.60017001e+00  8.60017001e+00  8.60017001e+00  1.94405394e+01
  2.79962127e+01  2.79962127e+01  2.79962127e+01  9.38964702e+01
  1.22209416e+02  1.22209416e+02  1.22209416e+02  3.56245977e+02
  1.34961628e+03  5.83605864e+03  3.50986728e+04]
E1 = -182.0496328292939  E_coul = 53.51982742834786
cycle= 1 E= -128.529805400946  delta_E= -0.029  |g|= 0.208  |ddm|= 0.155
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.541253
diis-c [-0.29295531  1.        ]
  HOMO = -0.885217222838911  LUMO = 0.579193918608693
  mo_energy =
[-3.28844990e+01 -1.96761841e+00 -8.85217223e-01 -8.85217223e-01
 -8.85217223e-01  5.79193919e-01  5.79193919e-01  5.79193919e-01
  1.97939655e+00  2.57502714e+00  2.57502714e+00  2.57502714e+00
  8.45627330e+00  8.45627330e+00  8.45627330e+00  1.92136639e+01
  2.77551031e+01  2.77551031e+01  2.77551031e+01  9.35855634e+01
  1.21878705e+02  1.21878705e+02  1.21878705e+02  3.55886604e+02
  1.34921827e+03  5.83562863e+03  3.50982212e+04]
E1 = -182.83127132102513  E_coul = 54.29876348251605
cycle= 2 E= -128.532507838509  delta_E= -0.0027  |g|= 0.106  |ddm|= 0.07
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.275908
diis-c [-5.81299375e-04  3.37007234e-01  6.62992766e-01]
  HOMO = -0.848664803685069  LUMO = 0.584777474561696
  mo_energy =
[-3.27739223e+01 -1.92901090e+00 -8.48664804e-01 -8.48664804e-01
 -8.48664804e-01  5.84777475e-01  5.84777475e-01  5.84777475e-01
  2.00542428e+00  2.59671792e+00  2.59671792e+00  2.59671792e+00
  8.50384813e+00  8.50384813e+00  8.50384813e+00  1.92898065e+01
  2.78359646e+01  2.78359646e+01  2.78359646e+01  9.36899956e+01
  1.21988818e+02  1.21988818e+02  1.21988818e+02  3.56004133e+02
  1.34934220e+03  5.83575559e+03  3.50983493e+04]
E1 = -182.56630232231652  E_coul = 54.03282922077826
cycle= 3 E= -128.533473101538  delta_E= -0.000965  |g|= 0.000346  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000854755
diis-c [-9.21486221e-08 -1.78307346e-03 -6.01275182e-04  1.00238435e+00]
  HOMO = -0.848845753050048  LUMO = 0.584770152724655
  mo_energy =
[-3.27742581e+01 -1.92914797e+00 -8.48845753e-01 -8.48845753e-01
 -8.48845753e-01  5.84770153e-01  5.84770153e-01  5.84770153e-01
  2.00535989e+00  2.59664752e+00  2.59664752e+00  2.59664752e+00
  8.50369003e+00  8.50369003e+00  8.50369003e+00  1.92895939e+01
  2.78357212e+01  2.78357212e+01  2.78357212e+01  9.36896841e+01
  1.21988472e+02  1.21988472e+02  1.21988472e+02  3.56003720e+02
  1.34934167e+03  5.83575496e+03  3.50983486e+04]
E1 = -182.56654002394384  E_coul = 54.033066910513284
cycle= 4 E= -128.533473113431  delta_E= -1.19e-08  |g|= 6.72e-05  |ddm|= 0.000159
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000172184
diis-c [-4.98475909e-10  8.64976096e-05  4.99394318e-04 -1.22062096e-01
  1.12147620e+00]
  HOMO = -0.848880396439144  LUMO = 0.584762781748502
  mo_energy =
[-3.27743234e+01 -1.92918003e+00 -8.48880396e-01 -8.48880396e-01
 -8.48880396e-01  5.84762782e-01  5.84762782e-01  5.84762782e-01
  2.00533421e+00  2.59662274e+00  2.59662274e+00  2.59662274e+00
  8.50364732e+00  8.50364732e+00  8.50364732e+00  1.92895407e+01
  2.78356647e+01  2.78356647e+01  2.78356647e+01  9.36896208e+01
  1.21988406e+02  1.21988406e+02  1.21988406e+02  3.56003650e+02
  1.34934159e+03  5.83575488e+03  3.50983485e+04]
E1 = -182.56666486465235  E_coul = 54.03319175078117
cycle= 5 E= -128.533473113871  delta_E= -4.41e-10  |g|= 1.96e-06  |ddm|= 2.74e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56666486465235  E_coul = 54.03319175078117
  HOMO = -0.848879862501072  LUMO = 0.584762793095548
  mo_energy =
[-3.27743218e+01 -1.92917932e+00 -8.48879863e-01 -8.48879863e-01
 -8.48879863e-01  5.84762793e-01  5.84762793e-01  5.84762793e-01
  2.00533463e+00  2.59662296e+00  2.59662296e+00  2.59662296e+00
  8.50364805e+00  8.50364805e+00  8.50364805e+00  1.92895421e+01
  2.78356660e+01  2.78356660e+01  2.78356660e+01  9.36896223e+01
  1.21988408e+02  1.21988408e+02  1.21988408e+02  3.56003652e+02
  1.34934159e+03  5.83575488e+03  3.50983486e+04]
E1 = -182.56665867593154  E_coul = 54.033185562059515
Extra cycle  E= -128.533473113872  delta_E= -8.24e-13  |g|= 8.07e-07  |ddm|= 1.43e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498604e+02 1.74905959e+02
 2.04942837e+01 5.69622329e+01 4.86623468e-01 7.82706272e+00
 1.65456065e+00 4.08463510e+00 1.24508016e+01 5.47502959e+01
 2.11827079e-01 1.53883418e+00 5.87090916e-01]
E = -128.53347311387202
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681854        1
[INPUT] 0    0    [1    /1   ]  617.498603794        1
[INPUT] 0    0    [1    /1   ]  174.905958845        1
[INPUT] 0    0    [1    /1   ]  20.4942836918        1
[INPUT] 0    0    [1    /1   ]  56.9622329367        1
[INPUT] 0    0    [1    /1   ]  0.486623467834       1
[INPUT] 0    0    [1    /1   ]  7.82706272203        1
[INPUT] 0    0    [1    /1   ]  1.65456065457        1
[INPUT] 1    0    [1    /1   ]  4.08463509687        1
[INPUT] 1    0    [1    /1   ]  12.4508015759        1
[INPUT] 1    0    [1    /1   ]  54.7502959214        1
[INPUT] 1    0    [1    /1   ]  0.211827079249       1
[INPUT] 1    0    [1    /1   ]  1.53883417817        1
[INPUT] 1    0    [1    /1   ]  0.587090916079       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873007136, 1.0]], [0, [2712.096818542949, 1.0]], [0, [617.4986037942317, 1.0]], [0, [174.90595884465506, 1.0]], [0, [20.494283691807784, 1.0]], [0, [56.96223293673165, 1.0]], [0, [0.4866234678335548, 1.0]], [0, [7.827062722029076, 1.0]], [0, [1.6545606545737188, 1.0]], [1, [4.084635096865044, 1.0]], [1, [12.450801575900954, 1.0]], [1, [54.7502959214051, 1.0]], [1, [0.2118270792486372, 1.0]], [1, [1.5388341781696633, 1.0]], [1, [0.5870909160790899, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681854]
bas 2, expnt(s) = [617.49860379]
bas 3, expnt(s) = [174.90595884]
bas 4, expnt(s) = [20.49428369]
bas 5, expnt(s) = [56.96223294]
bas 6, expnt(s) = [0.48662347]
bas 7, expnt(s) = [7.82706272]
bas 8, expnt(s) = [1.65456065]
bas 9, expnt(s) = [4.0846351]
bas 10, expnt(s) = [12.45080158]
bas 11, expnt(s) = [54.75029592]
bas 12, expnt(s) = [0.21182708]
bas 13, expnt(s) = [1.53883418]
bas 14, expnt(s) = [0.58709092]
CPU time:        56.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498604e+02 3.12962289e+02 1.74905959e+02 1.21511807e+02
 2.04942837e+01 2.43354612e+01 5.69622329e+01 5.23847986e+01
 4.86623468e-01 1.47200678e+00 7.82706272e+00 1.18226310e+01
 1.65456065e+00 3.68575993e+00 4.08463510e+00 1.69404902e+01
 1.24508016e+01 6.82308894e+01 5.47502959e+01 4.34477690e+02
 2.11827079e-01 4.19238579e-01 1.53883418e+00 5.00004798e+00
 5.87090916e-01 1.49922251e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999451656732061
cond(S) = 239.61273059857993
E1 = -183.58165548085762  E_coul = 55.08087851759831
init E= -128.500776963259
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77467416330183  LUMO = 0.595894745553108
  mo_energy =
[-3.25545090e+01 -1.85121380e+00 -7.74674163e-01 -7.74674163e-01
 -7.74674163e-01  5.95894746e-01  5.95894746e-01  5.95894746e-01
  2.05862760e+00  2.64137224e+00  2.64137224e+00  2.64137224e+00
  8.60017001e+00  8.60017001e+00  8.60017001e+00  1.94405394e+01
  2.79962127e+01  2.79962127e+01  2.79962127e+01  9.38964702e+01
  1.22209416e+02  1.22209416e+02  1.22209416e+02  3.56245977e+02
  1.34961628e+03  5.83605864e+03  3.50986728e+04]
E1 = -182.0496328292939  E_coul = 53.51982742834786
cycle= 1 E= -128.529805400946  delta_E= -0.029  |g|= 0.208  |ddm|= 0.155
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.541253
diis-c [-0.29295531  1.        ]
  HOMO = -0.885217222838911  LUMO = 0.579193918608693
  mo_energy =
[-3.28844990e+01 -1.96761841e+00 -8.85217223e-01 -8.85217223e-01
 -8.85217223e-01  5.79193919e-01  5.79193919e-01  5.79193919e-01
  1.97939655e+00  2.57502714e+00  2.57502714e+00  2.57502714e+00
  8.45627330e+00  8.45627330e+00  8.45627330e+00  1.92136639e+01
  2.77551031e+01  2.77551031e+01  2.77551031e+01  9.35855634e+01
  1.21878705e+02  1.21878705e+02  1.21878705e+02  3.55886604e+02
  1.34921827e+03  5.83562863e+03  3.50982212e+04]
E1 = -182.83127132102513  E_coul = 54.29876348251605
cycle= 2 E= -128.532507838509  delta_E= -0.0027  |g|= 0.106  |ddm|= 0.07
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.275908
diis-c [-5.81299375e-04  3.37007234e-01  6.62992766e-01]
  HOMO = -0.848664803685069  LUMO = 0.584777474561696
  mo_energy =
[-3.27739223e+01 -1.92901090e+00 -8.48664804e-01 -8.48664804e-01
 -8.48664804e-01  5.84777475e-01  5.84777475e-01  5.84777475e-01
  2.00542428e+00  2.59671792e+00  2.59671792e+00  2.59671792e+00
  8.50384813e+00  8.50384813e+00  8.50384813e+00  1.92898065e+01
  2.78359646e+01  2.78359646e+01  2.78359646e+01  9.36899956e+01
  1.21988818e+02  1.21988818e+02  1.21988818e+02  3.56004133e+02
  1.34934220e+03  5.83575559e+03  3.50983493e+04]
E1 = -182.56630232231652  E_coul = 54.03282922077826
cycle= 3 E= -128.533473101538  delta_E= -0.000965  |g|= 0.000346  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000854755
diis-c [-9.21486221e-08 -1.78307346e-03 -6.01275182e-04  1.00238435e+00]
  HOMO = -0.848845753050048  LUMO = 0.584770152724655
  mo_energy =
[-3.27742581e+01 -1.92914797e+00 -8.48845753e-01 -8.48845753e-01
 -8.48845753e-01  5.84770153e-01  5.84770153e-01  5.84770153e-01
  2.00535989e+00  2.59664752e+00  2.59664752e+00  2.59664752e+00
  8.50369003e+00  8.50369003e+00  8.50369003e+00  1.92895939e+01
  2.78357212e+01  2.78357212e+01  2.78357212e+01  9.36896841e+01
  1.21988472e+02  1.21988472e+02  1.21988472e+02  3.56003720e+02
  1.34934167e+03  5.83575496e+03  3.50983486e+04]
E1 = -182.56654002394384  E_coul = 54.033066910513284
cycle= 4 E= -128.533473113431  delta_E= -1.19e-08  |g|= 6.72e-05  |ddm|= 0.000159
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000172184
diis-c [-4.98475909e-10  8.64976096e-05  4.99394318e-04 -1.22062096e-01
  1.12147620e+00]
  HOMO = -0.848880396439144  LUMO = 0.584762781748502
  mo_energy =
[-3.27743234e+01 -1.92918003e+00 -8.48880396e-01 -8.48880396e-01
 -8.48880396e-01  5.84762782e-01  5.84762782e-01  5.84762782e-01
  2.00533421e+00  2.59662274e+00  2.59662274e+00  2.59662274e+00
  8.50364732e+00  8.50364732e+00  8.50364732e+00  1.92895407e+01
  2.78356647e+01  2.78356647e+01  2.78356647e+01  9.36896208e+01
  1.21988406e+02  1.21988406e+02  1.21988406e+02  3.56003650e+02
  1.34934159e+03  5.83575488e+03  3.50983485e+04]
E1 = -182.56666486465235  E_coul = 54.03319175078117
cycle= 5 E= -128.533473113871  delta_E= -4.41e-10  |g|= 1.96e-06  |ddm|= 2.74e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56666486465235  E_coul = 54.03319175078117
  HOMO = -0.848879862501072  LUMO = 0.584762793095548
  mo_energy =
[-3.27743218e+01 -1.92917932e+00 -8.48879863e-01 -8.48879863e-01
 -8.48879863e-01  5.84762793e-01  5.84762793e-01  5.84762793e-01
  2.00533463e+00  2.59662296e+00  2.59662296e+00  2.59662296e+00
  8.50364805e+00  8.50364805e+00  8.50364805e+00  1.92895421e+01
  2.78356660e+01  2.78356660e+01  2.78356660e+01  9.36896223e+01
  1.21988408e+02  1.21988408e+02  1.21988408e+02  3.56003652e+02
  1.34934159e+03  5.83575488e+03  3.50983486e+04]
E1 = -182.56665867593154  E_coul = 54.033185562059515
Extra cycle  E= -128.533473113872  delta_E= -8.24e-13  |g|= 8.07e-07  |ddm|= 1.43e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.61273059857993
E1 = -182.56665867593154  E_coul = 54.033185562059515
init E= -128.533473113872
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.848880322583425  LUMO = 0.584762710096844
  mo_energy =
[-3.27743230e+01 -1.92917979e+00 -8.48880323e-01 -8.48880323e-01
 -8.48880323e-01  5.84762710e-01  5.84762710e-01  5.84762710e-01
  2.00533430e+00  2.59662266e+00  2.59662266e+00  2.59662266e+00
  8.50364746e+00  8.50364746e+00  8.50364746e+00  1.92895412e+01
  2.78356651e+01  2.78356651e+01  2.78356651e+01  9.36896211e+01
  1.21988407e+02  1.21988407e+02  1.21988407e+02  3.56003650e+02
  1.34934159e+03  5.83575488e+03  3.50983485e+04]
E1 = -182.56666144586845  E_coul = 54.03318833199678
cycle= 1 E= -128.533473113872  delta_E= 3.69e-13  |g|= 3.85e-07  |ddm|= 2.87e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.56666144586845  E_coul = 54.03318833199678
  HOMO = -0.848880130362034  LUMO = 0.584762737533922
  mo_energy =
[-3.27743224e+01 -1.92917958e+00 -8.48880130e-01 -8.48880130e-01
 -8.48880130e-01  5.84762738e-01  5.84762738e-01  5.84762738e-01
  2.00533443e+00  2.59662277e+00  2.59662277e+00  2.59662277e+00
  8.50364771e+00  8.50364771e+00  8.50364771e+00  1.92895416e+01
  2.78356655e+01  2.78356655e+01  2.78356655e+01  9.36896217e+01
  1.21988407e+02  1.21988407e+02  1.21988407e+02  3.56003651e+02
  1.34934159e+03  5.83575488e+03  3.50983485e+04]
E1 = -182.56665995171082  E_coul = 54.0331868378389
Extra cycle  E= -128.533473113872  delta_E= -2.84e-13  |g|= 2.01e-07  |ddm|= 1.42e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498604e+02 1.74905959e+02
 2.04942837e+01 5.69622329e+01 4.86623468e-01 7.82706272e+00
 1.65456065e+00 4.08463510e+00 1.24508016e+01 5.47502959e+01
 2.11827079e-01 1.53883418e+00 5.87090916e-01]
grad_E = [ 2.29768600e-12  1.09806617e-10 -8.41245762e-09  2.00404485e-07
 -3.27744856e-06 -2.08742067e-06 -2.42483098e-03  1.94069831e-05
  6.32502956e-04 -5.52028927e-06 -1.74325781e-03  1.09623830e-04
  5.25055639e-04 -2.17307814e-04  1.05178471e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681852        1
[INPUT] 0    0    [1    /1   ]  617.498604461        1
[INPUT] 0    0    [1    /1   ]  174.90594792         1
[INPUT] 0    0    [1    /1   ]  20.4941570385        1
[INPUT] 0    0    [1    /1   ]  56.9623276837        1
[INPUT] 0    0    [1    /1   ]  0.485906380121       1
[INPUT] 0    0    [1    /1   ]  7.82696365902        1
[INPUT] 0    0    [1    /1   ]  1.65491740398        1
[INPUT] 1    0    [1    /1   ]  4.11074025397        1
[INPUT] 1    0    [1    /1   ]  12.4859397456        1
[INPUT] 1    0    [1    /1   ]  54.7479656612        1
[INPUT] 1    0    [1    /1   ]  0.218489521621       1
[INPUT] 1    0    [1    /1   ]  1.55985013251        1
[INPUT] 1    0    [1    /1   ]  0.603553857369       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730071714, 1.0]], [0, [2712.0968185172787, 1.0]], [0, [617.4986044613424, 1.0]], [0, [174.90594791990378, 1.0]], [0, [20.494157038464316, 1.0]], [0, [56.96232768369708, 1.0]], [0, [0.485906380120993, 1.0]], [0, [7.826963659023641, 1.0]], [0, [1.6549174039841386, 1.0]], [1, [4.110740253974021, 1.0]], [1, [12.485939745562584, 1.0]], [1, [54.747965661223716, 1.0]], [1, [0.21848952162069105, 1.0]], [1, [1.5598501325057492, 1.0]], [1, [0.6035538573687802, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681852]
bas 2, expnt(s) = [617.49860446]
bas 3, expnt(s) = [174.90594792]
bas 4, expnt(s) = [20.49415704]
bas 5, expnt(s) = [56.96232768]
bas 6, expnt(s) = [0.48590638]
bas 7, expnt(s) = [7.82696366]
bas 8, expnt(s) = [1.6549174]
bas 9, expnt(s) = [4.11074025]
bas 10, expnt(s) = [12.48593975]
bas 11, expnt(s) = [54.74796566]
bas 12, expnt(s) = [0.21848952]
bas 13, expnt(s) = [1.55985013]
bas 14, expnt(s) = [0.60355386]
CPU time:        59.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498604e+02 3.12962289e+02 1.74905948e+02 1.21511801e+02
 2.04941570e+01 2.43353484e+01 5.69623277e+01 5.23848639e+01
 4.85906380e-01 1.47037962e+00 7.82696366e+00 1.18225188e+01
 1.65491740e+00 3.68635594e+00 4.11074025e+00 1.70759328e+01
 1.24859397e+01 6.84716725e+01 5.47479657e+01 4.34454575e+02
 2.18489522e-01 4.35785384e-01 1.55985013e+00 5.08555066e+00
 6.03553857e-01 1.55195609e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999436247991472
cond(S) = 239.57749775858792
E1 = -183.58177232352992  E_coul = 55.08096089814326
init E= -128.500811425387
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774675150303259  LUMO = 0.617016581341177
  mo_energy =
[-3.25544857e+01 -1.85120860e+00 -7.74675150e-01 -7.74675150e-01
 -7.74675150e-01  6.17016581e-01  6.17016581e-01  6.17016581e-01
  2.05650509e+00  2.71527215e+00  2.71527215e+00  2.71527215e+00
  8.75331646e+00  8.75331646e+00  8.75331646e+00  1.94385491e+01
  2.82546725e+01  2.82546725e+01  2.82546725e+01  9.38945762e+01
  1.22508826e+02  1.22508826e+02  1.22508826e+02  3.56244254e+02
  1.34961479e+03  5.83605735e+03  3.50986718e+04]
E1 = -182.0508427044853  E_coul = 53.520998071363984
cycle= 1 E= -128.529844633121  delta_E= -0.029  |g|= 0.208  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.542634
diis-c [-0.29445205  1.        ]
  HOMO = -0.885147837781292  LUMO = 0.599535946916862
  mo_energy =
[-3.28842688e+01 -1.96748719e+00 -8.85147838e-01 -8.85147838e-01
 -8.85147838e-01  5.99535947e-01  5.99535947e-01  5.99535947e-01
  1.97741380e+00  2.64779452e+00  2.64779452e+00  2.64779452e+00
  8.60894890e+00  8.60894890e+00  8.60894890e+00  1.92117941e+01
  2.80136195e+01  2.80136195e+01  2.80136195e+01  9.35838621e+01
  1.22178389e+02  1.22178389e+02  1.22178389e+02  3.55885098e+02
  1.34921700e+03  5.83562756e+03  3.50982204e+04]
E1 = -182.83162187215413  E_coul = 54.29907697777701
cycle= 2 E= -128.532544894377  delta_E= -0.0027  |g|= 0.106  |ddm|= 0.0699
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.276416
diis-c [-5.81394101e-04  3.36850900e-01  6.63149100e-01]
  HOMO = -0.848630625361122  LUMO = 0.605375165714843
  mo_energy =
[-3.27737721e+01 -1.92891837e+00 -8.48630625e-01 -8.48630625e-01
 -8.48630625e-01  6.05375166e-01  6.05375166e-01  6.05375166e-01
  2.00340270e+00  2.66985250e+00  2.66985250e+00  2.66985250e+00
  8.65667558e+00  8.65667558e+00  8.65667558e+00  1.92878762e+01
  2.80944483e+01  2.80944483e+01  2.80944483e+01  9.36882175e+01
  1.22288401e+02  1.22288401e+02  1.22288401e+02  3.56002544e+02
  1.34934085e+03  5.83575443e+03  3.50983484e+04]
E1 = -182.56703519787465  E_coul = 54.033527207520635
cycle= 3 E= -128.533507990354  delta_E= -0.000963  |g|= 0.000352  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000883559
diis-c [-9.40601947e-08 -1.79406639e-03 -5.22577531e-04  1.00231664e+00]
  HOMO = -0.848812084370755  LUMO = 0.605367346478471
  mo_energy =
[-3.27741102e+01 -1.92905236e+00 -8.48812084e-01 -8.48812084e-01
 -8.48812084e-01  6.05367346e-01  6.05367346e-01  6.05367346e-01
  2.00334092e+00  2.66978060e+00  2.66978060e+00  2.66978060e+00
  8.65651669e+00  8.65651669e+00  8.65651669e+00  1.92876633e+01
  2.80942039e+01  2.80942039e+01  2.80942039e+01  9.36879040e+01
  1.22288052e+02  1.22288052e+02  1.22288052e+02  3.56002126e+02
  1.34934031e+03  5.83575379e+03  3.50983477e+04]
E1 = -182.56729016335458  E_coul = 54.03378216092238
cycle= 4 E= -128.533508002432  delta_E= -1.21e-08  |g|= 6.86e-05  |ddm|= 0.000157
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000179697
diis-c [-5.14126001e-10  9.32044243e-05  5.21385289e-04 -1.25351222e-01
  1.12473663e+00]
  HOMO = -0.848847021097084  LUMO = 0.605359725069719
  mo_energy =
[-3.27741769e+01 -1.92908386e+00 -8.48847021e-01 -8.48847021e-01
 -8.48847021e-01  6.05359725e-01  6.05359725e-01  6.05359725e-01
  2.00331582e+00  2.66975549e+00  2.66975549e+00  2.66975549e+00
  8.65647361e+00  8.65647361e+00  8.65647361e+00  1.92876097e+01
  2.80941466e+01  2.80941466e+01  2.80941466e+01  9.36878394e+01
  1.22287985e+02  1.22287985e+02  1.22287985e+02  3.56002055e+02
  1.34934023e+03  5.83575371e+03  3.50983476e+04]
E1 = -182.56742098232414  E_coul = 54.033912979438384
cycle= 5 E= -128.533508002886  delta_E= -4.54e-10  |g|= 1.98e-06  |ddm|= 2.61e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56742098232414  E_coul = 54.033912979438384
  HOMO = -0.848846414076973  LUMO = 0.605359771319108
  mo_energy =
[-3.27741753e+01 -1.92908299e+00 -8.48846414e-01 -8.48846414e-01
 -8.48846414e-01  6.05359771e-01  6.05359771e-01  6.05359771e-01
  2.00331639e+00  2.66975580e+00  2.66975580e+00  2.66975580e+00
  8.65647444e+00  8.65647444e+00  8.65647444e+00  1.92876111e+01
  2.80941480e+01  2.80941480e+01  2.80941480e+01  9.36878410e+01
  1.22287987e+02  1.22287987e+02  1.22287987e+02  3.56002056e+02
  1.34934023e+03  5.83575371e+03  3.50983476e+04]
E1 = -182.56741513056724  E_coul = 54.03390712768163
Extra cycle  E= -128.533508002886  delta_E= 1.42e-13  |g|= 7.69e-07  |ddm|= 1.28e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498604e+02 1.74905948e+02
 2.04941570e+01 5.69623277e+01 4.85906380e-01 7.82696366e+00
 1.65491740e+00 4.11074025e+00 1.24859397e+01 5.47479657e+01
 2.18489522e-01 1.55985013e+00 6.03553857e-01]
E = -128.5335080028856
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681852        1
[INPUT] 0    0    [1    /1   ]  617.498604461        1
[INPUT] 0    0    [1    /1   ]  174.90594792         1
[INPUT] 0    0    [1    /1   ]  20.4941570385        1
[INPUT] 0    0    [1    /1   ]  56.9623276837        1
[INPUT] 0    0    [1    /1   ]  0.485906380121       1
[INPUT] 0    0    [1    /1   ]  7.82696365902        1
[INPUT] 0    0    [1    /1   ]  1.65491740398        1
[INPUT] 1    0    [1    /1   ]  4.11074025397        1
[INPUT] 1    0    [1    /1   ]  12.4859397456        1
[INPUT] 1    0    [1    /1   ]  54.7479656612        1
[INPUT] 1    0    [1    /1   ]  0.218489521621       1
[INPUT] 1    0    [1    /1   ]  1.55985013251        1
[INPUT] 1    0    [1    /1   ]  0.603553857369       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730071714, 1.0]], [0, [2712.0968185172787, 1.0]], [0, [617.4986044613424, 1.0]], [0, [174.90594791990378, 1.0]], [0, [20.494157038464316, 1.0]], [0, [56.96232768369708, 1.0]], [0, [0.485906380120993, 1.0]], [0, [7.826963659023641, 1.0]], [0, [1.6549174039841386, 1.0]], [1, [4.110740253974021, 1.0]], [1, [12.485939745562584, 1.0]], [1, [54.747965661223716, 1.0]], [1, [0.21848952162069105, 1.0]], [1, [1.5598501325057492, 1.0]], [1, [0.6035538573687802, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681852]
bas 2, expnt(s) = [617.49860446]
bas 3, expnt(s) = [174.90594792]
bas 4, expnt(s) = [20.49415704]
bas 5, expnt(s) = [56.96232768]
bas 6, expnt(s) = [0.48590638]
bas 7, expnt(s) = [7.82696366]
bas 8, expnt(s) = [1.6549174]
bas 9, expnt(s) = [4.11074025]
bas 10, expnt(s) = [12.48593975]
bas 11, expnt(s) = [54.74796566]
bas 12, expnt(s) = [0.21848952]
bas 13, expnt(s) = [1.55985013]
bas 14, expnt(s) = [0.60355386]
CPU time:        60.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498604e+02 3.12962289e+02 1.74905948e+02 1.21511801e+02
 2.04941570e+01 2.43353484e+01 5.69623277e+01 5.23848639e+01
 4.85906380e-01 1.47037962e+00 7.82696366e+00 1.18225188e+01
 1.65491740e+00 3.68635594e+00 4.11074025e+00 1.70759328e+01
 1.24859397e+01 6.84716725e+01 5.47479657e+01 4.34454575e+02
 2.18489522e-01 4.35785384e-01 1.55985013e+00 5.08555066e+00
 6.03553857e-01 1.55195609e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999436247991472
cond(S) = 239.57749775858792
E1 = -183.58177232352992  E_coul = 55.08096089814326
init E= -128.500811425387
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774675150303259  LUMO = 0.617016581341177
  mo_energy =
[-3.25544857e+01 -1.85120860e+00 -7.74675150e-01 -7.74675150e-01
 -7.74675150e-01  6.17016581e-01  6.17016581e-01  6.17016581e-01
  2.05650509e+00  2.71527215e+00  2.71527215e+00  2.71527215e+00
  8.75331646e+00  8.75331646e+00  8.75331646e+00  1.94385491e+01
  2.82546725e+01  2.82546725e+01  2.82546725e+01  9.38945762e+01
  1.22508826e+02  1.22508826e+02  1.22508826e+02  3.56244254e+02
  1.34961479e+03  5.83605735e+03  3.50986718e+04]
E1 = -182.0508427044853  E_coul = 53.520998071363984
cycle= 1 E= -128.529844633121  delta_E= -0.029  |g|= 0.208  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.542634
diis-c [-0.29445205  1.        ]
  HOMO = -0.885147837781292  LUMO = 0.599535946916862
  mo_energy =
[-3.28842688e+01 -1.96748719e+00 -8.85147838e-01 -8.85147838e-01
 -8.85147838e-01  5.99535947e-01  5.99535947e-01  5.99535947e-01
  1.97741380e+00  2.64779452e+00  2.64779452e+00  2.64779452e+00
  8.60894890e+00  8.60894890e+00  8.60894890e+00  1.92117941e+01
  2.80136195e+01  2.80136195e+01  2.80136195e+01  9.35838621e+01
  1.22178389e+02  1.22178389e+02  1.22178389e+02  3.55885098e+02
  1.34921700e+03  5.83562756e+03  3.50982204e+04]
E1 = -182.83162187215413  E_coul = 54.29907697777701
cycle= 2 E= -128.532544894377  delta_E= -0.0027  |g|= 0.106  |ddm|= 0.0699
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.276416
diis-c [-5.81394101e-04  3.36850900e-01  6.63149100e-01]
  HOMO = -0.848630625361122  LUMO = 0.605375165714843
  mo_energy =
[-3.27737721e+01 -1.92891837e+00 -8.48630625e-01 -8.48630625e-01
 -8.48630625e-01  6.05375166e-01  6.05375166e-01  6.05375166e-01
  2.00340270e+00  2.66985250e+00  2.66985250e+00  2.66985250e+00
  8.65667558e+00  8.65667558e+00  8.65667558e+00  1.92878762e+01
  2.80944483e+01  2.80944483e+01  2.80944483e+01  9.36882175e+01
  1.22288401e+02  1.22288401e+02  1.22288401e+02  3.56002544e+02
  1.34934085e+03  5.83575443e+03  3.50983484e+04]
E1 = -182.56703519787465  E_coul = 54.033527207520635
cycle= 3 E= -128.533507990354  delta_E= -0.000963  |g|= 0.000352  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000883559
diis-c [-9.40601947e-08 -1.79406639e-03 -5.22577531e-04  1.00231664e+00]
  HOMO = -0.848812084370755  LUMO = 0.605367346478471
  mo_energy =
[-3.27741102e+01 -1.92905236e+00 -8.48812084e-01 -8.48812084e-01
 -8.48812084e-01  6.05367346e-01  6.05367346e-01  6.05367346e-01
  2.00334092e+00  2.66978060e+00  2.66978060e+00  2.66978060e+00
  8.65651669e+00  8.65651669e+00  8.65651669e+00  1.92876633e+01
  2.80942039e+01  2.80942039e+01  2.80942039e+01  9.36879040e+01
  1.22288052e+02  1.22288052e+02  1.22288052e+02  3.56002126e+02
  1.34934031e+03  5.83575379e+03  3.50983477e+04]
E1 = -182.56729016335458  E_coul = 54.03378216092238
cycle= 4 E= -128.533508002432  delta_E= -1.21e-08  |g|= 6.86e-05  |ddm|= 0.000157
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000179697
diis-c [-5.14126001e-10  9.32044243e-05  5.21385289e-04 -1.25351222e-01
  1.12473663e+00]
  HOMO = -0.848847021097084  LUMO = 0.605359725069719
  mo_energy =
[-3.27741769e+01 -1.92908386e+00 -8.48847021e-01 -8.48847021e-01
 -8.48847021e-01  6.05359725e-01  6.05359725e-01  6.05359725e-01
  2.00331582e+00  2.66975549e+00  2.66975549e+00  2.66975549e+00
  8.65647361e+00  8.65647361e+00  8.65647361e+00  1.92876097e+01
  2.80941466e+01  2.80941466e+01  2.80941466e+01  9.36878394e+01
  1.22287985e+02  1.22287985e+02  1.22287985e+02  3.56002055e+02
  1.34934023e+03  5.83575371e+03  3.50983476e+04]
E1 = -182.56742098232414  E_coul = 54.033912979438384
cycle= 5 E= -128.533508002886  delta_E= -4.54e-10  |g|= 1.98e-06  |ddm|= 2.61e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56742098232414  E_coul = 54.033912979438384
  HOMO = -0.848846414076973  LUMO = 0.605359771319108
  mo_energy =
[-3.27741753e+01 -1.92908299e+00 -8.48846414e-01 -8.48846414e-01
 -8.48846414e-01  6.05359771e-01  6.05359771e-01  6.05359771e-01
  2.00331639e+00  2.66975580e+00  2.66975580e+00  2.66975580e+00
  8.65647444e+00  8.65647444e+00  8.65647444e+00  1.92876111e+01
  2.80941480e+01  2.80941480e+01  2.80941480e+01  9.36878410e+01
  1.22287987e+02  1.22287987e+02  1.22287987e+02  3.56002056e+02
  1.34934023e+03  5.83575371e+03  3.50983476e+04]
E1 = -182.56741513056724  E_coul = 54.03390712768163
Extra cycle  E= -128.533508002886  delta_E= 1.42e-13  |g|= 7.69e-07  |ddm|= 1.28e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.57749775858792
E1 = -182.56741513056724  E_coul = 54.03390712768163
init E= -128.533508002886
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.848846848476664  LUMO = 0.605359692676884
  mo_energy =
[-3.27741765e+01 -1.92908342e+00 -8.48846848e-01 -8.48846848e-01
 -8.48846848e-01  6.05359693e-01  6.05359693e-01  6.05359693e-01
  2.00331609e+00  2.66975552e+00  2.66975552e+00  2.66975552e+00
  8.65647388e+00  8.65647388e+00  8.65647388e+00  1.92876103e+01
  2.80941471e+01  2.80941471e+01  2.80941471e+01  9.36878398e+01
  1.22287986e+02  1.22287986e+02  1.22287986e+02  3.56002055e+02
  1.34934023e+03  5.83575371e+03  3.50983476e+04]
E1 = -182.56741787094117  E_coul = 54.03390986805549
cycle= 1 E= -128.533508002886  delta_E= -8.53e-14  |g|= 3.8e-07  |ddm|= 2.4e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.56741787094117  E_coul = 54.03390986805549
  HOMO = -0.84884665812664  LUMO = 0.605359721875514
  mo_energy =
[-3.27741759e+01 -1.92908321e+00 -8.48846658e-01 -8.48846658e-01
 -8.48846658e-01  6.05359722e-01  6.05359722e-01  6.05359722e-01
  2.00331623e+00  2.66975563e+00  2.66975563e+00  2.66975563e+00
  8.65647413e+00  8.65647413e+00  8.65647413e+00  1.92876107e+01
  2.80941476e+01  2.80941476e+01  2.80941476e+01  9.36878404e+01
  1.22287986e+02  1.22287986e+02  1.22287986e+02  3.56002055e+02
  1.34934023e+03  5.83575371e+03  3.50983476e+04]
E1 = -182.56741642122054  E_coul = 54.033908418334484
Extra cycle  E= -128.533508002886  delta_E= -3.69e-13  |g|= 1.95e-07  |ddm|= 1.42e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498604e+02 1.74905948e+02
 2.04941570e+01 5.69623277e+01 4.85906380e-01 7.82696366e+00
 1.65491740e+00 4.11074025e+00 1.24859397e+01 5.47479657e+01
 2.18489522e-01 1.55985013e+00 6.03553857e-01]
grad_E = [ 1.21837660e-11 -4.27785547e-10  1.73134124e-09  7.20254589e-08
 -9.11610968e-06 -1.20492179e-06 -4.16908842e-03  3.09524812e-05
  1.11425459e-03  2.19679317e-04 -1.74524075e-03  1.04592482e-04
  9.44538753e-04 -9.22854867e-04  2.37261617e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681846        1
[INPUT] 0    0    [1    /1   ]  617.49860594         1
[INPUT] 0    0    [1    /1   ]  174.905923355        1
[INPUT] 0    0    [1    /1   ]  20.493868329         1
[INPUT] 0    0    [1    /1   ]  56.9625424706        1
[INPUT] 0    0    [1    /1   ]  0.485146663231       1
[INPUT] 0    0    [1    /1   ]  7.82673215801        1
[INPUT] 0    0    [1    /1   ]  1.65570840746        1
[INPUT] 1    0    [1    /1   ]  4.15830831159        1
[INPUT] 1    0    [1    /1   ]  12.5739923051        1
[INPUT] 1    0    [1    /1   ]  54.7422043797        1
[INPUT] 1    0    [1    /1   ]  0.227770108184       1
[INPUT] 1    0    [1    /1   ]  1.59259466752        1
[INPUT] 1    0    [1    /1   ]  0.628861854609       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730072475, 1.0]], [0, [2712.0968184610397, 1.0]], [0, [617.4986059398755, 1.0]], [0, [174.90592335470865, 1.0]], [0, [20.493868328962016, 1.0]], [0, [56.962542470591096, 1.0]], [0, [0.48514666323137223, 1.0]], [0, [7.826732158011538, 1.0]], [0, [1.655708407457998, 1.0]], [1, [4.158308311594967, 1.0]], [1, [12.573992305072089, 1.0]], [1, [54.7422043797298, 1.0]], [1, [0.22777010818411061, 1.0]], [1, [1.5925946675233655, 1.0]], [1, [0.6288618546085943, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681846]
bas 2, expnt(s) = [617.49860594]
bas 3, expnt(s) = [174.90592335]
bas 4, expnt(s) = [20.49386833]
bas 5, expnt(s) = [56.96254247]
bas 6, expnt(s) = [0.48514666]
bas 7, expnt(s) = [7.82673216]
bas 8, expnt(s) = [1.65570841]
bas 9, expnt(s) = [4.15830831]
bas 10, expnt(s) = [12.57399231]
bas 11, expnt(s) = [54.74220438]
bas 12, expnt(s) = [0.22777011]
bas 13, expnt(s) = [1.59259467]
bas 14, expnt(s) = [0.62886185]
CPU time:        63.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498606e+02 3.12962290e+02 1.74905923e+02 1.21511788e+02
 2.04938683e+01 2.43350913e+01 5.69625425e+01 5.23850121e+01
 4.85146663e-01 1.46865508e+00 7.82673216e+00 1.18222565e+01
 1.65570841e+00 3.68767734e+00 4.15830831e+00 1.73232850e+01
 1.25739923e+01 6.90757932e+01 5.47422044e+01 4.34397428e+02
 2.27770108e-01 4.59045044e-01 1.59259467e+00 5.21934451e+00
 6.28861855e-01 1.63372313e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999406000604722
cond(S) = 239.55376540011397
E1 = -183.58196271275168  E_coul = 55.08107593386259
init E= -128.500886778889
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774681895713972  LUMO = 0.647414655641167
  mo_energy =
[-3.25544502e+01 -1.85120084e+00 -7.74681896e-01 -7.74681896e-01
 -7.74681896e-01  6.47414656e-01  6.47414656e-01  6.47414656e-01
  2.05462314e+00  2.82544388e+00  2.82544388e+00  2.82544388e+00
  8.99107451e+00  8.99107451e+00  8.99107451e+00  1.94378678e+01
  2.87075994e+01  2.87075994e+01  2.87075994e+01  9.38935534e+01
  1.23096189e+02  1.23096189e+02  1.23096189e+02  3.56243191e+02
  1.34961392e+03  5.83605660e+03  3.50986712e+04]
E1 = -182.05321984596586  E_coul = 53.52328580630167
cycle= 1 E= -128.529934039664  delta_E= -0.029  |g|= 0.208  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.54405
diis-c [-0.29599036  1.        ]
  HOMO = -0.885008215046287  LUMO = 0.628798732827381
  mo_energy =
[-3.28838112e+01 -1.96725655e+00 -8.85008215e-01 -8.85008215e-01
 -8.85008215e-01  6.28798733e-01  6.28798733e-01  6.28798733e-01
  1.97573579e+00  2.75626638e+00  2.75626638e+00  2.75626638e+00
  8.84588974e+00  8.84588974e+00  8.84588974e+00  1.92113768e+01
  2.84664738e+01  2.84664738e+01  2.84664738e+01  9.35832351e+01
  1.22766271e+02  1.22766271e+02  1.22766271e+02  3.55884487e+02
  1.34921660e+03  5.83562729e+03  3.50982202e+04]
E1 = -182.83235120077038  E_coul = 54.29972215247148
cycle= 2 E= -128.532629048299  delta_E= -0.0027  |g|= 0.106  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.276825
diis-c [-5.82147408e-04  3.36599554e-01  6.63400446e-01]
  HOMO = -0.848560407625391  LUMO = 0.635008064041156
  mo_energy =
[-3.27734795e+01 -1.92876350e+00 -8.48560408e-01 -8.48560408e-01
 -8.48560408e-01  6.35008064e-01  6.35008064e-01  6.35008064e-01
  2.00166253e+00  2.77887182e+00  2.77887182e+00  2.77887182e+00
  8.89387666e+00  8.89387666e+00  8.89387666e+00  1.92873354e+01
  2.85472996e+01  2.85472996e+01  2.85472996e+01  9.36874321e+01
  1.22876088e+02  1.22876088e+02  1.22876088e+02  3.56001759e+02
  1.34934027e+03  5.83575398e+03  3.50983481e+04]
E1 = -182.56844284577076  E_coul = 54.03485476482722
cycle= 3 E= -128.533588080944  delta_E= -0.000959  |g|= 0.000365  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0009302
diis-c [-9.85924335e-08 -1.82271151e-03 -4.16185368e-04  1.00223890e+00]
  HOMO = -0.84874455827021  LUMO = 0.634998769164362
  mo_energy =
[-3.27738247e+01 -1.92889603e+00 -8.48744558e-01 -8.48744558e-01
 -8.48744558e-01  6.34998769e-01  6.34998769e-01  6.34998769e-01
  2.00160196e+00  2.77879584e+00  2.77879584e+00  2.77879584e+00
  8.89371376e+00  8.89371376e+00  8.89371376e+00  1.92871188e+01
  2.85470502e+01  2.85470502e+01  2.85470502e+01  9.36871119e+01
  1.22875732e+02  1.22875732e+02  1.22875732e+02  3.56001332e+02
  1.34933971e+03  5.83575332e+03  3.50983474e+04]
E1 = -182.56872538617313  E_coul = 54.03513729246628
cycle= 4 E= -128.533588093707  delta_E= -1.28e-08  |g|= 7.1e-05  |ddm|= 0.000159
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000189762
diis-c [-5.40427439e-10  1.04158337e-04  5.48219236e-04 -1.30587109e-01
  1.12993473e+00]
  HOMO = -0.848780148267102  LUMO = 0.634990681476734
  mo_energy =
[-3.27738936e+01 -1.92892719e+00 -8.48780148e-01 -8.48780148e-01
 -8.48780148e-01  6.34990681e-01  6.34990681e-01  6.34990681e-01
  2.00157728e+00  2.77876996e+00  2.77876996e+00  2.77876996e+00
  8.89366978e+00  8.89366978e+00  8.89366978e+00  1.92870641e+01
  2.85469914e+01  2.85469914e+01  2.85469914e+01  9.36870453e+01
  1.22875663e+02  1.22875663e+02  1.22875663e+02  3.56001258e+02
  1.34933963e+03  5.83575323e+03  3.50983473e+04]
E1 = -182.56886399607603  E_coul = 54.03527590188859
cycle= 5 E= -128.533588094187  delta_E= -4.81e-10  |g|= 2.12e-06  |ddm|= 2.52e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56886399607603  E_coul = 54.03527590188859
  HOMO = -0.848779399556804  LUMO = 0.634990783317617
  mo_energy =
[-3.27738918e+01 -1.92892610e+00 -8.48779400e-01 -8.48779400e-01
 -8.48779400e-01  6.34990783e-01  6.34990783e-01  6.34990783e-01
  2.00157804e+00  2.77877041e+00  2.77877041e+00  2.77877041e+00
  8.89367080e+00  8.89367080e+00  8.89367080e+00  1.92870658e+01
  2.85469931e+01  2.85469931e+01  2.85469931e+01  9.36870470e+01
  1.22875665e+02  1.22875665e+02  1.22875665e+02  3.56001259e+02
  1.34933963e+03  5.83575323e+03  3.50983473e+04]
E1 = -182.56885818781643  E_coul = 54.03527009362873
Extra cycle  E= -128.533588094188  delta_E= -2.56e-13  |g|= 7.79e-07  |ddm|= 1.2e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498606e+02 1.74905923e+02
 2.04938683e+01 5.69625425e+01 4.85146663e-01 7.82673216e+00
 1.65570841e+00 4.15830831e+00 1.25739923e+01 5.47422044e+01
 2.27770108e-01 1.59259467e+00 6.28861855e-01]
E = -128.5335880941877
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681846        1
[INPUT] 0    0    [1    /1   ]  617.49860594         1
[INPUT] 0    0    [1    /1   ]  174.905923355        1
[INPUT] 0    0    [1    /1   ]  20.493868329         1
[INPUT] 0    0    [1    /1   ]  56.9625424706        1
[INPUT] 0    0    [1    /1   ]  0.485146663231       1
[INPUT] 0    0    [1    /1   ]  7.82673215801        1
[INPUT] 0    0    [1    /1   ]  1.65570840746        1
[INPUT] 1    0    [1    /1   ]  4.15830831159        1
[INPUT] 1    0    [1    /1   ]  12.5739923051        1
[INPUT] 1    0    [1    /1   ]  54.7422043797        1
[INPUT] 1    0    [1    /1   ]  0.227770108184       1
[INPUT] 1    0    [1    /1   ]  1.59259466752        1
[INPUT] 1    0    [1    /1   ]  0.628861854609       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730072475, 1.0]], [0, [2712.0968184610397, 1.0]], [0, [617.4986059398755, 1.0]], [0, [174.90592335470865, 1.0]], [0, [20.493868328962016, 1.0]], [0, [56.962542470591096, 1.0]], [0, [0.48514666323137223, 1.0]], [0, [7.826732158011538, 1.0]], [0, [1.655708407457998, 1.0]], [1, [4.158308311594967, 1.0]], [1, [12.573992305072089, 1.0]], [1, [54.7422043797298, 1.0]], [1, [0.22777010818411061, 1.0]], [1, [1.5925946675233655, 1.0]], [1, [0.6288618546085943, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681846]
bas 2, expnt(s) = [617.49860594]
bas 3, expnt(s) = [174.90592335]
bas 4, expnt(s) = [20.49386833]
bas 5, expnt(s) = [56.96254247]
bas 6, expnt(s) = [0.48514666]
bas 7, expnt(s) = [7.82673216]
bas 8, expnt(s) = [1.65570841]
bas 9, expnt(s) = [4.15830831]
bas 10, expnt(s) = [12.57399231]
bas 11, expnt(s) = [54.74220438]
bas 12, expnt(s) = [0.22777011]
bas 13, expnt(s) = [1.59259467]
bas 14, expnt(s) = [0.62886185]
CPU time:        63.65
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498606e+02 3.12962290e+02 1.74905923e+02 1.21511788e+02
 2.04938683e+01 2.43350913e+01 5.69625425e+01 5.23850121e+01
 4.85146663e-01 1.46865508e+00 7.82673216e+00 1.18222565e+01
 1.65570841e+00 3.68767734e+00 4.15830831e+00 1.73232850e+01
 1.25739923e+01 6.90757932e+01 5.47422044e+01 4.34397428e+02
 2.27770108e-01 4.59045044e-01 1.59259467e+00 5.21934451e+00
 6.28861855e-01 1.63372313e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999406000604722
cond(S) = 239.55376540011397
E1 = -183.58196271275168  E_coul = 55.08107593386259
init E= -128.500886778889
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774681895713972  LUMO = 0.647414655641167
  mo_energy =
[-3.25544502e+01 -1.85120084e+00 -7.74681896e-01 -7.74681896e-01
 -7.74681896e-01  6.47414656e-01  6.47414656e-01  6.47414656e-01
  2.05462314e+00  2.82544388e+00  2.82544388e+00  2.82544388e+00
  8.99107451e+00  8.99107451e+00  8.99107451e+00  1.94378678e+01
  2.87075994e+01  2.87075994e+01  2.87075994e+01  9.38935534e+01
  1.23096189e+02  1.23096189e+02  1.23096189e+02  3.56243191e+02
  1.34961392e+03  5.83605660e+03  3.50986712e+04]
E1 = -182.05321984596586  E_coul = 53.52328580630167
cycle= 1 E= -128.529934039664  delta_E= -0.029  |g|= 0.208  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.54405
diis-c [-0.29599036  1.        ]
  HOMO = -0.885008215046287  LUMO = 0.628798732827381
  mo_energy =
[-3.28838112e+01 -1.96725655e+00 -8.85008215e-01 -8.85008215e-01
 -8.85008215e-01  6.28798733e-01  6.28798733e-01  6.28798733e-01
  1.97573579e+00  2.75626638e+00  2.75626638e+00  2.75626638e+00
  8.84588974e+00  8.84588974e+00  8.84588974e+00  1.92113768e+01
  2.84664738e+01  2.84664738e+01  2.84664738e+01  9.35832351e+01
  1.22766271e+02  1.22766271e+02  1.22766271e+02  3.55884487e+02
  1.34921660e+03  5.83562729e+03  3.50982202e+04]
E1 = -182.83235120077038  E_coul = 54.29972215247148
cycle= 2 E= -128.532629048299  delta_E= -0.0027  |g|= 0.106  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.276825
diis-c [-5.82147408e-04  3.36599554e-01  6.63400446e-01]
  HOMO = -0.848560407625391  LUMO = 0.635008064041156
  mo_energy =
[-3.27734795e+01 -1.92876350e+00 -8.48560408e-01 -8.48560408e-01
 -8.48560408e-01  6.35008064e-01  6.35008064e-01  6.35008064e-01
  2.00166253e+00  2.77887182e+00  2.77887182e+00  2.77887182e+00
  8.89387666e+00  8.89387666e+00  8.89387666e+00  1.92873354e+01
  2.85472996e+01  2.85472996e+01  2.85472996e+01  9.36874321e+01
  1.22876088e+02  1.22876088e+02  1.22876088e+02  3.56001759e+02
  1.34934027e+03  5.83575398e+03  3.50983481e+04]
E1 = -182.56844284577076  E_coul = 54.03485476482722
cycle= 3 E= -128.533588080944  delta_E= -0.000959  |g|= 0.000365  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0009302
diis-c [-9.85924335e-08 -1.82271151e-03 -4.16185368e-04  1.00223890e+00]
  HOMO = -0.84874455827021  LUMO = 0.634998769164362
  mo_energy =
[-3.27738247e+01 -1.92889603e+00 -8.48744558e-01 -8.48744558e-01
 -8.48744558e-01  6.34998769e-01  6.34998769e-01  6.34998769e-01
  2.00160196e+00  2.77879584e+00  2.77879584e+00  2.77879584e+00
  8.89371376e+00  8.89371376e+00  8.89371376e+00  1.92871188e+01
  2.85470502e+01  2.85470502e+01  2.85470502e+01  9.36871119e+01
  1.22875732e+02  1.22875732e+02  1.22875732e+02  3.56001332e+02
  1.34933971e+03  5.83575332e+03  3.50983474e+04]
E1 = -182.56872538617313  E_coul = 54.03513729246628
cycle= 4 E= -128.533588093707  delta_E= -1.28e-08  |g|= 7.1e-05  |ddm|= 0.000159
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000189762
diis-c [-5.40427439e-10  1.04158337e-04  5.48219236e-04 -1.30587109e-01
  1.12993473e+00]
  HOMO = -0.848780148267102  LUMO = 0.634990681476734
  mo_energy =
[-3.27738936e+01 -1.92892719e+00 -8.48780148e-01 -8.48780148e-01
 -8.48780148e-01  6.34990681e-01  6.34990681e-01  6.34990681e-01
  2.00157728e+00  2.77876996e+00  2.77876996e+00  2.77876996e+00
  8.89366978e+00  8.89366978e+00  8.89366978e+00  1.92870641e+01
  2.85469914e+01  2.85469914e+01  2.85469914e+01  9.36870453e+01
  1.22875663e+02  1.22875663e+02  1.22875663e+02  3.56001258e+02
  1.34933963e+03  5.83575323e+03  3.50983473e+04]
E1 = -182.56886399607603  E_coul = 54.03527590188859
cycle= 5 E= -128.533588094187  delta_E= -4.81e-10  |g|= 2.12e-06  |ddm|= 2.52e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.56886399607603  E_coul = 54.03527590188859
  HOMO = -0.848779399556804  LUMO = 0.634990783317617
  mo_energy =
[-3.27738918e+01 -1.92892610e+00 -8.48779400e-01 -8.48779400e-01
 -8.48779400e-01  6.34990783e-01  6.34990783e-01  6.34990783e-01
  2.00157804e+00  2.77877041e+00  2.77877041e+00  2.77877041e+00
  8.89367080e+00  8.89367080e+00  8.89367080e+00  1.92870658e+01
  2.85469931e+01  2.85469931e+01  2.85469931e+01  9.36870470e+01
  1.22875665e+02  1.22875665e+02  1.22875665e+02  3.56001259e+02
  1.34933963e+03  5.83575323e+03  3.50983473e+04]
E1 = -182.56885818781643  E_coul = 54.03527009362873
Extra cycle  E= -128.533588094188  delta_E= -2.56e-13  |g|= 7.79e-07  |ddm|= 1.2e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.55376540011397
E1 = -182.56885818781643  E_coul = 54.03527009362873
init E= -128.533588094188
    CPU time for initialize scf      0.26 sec, wall time      0.25 sec
  HOMO = -0.848779828003507  LUMO = 0.6349907054506
  mo_energy =
[-3.27738930e+01 -1.92892650e+00 -8.48779828e-01 -8.48779828e-01
 -8.48779828e-01  6.34990705e-01  6.34990705e-01  6.34990705e-01
  2.00157777e+00  2.77877014e+00  2.77877014e+00  2.77877014e+00
  8.89367025e+00  8.89367025e+00  8.89367025e+00  1.92870650e+01
  2.85469922e+01  2.85469922e+01  2.85469922e+01  9.36870459e+01
  1.22875663e+02  1.22875663e+02  1.22875663e+02  3.56001258e+02
  1.34933963e+03  5.83575323e+03  3.50983473e+04]
E1 = -182.5688610694891  E_coul = 54.035272975301446
cycle= 1 E= -128.533588094188  delta_E= 5.68e-14  |g|= 3.99e-07  |ddm|= 2.2e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5688610694891  E_coul = 54.035272975301446
  HOMO = -0.848779627336182  LUMO = 0.634990739205558
  mo_energy =
[-3.27738924e+01 -1.92892628e+00 -8.48779627e-01 -8.48779627e-01
 -8.48779627e-01  6.34990739e-01  6.34990739e-01  6.34990739e-01
  2.00157792e+00  2.77877026e+00  2.77877026e+00  2.77877026e+00
  8.89367051e+00  8.89367051e+00  8.89367051e+00  1.92870654e+01
  2.85469926e+01  2.85469926e+01  2.85469926e+01  9.36870464e+01
  1.22875664e+02  1.22875664e+02  1.22875664e+02  3.56001259e+02
  1.34933963e+03  5.83575323e+03  3.50983473e+04]
E1 = -182.56885957960682  E_coul = 54.03527148541886
Extra cycle  E= -128.533588094188  delta_E= -3.13e-13  |g|= 2.01e-07  |ddm|= 1.51e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.32 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498606e+02 1.74905923e+02
 2.04938683e+01 5.69625425e+01 4.85146663e-01 7.82673216e+00
 1.65570841e+00 4.15830831e+00 1.25739923e+01 5.47422044e+01
 2.27770108e-01 1.59259467e+00 6.28861855e-01]
grad_E = [ 2.62091494e-11 -1.18846273e-09  1.60407301e-08 -1.05650137e-07
 -1.66728302e-05 -2.59003902e-08 -6.26181070e-03  4.51848337e-05
  1.71572827e-03  5.03849967e-04 -1.66962521e-03  8.72742944e-05
  6.75702486e-04 -2.01127310e-03  4.63550861e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681835        1
[INPUT] 0    0    [1    /1   ]  617.498608792        1
[INPUT] 0    0    [1    /1   ]  174.905875445        1
[INPUT] 0    0    [1    /1   ]  20.4933008285        1
[INPUT] 0    0    [1    /1   ]  56.9629639957        1
[INPUT] 0    0    [1    /1   ]  0.485002073318       1
[INPUT] 0    0    [1    /1   ]  7.82626619582        1
[INPUT] 0    0    [1    /1   ]  1.65715105103        1
[INPUT] 1    0    [1    /1   ]  4.23686418223        1
[INPUT] 1    0    [1    /1   ]  12.7580513987        1
[INPUT] 1    0    [1    /1   ]  54.7302682017        1
[INPUT] 1    0    [1    /1   ]  0.238368263352       1
[INPUT] 1    0    [1    /1   ]  1.63587098032        1
[INPUT] 1    0    [1    /1   ]  0.660701321826       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730073904, 1.0]], [0, [2712.0968183535683, 1.0]], [0, [617.4986087918817, 1.0]], [0, [174.90587544541634, 1.0]], [0, [20.493300828541063, 1.0]], [0, [56.96296399568973, 1.0]], [0, [0.48500207331814765, 1.0]], [0, [7.826266195818277, 1.0]], [0, [1.6571510510308454, 1.0]], [1, [4.2368641822291755, 1.0]], [1, [12.758051398663813, 1.0]], [1, [54.73026820168228, 1.0]], [1, [0.23836826335225939, 1.0]], [1, [1.6358709803162212, 1.0]], [1, [0.660701321826038, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681835]
bas 2, expnt(s) = [617.49860879]
bas 3, expnt(s) = [174.90587545]
bas 4, expnt(s) = [20.49330083]
bas 5, expnt(s) = [56.962964]
bas 6, expnt(s) = [0.48500207]
bas 7, expnt(s) = [7.8262662]
bas 8, expnt(s) = [1.65715105]
bas 9, expnt(s) = [4.23686418]
bas 10, expnt(s) = [12.7580514]
bas 11, expnt(s) = [54.7302682]
bas 12, expnt(s) = [0.23836826]
bas 13, expnt(s) = [1.63587098]
bas 14, expnt(s) = [0.66070132]
CPU time:        67.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498609e+02 3.12962291e+02 1.74905875e+02 1.21511763e+02
 2.04933008e+01 2.43345859e+01 5.69629640e+01 5.23853028e+01
 4.85002073e-01 1.46832678e+00 7.82626620e+00 1.18217286e+01
 1.65715105e+00 3.69008693e+00 4.23686418e+00 1.77333208e+01
 1.27580514e+01 7.03420186e+01 5.47302682e+01 4.34279034e+02
 2.38368263e-01 4.85897800e-01 1.63587098e+00 5.39722723e+00
 6.60701322e-01 1.73776426e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999358075529104
cond(S) = 239.59054588145386
E1 = -183.58223262472436  E_coul = 55.08118913405366
init E= -128.501043490671
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774700140132423  LUMO = 0.683498344376515
  mo_energy =
[-3.25544095e+01 -1.85119397e+00 -7.74700140e-01 -7.74700140e-01
 -7.74700140e-01  6.83498344e-01  6.83498344e-01  6.83498344e-01
  2.05541909e+00  2.96133685e+00  2.96133685e+00  2.96133685e+00
  9.30396957e+00  9.30396957e+00  9.30396957e+00  1.94421523e+01
  2.94113380e+01  2.94113380e+01  2.94113380e+01  9.38962946e+01
  1.24121939e+02  1.24121939e+02  1.24121939e+02  3.56245222e+02
  1.34961583e+03  5.83605829e+03  3.50986726e+04]
E1 = -182.05755755549413  E_coul = 53.52745189832769
cycle= 1 E= -128.530105657166  delta_E= -0.0291  |g|= 0.207  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.544716
diis-c [-0.29671559  1.        ]
  HOMO = -0.884735403636933  LUMO = 0.663536502358081
  mo_energy =
[-3.28829900e+01 -1.96688400e+00 -8.84735404e-01 -8.84735404e-01
 -8.84735404e-01  6.63536502e-01  6.63536502e-01  6.63536502e-01
  1.97678151e+00  2.89007339e+00  2.89007339e+00  2.89007339e+00
  9.15755596e+00  9.15755596e+00  9.15755596e+00  1.92161990e+01
  2.91698284e+01  2.91698284e+01  2.91698284e+01  9.35867156e+01
  1.23792913e+02  1.23792913e+02  1.23792913e+02  3.55887364e+02
  1.34921941e+03  5.83562989e+03  3.50982225e+04]
E1 = -182.83381996547217  E_coul = 54.301030394354946
cycle= 2 E= -128.532789571117  delta_E= -0.00268  |g|= 0.105  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.276735
diis-c [-5.84055373e-04  3.36250877e-01  6.63749123e-01]
  HOMO = -0.84841164807432  LUMO = 0.670182442947593
  mo_energy =
[-3.27729683e+01 -1.92852551e+00 -8.48411648e-01 -8.48411648e-01
 -8.48411648e-01  6.70182443e-01  6.70182443e-01  6.70182443e-01
  2.00262272e+00  2.91334733e+00  2.91334733e+00  2.91334733e+00
  9.20593218e+00  9.20593218e+00  9.20593218e+00  1.92919276e+01
  2.92507370e+01  2.92507370e+01  2.92507370e+01  9.36906148e+01
  1.23902387e+02  1.23902387e+02  1.23902387e+02  3.56004310e+02
  1.34934273e+03  5.83575622e+03  3.50983500e+04]
E1 = -182.57102857843066  E_coul = 54.03728698495235
cycle= 3 E= -128.533741593478  delta_E= -0.000952  |g|= 0.000382  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000985733
diis-c [-1.03615028e-07 -1.87169146e-03 -3.13049051e-04  1.00218474e+00]
  HOMO = -0.848601018633086  LUMO = 0.670170415480592
  mo_energy =
[-3.27733263e+01 -1.92866087e+00 -8.48601019e-01 -8.48601019e-01
 -8.48601019e-01  6.70170415e-01  6.70170415e-01  6.70170415e-01
  2.00255967e+00  2.91326416e+00  2.91326416e+00  2.91326416e+00
  9.20576085e+00  9.20576085e+00  9.20576085e+00  1.92917026e+01
  2.92504769e+01  2.92504769e+01  2.92504769e+01  9.36902824e+01
  1.23902017e+02  1.23902017e+02  1.23902017e+02  3.56003867e+02
  1.34934215e+03  5.83575555e+03  3.50983493e+04]
E1 = -182.57134701993638  E_coul = 54.03760541266799
cycle= 4 E= -128.533741607268  delta_E= -1.38e-08  |g|= 7.32e-05  |ddm|= 0.000163
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000198087
diis-c [-5.51677559e-10  1.14029018e-04  5.65391985e-04 -1.34130675e-01
  1.13345125e+00]
  HOMO = -0.848637311787284  LUMO = 0.670161702671011
  mo_energy =
[-3.27733975e+01 -1.92869213e+00 -8.48637312e-01 -8.48637312e-01
 -8.48637312e-01  6.70161703e-01  6.70161703e-01  6.70161703e-01
  2.00253499e+00  2.91323721e+00  2.91323721e+00  2.91323721e+00
  9.20571573e+00  9.20571573e+00  9.20571573e+00  1.92916467e+01
  2.92504166e+01  2.92504166e+01  2.92504166e+01  9.36902137e+01
  1.23901946e+02  1.23901946e+02  1.23901946e+02  3.56003790e+02
  1.34934207e+03  5.83575546e+03  3.50983492e+04]
E1 = -182.57149194104184  E_coul = 54.03775033326637
cycle= 5 E= -128.533741607775  delta_E= -5.07e-10  |g|= 2.25e-06  |ddm|= 2.47e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57149194104184  E_coul = 54.03775033326637
  HOMO = -0.848636440151829  LUMO = 0.670161856888482
  mo_energy =
[-3.27733954e+01 -1.92869087e+00 -8.48636440e-01 -8.48636440e-01
 -8.48636440e-01  6.70161857e-01  6.70161857e-01  6.70161857e-01
  2.00253589e+00  2.91323779e+00  2.91323779e+00  2.91323779e+00
  9.20571692e+00  9.20571692e+00  9.20571692e+00  1.92916486e+01
  2.92504184e+01  2.92504184e+01  2.92504184e+01  9.36902156e+01
  1.23901948e+02  1.23901948e+02  1.23901948e+02  3.56003792e+02
  1.34934207e+03  5.83575546e+03  3.50983492e+04]
E1 = -182.57148600608394  E_coul = 54.03774439830797
Extra cycle  E= -128.533741607776  delta_E= -4.83e-13  |g|= 8.1e-07  |ddm|= 1.19e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498609e+02 1.74905875e+02
 2.04933008e+01 5.69629640e+01 4.85002073e-01 7.82626620e+00
 1.65715105e+00 4.23686418e+00 1.27580514e+01 5.47302682e+01
 2.38368263e-01 1.63587098e+00 6.60701322e-01]
E = -128.53374160777597
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681835        1
[INPUT] 0    0    [1    /1   ]  617.498608792        1
[INPUT] 0    0    [1    /1   ]  174.905875445        1
[INPUT] 0    0    [1    /1   ]  20.4933008285        1
[INPUT] 0    0    [1    /1   ]  56.9629639957        1
[INPUT] 0    0    [1    /1   ]  0.485002073318       1
[INPUT] 0    0    [1    /1   ]  7.82626619582        1
[INPUT] 0    0    [1    /1   ]  1.65715105103        1
[INPUT] 1    0    [1    /1   ]  4.23686418223        1
[INPUT] 1    0    [1    /1   ]  12.7580513987        1
[INPUT] 1    0    [1    /1   ]  54.7302682017        1
[INPUT] 1    0    [1    /1   ]  0.238368263352       1
[INPUT] 1    0    [1    /1   ]  1.63587098032        1
[INPUT] 1    0    [1    /1   ]  0.660701321826       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730073904, 1.0]], [0, [2712.0968183535683, 1.0]], [0, [617.4986087918817, 1.0]], [0, [174.90587544541634, 1.0]], [0, [20.493300828541063, 1.0]], [0, [56.96296399568973, 1.0]], [0, [0.48500207331814765, 1.0]], [0, [7.826266195818277, 1.0]], [0, [1.6571510510308454, 1.0]], [1, [4.2368641822291755, 1.0]], [1, [12.758051398663813, 1.0]], [1, [54.73026820168228, 1.0]], [1, [0.23836826335225939, 1.0]], [1, [1.6358709803162212, 1.0]], [1, [0.660701321826038, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681835]
bas 2, expnt(s) = [617.49860879]
bas 3, expnt(s) = [174.90587545]
bas 4, expnt(s) = [20.49330083]
bas 5, expnt(s) = [56.962964]
bas 6, expnt(s) = [0.48500207]
bas 7, expnt(s) = [7.8262662]
bas 8, expnt(s) = [1.65715105]
bas 9, expnt(s) = [4.23686418]
bas 10, expnt(s) = [12.7580514]
bas 11, expnt(s) = [54.7302682]
bas 12, expnt(s) = [0.23836826]
bas 13, expnt(s) = [1.63587098]
bas 14, expnt(s) = [0.66070132]
CPU time:        67.49
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498609e+02 3.12962291e+02 1.74905875e+02 1.21511763e+02
 2.04933008e+01 2.43345859e+01 5.69629640e+01 5.23853028e+01
 4.85002073e-01 1.46832678e+00 7.82626620e+00 1.18217286e+01
 1.65715105e+00 3.69008693e+00 4.23686418e+00 1.77333208e+01
 1.27580514e+01 7.03420186e+01 5.47302682e+01 4.34279034e+02
 2.38368263e-01 4.85897800e-01 1.63587098e+00 5.39722723e+00
 6.60701322e-01 1.73776426e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999358075529104
cond(S) = 239.59054588145386
E1 = -183.58223262472436  E_coul = 55.08118913405366
init E= -128.501043490671
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774700140132423  LUMO = 0.683498344376515
  mo_energy =
[-3.25544095e+01 -1.85119397e+00 -7.74700140e-01 -7.74700140e-01
 -7.74700140e-01  6.83498344e-01  6.83498344e-01  6.83498344e-01
  2.05541909e+00  2.96133685e+00  2.96133685e+00  2.96133685e+00
  9.30396957e+00  9.30396957e+00  9.30396957e+00  1.94421523e+01
  2.94113380e+01  2.94113380e+01  2.94113380e+01  9.38962946e+01
  1.24121939e+02  1.24121939e+02  1.24121939e+02  3.56245222e+02
  1.34961583e+03  5.83605829e+03  3.50986726e+04]
E1 = -182.05755755549413  E_coul = 53.52745189832769
cycle= 1 E= -128.530105657166  delta_E= -0.0291  |g|= 0.207  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.544716
diis-c [-0.29671559  1.        ]
  HOMO = -0.884735403636933  LUMO = 0.663536502358081
  mo_energy =
[-3.28829900e+01 -1.96688400e+00 -8.84735404e-01 -8.84735404e-01
 -8.84735404e-01  6.63536502e-01  6.63536502e-01  6.63536502e-01
  1.97678151e+00  2.89007339e+00  2.89007339e+00  2.89007339e+00
  9.15755596e+00  9.15755596e+00  9.15755596e+00  1.92161990e+01
  2.91698284e+01  2.91698284e+01  2.91698284e+01  9.35867156e+01
  1.23792913e+02  1.23792913e+02  1.23792913e+02  3.55887364e+02
  1.34921941e+03  5.83562989e+03  3.50982225e+04]
E1 = -182.83381996547217  E_coul = 54.301030394354946
cycle= 2 E= -128.532789571117  delta_E= -0.00268  |g|= 0.105  |ddm|= 0.0698
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.276735
diis-c [-5.84055373e-04  3.36250877e-01  6.63749123e-01]
  HOMO = -0.84841164807432  LUMO = 0.670182442947593
  mo_energy =
[-3.27729683e+01 -1.92852551e+00 -8.48411648e-01 -8.48411648e-01
 -8.48411648e-01  6.70182443e-01  6.70182443e-01  6.70182443e-01
  2.00262272e+00  2.91334733e+00  2.91334733e+00  2.91334733e+00
  9.20593218e+00  9.20593218e+00  9.20593218e+00  1.92919276e+01
  2.92507370e+01  2.92507370e+01  2.92507370e+01  9.36906148e+01
  1.23902387e+02  1.23902387e+02  1.23902387e+02  3.56004310e+02
  1.34934273e+03  5.83575622e+03  3.50983500e+04]
E1 = -182.57102857843066  E_coul = 54.03728698495235
cycle= 3 E= -128.533741593478  delta_E= -0.000952  |g|= 0.000382  |ddm|= 0.0242
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000985733
diis-c [-1.03615028e-07 -1.87169146e-03 -3.13049051e-04  1.00218474e+00]
  HOMO = -0.848601018633086  LUMO = 0.670170415480592
  mo_energy =
[-3.27733263e+01 -1.92866087e+00 -8.48601019e-01 -8.48601019e-01
 -8.48601019e-01  6.70170415e-01  6.70170415e-01  6.70170415e-01
  2.00255967e+00  2.91326416e+00  2.91326416e+00  2.91326416e+00
  9.20576085e+00  9.20576085e+00  9.20576085e+00  1.92917026e+01
  2.92504769e+01  2.92504769e+01  2.92504769e+01  9.36902824e+01
  1.23902017e+02  1.23902017e+02  1.23902017e+02  3.56003867e+02
  1.34934215e+03  5.83575555e+03  3.50983493e+04]
E1 = -182.57134701993638  E_coul = 54.03760541266799
cycle= 4 E= -128.533741607268  delta_E= -1.38e-08  |g|= 7.32e-05  |ddm|= 0.000163
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000198087
diis-c [-5.51677559e-10  1.14029018e-04  5.65391985e-04 -1.34130675e-01
  1.13345125e+00]
  HOMO = -0.848637311787284  LUMO = 0.670161702671011
  mo_energy =
[-3.27733975e+01 -1.92869213e+00 -8.48637312e-01 -8.48637312e-01
 -8.48637312e-01  6.70161703e-01  6.70161703e-01  6.70161703e-01
  2.00253499e+00  2.91323721e+00  2.91323721e+00  2.91323721e+00
  9.20571573e+00  9.20571573e+00  9.20571573e+00  1.92916467e+01
  2.92504166e+01  2.92504166e+01  2.92504166e+01  9.36902137e+01
  1.23901946e+02  1.23901946e+02  1.23901946e+02  3.56003790e+02
  1.34934207e+03  5.83575546e+03  3.50983492e+04]
E1 = -182.57149194104184  E_coul = 54.03775033326637
cycle= 5 E= -128.533741607775  delta_E= -5.07e-10  |g|= 2.25e-06  |ddm|= 2.47e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57149194104184  E_coul = 54.03775033326637
  HOMO = -0.848636440151829  LUMO = 0.670161856888482
  mo_energy =
[-3.27733954e+01 -1.92869087e+00 -8.48636440e-01 -8.48636440e-01
 -8.48636440e-01  6.70161857e-01  6.70161857e-01  6.70161857e-01
  2.00253589e+00  2.91323779e+00  2.91323779e+00  2.91323779e+00
  9.20571692e+00  9.20571692e+00  9.20571692e+00  1.92916486e+01
  2.92504184e+01  2.92504184e+01  2.92504184e+01  9.36902156e+01
  1.23901948e+02  1.23901948e+02  1.23901948e+02  3.56003792e+02
  1.34934207e+03  5.83575546e+03  3.50983492e+04]
E1 = -182.57148600608394  E_coul = 54.03774439830797
Extra cycle  E= -128.533741607776  delta_E= -4.83e-13  |g|= 8.1e-07  |ddm|= 1.19e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.59054588145386
E1 = -182.57148600608394  E_coul = 54.03774439830797
init E= -128.533741607776
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.848636874884698  LUMO = 0.670161775736748
  mo_energy =
[-3.27733967e+01 -1.92869127e+00 -8.48636875e-01 -8.48636875e-01
 -8.48636875e-01  6.70161776e-01  6.70161776e-01  6.70161776e-01
  2.00253563e+00  2.91323751e+00  2.91323751e+00  2.91323751e+00
  9.20571636e+00  9.20571636e+00  9.20571636e+00  1.92916478e+01
  2.92504175e+01  2.92504175e+01  2.92504175e+01  9.36902144e+01
  1.23901947e+02  1.23901947e+02  1.23901947e+02  3.56003790e+02
  1.34934207e+03  5.83575546e+03  3.50983492e+04]
E1 = -182.57148906392047  E_coul = 54.03774745614461
cycle= 1 E= -128.533741607776  delta_E= 1.14e-13  |g|= 4.23e-07  |ddm|= 2.3e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57148906392047  E_coul = 54.03774745614461
  HOMO = -0.848636661471455  LUMO = 0.670161814943165
  mo_energy =
[-3.27733961e+01 -1.92869103e+00 -8.48636661e-01 -8.48636661e-01
 -8.48636661e-01  6.70161815e-01  6.70161815e-01  6.70161815e-01
  2.00253579e+00  2.91323765e+00  2.91323765e+00  2.91323765e+00
  9.20571664e+00  9.20571664e+00  9.20571664e+00  1.92916482e+01
  2.92504180e+01  2.92504180e+01  2.92504180e+01  9.36902150e+01
  1.23901948e+02  1.23901948e+02  1.23901948e+02  3.56003791e+02
  1.34934207e+03  5.83575546e+03  3.50983492e+04]
E1 = -182.57148750600672  E_coul = 54.03774589823075
Extra cycle  E= -128.533741607776  delta_E= -1.14e-13  |g|= 2.11e-07  |ddm|= 1.61e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498609e+02 1.74905875e+02
 2.04933008e+01 5.69629640e+01 4.85002073e-01 7.82626620e+00
 1.65715105e+00 4.23686418e+00 1.27580514e+01 5.47302682e+01
 2.38368263e-01 1.63587098e+00 6.60701322e-01]
grad_E = [ 4.03628089e-11 -1.95061375e-09  3.02713829e-08 -2.73246863e-07
 -2.23853418e-05  9.74011111e-07 -7.38940417e-03  5.39302487e-05
  2.10526863e-03  7.26786988e-04 -1.43151016e-03  4.72458729e-05
 -4.27410051e-04 -3.26376109e-03  7.45758549e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681819        1
[INPUT] 0    0    [1    /1   ]  617.498613295        1
[INPUT] 0    0    [1    /1   ]  174.905799132        1
[INPUT] 0    0    [1    /1   ]  20.4923925088        1
[INPUT] 0    0    [1    /1   ]  56.9636389114        1
[INPUT] 0    0    [1    /1   ]  0.486138992475       1
[INPUT] 0    0    [1    /1   ]  7.8255061963         1
[INPUT] 0    0    [1    /1   ]  1.65930939484        1
[INPUT] 1    0    [1    /1   ]  4.34843587493        1
[INPUT] 1    0    [1    /1   ]  13.064884403         1
[INPUT] 1    0    [1    /1   ]  54.7105047358        1
[INPUT] 1    0    [1    /1   ]  0.2455254448         1
[INPUT] 1    0    [1    /1   ]  1.68007354357        1
[INPUT] 1    0    [1    /1   ]  0.687689040367       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730076113, 1.0]], [0, [2712.0968181852363, 1.0]], [0, [617.4986132947284, 1.0]], [0, [174.9057991324302, 1.0]], [0, [20.492392508849484, 1.0]], [0, [56.96363891140486, 1.0]], [0, [0.48613899247485565, 1.0]], [0, [7.82550619629833, 1.0]], [0, [1.6593093948426858, 1.0]], [1, [4.348435874934541, 1.0]], [1, [13.064884402952886, 1.0]], [1, [54.71050473577644, 1.0]], [1, [0.24552544479954969, 1.0]], [1, [1.6800735435714131, 1.0]], [1, [0.6876890403665606, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681819]
bas 2, expnt(s) = [617.49861329]
bas 3, expnt(s) = [174.90579913]
bas 4, expnt(s) = [20.49239251]
bas 5, expnt(s) = [56.96363891]
bas 6, expnt(s) = [0.48613899]
bas 7, expnt(s) = [7.8255062]
bas 8, expnt(s) = [1.65930939]
bas 9, expnt(s) = [4.34843587]
bas 10, expnt(s) = [13.0648844]
bas 11, expnt(s) = [54.71050474]
bas 12, expnt(s) = [0.24552544]
bas 13, expnt(s) = [1.68007354]
bas 14, expnt(s) = [0.68768904]
CPU time:        70.69
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498613e+02 3.12962292e+02 1.74905799e+02 1.21511724e+02
 2.04923925e+01 2.43337770e+01 5.69636389e+01 5.23857683e+01
 4.86138992e-01 1.47090751e+00 7.82550620e+00 1.18208676e+01
 1.65930939e+00 3.69369093e+00 4.34843587e+00 1.83189564e+01
 1.30648844e+01 7.24630078e+01 5.47105047e+01 4.34083016e+02
 2.45525445e-01 5.04202536e-01 1.68007354e+00 5.58013568e+00
 6.87689040e-01 1.82694100e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999314379319635
cond(S) = 239.73235957042314
E1 = -183.58252060443894  E_coul = 55.0812273218696
init E= -128.501293282569
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774735666446735  LUMO = 0.710295383151748
  mo_energy =
[-3.25543827e+01 -1.85119511e+00 -7.74735666e-01 -7.74735666e-01
 -7.74735666e-01  7.10295383e-01  7.10295383e-01  7.10295383e-01
  2.06122630e+00  3.07491127e+00  3.07491127e+00  3.07491127e+00
  9.61260975e+00  9.61260975e+00  9.61260975e+00  1.94545598e+01
  3.03135333e+01  3.03135333e+01  3.03135333e+01  9.39053365e+01
  1.25609324e+02  1.25609324e+02  1.25609324e+02  3.56252500e+02
  1.34962243e+03  5.83606409e+03  3.50986773e+04]
E1 = -182.06204759693406  E_coul = 53.53168855467531
cycle= 1 E= -128.530359042259  delta_E= -0.0291  |g|= 0.207  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.544174
diis-c [-0.29612549  1.        ]
  HOMO = -0.884462330505486  LUMO = 0.689286684881463
  mo_energy =
[-3.28821269e+01 -1.96655890e+00 -8.84462331e-01 -8.84462331e-01
 -8.84462331e-01  6.89286685e-01  6.89286685e-01  6.89286685e-01
  1.98269196e+00  3.00170114e+00  3.00170114e+00  3.00170114e+00
  9.46442063e+00  9.46442063e+00  9.46442063e+00  1.92291976e+01
  3.00708528e+01  3.00708528e+01  3.00708528e+01  9.35965515e+01
  1.25281214e+02  1.25281214e+02  1.25281214e+02  3.55895574e+02
  1.34922701e+03  5.83563672e+03  3.50982283e+04]
E1 = -182.83543755318502  E_coul = 54.30240745243267
cycle= 2 E= -128.533030100752  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0699
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.276134
diis-c [-5.87653862e-04  3.35980685e-01  6.64019315e-01]
  HOMO = -0.848266214692103  LUMO = 0.696264369296338
  mo_energy =
[-3.27724333e+01 -1.92833808e+00 -8.48266215e-01 -8.48266215e-01
 -8.48266215e-01  6.96264369e-01  6.96264369e-01  6.96264369e-01
  2.00847757e+00  3.02559088e+00  3.02559088e+00  3.02559088e+00
  9.51336563e+00  9.51336563e+00  9.51336563e+00  1.93046839e+01
  3.01521093e+01  3.01521093e+01  3.01521093e+01  9.37001344e+01
  1.25390340e+02  1.25390340e+02  1.25390340e+02  3.56012175e+02
  1.34934997e+03  5.83576268e+03  3.50983555e+04]
E1 = -182.5736479409127  E_coul = 54.03967256434297
cycle= 3 E= -128.53397537657  delta_E= -0.000945  |g|= 0.000402  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103179
diis-c [-1.06640796e-07 -1.93881403e-03 -2.71061227e-04  1.00220988e+00]
  HOMO = -0.848465159892926  LUMO = 0.696247658233386
  mo_energy =
[-3.27728118e+01 -1.92848605e+00 -8.48465160e-01 -8.48465160e-01
 -8.48465160e-01  6.96247658e-01  6.96247658e-01  6.96247658e-01
  2.00840361e+00  3.02549593e+00  3.02549593e+00  3.02549593e+00
  9.51317865e+00  9.51317865e+00  9.51317865e+00  1.93044424e+01
  3.01518300e+01  3.01518300e+01  3.01518300e+01  9.36997820e+01
  1.25389950e+02  1.25389950e+02  1.25389950e+02  3.56011709e+02
  1.34934937e+03  5.83576197e+03  3.50983547e+04]
E1 = -182.57399689403692  E_coul = 54.040021502195664
cycle= 4 E= -128.533975391841  delta_E= -1.53e-08  |g|= 7.43e-05  |ddm|= 0.000175
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000199077
diis-c [-5.13491477e-10  1.12600254e-04  5.54580249e-04 -1.30930330e-01
  1.13026315e+00]
  HOMO = -0.84850230499737  LUMO = 0.696238180375029
  mo_energy =
[-3.27728843e+01 -1.92851888e+00 -8.48502305e-01 -8.48502305e-01
 -8.48502305e-01  6.96238180e-01  6.96238180e-01  6.96238180e-01
  2.00837751e+00  3.02546746e+00  3.02546746e+00  3.02546746e+00
  9.51313189e+00  9.51313189e+00  9.51313189e+00  1.93043851e+01
  3.01517681e+01  3.01517681e+01  3.01517681e+01  9.36997119e+01
  1.25389877e+02  1.25389877e+02  1.25389877e+02  3.56011631e+02
  1.34934928e+03  5.83576188e+03  3.50983546e+04]
E1 = -182.57414175555297  E_coul = 54.04016636319506
cycle= 5 E= -128.533975392358  delta_E= -5.17e-10  |g|= 2.09e-06  |ddm|= 2.58e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57414175555297  E_coul = 54.04016636319506
  HOMO = -0.848501482600053  LUMO = 0.69623832755588
  mo_energy =
[-3.27728823e+01 -1.92851773e+00 -8.48501483e-01 -8.48501483e-01
 -8.48501483e-01  6.96238328e-01  6.96238328e-01  6.96238328e-01
  2.00837832e+00  3.02546801e+00  3.02546801e+00  3.02546801e+00
  9.51313303e+00  9.51313303e+00  9.51313303e+00  1.93043869e+01
  3.01517699e+01  3.01517699e+01  3.01517699e+01  9.36997138e+01
  1.25389879e+02  1.25389879e+02  1.25389879e+02  3.56011632e+02
  1.34934928e+03  5.83576188e+03  3.50983546e+04]
E1 = -182.57413574934603  E_coul = 54.040160356988046
Extra cycle  E= -128.533975392358  delta_E= -5.68e-14  |g|= 8.08e-07  |ddm|= 1.09e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498613e+02 1.74905799e+02
 2.04923925e+01 5.69636389e+01 4.86138992e-01 7.82550620e+00
 1.65930939e+00 4.34843587e+00 1.30648844e+01 5.47105047e+01
 2.45525445e-01 1.68007354e+00 6.87689040e-01]
E = -128.53397539235797
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681819        1
[INPUT] 0    0    [1    /1   ]  617.498613295        1
[INPUT] 0    0    [1    /1   ]  174.905799132        1
[INPUT] 0    0    [1    /1   ]  20.4923925088        1
[INPUT] 0    0    [1    /1   ]  56.9636389114        1
[INPUT] 0    0    [1    /1   ]  0.486138992475       1
[INPUT] 0    0    [1    /1   ]  7.8255061963         1
[INPUT] 0    0    [1    /1   ]  1.65930939484        1
[INPUT] 1    0    [1    /1   ]  4.34843587493        1
[INPUT] 1    0    [1    /1   ]  13.064884403         1
[INPUT] 1    0    [1    /1   ]  54.7105047358        1
[INPUT] 1    0    [1    /1   ]  0.2455254448         1
[INPUT] 1    0    [1    /1   ]  1.68007354357        1
[INPUT] 1    0    [1    /1   ]  0.687689040367       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730076113, 1.0]], [0, [2712.0968181852363, 1.0]], [0, [617.4986132947284, 1.0]], [0, [174.9057991324302, 1.0]], [0, [20.492392508849484, 1.0]], [0, [56.96363891140486, 1.0]], [0, [0.48613899247485565, 1.0]], [0, [7.82550619629833, 1.0]], [0, [1.6593093948426858, 1.0]], [1, [4.348435874934541, 1.0]], [1, [13.064884402952886, 1.0]], [1, [54.71050473577644, 1.0]], [1, [0.24552544479954969, 1.0]], [1, [1.6800735435714131, 1.0]], [1, [0.6876890403665606, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681819]
bas 2, expnt(s) = [617.49861329]
bas 3, expnt(s) = [174.90579913]
bas 4, expnt(s) = [20.49239251]
bas 5, expnt(s) = [56.96363891]
bas 6, expnt(s) = [0.48613899]
bas 7, expnt(s) = [7.8255062]
bas 8, expnt(s) = [1.65930939]
bas 9, expnt(s) = [4.34843587]
bas 10, expnt(s) = [13.0648844]
bas 11, expnt(s) = [54.71050474]
bas 12, expnt(s) = [0.24552544]
bas 13, expnt(s) = [1.68007354]
bas 14, expnt(s) = [0.68768904]
CPU time:        71.15
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498613e+02 3.12962292e+02 1.74905799e+02 1.21511724e+02
 2.04923925e+01 2.43337770e+01 5.69636389e+01 5.23857683e+01
 4.86138992e-01 1.47090751e+00 7.82550620e+00 1.18208676e+01
 1.65930939e+00 3.69369093e+00 4.34843587e+00 1.83189564e+01
 1.30648844e+01 7.24630078e+01 5.47105047e+01 4.34083016e+02
 2.45525445e-01 5.04202536e-01 1.68007354e+00 5.58013568e+00
 6.87689040e-01 1.82694100e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999314379319635
cond(S) = 239.73235957042314
E1 = -183.58252060443894  E_coul = 55.0812273218696
init E= -128.501293282569
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774735666446735  LUMO = 0.710295383151748
  mo_energy =
[-3.25543827e+01 -1.85119511e+00 -7.74735666e-01 -7.74735666e-01
 -7.74735666e-01  7.10295383e-01  7.10295383e-01  7.10295383e-01
  2.06122630e+00  3.07491127e+00  3.07491127e+00  3.07491127e+00
  9.61260975e+00  9.61260975e+00  9.61260975e+00  1.94545598e+01
  3.03135333e+01  3.03135333e+01  3.03135333e+01  9.39053365e+01
  1.25609324e+02  1.25609324e+02  1.25609324e+02  3.56252500e+02
  1.34962243e+03  5.83606409e+03  3.50986773e+04]
E1 = -182.06204759693406  E_coul = 53.53168855467531
cycle= 1 E= -128.530359042259  delta_E= -0.0291  |g|= 0.207  |ddm|= 0.16
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.544174
diis-c [-0.29612549  1.        ]
  HOMO = -0.884462330505486  LUMO = 0.689286684881463
  mo_energy =
[-3.28821269e+01 -1.96655890e+00 -8.84462331e-01 -8.84462331e-01
 -8.84462331e-01  6.89286685e-01  6.89286685e-01  6.89286685e-01
  1.98269196e+00  3.00170114e+00  3.00170114e+00  3.00170114e+00
  9.46442063e+00  9.46442063e+00  9.46442063e+00  1.92291976e+01
  3.00708528e+01  3.00708528e+01  3.00708528e+01  9.35965515e+01
  1.25281214e+02  1.25281214e+02  1.25281214e+02  3.55895574e+02
  1.34922701e+03  5.83563672e+03  3.50982283e+04]
E1 = -182.83543755318502  E_coul = 54.30240745243267
cycle= 2 E= -128.533030100752  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0699
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.276134
diis-c [-5.87653862e-04  3.35980685e-01  6.64019315e-01]
  HOMO = -0.848266214692103  LUMO = 0.696264369296338
  mo_energy =
[-3.27724333e+01 -1.92833808e+00 -8.48266215e-01 -8.48266215e-01
 -8.48266215e-01  6.96264369e-01  6.96264369e-01  6.96264369e-01
  2.00847757e+00  3.02559088e+00  3.02559088e+00  3.02559088e+00
  9.51336563e+00  9.51336563e+00  9.51336563e+00  1.93046839e+01
  3.01521093e+01  3.01521093e+01  3.01521093e+01  9.37001344e+01
  1.25390340e+02  1.25390340e+02  1.25390340e+02  3.56012175e+02
  1.34934997e+03  5.83576268e+03  3.50983555e+04]
E1 = -182.5736479409127  E_coul = 54.03967256434297
cycle= 3 E= -128.53397537657  delta_E= -0.000945  |g|= 0.000402  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103179
diis-c [-1.06640796e-07 -1.93881403e-03 -2.71061227e-04  1.00220988e+00]
  HOMO = -0.848465159892926  LUMO = 0.696247658233386
  mo_energy =
[-3.27728118e+01 -1.92848605e+00 -8.48465160e-01 -8.48465160e-01
 -8.48465160e-01  6.96247658e-01  6.96247658e-01  6.96247658e-01
  2.00840361e+00  3.02549593e+00  3.02549593e+00  3.02549593e+00
  9.51317865e+00  9.51317865e+00  9.51317865e+00  1.93044424e+01
  3.01518300e+01  3.01518300e+01  3.01518300e+01  9.36997820e+01
  1.25389950e+02  1.25389950e+02  1.25389950e+02  3.56011709e+02
  1.34934937e+03  5.83576197e+03  3.50983547e+04]
E1 = -182.57399689403692  E_coul = 54.040021502195664
cycle= 4 E= -128.533975391841  delta_E= -1.53e-08  |g|= 7.43e-05  |ddm|= 0.000175
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000199077
diis-c [-5.13491477e-10  1.12600254e-04  5.54580249e-04 -1.30930330e-01
  1.13026315e+00]
  HOMO = -0.84850230499737  LUMO = 0.696238180375029
  mo_energy =
[-3.27728843e+01 -1.92851888e+00 -8.48502305e-01 -8.48502305e-01
 -8.48502305e-01  6.96238180e-01  6.96238180e-01  6.96238180e-01
  2.00837751e+00  3.02546746e+00  3.02546746e+00  3.02546746e+00
  9.51313189e+00  9.51313189e+00  9.51313189e+00  1.93043851e+01
  3.01517681e+01  3.01517681e+01  3.01517681e+01  9.36997119e+01
  1.25389877e+02  1.25389877e+02  1.25389877e+02  3.56011631e+02
  1.34934928e+03  5.83576188e+03  3.50983546e+04]
E1 = -182.57414175555297  E_coul = 54.04016636319506
cycle= 5 E= -128.533975392358  delta_E= -5.17e-10  |g|= 2.09e-06  |ddm|= 2.58e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57414175555297  E_coul = 54.04016636319506
  HOMO = -0.848501482600053  LUMO = 0.69623832755588
  mo_energy =
[-3.27728823e+01 -1.92851773e+00 -8.48501483e-01 -8.48501483e-01
 -8.48501483e-01  6.96238328e-01  6.96238328e-01  6.96238328e-01
  2.00837832e+00  3.02546801e+00  3.02546801e+00  3.02546801e+00
  9.51313303e+00  9.51313303e+00  9.51313303e+00  1.93043869e+01
  3.01517699e+01  3.01517699e+01  3.01517699e+01  9.36997138e+01
  1.25389879e+02  1.25389879e+02  1.25389879e+02  3.56011632e+02
  1.34934928e+03  5.83576188e+03  3.50983546e+04]
E1 = -182.57413574934603  E_coul = 54.040160356988046
Extra cycle  E= -128.533975392358  delta_E= -5.68e-14  |g|= 8.08e-07  |ddm|= 1.09e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.73235957042314
E1 = -182.57413574934603  E_coul = 54.040160356988046
init E= -128.533975392358
    CPU time for initialize scf      0.26 sec, wall time      0.26 sec
  HOMO = -0.848501921858589  LUMO = 0.696238240068595
  mo_energy =
[-3.27728836e+01 -1.92851815e+00 -8.48501922e-01 -8.48501922e-01
 -8.48501922e-01  6.96238240e-01  6.96238240e-01  6.96238240e-01
  2.00837804e+00  3.02546772e+00  3.02546772e+00  3.02546772e+00
  9.51313245e+00  9.51313245e+00  9.51313245e+00  1.93043861e+01
  3.01517689e+01  3.01517689e+01  3.01517689e+01  9.36997126e+01
  1.25389878e+02  1.25389878e+02  1.25389878e+02  3.56011631e+02
  1.34934928e+03  5.83576188e+03  3.50983546e+04]
E1 = -182.574138788347  E_coul = 54.04016339598883
cycle= 1 E= -128.533975392358  delta_E= -1.99e-13  |g|= 4.19e-07  |ddm|= 2.33e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.574138788347  E_coul = 54.04016339598883
  HOMO = -0.84850170961496  LUMO = 0.696238280939424
  mo_energy =
[-3.27728830e+01 -1.92851791e+00 -8.48501710e-01 -8.48501710e-01
 -8.48501710e-01  6.96238281e-01  6.96238281e-01  6.96238281e-01
  2.00837820e+00  3.02546786e+00  3.02546786e+00  3.02546786e+00
  9.51313274e+00  9.51313274e+00  9.51313274e+00  1.93043865e+01
  3.01517694e+01  3.01517694e+01  3.01517694e+01  9.36997132e+01
  1.25389878e+02  1.25389878e+02  1.25389878e+02  3.56011632e+02
  1.34934928e+03  5.83576188e+03  3.50983546e+04]
E1 = -182.5741372316468  E_coul = 54.040161839288906
Extra cycle  E= -128.533975392358  delta_E= 2.84e-13  |g|= 2.1e-07  |ddm|= 1.57e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.33 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498613e+02 1.74905799e+02
 2.04923925e+01 5.69636389e+01 4.86138992e-01 7.82550620e+00
 1.65930939e+00 4.34843587e+00 1.30648844e+01 5.47105047e+01
 2.45525445e-01 1.68007354e+00 6.87689040e-01]
grad_E = [ 4.92899405e-11 -2.42023260e-09  3.88235458e-08 -3.55274792e-07
 -2.21105304e-05  1.21983014e-06 -6.14889345e-03  4.80560662e-05
  1.91776287e-03  8.20399635e-04 -1.01775988e-03 -1.77859404e-05
 -4.11709296e-03 -4.59590825e-03  1.08658214e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681797        1
[INPUT] 0    0    [1    /1   ]  617.498619015        1
[INPUT] 0    0    [1    /1   ]  174.905701477        1
[INPUT] 0    0    [1    /1   ]  20.4912293681        1
[INPUT] 0    0    [1    /1   ]  56.9645064923        1
[INPUT] 0    0    [1    /1   ]  0.488731565647       1
[INPUT] 0    0    [1    /1   ]  7.82451345501        1
[INPUT] 0    0    [1    /1   ]  1.66176432583        1
[INPUT] 1    0    [1    /1   ]  4.48482701914        1
[INPUT] 1    0    [1    /1   ]  13.4680820974        1
[INPUT] 1    0    [1    /1   ]  54.6846877682        1
[INPUT] 1    0    [1    /1   ]  0.246704711416       1
[INPUT] 1    0    [1    /1   ]  1.71502170071        1
[INPUT] 1    0    [1    /1   ]  0.696348727362       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730078867, 1.0]], [0, [2712.0968179729043, 1.0]], [0, [617.4986190154759, 1.0]], [0, [174.90570147749577, 1.0]], [0, [20.49122936808488, 1.0]], [0, [56.96450649228953, 1.0]], [0, [0.4887315656468389, 1.0]], [0, [7.824513455014852, 1.0]], [0, [1.6617643258328718, 1.0]], [1, [4.484827019141052, 1.0]], [1, [13.46808209743816, 1.0]], [1, [54.68468776824941, 1.0]], [1, [0.24670471141572128, 1.0]], [1, [1.7150217007142468, 1.0]], [1, [0.6963487273616558, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681797]
bas 2, expnt(s) = [617.49861902]
bas 3, expnt(s) = [174.90570148]
bas 4, expnt(s) = [20.49122937]
bas 5, expnt(s) = [56.96450649]
bas 6, expnt(s) = [0.48873157]
bas 7, expnt(s) = [7.82451346]
bas 8, expnt(s) = [1.66176433]
bas 9, expnt(s) = [4.48482702]
bas 10, expnt(s) = [13.4680821]
bas 11, expnt(s) = [54.68468777]
bas 12, expnt(s) = [0.24670471]
bas 13, expnt(s) = [1.7150217]
bas 14, expnt(s) = [0.69634873]
CPU time:        74.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498619e+02 3.12962295e+02 1.74905701e+02 1.21511673e+02
 2.04912294e+01 2.43327411e+01 5.69645065e+01 5.23863667e+01
 4.88731566e-01 1.47678685e+00 7.82451346e+00 1.18197429e+01
 1.66176433e+00 3.69778876e+00 4.48482702e+00 1.90399811e+01
 1.34680821e+01 7.52690763e+01 5.46846878e+01 4.33826986e+02
 2.46704711e-01 5.07231477e-01 1.71502170e+00 5.72560544e+00
 6.96348727e-01 1.85574319e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999303403890778
cond(S) = 239.97484772324347
E1 = -183.58285227471768  E_coul = 55.081196552953344
init E= -128.501655721764
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.774783039957177  LUMO = 0.717094133782654
  mo_energy =
[-3.25543820e+01 -1.85119816e+00 -7.74783040e-01 -7.74783040e-01
 -7.74783040e-01  7.17094134e-01  7.17094134e-01  7.17094134e-01
  2.07226448e+00  3.12094779e+00  3.12094779e+00  3.12094779e+00
  9.83039071e+00  9.83039071e+00  9.83039071e+00  1.94742968e+01
  3.12754774e+01  3.12754774e+01  3.12754774e+01  9.39200061e+01
  1.27383536e+02  1.27383536e+02  1.27383536e+02  3.56264473e+02
  1.34963321e+03  5.83607354e+03  3.50986851e+04]
E1 = -182.06616208789242  E_coul = 53.53549452517675
cycle= 1 E= -128.530667562716  delta_E= -0.029  |g|= 0.206  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.542649
diis-c [-0.29446821  1.        ]
  HOMO = -0.884202237479774  LUMO = 0.695802776562578
  mo_energy =
[-3.28813853e+01 -1.96631833e+00 -8.84202237e-01 -8.84202237e-01
 -8.84202237e-01  6.95802777e-01  6.95802777e-01  6.95802777e-01
  1.99366279e+00  3.04660632e+00  3.04660632e+00  3.04660632e+00
  9.68008122e+00  9.68008122e+00  9.68008122e+00  1.92495217e+01
  3.10308920e+01  3.10308920e+01  3.10308920e+01  9.36119372e+01
  1.27056173e+02  1.27056173e+02  1.27056173e+02  3.55908391e+02
  1.34923872e+03  5.83564712e+03  3.50982371e+04]
E1 = -182.83735967542142  E_coul = 54.304033536815666
cycle= 2 E= -128.533326138606  delta_E= -0.00266  |g|= 0.105  |ddm|= 0.0701
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.275261
diis-c [-5.92020137e-04  3.35891196e-01  6.64108804e-01]
  HOMO = -0.848107234825707  LUMO = 0.702866005038553
  mo_energy =
[-3.27719733e+01 -1.92820509e+00 -8.48107235e-01 -8.48107235e-01
 -8.48107235e-01  7.02866005e-01  7.02866005e-01  7.02866005e-01
  2.01944723e+00  3.07085959e+00  3.07085959e+00  3.07085959e+00
  9.72973324e+00  9.72973324e+00  9.72973324e+00  1.93248037e+01
  3.11127699e+01  3.11127699e+01  3.11127699e+01  9.37152478e+01
  1.27165021e+02  1.27165021e+02  1.27165021e+02  3.56024694e+02
  1.34936136e+03  5.83577276e+03  3.50983639e+04]
E1 = -182.57627439631963  E_coul = 54.04200815063961
cycle= 3 E= -128.53426624568  delta_E= -0.00094  |g|= 0.00041  |ddm|= 0.0243
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00103207
diis-c [-1.02810542e-07 -1.98130834e-03 -3.37079490e-04  1.00231839e+00]
  HOMO = -0.848312219925771  LUMO = 0.702846113837447
  mo_energy =
[-3.27723662e+01 -1.92836728e+00 -8.48312220e-01 -8.48312220e-01
 -8.48312220e-01  7.02846114e-01  7.02846114e-01  7.02846114e-01
  2.01936105e+00  3.07075626e+00  3.07075626e+00  3.07075626e+00
  9.72953363e+00  9.72953363e+00  9.72953363e+00  1.93245494e+01
  3.11124752e+01  3.11124752e+01  3.11124752e+01  9.37148813e+01
  1.27164617e+02  1.27164617e+02  1.27164617e+02  3.56024214e+02
  1.34936075e+03  5.83577204e+03  3.50983631e+04]
E1 = -182.5766314177126  E_coul = 54.042365156083314
cycle= 4 E= -128.534266261629  delta_E= -1.59e-08  |g|= 7.28e-05  |ddm|= 0.000184
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188758
diis-c [-4.58881200e-10  9.93587181e-05  5.14899604e-04 -1.21679689e-01
  1.12106543e+00]
  HOMO = -0.848349203393569  LUMO = 0.70283630832094
  mo_energy =
[-3.27724373e+01 -1.92840184e+00 -8.48349203e-01 -8.48349203e-01
 -8.48349203e-01  7.02836308e-01  7.02836308e-01  7.02836308e-01
  2.01933328e+00  3.07072709e+00  3.07072709e+00  3.07072709e+00
  9.72948631e+00  9.72948631e+00  9.72948631e+00  1.93244921e+01
  3.11124135e+01  3.11124135e+01  3.11124135e+01  9.37148124e+01
  1.27164546e+02  1.27164546e+02  1.27164546e+02  3.56024138e+02
  1.34936067e+03  5.83577196e+03  3.50983630e+04]
E1 = -182.5767679677379  E_coul = 54.04250170561857
cycle= 5 E= -128.534266262119  delta_E= -4.9e-10  |g|= 1.79e-06  |ddm|= 2.75e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5767679677379  E_coul = 54.04250170561857
  HOMO = -0.848348568402095  LUMO = 0.702836387644826
  mo_energy =
[-3.27724355e+01 -1.92840104e+00 -8.48348568e-01 -8.48348568e-01
 -8.48348568e-01  7.02836388e-01  7.02836388e-01  7.02836388e-01
  2.01933379e+00  3.07072746e+00  3.07072746e+00  3.07072746e+00
  9.72948722e+00  9.72948722e+00  9.72948722e+00  1.93244936e+01
  3.11124150e+01  3.11124150e+01  3.11124150e+01  9.37148141e+01
  1.27164547e+02  1.27164547e+02  1.27164547e+02  3.56024139e+02
  1.34936067e+03  5.83577196e+03  3.50983630e+04]
E1 = -182.57676184529618  E_coul = 54.04249558317614
Extra cycle  E= -128.53426626212  delta_E= -7.11e-13  |g|= 8.02e-07  |ddm|= 1.06e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498619e+02 1.74905701e+02
 2.04912294e+01 5.69645065e+01 4.88731566e-01 7.82451346e+00
 1.66176433e+00 4.48482702e+00 1.34680821e+01 5.46846878e+01
 2.46704711e-01 1.71502170e+00 6.96348727e-01]
E = -128.53426626212004
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681797        1
[INPUT] 0    0    [1    /1   ]  617.498619015        1
[INPUT] 0    0    [1    /1   ]  174.905701477        1
[INPUT] 0    0    [1    /1   ]  20.4912293681        1
[INPUT] 0    0    [1    /1   ]  56.9645064923        1
[INPUT] 0    0    [1    /1   ]  0.488731565647       1
[INPUT] 0    0    [1    /1   ]  7.82451345501        1
[INPUT] 0    0    [1    /1   ]  1.66176432583        1
[INPUT] 1    0    [1    /1   ]  4.48482701914        1
[INPUT] 1    0    [1    /1   ]  13.4680820974        1
[INPUT] 1    0    [1    /1   ]  54.6846877682        1
[INPUT] 1    0    [1    /1   ]  0.246704711416       1
[INPUT] 1    0    [1    /1   ]  1.71502170071        1
[INPUT] 1    0    [1    /1   ]  0.696348727362       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730078867, 1.0]], [0, [2712.0968179729043, 1.0]], [0, [617.4986190154759, 1.0]], [0, [174.90570147749577, 1.0]], [0, [20.49122936808488, 1.0]], [0, [56.96450649228953, 1.0]], [0, [0.4887315656468389, 1.0]], [0, [7.824513455014852, 1.0]], [0, [1.6617643258328718, 1.0]], [1, [4.484827019141052, 1.0]], [1, [13.46808209743816, 1.0]], [1, [54.68468776824941, 1.0]], [1, [0.24670471141572128, 1.0]], [1, [1.7150217007142468, 1.0]], [1, [0.6963487273616558, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681797]
bas 2, expnt(s) = [617.49861902]
bas 3, expnt(s) = [174.90570148]
bas 4, expnt(s) = [20.49122937]
bas 5, expnt(s) = [56.96450649]
bas 6, expnt(s) = [0.48873157]
bas 7, expnt(s) = [7.82451346]
bas 8, expnt(s) = [1.66176433]
bas 9, expnt(s) = [4.48482702]
bas 10, expnt(s) = [13.4680821]
bas 11, expnt(s) = [54.68468777]
bas 12, expnt(s) = [0.24670471]
bas 13, expnt(s) = [1.7150217]
bas 14, expnt(s) = [0.69634873]
CPU time:        74.67
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498619e+02 3.12962295e+02 1.74905701e+02 1.21511673e+02
 2.04912294e+01 2.43327411e+01 5.69645065e+01 5.23863667e+01
 4.88731566e-01 1.47678685e+00 7.82451346e+00 1.18197429e+01
 1.66176433e+00 3.69778876e+00 4.48482702e+00 1.90399811e+01
 1.34680821e+01 7.52690763e+01 5.46846878e+01 4.33826986e+02
 2.46704711e-01 5.07231477e-01 1.71502170e+00 5.72560544e+00
 6.96348727e-01 1.85574319e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999303403890778
cond(S) = 239.97484772324347
E1 = -183.58285227471768  E_coul = 55.081196552953344
init E= -128.501655721764
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774783039957177  LUMO = 0.717094133782654
  mo_energy =
[-3.25543820e+01 -1.85119816e+00 -7.74783040e-01 -7.74783040e-01
 -7.74783040e-01  7.17094134e-01  7.17094134e-01  7.17094134e-01
  2.07226448e+00  3.12094779e+00  3.12094779e+00  3.12094779e+00
  9.83039071e+00  9.83039071e+00  9.83039071e+00  1.94742968e+01
  3.12754774e+01  3.12754774e+01  3.12754774e+01  9.39200061e+01
  1.27383536e+02  1.27383536e+02  1.27383536e+02  3.56264473e+02
  1.34963321e+03  5.83607354e+03  3.50986851e+04]
E1 = -182.06616208789242  E_coul = 53.53549452517675
cycle= 1 E= -128.530667562716  delta_E= -0.029  |g|= 0.206  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.542649
diis-c [-0.29446821  1.        ]
  HOMO = -0.884202237479774  LUMO = 0.695802776562578
  mo_energy =
[-3.28813853e+01 -1.96631833e+00 -8.84202237e-01 -8.84202237e-01
 -8.84202237e-01  6.95802777e-01  6.95802777e-01  6.95802777e-01
  1.99366279e+00  3.04660632e+00  3.04660632e+00  3.04660632e+00
  9.68008122e+00  9.68008122e+00  9.68008122e+00  1.92495217e+01
  3.10308920e+01  3.10308920e+01  3.10308920e+01  9.36119372e+01
  1.27056173e+02  1.27056173e+02  1.27056173e+02  3.55908391e+02
  1.34923872e+03  5.83564712e+03  3.50982371e+04]
E1 = -182.83735967542142  E_coul = 54.304033536815666
cycle= 2 E= -128.533326138606  delta_E= -0.00266  |g|= 0.105  |ddm|= 0.0701
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.275261
diis-c [-5.92020137e-04  3.35891196e-01  6.64108804e-01]
  HOMO = -0.848107234825707  LUMO = 0.702866005038553
  mo_energy =
[-3.27719733e+01 -1.92820509e+00 -8.48107235e-01 -8.48107235e-01
 -8.48107235e-01  7.02866005e-01  7.02866005e-01  7.02866005e-01
  2.01944723e+00  3.07085959e+00  3.07085959e+00  3.07085959e+00
  9.72973324e+00  9.72973324e+00  9.72973324e+00  1.93248037e+01
  3.11127699e+01  3.11127699e+01  3.11127699e+01  9.37152478e+01
  1.27165021e+02  1.27165021e+02  1.27165021e+02  3.56024694e+02
  1.34936136e+03  5.83577276e+03  3.50983639e+04]
E1 = -182.57627439631963  E_coul = 54.04200815063961
cycle= 3 E= -128.53426624568  delta_E= -0.00094  |g|= 0.00041  |ddm|= 0.0243
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103207
diis-c [-1.02810542e-07 -1.98130834e-03 -3.37079490e-04  1.00231839e+00]
  HOMO = -0.848312219925771  LUMO = 0.702846113837447
  mo_energy =
[-3.27723662e+01 -1.92836728e+00 -8.48312220e-01 -8.48312220e-01
 -8.48312220e-01  7.02846114e-01  7.02846114e-01  7.02846114e-01
  2.01936105e+00  3.07075626e+00  3.07075626e+00  3.07075626e+00
  9.72953363e+00  9.72953363e+00  9.72953363e+00  1.93245494e+01
  3.11124752e+01  3.11124752e+01  3.11124752e+01  9.37148813e+01
  1.27164617e+02  1.27164617e+02  1.27164617e+02  3.56024214e+02
  1.34936075e+03  5.83577204e+03  3.50983631e+04]
E1 = -182.5766314177126  E_coul = 54.042365156083314
cycle= 4 E= -128.534266261629  delta_E= -1.59e-08  |g|= 7.28e-05  |ddm|= 0.000184
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188758
diis-c [-4.58881200e-10  9.93587181e-05  5.14899604e-04 -1.21679689e-01
  1.12106543e+00]
  HOMO = -0.848349203393569  LUMO = 0.70283630832094
  mo_energy =
[-3.27724373e+01 -1.92840184e+00 -8.48349203e-01 -8.48349203e-01
 -8.48349203e-01  7.02836308e-01  7.02836308e-01  7.02836308e-01
  2.01933328e+00  3.07072709e+00  3.07072709e+00  3.07072709e+00
  9.72948631e+00  9.72948631e+00  9.72948631e+00  1.93244921e+01
  3.11124135e+01  3.11124135e+01  3.11124135e+01  9.37148124e+01
  1.27164546e+02  1.27164546e+02  1.27164546e+02  3.56024138e+02
  1.34936067e+03  5.83577196e+03  3.50983630e+04]
E1 = -182.5767679677379  E_coul = 54.04250170561857
cycle= 5 E= -128.534266262119  delta_E= -4.9e-10  |g|= 1.79e-06  |ddm|= 2.75e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5767679677379  E_coul = 54.04250170561857
  HOMO = -0.848348568402095  LUMO = 0.702836387644826
  mo_energy =
[-3.27724355e+01 -1.92840104e+00 -8.48348568e-01 -8.48348568e-01
 -8.48348568e-01  7.02836388e-01  7.02836388e-01  7.02836388e-01
  2.01933379e+00  3.07072746e+00  3.07072746e+00  3.07072746e+00
  9.72948722e+00  9.72948722e+00  9.72948722e+00  1.93244936e+01
  3.11124150e+01  3.11124150e+01  3.11124150e+01  9.37148141e+01
  1.27164547e+02  1.27164547e+02  1.27164547e+02  3.56024139e+02
  1.34936067e+03  5.83577196e+03  3.50983630e+04]
E1 = -182.57676184529618  E_coul = 54.04249558317614
Extra cycle  E= -128.53426626212  delta_E= -7.11e-13  |g|= 8.02e-07  |ddm|= 1.06e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.97484772324347
E1 = -182.57676184529618  E_coul = 54.04249558317614
init E= -128.53426626212
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.848349017154026  LUMO = 0.70283629149632
  mo_energy =
[-3.27724368e+01 -1.92840149e+00 -8.48349017e-01 -8.48349017e-01
 -8.48349017e-01  7.02836291e-01  7.02836291e-01  7.02836291e-01
  2.01933347e+00  3.07072714e+00  3.07072714e+00  3.07072714e+00
  9.72948661e+00  9.72948661e+00  9.72948661e+00  1.93244927e+01
  3.11124141e+01  3.11124141e+01  3.11124141e+01  9.37148129e+01
  1.27164546e+02  1.27164546e+02  1.27164546e+02  3.56024138e+02
  1.34936067e+03  5.83577196e+03  3.50983630e+04]
E1 = -182.57676473949766  E_coul = 54.042498477377464
cycle= 1 E= -128.53426626212  delta_E= -1.42e-13  |g|= 3.98e-07  |ddm|= 2.55e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57676473949766  E_coul = 54.042498477377464
  HOMO = -0.848348815049469  LUMO = 0.70283633003287
  mo_energy =
[-3.27724362e+01 -1.92840128e+00 -8.48348815e-01 -8.48348815e-01
 -8.48348815e-01  7.02836330e-01  7.02836330e-01  7.02836330e-01
  2.01933361e+00  3.07072728e+00  3.07072728e+00  3.07072728e+00
  9.72948689e+00  9.72948689e+00  9.72948689e+00  1.93244932e+01
  3.11124145e+01  3.11124145e+01  3.11124145e+01  9.37148135e+01
  1.27164547e+02  1.27164547e+02  1.27164547e+02  3.56024139e+02
  1.34936067e+03  5.83577196e+03  3.50983630e+04]
E1 = -182.57676322102995  E_coul = 54.04249695891026
Extra cycle  E= -128.53426626212  delta_E= 5.12e-13  |g|= 2.05e-07  |ddm|= 1.46e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498619e+02 1.74905701e+02
 2.04912294e+01 5.69645065e+01 4.88731566e-01 7.82451346e+00
 1.66176433e+00 4.48482702e+00 1.34680821e+01 5.46846878e+01
 2.46704711e-01 1.71502170e+00 6.96348727e-01]
grad_E = [ 4.85947905e-11 -2.35744130e-09  3.72083344e-08 -2.94781549e-07
 -1.32825841e-05  3.30193602e-07 -1.92973284e-03  2.29197417e-05
  9.68359354e-04  6.08479116e-04 -5.17356854e-04 -9.50713316e-05
 -6.34433813e-03 -5.22193136e-03  1.24588606e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.0968177         1
[INPUT] 0    0    [1    /1   ]  617.498626474        1
[INPUT] 0    0    [1    /1   ]  174.905573545        1
[INPUT] 0    0    [1    /1   ]  20.4897077059        1
[INPUT] 0    0    [1    /1   ]  56.9656470097        1
[INPUT] 0    0    [1    /1   ]  0.491614273211       1
[INPUT] 0    0    [1    /1   ]  7.82320222984        1
[INPUT] 0    0    [1    /1   ]  1.66478833535        1
[INPUT] 1    0    [1    /1   ]  4.6751751286         1
[INPUT] 1    0    [1    /1   ]  13.9979279647        1
[INPUT] 1    0    [1    /1   ]  54.6509148323        1
[INPUT] 1    0    [1    /1   ]  0.237202143476       1
[INPUT] 1    0    [1    /1   ]  1.74817614988        1
[INPUT] 1    0    [1    /1   ]  0.677984917362       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008241, 1.0]], [0, [2712.096817697562, 1.0]], [0, [617.49862647423, 1.0]], [0, [174.90557354483394, 1.0]], [0, [20.48970770586714, 1.0]], [0, [56.96564700969644, 1.0]], [0, [0.49161427321121154, 1.0]], [0, [7.8232022298377935, 1.0]], [0, [1.6647883353462944, 1.0]], [1, [4.675175128602728, 1.0]], [1, [13.997927964715746, 1.0]], [1, [54.650914832336355, 1.0]], [1, [0.23720214347584895, 1.0]], [1, [1.7481761498821802, 1.0]], [1, [0.6779849173623761, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.0968177]
bas 2, expnt(s) = [617.49862647]
bas 3, expnt(s) = [174.90557354]
bas 4, expnt(s) = [20.48970771]
bas 5, expnt(s) = [56.96564701]
bas 6, expnt(s) = [0.49161427]
bas 7, expnt(s) = [7.82320223]
bas 8, expnt(s) = [1.66478834]
bas 9, expnt(s) = [4.67517513]
bas 10, expnt(s) = [13.99792796]
bas 11, expnt(s) = [54.65091483]
bas 12, expnt(s) = [0.23720214]
bas 13, expnt(s) = [1.74817615]
bas 14, expnt(s) = [0.67798492]
CPU time:        77.65
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498626e+02 3.12962297e+02 1.74905574e+02 1.21511606e+02
 2.04897077e+01 2.43313859e+01 5.69656470e+01 5.23871533e+01
 4.91614273e-01 1.48331499e+00 7.82320223e+00 1.18182573e+01
 1.66478834e+00 3.70283442e+00 4.67517513e+00 2.00554194e+01
 1.39979280e+01 7.89885398e+01 5.46509148e+01 4.33492101e+02
 2.37202143e-01 4.82928298e-01 1.74817615e+00 5.86429597e+00
 6.77984917e-01 1.79477261e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999352318735093
cond(S) = 240.25055506087526
E1 = -183.58335571215085  E_coul = 55.081214300639836
init E= -128.502141411511
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774843932359003  LUMO = 0.689510325605117
  mo_energy =
[-3.25543830e+01 -1.85118973e+00 -7.74843932e-01 -7.74843932e-01
 -7.74843932e-01  6.89510326e-01  6.89510326e-01  6.89510326e-01
  2.08479484e+00  3.06449207e+00  3.06449207e+00  3.06449207e+00
  9.94946712e+00  9.94946712e+00  9.94946712e+00  1.94970095e+01
  3.23963995e+01  3.23963995e+01  3.23963995e+01  9.39363993e+01
  1.29617088e+02  1.29617088e+02  1.29617088e+02  3.56277679e+02
  1.34964514e+03  5.83608400e+03  3.50986937e+04]
E1 = -182.06600130565522  E_coul = 53.534960005533925
cycle= 1 E= -128.531041300121  delta_E= -0.0289  |g|= 0.206  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540471
diis-c [-0.2921084  1.       ]
  HOMO = -0.884295666407991  LUMO = 0.669113651621054
  mo_energy =
[-3.28814069e+01 -1.96647305e+00 -8.84295666e-01 -8.84295666e-01
 -8.84295666e-01  6.69113652e-01  6.69113652e-01  6.69113652e-01
  2.00576998e+00  2.98969526e+00  2.98969526e+00  2.98969526e+00
  9.79564523e+00  9.79564523e+00  9.79564523e+00  1.92722450e+01
  3.21483676e+01  3.21483676e+01  3.21483676e+01  9.36283255e+01
  1.29289632e+02  1.29289632e+02  1.29289632e+02  3.55921666e+02
  1.34925080e+03  5.83565777e+03  3.50982459e+04]
E1 = -182.8382304241768  E_coul = 54.30453158638427
cycle= 2 E= -128.533698837793  delta_E= -0.00266  |g|= 0.105  |ddm|= 0.0706
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274537
diis-c [-5.98060994e-04  3.36191524e-01  6.63808476e-01]
  HOMO = -0.84816204563481  LUMO = 0.675881073127143
  mo_energy =
[-3.27719284e+01 -1.92831413e+00 -8.48162046e-01 -8.48162046e-01
 -8.48162046e-01  6.75881073e-01  6.75881073e-01  6.75881073e-01
  2.03167694e+00  3.01410519e+00  3.01410519e+00  3.01410519e+00
  9.84651120e+00  9.84651120e+00  9.84651120e+00  1.93475830e+01
  3.22314594e+01  3.22314594e+01  3.22314594e+01  9.37316960e+01
  1.29398574e+02  1.29398574e+02  1.29398574e+02  3.56038035e+02
  1.34937351e+03  5.83578347e+03  3.50983727e+04]
E1 = -182.57654092611264  E_coul = 54.04189922290379
cycle= 3 E= -128.534641703209  delta_E= -0.000943  |g|= 0.000409  |ddm|= 0.0244
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000997666
diis-c [-9.97306314e-08 -1.99669737e-03 -4.80083279e-04  1.00247678e+00]
  HOMO = -0.848370041095071  LUMO = 0.675860771015936
  mo_energy =
[-3.27723283e+01 -1.92848851e+00 -8.48370041e-01 -8.48370041e-01
 -8.48370041e-01  6.75860771e-01  6.75860771e-01  6.75860771e-01
  2.03158043e+00  3.01399796e+00  3.01399796e+00  3.01399796e+00
  9.84630237e+00  9.84630237e+00  9.84630237e+00  1.93473211e+01
  3.22311542e+01  3.22311542e+01  3.22311542e+01  9.37313225e+01
  1.29398163e+02  1.29398163e+02  1.29398163e+02  3.56037550e+02
  1.34937289e+03  5.83578275e+03  3.50983720e+04]
E1 = -182.57688149516594  E_coul = 54.04223977552486
cycle= 4 E= -128.534641719641  delta_E= -1.64e-08  |g|= 7.09e-05  |ddm|= 0.000191
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000173993
diis-c [-4.63258841e-10  8.74168724e-05  4.66402793e-04 -1.14932547e-01
  1.11437873e+00]
  HOMO = -0.848406792775686  LUMO = 0.675851105784871
  mo_energy =
[-3.27723972e+01 -1.92852498e+00 -8.48406793e-01 -8.48406793e-01
 -8.48406793e-01  6.75851106e-01  6.75851106e-01  6.75851106e-01
  2.03155075e+00  3.01396833e+00  3.01396833e+00  3.01396833e+00
  9.84625446e+00  9.84625446e+00  9.84625446e+00  1.93472640e+01
  3.22310930e+01  3.22310930e+01  3.22310930e+01  9.37312555e+01
  1.29398094e+02  1.29398094e+02  1.29398094e+02  3.56037477e+02
  1.34937282e+03  5.83578267e+03  3.50983719e+04]
E1 = -182.5770066673716  E_coul = 54.04236494725197
cycle= 5 E= -128.53464172012  delta_E= -4.79e-10  |g|= 1.98e-06  |ddm|= 3.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5770066673716  E_coul = 54.04236494725197
  HOMO = -0.848406233772343  LUMO = 0.675851121881348
  mo_energy =
[-3.27723952e+01 -1.92852447e+00 -8.48406234e-01 -8.48406234e-01
 -8.48406234e-01  6.75851122e-01  6.75851122e-01  6.75851122e-01
  2.03155098e+00  3.01396858e+00  3.01396858e+00  3.01396858e+00
  9.84625528e+00  9.84625528e+00  9.84625528e+00  1.93472654e+01
  3.22310946e+01  3.22310946e+01  3.22310946e+01  9.37312573e+01
  1.29398096e+02  1.29398096e+02  1.29398096e+02  3.56037479e+02
  1.34937282e+03  5.83578267e+03  3.50983719e+04]
E1 = -182.57699931584114  E_coul = 54.042357595720986
Extra cycle  E= -128.53464172012  delta_E= -5.12e-13  |g|= 9.75e-07  |ddm|= 1.42e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498626e+02 1.74905574e+02
 2.04897077e+01 5.69656470e+01 4.91614273e-01 7.82320223e+00
 1.66478834e+00 4.67517513e+00 1.39979280e+01 5.46509148e+01
 2.37202143e-01 1.74817615e+00 6.77984917e-01]
E = -128.53464172012013
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.0968177         1
[INPUT] 0    0    [1    /1   ]  617.498626474        1
[INPUT] 0    0    [1    /1   ]  174.905573545        1
[INPUT] 0    0    [1    /1   ]  20.4897077059        1
[INPUT] 0    0    [1    /1   ]  56.9656470097        1
[INPUT] 0    0    [1    /1   ]  0.491614273211       1
[INPUT] 0    0    [1    /1   ]  7.82320222984        1
[INPUT] 0    0    [1    /1   ]  1.66478833535        1
[INPUT] 1    0    [1    /1   ]  4.6751751286         1
[INPUT] 1    0    [1    /1   ]  13.9979279647        1
[INPUT] 1    0    [1    /1   ]  54.6509148323        1
[INPUT] 1    0    [1    /1   ]  0.237202143476       1
[INPUT] 1    0    [1    /1   ]  1.74817614988        1
[INPUT] 1    0    [1    /1   ]  0.677984917362       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008241, 1.0]], [0, [2712.096817697562, 1.0]], [0, [617.49862647423, 1.0]], [0, [174.90557354483394, 1.0]], [0, [20.48970770586714, 1.0]], [0, [56.96564700969644, 1.0]], [0, [0.49161427321121154, 1.0]], [0, [7.8232022298377935, 1.0]], [0, [1.6647883353462944, 1.0]], [1, [4.675175128602728, 1.0]], [1, [13.997927964715746, 1.0]], [1, [54.650914832336355, 1.0]], [1, [0.23720214347584895, 1.0]], [1, [1.7481761498821802, 1.0]], [1, [0.6779849173623761, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.0968177]
bas 2, expnt(s) = [617.49862647]
bas 3, expnt(s) = [174.90557354]
bas 4, expnt(s) = [20.48970771]
bas 5, expnt(s) = [56.96564701]
bas 6, expnt(s) = [0.49161427]
bas 7, expnt(s) = [7.82320223]
bas 8, expnt(s) = [1.66478834]
bas 9, expnt(s) = [4.67517513]
bas 10, expnt(s) = [13.99792796]
bas 11, expnt(s) = [54.65091483]
bas 12, expnt(s) = [0.23720214]
bas 13, expnt(s) = [1.74817615]
bas 14, expnt(s) = [0.67798492]
CPU time:        78.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498626e+02 3.12962297e+02 1.74905574e+02 1.21511606e+02
 2.04897077e+01 2.43313859e+01 5.69656470e+01 5.23871533e+01
 4.91614273e-01 1.48331499e+00 7.82320223e+00 1.18182573e+01
 1.66478834e+00 3.70283442e+00 4.67517513e+00 2.00554194e+01
 1.39979280e+01 7.89885398e+01 5.46509148e+01 4.33492101e+02
 2.37202143e-01 4.82928298e-01 1.74817615e+00 5.86429597e+00
 6.77984917e-01 1.79477261e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999352318735093
cond(S) = 240.25055506087526
E1 = -183.58335571215085  E_coul = 55.081214300639836
init E= -128.502141411511
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774843932359003  LUMO = 0.689510325605117
  mo_energy =
[-3.25543830e+01 -1.85118973e+00 -7.74843932e-01 -7.74843932e-01
 -7.74843932e-01  6.89510326e-01  6.89510326e-01  6.89510326e-01
  2.08479484e+00  3.06449207e+00  3.06449207e+00  3.06449207e+00
  9.94946712e+00  9.94946712e+00  9.94946712e+00  1.94970095e+01
  3.23963995e+01  3.23963995e+01  3.23963995e+01  9.39363993e+01
  1.29617088e+02  1.29617088e+02  1.29617088e+02  3.56277679e+02
  1.34964514e+03  5.83608400e+03  3.50986937e+04]
E1 = -182.06600130565522  E_coul = 53.534960005533925
cycle= 1 E= -128.531041300121  delta_E= -0.0289  |g|= 0.206  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540471
diis-c [-0.2921084  1.       ]
  HOMO = -0.884295666407991  LUMO = 0.669113651621054
  mo_energy =
[-3.28814069e+01 -1.96647305e+00 -8.84295666e-01 -8.84295666e-01
 -8.84295666e-01  6.69113652e-01  6.69113652e-01  6.69113652e-01
  2.00576998e+00  2.98969526e+00  2.98969526e+00  2.98969526e+00
  9.79564523e+00  9.79564523e+00  9.79564523e+00  1.92722450e+01
  3.21483676e+01  3.21483676e+01  3.21483676e+01  9.36283255e+01
  1.29289632e+02  1.29289632e+02  1.29289632e+02  3.55921666e+02
  1.34925080e+03  5.83565777e+03  3.50982459e+04]
E1 = -182.8382304241768  E_coul = 54.30453158638427
cycle= 2 E= -128.533698837793  delta_E= -0.00266  |g|= 0.105  |ddm|= 0.0706
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.274537
diis-c [-5.98060994e-04  3.36191524e-01  6.63808476e-01]
  HOMO = -0.84816204563481  LUMO = 0.675881073127143
  mo_energy =
[-3.27719284e+01 -1.92831413e+00 -8.48162046e-01 -8.48162046e-01
 -8.48162046e-01  6.75881073e-01  6.75881073e-01  6.75881073e-01
  2.03167694e+00  3.01410519e+00  3.01410519e+00  3.01410519e+00
  9.84651120e+00  9.84651120e+00  9.84651120e+00  1.93475830e+01
  3.22314594e+01  3.22314594e+01  3.22314594e+01  9.37316960e+01
  1.29398574e+02  1.29398574e+02  1.29398574e+02  3.56038035e+02
  1.34937351e+03  5.83578347e+03  3.50983727e+04]
E1 = -182.57654092611264  E_coul = 54.04189922290379
cycle= 3 E= -128.534641703209  delta_E= -0.000943  |g|= 0.000409  |ddm|= 0.0244
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000997666
diis-c [-9.97306314e-08 -1.99669737e-03 -4.80083279e-04  1.00247678e+00]
  HOMO = -0.848370041095071  LUMO = 0.675860771015936
  mo_energy =
[-3.27723283e+01 -1.92848851e+00 -8.48370041e-01 -8.48370041e-01
 -8.48370041e-01  6.75860771e-01  6.75860771e-01  6.75860771e-01
  2.03158043e+00  3.01399796e+00  3.01399796e+00  3.01399796e+00
  9.84630237e+00  9.84630237e+00  9.84630237e+00  1.93473211e+01
  3.22311542e+01  3.22311542e+01  3.22311542e+01  9.37313225e+01
  1.29398163e+02  1.29398163e+02  1.29398163e+02  3.56037550e+02
  1.34937289e+03  5.83578275e+03  3.50983720e+04]
E1 = -182.57688149516594  E_coul = 54.04223977552486
cycle= 4 E= -128.534641719641  delta_E= -1.64e-08  |g|= 7.09e-05  |ddm|= 0.000191
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000173993
diis-c [-4.63258841e-10  8.74168724e-05  4.66402793e-04 -1.14932547e-01
  1.11437873e+00]
  HOMO = -0.848406792775686  LUMO = 0.675851105784871
  mo_energy =
[-3.27723972e+01 -1.92852498e+00 -8.48406793e-01 -8.48406793e-01
 -8.48406793e-01  6.75851106e-01  6.75851106e-01  6.75851106e-01
  2.03155075e+00  3.01396833e+00  3.01396833e+00  3.01396833e+00
  9.84625446e+00  9.84625446e+00  9.84625446e+00  1.93472640e+01
  3.22310930e+01  3.22310930e+01  3.22310930e+01  9.37312555e+01
  1.29398094e+02  1.29398094e+02  1.29398094e+02  3.56037477e+02
  1.34937282e+03  5.83578267e+03  3.50983719e+04]
E1 = -182.5770066673716  E_coul = 54.04236494725197
cycle= 5 E= -128.53464172012  delta_E= -4.79e-10  |g|= 1.98e-06  |ddm|= 3.05e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5770066673716  E_coul = 54.04236494725197
  HOMO = -0.848406233772343  LUMO = 0.675851121881348
  mo_energy =
[-3.27723952e+01 -1.92852447e+00 -8.48406234e-01 -8.48406234e-01
 -8.48406234e-01  6.75851122e-01  6.75851122e-01  6.75851122e-01
  2.03155098e+00  3.01396858e+00  3.01396858e+00  3.01396858e+00
  9.84625528e+00  9.84625528e+00  9.84625528e+00  1.93472654e+01
  3.22310946e+01  3.22310946e+01  3.22310946e+01  9.37312573e+01
  1.29398096e+02  1.29398096e+02  1.29398096e+02  3.56037479e+02
  1.34937282e+03  5.83578267e+03  3.50983719e+04]
E1 = -182.57699931584114  E_coul = 54.042357595720986
Extra cycle  E= -128.53464172012  delta_E= -5.12e-13  |g|= 9.75e-07  |ddm|= 1.42e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.25055506087526
E1 = -182.57699931584114  E_coul = 54.042357595720986
init E= -128.53464172012
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.848406770703943  LUMO = 0.675851005380205
  mo_energy =
[-3.27723967e+01 -1.92852507e+00 -8.48406771e-01 -8.48406771e-01
 -8.48406771e-01  6.75851005e-01  6.75851005e-01  6.75851005e-01
  2.03155055e+00  3.01396819e+00  3.01396819e+00  3.01396819e+00
  9.84625453e+00  9.84625453e+00  9.84625453e+00  1.93472644e+01
  3.22310934e+01  3.22310934e+01  3.22310934e+01  9.37312559e+01
  1.29398095e+02  1.29398095e+02  1.29398095e+02  3.56037477e+02
  1.34937282e+03  5.83578267e+03  3.50983719e+04]
E1 = -182.57700255735938  E_coul = 54.04236083723913
cycle= 1 E= -128.53464172012  delta_E= -1.14e-13  |g|= 4.48e-07  |ddm|= 3.84e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57700255735938  E_coul = 54.04236083723913
  HOMO = -0.848406543922938  LUMO = 0.675851045456112
  mo_energy =
[-3.27723960e+01 -1.92852484e+00 -8.48406544e-01 -8.48406544e-01
 -8.48406544e-01  6.75851045e-01  6.75851045e-01  6.75851045e-01
  2.03155071e+00  3.01396834e+00  3.01396834e+00  3.01396834e+00
  9.84625485e+00  9.84625485e+00  9.84625485e+00  1.93472649e+01
  3.22310940e+01  3.22310940e+01  3.22310940e+01  9.37312566e+01
  1.29398096e+02  1.29398096e+02  1.29398096e+02  3.56037478e+02
  1.34937282e+03  5.83578267e+03  3.50983719e+04]
E1 = -182.57700080479972  E_coul = 54.042359084679546
Extra cycle  E= -128.53464172012  delta_E= 5.68e-14  |g|= 2.37e-07  |ddm|= 1.59e-07
    CPU time for scf_cycle      0.37 sec, wall time      0.37 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498626e+02 1.74905574e+02
 2.04897077e+01 5.69656470e+01 4.91614273e-01 7.82320223e+00
 1.66478834e+00 4.67517513e+00 1.39979280e+01 5.46509148e+01
 2.37202143e-01 1.74817615e+00 6.77984917e-01]
grad_E = [ 5.19671198e-11 -2.50674848e-09  3.95281995e-08 -2.71606656e-07
 -4.37482277e-06 -4.29740180e-07  2.54188208e-03 -3.86883409e-06
 -1.48735528e-05  1.07561175e-04 -2.37717108e-05 -1.77065666e-04
 -7.31143333e-03 -4.42302806e-03  1.09204092e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681742        1
[INPUT] 0    0    [1    /1   ]  617.498633981        1
[INPUT] 0    0    [1    /1   ]  174.905444436        1
[INPUT] 0    0    [1    /1   ]  20.4881825066        1
[INPUT] 0    0    [1    /1   ]  56.9668012453        1
[INPUT] 0    0    [1    /1   ]  0.493136892296       1
[INPUT] 0    0    [1    /1   ]  7.82187207997        1
[INPUT] 0    0    [1    /1   ]  1.66733354256        1
[INPUT] 1    0    [1    /1   ]  4.89756728628        1
[INPUT] 1    0    [1    /1   ]  14.5224342373        1
[INPUT] 1    0    [1    /1   ]  54.6176284934        1
[INPUT] 1    0    [1    /1   ]  0.22157197218        1
[INPUT] 1    0    [1    /1   ]  1.78778134294        1
[INPUT] 1    0    [1    /1   ]  0.642070830739       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008594, 1.0]], [0, [2712.096817421669, 1.0]], [0, [617.4986339808643, 1.0]], [0, [174.90544443611864, 1.0]], [0, [20.488182506613132, 1.0]], [0, [56.96680124525978, 1.0]], [0, [0.4931368922955054, 1.0]], [0, [7.8218720799714845, 1.0]], [0, [1.6673335425572315, 1.0]], [1, [4.897567286283903, 1.0]], [1, [14.522434237281866, 1.0]], [1, [54.61762849341282, 1.0]], [1, [0.22157197218041588, 1.0]], [1, [1.7877813429419234, 1.0]], [1, [0.6420708307394227, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681742]
bas 2, expnt(s) = [617.49863398]
bas 3, expnt(s) = [174.90544444]
bas 4, expnt(s) = [20.48818251]
bas 5, expnt(s) = [56.96680125]
bas 6, expnt(s) = [0.49313689]
bas 7, expnt(s) = [7.82187208]
bas 8, expnt(s) = [1.66733354]
bas 9, expnt(s) = [4.89756729]
bas 10, expnt(s) = [14.52243424]
bas 11, expnt(s) = [54.61762849]
bas 12, expnt(s) = [0.22157197]
bas 13, expnt(s) = [1.78778134]
bas 14, expnt(s) = [0.64207083]
CPU time:        81.10
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498634e+02 3.12962300e+02 1.74905444e+02 1.21511539e+02
 2.04881825e+01 2.43300275e+01 5.69668012e+01 5.23879494e+01
 4.93136892e-01 1.48675923e+00 7.82187208e+00 1.18167502e+01
 1.66733354e+00 3.70707941e+00 4.89756729e+00 2.12549411e+01
 1.45224342e+01 8.27053618e+01 5.46176285e+01 4.33162091e+02
 2.21571972e-01 4.43483965e-01 1.78778134e+00 6.03083426e+00
 6.42070831e-01 1.67672974e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999402679874267
cond(S) = 240.41371508874877
E1 = -183.5836436049248  E_coul = 55.081265792682295
init E= -128.502377812242
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774875519932938  LUMO = 0.640981688332831
  mo_energy =
[-3.25543719e+01 -1.85118238e+00 -7.74875520e-01 -7.74875520e-01
 -7.74875520e-01  6.40981688e-01  6.40981688e-01  6.40981688e-01
  2.09222067e+00  2.94286310e+00  2.94286310e+00  2.94286310e+00
  1.00253422e+01  1.00253422e+01  1.00253422e+01  1.95115493e+01
  3.35542663e+01  3.35542663e+01  3.35542663e+01  9.39454374e+01
  1.31901900e+02  1.31901900e+02  1.31901900e+02  3.56284429e+02
  1.34965134e+03  5.83608943e+03  3.50986982e+04]
E1 = -182.06353882208535  E_coul = 53.532325601748845
cycle= 1 E= -128.531213220336  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.537553
diis-c [-0.2889636  1.       ]
  HOMO = -0.884533972908962  LUMO = 0.622349591346003
  mo_energy =
[-3.28818121e+01 -1.96676735e+00 -8.84533973e-01 -8.84533973e-01
 -8.84533973e-01  6.22349591e-01  6.22349591e-01  6.22349591e-01
  2.01278478e+00  2.86813916e+00  2.86813916e+00  2.86813916e+00
  9.86712825e+00  9.86712825e+00  9.86712825e+00  1.92865218e+01
  3.33024472e+01  3.33024472e+01  3.33024472e+01  9.36370020e+01
  1.31573920e+02  1.31573920e+02  1.31573920e+02  3.55928068e+02
  1.34925674e+03  5.83566299e+03  3.50982502e+04]
E1 = -182.8384884333068  E_coul = 54.30461105796075
cycle= 2 E= -128.533877375346  delta_E= -0.00266  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273532
diis-c [-6.04217628e-04  3.36570116e-01  6.63429884e-01]
  HOMO = -0.848282525824782  LUMO = 0.628569842295564
  mo_energy =
[-3.27720629e+01 -1.92847500e+00 -8.48282526e-01 -8.48282526e-01
 -8.48282526e-01  6.28569842e-01  6.28569842e-01  6.28569842e-01
  2.03884999e+00  2.89257610e+00  2.89257610e+00  2.89257610e+00
  9.91954999e+00  9.91954999e+00  9.91954999e+00  1.93620673e+01
  3.33869274e+01  3.33869274e+01  3.33869274e+01  9.37406285e+01
  1.31683167e+02  1.31683167e+02  1.31683167e+02  3.56044717e+02
  1.34937974e+03  5.83578898e+03  3.50983773e+04]
E1 = -182.57585601679784  E_coul = 54.041029741319385
cycle= 3 E= -128.534826275478  delta_E= -0.000949  |g|= 0.000366  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000919636
diis-c [-8.24030361e-08 -1.91839856e-03 -5.74265322e-04  1.00249266e+00]
  HOMO = -0.84847243310424  LUMO = 0.628559450799357
  mo_energy =
[-3.27724363e+01 -1.92863116e+00 -8.48472433e-01 -8.48472433e-01
 -8.48472433e-01  6.28559451e-01  6.28559451e-01  6.28559451e-01
  2.03877053e+00  2.89248805e+00  2.89248805e+00  2.89248805e+00
  9.91936018e+00  9.91936018e+00  9.91936018e+00  1.93618296e+01
  3.33866442e+01  3.33866442e+01  3.33866442e+01  9.37402815e+01
  1.31682782e+02  1.31682782e+02  1.31682782e+02  3.56044258e+02
  1.34937915e+03  5.83578829e+03  3.50983765e+04]
E1 = -182.57618405161386  E_coul = 54.04135776434662
cycle= 4 E= -128.534826287267  delta_E= -1.18e-08  |g|= 6.38e-05  |ddm|= 0.000141
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000159509
diis-c [-4.17336906e-10  7.18165431e-05  4.38282950e-04 -1.04589077e-01
  1.10407898e+00]
  HOMO = -0.848505290958333  LUMO = 0.628551720631341
  mo_energy =
[-3.27724985e+01 -1.92866340e+00 -8.48505291e-01 -8.48505291e-01
 -8.48505291e-01  6.28551721e-01  6.28551721e-01  6.28551721e-01
  2.03874453e+00  2.89246200e+00  2.89246200e+00  2.89246200e+00
  9.91931656e+00  9.91931656e+00  9.91931656e+00  1.93617782e+01
  3.33865886e+01  3.33865886e+01  3.33865886e+01  9.37402210e+01
  1.31682720e+02  1.31682720e+02  1.31682720e+02  3.56044193e+02
  1.34937908e+03  5.83578822e+03  3.50983765e+04]
E1 = -182.57630272004693  E_coul = 54.04147643240385
cycle= 5 E= -128.534826287643  delta_E= -3.76e-10  |g|= 1.82e-06  |ddm|= 2.4e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57630272004693  E_coul = 54.04147643240385
  HOMO = -0.848504936324427  LUMO = 0.628551690960564
  mo_energy =
[-3.27724971e+01 -1.92866302e+00 -8.48504936e-01 -8.48504936e-01
 -8.48504936e-01  6.28551691e-01  6.28551691e-01  6.28551691e-01
  2.03874467e+00  2.89246210e+00  2.89246210e+00  2.89246210e+00
  9.91931715e+00  9.91931715e+00  9.91931715e+00  1.93617793e+01
  3.33865898e+01  3.33865898e+01  3.33865898e+01  9.37402223e+01
  1.31682721e+02  1.31682721e+02  1.31682721e+02  3.56044194e+02
  1.34937908e+03  5.83578822e+03  3.50983765e+04]
E1 = -182.5762966087608  E_coul = 54.041470321117444
Extra cycle  E= -128.534826287643  delta_E= -2.56e-13  |g|= 8e-07  |ddm|= 1.41e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498634e+02 1.74905444e+02
 2.04881825e+01 5.69668012e+01 4.93136892e-01 7.82187208e+00
 1.66733354e+00 4.89756729e+00 1.45224342e+01 5.46176285e+01
 2.21571972e-01 1.78778134e+00 6.42070831e-01]
E = -128.53482628764334
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:53:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681742        1
[INPUT] 0    0    [1    /1   ]  617.498633981        1
[INPUT] 0    0    [1    /1   ]  174.905444436        1
[INPUT] 0    0    [1    /1   ]  20.4881825066        1
[INPUT] 0    0    [1    /1   ]  56.9668012453        1
[INPUT] 0    0    [1    /1   ]  0.493136892296       1
[INPUT] 0    0    [1    /1   ]  7.82187207997        1
[INPUT] 0    0    [1    /1   ]  1.66733354256        1
[INPUT] 1    0    [1    /1   ]  4.89756728628        1
[INPUT] 1    0    [1    /1   ]  14.5224342373        1
[INPUT] 1    0    [1    /1   ]  54.6176284934        1
[INPUT] 1    0    [1    /1   ]  0.22157197218        1
[INPUT] 1    0    [1    /1   ]  1.78778134294        1
[INPUT] 1    0    [1    /1   ]  0.642070830739       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008594, 1.0]], [0, [2712.096817421669, 1.0]], [0, [617.4986339808643, 1.0]], [0, [174.90544443611864, 1.0]], [0, [20.488182506613132, 1.0]], [0, [56.96680124525978, 1.0]], [0, [0.4931368922955054, 1.0]], [0, [7.8218720799714845, 1.0]], [0, [1.6673335425572315, 1.0]], [1, [4.897567286283903, 1.0]], [1, [14.522434237281866, 1.0]], [1, [54.61762849341282, 1.0]], [1, [0.22157197218041588, 1.0]], [1, [1.7877813429419234, 1.0]], [1, [0.6420708307394227, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681742]
bas 2, expnt(s) = [617.49863398]
bas 3, expnt(s) = [174.90544444]
bas 4, expnt(s) = [20.48818251]
bas 5, expnt(s) = [56.96680125]
bas 6, expnt(s) = [0.49313689]
bas 7, expnt(s) = [7.82187208]
bas 8, expnt(s) = [1.66733354]
bas 9, expnt(s) = [4.89756729]
bas 10, expnt(s) = [14.52243424]
bas 11, expnt(s) = [54.61762849]
bas 12, expnt(s) = [0.22157197]
bas 13, expnt(s) = [1.78778134]
bas 14, expnt(s) = [0.64207083]
CPU time:        81.67
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498634e+02 3.12962300e+02 1.74905444e+02 1.21511539e+02
 2.04881825e+01 2.43300275e+01 5.69668012e+01 5.23879494e+01
 4.93136892e-01 1.48675923e+00 7.82187208e+00 1.18167502e+01
 1.66733354e+00 3.70707941e+00 4.89756729e+00 2.12549411e+01
 1.45224342e+01 8.27053618e+01 5.46176285e+01 4.33162091e+02
 2.21571972e-01 4.43483965e-01 1.78778134e+00 6.03083426e+00
 6.42070831e-01 1.67672974e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999402679874267
cond(S) = 240.41371508874877
E1 = -183.5836436049248  E_coul = 55.081265792682295
init E= -128.502377812242
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774875519932938  LUMO = 0.640981688332831
  mo_energy =
[-3.25543719e+01 -1.85118238e+00 -7.74875520e-01 -7.74875520e-01
 -7.74875520e-01  6.40981688e-01  6.40981688e-01  6.40981688e-01
  2.09222067e+00  2.94286310e+00  2.94286310e+00  2.94286310e+00
  1.00253422e+01  1.00253422e+01  1.00253422e+01  1.95115493e+01
  3.35542663e+01  3.35542663e+01  3.35542663e+01  9.39454374e+01
  1.31901900e+02  1.31901900e+02  1.31901900e+02  3.56284429e+02
  1.34965134e+03  5.83608943e+03  3.50986982e+04]
E1 = -182.06353882208535  E_coul = 53.532325601748845
cycle= 1 E= -128.531213220336  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.537553
diis-c [-0.2889636  1.       ]
  HOMO = -0.884533972908962  LUMO = 0.622349591346003
  mo_energy =
[-3.28818121e+01 -1.96676735e+00 -8.84533973e-01 -8.84533973e-01
 -8.84533973e-01  6.22349591e-01  6.22349591e-01  6.22349591e-01
  2.01278478e+00  2.86813916e+00  2.86813916e+00  2.86813916e+00
  9.86712825e+00  9.86712825e+00  9.86712825e+00  1.92865218e+01
  3.33024472e+01  3.33024472e+01  3.33024472e+01  9.36370020e+01
  1.31573920e+02  1.31573920e+02  1.31573920e+02  3.55928068e+02
  1.34925674e+03  5.83566299e+03  3.50982502e+04]
E1 = -182.8384884333068  E_coul = 54.30461105796075
cycle= 2 E= -128.533877375346  delta_E= -0.00266  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.273532
diis-c [-6.04217628e-04  3.36570116e-01  6.63429884e-01]
  HOMO = -0.848282525824782  LUMO = 0.628569842295564
  mo_energy =
[-3.27720629e+01 -1.92847500e+00 -8.48282526e-01 -8.48282526e-01
 -8.48282526e-01  6.28569842e-01  6.28569842e-01  6.28569842e-01
  2.03884999e+00  2.89257610e+00  2.89257610e+00  2.89257610e+00
  9.91954999e+00  9.91954999e+00  9.91954999e+00  1.93620673e+01
  3.33869274e+01  3.33869274e+01  3.33869274e+01  9.37406285e+01
  1.31683167e+02  1.31683167e+02  1.31683167e+02  3.56044717e+02
  1.34937974e+03  5.83578898e+03  3.50983773e+04]
E1 = -182.57585601679784  E_coul = 54.041029741319385
cycle= 3 E= -128.534826275478  delta_E= -0.000949  |g|= 0.000366  |ddm|= 0.0245
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000919636
diis-c [-8.24030361e-08 -1.91839856e-03 -5.74265322e-04  1.00249266e+00]
  HOMO = -0.84847243310424  LUMO = 0.628559450799357
  mo_energy =
[-3.27724363e+01 -1.92863116e+00 -8.48472433e-01 -8.48472433e-01
 -8.48472433e-01  6.28559451e-01  6.28559451e-01  6.28559451e-01
  2.03877053e+00  2.89248805e+00  2.89248805e+00  2.89248805e+00
  9.91936018e+00  9.91936018e+00  9.91936018e+00  1.93618296e+01
  3.33866442e+01  3.33866442e+01  3.33866442e+01  9.37402815e+01
  1.31682782e+02  1.31682782e+02  1.31682782e+02  3.56044258e+02
  1.34937915e+03  5.83578829e+03  3.50983765e+04]
E1 = -182.57618405161386  E_coul = 54.04135776434662
cycle= 4 E= -128.534826287267  delta_E= -1.18e-08  |g|= 6.38e-05  |ddm|= 0.000141
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000159509
diis-c [-4.17336906e-10  7.18165431e-05  4.38282950e-04 -1.04589077e-01
  1.10407898e+00]
  HOMO = -0.848505290958333  LUMO = 0.628551720631341
  mo_energy =
[-3.27724985e+01 -1.92866340e+00 -8.48505291e-01 -8.48505291e-01
 -8.48505291e-01  6.28551721e-01  6.28551721e-01  6.28551721e-01
  2.03874453e+00  2.89246200e+00  2.89246200e+00  2.89246200e+00
  9.91931656e+00  9.91931656e+00  9.91931656e+00  1.93617782e+01
  3.33865886e+01  3.33865886e+01  3.33865886e+01  9.37402210e+01
  1.31682720e+02  1.31682720e+02  1.31682720e+02  3.56044193e+02
  1.34937908e+03  5.83578822e+03  3.50983765e+04]
E1 = -182.57630272004693  E_coul = 54.04147643240385
cycle= 5 E= -128.534826287643  delta_E= -3.76e-10  |g|= 1.82e-06  |ddm|= 2.4e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57630272004693  E_coul = 54.04147643240385
  HOMO = -0.848504936324427  LUMO = 0.628551690960564
  mo_energy =
[-3.27724971e+01 -1.92866302e+00 -8.48504936e-01 -8.48504936e-01
 -8.48504936e-01  6.28551691e-01  6.28551691e-01  6.28551691e-01
  2.03874467e+00  2.89246210e+00  2.89246210e+00  2.89246210e+00
  9.91931715e+00  9.91931715e+00  9.91931715e+00  1.93617793e+01
  3.33865898e+01  3.33865898e+01  3.33865898e+01  9.37402223e+01
  1.31682721e+02  1.31682721e+02  1.31682721e+02  3.56044194e+02
  1.34937908e+03  5.83578822e+03  3.50983765e+04]
E1 = -182.5762966087608  E_coul = 54.041470321117444
Extra cycle  E= -128.534826287643  delta_E= -2.56e-13  |g|= 8e-07  |ddm|= 1.41e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.41371508874877
E1 = -182.5762966087608  E_coul = 54.041470321117444
init E= -128.534826287643
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.848505390304801  LUMO = 0.628551597272826
  mo_energy =
[-3.27724983e+01 -1.92866351e+00 -8.48505390e-01 -8.48505390e-01
 -8.48505390e-01  6.28551597e-01  6.28551597e-01  6.28551597e-01
  2.03874431e+00  2.89246177e+00  2.89246177e+00  2.89246177e+00
  9.91931651e+00  9.91931651e+00  9.91931651e+00  1.93617784e+01
  3.33865888e+01  3.33865888e+01  3.33865888e+01  9.37402212e+01
  1.31682720e+02  1.31682720e+02  1.31682720e+02  3.56044193e+02
  1.34937908e+03  5.83578822e+03  3.50983765e+04]
E1 = -182.57629920095573  E_coul = 54.04147291331282
cycle= 1 E= -128.534826287643  delta_E= 4.26e-13  |g|= 3.61e-07  |ddm|= 3.17e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57629920095573  E_coul = 54.04147291331282
  HOMO = -0.84850521026573  LUMO = 0.628551625723273
  mo_energy =
[-3.27724977e+01 -1.92866333e+00 -8.48505210e-01 -8.48505210e-01
 -8.48505210e-01  6.28551626e-01  6.28551626e-01  6.28551626e-01
  2.03874444e+00  2.89246188e+00  2.89246188e+00  2.89246188e+00
  9.91931677e+00  9.91931677e+00  9.91931677e+00  1.93617788e+01
  3.33865892e+01  3.33865892e+01  3.33865892e+01  9.37402217e+01
  1.31682721e+02  1.31682721e+02  1.31682721e+02  3.56044193e+02
  1.34937908e+03  5.83578822e+03  3.50983765e+04]
E1 = -182.57629777770524  E_coul = 54.04147149006147
Extra cycle  E= -128.534826287644  delta_E= -8.53e-13  |g|= 1.92e-07  |ddm|= 1.33e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.35 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498634e+02 1.74905444e+02
 2.04881825e+01 5.69668012e+01 4.93136892e-01 7.82187208e+00
 1.66733354e+00 4.89756729e+00 1.45224342e+01 5.46176285e+01
 2.21571972e-01 1.78778134e+00 6.42070831e-01]
grad_E = [ 6.65942045e-11 -3.26675595e-09  5.35115224e-08 -3.97783664e-07
 -2.72528852e-06 -1.02928189e-07  4.52361304e-03 -1.46237082e-05
 -3.91567924e-04 -1.12995092e-03  3.42230089e-04 -2.39416873e-04
  3.24238527e-03  2.13886362e-03 -4.51502338e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681746        1
[INPUT] 0    0    [1    /1   ]  617.498632816        1
[INPUT] 0    0    [1    /1   ]  174.90546458         1
[INPUT] 0    0    [1    /1   ]  20.4884323382        1
[INPUT] 0    0    [1    /1   ]  56.9666216411        1
[INPUT] 0    0    [1    /1   ]  0.491538889077       1
[INPUT] 0    0    [1    /1   ]  7.82207970401        1
[INPUT] 0    0    [1    /1   ]  1.66645116134        1
[INPUT] 1    0    [1    /1   ]  4.8880017396         1
[INPUT] 1    0    [1    /1   ]  14.4264926572        1
[INPUT] 1    0    [1    /1   ]  54.6237819594        1
[INPUT] 1    0    [1    /1   ]  0.226136892253       1
[INPUT] 1    0    [1    /1   ]  1.80268382743        1
[INPUT] 1    0    [1    /1   ]  0.658769171969       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730085393, 1.0]], [0, [2712.096817464643, 1.0]], [0, [617.4986328162031, 1.0]], [0, [174.9054645797692, 1.0]], [0, [20.48843233822669, 1.0]], [0, [56.96662164111726, 1.0]], [0, [0.4915388890773059, 1.0]], [0, [7.822079704008187, 1.0]], [0, [1.6664511613386637, 1.0]], [1, [4.888001739598236, 1.0]], [1, [14.426492657199388, 1.0]], [1, [54.623781959430204, 1.0]], [1, [0.22613689225341593, 1.0]], [1, [1.8026838274310304, 1.0]], [1, [0.6587691719689784, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681746]
bas 2, expnt(s) = [617.49863282]
bas 3, expnt(s) = [174.90546458]
bas 4, expnt(s) = [20.48843234]
bas 5, expnt(s) = [56.96662164]
bas 6, expnt(s) = [0.49153889]
bas 7, expnt(s) = [7.8220797]
bas 8, expnt(s) = [1.66645116]
bas 9, expnt(s) = [4.88800174]
bas 10, expnt(s) = [14.42649266]
bas 11, expnt(s) = [54.62378196]
bas 12, expnt(s) = [0.22613689]
bas 13, expnt(s) = [1.80268383]
bas 14, expnt(s) = [0.65876917]
CPU time:        84.61
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498633e+02 3.12962300e+02 1.74905465e+02 1.21511549e+02
 2.04884323e+01 2.43302500e+01 5.69666216e+01 5.23878256e+01
 4.91538889e-01 1.48314440e+00 7.82207970e+00 1.18169855e+01
 1.66645116e+00 3.70560793e+00 4.88800174e+00 2.12030620e+01
 1.44264927e+01 8.20229418e+01 5.46237820e+01 4.33223094e+02
 2.26136892e-01 4.54934284e-01 1.80268383e+00 6.09373895e+00
 6.58769172e-01 1.73141421e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999395117461239
cond(S) = 240.27507709351536
E1 = -183.58380635414656  E_coul = 55.08137844854663
init E= -128.5024279056
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774873134635411  LUMO = 0.657429320174132
  mo_energy =
[-3.25543423e+01 -1.85118021e+00 -7.74873135e-01 -7.74873135e-01
 -7.74873135e-01  6.57429320e-01  6.57429320e-01  6.57429320e-01
  2.08600392e+00  3.00747302e+00  3.00747302e+00  3.00747302e+00
  1.01319584e+01  1.01319584e+01  1.01319584e+01  1.95011957e+01
  3.35441849e+01  3.35441849e+01  3.35441849e+01  9.39367761e+01
  1.31677535e+02  1.31677535e+02  1.31677535e+02  3.56277022e+02
  1.34964477e+03  5.83608370e+03  3.50986935e+04]
E1 = -182.06238578450413  E_coul = 53.5311471667474
cycle= 1 E= -128.531238617757  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.538993
diis-c [-0.29051309  1.        ]
  HOMO = -0.884662519104513  LUMO = 0.638062923223986
  mo_energy =
[-3.28819694e+01 -1.96682948e+00 -8.84662519e-01 -8.84662519e-01
 -8.84662519e-01  6.38062923e-01  6.38062923e-01  6.38062923e-01
  2.00663894e+00  2.93169336e+00  2.93169336e+00  2.93169336e+00
  9.97371571e+00  9.97371571e+00  9.97371571e+00  1.92759419e+01
  3.32927946e+01  3.32927946e+01  3.32927946e+01  9.36281388e+01
  1.31349450e+02  1.31349450e+02  1.31349450e+02  3.55920447e+02
  1.34924992e+03  5.83565700e+03  3.50982452e+04]
E1 = -182.837606940881  E_coul = 54.30370093892132
cycle= 2 E= -128.53390600196  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0711
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274181
diis-c [-6.03072816e-04  3.36506553e-01  6.63493447e-01]
  HOMO = -0.848397009980642  LUMO = 0.644507272126129
  mo_energy =
[-3.27721612e+01 -1.92852418e+00 -8.48397010e-01 -8.48397010e-01
 -8.48397010e-01  6.44507272e-01  6.44507272e-01  6.44507272e-01
  2.03267080e+00  2.95644673e+00  2.95644673e+00  2.95644673e+00
  1.00261203e+01  1.00261203e+01  1.00261203e+01  1.93515265e+01
  3.33771105e+01  3.33771105e+01  3.33771105e+01  9.37318222e+01
  1.31458730e+02  1.31458730e+02  1.31458730e+02  3.56037158e+02
  1.34937299e+03  5.83578306e+03  3.50983724e+04]
E1 = -182.5747671053444  E_coul = 54.039911052423875
cycle= 3 E= -128.534856052921  delta_E= -0.00095  |g|= 0.000391  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000977889
diis-c [-9.36118641e-08 -1.96343372e-03 -4.68887731e-04  1.00243232e+00]
  HOMO = -0.848598019949224  LUMO = 0.644492381586683
  mo_energy =
[-3.27725513e+01 -1.92868828e+00 -8.48598020e-01 -8.48598020e-01
 -8.48598020e-01  6.44492382e-01  6.44492382e-01  6.44492382e-01
  2.03258401e+00  2.95634736e+00  2.95634736e+00  2.95634736e+00
  1.00259171e+01  1.00259171e+01  1.00259171e+01  1.93512749e+01
  3.33768128e+01  3.33768128e+01  3.33768128e+01  9.37314586e+01
  1.31458328e+02  1.31458328e+02  1.31458328e+02  3.56036680e+02
  1.34937238e+03  5.83578234e+03  3.50983716e+04]
E1 = -182.57511141352492  E_coul = 54.040255346429554
cycle= 4 E= -128.534856067095  delta_E= -1.42e-08  |g|= 6.85e-05  |ddm|= 0.000162
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000172058
diis-c [-4.46810811e-10  8.45639464e-05  4.66643769e-04 -1.13085332e-01
  1.11253412e+00]
  HOMO = -0.848633425206878  LUMO = 0.644483709065628
  mo_energy =
[-3.27726182e+01 -1.92872257e+00 -8.48633425e-01 -8.48633425e-01
 -8.48633425e-01  6.44483709e-01  6.44483709e-01  6.44483709e-01
  2.03255630e+00  2.95631893e+00  2.95631893e+00  2.95631893e+00
  1.00258703e+01  1.00258703e+01  1.00258703e+01  1.93512198e+01
  3.33767532e+01  3.33767532e+01  3.33767532e+01  9.37313936e+01
  1.31458261e+02  1.31458261e+02  1.31458261e+02  3.56036610e+02
  1.34937230e+03  5.83578226e+03  3.50983715e+04]
E1 = -182.57523761613692  E_coul = 54.04038154860309
cycle= 5 E= -128.534856067534  delta_E= -4.38e-10  |g|= 1.88e-06  |ddm|= 2.64e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57523761613692  E_coul = 54.04038154860309
  HOMO = -0.848632918859313  LUMO = 0.644483719645104
  mo_energy =
[-3.27726165e+01 -1.92872201e+00 -8.48632919e-01 -8.48632919e-01
 -8.48632919e-01  6.44483720e-01  6.44483720e-01  6.44483720e-01
  2.03255659e+00  2.95631916e+00  2.95631916e+00  2.95631916e+00
  1.00258711e+01  1.00258711e+01  1.00258711e+01  1.93512212e+01
  3.33767546e+01  3.33767546e+01  3.33767546e+01  9.37313952e+01
  1.31458263e+02  1.31458263e+02  1.31458263e+02  3.56036611e+02
  1.34937230e+03  5.83578226e+03  3.50983715e+04]
E1 = -182.57523095270258  E_coul = 54.04037488516832
Extra cycle  E= -128.534856067534  delta_E= -4.26e-13  |g|= 8.72e-07  |ddm|= 1.32e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498633e+02 1.74905465e+02
 2.04884323e+01 5.69666216e+01 4.91538889e-01 7.82207970e+00
 1.66645116e+00 4.88800174e+00 1.44264927e+01 5.46237820e+01
 2.26136892e-01 1.80268383e+00 6.58769172e-01]
E = -128.53485606753426
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681746        1
[INPUT] 0    0    [1    /1   ]  617.498632816        1
[INPUT] 0    0    [1    /1   ]  174.90546458         1
[INPUT] 0    0    [1    /1   ]  20.4884323382        1
[INPUT] 0    0    [1    /1   ]  56.9666216411        1
[INPUT] 0    0    [1    /1   ]  0.491538889077       1
[INPUT] 0    0    [1    /1   ]  7.82207970401        1
[INPUT] 0    0    [1    /1   ]  1.66645116134        1
[INPUT] 1    0    [1    /1   ]  4.8880017396         1
[INPUT] 1    0    [1    /1   ]  14.4264926572        1
[INPUT] 1    0    [1    /1   ]  54.6237819594        1
[INPUT] 1    0    [1    /1   ]  0.226136892253       1
[INPUT] 1    0    [1    /1   ]  1.80268382743        1
[INPUT] 1    0    [1    /1   ]  0.658769171969       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730085393, 1.0]], [0, [2712.096817464643, 1.0]], [0, [617.4986328162031, 1.0]], [0, [174.9054645797692, 1.0]], [0, [20.48843233822669, 1.0]], [0, [56.96662164111726, 1.0]], [0, [0.4915388890773059, 1.0]], [0, [7.822079704008187, 1.0]], [0, [1.6664511613386637, 1.0]], [1, [4.888001739598236, 1.0]], [1, [14.426492657199388, 1.0]], [1, [54.623781959430204, 1.0]], [1, [0.22613689225341593, 1.0]], [1, [1.8026838274310304, 1.0]], [1, [0.6587691719689784, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681746]
bas 2, expnt(s) = [617.49863282]
bas 3, expnt(s) = [174.90546458]
bas 4, expnt(s) = [20.48843234]
bas 5, expnt(s) = [56.96662164]
bas 6, expnt(s) = [0.49153889]
bas 7, expnt(s) = [7.8220797]
bas 8, expnt(s) = [1.66645116]
bas 9, expnt(s) = [4.88800174]
bas 10, expnt(s) = [14.42649266]
bas 11, expnt(s) = [54.62378196]
bas 12, expnt(s) = [0.22613689]
bas 13, expnt(s) = [1.80268383]
bas 14, expnt(s) = [0.65876917]
CPU time:        85.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498633e+02 3.12962300e+02 1.74905465e+02 1.21511549e+02
 2.04884323e+01 2.43302500e+01 5.69666216e+01 5.23878256e+01
 4.91538889e-01 1.48314440e+00 7.82207970e+00 1.18169855e+01
 1.66645116e+00 3.70560793e+00 4.88800174e+00 2.12030620e+01
 1.44264927e+01 8.20229418e+01 5.46237820e+01 4.33223094e+02
 2.26136892e-01 4.54934284e-01 1.80268383e+00 6.09373895e+00
 6.58769172e-01 1.73141421e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999395117461239
cond(S) = 240.27507709351536
E1 = -183.58380635414656  E_coul = 55.08137844854663
init E= -128.5024279056
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774873134635411  LUMO = 0.657429320174132
  mo_energy =
[-3.25543423e+01 -1.85118021e+00 -7.74873135e-01 -7.74873135e-01
 -7.74873135e-01  6.57429320e-01  6.57429320e-01  6.57429320e-01
  2.08600392e+00  3.00747302e+00  3.00747302e+00  3.00747302e+00
  1.01319584e+01  1.01319584e+01  1.01319584e+01  1.95011957e+01
  3.35441849e+01  3.35441849e+01  3.35441849e+01  9.39367761e+01
  1.31677535e+02  1.31677535e+02  1.31677535e+02  3.56277022e+02
  1.34964477e+03  5.83608370e+03  3.50986935e+04]
E1 = -182.06238578450413  E_coul = 53.5311471667474
cycle= 1 E= -128.531238617757  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.538993
diis-c [-0.29051309  1.        ]
  HOMO = -0.884662519104513  LUMO = 0.638062923223986
  mo_energy =
[-3.28819694e+01 -1.96682948e+00 -8.84662519e-01 -8.84662519e-01
 -8.84662519e-01  6.38062923e-01  6.38062923e-01  6.38062923e-01
  2.00663894e+00  2.93169336e+00  2.93169336e+00  2.93169336e+00
  9.97371571e+00  9.97371571e+00  9.97371571e+00  1.92759419e+01
  3.32927946e+01  3.32927946e+01  3.32927946e+01  9.36281388e+01
  1.31349450e+02  1.31349450e+02  1.31349450e+02  3.55920447e+02
  1.34924992e+03  5.83565700e+03  3.50982452e+04]
E1 = -182.837606940881  E_coul = 54.30370093892132
cycle= 2 E= -128.53390600196  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0711
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.274181
diis-c [-6.03072816e-04  3.36506553e-01  6.63493447e-01]
  HOMO = -0.848397009980642  LUMO = 0.644507272126129
  mo_energy =
[-3.27721612e+01 -1.92852418e+00 -8.48397010e-01 -8.48397010e-01
 -8.48397010e-01  6.44507272e-01  6.44507272e-01  6.44507272e-01
  2.03267080e+00  2.95644673e+00  2.95644673e+00  2.95644673e+00
  1.00261203e+01  1.00261203e+01  1.00261203e+01  1.93515265e+01
  3.33771105e+01  3.33771105e+01  3.33771105e+01  9.37318222e+01
  1.31458730e+02  1.31458730e+02  1.31458730e+02  3.56037158e+02
  1.34937299e+03  5.83578306e+03  3.50983724e+04]
E1 = -182.5747671053444  E_coul = 54.039911052423875
cycle= 3 E= -128.534856052921  delta_E= -0.00095  |g|= 0.000391  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000977889
diis-c [-9.36118641e-08 -1.96343372e-03 -4.68887731e-04  1.00243232e+00]
  HOMO = -0.848598019949224  LUMO = 0.644492381586683
  mo_energy =
[-3.27725513e+01 -1.92868828e+00 -8.48598020e-01 -8.48598020e-01
 -8.48598020e-01  6.44492382e-01  6.44492382e-01  6.44492382e-01
  2.03258401e+00  2.95634736e+00  2.95634736e+00  2.95634736e+00
  1.00259171e+01  1.00259171e+01  1.00259171e+01  1.93512749e+01
  3.33768128e+01  3.33768128e+01  3.33768128e+01  9.37314586e+01
  1.31458328e+02  1.31458328e+02  1.31458328e+02  3.56036680e+02
  1.34937238e+03  5.83578234e+03  3.50983716e+04]
E1 = -182.57511141352492  E_coul = 54.040255346429554
cycle= 4 E= -128.534856067095  delta_E= -1.42e-08  |g|= 6.85e-05  |ddm|= 0.000162
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000172058
diis-c [-4.46810811e-10  8.45639464e-05  4.66643769e-04 -1.13085332e-01
  1.11253412e+00]
  HOMO = -0.848633425206878  LUMO = 0.644483709065628
  mo_energy =
[-3.27726182e+01 -1.92872257e+00 -8.48633425e-01 -8.48633425e-01
 -8.48633425e-01  6.44483709e-01  6.44483709e-01  6.44483709e-01
  2.03255630e+00  2.95631893e+00  2.95631893e+00  2.95631893e+00
  1.00258703e+01  1.00258703e+01  1.00258703e+01  1.93512198e+01
  3.33767532e+01  3.33767532e+01  3.33767532e+01  9.37313936e+01
  1.31458261e+02  1.31458261e+02  1.31458261e+02  3.56036610e+02
  1.34937230e+03  5.83578226e+03  3.50983715e+04]
E1 = -182.57523761613692  E_coul = 54.04038154860309
cycle= 5 E= -128.534856067534  delta_E= -4.38e-10  |g|= 1.88e-06  |ddm|= 2.64e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57523761613692  E_coul = 54.04038154860309
  HOMO = -0.848632918859313  LUMO = 0.644483719645104
  mo_energy =
[-3.27726165e+01 -1.92872201e+00 -8.48632919e-01 -8.48632919e-01
 -8.48632919e-01  6.44483720e-01  6.44483720e-01  6.44483720e-01
  2.03255659e+00  2.95631916e+00  2.95631916e+00  2.95631916e+00
  1.00258711e+01  1.00258711e+01  1.00258711e+01  1.93512212e+01
  3.33767546e+01  3.33767546e+01  3.33767546e+01  9.37313952e+01
  1.31458263e+02  1.31458263e+02  1.31458263e+02  3.56036611e+02
  1.34937230e+03  5.83578226e+03  3.50983715e+04]
E1 = -182.57523095270258  E_coul = 54.04037488516832
Extra cycle  E= -128.534856067534  delta_E= -4.26e-13  |g|= 8.72e-07  |ddm|= 1.32e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.27507709351536
E1 = -182.57523095270258  E_coul = 54.04037488516832
init E= -128.534856067534
    CPU time for initialize scf      0.32 sec, wall time      0.31 sec
  HOMO = -0.848633409935662  LUMO = 0.644483618306117
  mo_energy =
[-3.27726178e+01 -1.92872253e+00 -8.48633410e-01 -8.48633410e-01
 -8.48633410e-01  6.44483618e-01  6.44483618e-01  6.44483618e-01
  2.03255621e+00  2.95631880e+00  2.95631880e+00  2.95631880e+00
  1.00258704e+01  1.00258704e+01  1.00258704e+01  1.93512202e+01
  3.33767536e+01  3.33767536e+01  3.33767536e+01  9.37313939e+01
  1.31458262e+02  1.31458262e+02  1.31458262e+02  3.56036610e+02
  1.34937230e+03  5.83578226e+03  3.50983715e+04]
E1 = -182.57523390353725  E_coul = 54.04037783600299
cycle= 1 E= -128.534856067534  delta_E=    0  |g|= 4.08e-07  |ddm|= 3.23e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57523390353725  E_coul = 54.04037783600299
  HOMO = -0.848633204250103  LUMO = 0.64448365277348
  mo_energy =
[-3.27726172e+01 -1.92872232e+00 -8.48633204e-01 -8.48633204e-01
 -8.48633204e-01  6.44483653e-01  6.44483653e-01  6.44483653e-01
  2.03255635e+00  2.95631894e+00  2.95631894e+00  2.95631894e+00
  1.00258707e+01  1.00258707e+01  1.00258707e+01  1.93512207e+01
  3.33767541e+01  3.33767541e+01  3.33767541e+01  9.37313945e+01
  1.31458262e+02  1.31458262e+02  1.31458262e+02  3.56036611e+02
  1.34937230e+03  5.83578226e+03  3.50983715e+04]
E1 = -182.57523230964352  E_coul = 54.04037624210961
Extra cycle  E= -128.534856067534  delta_E= 3.41e-13  |g|= 2.15e-07  |ddm|= 1.48e-07
    CPU time for scf_cycle      0.37 sec, wall time      0.37 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498633e+02 1.74905465e+02
 2.04884323e+01 5.69666216e+01 4.91538889e-01 7.82207970e+00
 1.66645116e+00 4.88800174e+00 1.44264927e+01 5.46237820e+01
 2.26136892e-01 1.80268383e+00 6.58769172e-01]
grad_E = [ 7.53853259e-11 -3.75009739e-09  6.28250091e-08 -5.26595263e-07
 -1.03793845e-05  9.37595072e-07  1.54079650e-03  3.55254026e-06
  3.29876170e-04 -5.81018242e-04  1.87900213e-04 -2.21614816e-04
 -2.52918112e-03 -1.15794144e-04  1.67869652e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681746        1
[INPUT] 0    0    [1    /1   ]  617.498633084        1
[INPUT] 0    0    [1    /1   ]  174.905459719        1
[INPUT] 0    0    [1    /1   ]  20.4883896101        1
[INPUT] 0    0    [1    /1   ]  56.9666677781        1
[INPUT] 0    0    [1    /1   ]  0.490927400783       1
[INPUT] 0    0    [1    /1   ]  7.82201610898        1
[INPUT] 0    0    [1    /1   ]  1.66566890489        1
[INPUT] 1    0    [1    /1   ]  4.91994708495        1
[INPUT] 1    0    [1    /1   ]  14.4357665944        1
[INPUT] 1    0    [1    /1   ]  54.623356585         1
[INPUT] 1    0    [1    /1   ]  0.227916210279       1
[INPUT] 1    0    [1    /1   ]  1.81954021346        1
[INPUT] 1    0    [1    /1   ]  0.664056360084       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008549, 1.0]], [0, [2712.096817455847, 1.0]], [0, [617.4986330842172, 1.0]], [0, [174.90545971926684, 1.0]], [0, [20.48838961011164, 1.0]], [0, [56.966667778058245, 1.0]], [0, [0.4909274007832382, 1.0]], [0, [7.8220161089765075, 1.0]], [0, [1.665668904894805, 1.0]], [1, [4.919947084953328, 1.0]], [1, [14.43576659439169, 1.0]], [1, [54.623356584965265, 1.0]], [1, [0.22791621027874362, 1.0]], [1, [1.8195402134605827, 1.0]], [1, [0.6640563600840749, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681746]
bas 2, expnt(s) = [617.49863308]
bas 3, expnt(s) = [174.90545972]
bas 4, expnt(s) = [20.48838961]
bas 5, expnt(s) = [56.96666778]
bas 6, expnt(s) = [0.4909274]
bas 7, expnt(s) = [7.82201611]
bas 8, expnt(s) = [1.6656689]
bas 9, expnt(s) = [4.91994708]
bas 10, expnt(s) = [14.43576659]
bas 11, expnt(s) = [54.62335658]
bas 12, expnt(s) = [0.22791621]
bas 13, expnt(s) = [1.81954021]
bas 14, expnt(s) = [0.66405636]
CPU time:        88.15
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498633e+02 3.12962300e+02 1.74905460e+02 1.21511547e+02
 2.04883896e+01 2.43302120e+01 5.69666678e+01 5.23878574e+01
 4.90927401e-01 1.48176038e+00 7.82201611e+00 1.18169134e+01
 1.66566890e+00 3.70430325e+00 4.91994708e+00 2.13764180e+01
 1.44357666e+01 8.20888567e+01 5.46233566e+01 4.33218877e+02
 2.27916210e-01 4.59413139e-01 1.81954021e+00 6.16504804e+00
 6.64056360e-01 1.74880171e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999392103023773
cond(S) = 240.19574973854932
E1 = -183.58384660150142  E_coul = 55.081406848588536
init E= -128.502439752913
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77487349742108  LUMO = 0.663672521110296
  mo_energy =
[-3.25543339e+01 -1.85118017e+00 -7.74873497e-01 -7.74873497e-01
 -7.74873497e-01  6.63672521e-01  6.63672521e-01  6.63672521e-01
  2.08321163e+00  3.03537717e+00  3.03537717e+00  3.03537717e+00
  1.02228498e+01  1.02228498e+01  1.02228498e+01  1.94951777e+01
  3.37245172e+01  3.37245172e+01  3.37245172e+01  9.39309049e+01
  1.31875092e+02  1.31875092e+02  1.31875092e+02  3.56271782e+02
  1.34964015e+03  5.83607966e+03  3.50986901e+04]
E1 = -182.06266310221258  E_coul = 53.531411372366186
cycle= 1 E= -128.531251729846  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53944
diis-c [-0.29099541  1.        ]
  HOMO = -0.884651578937722  LUMO = 0.644067418567914
  mo_energy =
[-3.28819163e+01 -1.96678929e+00 -8.84651579e-01 -8.84651579e-01
 -8.84651579e-01  6.44067419e-01  6.44067419e-01  6.44067419e-01
  2.00394456e+00  2.95902751e+00  2.95902751e+00  2.95902751e+00
  1.00640423e+01  1.00640423e+01  1.00640423e+01  1.92699504e+01
  3.34730742e+01  3.34730742e+01  3.34730742e+01  9.36223076e+01
  1.31547091e+02  1.31547091e+02  1.31547091e+02  3.55915246e+02
  1.34924533e+03  5.83565299e+03  3.50982419e+04]
E1 = -182.8377155737282  E_coul = 54.303796564486476
cycle= 2 E= -128.533919009242  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0711
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274337
diis-c [-6.02681895e-04  3.36449486e-01  6.63550514e-01]
  HOMO = -0.848391625372819  LUMO = 0.650592732643316
  mo_energy =
[-3.27721189e+01 -1.92849045e+00 -8.48391625e-01 -8.48391625e-01
 -8.48391625e-01  6.50592733e-01  6.50592733e-01  6.50592733e-01
  2.02995186e+00  2.98397143e+00  2.98397143e+00  2.98397143e+00
  1.01166401e+01  1.01166401e+01  1.01166401e+01  1.93455254e+01
  3.35574101e+01  3.35574101e+01  3.35574101e+01  9.37259811e+01
  1.31656347e+02  1.31656347e+02  1.31656347e+02  3.56031945e+02
  1.34936838e+03  5.83577903e+03  3.50983691e+04]
E1 = -182.5749931588457  E_coul = 54.04012463334255
cycle= 3 E= -128.534868525503  delta_E= -0.00095  |g|= 0.00039  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000985917
diis-c [-9.28915385e-08 -1.95696665e-03 -4.26498477e-04  1.00238347e+00]
  HOMO = -0.848590719967797  LUMO = 0.650578613722021
  mo_energy =
[-3.27725068e+01 -1.92865021e+00 -8.48590720e-01 -8.48590720e-01
 -8.48590720e-01  6.50578614e-01  6.50578614e-01  6.50578614e-01
  2.02986898e+00  2.98387353e+00  2.98387353e+00  2.98387353e+00
  1.01164391e+01  1.01164391e+01  1.01164391e+01  1.93452769e+01
  3.35571150e+01  3.35571150e+01  3.35571150e+01  9.37256199e+01
  1.31655947e+02  1.31655947e+02  1.31655947e+02  3.56031470e+02
  1.34936778e+03  5.83577832e+03  3.50983683e+04]
E1 = -182.57534559508613  E_coul = 54.040477055860585
cycle= 4 E= -128.534868539226  delta_E= -1.37e-08  |g|= 6.85e-05  |ddm|= 0.000154
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000175088
diis-c [-4.43754144e-10  8.62371038e-05  4.76816623e-04 -1.13761785e-01
  1.11319873e+00]
  HOMO = -0.848625849391884  LUMO = 0.650570027371357
  mo_energy =
[-3.27725738e+01 -1.92868362e+00 -8.48625849e-01 -8.48625849e-01
 -8.48625849e-01  6.50570027e-01  6.50570027e-01  6.50570027e-01
  2.02984210e+00  2.98384534e+00  2.98384534e+00  2.98384534e+00
  1.01163926e+01  1.01163926e+01  1.01163926e+01  1.93452222e+01
  3.35570557e+01  3.35570557e+01  3.35570557e+01  9.37255549e+01
  1.31655880e+02  1.31655880e+02  1.31655880e+02  3.56031399e+02
  1.34936770e+03  5.83577824e+03  3.50983682e+04]
E1 = -182.57547470309092  E_coul = 54.040606163432265
cycle= 5 E= -128.534868539659  delta_E= -4.33e-10  |g|= 1.81e-06  |ddm|= 2.48e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57547470309092  E_coul = 54.040606163432265
  HOMO = -0.848625339774478  LUMO = 0.650570052106557
  mo_energy =
[-3.27725722e+01 -1.92868298e+00 -8.48625340e-01 -8.48625340e-01
 -8.48625340e-01  6.50570052e-01  6.50570052e-01  6.50570052e-01
  2.02984246e+00  2.98384560e+00  2.98384560e+00  2.98384560e+00
  1.01163934e+01  1.01163934e+01  1.01163934e+01  1.93452236e+01
  3.35570570e+01  3.35570570e+01  3.35570570e+01  9.37255564e+01
  1.31655882e+02  1.31655882e+02  1.31655882e+02  3.56031400e+02
  1.34936770e+03  5.83577824e+03  3.50983682e+04]
E1 = -182.57546852402228  E_coul = 54.04059998436339
Extra cycle  E= -128.534868539659  delta_E= -2.56e-13  |g|= 8.05e-07  |ddm|= 1.2e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498633e+02 1.74905460e+02
 2.04883896e+01 5.69666678e+01 4.90927401e-01 7.82201611e+00
 1.66566890e+00 4.91994708e+00 1.44357666e+01 5.46233566e+01
 2.27916210e-01 1.81954021e+00 6.64056360e-01]
E = -128.5348685396589
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681746        1
[INPUT] 0    0    [1    /1   ]  617.498633084        1
[INPUT] 0    0    [1    /1   ]  174.905459719        1
[INPUT] 0    0    [1    /1   ]  20.4883896101        1
[INPUT] 0    0    [1    /1   ]  56.9666677781        1
[INPUT] 0    0    [1    /1   ]  0.490927400783       1
[INPUT] 0    0    [1    /1   ]  7.82201610898        1
[INPUT] 0    0    [1    /1   ]  1.66566890489        1
[INPUT] 1    0    [1    /1   ]  4.91994708495        1
[INPUT] 1    0    [1    /1   ]  14.4357665944        1
[INPUT] 1    0    [1    /1   ]  54.623356585         1
[INPUT] 1    0    [1    /1   ]  0.227916210279       1
[INPUT] 1    0    [1    /1   ]  1.81954021346        1
[INPUT] 1    0    [1    /1   ]  0.664056360084       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008549, 1.0]], [0, [2712.096817455847, 1.0]], [0, [617.4986330842172, 1.0]], [0, [174.90545971926684, 1.0]], [0, [20.48838961011164, 1.0]], [0, [56.966667778058245, 1.0]], [0, [0.4909274007832382, 1.0]], [0, [7.8220161089765075, 1.0]], [0, [1.665668904894805, 1.0]], [1, [4.919947084953328, 1.0]], [1, [14.43576659439169, 1.0]], [1, [54.623356584965265, 1.0]], [1, [0.22791621027874362, 1.0]], [1, [1.8195402134605827, 1.0]], [1, [0.6640563600840749, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681746]
bas 2, expnt(s) = [617.49863308]
bas 3, expnt(s) = [174.90545972]
bas 4, expnt(s) = [20.48838961]
bas 5, expnt(s) = [56.96666778]
bas 6, expnt(s) = [0.4909274]
bas 7, expnt(s) = [7.82201611]
bas 8, expnt(s) = [1.6656689]
bas 9, expnt(s) = [4.91994708]
bas 10, expnt(s) = [14.43576659]
bas 11, expnt(s) = [54.62335658]
bas 12, expnt(s) = [0.22791621]
bas 13, expnt(s) = [1.81954021]
bas 14, expnt(s) = [0.66405636]
CPU time:        88.66
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498633e+02 3.12962300e+02 1.74905460e+02 1.21511547e+02
 2.04883896e+01 2.43302120e+01 5.69666678e+01 5.23878574e+01
 4.90927401e-01 1.48176038e+00 7.82201611e+00 1.18169134e+01
 1.66566890e+00 3.70430325e+00 4.91994708e+00 2.13764180e+01
 1.44357666e+01 8.20888567e+01 5.46233566e+01 4.33218877e+02
 2.27916210e-01 4.59413139e-01 1.81954021e+00 6.16504804e+00
 6.64056360e-01 1.74880171e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999392103023773
cond(S) = 240.19574973854932
E1 = -183.58384660150142  E_coul = 55.081406848588536
init E= -128.502439752913
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77487349742108  LUMO = 0.663672521110296
  mo_energy =
[-3.25543339e+01 -1.85118017e+00 -7.74873497e-01 -7.74873497e-01
 -7.74873497e-01  6.63672521e-01  6.63672521e-01  6.63672521e-01
  2.08321163e+00  3.03537717e+00  3.03537717e+00  3.03537717e+00
  1.02228498e+01  1.02228498e+01  1.02228498e+01  1.94951777e+01
  3.37245172e+01  3.37245172e+01  3.37245172e+01  9.39309049e+01
  1.31875092e+02  1.31875092e+02  1.31875092e+02  3.56271782e+02
  1.34964015e+03  5.83607966e+03  3.50986901e+04]
E1 = -182.06266310221258  E_coul = 53.531411372366186
cycle= 1 E= -128.531251729846  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53944
diis-c [-0.29099541  1.        ]
  HOMO = -0.884651578937722  LUMO = 0.644067418567914
  mo_energy =
[-3.28819163e+01 -1.96678929e+00 -8.84651579e-01 -8.84651579e-01
 -8.84651579e-01  6.44067419e-01  6.44067419e-01  6.44067419e-01
  2.00394456e+00  2.95902751e+00  2.95902751e+00  2.95902751e+00
  1.00640423e+01  1.00640423e+01  1.00640423e+01  1.92699504e+01
  3.34730742e+01  3.34730742e+01  3.34730742e+01  9.36223076e+01
  1.31547091e+02  1.31547091e+02  1.31547091e+02  3.55915246e+02
  1.34924533e+03  5.83565299e+03  3.50982419e+04]
E1 = -182.8377155737282  E_coul = 54.303796564486476
cycle= 2 E= -128.533919009242  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0711
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.274337
diis-c [-6.02681895e-04  3.36449486e-01  6.63550514e-01]
  HOMO = -0.848391625372819  LUMO = 0.650592732643316
  mo_energy =
[-3.27721189e+01 -1.92849045e+00 -8.48391625e-01 -8.48391625e-01
 -8.48391625e-01  6.50592733e-01  6.50592733e-01  6.50592733e-01
  2.02995186e+00  2.98397143e+00  2.98397143e+00  2.98397143e+00
  1.01166401e+01  1.01166401e+01  1.01166401e+01  1.93455254e+01
  3.35574101e+01  3.35574101e+01  3.35574101e+01  9.37259811e+01
  1.31656347e+02  1.31656347e+02  1.31656347e+02  3.56031945e+02
  1.34936838e+03  5.83577903e+03  3.50983691e+04]
E1 = -182.5749931588457  E_coul = 54.04012463334255
cycle= 3 E= -128.534868525503  delta_E= -0.00095  |g|= 0.00039  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000985917
diis-c [-9.28915385e-08 -1.95696665e-03 -4.26498477e-04  1.00238347e+00]
  HOMO = -0.848590719967797  LUMO = 0.650578613722021
  mo_energy =
[-3.27725068e+01 -1.92865021e+00 -8.48590720e-01 -8.48590720e-01
 -8.48590720e-01  6.50578614e-01  6.50578614e-01  6.50578614e-01
  2.02986898e+00  2.98387353e+00  2.98387353e+00  2.98387353e+00
  1.01164391e+01  1.01164391e+01  1.01164391e+01  1.93452769e+01
  3.35571150e+01  3.35571150e+01  3.35571150e+01  9.37256199e+01
  1.31655947e+02  1.31655947e+02  1.31655947e+02  3.56031470e+02
  1.34936778e+03  5.83577832e+03  3.50983683e+04]
E1 = -182.57534559508613  E_coul = 54.040477055860585
cycle= 4 E= -128.534868539226  delta_E= -1.37e-08  |g|= 6.85e-05  |ddm|= 0.000154
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000175088
diis-c [-4.43754144e-10  8.62371038e-05  4.76816623e-04 -1.13761785e-01
  1.11319873e+00]
  HOMO = -0.848625849391884  LUMO = 0.650570027371357
  mo_energy =
[-3.27725738e+01 -1.92868362e+00 -8.48625849e-01 -8.48625849e-01
 -8.48625849e-01  6.50570027e-01  6.50570027e-01  6.50570027e-01
  2.02984210e+00  2.98384534e+00  2.98384534e+00  2.98384534e+00
  1.01163926e+01  1.01163926e+01  1.01163926e+01  1.93452222e+01
  3.35570557e+01  3.35570557e+01  3.35570557e+01  9.37255549e+01
  1.31655880e+02  1.31655880e+02  1.31655880e+02  3.56031399e+02
  1.34936770e+03  5.83577824e+03  3.50983682e+04]
E1 = -182.57547470309092  E_coul = 54.040606163432265
cycle= 5 E= -128.534868539659  delta_E= -4.33e-10  |g|= 1.81e-06  |ddm|= 2.48e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57547470309092  E_coul = 54.040606163432265
  HOMO = -0.848625339774478  LUMO = 0.650570052106557
  mo_energy =
[-3.27725722e+01 -1.92868298e+00 -8.48625340e-01 -8.48625340e-01
 -8.48625340e-01  6.50570052e-01  6.50570052e-01  6.50570052e-01
  2.02984246e+00  2.98384560e+00  2.98384560e+00  2.98384560e+00
  1.01163934e+01  1.01163934e+01  1.01163934e+01  1.93452236e+01
  3.35570570e+01  3.35570570e+01  3.35570570e+01  9.37255564e+01
  1.31655882e+02  1.31655882e+02  1.31655882e+02  3.56031400e+02
  1.34936770e+03  5.83577824e+03  3.50983682e+04]
E1 = -182.57546852402228  E_coul = 54.04059998436339
Extra cycle  E= -128.534868539659  delta_E= -2.56e-13  |g|= 8.05e-07  |ddm|= 1.2e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.19574973854932
E1 = -182.57546852402228  E_coul = 54.04059998436339
init E= -128.534868539659
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.848625796436948  LUMO = 0.650569958149584
  mo_energy =
[-3.27725734e+01 -1.92868346e+00 -8.48625796e-01 -8.48625796e-01
 -8.48625796e-01  6.50569958e-01  6.50569958e-01  6.50569958e-01
  2.02984212e+00  2.98384526e+00  2.98384526e+00  2.98384526e+00
  1.01163927e+01  1.01163927e+01  1.01163927e+01  1.93452227e+01
  3.35570561e+01  3.35570561e+01  3.35570561e+01  9.37255552e+01
  1.31655881e+02  1.31655881e+02  1.31655881e+02  3.56031399e+02
  1.34936770e+03  5.83577824e+03  3.50983682e+04]
E1 = -182.57547131445472  E_coul = 54.04060277479606
cycle= 1 E= -128.534868539659  delta_E= 2.56e-13  |g|= 3.86e-07  |ddm|= 2.77e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57547131445472  E_coul = 54.04060277479606
  HOMO = -0.848625602141689  LUMO = 0.650569991461543
  mo_energy =
[-3.27725728e+01 -1.92868325e+00 -8.48625602e-01 -8.48625602e-01
 -8.48625602e-01  6.50569991e-01  6.50569991e-01  6.50569991e-01
  2.02984226e+00  2.98384539e+00  2.98384539e+00  2.98384539e+00
  1.01163930e+01  1.01163930e+01  1.01163930e+01  1.93452231e+01
  3.35570565e+01  3.35570565e+01  3.35570565e+01  9.37255558e+01
  1.31655881e+02  1.31655881e+02  1.31655881e+02  3.56031399e+02
  1.34936770e+03  5.83577824e+03  3.50983682e+04]
E1 = -182.57546982066083  E_coul = 54.04060128100199
Extra cycle  E= -128.534868539659  delta_E= -1.99e-13  |g|= 2.02e-07  |ddm|= 1.42e-07
    CPU time for scf_cycle      0.37 sec, wall time      0.37 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498633e+02 1.74905460e+02
 2.04883896e+01 5.69666678e+01 4.90927401e-01 7.82201611e+00
 1.66566890e+00 4.91994708e+00 1.44357666e+01 5.46233566e+01
 2.27916210e-01 1.81954021e+00 6.64056360e-01]
grad_E = [ 7.87704459e-11 -3.92861729e-09  6.63206538e-08 -5.67244808e-07
 -1.19367835e-05  1.22903361e-06  6.83536716e-04  7.93361201e-06
  5.04772618e-04 -4.42329764e-04  1.21021122e-04 -2.16495426e-04
 -1.17182018e-03  1.06309070e-04  8.54637352e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681744        1
[INPUT] 0    0    [1    /1   ]  617.498633611        1
[INPUT] 0    0    [1    /1   ]  174.90544958         1
[INPUT] 0    0    [1    /1   ]  20.4882996985        1
[INPUT] 0    0    [1    /1   ]  56.9667672411        1
[INPUT] 0    0    [1    /1   ]  0.489996401195       1
[INPUT] 0    0    [1    /1   ]  7.82187095131        1
[INPUT] 0    0    [1    /1   ]  1.6637852646         1
[INPUT] 1    0    [1    /1   ]  4.9787799218         1
[INPUT] 1    0    [1    /1   ]  14.4624243783        1
[INPUT] 1    0    [1    /1   ]  54.6221589895        1
[INPUT] 1    0    [1    /1   ]  0.229153151443       1
[INPUT] 1    0    [1    /1   ]  1.84579991027        1
[INPUT] 1    0    [1    /1   ]  0.669938044417       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730085637, 1.0]], [0, [2712.0968174399545, 1.0]], [0, [617.4986336106108, 1.0]], [0, [174.9054495801078, 1.0]], [0, [20.488299698485015, 1.0]], [0, [56.96676724109641, 1.0]], [0, [0.4899964011951712, 1.0]], [0, [7.821870951308213, 1.0]], [0, [1.6637852645970674, 1.0]], [1, [4.978779921796084, 1.0]], [1, [14.462424378289587, 1.0]], [1, [54.62215898950288, 1.0]], [1, [0.2291531514432023, 1.0]], [1, [1.8457999102687699, 1.0]], [1, [0.6699380444165246, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681744]
bas 2, expnt(s) = [617.49863361]
bas 3, expnt(s) = [174.90544958]
bas 4, expnt(s) = [20.4882997]
bas 5, expnt(s) = [56.96676724]
bas 6, expnt(s) = [0.4899964]
bas 7, expnt(s) = [7.82187095]
bas 8, expnt(s) = [1.66378526]
bas 9, expnt(s) = [4.97877992]
bas 10, expnt(s) = [14.46242438]
bas 11, expnt(s) = [54.62215899]
bas 12, expnt(s) = [0.22915315]
bas 13, expnt(s) = [1.84579991]
bas 14, expnt(s) = [0.66993804]
CPU time:        91.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498634e+02 3.12962300e+02 1.74905450e+02 1.21511541e+02
 2.04882997e+01 2.43301319e+01 5.69667672e+01 5.23879260e+01
 4.89996401e-01 1.47965236e+00 7.82187095e+00 1.18167490e+01
 1.66378526e+00 3.70116102e+00 4.97877992e+00 2.16964188e+01
 1.44624244e+01 8.22783870e+01 5.46221590e+01 4.33207004e+02
 2.29153151e-01 4.62531894e-01 1.84579991e+00 6.27646582e+00
 6.69938044e-01 1.76818497e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999390424307101
cond(S) = 240.04135734366608
E1 = -183.583854779264  E_coul = 55.08141708445321
init E= -128.502437694811
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774875136949033  LUMO = 0.668893307350363
  mo_energy =
[-3.25543283e+01 -1.85118279e+00 -7.74875137e-01 -7.74875137e-01
 -7.74875137e-01  6.68893307e-01  6.68893307e-01  6.68893307e-01
  2.07833328e+00  3.06743841e+00  3.06743841e+00  3.06743841e+00
  1.03572550e+01  1.03572550e+01  1.03572550e+01  1.94831542e+01
  3.40313320e+01  3.40313320e+01  3.40313320e+01  9.39189255e+01
  1.32240720e+02  1.32240720e+02  1.32240720e+02  3.56261050e+02
  1.34963067e+03  5.83607138e+03  3.50986833e+04]
E1 = -182.0624129097099  E_coul = 53.53115292070806
cycle= 1 E= -128.531259989002  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53995
diis-c [-0.29154615  1.        ]
  HOMO = -0.884685100477885  LUMO = 0.649051610639559
  mo_energy =
[-3.28819465e+01 -1.96679292e+00 -8.84685100e-01 -8.84685100e-01
 -8.84685100e-01  6.49051611e-01  6.49051611e-01  6.49051611e-01
  1.99918644e+00  2.99023747e+00  2.99023747e+00  2.99023747e+00
  1.01973522e+01  1.01973522e+01  1.01973522e+01  1.92578874e+01
  3.37796031e+01  3.37796031e+01  3.37796031e+01  9.36102861e+01
  1.31912740e+02  1.31912740e+02  1.31912740e+02  3.55904467e+02
  1.34923580e+03  5.83564464e+03  3.50982350e+04]
E1 = -182.83761185150857  E_coul = 54.303683284505695
cycle= 2 E= -128.533928567003  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274549
diis-c [-6.02197023e-04  3.36412466e-01  6.63587534e-01]
  HOMO = -0.84841629062711  LUMO = 0.655656441865923
  mo_energy =
[-3.27721217e+01 -1.92848539e+00 -8.48416291e-01 -8.48416291e-01
 -8.48416291e-01  6.55656442e-01  6.55656442e-01  6.55656442e-01
  2.02516222e+00  3.01546426e+00  3.01546426e+00  3.01546426e+00
  1.02503244e+01  1.02503244e+01  1.02503244e+01  1.93334792e+01
  3.38640449e+01  3.38640449e+01  3.38640449e+01  9.37139871e+01
  1.32022004e+02  1.32022004e+02  1.32022004e+02  3.56021195e+02
  1.34935887e+03  5.83577071e+03  3.50983622e+04]
E1 = -182.57487470521758  E_coul = 54.03999636043955
cycle= 3 E= -128.534878344778  delta_E= -0.00095  |g|= 0.00039  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000997991
diis-c [-9.33954958e-08 -1.95247696e-03 -3.75227219e-04  1.00232770e+00]
  HOMO = -0.848614168557536  LUMO = 0.655642952282842
  mo_energy =
[-3.27725086e+01 -1.92864132e+00 -8.48614169e-01 -8.48614169e-01
 -8.48614169e-01  6.55642952e-01  6.55642952e-01  6.55642952e-01
  2.02508289e+00  3.01536701e+00  3.01536701e+00  3.01536701e+00
  1.02501242e+01  1.02501242e+01  1.02501242e+01  1.93332328e+01
  3.38637512e+01  3.38637512e+01  3.38637512e+01  9.37136270e+01
  1.32021605e+02  1.32021605e+02  1.32021605e+02  3.56020719e+02
  1.34935826e+03  5.83576999e+03  3.50983614e+04]
E1 = -182.57523664378175  E_coul = 54.04035828553681
cycle= 4 E= -128.534878358245  delta_E= -1.35e-08  |g|= 6.89e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000178889
diis-c [-4.49172342e-10  8.90596328e-05  4.87930030e-04 -1.15319249e-01
  1.11474226e+00]
  HOMO = -0.848649204023956  LUMO = 0.655634411461055
  mo_energy =
[-3.27725761e+01 -1.92867401e+00 -8.48649204e-01 -8.48649204e-01
 -8.48649204e-01  6.55634411e-01  6.55634411e-01  6.55634411e-01
  2.02505673e+00  3.01533884e+00  3.01533884e+00  3.01533884e+00
  1.02500776e+01  1.02500776e+01  1.02500776e+01  1.93331783e+01
  3.38636917e+01  3.38636917e+01  3.38636917e+01  9.37135615e+01
  1.32021537e+02  1.32021537e+02  1.32021537e+02  3.56020647e+02
  1.34935819e+03  5.83576991e+03  3.50983613e+04]
E1 = -182.5753692088647  E_coul = 54.04049085018594
cycle= 5 E= -128.534878358679  delta_E= -4.34e-10  |g|= 1.82e-06  |ddm|= 2.34e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5753692088647  E_coul = 54.04049085018594
  HOMO = -0.848648663090805  LUMO = 0.655634456451725
  mo_energy =
[-3.27725745e+01 -1.92867328e+00 -8.48648663e-01 -8.48648663e-01
 -8.48648663e-01  6.55634456e-01  6.55634456e-01  6.55634456e-01
  2.02505719e+00  3.01533914e+00  3.01533914e+00  3.01533914e+00
  1.02500784e+01  1.02500784e+01  1.02500784e+01  1.93331797e+01
  3.38636931e+01  3.38636931e+01  3.38636931e+01  9.37135631e+01
  1.32021539e+02  1.32021539e+02  1.32021539e+02  3.56020648e+02
  1.34935819e+03  5.83576991e+03  3.50983613e+04]
E1 = -182.57536335428378  E_coul = 54.04048499560442
Extra cycle  E= -128.534878358679  delta_E= -5.68e-13  |g|= 7.64e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498634e+02 1.74905450e+02
 2.04882997e+01 5.69667672e+01 4.89996401e-01 7.82187095e+00
 1.66378526e+00 4.97877992e+00 1.44624244e+01 5.46221590e+01
 2.29153151e-01 1.84579991e+00 6.69938044e-01]
E = -128.53487835867935
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681744        1
[INPUT] 0    0    [1    /1   ]  617.498633611        1
[INPUT] 0    0    [1    /1   ]  174.90544958         1
[INPUT] 0    0    [1    /1   ]  20.4882996985        1
[INPUT] 0    0    [1    /1   ]  56.9667672411        1
[INPUT] 0    0    [1    /1   ]  0.489996401195       1
[INPUT] 0    0    [1    /1   ]  7.82187095131        1
[INPUT] 0    0    [1    /1   ]  1.6637852646         1
[INPUT] 1    0    [1    /1   ]  4.9787799218         1
[INPUT] 1    0    [1    /1   ]  14.4624243783        1
[INPUT] 1    0    [1    /1   ]  54.6221589895        1
[INPUT] 1    0    [1    /1   ]  0.229153151443       1
[INPUT] 1    0    [1    /1   ]  1.84579991027        1
[INPUT] 1    0    [1    /1   ]  0.669938044417       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730085637, 1.0]], [0, [2712.0968174399545, 1.0]], [0, [617.4986336106108, 1.0]], [0, [174.9054495801078, 1.0]], [0, [20.488299698485015, 1.0]], [0, [56.96676724109641, 1.0]], [0, [0.4899964011951712, 1.0]], [0, [7.821870951308213, 1.0]], [0, [1.6637852645970674, 1.0]], [1, [4.978779921796084, 1.0]], [1, [14.462424378289587, 1.0]], [1, [54.62215898950288, 1.0]], [1, [0.2291531514432023, 1.0]], [1, [1.8457999102687699, 1.0]], [1, [0.6699380444165246, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681744]
bas 2, expnt(s) = [617.49863361]
bas 3, expnt(s) = [174.90544958]
bas 4, expnt(s) = [20.4882997]
bas 5, expnt(s) = [56.96676724]
bas 6, expnt(s) = [0.4899964]
bas 7, expnt(s) = [7.82187095]
bas 8, expnt(s) = [1.66378526]
bas 9, expnt(s) = [4.97877992]
bas 10, expnt(s) = [14.46242438]
bas 11, expnt(s) = [54.62215899]
bas 12, expnt(s) = [0.22915315]
bas 13, expnt(s) = [1.84579991]
bas 14, expnt(s) = [0.66993804]
CPU time:        92.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498634e+02 3.12962300e+02 1.74905450e+02 1.21511541e+02
 2.04882997e+01 2.43301319e+01 5.69667672e+01 5.23879260e+01
 4.89996401e-01 1.47965236e+00 7.82187095e+00 1.18167490e+01
 1.66378526e+00 3.70116102e+00 4.97877992e+00 2.16964188e+01
 1.44624244e+01 8.22783870e+01 5.46221590e+01 4.33207004e+02
 2.29153151e-01 4.62531894e-01 1.84579991e+00 6.27646582e+00
 6.69938044e-01 1.76818497e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999390424307101
cond(S) = 240.04135734366608
E1 = -183.583854779264  E_coul = 55.08141708445321
init E= -128.502437694811
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774875136949033  LUMO = 0.668893307350363
  mo_energy =
[-3.25543283e+01 -1.85118279e+00 -7.74875137e-01 -7.74875137e-01
 -7.74875137e-01  6.68893307e-01  6.68893307e-01  6.68893307e-01
  2.07833328e+00  3.06743841e+00  3.06743841e+00  3.06743841e+00
  1.03572550e+01  1.03572550e+01  1.03572550e+01  1.94831542e+01
  3.40313320e+01  3.40313320e+01  3.40313320e+01  9.39189255e+01
  1.32240720e+02  1.32240720e+02  1.32240720e+02  3.56261050e+02
  1.34963067e+03  5.83607138e+03  3.50986833e+04]
E1 = -182.0624129097099  E_coul = 53.53115292070806
cycle= 1 E= -128.531259989002  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.53995
diis-c [-0.29154615  1.        ]
  HOMO = -0.884685100477885  LUMO = 0.649051610639559
  mo_energy =
[-3.28819465e+01 -1.96679292e+00 -8.84685100e-01 -8.84685100e-01
 -8.84685100e-01  6.49051611e-01  6.49051611e-01  6.49051611e-01
  1.99918644e+00  2.99023747e+00  2.99023747e+00  2.99023747e+00
  1.01973522e+01  1.01973522e+01  1.01973522e+01  1.92578874e+01
  3.37796031e+01  3.37796031e+01  3.37796031e+01  9.36102861e+01
  1.31912740e+02  1.31912740e+02  1.31912740e+02  3.55904467e+02
  1.34923580e+03  5.83564464e+03  3.50982350e+04]
E1 = -182.83761185150857  E_coul = 54.303683284505695
cycle= 2 E= -128.533928567003  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274549
diis-c [-6.02197023e-04  3.36412466e-01  6.63587534e-01]
  HOMO = -0.84841629062711  LUMO = 0.655656441865923
  mo_energy =
[-3.27721217e+01 -1.92848539e+00 -8.48416291e-01 -8.48416291e-01
 -8.48416291e-01  6.55656442e-01  6.55656442e-01  6.55656442e-01
  2.02516222e+00  3.01546426e+00  3.01546426e+00  3.01546426e+00
  1.02503244e+01  1.02503244e+01  1.02503244e+01  1.93334792e+01
  3.38640449e+01  3.38640449e+01  3.38640449e+01  9.37139871e+01
  1.32022004e+02  1.32022004e+02  1.32022004e+02  3.56021195e+02
  1.34935887e+03  5.83577071e+03  3.50983622e+04]
E1 = -182.57487470521758  E_coul = 54.03999636043955
cycle= 3 E= -128.534878344778  delta_E= -0.00095  |g|= 0.00039  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000997991
diis-c [-9.33954958e-08 -1.95247696e-03 -3.75227219e-04  1.00232770e+00]
  HOMO = -0.848614168557536  LUMO = 0.655642952282842
  mo_energy =
[-3.27725086e+01 -1.92864132e+00 -8.48614169e-01 -8.48614169e-01
 -8.48614169e-01  6.55642952e-01  6.55642952e-01  6.55642952e-01
  2.02508289e+00  3.01536701e+00  3.01536701e+00  3.01536701e+00
  1.02501242e+01  1.02501242e+01  1.02501242e+01  1.93332328e+01
  3.38637512e+01  3.38637512e+01  3.38637512e+01  9.37136270e+01
  1.32021605e+02  1.32021605e+02  1.32021605e+02  3.56020719e+02
  1.34935826e+03  5.83576999e+03  3.50983614e+04]
E1 = -182.57523664378175  E_coul = 54.04035828553681
cycle= 4 E= -128.534878358245  delta_E= -1.35e-08  |g|= 6.89e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000178889
diis-c [-4.49172342e-10  8.90596328e-05  4.87930030e-04 -1.15319249e-01
  1.11474226e+00]
  HOMO = -0.848649204023956  LUMO = 0.655634411461055
  mo_energy =
[-3.27725761e+01 -1.92867401e+00 -8.48649204e-01 -8.48649204e-01
 -8.48649204e-01  6.55634411e-01  6.55634411e-01  6.55634411e-01
  2.02505673e+00  3.01533884e+00  3.01533884e+00  3.01533884e+00
  1.02500776e+01  1.02500776e+01  1.02500776e+01  1.93331783e+01
  3.38636917e+01  3.38636917e+01  3.38636917e+01  9.37135615e+01
  1.32021537e+02  1.32021537e+02  1.32021537e+02  3.56020647e+02
  1.34935819e+03  5.83576991e+03  3.50983613e+04]
E1 = -182.5753692088647  E_coul = 54.04049085018594
cycle= 5 E= -128.534878358679  delta_E= -4.34e-10  |g|= 1.82e-06  |ddm|= 2.34e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5753692088647  E_coul = 54.04049085018594
  HOMO = -0.848648663090805  LUMO = 0.655634456451725
  mo_energy =
[-3.27725745e+01 -1.92867328e+00 -8.48648663e-01 -8.48648663e-01
 -8.48648663e-01  6.55634456e-01  6.55634456e-01  6.55634456e-01
  2.02505719e+00  3.01533914e+00  3.01533914e+00  3.01533914e+00
  1.02500784e+01  1.02500784e+01  1.02500784e+01  1.93331797e+01
  3.38636931e+01  3.38636931e+01  3.38636931e+01  9.37135631e+01
  1.32021539e+02  1.32021539e+02  1.32021539e+02  3.56020648e+02
  1.34935819e+03  5.83576991e+03  3.50983613e+04]
E1 = -182.57536335428378  E_coul = 54.04048499560442
Extra cycle  E= -128.534878358679  delta_E= -5.68e-13  |g|= 7.64e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.04135734366608
E1 = -182.57536335428378  E_coul = 54.04048499560442
init E= -128.534878358679
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.848649096444424  LUMO = 0.655634368163104
  mo_energy =
[-3.27725757e+01 -1.92867371e+00 -8.48649096e-01 -8.48649096e-01
 -8.48649096e-01  6.55634368e-01  6.55634368e-01  6.55634368e-01
  2.02505688e+00  3.01533883e+00  3.01533883e+00  3.01533883e+00
  1.02500778e+01  1.02500778e+01  1.02500778e+01  1.93331789e+01
  3.38636922e+01  3.38636922e+01  3.38636922e+01  9.37135619e+01
  1.32021538e+02  1.32021538e+02  1.32021538e+02  3.56020647e+02
  1.34935819e+03  5.83576991e+03  3.50983613e+04]
E1 = -182.57536606918097  E_coul = 54.04048771050175
cycle= 1 E= -128.534878358679  delta_E= 1.14e-13  |g|= 3.76e-07  |ddm|= 2.44e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57536606918097  E_coul = 54.04048771050175
  HOMO = -0.848648907515399  LUMO = 0.655634401360936
  mo_energy =
[-3.27725751e+01 -1.92867351e+00 -8.48648908e-01 -8.48648908e-01
 -8.48648908e-01  6.55634401e-01  6.55634401e-01  6.55634401e-01
  2.02505701e+00  3.01533896e+00  3.01533896e+00  3.01533896e+00
  1.02500781e+01  1.02500781e+01  1.02500781e+01  1.93331793e+01
  3.38636926e+01  3.38636926e+01  3.38636926e+01  9.37135625e+01
  1.32021538e+02  1.32021538e+02  1.32021538e+02  3.56020647e+02
  1.34935819e+03  5.83576991e+03  3.50983613e+04]
E1 = -182.5753646317918  E_coul = 54.04048627311288
Extra cycle  E= -128.534878358679  delta_E= 3.13e-13  |g|= 1.94e-07  |ddm|= 1.4e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.28 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498634e+02 1.74905450e+02
 2.04882997e+01 5.69667672e+01 4.89996401e-01 7.82187095e+00
 1.66378526e+00 4.97877992e+00 1.44624244e+01 5.46221590e+01
 2.29153151e-01 1.84579991e+00 6.69938044e-01]
grad_E = [ 8.14593973e-11 -4.06114016e-09  6.90898914e-08 -5.92374480e-07
 -1.21372942e-05  1.40768730e-06 -2.51963599e-04  1.09806559e-05
  6.33473593e-04 -1.55559332e-04  6.33761695e-06 -2.08317407e-04
 -2.39173672e-04  3.40580219e-04 -1.95702012e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681744        1
[INPUT] 0    0    [1    /1   ]  617.498633622        1
[INPUT] 0    0    [1    /1   ]  174.905448561        1
[INPUT] 0    0    [1    /1   ]  20.4882972936        1
[INPUT] 0    0    [1    /1   ]  56.9667820272        1
[INPUT] 0    0    [1    /1   ]  0.489937901317       1
[INPUT] 0    0    [1    /1   ]  7.82183665539        1
[INPUT] 0    0    [1    /1   ]  1.66285441526        1
[INPUT] 1    0    [1    /1   ]  4.98792891807        1
[INPUT] 1    0    [1    /1   ]  14.467191532         1
[INPUT] 1    0    [1    /1   ]  54.6221631859        1
[INPUT] 1    0    [1    /1   ]  0.229895121987       1
[INPUT] 1    0    [1    /1   ]  1.8488178883         1
[INPUT] 1    0    [1    /1   ]  0.671094694054       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008557, 1.0]], [0, [2712.0968174417662, 1.0]], [0, [617.498633621556, 1.0]], [0, [174.9054485609741, 1.0]], [0, [20.488297293555274, 1.0]], [0, [56.9667820271838, 1.0]], [0, [0.48993790131709836, 1.0]], [0, [7.821836655390268, 1.0]], [0, [1.6628544152628228, 1.0]], [1, [4.987928918065899, 1.0]], [1, [14.467191531971018, 1.0]], [1, [54.6221631858841, 1.0]], [1, [0.22989512198667897, 1.0]], [1, [1.8488178883008968, 1.0]], [1, [0.6710946940538717, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681744]
bas 2, expnt(s) = [617.49863362]
bas 3, expnt(s) = [174.90544856]
bas 4, expnt(s) = [20.48829729]
bas 5, expnt(s) = [56.96678203]
bas 6, expnt(s) = [0.4899379]
bas 7, expnt(s) = [7.82183666]
bas 8, expnt(s) = [1.66285442]
bas 9, expnt(s) = [4.98792892]
bas 10, expnt(s) = [14.46719153]
bas 11, expnt(s) = [54.62216319]
bas 12, expnt(s) = [0.22989512]
bas 13, expnt(s) = [1.84881789]
bas 14, expnt(s) = [0.67109469]
CPU time:        95.39
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498634e+02 3.12962300e+02 1.74905449e+02 1.21511541e+02
 2.04882973e+01 2.43301297e+01 5.69667820e+01 5.23879362e+01
 4.89937901e-01 1.47951987e+00 7.82183666e+00 1.18167101e+01
 1.66285442e+00 3.69960787e+00 4.98792892e+00 2.17462668e+01
 1.44671915e+01 8.23122895e+01 5.46221632e+01 4.33207046e+02
 2.29895122e-01 4.64404680e-01 1.84881789e+00 6.28929637e+00
 6.71094694e-01 1.77200176e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999389962688667
cond(S) = 239.99340026540835
E1 = -183.58383350104555  E_coul = 55.08139642385029
init E= -128.502437077195
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774875755761964  LUMO = 0.671162903594327
  mo_energy =
[-3.25543347e+01 -1.85118413e+00 -7.74875756e-01 -7.74875756e-01
 -7.74875756e-01  6.71162904e-01  6.71162904e-01  6.71162904e-01
  2.07729378e+00  3.07454953e+00  3.07454953e+00  3.07454953e+00
  1.03783065e+01  1.03783065e+01  1.03783065e+01  1.94791017e+01
  3.40783675e+01  3.40783675e+01  3.40783675e+01  9.39147721e+01
  1.32298488e+02  1.32298488e+02  1.32298488e+02  3.56257322e+02
  1.34962737e+03  5.83606849e+03  3.50986809e+04]
E1 = -182.06302329922934  E_coul = 53.53176010223356
cycle= 1 E= -128.531263196996  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540002
diis-c [-0.29160199  1.        ]
  HOMO = -0.88463214820648  LUMO = 0.651256360810955
  mo_energy =
[-3.28818560e+01 -1.96673846e+00 -8.84632148e-01 -8.84632148e-01
 -8.84632148e-01  6.51256361e-01  6.51256361e-01  6.51256361e-01
  1.99822544e+00  2.99727715e+00  2.99727715e+00  2.99727715e+00
  1.02183346e+01  1.02183346e+01  1.02183346e+01  1.92539259e+01
  3.38266878e+01  3.38266878e+01  3.38266878e+01  9.36062252e+01
  1.31970612e+02  1.31970612e+02  1.31970612e+02  3.55900833e+02
  1.34923258e+03  5.83564184e+03  3.50982327e+04]
E1 = -182.8378895762811  E_coul = 54.303959202218806
cycle= 2 E= -128.533930374062  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274533
diis-c [-6.01795434e-04  3.36378242e-01  6.63621758e-01]
  HOMO = -0.848377426315475  LUMO = 0.657884166253847
  mo_energy =
[-3.27720704e+01 -1.92844656e+00 -8.48377426e-01 -8.48377426e-01
 -8.48377426e-01  6.57884166e-01  6.57884166e-01  6.57884166e-01
  2.02417932e+00  3.02253213e+00  3.02253213e+00  3.02253213e+00
  1.02713328e+01  1.02713328e+01  1.02713328e+01  1.93294879e+01
  3.39111117e+01  3.39111117e+01  3.39111117e+01  9.37098893e+01
  1.32079835e+02  1.32079835e+02  1.32079835e+02  3.56017520e+02
  1.34935562e+03  5.83576787e+03  3.50983598e+04]
E1 = -182.57530732336497  E_coul = 54.04042810189944
cycle= 3 E= -128.534879221466  delta_E= -0.000949  |g|= 0.000387  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000994623
diis-c [-9.22742655e-08 -1.94704671e-03 -3.75714293e-04  1.00232276e+00]
  HOMO = -0.848573917446472  LUMO = 0.657871039118529
  mo_energy =
[-3.27724557e+01 -1.92860120e+00 -8.48573917e-01 -8.48573917e-01
 -8.48573917e-01  6.57871039e-01  6.57871039e-01  6.57871039e-01
  2.02410119e+00  3.02243593e+00  3.02243593e+00  3.02243593e+00
  1.02711340e+01  1.02711340e+01  1.02711340e+01  1.93292432e+01
  3.39108196e+01  3.39108196e+01  3.39108196e+01  9.37095309e+01
  1.32079437e+02  1.32079437e+02  1.32079437e+02  3.56017046e+02
  1.34935501e+03  5.83576715e+03  3.50983591e+04]
E1 = -182.57566924840927  E_coul = 54.04079001372709
cycle= 4 E= -128.534879234682  delta_E= -1.32e-08  |g|= 6.85e-05  |ddm|= 0.000146
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000178193
diis-c [-4.46138662e-10  8.79091107e-05  4.86603543e-04 -1.14522847e-01
  1.11394833e+00]
  HOMO = -0.848608673510888  LUMO = 0.657862557780665
  mo_energy =
[-3.27725227e+01 -1.92863360e+00 -8.48608674e-01 -8.48608674e-01
 -8.48608674e-01  6.57862558e-01  6.57862558e-01  6.57862558e-01
  2.02407529e+00  3.02240798e+00  3.02240798e+00  3.02240798e+00
  1.02710878e+01  1.02710878e+01  1.02710878e+01  1.93291891e+01
  3.39107605e+01  3.39107605e+01  3.39107605e+01  9.37094659e+01
  1.32079370e+02  1.32079370e+02  1.32079370e+02  3.56016974e+02
  1.34935493e+03  5.83576707e+03  3.50983590e+04]
E1 = -182.57580147885162  E_coul = 54.04092224374221
cycle= 5 E= -128.534879235109  delta_E= -4.27e-10  |g|= 1.8e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57580147885162  E_coul = 54.04092224374221
  HOMO = -0.848608150131649  LUMO = 0.657862600519286
  mo_energy =
[-3.27725212e+01 -1.92863288e+00 -8.48608150e-01 -8.48608150e-01
 -8.48608150e-01  6.57862601e-01  6.57862601e-01  6.57862601e-01
  2.02407574e+00  3.02240828e+00  3.02240828e+00  3.02240828e+00
  1.02710886e+01  1.02710886e+01  1.02710886e+01  1.93291905e+01
  3.39107619e+01  3.39107619e+01  3.39107619e+01  9.37094674e+01
  1.32079372e+02  1.32079372e+02  1.32079372e+02  3.56016975e+02
  1.34935493e+03  5.83576707e+03  3.50983590e+04]
E1 = -182.57579576063495  E_coul = 54.040916525525446
Extra cycle  E= -128.534879235109  delta_E= -8.53e-14  |g|= 7.46e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498634e+02 1.74905449e+02
 2.04882973e+01 5.69667820e+01 4.89937901e-01 7.82183666e+00
 1.66285442e+00 4.98792892e+00 1.44671915e+01 5.46221632e+01
 2.29895122e-01 1.84881789e+00 6.71094694e-01]
E = -128.53487923510949
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681744        1
[INPUT] 0    0    [1    /1   ]  617.498633622        1
[INPUT] 0    0    [1    /1   ]  174.905448561        1
[INPUT] 0    0    [1    /1   ]  20.4882972936        1
[INPUT] 0    0    [1    /1   ]  56.9667820272        1
[INPUT] 0    0    [1    /1   ]  0.489937901317       1
[INPUT] 0    0    [1    /1   ]  7.82183665539        1
[INPUT] 0    0    [1    /1   ]  1.66285441526        1
[INPUT] 1    0    [1    /1   ]  4.98792891807        1
[INPUT] 1    0    [1    /1   ]  14.467191532         1
[INPUT] 1    0    [1    /1   ]  54.6221631859        1
[INPUT] 1    0    [1    /1   ]  0.229895121987       1
[INPUT] 1    0    [1    /1   ]  1.8488178883         1
[INPUT] 1    0    [1    /1   ]  0.671094694054       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008557, 1.0]], [0, [2712.0968174417662, 1.0]], [0, [617.498633621556, 1.0]], [0, [174.9054485609741, 1.0]], [0, [20.488297293555274, 1.0]], [0, [56.9667820271838, 1.0]], [0, [0.48993790131709836, 1.0]], [0, [7.821836655390268, 1.0]], [0, [1.6628544152628228, 1.0]], [1, [4.987928918065899, 1.0]], [1, [14.467191531971018, 1.0]], [1, [54.6221631858841, 1.0]], [1, [0.22989512198667897, 1.0]], [1, [1.8488178883008968, 1.0]], [1, [0.6710946940538717, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681744]
bas 2, expnt(s) = [617.49863362]
bas 3, expnt(s) = [174.90544856]
bas 4, expnt(s) = [20.48829729]
bas 5, expnt(s) = [56.96678203]
bas 6, expnt(s) = [0.4899379]
bas 7, expnt(s) = [7.82183666]
bas 8, expnt(s) = [1.66285442]
bas 9, expnt(s) = [4.98792892]
bas 10, expnt(s) = [14.46719153]
bas 11, expnt(s) = [54.62216319]
bas 12, expnt(s) = [0.22989512]
bas 13, expnt(s) = [1.84881789]
bas 14, expnt(s) = [0.67109469]
CPU time:        95.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498634e+02 3.12962300e+02 1.74905449e+02 1.21511541e+02
 2.04882973e+01 2.43301297e+01 5.69667820e+01 5.23879362e+01
 4.89937901e-01 1.47951987e+00 7.82183666e+00 1.18167101e+01
 1.66285442e+00 3.69960787e+00 4.98792892e+00 2.17462668e+01
 1.44671915e+01 8.23122895e+01 5.46221632e+01 4.33207046e+02
 2.29895122e-01 4.64404680e-01 1.84881789e+00 6.28929637e+00
 6.71094694e-01 1.77200176e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999389962688667
cond(S) = 239.99340026540835
E1 = -183.58383350104555  E_coul = 55.08139642385029
init E= -128.502437077195
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774875755761964  LUMO = 0.671162903594327
  mo_energy =
[-3.25543347e+01 -1.85118413e+00 -7.74875756e-01 -7.74875756e-01
 -7.74875756e-01  6.71162904e-01  6.71162904e-01  6.71162904e-01
  2.07729378e+00  3.07454953e+00  3.07454953e+00  3.07454953e+00
  1.03783065e+01  1.03783065e+01  1.03783065e+01  1.94791017e+01
  3.40783675e+01  3.40783675e+01  3.40783675e+01  9.39147721e+01
  1.32298488e+02  1.32298488e+02  1.32298488e+02  3.56257322e+02
  1.34962737e+03  5.83606849e+03  3.50986809e+04]
E1 = -182.06302329922934  E_coul = 53.53176010223356
cycle= 1 E= -128.531263196996  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540002
diis-c [-0.29160199  1.        ]
  HOMO = -0.88463214820648  LUMO = 0.651256360810955
  mo_energy =
[-3.28818560e+01 -1.96673846e+00 -8.84632148e-01 -8.84632148e-01
 -8.84632148e-01  6.51256361e-01  6.51256361e-01  6.51256361e-01
  1.99822544e+00  2.99727715e+00  2.99727715e+00  2.99727715e+00
  1.02183346e+01  1.02183346e+01  1.02183346e+01  1.92539259e+01
  3.38266878e+01  3.38266878e+01  3.38266878e+01  9.36062252e+01
  1.31970612e+02  1.31970612e+02  1.31970612e+02  3.55900833e+02
  1.34923258e+03  5.83564184e+03  3.50982327e+04]
E1 = -182.8378895762811  E_coul = 54.303959202218806
cycle= 2 E= -128.533930374062  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274533
diis-c [-6.01795434e-04  3.36378242e-01  6.63621758e-01]
  HOMO = -0.848377426315475  LUMO = 0.657884166253847
  mo_energy =
[-3.27720704e+01 -1.92844656e+00 -8.48377426e-01 -8.48377426e-01
 -8.48377426e-01  6.57884166e-01  6.57884166e-01  6.57884166e-01
  2.02417932e+00  3.02253213e+00  3.02253213e+00  3.02253213e+00
  1.02713328e+01  1.02713328e+01  1.02713328e+01  1.93294879e+01
  3.39111117e+01  3.39111117e+01  3.39111117e+01  9.37098893e+01
  1.32079835e+02  1.32079835e+02  1.32079835e+02  3.56017520e+02
  1.34935562e+03  5.83576787e+03  3.50983598e+04]
E1 = -182.57530732336497  E_coul = 54.04042810189944
cycle= 3 E= -128.534879221466  delta_E= -0.000949  |g|= 0.000387  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000994623
diis-c [-9.22742655e-08 -1.94704671e-03 -3.75714293e-04  1.00232276e+00]
  HOMO = -0.848573917446472  LUMO = 0.657871039118529
  mo_energy =
[-3.27724557e+01 -1.92860120e+00 -8.48573917e-01 -8.48573917e-01
 -8.48573917e-01  6.57871039e-01  6.57871039e-01  6.57871039e-01
  2.02410119e+00  3.02243593e+00  3.02243593e+00  3.02243593e+00
  1.02711340e+01  1.02711340e+01  1.02711340e+01  1.93292432e+01
  3.39108196e+01  3.39108196e+01  3.39108196e+01  9.37095309e+01
  1.32079437e+02  1.32079437e+02  1.32079437e+02  3.56017046e+02
  1.34935501e+03  5.83576715e+03  3.50983591e+04]
E1 = -182.57566924840927  E_coul = 54.04079001372709
cycle= 4 E= -128.534879234682  delta_E= -1.32e-08  |g|= 6.85e-05  |ddm|= 0.000146
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000178193
diis-c [-4.46138662e-10  8.79091107e-05  4.86603543e-04 -1.14522847e-01
  1.11394833e+00]
  HOMO = -0.848608673510888  LUMO = 0.657862557780665
  mo_energy =
[-3.27725227e+01 -1.92863360e+00 -8.48608674e-01 -8.48608674e-01
 -8.48608674e-01  6.57862558e-01  6.57862558e-01  6.57862558e-01
  2.02407529e+00  3.02240798e+00  3.02240798e+00  3.02240798e+00
  1.02710878e+01  1.02710878e+01  1.02710878e+01  1.93291891e+01
  3.39107605e+01  3.39107605e+01  3.39107605e+01  9.37094659e+01
  1.32079370e+02  1.32079370e+02  1.32079370e+02  3.56016974e+02
  1.34935493e+03  5.83576707e+03  3.50983590e+04]
E1 = -182.57580147885162  E_coul = 54.04092224374221
cycle= 5 E= -128.534879235109  delta_E= -4.27e-10  |g|= 1.8e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57580147885162  E_coul = 54.04092224374221
  HOMO = -0.848608150131649  LUMO = 0.657862600519286
  mo_energy =
[-3.27725212e+01 -1.92863288e+00 -8.48608150e-01 -8.48608150e-01
 -8.48608150e-01  6.57862601e-01  6.57862601e-01  6.57862601e-01
  2.02407574e+00  3.02240828e+00  3.02240828e+00  3.02240828e+00
  1.02710886e+01  1.02710886e+01  1.02710886e+01  1.93291905e+01
  3.39107619e+01  3.39107619e+01  3.39107619e+01  9.37094674e+01
  1.32079372e+02  1.32079372e+02  1.32079372e+02  3.56016975e+02
  1.34935493e+03  5.83576707e+03  3.50983590e+04]
E1 = -182.57579576063495  E_coul = 54.040916525525446
Extra cycle  E= -128.534879235109  delta_E= -8.53e-14  |g|= 7.46e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.99340026540835
E1 = -182.57579576063495  E_coul = 54.040916525525446
init E= -128.534879235109
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.848608573938764  LUMO = 0.657862513828286
  mo_energy =
[-3.27725223e+01 -1.92863330e+00 -8.48608574e-01 -8.48608574e-01
 -8.48608574e-01  6.57862514e-01  6.57862514e-01  6.57862514e-01
  2.02407544e+00  3.02240797e+00  3.02240797e+00  3.02240797e+00
  1.02710880e+01  1.02710880e+01  1.02710880e+01  1.93291897e+01
  3.39107610e+01  3.39107610e+01  3.39107610e+01  9.37094663e+01
  1.32079371e+02  1.32079371e+02  1.32079371e+02  3.56016974e+02
  1.34935493e+03  5.83576707e+03  3.50983590e+04]
E1 = -182.5757984108281  E_coul = 54.04091917571846
cycle= 1 E= -128.53487923511  delta_E= -1.71e-13  |g|= 3.67e-07  |ddm|= 2.36e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5757984108281  E_coul = 54.04091917571846
  HOMO = -0.848608389601978  LUMO = 0.657862546349191
  mo_energy =
[-3.27725218e+01 -1.92863310e+00 -8.48608390e-01 -8.48608390e-01
 -8.48608390e-01  6.57862546e-01  6.57862546e-01  6.57862546e-01
  2.02407557e+00  3.02240810e+00  3.02240810e+00  3.02240810e+00
  1.02710883e+01  1.02710883e+01  1.02710883e+01  1.93291901e+01
  3.39107614e+01  3.39107614e+01  3.39107614e+01  9.37094668e+01
  1.32079371e+02  1.32079371e+02  1.32079371e+02  3.56016975e+02
  1.34935493e+03  5.83576707e+03  3.50983590e+04]
E1 = -182.57579700824988  E_coul = 54.04091777314008
Extra cycle  E= -128.53487923511  delta_E= -1.42e-13  |g|= 1.89e-07  |ddm|= 1.37e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.29 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498634e+02 1.74905449e+02
 2.04882973e+01 5.69667820e+01 4.89937901e-01 7.82183666e+00
 1.66285442e+00 4.98792892e+00 1.44671915e+01 5.46221632e+01
 2.29895122e-01 1.84881789e+00 6.71094694e-01]
grad_E = [ 7.83258793e-11 -3.88468597e-09  6.58682205e-08 -5.46951597e-07
 -9.58419071e-06  1.09195264e-06  1.46673924e-04  6.94524654e-06
  4.74351174e-04 -6.08742517e-05 -1.87590094e-05 -2.06617019e-04
  5.76189977e-04  2.42447939e-04 -4.06875258e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681744        1
[INPUT] 0    0    [1    /1   ]  617.498633644        1
[INPUT] 0    0    [1    /1   ]  174.905446703        1
[INPUT] 0    0    [1    /1   ]  20.4882866502        1
[INPUT] 0    0    [1    /1   ]  56.9668083798        1
[INPUT] 0    0    [1    /1   ]  0.489667712943       1
[INPUT] 0    0    [1    /1   ]  7.82178182585        1
[INPUT] 0    0    [1    /1   ]  1.66153912672        1
[INPUT] 1    0    [1    /1   ]  4.9974790298         1
[INPUT] 1    0    [1    /1   ]  14.4789080346        1
[INPUT] 1    0    [1    /1   ]  54.621947119         1
[INPUT] 1    0    [1    /1   ]  0.229700826184       1
[INPUT] 1    0    [1    /1   ]  1.85045871719        1
[INPUT] 1    0    [1    /1   ]  0.671015219137       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730085462, 1.0]], [0, [2712.0968174447185, 1.0]], [0, [617.4986336438843, 1.0]], [0, [174.90544670272422, 1.0]], [0, [20.488286650209528, 1.0]], [0, [56.966808379757886, 1.0]], [0, [0.4896677129432981, 1.0]], [0, [7.821781825845055, 1.0]], [0, [1.661539126718147, 1.0]], [1, [4.997479029797098, 1.0]], [1, [14.478908034575053, 1.0]], [1, [54.621947118997994, 1.0]], [1, [0.2297008261837016, 1.0]], [1, [1.850458717192487, 1.0]], [1, [0.6710152191367781, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681744]
bas 2, expnt(s) = [617.49863364]
bas 3, expnt(s) = [174.9054467]
bas 4, expnt(s) = [20.48828665]
bas 5, expnt(s) = [56.96680838]
bas 6, expnt(s) = [0.48966771]
bas 7, expnt(s) = [7.82178183]
bas 8, expnt(s) = [1.66153913]
bas 9, expnt(s) = [4.99747903]
bas 10, expnt(s) = [14.47890803]
bas 11, expnt(s) = [54.62194712]
bas 12, expnt(s) = [0.22970083]
bas 13, expnt(s) = [1.85045872]
bas 14, expnt(s) = [0.67101522]
CPU time:        99.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498634e+02 3.12962300e+02 1.74905447e+02 1.21511540e+02
 2.04882867e+01 2.43301203e+01 5.69668084e+01 5.23879544e+01
 4.89667713e-01 1.47890789e+00 7.82178183e+00 1.18166480e+01
 1.66153913e+00 3.69741291e+00 4.99747903e+00 2.17983247e+01
 1.44789080e+01 8.23956254e+01 5.46219471e+01 4.33204904e+02
 2.29700826e-01 4.63914118e-01 1.85045872e+00 6.29627435e+00
 6.71015219e-01 1.77173945e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9993921415468
cond(S) = 239.9129539727328
E1 = -183.58380595796518  E_coul = 55.0813751345798
init E= -128.502430823385
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774877334652446  LUMO = 0.670701071246044
  mo_energy =
[-3.25543392e+01 -1.85118646e+00 -7.74877335e-01 -7.74877335e-01
 -7.74877335e-01  6.70701071e-01  6.70701071e-01  6.70701071e-01
  2.07518664e+00  3.07448183e+00  3.07448183e+00  3.07448183e+00
  1.03884756e+01  1.03884756e+01  1.03884756e+01  1.94725148e+01
  3.41224383e+01  3.41224383e+01  3.41224383e+01  9.39081371e+01
  1.32369647e+02  1.32369647e+02  1.32369647e+02  3.56251379e+02
  1.34962210e+03  5.83606388e+03  3.50986771e+04]
E1 = -182.06282196205274  E_coul = 53.53155885410422
cycle= 1 E= -128.531263107949  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540042
diis-c [-0.29164548  1.        ]
  HOMO = -0.884647902376787  LUMO = 0.650800355431012
  mo_energy =
[-3.28818948e+01 -1.96675366e+00 -8.84647902e-01 -8.84647902e-01
 -8.84647902e-01  6.50800355e-01  6.50800355e-01  6.50800355e-01
  1.99616589e+00  2.99715334e+00  2.99715334e+00  2.99715334e+00
  1.02283342e+01  1.02283342e+01  1.02283342e+01  1.92473194e+01
  3.38706458e+01  3.38706458e+01  3.38706458e+01  9.35995541e+01
  1.32041739e+02  1.32041739e+02  1.32041739e+02  3.55894852e+02
  1.34922727e+03  5.83563719e+03  3.50982288e+04]
E1 = -182.83781091268136  E_coul = 54.303880049576165
cycle= 2 E= -128.533930863105  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274558
diis-c [-6.01680229e-04  3.36381931e-01  6.63618069e-01]
  HOMO = -0.848387153148576  LUMO = 0.657425318031791
  mo_energy =
[-3.27720940e+01 -1.92845584e+00 -8.48387153e-01 -8.48387153e-01
 -8.48387153e-01  6.57425318e-01  6.57425318e-01  6.57425318e-01
  2.02210488e+00  3.02242714e+00  3.02242714e+00  3.02242714e+00
  1.02813909e+01  1.02813909e+01  1.02813909e+01  1.93228908e+01
  3.39551111e+01  3.39551111e+01  3.39551111e+01  9.37032334e+01
  1.32150976e+02  1.32150976e+02  1.32150976e+02  3.56011554e+02
  1.34935033e+03  5.83576323e+03  3.50983560e+04]
E1 = -182.5751739088229  E_coul = 54.04029390392003
cycle= 3 E= -128.534880004903  delta_E= -0.000949  |g|= 0.000389  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000997369
diis-c [-9.29954487e-08 -1.94888413e-03 -3.70392041e-04  1.00231928e+00]
  HOMO = -0.848584318581388  LUMO = 0.657411935409844
  mo_energy =
[-3.27724806e+01 -1.92861130e+00 -8.48584319e-01 -8.48584319e-01
 -8.48584319e-01  6.57411935e-01  6.57411935e-01  6.57411935e-01
  2.02202611e+00  3.02233026e+00  3.02233026e+00  3.02233026e+00
  1.02811910e+01  1.02811910e+01  1.02811910e+01  1.93226452e+01
  3.39548178e+01  3.39548178e+01  3.39548178e+01  9.37028736e+01
  1.32150578e+02  1.32150578e+02  1.32150578e+02  3.56011078e+02
  1.34934972e+03  5.83576251e+03  3.50983552e+04]
E1 = -182.57553650703937  E_coul = 54.0406564887669
cycle= 4 E= -128.534880018272  delta_E= -1.34e-08  |g|= 6.87e-05  |ddm|= 0.000147
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000178464
diis-c [-4.47069859e-10  8.76829628e-05  4.86005697e-04 -1.14556512e-01
  1.11398282e+00]
  HOMO = -0.848619219192112  LUMO = 0.657403407272583
  mo_energy =
[-3.27725479e+01 -1.92864390e+00 -8.48619219e-01 -8.48619219e-01
 -8.48619219e-01  6.57403407e-01  6.57403407e-01  6.57403407e-01
  2.02200005e+00  3.02230216e+00  3.02230216e+00  3.02230216e+00
  1.02811445e+01  1.02811445e+01  1.02811445e+01  1.93225909e+01
  3.39547585e+01  3.39547585e+01  3.39547585e+01  9.37028083e+01
  1.32150510e+02  1.32150510e+02  1.32150510e+02  3.56011007e+02
  1.34934964e+03  5.83576243e+03  3.50983552e+04]
E1 = -182.57566881699145  E_coul = 54.04078879828808
cycle= 5 E= -128.534880018703  delta_E= -4.31e-10  |g|= 1.8e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57566881699145  E_coul = 54.04078879828808
  HOMO = -0.848618695895419  LUMO = 0.657403448664328
  mo_energy =
[-3.27725463e+01 -1.92864319e+00 -8.48618696e-01 -8.48618696e-01
 -8.48618696e-01  6.57403449e-01  6.57403449e-01  6.57403449e-01
  2.02200049e+00  3.02230246e+00  3.02230246e+00  3.02230246e+00
  1.02811453e+01  1.02811453e+01  1.02811453e+01  1.93225922e+01
  3.39547599e+01  3.39547599e+01  3.39547599e+01  9.37028098e+01
  1.32150512e+02  1.32150512e+02  1.32150512e+02  3.56011008e+02
  1.34934964e+03  5.83576243e+03  3.50983552e+04]
E1 = -182.57566303935923  E_coul = 54.040783020655965
Extra cycle  E= -128.534880018703  delta_E= 1.14e-13  |g|= 7.54e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498634e+02 1.74905447e+02
 2.04882867e+01 5.69668084e+01 4.89667713e-01 7.82178183e+00
 1.66153913e+00 4.99747903e+00 1.44789080e+01 5.46219471e+01
 2.29700826e-01 1.85045872e+00 6.71015219e-01]
E = -128.53488001870326
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681744        1
[INPUT] 0    0    [1    /1   ]  617.498633644        1
[INPUT] 0    0    [1    /1   ]  174.905446703        1
[INPUT] 0    0    [1    /1   ]  20.4882866502        1
[INPUT] 0    0    [1    /1   ]  56.9668083798        1
[INPUT] 0    0    [1    /1   ]  0.489667712943       1
[INPUT] 0    0    [1    /1   ]  7.82178182585        1
[INPUT] 0    0    [1    /1   ]  1.66153912672        1
[INPUT] 1    0    [1    /1   ]  4.9974790298         1
[INPUT] 1    0    [1    /1   ]  14.4789080346        1
[INPUT] 1    0    [1    /1   ]  54.621947119         1
[INPUT] 1    0    [1    /1   ]  0.229700826184       1
[INPUT] 1    0    [1    /1   ]  1.85045871719        1
[INPUT] 1    0    [1    /1   ]  0.671015219137       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730085462, 1.0]], [0, [2712.0968174447185, 1.0]], [0, [617.4986336438843, 1.0]], [0, [174.90544670272422, 1.0]], [0, [20.488286650209528, 1.0]], [0, [56.966808379757886, 1.0]], [0, [0.4896677129432981, 1.0]], [0, [7.821781825845055, 1.0]], [0, [1.661539126718147, 1.0]], [1, [4.997479029797098, 1.0]], [1, [14.478908034575053, 1.0]], [1, [54.621947118997994, 1.0]], [1, [0.2297008261837016, 1.0]], [1, [1.850458717192487, 1.0]], [1, [0.6710152191367781, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681744]
bas 2, expnt(s) = [617.49863364]
bas 3, expnt(s) = [174.9054467]
bas 4, expnt(s) = [20.48828665]
bas 5, expnt(s) = [56.96680838]
bas 6, expnt(s) = [0.48966771]
bas 7, expnt(s) = [7.82178183]
bas 8, expnt(s) = [1.66153913]
bas 9, expnt(s) = [4.99747903]
bas 10, expnt(s) = [14.47890803]
bas 11, expnt(s) = [54.62194712]
bas 12, expnt(s) = [0.22970083]
bas 13, expnt(s) = [1.85045872]
bas 14, expnt(s) = [0.67101522]
CPU time:        99.60
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498634e+02 3.12962300e+02 1.74905447e+02 1.21511540e+02
 2.04882867e+01 2.43301203e+01 5.69668084e+01 5.23879544e+01
 4.89667713e-01 1.47890789e+00 7.82178183e+00 1.18166480e+01
 1.66153913e+00 3.69741291e+00 4.99747903e+00 2.17983247e+01
 1.44789080e+01 8.23956254e+01 5.46219471e+01 4.33204904e+02
 2.29700826e-01 4.63914118e-01 1.85045872e+00 6.29627435e+00
 6.71015219e-01 1.77173945e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9993921415468
cond(S) = 239.9129539727328
E1 = -183.58380595796518  E_coul = 55.0813751345798
init E= -128.502430823385
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774877334652446  LUMO = 0.670701071246044
  mo_energy =
[-3.25543392e+01 -1.85118646e+00 -7.74877335e-01 -7.74877335e-01
 -7.74877335e-01  6.70701071e-01  6.70701071e-01  6.70701071e-01
  2.07518664e+00  3.07448183e+00  3.07448183e+00  3.07448183e+00
  1.03884756e+01  1.03884756e+01  1.03884756e+01  1.94725148e+01
  3.41224383e+01  3.41224383e+01  3.41224383e+01  9.39081371e+01
  1.32369647e+02  1.32369647e+02  1.32369647e+02  3.56251379e+02
  1.34962210e+03  5.83606388e+03  3.50986771e+04]
E1 = -182.06282196205274  E_coul = 53.53155885410422
cycle= 1 E= -128.531263107949  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540042
diis-c [-0.29164548  1.        ]
  HOMO = -0.884647902376787  LUMO = 0.650800355431012
  mo_energy =
[-3.28818948e+01 -1.96675366e+00 -8.84647902e-01 -8.84647902e-01
 -8.84647902e-01  6.50800355e-01  6.50800355e-01  6.50800355e-01
  1.99616589e+00  2.99715334e+00  2.99715334e+00  2.99715334e+00
  1.02283342e+01  1.02283342e+01  1.02283342e+01  1.92473194e+01
  3.38706458e+01  3.38706458e+01  3.38706458e+01  9.35995541e+01
  1.32041739e+02  1.32041739e+02  1.32041739e+02  3.55894852e+02
  1.34922727e+03  5.83563719e+03  3.50982288e+04]
E1 = -182.83781091268136  E_coul = 54.303880049576165
cycle= 2 E= -128.533930863105  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274558
diis-c [-6.01680229e-04  3.36381931e-01  6.63618069e-01]
  HOMO = -0.848387153148576  LUMO = 0.657425318031791
  mo_energy =
[-3.27720940e+01 -1.92845584e+00 -8.48387153e-01 -8.48387153e-01
 -8.48387153e-01  6.57425318e-01  6.57425318e-01  6.57425318e-01
  2.02210488e+00  3.02242714e+00  3.02242714e+00  3.02242714e+00
  1.02813909e+01  1.02813909e+01  1.02813909e+01  1.93228908e+01
  3.39551111e+01  3.39551111e+01  3.39551111e+01  9.37032334e+01
  1.32150976e+02  1.32150976e+02  1.32150976e+02  3.56011554e+02
  1.34935033e+03  5.83576323e+03  3.50983560e+04]
E1 = -182.5751739088229  E_coul = 54.04029390392003
cycle= 3 E= -128.534880004903  delta_E= -0.000949  |g|= 0.000389  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000997369
diis-c [-9.29954487e-08 -1.94888413e-03 -3.70392041e-04  1.00231928e+00]
  HOMO = -0.848584318581388  LUMO = 0.657411935409844
  mo_energy =
[-3.27724806e+01 -1.92861130e+00 -8.48584319e-01 -8.48584319e-01
 -8.48584319e-01  6.57411935e-01  6.57411935e-01  6.57411935e-01
  2.02202611e+00  3.02233026e+00  3.02233026e+00  3.02233026e+00
  1.02811910e+01  1.02811910e+01  1.02811910e+01  1.93226452e+01
  3.39548178e+01  3.39548178e+01  3.39548178e+01  9.37028736e+01
  1.32150578e+02  1.32150578e+02  1.32150578e+02  3.56011078e+02
  1.34934972e+03  5.83576251e+03  3.50983552e+04]
E1 = -182.57553650703937  E_coul = 54.0406564887669
cycle= 4 E= -128.534880018272  delta_E= -1.34e-08  |g|= 6.87e-05  |ddm|= 0.000147
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000178464
diis-c [-4.47069859e-10  8.76829628e-05  4.86005697e-04 -1.14556512e-01
  1.11398282e+00]
  HOMO = -0.848619219192112  LUMO = 0.657403407272583
  mo_energy =
[-3.27725479e+01 -1.92864390e+00 -8.48619219e-01 -8.48619219e-01
 -8.48619219e-01  6.57403407e-01  6.57403407e-01  6.57403407e-01
  2.02200005e+00  3.02230216e+00  3.02230216e+00  3.02230216e+00
  1.02811445e+01  1.02811445e+01  1.02811445e+01  1.93225909e+01
  3.39547585e+01  3.39547585e+01  3.39547585e+01  9.37028083e+01
  1.32150510e+02  1.32150510e+02  1.32150510e+02  3.56011007e+02
  1.34934964e+03  5.83576243e+03  3.50983552e+04]
E1 = -182.57566881699145  E_coul = 54.04078879828808
cycle= 5 E= -128.534880018703  delta_E= -4.31e-10  |g|= 1.8e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57566881699145  E_coul = 54.04078879828808
  HOMO = -0.848618695895419  LUMO = 0.657403448664328
  mo_energy =
[-3.27725463e+01 -1.92864319e+00 -8.48618696e-01 -8.48618696e-01
 -8.48618696e-01  6.57403449e-01  6.57403449e-01  6.57403449e-01
  2.02200049e+00  3.02230246e+00  3.02230246e+00  3.02230246e+00
  1.02811453e+01  1.02811453e+01  1.02811453e+01  1.93225922e+01
  3.39547599e+01  3.39547599e+01  3.39547599e+01  9.37028098e+01
  1.32150512e+02  1.32150512e+02  1.32150512e+02  3.56011008e+02
  1.34934964e+03  5.83576243e+03  3.50983552e+04]
E1 = -182.57566303935923  E_coul = 54.040783020655965
Extra cycle  E= -128.534880018703  delta_E= 1.14e-13  |g|= 7.54e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.9129539727328
E1 = -182.57566303935923  E_coul = 54.040783020655965
init E= -128.534880018703
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.848619123961718  LUMO = 0.65740336100805
  mo_energy =
[-3.27725475e+01 -1.92864361e+00 -8.48619124e-01 -8.48619124e-01
 -8.48619124e-01  6.57403361e-01  6.57403361e-01  6.57403361e-01
  2.02200019e+00  3.02230214e+00  3.02230214e+00  3.02230214e+00
  1.02811447e+01  1.02811447e+01  1.02811447e+01  1.93225914e+01
  3.39547589e+01  3.39547589e+01  3.39547589e+01  9.37028087e+01
  1.32150511e+02  1.32150511e+02  1.32150511e+02  3.56011007e+02
  1.34934964e+03  5.83576243e+03  3.50983552e+04]
E1 = -182.57566571104817  E_coul = 54.04078569234485
cycle= 1 E= -128.534880018703  delta_E= -5.68e-14  |g|= 3.7e-07  |ddm|= 2.4e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57566571104817  E_coul = 54.04078569234485
  HOMO = -0.848618938099647  LUMO = 0.657403393746543
  mo_energy =
[-3.27725469e+01 -1.92864341e+00 -8.48618938e-01 -8.48618938e-01
 -8.48618938e-01  6.57403394e-01  6.57403394e-01  6.57403394e-01
  2.02200032e+00  3.02230227e+00  3.02230227e+00  3.02230227e+00
  1.02811450e+01  1.02811450e+01  1.02811450e+01  1.93225918e+01
  3.39547594e+01  3.39547594e+01  3.39547594e+01  9.37028093e+01
  1.32150511e+02  1.32150511e+02  1.32150511e+02  3.56011008e+02
  1.34934964e+03  5.83576243e+03  3.50983552e+04]
E1 = -182.57566429567532  E_coul = 54.040784276971685
Extra cycle  E= -128.534880018704  delta_E= -3.13e-13  |g|= 1.91e-07  |ddm|= 1.38e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498634e+02 1.74905447e+02
 2.04882867e+01 5.69668084e+01 4.89667713e-01 7.82178183e+00
 1.66153913e+00 4.99747903e+00 1.44789080e+01 5.46219471e+01
 2.29700826e-01 1.85045872e+00 6.71015219e-01]
grad_E = [ 7.57237504e-11 -3.73493598e-09  6.32064394e-08 -5.07336732e-07
 -7.19955402e-06  8.23831916e-07  2.94838142e-04  3.85532526e-06
  3.56142010e-04  4.88694639e-05 -3.92486994e-05 -2.05836299e-04
  2.22482225e-04  3.69897255e-05 -1.68268180e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681745        1
[INPUT] 0    0    [1    /1   ]  617.498633551        1
[INPUT] 0    0    [1    /1   ]  174.905445971        1
[INPUT] 0    0    [1    /1   ]  20.4882892524        1
[INPUT] 0    0    [1    /1   ]  56.9668299121        1
[INPUT] 0    0    [1    /1   ]  0.489230356151       1
[INPUT] 0    0    [1    /1   ]  7.82172518152        1
[INPUT] 0    0    [1    /1   ]  1.6597599665         1
[INPUT] 1    0    [1    /1   ]  5.00138548587        1
[INPUT] 1    0    [1    /1   ]  14.4914790342        1
[INPUT] 1    0    [1    /1   ]  54.6219698507        1
[INPUT] 1    0    [1    /1   ]  0.229561866151       1
[INPUT] 1    0    [1    /1   ]  1.84933481967        1
[INPUT] 1    0    [1    /1   ]  0.670466761862       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730085233, 1.0]], [0, [2712.0968174538943, 1.0]], [0, [617.4986335513022, 1.0]], [0, [174.90544597058965, 1.0]], [0, [20.48828925238953, 1.0]], [0, [56.96682991211597, 1.0]], [0, [0.48923035615090743, 1.0]], [0, [7.821725181517235, 1.0]], [0, [1.659759966503904, 1.0]], [1, [5.001385485872093, 1.0]], [1, [14.491479034190059, 1.0]], [1, [54.62196985074992, 1.0]], [1, [0.2295618661509489, 1.0]], [1, [1.849334819667741, 1.0]], [1, [0.6704667618624576, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681745]
bas 2, expnt(s) = [617.49863355]
bas 3, expnt(s) = [174.90544597]
bas 4, expnt(s) = [20.48828925]
bas 5, expnt(s) = [56.96682991]
bas 6, expnt(s) = [0.48923036]
bas 7, expnt(s) = [7.82172518]
bas 8, expnt(s) = [1.65975997]
bas 9, expnt(s) = [5.00138549]
bas 10, expnt(s) = [14.49147903]
bas 11, expnt(s) = [54.62196985]
bas 12, expnt(s) = [0.22956187]
bas 13, expnt(s) = [1.84933482]
bas 14, expnt(s) = [0.67046676]
CPU time:       102.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498634e+02 3.12962300e+02 1.74905446e+02 1.21511540e+02
 2.04882893e+01 2.43301226e+01 5.69668299e+01 5.23879692e+01
 4.89230356e-01 1.47791709e+00 7.82172518e+00 1.18165838e+01
 1.65975997e+00 3.69444315e+00 5.00138549e+00 2.18196261e+01
 1.44914790e+01 8.24850579e+01 5.46219699e+01 4.33205129e+02
 2.29561866e-01 4.63563332e-01 1.84933482e+00 6.29149457e+00
 6.70466762e-01 1.76992946e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999395236330123
cond(S) = 239.80018276087836
E1 = -183.58377907885654  E_coul = 55.081354433168464
init E= -128.502424645688
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774879229569537  LUMO = 0.670203039893937
  mo_energy =
[-3.25543425e+01 -1.85118908e+00 -7.74879230e-01 -7.74879230e-01
 -7.74879230e-01  6.70203040e-01  6.70203040e-01  6.70203040e-01
  2.07209296e+00  3.07212032e+00  3.07212032e+00  3.07212032e+00
  1.03860765e+01  1.03860765e+01  1.03860765e+01  1.94633097e+01
  3.41407802e+01  3.41407802e+01  3.41407802e+01  9.38989714e+01
  1.32416314e+02  1.32416314e+02  1.32416314e+02  3.56243191e+02
  1.34961484e+03  5.83605753e+03  3.50986719e+04]
E1 = -182.06259240126687  E_coul = 53.5313296226473
cycle= 1 E= -128.53126277862  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540112
diis-c [-0.29172073  1.        ]
  HOMO = -0.884666096577481  LUMO = 0.650317300392757
  mo_energy =
[-3.28819424e+01 -1.96676673e+00 -8.84666097e-01 -8.84666097e-01
 -8.84666097e-01  6.50317300e-01  6.50317300e-01  6.50317300e-01
  1.99314685e+00  2.99481667e+00  2.99481667e+00  2.99481667e+00
  1.02258700e+01  1.02258700e+01  1.02258700e+01  1.92380921e+01
  3.38888791e+01  3.38888791e+01  3.38888791e+01  9.35903426e+01
  1.32088357e+02  1.32088357e+02  1.32088357e+02  3.55886615e+02
  1.34921996e+03  5.83563078e+03  3.50982235e+04]
E1 = -182.83772480133223  E_coul = 54.303793488249276
cycle= 2 E= -128.533931313083  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274589
diis-c [-6.01646737e-04  3.36378599e-01  6.63621401e-01]
  HOMO = -0.848397863103545  LUMO = 0.656936747718512
  mo_energy =
[-3.27721225e+01 -1.92846163e+00 -8.48397863e-01 -8.48397863e-01
 -8.48397863e-01  6.56936748e-01  6.56936748e-01  6.56936748e-01
  2.01906381e+00  3.02008343e+00  3.02008343e+00  3.02008343e+00
  1.02789508e+01  1.02789508e+01  1.02789508e+01  1.93136755e+01
  3.39733853e+01  3.39733853e+01  3.39733853e+01  9.36940411e+01
  1.32197615e+02  1.32197615e+02  1.32197615e+02  3.56003337e+02
  1.34934303e+03  5.83575684e+03  3.50983507e+04]
E1 = -182.57503097616427  E_coul = 54.04015020278127
cycle= 3 E= -128.534880773383  delta_E= -0.000949  |g|= 0.000391  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00100189
diis-c [-9.39717194e-08 -1.95074923e-03 -3.58974008e-04  1.00230972e+00]
  HOMO = -0.848595620000181  LUMO = 0.656923183116379
  mo_energy =
[-3.27725107e+01 -1.92861751e+00 -8.48595620e-01 -8.48595620e-01
 -8.48595620e-01  6.56923183e-01  6.56923183e-01  6.56923183e-01
  2.01898478e+00  3.01998611e+00  3.01998611e+00  3.01998611e+00
  1.02787501e+01  1.02787501e+01  1.02787501e+01  1.93134290e+01
  3.39730907e+01  3.39730907e+01  3.39730907e+01  9.36936799e+01
  1.32197215e+02  1.32197215e+02  1.32197215e+02  3.56002860e+02
  1.34934242e+03  5.83575612e+03  3.50983499e+04]
E1 = -182.5753954363695  E_coul = 54.040514649460064
cycle= 4 E= -128.534880786909  delta_E= -1.35e-08  |g|= 6.9e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000179231
diis-c [-4.49892123e-10  8.79597227e-05  4.86820046e-04 -1.14873759e-01
  1.11429898e+00]
  HOMO = -0.848630677456535  LUMO = 0.656914618204212
  mo_energy =
[-3.27725783e+01 -1.92865024e+00 -8.48630677e-01 -8.48630677e-01
 -8.48630677e-01  6.56914618e-01  6.56914618e-01  6.56914618e-01
  2.01895864e+00  3.01995790e+00  3.01995790e+00  3.01995790e+00
  1.02787033e+01  1.02787033e+01  1.02787033e+01  1.93133745e+01
  3.39730311e+01  3.39730311e+01  3.39730311e+01  9.36936143e+01
  1.32197148e+02  1.32197148e+02  1.32197148e+02  3.56002788e+02
  1.34934234e+03  5.83575604e+03  3.50983499e+04]
E1 = -182.57552822635074  E_coul = 54.040647439006484
cycle= 5 E= -128.534880787344  delta_E= -4.35e-10  |g|= 1.81e-06  |ddm|= 2.34e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57552822635074  E_coul = 54.040647439006484
  HOMO = -0.848630150152043  LUMO = 0.656914660202029
  mo_energy =
[-3.27725767e+01 -1.92864952e+00 -8.48630150e-01 -8.48630150e-01
 -8.48630150e-01  6.56914660e-01  6.56914660e-01  6.56914660e-01
  2.01895908e+00  3.01995819e+00  3.01995819e+00  3.01995819e+00
  1.02787042e+01  1.02787042e+01  1.02787042e+01  1.93133758e+01
  3.39730325e+01  3.39730325e+01  3.39730325e+01  9.36936158e+01
  1.32197149e+02  1.32197149e+02  1.32197149e+02  3.56002789e+02
  1.34934234e+03  5.83575604e+03  3.50983499e+04]
E1 = -182.57552241424054  E_coul = 54.04064162689582
Extra cycle  E= -128.534880787345  delta_E= -4.55e-13  |g|= 7.58e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498634e+02 1.74905446e+02
 2.04882893e+01 5.69668299e+01 4.89230356e-01 7.82172518e+00
 1.65975997e+00 5.00138549e+00 1.44914790e+01 5.46219699e+01
 2.29561866e-01 1.84933482e+00 6.70466762e-01]
E = -128.53488078734472
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681745        1
[INPUT] 0    0    [1    /1   ]  617.498633551        1
[INPUT] 0    0    [1    /1   ]  174.905445971        1
[INPUT] 0    0    [1    /1   ]  20.4882892524        1
[INPUT] 0    0    [1    /1   ]  56.9668299121        1
[INPUT] 0    0    [1    /1   ]  0.489230356151       1
[INPUT] 0    0    [1    /1   ]  7.82172518152        1
[INPUT] 0    0    [1    /1   ]  1.6597599665         1
[INPUT] 1    0    [1    /1   ]  5.00138548587        1
[INPUT] 1    0    [1    /1   ]  14.4914790342        1
[INPUT] 1    0    [1    /1   ]  54.6219698507        1
[INPUT] 1    0    [1    /1   ]  0.229561866151       1
[INPUT] 1    0    [1    /1   ]  1.84933481967        1
[INPUT] 1    0    [1    /1   ]  0.670466761862       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730085233, 1.0]], [0, [2712.0968174538943, 1.0]], [0, [617.4986335513022, 1.0]], [0, [174.90544597058965, 1.0]], [0, [20.48828925238953, 1.0]], [0, [56.96682991211597, 1.0]], [0, [0.48923035615090743, 1.0]], [0, [7.821725181517235, 1.0]], [0, [1.659759966503904, 1.0]], [1, [5.001385485872093, 1.0]], [1, [14.491479034190059, 1.0]], [1, [54.62196985074992, 1.0]], [1, [0.2295618661509489, 1.0]], [1, [1.849334819667741, 1.0]], [1, [0.6704667618624576, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873009]
bas 1, expnt(s) = [2712.09681745]
bas 2, expnt(s) = [617.49863355]
bas 3, expnt(s) = [174.90544597]
bas 4, expnt(s) = [20.48828925]
bas 5, expnt(s) = [56.96682991]
bas 6, expnt(s) = [0.48923036]
bas 7, expnt(s) = [7.82172518]
bas 8, expnt(s) = [1.65975997]
bas 9, expnt(s) = [5.00138549]
bas 10, expnt(s) = [14.49147903]
bas 11, expnt(s) = [54.62196985]
bas 12, expnt(s) = [0.22956187]
bas 13, expnt(s) = [1.84933482]
bas 14, expnt(s) = [0.67046676]
CPU time:       103.30
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498634e+02 3.12962300e+02 1.74905446e+02 1.21511540e+02
 2.04882893e+01 2.43301226e+01 5.69668299e+01 5.23879692e+01
 4.89230356e-01 1.47791709e+00 7.82172518e+00 1.18165838e+01
 1.65975997e+00 3.69444315e+00 5.00138549e+00 2.18196261e+01
 1.44914790e+01 8.24850579e+01 5.46219699e+01 4.33205129e+02
 2.29561866e-01 4.63563332e-01 1.84933482e+00 6.29149457e+00
 6.70466762e-01 1.76992946e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999395236330123
cond(S) = 239.80018276087836
E1 = -183.58377907885654  E_coul = 55.081354433168464
init E= -128.502424645688
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774879229569537  LUMO = 0.670203039893937
  mo_energy =
[-3.25543425e+01 -1.85118908e+00 -7.74879230e-01 -7.74879230e-01
 -7.74879230e-01  6.70203040e-01  6.70203040e-01  6.70203040e-01
  2.07209296e+00  3.07212032e+00  3.07212032e+00  3.07212032e+00
  1.03860765e+01  1.03860765e+01  1.03860765e+01  1.94633097e+01
  3.41407802e+01  3.41407802e+01  3.41407802e+01  9.38989714e+01
  1.32416314e+02  1.32416314e+02  1.32416314e+02  3.56243191e+02
  1.34961484e+03  5.83605753e+03  3.50986719e+04]
E1 = -182.06259240126687  E_coul = 53.5313296226473
cycle= 1 E= -128.53126277862  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540112
diis-c [-0.29172073  1.        ]
  HOMO = -0.884666096577481  LUMO = 0.650317300392757
  mo_energy =
[-3.28819424e+01 -1.96676673e+00 -8.84666097e-01 -8.84666097e-01
 -8.84666097e-01  6.50317300e-01  6.50317300e-01  6.50317300e-01
  1.99314685e+00  2.99481667e+00  2.99481667e+00  2.99481667e+00
  1.02258700e+01  1.02258700e+01  1.02258700e+01  1.92380921e+01
  3.38888791e+01  3.38888791e+01  3.38888791e+01  9.35903426e+01
  1.32088357e+02  1.32088357e+02  1.32088357e+02  3.55886615e+02
  1.34921996e+03  5.83563078e+03  3.50982235e+04]
E1 = -182.83772480133223  E_coul = 54.303793488249276
cycle= 2 E= -128.533931313083  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274589
diis-c [-6.01646737e-04  3.36378599e-01  6.63621401e-01]
  HOMO = -0.848397863103545  LUMO = 0.656936747718512
  mo_energy =
[-3.27721225e+01 -1.92846163e+00 -8.48397863e-01 -8.48397863e-01
 -8.48397863e-01  6.56936748e-01  6.56936748e-01  6.56936748e-01
  2.01906381e+00  3.02008343e+00  3.02008343e+00  3.02008343e+00
  1.02789508e+01  1.02789508e+01  1.02789508e+01  1.93136755e+01
  3.39733853e+01  3.39733853e+01  3.39733853e+01  9.36940411e+01
  1.32197615e+02  1.32197615e+02  1.32197615e+02  3.56003337e+02
  1.34934303e+03  5.83575684e+03  3.50983507e+04]
E1 = -182.57503097616427  E_coul = 54.04015020278127
cycle= 3 E= -128.534880773383  delta_E= -0.000949  |g|= 0.000391  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00100189
diis-c [-9.39717194e-08 -1.95074923e-03 -3.58974008e-04  1.00230972e+00]
  HOMO = -0.848595620000181  LUMO = 0.656923183116379
  mo_energy =
[-3.27725107e+01 -1.92861751e+00 -8.48595620e-01 -8.48595620e-01
 -8.48595620e-01  6.56923183e-01  6.56923183e-01  6.56923183e-01
  2.01898478e+00  3.01998611e+00  3.01998611e+00  3.01998611e+00
  1.02787501e+01  1.02787501e+01  1.02787501e+01  1.93134290e+01
  3.39730907e+01  3.39730907e+01  3.39730907e+01  9.36936799e+01
  1.32197215e+02  1.32197215e+02  1.32197215e+02  3.56002860e+02
  1.34934242e+03  5.83575612e+03  3.50983499e+04]
E1 = -182.5753954363695  E_coul = 54.040514649460064
cycle= 4 E= -128.534880786909  delta_E= -1.35e-08  |g|= 6.9e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000179231
diis-c [-4.49892123e-10  8.79597227e-05  4.86820046e-04 -1.14873759e-01
  1.11429898e+00]
  HOMO = -0.848630677456535  LUMO = 0.656914618204212
  mo_energy =
[-3.27725783e+01 -1.92865024e+00 -8.48630677e-01 -8.48630677e-01
 -8.48630677e-01  6.56914618e-01  6.56914618e-01  6.56914618e-01
  2.01895864e+00  3.01995790e+00  3.01995790e+00  3.01995790e+00
  1.02787033e+01  1.02787033e+01  1.02787033e+01  1.93133745e+01
  3.39730311e+01  3.39730311e+01  3.39730311e+01  9.36936143e+01
  1.32197148e+02  1.32197148e+02  1.32197148e+02  3.56002788e+02
  1.34934234e+03  5.83575604e+03  3.50983499e+04]
E1 = -182.57552822635074  E_coul = 54.040647439006484
cycle= 5 E= -128.534880787344  delta_E= -4.35e-10  |g|= 1.81e-06  |ddm|= 2.34e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57552822635074  E_coul = 54.040647439006484
  HOMO = -0.848630150152043  LUMO = 0.656914660202029
  mo_energy =
[-3.27725767e+01 -1.92864952e+00 -8.48630150e-01 -8.48630150e-01
 -8.48630150e-01  6.56914660e-01  6.56914660e-01  6.56914660e-01
  2.01895908e+00  3.01995819e+00  3.01995819e+00  3.01995819e+00
  1.02787042e+01  1.02787042e+01  1.02787042e+01  1.93133758e+01
  3.39730325e+01  3.39730325e+01  3.39730325e+01  9.36936158e+01
  1.32197149e+02  1.32197149e+02  1.32197149e+02  3.56002789e+02
  1.34934234e+03  5.83575604e+03  3.50983499e+04]
E1 = -182.57552241424054  E_coul = 54.04064162689582
Extra cycle  E= -128.534880787345  delta_E= -4.55e-13  |g|= 7.58e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.80018276087836
E1 = -182.57552241424054  E_coul = 54.04064162689582
init E= -128.534880787345
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.848630580722472  LUMO = 0.656914572157159
  mo_energy =
[-3.27725779e+01 -1.92864995e+00 -8.48630581e-01 -8.48630581e-01
 -8.48630581e-01  6.56914572e-01  6.56914572e-01  6.56914572e-01
  2.01895877e+00  3.01995788e+00  3.01995788e+00  3.01995788e+00
  1.02787036e+01  1.02787036e+01  1.02787036e+01  1.93133750e+01
  3.39730316e+01  3.39730316e+01  3.39730316e+01  9.36936147e+01
  1.32197148e+02  1.32197148e+02  1.32197148e+02  3.56002788e+02
  1.34934234e+03  5.83575604e+03  3.50983499e+04]
E1 = -182.575525103214  E_coul = 54.04064431586891
cycle= 1 E= -128.534880787345  delta_E= -3.69e-13  |g|= 3.72e-07  |ddm|= 2.42e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.575525103214  E_coul = 54.04064431586891
  HOMO = -0.848630393645086  LUMO = 0.656914605081838
  mo_energy =
[-3.27725773e+01 -1.92864975e+00 -8.48630394e-01 -8.48630394e-01
 -8.48630394e-01  6.56914605e-01  6.56914605e-01  6.56914605e-01
  2.01895891e+00  3.01995801e+00  3.01995801e+00  3.01995801e+00
  1.02787038e+01  1.02787038e+01  1.02787038e+01  1.93133754e+01
  3.39730320e+01  3.39730320e+01  3.39730320e+01  9.36936153e+01
  1.32197149e+02  1.32197149e+02  1.32197149e+02  3.56002788e+02
  1.34934234e+03  5.83575604e+03  3.50983499e+04]
E1 = -182.5755236788648  E_coul = 54.04064289152
Extra cycle  E= -128.534880787345  delta_E= 2.84e-13  |g|= 1.92e-07  |ddm|= 1.39e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498634e+02 1.74905446e+02
 2.04882893e+01 5.69668299e+01 4.89230356e-01 7.82172518e+00
 1.65975997e+00 5.00138549e+00 1.44914790e+01 5.46219699e+01
 2.29561866e-01 1.84933482e+00 6.70466762e-01]
grad_E = [ 7.25943427e-11 -3.55440526e-09  6.00279806e-08 -4.60196131e-07
 -4.41752970e-06  5.16540271e-07  3.46363923e-04  6.74672621e-07
  2.33781741e-04  1.26098121e-04 -4.45246475e-05 -2.06440538e-04
  2.21671440e-05 -1.90178114e-04  1.04951847e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681747        1
[INPUT] 0    0    [1    /1   ]  617.498633326        1
[INPUT] 0    0    [1    /1   ]  174.905446655        1
[INPUT] 0    0    [1    /1   ]  20.4883067817        1
[INPUT] 0    0    [1    /1   ]  56.9668441762        1
[INPUT] 0    0    [1    /1   ]  0.488558213344       1
[INPUT] 0    0    [1    /1   ]  7.82167327483        1
[INPUT] 0    0    [1    /1   ]  1.65758682775        1
[INPUT] 1    0    [1    /1   ]  5.00134711314        1
[INPUT] 1    0    [1    /1   ]  14.5024075658        1
[INPUT] 1    0    [1    /1   ]  54.6224099351        1
[INPUT] 1    0    [1    /1   ]  0.229351495181       1
[INPUT] 1    0    [1    /1   ]  1.8472282327         1
[INPUT] 1    0    [1    /1   ]  0.669716049658       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730084873, 1.0]], [0, [2712.0968174699938, 1.0]], [0, [617.4986333256238, 1.0]], [0, [174.90544665485587, 1.0]], [0, [20.488306781673398, 1.0]], [0, [56.96684417619729, 1.0]], [0, [0.4885582133436472, 1.0]], [0, [7.8216732748250895, 1.0]], [0, [1.6575868277450003, 1.0]], [1, [5.001347113136287, 1.0]], [1, [14.50240756581759, 1.0]], [1, [54.62240993507963, 1.0]], [1, [0.22935149518115444, 1.0]], [1, [1.847228232701713, 1.0]], [1, [0.669716049657707, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681747]
bas 2, expnt(s) = [617.49863333]
bas 3, expnt(s) = [174.90544665]
bas 4, expnt(s) = [20.48830678]
bas 5, expnt(s) = [56.96684418]
bas 6, expnt(s) = [0.48855821]
bas 7, expnt(s) = [7.82167327]
bas 8, expnt(s) = [1.65758683]
bas 9, expnt(s) = [5.00134711]
bas 10, expnt(s) = [14.50240757]
bas 11, expnt(s) = [54.62240994]
bas 12, expnt(s) = [0.2293515]
bas 13, expnt(s) = [1.84722823]
bas 14, expnt(s) = [0.66971605]
CPU time:       106.32
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498633e+02 3.12962300e+02 1.74905447e+02 1.21511540e+02
 2.04883068e+01 2.43301382e+01 5.69668442e+01 5.23879791e+01
 4.88558213e-01 1.47639397e+00 7.82167327e+00 1.18165250e+01
 1.65758683e+00 3.69081468e+00 5.00134711e+00 2.18194168e+01
 1.45024076e+01 8.25628213e+01 5.46224099e+01 4.33209492e+02
 2.29351495e-01 4.63032380e-01 1.84722823e+00 6.28253750e+00
 6.69716050e-01 1.76745260e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999399205868716
cond(S) = 239.65415583761174
E1 = -183.58375844504076  E_coul = 55.08134069110591
init E= -128.502417753935
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774881326400662  LUMO = 0.669441025303533
  mo_energy =
[-3.25543424e+01 -1.85119182e+00 -7.74881326e-01 -7.74881326e-01
 -7.74881326e-01  6.69441025e-01  6.69441025e-01  6.69441025e-01
  2.06784610e+00  3.06851235e+00  3.06851235e+00  3.06851235e+00
  1.03773246e+01  1.03773246e+01  1.03773246e+01  1.94514692e+01
  3.41421138e+01  3.41421138e+01  3.41421138e+01  9.38873230e+01
  1.32442173e+02  1.32442173e+02  1.32442173e+02  3.56232811e+02
  1.34960564e+03  5.83604948e+03  3.50986652e+04]
E1 = -182.06212135811052  E_coul = 53.530860022893876
cycle= 1 E= -128.531261335217  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540235
diis-c [-0.29185391  1.        ]
  HOMO = -0.88470588492784  LUMO = 0.649576877781894
  mo_energy =
[-3.28820304e+01 -1.96679510e+00 -8.84705885e-01 -8.84705885e-01
 -8.84705885e-01  6.49576878e-01  6.49576878e-01  6.49576878e-01
  1.98898958e+00  2.99125083e+00  2.99125083e+00  2.99125083e+00
  1.02170867e+01  1.02170867e+01  1.02170867e+01  1.92261962e+01
  3.38900859e+01  3.38900859e+01  3.38900859e+01  9.35786061e+01
  1.32114121e+02  1.32114121e+02  1.32114121e+02  3.55876142e+02
  1.34921066e+03  5.83562262e+03  3.50982168e+04]
E1 = -182.8375326781632  E_coul = 54.30360130170342
cycle= 2 E= -128.53393137646  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274649
diis-c [-6.01765973e-04  3.36376340e-01  6.63623660e-01]
  HOMO = -0.848423650856929  LUMO = 0.656188683601134
  mo_energy =
[-3.27721734e+01 -1.92847587e+00 -8.48423651e-01 -8.48423651e-01
 -8.48423651e-01  6.56188684e-01  6.56188684e-01  6.56188684e-01
  2.01488057e+00  3.01650437e+00  3.01650437e+00  3.01650437e+00
  1.02701806e+01  1.02701806e+01  1.02701806e+01  1.93018044e+01
  3.39746407e+01  3.39746407e+01  3.39746407e+01  9.36823414e+01
  1.32223419e+02  1.32223419e+02  1.32223419e+02  3.55992903e+02
  1.34933377e+03  5.83574872e+03  3.50983440e+04]
E1 = -182.57473081251038  E_coul = 54.039849323203214
cycle= 3 E= -128.534881489307  delta_E= -0.00095  |g|= 0.000393  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101008
diis-c [-9.55772553e-08 -1.95387437e-03 -3.37378808e-04  1.00229125e+00]
  HOMO = -0.848622226711226  LUMO = 0.656174964995405
  mo_energy =
[-3.27725636e+01 -1.92863183e+00 -8.48622227e-01 -8.48622227e-01
 -8.48622227e-01  6.56174965e-01  6.56174965e-01  6.56174965e-01
  2.01480163e+00  3.01640659e+00  3.01640659e+00  3.01640659e+00
  1.02699789e+01  1.02699789e+01  1.02699789e+01  1.93015569e+01
  3.39743446e+01  3.39743446e+01  3.39743446e+01  9.36819783e+01
  1.32223017e+02  1.32223017e+02  1.32223017e+02  3.55992423e+02
  1.34933315e+03  5.83574800e+03  3.50983432e+04]
E1 = -182.57509913894702  E_coul = 54.04021763590431
cycle= 4 E= -128.534881503043  delta_E= -1.37e-08  |g|= 6.95e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000180979
diis-c [-4.55996692e-10  8.92916311e-05  4.90198955e-04 -1.15829770e-01
  1.11525028e+00]
  HOMO = -0.848657521581824  LUMO = 0.656166361357745
  mo_energy =
[-3.27726317e+01 -1.92866465e+00 -8.48657522e-01 -8.48657522e-01
 -8.48657522e-01  6.56166361e-01  6.56166361e-01  6.56166361e-01
  2.01477545e+00  3.01637822e+00  3.01637822e+00  3.01637822e+00
  1.02699319e+01  1.02699319e+01  1.02699319e+01  1.93015020e+01
  3.39742846e+01  3.39742846e+01  3.39742846e+01  9.36819122e+01
  1.32222949e+02  1.32222949e+02  1.32222949e+02  3.55992350e+02
  1.34933307e+03  5.83574791e+03  3.50983431e+04]
E1 = -182.57523317953735  E_coul = 54.04035167605209
cycle= 5 E= -128.534881503485  delta_E= -4.43e-10  |g|= 1.83e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57523317953735  E_coul = 54.04035167605209
  HOMO = -0.848656977619829  LUMO = 0.656166408439904
  mo_energy =
[-3.27726301e+01 -1.92866390e+00 -8.48656978e-01 -8.48656978e-01
 -8.48656978e-01  6.56166408e-01  6.56166408e-01  6.56166408e-01
  2.01477591e+00  3.01637853e+00  3.01637853e+00  3.01637853e+00
  1.02699328e+01  1.02699328e+01  1.02699328e+01  1.93015034e+01
  3.39742860e+01  3.39742860e+01  3.39742860e+01  9.36819138e+01
  1.32222950e+02  1.32222950e+02  1.32222950e+02  3.55992352e+02
  1.34933308e+03  5.83574791e+03  3.50983431e+04]
E1 = -182.57522734081033  E_coul = 54.04034583732471
Extra cycle  E= -128.534881503486  delta_E= -3.69e-13  |g|= 7.62e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498633e+02 1.74905447e+02
 2.04883068e+01 5.69668442e+01 4.88558213e-01 7.82167327e+00
 1.65758683e+00 5.00134711e+00 1.45024076e+01 5.46224099e+01
 2.29351495e-01 1.84722823e+00 6.69716050e-01]
E = -128.53488150348562
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681747        1
[INPUT] 0    0    [1    /1   ]  617.498633326        1
[INPUT] 0    0    [1    /1   ]  174.905446655        1
[INPUT] 0    0    [1    /1   ]  20.4883067817        1
[INPUT] 0    0    [1    /1   ]  56.9668441762        1
[INPUT] 0    0    [1    /1   ]  0.488558213344       1
[INPUT] 0    0    [1    /1   ]  7.82167327483        1
[INPUT] 0    0    [1    /1   ]  1.65758682775        1
[INPUT] 1    0    [1    /1   ]  5.00134711314        1
[INPUT] 1    0    [1    /1   ]  14.5024075658        1
[INPUT] 1    0    [1    /1   ]  54.6224099351        1
[INPUT] 1    0    [1    /1   ]  0.229351495181       1
[INPUT] 1    0    [1    /1   ]  1.8472282327         1
[INPUT] 1    0    [1    /1   ]  0.669716049658       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730084873, 1.0]], [0, [2712.0968174699938, 1.0]], [0, [617.4986333256238, 1.0]], [0, [174.90544665485587, 1.0]], [0, [20.488306781673398, 1.0]], [0, [56.96684417619729, 1.0]], [0, [0.4885582133436472, 1.0]], [0, [7.8216732748250895, 1.0]], [0, [1.6575868277450003, 1.0]], [1, [5.001347113136287, 1.0]], [1, [14.50240756581759, 1.0]], [1, [54.62240993507963, 1.0]], [1, [0.22935149518115444, 1.0]], [1, [1.847228232701713, 1.0]], [1, [0.669716049657707, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681747]
bas 2, expnt(s) = [617.49863333]
bas 3, expnt(s) = [174.90544665]
bas 4, expnt(s) = [20.48830678]
bas 5, expnt(s) = [56.96684418]
bas 6, expnt(s) = [0.48855821]
bas 7, expnt(s) = [7.82167327]
bas 8, expnt(s) = [1.65758683]
bas 9, expnt(s) = [5.00134711]
bas 10, expnt(s) = [14.50240757]
bas 11, expnt(s) = [54.62240994]
bas 12, expnt(s) = [0.2293515]
bas 13, expnt(s) = [1.84722823]
bas 14, expnt(s) = [0.66971605]
CPU time:       106.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498633e+02 3.12962300e+02 1.74905447e+02 1.21511540e+02
 2.04883068e+01 2.43301382e+01 5.69668442e+01 5.23879791e+01
 4.88558213e-01 1.47639397e+00 7.82167327e+00 1.18165250e+01
 1.65758683e+00 3.69081468e+00 5.00134711e+00 2.18194168e+01
 1.45024076e+01 8.25628213e+01 5.46224099e+01 4.33209492e+02
 2.29351495e-01 4.63032380e-01 1.84722823e+00 6.28253750e+00
 6.69716050e-01 1.76745260e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999399205868716
cond(S) = 239.65415583761174
E1 = -183.58375844504076  E_coul = 55.08134069110591
init E= -128.502417753935
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774881326400662  LUMO = 0.669441025303533
  mo_energy =
[-3.25543424e+01 -1.85119182e+00 -7.74881326e-01 -7.74881326e-01
 -7.74881326e-01  6.69441025e-01  6.69441025e-01  6.69441025e-01
  2.06784610e+00  3.06851235e+00  3.06851235e+00  3.06851235e+00
  1.03773246e+01  1.03773246e+01  1.03773246e+01  1.94514692e+01
  3.41421138e+01  3.41421138e+01  3.41421138e+01  9.38873230e+01
  1.32442173e+02  1.32442173e+02  1.32442173e+02  3.56232811e+02
  1.34960564e+03  5.83604948e+03  3.50986652e+04]
E1 = -182.06212135811052  E_coul = 53.530860022893876
cycle= 1 E= -128.531261335217  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540235
diis-c [-0.29185391  1.        ]
  HOMO = -0.88470588492784  LUMO = 0.649576877781894
  mo_energy =
[-3.28820304e+01 -1.96679510e+00 -8.84705885e-01 -8.84705885e-01
 -8.84705885e-01  6.49576878e-01  6.49576878e-01  6.49576878e-01
  1.98898958e+00  2.99125083e+00  2.99125083e+00  2.99125083e+00
  1.02170867e+01  1.02170867e+01  1.02170867e+01  1.92261962e+01
  3.38900859e+01  3.38900859e+01  3.38900859e+01  9.35786061e+01
  1.32114121e+02  1.32114121e+02  1.32114121e+02  3.55876142e+02
  1.34921066e+03  5.83562262e+03  3.50982168e+04]
E1 = -182.8375326781632  E_coul = 54.30360130170342
cycle= 2 E= -128.53393137646  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274649
diis-c [-6.01765973e-04  3.36376340e-01  6.63623660e-01]
  HOMO = -0.848423650856929  LUMO = 0.656188683601134
  mo_energy =
[-3.27721734e+01 -1.92847587e+00 -8.48423651e-01 -8.48423651e-01
 -8.48423651e-01  6.56188684e-01  6.56188684e-01  6.56188684e-01
  2.01488057e+00  3.01650437e+00  3.01650437e+00  3.01650437e+00
  1.02701806e+01  1.02701806e+01  1.02701806e+01  1.93018044e+01
  3.39746407e+01  3.39746407e+01  3.39746407e+01  9.36823414e+01
  1.32223419e+02  1.32223419e+02  1.32223419e+02  3.55992903e+02
  1.34933377e+03  5.83574872e+03  3.50983440e+04]
E1 = -182.57473081251038  E_coul = 54.039849323203214
cycle= 3 E= -128.534881489307  delta_E= -0.00095  |g|= 0.000393  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101008
diis-c [-9.55772553e-08 -1.95387437e-03 -3.37378808e-04  1.00229125e+00]
  HOMO = -0.848622226711226  LUMO = 0.656174964995405
  mo_energy =
[-3.27725636e+01 -1.92863183e+00 -8.48622227e-01 -8.48622227e-01
 -8.48622227e-01  6.56174965e-01  6.56174965e-01  6.56174965e-01
  2.01480163e+00  3.01640659e+00  3.01640659e+00  3.01640659e+00
  1.02699789e+01  1.02699789e+01  1.02699789e+01  1.93015569e+01
  3.39743446e+01  3.39743446e+01  3.39743446e+01  9.36819783e+01
  1.32223017e+02  1.32223017e+02  1.32223017e+02  3.55992423e+02
  1.34933315e+03  5.83574800e+03  3.50983432e+04]
E1 = -182.57509913894702  E_coul = 54.04021763590431
cycle= 4 E= -128.534881503043  delta_E= -1.37e-08  |g|= 6.95e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000180979
diis-c [-4.55996692e-10  8.92916311e-05  4.90198955e-04 -1.15829770e-01
  1.11525028e+00]
  HOMO = -0.848657521581824  LUMO = 0.656166361357745
  mo_energy =
[-3.27726317e+01 -1.92866465e+00 -8.48657522e-01 -8.48657522e-01
 -8.48657522e-01  6.56166361e-01  6.56166361e-01  6.56166361e-01
  2.01477545e+00  3.01637822e+00  3.01637822e+00  3.01637822e+00
  1.02699319e+01  1.02699319e+01  1.02699319e+01  1.93015020e+01
  3.39742846e+01  3.39742846e+01  3.39742846e+01  9.36819122e+01
  1.32222949e+02  1.32222949e+02  1.32222949e+02  3.55992350e+02
  1.34933307e+03  5.83574791e+03  3.50983431e+04]
E1 = -182.57523317953735  E_coul = 54.04035167605209
cycle= 5 E= -128.534881503485  delta_E= -4.43e-10  |g|= 1.83e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57523317953735  E_coul = 54.04035167605209
  HOMO = -0.848656977619829  LUMO = 0.656166408439904
  mo_energy =
[-3.27726301e+01 -1.92866390e+00 -8.48656978e-01 -8.48656978e-01
 -8.48656978e-01  6.56166408e-01  6.56166408e-01  6.56166408e-01
  2.01477591e+00  3.01637853e+00  3.01637853e+00  3.01637853e+00
  1.02699328e+01  1.02699328e+01  1.02699328e+01  1.93015034e+01
  3.39742860e+01  3.39742860e+01  3.39742860e+01  9.36819138e+01
  1.32222950e+02  1.32222950e+02  1.32222950e+02  3.55992352e+02
  1.34933308e+03  5.83574791e+03  3.50983431e+04]
E1 = -182.57522734081033  E_coul = 54.04034583732471
Extra cycle  E= -128.534881503486  delta_E= -3.69e-13  |g|= 7.62e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.65415583761174
E1 = -182.57522734081033  E_coul = 54.04034583732471
init E= -128.534881503486
    CPU time for initialize scf      0.27 sec, wall time      0.28 sec
  HOMO = -0.848657410072663  LUMO = 0.656166320536927
  mo_energy =
[-3.27726313e+01 -1.92866433e+00 -8.48657410e-01 -8.48657410e-01
 -8.48657410e-01  6.56166321e-01  6.56166321e-01  6.56166321e-01
  2.01477561e+00  3.01637822e+00  3.01637822e+00  3.01637822e+00
  1.02699322e+01  1.02699322e+01  1.02699322e+01  1.93015026e+01
  3.39742851e+01  3.39742851e+01  3.39742851e+01  9.36819126e+01
  1.32222949e+02  1.32222949e+02  1.32222949e+02  3.55992350e+02
  1.34933307e+03  5.83574791e+03  3.50983431e+04]
E1 = -182.57523005766762  E_coul = 54.04034855418227
cycle= 1 E= -128.534881503485  delta_E= 2.84e-13  |g|= 3.76e-07  |ddm|= 2.4e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57523005766762  E_coul = 54.04034855418227
  HOMO = -0.848657221037541  LUMO = 0.656166353834584
  mo_energy =
[-3.27726307e+01 -1.92866412e+00 -8.48657221e-01 -8.48657221e-01
 -8.48657221e-01  6.56166354e-01  6.56166354e-01  6.56166354e-01
  2.01477574e+00  3.01637835e+00  3.01637835e+00  3.01637835e+00
  1.02699324e+01  1.02699324e+01  1.02699324e+01  1.93015030e+01
  3.39742856e+01  3.39742856e+01  3.39742856e+01  9.36819132e+01
  1.32222949e+02  1.32222949e+02  1.32222949e+02  3.55992351e+02
  1.34933308e+03  5.83574791e+03  3.50983431e+04]
E1 = -182.57522862153442  E_coul = 54.040347118048594
Extra cycle  E= -128.534881503486  delta_E= -4.83e-13  |g|= 1.94e-07  |ddm|= 1.41e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.34 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498633e+02 1.74905447e+02
 2.04883068e+01 5.69668442e+01 4.88558213e-01 7.82167327e+00
 1.65758683e+00 5.00134711e+00 1.45024076e+01 5.46224099e+01
 2.29351495e-01 1.84722823e+00 6.69716050e-01]
grad_E = [ 6.98621669e-11 -3.39393938e-09  5.72903783e-08 -4.18281620e-07
 -1.90114533e-06  2.62304096e-07  1.19146658e-04 -1.29008009e-06
  1.58122879e-04  1.48261756e-04 -3.63121087e-05 -2.07980571e-04
 -1.84449645e-04 -3.29075280e-04  3.19521230e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681749        1
[INPUT] 0    0    [1    /1   ]  617.498632969        1
[INPUT] 0    0    [1    /1   ]  174.905449298        1
[INPUT] 0    0    [1    /1   ]  20.4883419173        1
[INPUT] 0    0    [1    /1   ]  56.9668425886        1
[INPUT] 0    0    [1    /1   ]  0.487867777928       1
[INPUT] 0    0    [1    /1   ]  7.82164598164        1
[INPUT] 0    0    [1    /1   ]  1.65548517629        1
[INPUT] 1    0    [1    /1   ]  4.99821433655        1
[INPUT] 1    0    [1    /1   ]  14.5057399816        1
[INPUT] 1    0    [1    /1   ]  54.6234492984        1
[INPUT] 1    0    [1    /1   ]  0.229264547706       1
[INPUT] 1    0    [1    /1   ]  1.84565307899        1
[INPUT] 1    0    [1    /1   ]  0.669326680199       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008443, 1.0]], [0, [2712.0968174914788, 1.0]], [0, [617.4986329691469, 1.0]], [0, [174.90544929771258, 1.0]], [0, [20.488341917343043, 1.0]], [0, [56.966842588634435, 1.0]], [0, [0.48786777792811137, 1.0]], [0, [7.821645981638037, 1.0]], [0, [1.6554851762919536, 1.0]], [1, [4.998214336546803, 1.0]], [1, [14.505739981587068, 1.0]], [1, [54.6234492983526, 1.0]], [1, [0.22926454770584356, 1.0]], [1, [1.8456530789883228, 1.0]], [1, [0.6693266801987675, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681749]
bas 2, expnt(s) = [617.49863297]
bas 3, expnt(s) = [174.9054493]
bas 4, expnt(s) = [20.48834192]
bas 5, expnt(s) = [56.96684259]
bas 6, expnt(s) = [0.48786778]
bas 7, expnt(s) = [7.82164598]
bas 8, expnt(s) = [1.65548518]
bas 9, expnt(s) = [4.99821434]
bas 10, expnt(s) = [14.50573998]
bas 11, expnt(s) = [54.6234493]
bas 12, expnt(s) = [0.22926455]
bas 13, expnt(s) = [1.84565308]
bas 14, expnt(s) = [0.66932668]
CPU time:       110.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498633e+02 3.12962300e+02 1.74905449e+02 1.21511541e+02
 2.04883419e+01 2.43301695e+01 5.69668426e+01 5.23879780e+01
 4.87867778e-01 1.47482885e+00 7.82164598e+00 1.18164941e+01
 1.65548518e+00 3.68730444e+00 4.99821434e+00 2.18023339e+01
 1.45057400e+01 8.25865365e+01 5.46234493e+01 4.33219796e+02
 2.29264548e-01 4.62812970e-01 1.84565308e+00 6.27584172e+00
 6.69326680e-01 1.76616821e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999402683970196
cond(S) = 239.5113657243687
E1 = -183.58374384460305  E_coul = 55.081332364483984
init E= -128.502411480119
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774883113384002  LUMO = 0.669083590661001
  mo_energy =
[-3.25543410e+01 -1.85119401e+00 -7.74883113e-01 -7.74883113e-01
 -7.74883113e-01  6.69083591e-01  6.69083591e-01  6.69083591e-01
  2.06360323e+00  3.06648354e+00  3.06648354e+00  3.06648354e+00
  1.03693551e+01  1.03693551e+01  1.03693551e+01  1.94398721e+01
  3.41300269e+01  3.41300269e+01  3.41300269e+01  9.38760112e+01
  1.32438099e+02  1.32438099e+02  1.32438099e+02  3.56222754e+02
  1.34959672e+03  5.83604167e+03  3.50986588e+04]
E1 = -182.06168481420883  E_coul = 53.53042489272862
cycle= 1 E= -128.53125992148  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540369
diis-c [-0.29199898  1.        ]
  HOMO = -0.884743303508965  LUMO = 0.649227236810638
  mo_energy =
[-3.28821125e+01 -1.96681916e+00 -8.84743304e-01 -8.84743304e-01
 -8.84743304e-01  6.49227237e-01  6.49227237e-01  6.49227237e-01
  1.98483815e+00  2.98924678e+00  2.98924678e+00  2.98924678e+00
  1.02091268e+01  1.02091268e+01  1.02091268e+01  1.92145485e+01
  3.38779243e+01  3.38779243e+01  3.38779243e+01  9.35672117e+01
  1.32109958e+02  1.32109958e+02  1.32109958e+02  3.55865996e+02
  1.34920164e+03  5.83561471e+03  3.50982102e+04]
E1 = -182.83734925053307  E_coul = 54.30341787653574
cycle= 2 E= -128.533931373997  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27471
diis-c [-6.01904444e-04  3.36370704e-01  6.63629296e-01]
  HOMO = -0.848448182462707  LUMO = 0.655836422305716
  mo_energy =
[-3.27722210e+01 -1.92848695e+00 -8.48448182e-01 -8.48448182e-01
 -8.48448182e-01  6.55836422e-01  6.55836422e-01  6.55836422e-01
  2.01070268e+00  3.01449278e+00  3.01449278e+00  3.01449278e+00
  1.02622196e+01  1.02622196e+01  1.02622196e+01  1.92901797e+01
  3.39625092e+01  3.39625092e+01  3.39625092e+01  9.36709811e+01
  1.32219292e+02  1.32219292e+02  1.32219292e+02  3.55982793e+02
  1.34932479e+03  5.83574085e+03  3.50983375e+04]
E1 = -182.57445355334684  E_coul = 54.03957148175073
cycle= 3 E= -128.534882071596  delta_E= -0.000951  |g|= 0.000396  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101836
diis-c [-9.70625168e-08 -1.95638506e-03 -3.14092602e-04  1.00227048e+00]
  HOMO = -0.848647338047153  LUMO = 0.65582266979267
  mo_energy =
[-3.27726129e+01 -1.92864257e+00 -8.48647338e-01 -8.48647338e-01
 -8.48647338e-01  6.55822670e-01  6.55822670e-01  6.55822670e-01
  2.01062419e+00  3.01439478e+00  3.01439478e+00  3.01439478e+00
  1.02620173e+01  1.02620173e+01  1.02620173e+01  1.92899316e+01
  3.39622120e+01  3.39622120e+01  3.39622120e+01  9.36706165e+01
  1.32218888e+02  1.32218888e+02  1.32218888e+02  3.55982310e+02
  1.34932417e+03  5.83574012e+03  3.50983367e+04]
E1 = -182.5748263168556  E_coul = 54.03994423137378
cycle= 4 E= -128.534882085482  delta_E= -1.39e-08  |g|= 7e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182868
diis-c [-4.62552787e-10  9.08753192e-05  4.94258691e-04 -1.16881853e-01
  1.11629672e+00]
  HOMO = -0.848682819369115  LUMO = 0.655814046478886
  mo_energy =
[-3.27726815e+01 -1.92867537e+00 -8.48682819e-01 -8.48682819e-01
 -8.48682819e-01  6.55814046e-01  6.55814046e-01  6.55814046e-01
  2.01059808e+00  3.01436631e+00  3.01436631e+00  3.01436631e+00
  1.02619701e+01  1.02619701e+01  1.02619701e+01  1.92898765e+01
  3.39621517e+01  3.39621517e+01  3.39621517e+01  9.36705500e+01
  1.32218819e+02  1.32218819e+02  1.32218819e+02  3.55982237e+02
  1.34932409e+03  5.83574004e+03  3.50983366e+04]
E1 = -182.57496179482285  E_coul = 54.04007970889215
cycle= 5 E= -128.534882085931  delta_E= -4.49e-10  |g|= 1.86e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57496179482285  E_coul = 54.04007970889215
  HOMO = -0.848682255553944  LUMO = 0.655814100494637
  mo_energy =
[-3.27726798e+01 -1.92867458e+00 -8.48682256e-01 -8.48682256e-01
 -8.48682256e-01  6.55814100e-01  6.55814100e-01  6.55814100e-01
  2.01059857e+00  3.01436665e+00  3.01436665e+00  3.01436665e+00
  1.02619710e+01  1.02619710e+01  1.02619710e+01  1.92898779e+01
  3.39621531e+01  3.39621531e+01  3.39621531e+01  9.36705516e+01
  1.32218821e+02  1.32218821e+02  1.32218821e+02  3.55982238e+02
  1.34932409e+03  5.83574004e+03  3.50983366e+04]
E1 = -182.57495596008243  E_coul = 54.04007387415104
Extra cycle  E= -128.534882085931  delta_E= -7.11e-13  |g|= 7.63e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498633e+02 1.74905449e+02
 2.04883419e+01 5.69668426e+01 4.87867778e-01 7.82164598e+00
 1.65548518e+00 4.99821434e+00 1.45057400e+01 5.46234493e+01
 2.29264548e-01 1.84565308e+00 6.69326680e-01]
E = -128.5348820859314
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681749        1
[INPUT] 0    0    [1    /1   ]  617.498632969        1
[INPUT] 0    0    [1    /1   ]  174.905449298        1
[INPUT] 0    0    [1    /1   ]  20.4883419173        1
[INPUT] 0    0    [1    /1   ]  56.9668425886        1
[INPUT] 0    0    [1    /1   ]  0.487867777928       1
[INPUT] 0    0    [1    /1   ]  7.82164598164        1
[INPUT] 0    0    [1    /1   ]  1.65548517629        1
[INPUT] 1    0    [1    /1   ]  4.99821433655        1
[INPUT] 1    0    [1    /1   ]  14.5057399816        1
[INPUT] 1    0    [1    /1   ]  54.6234492984        1
[INPUT] 1    0    [1    /1   ]  0.229264547706       1
[INPUT] 1    0    [1    /1   ]  1.84565307899        1
[INPUT] 1    0    [1    /1   ]  0.669326680199       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008443, 1.0]], [0, [2712.0968174914788, 1.0]], [0, [617.4986329691469, 1.0]], [0, [174.90544929771258, 1.0]], [0, [20.488341917343043, 1.0]], [0, [56.966842588634435, 1.0]], [0, [0.48786777792811137, 1.0]], [0, [7.821645981638037, 1.0]], [0, [1.6554851762919536, 1.0]], [1, [4.998214336546803, 1.0]], [1, [14.505739981587068, 1.0]], [1, [54.6234492983526, 1.0]], [1, [0.22926454770584356, 1.0]], [1, [1.8456530789883228, 1.0]], [1, [0.6693266801987675, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681749]
bas 2, expnt(s) = [617.49863297]
bas 3, expnt(s) = [174.9054493]
bas 4, expnt(s) = [20.48834192]
bas 5, expnt(s) = [56.96684259]
bas 6, expnt(s) = [0.48786778]
bas 7, expnt(s) = [7.82164598]
bas 8, expnt(s) = [1.65548518]
bas 9, expnt(s) = [4.99821434]
bas 10, expnt(s) = [14.50573998]
bas 11, expnt(s) = [54.6234493]
bas 12, expnt(s) = [0.22926455]
bas 13, expnt(s) = [1.84565308]
bas 14, expnt(s) = [0.66932668]
CPU time:       110.67
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498633e+02 3.12962300e+02 1.74905449e+02 1.21511541e+02
 2.04883419e+01 2.43301695e+01 5.69668426e+01 5.23879780e+01
 4.87867778e-01 1.47482885e+00 7.82164598e+00 1.18164941e+01
 1.65548518e+00 3.68730444e+00 4.99821434e+00 2.18023339e+01
 1.45057400e+01 8.25865365e+01 5.46234493e+01 4.33219796e+02
 2.29264548e-01 4.62812970e-01 1.84565308e+00 6.27584172e+00
 6.69326680e-01 1.76616821e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999402683970196
cond(S) = 239.5113657243687
E1 = -183.58374384460305  E_coul = 55.081332364483984
init E= -128.502411480119
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774883113384002  LUMO = 0.669083590661001
  mo_energy =
[-3.25543410e+01 -1.85119401e+00 -7.74883113e-01 -7.74883113e-01
 -7.74883113e-01  6.69083591e-01  6.69083591e-01  6.69083591e-01
  2.06360323e+00  3.06648354e+00  3.06648354e+00  3.06648354e+00
  1.03693551e+01  1.03693551e+01  1.03693551e+01  1.94398721e+01
  3.41300269e+01  3.41300269e+01  3.41300269e+01  9.38760112e+01
  1.32438099e+02  1.32438099e+02  1.32438099e+02  3.56222754e+02
  1.34959672e+03  5.83604167e+03  3.50986588e+04]
E1 = -182.06168481420883  E_coul = 53.53042489272862
cycle= 1 E= -128.53125992148  delta_E= -0.0288  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540369
diis-c [-0.29199898  1.        ]
  HOMO = -0.884743303508965  LUMO = 0.649227236810638
  mo_energy =
[-3.28821125e+01 -1.96681916e+00 -8.84743304e-01 -8.84743304e-01
 -8.84743304e-01  6.49227237e-01  6.49227237e-01  6.49227237e-01
  1.98483815e+00  2.98924678e+00  2.98924678e+00  2.98924678e+00
  1.02091268e+01  1.02091268e+01  1.02091268e+01  1.92145485e+01
  3.38779243e+01  3.38779243e+01  3.38779243e+01  9.35672117e+01
  1.32109958e+02  1.32109958e+02  1.32109958e+02  3.55865996e+02
  1.34920164e+03  5.83561471e+03  3.50982102e+04]
E1 = -182.83734925053307  E_coul = 54.30341787653574
cycle= 2 E= -128.533931373997  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.27471
diis-c [-6.01904444e-04  3.36370704e-01  6.63629296e-01]
  HOMO = -0.848448182462707  LUMO = 0.655836422305716
  mo_energy =
[-3.27722210e+01 -1.92848695e+00 -8.48448182e-01 -8.48448182e-01
 -8.48448182e-01  6.55836422e-01  6.55836422e-01  6.55836422e-01
  2.01070268e+00  3.01449278e+00  3.01449278e+00  3.01449278e+00
  1.02622196e+01  1.02622196e+01  1.02622196e+01  1.92901797e+01
  3.39625092e+01  3.39625092e+01  3.39625092e+01  9.36709811e+01
  1.32219292e+02  1.32219292e+02  1.32219292e+02  3.55982793e+02
  1.34932479e+03  5.83574085e+03  3.50983375e+04]
E1 = -182.57445355334684  E_coul = 54.03957148175073
cycle= 3 E= -128.534882071596  delta_E= -0.000951  |g|= 0.000396  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101836
diis-c [-9.70625168e-08 -1.95638506e-03 -3.14092602e-04  1.00227048e+00]
  HOMO = -0.848647338047153  LUMO = 0.65582266979267
  mo_energy =
[-3.27726129e+01 -1.92864257e+00 -8.48647338e-01 -8.48647338e-01
 -8.48647338e-01  6.55822670e-01  6.55822670e-01  6.55822670e-01
  2.01062419e+00  3.01439478e+00  3.01439478e+00  3.01439478e+00
  1.02620173e+01  1.02620173e+01  1.02620173e+01  1.92899316e+01
  3.39622120e+01  3.39622120e+01  3.39622120e+01  9.36706165e+01
  1.32218888e+02  1.32218888e+02  1.32218888e+02  3.55982310e+02
  1.34932417e+03  5.83574012e+03  3.50983367e+04]
E1 = -182.5748263168556  E_coul = 54.03994423137378
cycle= 4 E= -128.534882085482  delta_E= -1.39e-08  |g|= 7e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182868
diis-c [-4.62552787e-10  9.08753192e-05  4.94258691e-04 -1.16881853e-01
  1.11629672e+00]
  HOMO = -0.848682819369115  LUMO = 0.655814046478886
  mo_energy =
[-3.27726815e+01 -1.92867537e+00 -8.48682819e-01 -8.48682819e-01
 -8.48682819e-01  6.55814046e-01  6.55814046e-01  6.55814046e-01
  2.01059808e+00  3.01436631e+00  3.01436631e+00  3.01436631e+00
  1.02619701e+01  1.02619701e+01  1.02619701e+01  1.92898765e+01
  3.39621517e+01  3.39621517e+01  3.39621517e+01  9.36705500e+01
  1.32218819e+02  1.32218819e+02  1.32218819e+02  3.55982237e+02
  1.34932409e+03  5.83574004e+03  3.50983366e+04]
E1 = -182.57496179482285  E_coul = 54.04007970889215
cycle= 5 E= -128.534882085931  delta_E= -4.49e-10  |g|= 1.86e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57496179482285  E_coul = 54.04007970889215
  HOMO = -0.848682255553944  LUMO = 0.655814100494637
  mo_energy =
[-3.27726798e+01 -1.92867458e+00 -8.48682256e-01 -8.48682256e-01
 -8.48682256e-01  6.55814100e-01  6.55814100e-01  6.55814100e-01
  2.01059857e+00  3.01436665e+00  3.01436665e+00  3.01436665e+00
  1.02619710e+01  1.02619710e+01  1.02619710e+01  1.92898779e+01
  3.39621531e+01  3.39621531e+01  3.39621531e+01  9.36705516e+01
  1.32218821e+02  1.32218821e+02  1.32218821e+02  3.55982238e+02
  1.34932409e+03  5.83574004e+03  3.50983366e+04]
E1 = -182.57495596008243  E_coul = 54.04007387415104
Extra cycle  E= -128.534882085931  delta_E= -7.11e-13  |g|= 7.63e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.5113657243687
E1 = -182.57495596008243  E_coul = 54.04007387415104
init E= -128.534882085931
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.848682687669702  LUMO = 0.655814013290206
  mo_energy =
[-3.27726810e+01 -1.92867501e+00 -8.48682688e-01 -8.48682688e-01
 -8.48682688e-01  6.55814013e-01  6.55814013e-01  6.55814013e-01
  2.01059827e+00  3.01436633e+00  3.01436633e+00  3.01436633e+00
  1.02619704e+01  1.02619704e+01  1.02619704e+01  1.92898771e+01
  3.39621522e+01  3.39621522e+01  3.39621522e+01  9.36705504e+01
  1.32218820e+02  1.32218820e+02  1.32218820e+02  3.55982237e+02
  1.34932409e+03  5.83574004e+03  3.50983366e+04]
E1 = -182.5749586972723  E_coul = 54.04007661134089
cycle= 1 E= -128.534882085931  delta_E= -2.84e-14  |g|= 3.79e-07  |ddm|= 2.37e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5749586972723  E_coul = 54.04007661134089
  HOMO = -0.848682497212256  LUMO = 0.655814046928305
  mo_energy =
[-3.27726804e+01 -1.92867480e+00 -8.48682497e-01 -8.48682497e-01
 -8.48682497e-01  6.55814047e-01  6.55814047e-01  6.55814047e-01
  2.01059841e+00  3.01436646e+00  3.01436646e+00  3.01436646e+00
  1.02619707e+01  1.02619707e+01  1.02619707e+01  1.92898775e+01
  3.39621527e+01  3.39621527e+01  3.39621527e+01  9.36705510e+01
  1.32218820e+02  1.32218820e+02  1.32218820e+02  3.55982238e+02
  1.34932409e+03  5.83574004e+03  3.50983366e+04]
E1 = -182.57495725478336  E_coul = 54.040075168851864
Extra cycle  E= -128.534882085931  delta_E= -5.68e-14  |g|= 1.95e-07  |ddm|= 1.42e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498633e+02 1.74905449e+02
 2.04883419e+01 5.69668426e+01 4.87867778e-01 7.82164598e+00
 1.65548518e+00 4.99821434e+00 1.45057400e+01 5.46234493e+01
 2.29264548e-01 1.84565308e+00 6.69326680e-01]
grad_E = [ 6.73879998e-11 -3.24842587e-09  5.48337350e-08 -3.80982474e-07
  2.73888934e-07  4.78110967e-08 -1.80986508e-04 -2.58999343e-06
  1.04409831e-04  1.10552164e-04 -2.16431179e-05 -2.09393799e-04
 -2.12916522e-04 -3.08410580e-04  3.39261700e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681752        1
[INPUT] 0    0    [1    /1   ]  617.498632499        1
[INPUT] 0    0    [1    /1   ]  174.905453704        1
[INPUT] 0    0    [1    /1   ]  20.4883902962        1
[INPUT] 0    0    [1    /1   ]  56.9668261915        1
[INPUT] 0    0    [1    /1   ]  0.487292068329       1
[INPUT] 0    0    [1    /1   ]  7.8216460363         1
[INPUT] 0    0    [1    /1   ]  1.65360519025        1
[INPUT] 1    0    [1    /1   ]  4.9938319587         1
[INPUT] 1    0    [1    /1   ]  14.5009297163        1
[INPUT] 1    0    [1    /1   ]  54.6250923           1
[INPUT] 1    0    [1    /1   ]  0.229292760648       1
[INPUT] 1    0    [1    /1   ]  1.84524052617        1
[INPUT] 1    0    [1    /1   ]  0.669395445473       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730083923, 1.0]], [0, [2712.0968175174253, 1.0]], [0, [617.4986324992348, 1.0]], [0, [174.90545370426113, 1.0]], [0, [20.488390296215673, 1.0]], [0, [56.966826191538686, 1.0]], [0, [0.4872920683286565, 1.0]], [0, [7.821646036303166, 1.0]], [0, [1.6536051902540019, 1.0]], [1, [4.993831958702859, 1.0]], [1, [14.500929716263489, 1.0]], [1, [54.62509229995289, 1.0]], [1, [0.22929276064820064, 1.0]], [1, [1.8452405261701488, 1.0]], [1, [0.66939544547276, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681752]
bas 2, expnt(s) = [617.4986325]
bas 3, expnt(s) = [174.9054537]
bas 4, expnt(s) = [20.4883903]
bas 5, expnt(s) = [56.96682619]
bas 6, expnt(s) = [0.48729207]
bas 7, expnt(s) = [7.82164604]
bas 8, expnt(s) = [1.65360519]
bas 9, expnt(s) = [4.99383196]
bas 10, expnt(s) = [14.50092972]
bas 11, expnt(s) = [54.6250923]
bas 12, expnt(s) = [0.22929276]
bas 13, expnt(s) = [1.84524053]
bas 14, expnt(s) = [0.66939545]
CPU time:       113.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498632e+02 3.12962300e+02 1.74905454e+02 1.21511544e+02
 2.04883903e+01 2.43302126e+01 5.69668262e+01 5.23879666e+01
 4.87292068e-01 1.47352338e+00 7.82164604e+00 1.18164941e+01
 1.65360519e+00 3.68416349e+00 4.99383196e+00 2.17784415e+01
 1.45009297e+01 8.25523046e+01 5.46250923e+01 4.33236085e+02
 2.29292761e-01 4.62884162e-01 1.84524053e+00 6.27408825e+00
 6.69395445e-01 1.76639503e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9994053523446
cond(S) = 239.3875299836582
E1 = -183.58372826663006  E_coul = 55.08132304104423
init E= -128.502405225586
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774884601147726  LUMO = 0.669150356212191
  mo_energy =
[-3.25543408e+01 -1.85119575e+00 -7.74884601e-01 -7.74884601e-01
 -7.74884601e-01  6.69150356e-01  6.69150356e-01  6.69150356e-01
  2.05995208e+00  3.06654310e+00  3.06654310e+00  3.06654310e+00
  1.03654343e+01  1.03654343e+01  1.03654343e+01  1.94297275e+01
  3.41115297e+01  3.41115297e+01  3.41115297e+01  9.38661698e+01
  1.32410475e+02  1.32410475e+02  1.32410475e+02  3.56214019e+02
  1.34958897e+03  5.83603488e+03  3.50986532e+04]
E1 = -182.06140107630947  E_coul = 53.530141968467184
cycle= 1 E= -128.531259107842  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540474
diis-c [-0.29211213  1.        ]
  HOMO = -0.884767330172317  LUMO = 0.649287443593386
  mo_energy =
[-3.28821694e+01 -1.96683226e+00 -8.84767330e-01 -8.84767330e-01
 -8.84767330e-01  6.49287444e-01  6.49287444e-01  6.49287444e-01
  1.98127238e+00  2.98930235e+00  2.98930235e+00  2.98930235e+00
  1.02052385e+01  1.02052385e+01  1.02052385e+01  1.92043754e+01
  3.38594200e+01  3.38594200e+01  3.38594200e+01  9.35573141e+01
  1.32082276e+02  1.32082276e+02  1.32082276e+02  3.55857199e+02
  1.34919382e+03  5.83560786e+03  3.50982045e+04]
E1 = -182.83722543532704  E_coul = 54.30329395570708
cycle= 2 E= -128.53393147962  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274754
diis-c [-6.01968886e-04  3.36363153e-01  6.63636847e-01]
  HOMO = -0.848463754627106  LUMO = 0.655899087005161
  mo_energy =
[-3.27722556e+01 -1.92849176e+00 -8.48463755e-01 -8.48463755e-01
 -8.48463755e-01  6.55899087e-01  6.55899087e-01  6.55899087e-01
  2.00711163e+00  3.01455036e+00  3.01455036e+00  3.01455036e+00
  1.02583219e+01  1.02583219e+01  1.02583219e+01  1.92800211e+01
  3.39440101e+01  3.39440101e+01  3.39440101e+01  9.36611059e+01
  1.32191632e+02  1.32191632e+02  1.32191632e+02  3.55974020e+02
  1.34931699e+03  5.83573402e+03  3.50983318e+04]
E1 = -182.5742734080834  E_coul = 54.03939087549773
cycle= 3 E= -128.534882532586  delta_E= -0.000951  |g|= 0.000397  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102452
diis-c [-9.80774179e-08 -1.95775489e-03 -2.95669799e-04  1.00225342e+00]
  HOMO = -0.848663208654969  LUMO = 0.65588537335232
  mo_energy =
[-3.27726485e+01 -1.92864696e+00 -8.48663209e-01 -8.48663209e-01
 -8.48663209e-01  6.55885373e-01  6.55885373e-01  6.55885373e-01
  2.00703366e+00  3.01445231e+00  3.01445231e+00  3.01445231e+00
  1.02581194e+01  1.02581194e+01  1.02581194e+01  1.92797728e+01
  3.39437124e+01  3.39437124e+01  3.39437124e+01  9.36607404e+01
  1.32191227e+02  1.32191227e+02  1.32191227e+02  3.55973536e+02
  1.34931637e+03  5.83573329e+03  3.50983311e+04]
E1 = -182.57464990051056  E_coul = 54.03976735396568
cycle= 4 E= -128.534882546545  delta_E= -1.4e-08  |g|= 7.04e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184248
diis-c [-4.67372212e-10  9.19852442e-05  4.97179069e-04 -1.17608071e-01
  1.11701891e+00]
  HOMO = -0.848698788316919  LUMO = 0.655876746533618
  mo_energy =
[-3.27727175e+01 -1.92867969e+00 -8.48698788e-01 -8.48698788e-01
 -8.48698788e-01  6.55876747e-01  6.55876747e-01  6.55876747e-01
  2.00700764e+00  3.01442380e+00  3.01442380e+00  3.01442380e+00
  1.02580721e+01  1.02580721e+01  1.02580721e+01  1.92797175e+01
  3.39436518e+01  3.39436518e+01  3.39436518e+01  9.36606736e+01
  1.32191158e+02  1.32191158e+02  1.32191158e+02  3.55973462e+02
  1.34931629e+03  5.83573320e+03  3.50983310e+04]
E1 = -182.57478648033572  E_coul = 54.039903933337946
cycle= 5 E= -128.534882546998  delta_E= -4.53e-10  |g|= 1.88e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57478648033572  E_coul = 54.039903933337946
  HOMO = -0.848698209940014  LUMO = 0.655876806130827
  mo_energy =
[-3.27727158e+01 -1.92867887e+00 -8.48698210e-01 -8.48698210e-01
 -8.48698210e-01  6.55876806e-01  6.55876806e-01  6.55876806e-01
  2.00700816e+00  3.01442415e+00  3.01442415e+00  3.01442415e+00
  1.02580730e+01  1.02580730e+01  1.02580730e+01  1.92797190e+01
  3.39436533e+01  3.39436533e+01  3.39436533e+01  9.36606752e+01
  1.32191160e+02  1.32191160e+02  1.32191160e+02  3.55973463e+02
  1.34931629e+03  5.83573320e+03  3.50983310e+04]
E1 = -182.57478066759745  E_coul = 54.03989812059922
Extra cycle  E= -128.534882546998  delta_E= -4.55e-13  |g|= 7.62e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498632e+02 1.74905454e+02
 2.04883903e+01 5.69668262e+01 4.87292068e-01 7.82164604e+00
 1.65360519e+00 4.99383196e+00 1.45009297e+01 5.46250923e+01
 2.29292761e-01 1.84524053e+00 6.69395445e-01]
E = -128.53488254699823
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681752        1
[INPUT] 0    0    [1    /1   ]  617.498632499        1
[INPUT] 0    0    [1    /1   ]  174.905453704        1
[INPUT] 0    0    [1    /1   ]  20.4883902962        1
[INPUT] 0    0    [1    /1   ]  56.9668261915        1
[INPUT] 0    0    [1    /1   ]  0.487292068329       1
[INPUT] 0    0    [1    /1   ]  7.8216460363         1
[INPUT] 0    0    [1    /1   ]  1.65360519025        1
[INPUT] 1    0    [1    /1   ]  4.9938319587         1
[INPUT] 1    0    [1    /1   ]  14.5009297163        1
[INPUT] 1    0    [1    /1   ]  54.6250923           1
[INPUT] 1    0    [1    /1   ]  0.229292760648       1
[INPUT] 1    0    [1    /1   ]  1.84524052617        1
[INPUT] 1    0    [1    /1   ]  0.669395445473       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730083923, 1.0]], [0, [2712.0968175174253, 1.0]], [0, [617.4986324992348, 1.0]], [0, [174.90545370426113, 1.0]], [0, [20.488390296215673, 1.0]], [0, [56.966826191538686, 1.0]], [0, [0.4872920683286565, 1.0]], [0, [7.821646036303166, 1.0]], [0, [1.6536051902540019, 1.0]], [1, [4.993831958702859, 1.0]], [1, [14.500929716263489, 1.0]], [1, [54.62509229995289, 1.0]], [1, [0.22929276064820064, 1.0]], [1, [1.8452405261701488, 1.0]], [1, [0.66939544547276, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681752]
bas 2, expnt(s) = [617.4986325]
bas 3, expnt(s) = [174.9054537]
bas 4, expnt(s) = [20.4883903]
bas 5, expnt(s) = [56.96682619]
bas 6, expnt(s) = [0.48729207]
bas 7, expnt(s) = [7.82164604]
bas 8, expnt(s) = [1.65360519]
bas 9, expnt(s) = [4.99383196]
bas 10, expnt(s) = [14.50092972]
bas 11, expnt(s) = [54.6250923]
bas 12, expnt(s) = [0.22929276]
bas 13, expnt(s) = [1.84524053]
bas 14, expnt(s) = [0.66939545]
CPU time:       114.41
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498632e+02 3.12962300e+02 1.74905454e+02 1.21511544e+02
 2.04883903e+01 2.43302126e+01 5.69668262e+01 5.23879666e+01
 4.87292068e-01 1.47352338e+00 7.82164604e+00 1.18164941e+01
 1.65360519e+00 3.68416349e+00 4.99383196e+00 2.17784415e+01
 1.45009297e+01 8.25523046e+01 5.46250923e+01 4.33236085e+02
 2.29292761e-01 4.62884162e-01 1.84524053e+00 6.27408825e+00
 6.69395445e-01 1.76639503e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9994053523446
cond(S) = 239.3875299836582
E1 = -183.58372826663006  E_coul = 55.08132304104423
init E= -128.502405225586
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774884601147726  LUMO = 0.669150356212191
  mo_energy =
[-3.25543408e+01 -1.85119575e+00 -7.74884601e-01 -7.74884601e-01
 -7.74884601e-01  6.69150356e-01  6.69150356e-01  6.69150356e-01
  2.05995208e+00  3.06654310e+00  3.06654310e+00  3.06654310e+00
  1.03654343e+01  1.03654343e+01  1.03654343e+01  1.94297275e+01
  3.41115297e+01  3.41115297e+01  3.41115297e+01  9.38661698e+01
  1.32410475e+02  1.32410475e+02  1.32410475e+02  3.56214019e+02
  1.34958897e+03  5.83603488e+03  3.50986532e+04]
E1 = -182.06140107630947  E_coul = 53.530141968467184
cycle= 1 E= -128.531259107842  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540474
diis-c [-0.29211213  1.        ]
  HOMO = -0.884767330172317  LUMO = 0.649287443593386
  mo_energy =
[-3.28821694e+01 -1.96683226e+00 -8.84767330e-01 -8.84767330e-01
 -8.84767330e-01  6.49287444e-01  6.49287444e-01  6.49287444e-01
  1.98127238e+00  2.98930235e+00  2.98930235e+00  2.98930235e+00
  1.02052385e+01  1.02052385e+01  1.02052385e+01  1.92043754e+01
  3.38594200e+01  3.38594200e+01  3.38594200e+01  9.35573141e+01
  1.32082276e+02  1.32082276e+02  1.32082276e+02  3.55857199e+02
  1.34919382e+03  5.83560786e+03  3.50982045e+04]
E1 = -182.83722543532704  E_coul = 54.30329395570708
cycle= 2 E= -128.53393147962  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274754
diis-c [-6.01968886e-04  3.36363153e-01  6.63636847e-01]
  HOMO = -0.848463754627106  LUMO = 0.655899087005161
  mo_energy =
[-3.27722556e+01 -1.92849176e+00 -8.48463755e-01 -8.48463755e-01
 -8.48463755e-01  6.55899087e-01  6.55899087e-01  6.55899087e-01
  2.00711163e+00  3.01455036e+00  3.01455036e+00  3.01455036e+00
  1.02583219e+01  1.02583219e+01  1.02583219e+01  1.92800211e+01
  3.39440101e+01  3.39440101e+01  3.39440101e+01  9.36611059e+01
  1.32191632e+02  1.32191632e+02  1.32191632e+02  3.55974020e+02
  1.34931699e+03  5.83573402e+03  3.50983318e+04]
E1 = -182.5742734080834  E_coul = 54.03939087549773
cycle= 3 E= -128.534882532586  delta_E= -0.000951  |g|= 0.000397  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102452
diis-c [-9.80774179e-08 -1.95775489e-03 -2.95669799e-04  1.00225342e+00]
  HOMO = -0.848663208654969  LUMO = 0.65588537335232
  mo_energy =
[-3.27726485e+01 -1.92864696e+00 -8.48663209e-01 -8.48663209e-01
 -8.48663209e-01  6.55885373e-01  6.55885373e-01  6.55885373e-01
  2.00703366e+00  3.01445231e+00  3.01445231e+00  3.01445231e+00
  1.02581194e+01  1.02581194e+01  1.02581194e+01  1.92797728e+01
  3.39437124e+01  3.39437124e+01  3.39437124e+01  9.36607404e+01
  1.32191227e+02  1.32191227e+02  1.32191227e+02  3.55973536e+02
  1.34931637e+03  5.83573329e+03  3.50983311e+04]
E1 = -182.57464990051056  E_coul = 54.03976735396568
cycle= 4 E= -128.534882546545  delta_E= -1.4e-08  |g|= 7.04e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184248
diis-c [-4.67372212e-10  9.19852442e-05  4.97179069e-04 -1.17608071e-01
  1.11701891e+00]
  HOMO = -0.848698788316919  LUMO = 0.655876746533618
  mo_energy =
[-3.27727175e+01 -1.92867969e+00 -8.48698788e-01 -8.48698788e-01
 -8.48698788e-01  6.55876747e-01  6.55876747e-01  6.55876747e-01
  2.00700764e+00  3.01442380e+00  3.01442380e+00  3.01442380e+00
  1.02580721e+01  1.02580721e+01  1.02580721e+01  1.92797175e+01
  3.39436518e+01  3.39436518e+01  3.39436518e+01  9.36606736e+01
  1.32191158e+02  1.32191158e+02  1.32191158e+02  3.55973462e+02
  1.34931629e+03  5.83573320e+03  3.50983310e+04]
E1 = -182.57478648033572  E_coul = 54.039903933337946
cycle= 5 E= -128.534882546998  delta_E= -4.53e-10  |g|= 1.88e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57478648033572  E_coul = 54.039903933337946
  HOMO = -0.848698209940014  LUMO = 0.655876806130827
  mo_energy =
[-3.27727158e+01 -1.92867887e+00 -8.48698210e-01 -8.48698210e-01
 -8.48698210e-01  6.55876806e-01  6.55876806e-01  6.55876806e-01
  2.00700816e+00  3.01442415e+00  3.01442415e+00  3.01442415e+00
  1.02580730e+01  1.02580730e+01  1.02580730e+01  1.92797190e+01
  3.39436533e+01  3.39436533e+01  3.39436533e+01  9.36606752e+01
  1.32191160e+02  1.32191160e+02  1.32191160e+02  3.55973463e+02
  1.34931629e+03  5.83573320e+03  3.50983310e+04]
E1 = -182.57478066759745  E_coul = 54.03989812059922
Extra cycle  E= -128.534882546998  delta_E= -4.55e-13  |g|= 7.62e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.3875299836582
E1 = -182.57478066759745  E_coul = 54.03989812059922
init E= -128.534882546998
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.84869864044276  LUMO = 0.655876719715256
  mo_energy =
[-3.27727170e+01 -1.92867929e+00 -8.48698640e-01 -8.48698640e-01
 -8.48698640e-01  6.55876720e-01  6.55876720e-01  6.55876720e-01
  2.00700786e+00  3.01442384e+00  3.01442384e+00  3.01442384e+00
  1.02580724e+01  1.02580724e+01  1.02580724e+01  1.92797181e+01
  3.39436523e+01  3.39436523e+01  3.39436523e+01  9.36606741e+01
  1.32191158e+02  1.32191158e+02  1.32191158e+02  3.55973462e+02
  1.34931629e+03  5.83573320e+03  3.50983310e+04]
E1 = -182.57478341296996  E_coul = 54.039900865971774
cycle= 1 E= -128.534882546998  delta_E= 5.68e-14  |g|= 3.8e-07  |ddm|= 2.33e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57478341296996  E_coul = 54.039900865971774
  HOMO = -0.848698449418694  LUMO = 0.655876753554815
  mo_energy =
[-3.27727164e+01 -1.92867908e+00 -8.48698449e-01 -8.48698449e-01
 -8.48698449e-01  6.55876754e-01  6.55876754e-01  6.55876754e-01
  2.00700800e+00  3.01442397e+00  3.01442397e+00  3.01442397e+00
  1.02580727e+01  1.02580727e+01  1.02580727e+01  1.92797185e+01
  3.39436528e+01  3.39436528e+01  3.39436528e+01  9.36606746e+01
  1.32191159e+02  1.32191159e+02  1.32191159e+02  3.55973463e+02
  1.34931629e+03  5.83573320e+03  3.50983310e+04]
E1 = -182.5747819698866  E_coul = 54.03989942288828
Extra cycle  E= -128.534882546998  delta_E= -1.42e-13  |g|= 1.95e-07  |ddm|= 1.43e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498632e+02 1.74905454e+02
 2.04883903e+01 5.69668262e+01 4.87292068e-01 7.82164604e+00
 1.65360519e+00 4.99383196e+00 1.45009297e+01 5.46250923e+01
 2.29292761e-01 1.84524053e+00 6.69395445e-01]
grad_E = [ 6.46401969e-11 -3.08936353e-09  5.20977118e-08 -3.41149594e-07
  2.47475531e-06 -1.84146702e-07 -3.55364424e-04 -4.24716909e-06
  3.04678800e-05  3.82428146e-05 -8.20036309e-06 -2.10021778e-04
 -1.13564695e-04 -1.59484538e-04  1.92956202e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681754        1
[INPUT] 0    0    [1    /1   ]  617.498632115        1
[INPUT] 0    0    [1    /1   ]  174.905457674        1
[INPUT] 0    0    [1    /1   ]  20.4884257544        1
[INPUT] 0    0    [1    /1   ]  56.9668069276        1
[INPUT] 0    0    [1    /1   ]  0.48708354535        1
[INPUT] 0    0    [1    /1   ]  7.82166773472        1
[INPUT] 0    0    [1    /1   ]  1.65265923093        1
[INPUT] 1    0    [1    /1   ]  4.99106997088        1
[INPUT] 1    0    [1    /1   ]  14.4924326023        1
[INPUT] 1    0    [1    /1   ]  54.6266109632        1
[INPUT] 1    0    [1    /1   ]  0.229377209627       1
[INPUT] 1    0    [1    /1   ]  1.84593605675        1
[INPUT] 1    0    [1    /1   ]  0.669757297462       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008354, 1.0]], [0, [2712.096817537585, 1.0]], [0, [617.4986321151075, 1.0]], [0, [174.90545767414383, 1.0]], [0, [20.488425754357213, 1.0]], [0, [56.966806927603024, 1.0]], [0, [0.4870835453503015, 1.0]], [0, [7.821667734717045, 1.0]], [0, [1.652659230932695, 1.0]], [1, [4.991069970875106, 1.0]], [1, [14.49243260229167, 1.0]], [1, [54.626610963227215, 1.0]], [1, [0.22937720962692176, 1.0]], [1, [1.8459360567466514, 1.0]], [1, [0.669757297461639, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681754]
bas 2, expnt(s) = [617.49863212]
bas 3, expnt(s) = [174.90545767]
bas 4, expnt(s) = [20.48842575]
bas 5, expnt(s) = [56.96680693]
bas 6, expnt(s) = [0.48708355]
bas 7, expnt(s) = [7.82166773]
bas 8, expnt(s) = [1.65265923]
bas 9, expnt(s) = [4.99106997]
bas 10, expnt(s) = [14.4924326]
bas 11, expnt(s) = [54.62661096]
bas 12, expnt(s) = [0.22937721]
bas 13, expnt(s) = [1.84593606]
bas 14, expnt(s) = [0.6697573]
CPU time:       117.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498632e+02 3.12962300e+02 1.74905458e+02 1.21511546e+02
 2.04884258e+01 2.43302441e+01 5.69668069e+01 5.23879534e+01
 4.87083545e-01 1.47305044e+00 7.82166773e+00 1.18165187e+01
 1.65265923e+00 3.68258271e+00 4.99106997e+00 2.17633860e+01
 1.44924326e+01 8.24918426e+01 5.46266110e+01 4.33251141e+02
 2.29377210e-01 4.63097274e-01 1.84593606e+00 6.27704452e+00
 6.69757297e-01 1.76758867e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99940635698079
cond(S) = 239.33145800406467
E1 = -183.58371370215318  E_coul = 55.08131266899414
init E= -128.502401033159
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77488535976706  LUMO = 0.669458934387732
  mo_energy =
[-3.25543430e+01 -1.85119665e+00 -7.74885360e-01 -7.74885360e-01
 -7.74885360e-01  6.69458934e-01  6.69458934e-01  6.69458934e-01
  2.05839176e+00  3.06805190e+00  3.06805190e+00  3.06805190e+00
  1.03667427e+01  1.03667427e+01  1.03667427e+01  1.94250257e+01
  3.40985107e+01  3.40985107e+01  3.40985107e+01  9.38616279e+01
  1.32380618e+02  1.32380618e+02  1.32380618e+02  3.56209996e+02
  1.34958539e+03  5.83603175e+03  3.50986506e+04]
E1 = -182.0613904234587  E_coul = 53.530131081862464
cycle= 1 E= -128.531259341596  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540496
diis-c [-0.29213607  1.        ]
  HOMO = -0.884767333484404  LUMO = 0.649583336691713
  mo_energy =
[-3.28821776e+01 -1.96682957e+00 -8.84767333e-01 -8.84767333e-01
 -8.84767333e-01  6.49583337e-01  6.49583337e-01  6.49583337e-01
  1.97975686e+00  2.99078843e+00  2.99078843e+00  2.99078843e+00
  1.02065771e+01  1.02065771e+01  1.02065771e+01  1.91996804e+01
  3.38464495e+01  3.38464495e+01  3.38464495e+01  9.35527662e+01
  1.32052415e+02  1.32052415e+02  1.32052415e+02  3.55853168e+02
  1.34919024e+03  5.83560472e+03  3.50982019e+04]
E1 = -182.83721601914667  E_coul = 54.30328427492538
cycle= 2 E= -128.533931744221  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274758
diis-c [-6.01909809e-04  3.36358014e-01  6.63641986e-01]
  HOMO = -0.848463231917963  LUMO = 0.656199488304073
  mo_energy =
[-3.27722632e+01 -1.92848892e+00 -8.48463232e-01 -8.48463232e-01
 -8.48463232e-01  6.56199488e-01  6.56199488e-01  6.56199488e-01
  2.00558210e+00  3.01604450e+00  3.01604450e+00  3.01604450e+00
  1.02596507e+01  1.02596507e+01  1.02596507e+01  1.92753258e+01
  3.39310231e+01  3.39310231e+01  3.39310231e+01  9.36565592e+01
  1.32161771e+02  1.32161771e+02  1.32161771e+02  3.55969989e+02
  1.34931341e+03  5.83573088e+03  3.50983292e+04]
E1 = -182.57426627768857  E_coul = 54.03938349910849
cycle= 3 E= -128.53488277858  delta_E= -0.000951  |g|= 0.000397  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102571
diis-c [-9.81872646e-08 -1.95754147e-03 -2.91008777e-04  1.00224855e+00]
  HOMO = -0.848662671404551  LUMO = 0.656185816014977
  mo_energy =
[-3.27726563e+01 -1.92864402e+00 -8.48662671e-01 -8.48662671e-01
 -8.48662671e-01  6.56185816e-01  6.56185816e-01  6.56185816e-01
  2.00550429e+00  3.01594648e+00  3.01594648e+00  3.01594648e+00
  1.02594483e+01  1.02594483e+01  1.02594483e+01  1.92750775e+01
  3.39307253e+01  3.39307253e+01  3.39307253e+01  9.36561935e+01
  1.32161365e+02  1.32161365e+02  1.32161365e+02  3.55969505e+02
  1.34931279e+03  5.83573015e+03  3.50983285e+04]
E1 = -182.5746438909952  E_coul = 54.039761098471935
cycle= 4 E= -128.534882792523  delta_E= -1.39e-08  |g|= 7.04e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184405
diis-c [-4.67680701e-10  9.19179212e-05  4.97230987e-04 -1.17586289e-01
  1.11699714e+00]
  HOMO = -0.848698235039892  LUMO = 0.656177195609456
  mo_energy =
[-3.27727253e+01 -1.92867670e+00 -8.48698235e-01 -8.48698235e-01
 -8.48698235e-01  6.56177196e-01  6.56177196e-01  6.56177196e-01
  2.00547832e+00  3.01591799e+00  3.01591799e+00  3.01591799e+00
  1.02594010e+01  1.02594010e+01  1.02594010e+01  1.92750222e+01
  3.39306648e+01  3.39306648e+01  3.39306648e+01  9.36561267e+01
  1.32161296e+02  1.32161296e+02  1.32161296e+02  3.55969431e+02
  1.34931271e+03  5.83573006e+03  3.50983284e+04]
E1 = -182.5747806339652  E_coul = 54.039897840988836
cycle= 5 E= -128.534882792976  delta_E= -4.53e-10  |g|= 1.88e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5747806339652  E_coul = 54.039897840988836
  HOMO = -0.848697656999412  LUMO = 0.656177255720054
  mo_energy =
[-3.27727236e+01 -1.92867588e+00 -8.48697657e-01 -8.48697657e-01
 -8.48697657e-01  6.56177256e-01  6.56177256e-01  6.56177256e-01
  2.00547885e+00  3.01591834e+00  3.01591834e+00  3.01591834e+00
  1.02594019e+01  1.02594019e+01  1.02594019e+01  1.92750237e+01
  3.39306662e+01  3.39306662e+01  3.39306662e+01  9.36561283e+01
  1.32161298e+02  1.32161298e+02  1.32161298e+02  3.55969433e+02
  1.34931271e+03  5.83573006e+03  3.50983284e+04]
E1 = -182.57477484488896  E_coul = 54.03989205191248
Extra cycle  E= -128.534882792976  delta_E= -1.14e-13  |g|= 7.59e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498632e+02 1.74905458e+02
 2.04884258e+01 5.69668069e+01 4.87083545e-01 7.82166773e+00
 1.65265923e+00 4.99106997e+00 1.44924326e+01 5.46266110e+01
 2.29377210e-01 1.84593606e+00 6.69757297e-01]
E = -128.53488279297648
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681754        1
[INPUT] 0    0    [1    /1   ]  617.498632115        1
[INPUT] 0    0    [1    /1   ]  174.905457674        1
[INPUT] 0    0    [1    /1   ]  20.4884257544        1
[INPUT] 0    0    [1    /1   ]  56.9668069276        1
[INPUT] 0    0    [1    /1   ]  0.48708354535        1
[INPUT] 0    0    [1    /1   ]  7.82166773472        1
[INPUT] 0    0    [1    /1   ]  1.65265923093        1
[INPUT] 1    0    [1    /1   ]  4.99106997088        1
[INPUT] 1    0    [1    /1   ]  14.4924326023        1
[INPUT] 1    0    [1    /1   ]  54.6266109632        1
[INPUT] 1    0    [1    /1   ]  0.229377209627       1
[INPUT] 1    0    [1    /1   ]  1.84593605675        1
[INPUT] 1    0    [1    /1   ]  0.669757297462       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008354, 1.0]], [0, [2712.096817537585, 1.0]], [0, [617.4986321151075, 1.0]], [0, [174.90545767414383, 1.0]], [0, [20.488425754357213, 1.0]], [0, [56.966806927603024, 1.0]], [0, [0.4870835453503015, 1.0]], [0, [7.821667734717045, 1.0]], [0, [1.652659230932695, 1.0]], [1, [4.991069970875106, 1.0]], [1, [14.49243260229167, 1.0]], [1, [54.626610963227215, 1.0]], [1, [0.22937720962692176, 1.0]], [1, [1.8459360567466514, 1.0]], [1, [0.669757297461639, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681754]
bas 2, expnt(s) = [617.49863212]
bas 3, expnt(s) = [174.90545767]
bas 4, expnt(s) = [20.48842575]
bas 5, expnt(s) = [56.96680693]
bas 6, expnt(s) = [0.48708355]
bas 7, expnt(s) = [7.82166773]
bas 8, expnt(s) = [1.65265923]
bas 9, expnt(s) = [4.99106997]
bas 10, expnt(s) = [14.4924326]
bas 11, expnt(s) = [54.62661096]
bas 12, expnt(s) = [0.22937721]
bas 13, expnt(s) = [1.84593606]
bas 14, expnt(s) = [0.6697573]
CPU time:       118.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498632e+02 3.12962300e+02 1.74905458e+02 1.21511546e+02
 2.04884258e+01 2.43302441e+01 5.69668069e+01 5.23879534e+01
 4.87083545e-01 1.47305044e+00 7.82166773e+00 1.18165187e+01
 1.65265923e+00 3.68258271e+00 4.99106997e+00 2.17633860e+01
 1.44924326e+01 8.24918426e+01 5.46266110e+01 4.33251141e+02
 2.29377210e-01 4.63097274e-01 1.84593606e+00 6.27704452e+00
 6.69757297e-01 1.76758867e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99940635698079
cond(S) = 239.33145800406467
E1 = -183.58371370215318  E_coul = 55.08131266899414
init E= -128.502401033159
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77488535976706  LUMO = 0.669458934387732
  mo_energy =
[-3.25543430e+01 -1.85119665e+00 -7.74885360e-01 -7.74885360e-01
 -7.74885360e-01  6.69458934e-01  6.69458934e-01  6.69458934e-01
  2.05839176e+00  3.06805190e+00  3.06805190e+00  3.06805190e+00
  1.03667427e+01  1.03667427e+01  1.03667427e+01  1.94250257e+01
  3.40985107e+01  3.40985107e+01  3.40985107e+01  9.38616279e+01
  1.32380618e+02  1.32380618e+02  1.32380618e+02  3.56209996e+02
  1.34958539e+03  5.83603175e+03  3.50986506e+04]
E1 = -182.0613904234587  E_coul = 53.530131081862464
cycle= 1 E= -128.531259341596  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540496
diis-c [-0.29213607  1.        ]
  HOMO = -0.884767333484404  LUMO = 0.649583336691713
  mo_energy =
[-3.28821776e+01 -1.96682957e+00 -8.84767333e-01 -8.84767333e-01
 -8.84767333e-01  6.49583337e-01  6.49583337e-01  6.49583337e-01
  1.97975686e+00  2.99078843e+00  2.99078843e+00  2.99078843e+00
  1.02065771e+01  1.02065771e+01  1.02065771e+01  1.91996804e+01
  3.38464495e+01  3.38464495e+01  3.38464495e+01  9.35527662e+01
  1.32052415e+02  1.32052415e+02  1.32052415e+02  3.55853168e+02
  1.34919024e+03  5.83560472e+03  3.50982019e+04]
E1 = -182.83721601914667  E_coul = 54.30328427492538
cycle= 2 E= -128.533931744221  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274758
diis-c [-6.01909809e-04  3.36358014e-01  6.63641986e-01]
  HOMO = -0.848463231917963  LUMO = 0.656199488304073
  mo_energy =
[-3.27722632e+01 -1.92848892e+00 -8.48463232e-01 -8.48463232e-01
 -8.48463232e-01  6.56199488e-01  6.56199488e-01  6.56199488e-01
  2.00558210e+00  3.01604450e+00  3.01604450e+00  3.01604450e+00
  1.02596507e+01  1.02596507e+01  1.02596507e+01  1.92753258e+01
  3.39310231e+01  3.39310231e+01  3.39310231e+01  9.36565592e+01
  1.32161771e+02  1.32161771e+02  1.32161771e+02  3.55969989e+02
  1.34931341e+03  5.83573088e+03  3.50983292e+04]
E1 = -182.57426627768857  E_coul = 54.03938349910849
cycle= 3 E= -128.53488277858  delta_E= -0.000951  |g|= 0.000397  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102571
diis-c [-9.81872646e-08 -1.95754147e-03 -2.91008777e-04  1.00224855e+00]
  HOMO = -0.848662671404551  LUMO = 0.656185816014977
  mo_energy =
[-3.27726563e+01 -1.92864402e+00 -8.48662671e-01 -8.48662671e-01
 -8.48662671e-01  6.56185816e-01  6.56185816e-01  6.56185816e-01
  2.00550429e+00  3.01594648e+00  3.01594648e+00  3.01594648e+00
  1.02594483e+01  1.02594483e+01  1.02594483e+01  1.92750775e+01
  3.39307253e+01  3.39307253e+01  3.39307253e+01  9.36561935e+01
  1.32161365e+02  1.32161365e+02  1.32161365e+02  3.55969505e+02
  1.34931279e+03  5.83573015e+03  3.50983285e+04]
E1 = -182.5746438909952  E_coul = 54.039761098471935
cycle= 4 E= -128.534882792523  delta_E= -1.39e-08  |g|= 7.04e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000184405
diis-c [-4.67680701e-10  9.19179212e-05  4.97230987e-04 -1.17586289e-01
  1.11699714e+00]
  HOMO = -0.848698235039892  LUMO = 0.656177195609456
  mo_energy =
[-3.27727253e+01 -1.92867670e+00 -8.48698235e-01 -8.48698235e-01
 -8.48698235e-01  6.56177196e-01  6.56177196e-01  6.56177196e-01
  2.00547832e+00  3.01591799e+00  3.01591799e+00  3.01591799e+00
  1.02594010e+01  1.02594010e+01  1.02594010e+01  1.92750222e+01
  3.39306648e+01  3.39306648e+01  3.39306648e+01  9.36561267e+01
  1.32161296e+02  1.32161296e+02  1.32161296e+02  3.55969431e+02
  1.34931271e+03  5.83573006e+03  3.50983284e+04]
E1 = -182.5747806339652  E_coul = 54.039897840988836
cycle= 5 E= -128.534882792976  delta_E= -4.53e-10  |g|= 1.88e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5747806339652  E_coul = 54.039897840988836
  HOMO = -0.848697656999412  LUMO = 0.656177255720054
  mo_energy =
[-3.27727236e+01 -1.92867588e+00 -8.48697657e-01 -8.48697657e-01
 -8.48697657e-01  6.56177256e-01  6.56177256e-01  6.56177256e-01
  2.00547885e+00  3.01591834e+00  3.01591834e+00  3.01591834e+00
  1.02594019e+01  1.02594019e+01  1.02594019e+01  1.92750237e+01
  3.39306662e+01  3.39306662e+01  3.39306662e+01  9.36561283e+01
  1.32161298e+02  1.32161298e+02  1.32161298e+02  3.55969433e+02
  1.34931271e+03  5.83573006e+03  3.50983284e+04]
E1 = -182.57477484488896  E_coul = 54.03989205191248
Extra cycle  E= -128.534882792976  delta_E= -1.14e-13  |g|= 7.59e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.33145800406467
E1 = -182.57477484488896  E_coul = 54.03989205191248
init E= -128.534882792976
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.848698085838358  LUMO = 0.656177169654491
  mo_energy =
[-3.27727248e+01 -1.92867630e+00 -8.48698086e-01 -8.48698086e-01
 -8.48698086e-01  6.56177170e-01  6.56177170e-01  6.56177170e-01
  2.00547855e+00  3.01591803e+00  3.01591803e+00  3.01591803e+00
  1.02594013e+01  1.02594013e+01  1.02594013e+01  1.92750229e+01
  3.39306653e+01  3.39306653e+01  3.39306653e+01  9.36561272e+01
  1.32161297e+02  1.32161297e+02  1.32161297e+02  3.55969431e+02
  1.34931271e+03  5.83573006e+03  3.50983284e+04]
E1 = -182.57477758184174  E_coul = 54.039894788865
cycle= 1 E= -128.534882792977  delta_E= -2.84e-13  |g|= 3.79e-07  |ddm|= 2.31e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57477758184174  E_coul = 54.039894788865
  HOMO = -0.848697895413934  LUMO = 0.656177203426561
  mo_energy =
[-3.27727242e+01 -1.92867609e+00 -8.48697895e-01 -8.48697895e-01
 -8.48697895e-01  6.56177203e-01  6.56177203e-01  6.56177203e-01
  2.00547869e+00  3.01591816e+00  3.01591816e+00  3.01591816e+00
  1.02594015e+01  1.02594015e+01  1.02594015e+01  1.92750233e+01
  3.39306658e+01  3.39306658e+01  3.39306658e+01  9.36561277e+01
  1.32161297e+02  1.32161297e+02  1.32161297e+02  3.55969432e+02
  1.34931271e+03  5.83573006e+03  3.50983284e+04]
E1 = -182.57477614383717  E_coul = 54.03989335086034
Extra cycle  E= -128.534882792977  delta_E= -5.68e-14  |g|= 1.94e-07  |ddm|= 1.43e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.29 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498632e+02 1.74905458e+02
 2.04884258e+01 5.69668069e+01 4.87083545e-01 7.82166773e+00
 1.65265923e+00 4.99106997e+00 1.44924326e+01 5.46266110e+01
 2.29377210e-01 1.84593606e+00 6.69757297e-01]
grad_E = [ 6.24822110e-11 -2.96701094e-09  4.99288777e-08 -3.11018790e-07
  4.06407945e-06 -3.69694457e-07 -2.67960474e-04 -6.08136081e-06
 -5.33390713e-05 -1.43516330e-05 -4.55356115e-06 -2.09578892e-04
 -1.46180392e-06 -8.45454488e-06  2.15699333e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681755        1
[INPUT] 0    0    [1    /1   ]  617.498631842        1
[INPUT] 0    0    [1    /1   ]  174.90546042         1
[INPUT] 0    0    [1    /1   ]  20.4884410506        1
[INPUT] 0    0    [1    /1   ]  56.966794134         1
[INPUT] 0    0    [1    /1   ]  0.487104959652       1
[INPUT] 0    0    [1    /1   ]  7.82169442461        1
[INPUT] 0    0    [1    /1   ]  1.65238569334        1
[INPUT] 1    0    [1    /1   ]  4.99016069198        1
[INPUT] 1    0    [1    /1   ]  14.4857705325        1
[INPUT] 1    0    [1    /1   ]  54.6277761262        1
[INPUT] 1    0    [1    /1   ]  0.229441485102       1
[INPUT] 1    0    [1    /1   ]  1.84681238689        1
[INPUT] 1    0    [1    /1   ]  0.670087420009       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008327, 1.0]], [0, [2712.0968175519383, 1.0]], [0, [617.4986318416181, 1.0]], [0, [174.90546042002393, 1.0]], [0, [20.488441050559313, 1.0]], [0, [56.96679413399665, 1.0]], [0, [0.48710495965218287, 1.0]], [0, [7.821694424612506, 1.0]], [0, [1.6523856933430774, 1.0]], [1, [4.990160691975493, 1.0]], [1, [14.485770532487715, 1.0]], [1, [54.627776126158764, 1.0]], [1, [0.22944148510156656, 1.0]], [1, [1.8468123868895807, 1.0]], [1, [0.6700874200090744, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681755]
bas 2, expnt(s) = [617.49863184]
bas 3, expnt(s) = [174.90546042]
bas 4, expnt(s) = [20.48844105]
bas 5, expnt(s) = [56.96679413]
bas 6, expnt(s) = [0.48710496]
bas 7, expnt(s) = [7.82169442]
bas 8, expnt(s) = [1.65238569]
bas 9, expnt(s) = [4.99016069]
bas 10, expnt(s) = [14.48577053]
bas 11, expnt(s) = [54.62777613]
bas 12, expnt(s) = [0.22944149]
bas 13, expnt(s) = [1.84681239]
bas 14, expnt(s) = [0.67008742]
CPU time:       121.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498632e+02 3.12962299e+02 1.74905460e+02 1.21511547e+02
 2.04884411e+01 2.43302578e+01 5.69667941e+01 5.23879445e+01
 4.87104960e-01 1.47309901e+00 7.82169442e+00 1.18165489e+01
 1.65238569e+00 3.68212556e+00 4.99016069e+00 2.17584300e+01
 1.44857705e+01 8.24444441e+01 5.46277761e+01 4.33262692e+02
 2.29441485e-01 4.63259489e-01 1.84681239e+00 6.28076965e+00
 6.70087420e-01 1.76867779e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999406415913743
cond(S) = 239.3213857448474
E1 = -183.58370240070857  E_coul = 55.08130358865191
init E= -128.502398812057
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774885642466036  LUMO = 0.669717898858808
  mo_energy =
[-3.25543460e+01 -1.85119702e+00 -7.74885642e-01 -7.74885642e-01
 -7.74885642e-01  6.69717899e-01  6.69717899e-01  6.69717899e-01
  2.05821888e+00  3.06949958e+00  3.06949958e+00  3.06949958e+00
  1.03696868e+01  1.03696868e+01  1.03696868e+01  1.94240686e+01
  3.40930856e+01  3.40930856e+01  3.40930856e+01  9.38607113e+01
  1.32362332e+02  1.32362332e+02  1.32362332e+02  3.56209190e+02
  1.34958467e+03  5.83603112e+03  3.50986501e+04]
E1 = -182.06150312962097  E_coul = 53.53024309817422
cycle= 1 E= -128.531260031447  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540471
diis-c [-0.29210856  1.        ]
  HOMO = -0.88475660910218  LUMO = 0.649832940188721
  mo_energy =
[-3.28821622e+01 -1.96682107e+00 -8.84756609e-01 -8.84756609e-01
 -8.84756609e-01  6.49832940e-01  6.49832940e-01  6.49832940e-01
  1.97959758e+00  2.99221545e+00  2.99221545e+00  2.99221545e+00
  1.02095381e+01  1.02095381e+01  1.02095381e+01  1.91987438e+01
  3.38410772e+01  3.38410772e+01  3.38410772e+01  9.35518674e+01
  1.32034150e+02  1.32034150e+02  1.32034150e+02  3.55852380e+02
  1.34918954e+03  5.83560410e+03  3.50982014e+04]
E1 = -182.83726046129686  E_coul = 54.303328401822895
cycle= 2 E= -128.533932059474  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274743
diis-c [-6.01808057e-04  3.36356037e-01  6.63643963e-01]
  HOMO = -0.84845561169474  LUMO = 0.656452341989334
  mo_energy =
[-3.27722569e+01 -1.92848388e+00 -8.48455612e-01 -8.48455612e-01
 -8.48455612e-01  6.56452342e-01  6.56452342e-01  6.56452342e-01
  2.00541788e+00  3.01747868e+00  3.01747868e+00  3.01747868e+00
  1.02626059e+01  1.02626059e+01  1.02626059e+01  1.92743823e+01
  3.39256317e+01  3.39256317e+01  3.39256317e+01  9.36556520e+01
  1.32143496e+02  1.32143496e+02  1.32143496e+02  3.55969191e+02
  1.34931270e+03  5.83573026e+03  3.50983287e+04]
E1 = -182.57433697908053  E_coul = 54.03945406024827
cycle= 3 E= -128.534882918832  delta_E= -0.000951  |g|= 0.000397  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102426
diis-c [-9.78677087e-08 -1.95677990e-03 -2.94326354e-04  1.00225111e+00]
  HOMO = -0.848654944105957  LUMO = 0.656438677673737
  mo_energy =
[-3.27726498e+01 -1.92863914e+00 -8.48654944e-01 -8.48654944e-01
 -8.48654944e-01  6.56438678e-01  6.56438678e-01  6.56438678e-01
  2.00533994e+00  3.01738066e+00  3.01738066e+00  3.01738066e+00
  1.02624035e+01  1.02624035e+01  1.02624035e+01  1.92741341e+01
  3.39253340e+01  3.39253340e+01  3.39253340e+01  9.36552865e+01
  1.32143091e+02  1.32143091e+02  1.32143091e+02  3.55968707e+02
  1.34931208e+03  5.83572953e+03  3.50983279e+04]
E1 = -182.57471409708978  E_coul = 54.039831164356414
cycle= 4 E= -128.534882932733  delta_E= -1.39e-08  |g|= 7.02e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183922
diis-c [-4.65642104e-10  9.12620540e-05  4.95796135e-04 -1.17196231e-01
  1.11660917e+00]
  HOMO = -0.848690452433389  LUMO = 0.656430063018401
  mo_energy =
[-3.27727187e+01 -1.92867183e+00 -8.48690452e-01 -8.48690452e-01
 -8.48690452e-01  6.56430063e-01  6.56430063e-01  6.56430063e-01
  2.00531397e+00  3.01735220e+00  3.01735220e+00  3.01735220e+00
  1.02623563e+01  1.02623563e+01  1.02623563e+01  1.92740789e+01
  3.39252736e+01  3.39252736e+01  3.39252736e+01  9.36552198e+01
  1.32143022e+02  1.32143022e+02  1.32143022e+02  3.55968634e+02
  1.34931200e+03  5.83572944e+03  3.50983279e+04]
E1 = -182.57485048526556  E_coul = 54.03996755208114
cycle= 5 E= -128.534882933184  delta_E= -4.51e-10  |g|= 1.87e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57485048526556  E_coul = 54.03996755208114
  HOMO = -0.848689882400075  LUMO = 0.656430120739987
  mo_energy =
[-3.27727170e+01 -1.92867102e+00 -8.48689882e-01 -8.48689882e-01
 -8.48689882e-01  6.56430121e-01  6.56430121e-01  6.56430121e-01
  2.00531448e+00  3.01735254e+00  3.01735254e+00  3.01735254e+00
  1.02623572e+01  1.02623572e+01  1.02623572e+01  1.92740804e+01
  3.39252750e+01  3.39252750e+01  3.39252750e+01  9.36552214e+01
  1.32143024e+02  1.32143024e+02  1.32143024e+02  3.55968635e+02
  1.34931200e+03  5.83572944e+03  3.50983279e+04]
E1 = -182.57484470964212  E_coul = 54.03996177645727
Extra cycle  E= -128.534882933185  delta_E= -4.55e-13  |g|= 7.57e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498632e+02 1.74905460e+02
 2.04884411e+01 5.69667941e+01 4.87104960e-01 7.82169442e+00
 1.65238569e+00 4.99016069e+00 1.44857705e+01 5.46277761e+01
 2.29441485e-01 1.84681239e+00 6.70087420e-01]
E = -128.53488293318486
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681755        1
[INPUT] 0    0    [1    /1   ]  617.498631842        1
[INPUT] 0    0    [1    /1   ]  174.90546042         1
[INPUT] 0    0    [1    /1   ]  20.4884410506        1
[INPUT] 0    0    [1    /1   ]  56.966794134         1
[INPUT] 0    0    [1    /1   ]  0.487104959652       1
[INPUT] 0    0    [1    /1   ]  7.82169442461        1
[INPUT] 0    0    [1    /1   ]  1.65238569334        1
[INPUT] 1    0    [1    /1   ]  4.99016069198        1
[INPUT] 1    0    [1    /1   ]  14.4857705325        1
[INPUT] 1    0    [1    /1   ]  54.6277761262        1
[INPUT] 1    0    [1    /1   ]  0.229441485102       1
[INPUT] 1    0    [1    /1   ]  1.84681238689        1
[INPUT] 1    0    [1    /1   ]  0.670087420009       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008327, 1.0]], [0, [2712.0968175519383, 1.0]], [0, [617.4986318416181, 1.0]], [0, [174.90546042002393, 1.0]], [0, [20.488441050559313, 1.0]], [0, [56.96679413399665, 1.0]], [0, [0.48710495965218287, 1.0]], [0, [7.821694424612506, 1.0]], [0, [1.6523856933430774, 1.0]], [1, [4.990160691975493, 1.0]], [1, [14.485770532487715, 1.0]], [1, [54.627776126158764, 1.0]], [1, [0.22944148510156656, 1.0]], [1, [1.8468123868895807, 1.0]], [1, [0.6700874200090744, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681755]
bas 2, expnt(s) = [617.49863184]
bas 3, expnt(s) = [174.90546042]
bas 4, expnt(s) = [20.48844105]
bas 5, expnt(s) = [56.96679413]
bas 6, expnt(s) = [0.48710496]
bas 7, expnt(s) = [7.82169442]
bas 8, expnt(s) = [1.65238569]
bas 9, expnt(s) = [4.99016069]
bas 10, expnt(s) = [14.48577053]
bas 11, expnt(s) = [54.62777613]
bas 12, expnt(s) = [0.22944149]
bas 13, expnt(s) = [1.84681239]
bas 14, expnt(s) = [0.67008742]
CPU time:       122.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498632e+02 3.12962299e+02 1.74905460e+02 1.21511547e+02
 2.04884411e+01 2.43302578e+01 5.69667941e+01 5.23879445e+01
 4.87104960e-01 1.47309901e+00 7.82169442e+00 1.18165489e+01
 1.65238569e+00 3.68212556e+00 4.99016069e+00 2.17584300e+01
 1.44857705e+01 8.24444441e+01 5.46277761e+01 4.33262692e+02
 2.29441485e-01 4.63259489e-01 1.84681239e+00 6.28076965e+00
 6.70087420e-01 1.76867779e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999406415913743
cond(S) = 239.3213857448474
E1 = -183.58370240070857  E_coul = 55.08130358865191
init E= -128.502398812057
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774885642466036  LUMO = 0.669717898858808
  mo_energy =
[-3.25543460e+01 -1.85119702e+00 -7.74885642e-01 -7.74885642e-01
 -7.74885642e-01  6.69717899e-01  6.69717899e-01  6.69717899e-01
  2.05821888e+00  3.06949958e+00  3.06949958e+00  3.06949958e+00
  1.03696868e+01  1.03696868e+01  1.03696868e+01  1.94240686e+01
  3.40930856e+01  3.40930856e+01  3.40930856e+01  9.38607113e+01
  1.32362332e+02  1.32362332e+02  1.32362332e+02  3.56209190e+02
  1.34958467e+03  5.83603112e+03  3.50986501e+04]
E1 = -182.06150312962097  E_coul = 53.53024309817422
cycle= 1 E= -128.531260031447  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540471
diis-c [-0.29210856  1.        ]
  HOMO = -0.88475660910218  LUMO = 0.649832940188721
  mo_energy =
[-3.28821622e+01 -1.96682107e+00 -8.84756609e-01 -8.84756609e-01
 -8.84756609e-01  6.49832940e-01  6.49832940e-01  6.49832940e-01
  1.97959758e+00  2.99221545e+00  2.99221545e+00  2.99221545e+00
  1.02095381e+01  1.02095381e+01  1.02095381e+01  1.91987438e+01
  3.38410772e+01  3.38410772e+01  3.38410772e+01  9.35518674e+01
  1.32034150e+02  1.32034150e+02  1.32034150e+02  3.55852380e+02
  1.34918954e+03  5.83560410e+03  3.50982014e+04]
E1 = -182.83726046129686  E_coul = 54.303328401822895
cycle= 2 E= -128.533932059474  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274743
diis-c [-6.01808057e-04  3.36356037e-01  6.63643963e-01]
  HOMO = -0.84845561169474  LUMO = 0.656452341989334
  mo_energy =
[-3.27722569e+01 -1.92848388e+00 -8.48455612e-01 -8.48455612e-01
 -8.48455612e-01  6.56452342e-01  6.56452342e-01  6.56452342e-01
  2.00541788e+00  3.01747868e+00  3.01747868e+00  3.01747868e+00
  1.02626059e+01  1.02626059e+01  1.02626059e+01  1.92743823e+01
  3.39256317e+01  3.39256317e+01  3.39256317e+01  9.36556520e+01
  1.32143496e+02  1.32143496e+02  1.32143496e+02  3.55969191e+02
  1.34931270e+03  5.83573026e+03  3.50983287e+04]
E1 = -182.57433697908053  E_coul = 54.03945406024827
cycle= 3 E= -128.534882918832  delta_E= -0.000951  |g|= 0.000397  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102426
diis-c [-9.78677087e-08 -1.95677990e-03 -2.94326354e-04  1.00225111e+00]
  HOMO = -0.848654944105957  LUMO = 0.656438677673737
  mo_energy =
[-3.27726498e+01 -1.92863914e+00 -8.48654944e-01 -8.48654944e-01
 -8.48654944e-01  6.56438678e-01  6.56438678e-01  6.56438678e-01
  2.00533994e+00  3.01738066e+00  3.01738066e+00  3.01738066e+00
  1.02624035e+01  1.02624035e+01  1.02624035e+01  1.92741341e+01
  3.39253340e+01  3.39253340e+01  3.39253340e+01  9.36552865e+01
  1.32143091e+02  1.32143091e+02  1.32143091e+02  3.55968707e+02
  1.34931208e+03  5.83572953e+03  3.50983279e+04]
E1 = -182.57471409708978  E_coul = 54.039831164356414
cycle= 4 E= -128.534882932733  delta_E= -1.39e-08  |g|= 7.02e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183922
diis-c [-4.65642104e-10  9.12620540e-05  4.95796135e-04 -1.17196231e-01
  1.11660917e+00]
  HOMO = -0.848690452433389  LUMO = 0.656430063018401
  mo_energy =
[-3.27727187e+01 -1.92867183e+00 -8.48690452e-01 -8.48690452e-01
 -8.48690452e-01  6.56430063e-01  6.56430063e-01  6.56430063e-01
  2.00531397e+00  3.01735220e+00  3.01735220e+00  3.01735220e+00
  1.02623563e+01  1.02623563e+01  1.02623563e+01  1.92740789e+01
  3.39252736e+01  3.39252736e+01  3.39252736e+01  9.36552198e+01
  1.32143022e+02  1.32143022e+02  1.32143022e+02  3.55968634e+02
  1.34931200e+03  5.83572944e+03  3.50983279e+04]
E1 = -182.57485048526556  E_coul = 54.03996755208114
cycle= 5 E= -128.534882933184  delta_E= -4.51e-10  |g|= 1.87e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57485048526556  E_coul = 54.03996755208114
  HOMO = -0.848689882400075  LUMO = 0.656430120739987
  mo_energy =
[-3.27727170e+01 -1.92867102e+00 -8.48689882e-01 -8.48689882e-01
 -8.48689882e-01  6.56430121e-01  6.56430121e-01  6.56430121e-01
  2.00531448e+00  3.01735254e+00  3.01735254e+00  3.01735254e+00
  1.02623572e+01  1.02623572e+01  1.02623572e+01  1.92740804e+01
  3.39252750e+01  3.39252750e+01  3.39252750e+01  9.36552214e+01
  1.32143024e+02  1.32143024e+02  1.32143024e+02  3.55968635e+02
  1.34931200e+03  5.83572944e+03  3.50983279e+04]
E1 = -182.57484470964212  E_coul = 54.03996177645727
Extra cycle  E= -128.534882933185  delta_E= -4.55e-13  |g|= 7.57e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.3213857448474
E1 = -182.57484470964212  E_coul = 54.03996177645727
init E= -128.534882933185
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.84869031033724  LUMO = 0.656430034635096
  mo_energy =
[-3.27727182e+01 -1.92867144e+00 -8.48690310e-01 -8.48690310e-01
 -8.48690310e-01  6.56430035e-01  6.56430035e-01  6.56430035e-01
  2.00531419e+00  3.01735223e+00  3.01735223e+00  3.01735223e+00
  1.02623565e+01  1.02623565e+01  1.02623565e+01  1.92740796e+01
  3.39252741e+01  3.39252741e+01  3.39252741e+01  9.36552202e+01
  1.32143023e+02  1.32143023e+02  1.32143023e+02  3.55968634e+02
  1.34931200e+03  5.83572944e+03  3.50983279e+04]
E1 = -182.5748474335046  E_coul = 54.03996450031979
cycle= 1 E= -128.534882933185  delta_E= 5.68e-14  |g|= 3.77e-07  |ddm|= 2.31e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5748474335046  E_coul = 54.03996450031979
  HOMO = -0.848690120837651  LUMO = 0.65643006822964
  mo_energy =
[-3.27727176e+01 -1.92867124e+00 -8.48690121e-01 -8.48690121e-01
 -8.48690121e-01  6.56430068e-01  6.56430068e-01  6.56430068e-01
  2.00531432e+00  3.01735236e+00  3.01735236e+00  3.01735236e+00
  1.02623568e+01  1.02623568e+01  1.02623568e+01  1.92740800e+01
  3.39252745e+01  3.39252745e+01  3.39252745e+01  9.36552208e+01
  1.32143023e+02  1.32143023e+02  1.32143023e+02  3.55968634e+02
  1.34931200e+03  5.83572944e+03  3.50983279e+04]
E1 = -182.5748460011468  E_coul = 54.03996306796207
Extra cycle  E= -128.534882933185  delta_E= 8.53e-14  |g|= 1.93e-07  |ddm|= 1.42e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498632e+02 1.74905460e+02
 2.04884411e+01 5.69667941e+01 4.87104960e-01 7.82169442e+00
 1.65238569e+00 4.99016069e+00 1.44857705e+01 5.46277761e+01
 2.29441485e-01 1.84681239e+00 6.70087420e-01]
grad_E = [ 6.12103781e-11 -2.89599509e-09  4.86386033e-08 -2.93603344e-07
  4.98103197e-06 -4.84209431e-07 -6.79925340e-05 -7.58754429e-06
 -1.23687232e-04 -3.47777096e-05 -7.11714359e-06 -2.08807513e-04
  5.18723466e-05  7.62392584e-05 -7.93576820e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681757        1
[INPUT] 0    0    [1    /1   ]  617.498631511        1
[INPUT] 0    0    [1    /1   ]  174.905463295        1
[INPUT] 0    0    [1    /1   ]  20.4884447086        1
[INPUT] 0    0    [1    /1   ]  56.9667850557        1
[INPUT] 0    0    [1    /1   ]  0.487198947855       1
[INPUT] 0    0    [1    /1   ]  7.82172966423        1
[INPUT] 0    0    [1    /1   ]  1.65231467779        1
[INPUT] 1    0    [1    /1   ]  4.98999239838        1
[INPUT] 1    0    [1    /1   ]  14.4804279086        1
[INPUT] 1    0    [1    /1   ]  54.6291847668        1
[INPUT] 1    0    [1    /1   ]  0.229488177517       1
[INPUT] 1    0    [1    /1   ]  1.84766653874        1
[INPUT] 1    0    [1    /1   ]  0.670372178041       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008291, 1.0]], [0, [2712.096817570121, 1.0]], [0, [617.498631511197, 1.0]], [0, [174.90546329539424, 1.0]], [0, [20.48844470858154, 1.0]], [0, [56.966785055660644, 1.0]], [0, [0.48719894785544376, 1.0]], [0, [7.821729664229985, 1.0]], [0, [1.6523146777851934, 1.0]], [1, [4.9899923983773995, 1.0]], [1, [14.480427908573317, 1.0]], [1, [54.62918476683743, 1.0]], [1, [0.22948817751652575, 1.0]], [1, [1.8476665387410673, 1.0]], [1, [0.6703721780412208, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681757]
bas 2, expnt(s) = [617.49863151]
bas 3, expnt(s) = [174.9054633]
bas 4, expnt(s) = [20.48844471]
bas 5, expnt(s) = [56.96678506]
bas 6, expnt(s) = [0.48719895]
bas 7, expnt(s) = [7.82172966]
bas 8, expnt(s) = [1.65231468]
bas 9, expnt(s) = [4.9899924]
bas 10, expnt(s) = [14.48042791]
bas 11, expnt(s) = [54.62918477]
bas 12, expnt(s) = [0.22948818]
bas 13, expnt(s) = [1.84766654]
bas 14, expnt(s) = [0.67037218]
CPU time:       125.18
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498632e+02 3.12962299e+02 1.74905463e+02 1.21511549e+02
 2.04884447e+01 2.43302610e+01 5.69667851e+01 5.23879383e+01
 4.87198948e-01 1.47331218e+00 7.82172966e+00 1.18165889e+01
 1.65231468e+00 3.68200687e+00 4.98999240e+00 2.17575128e+01
 1.44804279e+01 8.24064371e+01 5.46291848e+01 4.33276657e+02
 2.29488178e-01 4.63377336e-01 1.84766654e+00 6.28440094e+00
 6.70372178e-01 1.76961736e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999406219779319
cond(S) = 239.3255907520746
E1 = -183.5836916630595  E_coul = 55.08129453728909
init E= -128.50239712577
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774885815460561  LUMO = 0.669922970412323
  mo_energy =
[-3.25543492e+01 -1.85119725e+00 -7.74885815e-01 -7.74885815e-01
 -7.74885815e-01  6.69922970e-01  6.69922970e-01  6.69922970e-01
  2.05847528e+00  3.07076375e+00  3.07076375e+00  3.07076375e+00
  1.03728979e+01  1.03728979e+01  1.03728979e+01  1.94242637e+01
  3.40908682e+01  3.40908682e+01  3.40908682e+01  9.38609133e+01
  1.32350689e+02  1.32350689e+02  1.32350689e+02  3.56209376e+02
  1.34958484e+03  5.83603127e+03  3.50986502e+04]
E1 = -182.06165092560795  E_coul = 53.53039002195604
cycle= 1 E= -128.531260903652  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540428
diis-c [-0.29206275  1.        ]
  HOMO = -0.884742799863761  LUMO = 0.650031052989847
  mo_energy =
[-3.28821400e+01 -1.96681113e+00 -8.84742800e-01 -8.84742800e-01
 -8.84742800e-01  6.50031053e-01  6.50031053e-01  6.50031053e-01
  1.97985772e+00  2.99346198e+00  2.99346198e+00  2.99346198e+00
  1.02127600e+01  1.02127600e+01  1.02127600e+01  1.91989632e+01
  3.38389095e+01  3.38389095e+01  3.38389095e+01  9.35520943e+01
  1.32022534e+02  1.32022534e+02  1.32022534e+02  3.55852591e+02
  1.34918973e+03  5.83560427e+03  3.50982016e+04]
E1 = -182.8373206777516  E_coul = 54.30338823857366
cycle= 2 E= -128.533932439178  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.274721
diis-c [-6.01694932e-04  3.36355340e-01  6.63644660e-01]
  HOMO = -0.848445935789629  LUMO = 0.656652822943159
  mo_energy =
[-3.27722466e+01 -1.92847843e+00 -8.48445936e-01 -8.48445936e-01
 -8.48445936e-01  6.56652823e-01  6.56652823e-01  6.56652823e-01
  2.00567593e+00  3.01873129e+00  3.01873129e+00  3.01873129e+00
  1.02658238e+01  1.02658238e+01  1.02658238e+01  1.92745931e+01
  3.39234455e+01  3.39234455e+01  3.39234455e+01  9.36558676e+01
  1.32131868e+02  1.32131868e+02  1.32131868e+02  3.55969390e+02
  1.34931288e+03  5.83573041e+03  3.50983289e+04]
E1 = -182.5744296067541  E_coul = 54.03954652564201
cycle= 3 E= -128.534883081112  delta_E= -0.000951  |g|= 0.000396  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.001022
diis-c [-9.74334466e-08 -1.95593421e-03 -3.00280914e-04  1.00225622e+00]
  HOMO = -0.848645156115735  LUMO = 0.6566391455059
  mo_energy =
[-3.27726393e+01 -1.92863398e+00 -8.48645156e-01 -8.48645156e-01
 -8.48645156e-01  6.56639146e-01  6.56639146e-01  6.56639146e-01
  2.00559774e+00  3.01863325e+00  3.01863325e+00  3.01863325e+00
  1.02656214e+01  1.02656214e+01  1.02656214e+01  1.92743449e+01
  3.39231480e+01  3.39231480e+01  3.39231480e+01  9.36555023e+01
  1.32131463e+02  1.32131463e+02  1.32131463e+02  3.55968906e+02
  1.34931226e+03  5.83572968e+03  3.50983281e+04]
E1 = -182.57480568844795  E_coul = 54.03992259347867
cycle= 4 E= -128.534883094969  delta_E= -1.39e-08  |g|= 7.01e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00018323
diis-c [-4.62898924e-10  9.04092416e-05  4.93837839e-04 -1.16687097e-01
  1.11610285e+00]
  HOMO = -0.84868060178535  LUMO = 0.656630534743917
  mo_energy =
[-3.27727079e+01 -1.92866670e+00 -8.48680602e-01 -8.48680602e-01
 -8.48680602e-01  6.56630535e-01  6.56630535e-01  6.56630535e-01
  2.00557174e+00  3.01860482e+00  3.01860482e+00  3.01860482e+00
  1.02655742e+01  1.02655742e+01  1.02655742e+01  1.92742898e+01
  3.39230877e+01  3.39230877e+01  3.39230877e+01  9.36554358e+01
  1.32131394e+02  1.32131394e+02  1.32131394e+02  3.55968833e+02
  1.34931218e+03  5.83572960e+03  3.50983280e+04]
E1 = -182.57494154698344  E_coul = 54.0400584515654
cycle= 5 E= -128.534883095418  delta_E= -4.49e-10  |g|= 1.86e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57494154698344  E_coul = 54.0400584515654
  HOMO = -0.848680042201258  LUMO = 0.656630589054989
  mo_energy =
[-3.27727063e+01 -1.92866590e+00 -8.48680042e-01 -8.48680042e-01
 -8.48680042e-01  6.56630589e-01  6.56630589e-01  6.56630589e-01
  2.00557224e+00  3.01860515e+00  3.01860515e+00  3.01860515e+00
  1.02655751e+01  1.02655751e+01  1.02655751e+01  1.92742912e+01
  3.39230891e+01  3.39230891e+01  3.39230891e+01  9.36554373e+01
  1.32131396e+02  1.32131396e+02  1.32131396e+02  3.55968834e+02
  1.34931218e+03  5.83572960e+03  3.50983280e+04]
E1 = -182.5749357778222  E_coul = 54.040052682403854
Extra cycle  E= -128.534883095418  delta_E= -3.13e-13  |g|= 7.55e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498632e+02 1.74905463e+02
 2.04884447e+01 5.69667851e+01 4.87198948e-01 7.82172966e+00
 1.65231468e+00 4.98999240e+00 1.44804279e+01 5.46291848e+01
 2.29488178e-01 1.84766654e+00 6.70372178e-01]
E = -128.53488309541834
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681757        1
[INPUT] 0    0    [1    /1   ]  617.498631511        1
[INPUT] 0    0    [1    /1   ]  174.905463295        1
[INPUT] 0    0    [1    /1   ]  20.4884447086        1
[INPUT] 0    0    [1    /1   ]  56.9667850557        1
[INPUT] 0    0    [1    /1   ]  0.487198947855       1
[INPUT] 0    0    [1    /1   ]  7.82172966423        1
[INPUT] 0    0    [1    /1   ]  1.65231467779        1
[INPUT] 1    0    [1    /1   ]  4.98999239838        1
[INPUT] 1    0    [1    /1   ]  14.4804279086        1
[INPUT] 1    0    [1    /1   ]  54.6291847668        1
[INPUT] 1    0    [1    /1   ]  0.229488177517       1
[INPUT] 1    0    [1    /1   ]  1.84766653874        1
[INPUT] 1    0    [1    /1   ]  0.670372178041       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873008291, 1.0]], [0, [2712.096817570121, 1.0]], [0, [617.498631511197, 1.0]], [0, [174.90546329539424, 1.0]], [0, [20.48844470858154, 1.0]], [0, [56.966785055660644, 1.0]], [0, [0.48719894785544376, 1.0]], [0, [7.821729664229985, 1.0]], [0, [1.6523146777851934, 1.0]], [1, [4.9899923983773995, 1.0]], [1, [14.480427908573317, 1.0]], [1, [54.62918476683743, 1.0]], [1, [0.22948817751652575, 1.0]], [1, [1.8476665387410673, 1.0]], [1, [0.6703721780412208, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681757]
bas 2, expnt(s) = [617.49863151]
bas 3, expnt(s) = [174.9054633]
bas 4, expnt(s) = [20.48844471]
bas 5, expnt(s) = [56.96678506]
bas 6, expnt(s) = [0.48719895]
bas 7, expnt(s) = [7.82172966]
bas 8, expnt(s) = [1.65231468]
bas 9, expnt(s) = [4.9899924]
bas 10, expnt(s) = [14.48042791]
bas 11, expnt(s) = [54.62918477]
bas 12, expnt(s) = [0.22948818]
bas 13, expnt(s) = [1.84766654]
bas 14, expnt(s) = [0.67037218]
CPU time:       125.86
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498632e+02 3.12962299e+02 1.74905463e+02 1.21511549e+02
 2.04884447e+01 2.43302610e+01 5.69667851e+01 5.23879383e+01
 4.87198948e-01 1.47331218e+00 7.82172966e+00 1.18165889e+01
 1.65231468e+00 3.68200687e+00 4.98999240e+00 2.17575128e+01
 1.44804279e+01 8.24064371e+01 5.46291848e+01 4.33276657e+02
 2.29488178e-01 4.63377336e-01 1.84766654e+00 6.28440094e+00
 6.70372178e-01 1.76961736e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999406219779319
cond(S) = 239.3255907520746
E1 = -183.5836916630595  E_coul = 55.08129453728909
init E= -128.50239712577
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774885815460561  LUMO = 0.669922970412323
  mo_energy =
[-3.25543492e+01 -1.85119725e+00 -7.74885815e-01 -7.74885815e-01
 -7.74885815e-01  6.69922970e-01  6.69922970e-01  6.69922970e-01
  2.05847528e+00  3.07076375e+00  3.07076375e+00  3.07076375e+00
  1.03728979e+01  1.03728979e+01  1.03728979e+01  1.94242637e+01
  3.40908682e+01  3.40908682e+01  3.40908682e+01  9.38609133e+01
  1.32350689e+02  1.32350689e+02  1.32350689e+02  3.56209376e+02
  1.34958484e+03  5.83603127e+03  3.50986502e+04]
E1 = -182.06165092560795  E_coul = 53.53039002195604
cycle= 1 E= -128.531260903652  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540428
diis-c [-0.29206275  1.        ]
  HOMO = -0.884742799863761  LUMO = 0.650031052989847
  mo_energy =
[-3.28821400e+01 -1.96681113e+00 -8.84742800e-01 -8.84742800e-01
 -8.84742800e-01  6.50031053e-01  6.50031053e-01  6.50031053e-01
  1.97985772e+00  2.99346198e+00  2.99346198e+00  2.99346198e+00
  1.02127600e+01  1.02127600e+01  1.02127600e+01  1.91989632e+01
  3.38389095e+01  3.38389095e+01  3.38389095e+01  9.35520943e+01
  1.32022534e+02  1.32022534e+02  1.32022534e+02  3.55852591e+02
  1.34918973e+03  5.83560427e+03  3.50982016e+04]
E1 = -182.8373206777516  E_coul = 54.30338823857366
cycle= 2 E= -128.533932439178  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0712
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274721
diis-c [-6.01694932e-04  3.36355340e-01  6.63644660e-01]
  HOMO = -0.848445935789629  LUMO = 0.656652822943159
  mo_energy =
[-3.27722466e+01 -1.92847843e+00 -8.48445936e-01 -8.48445936e-01
 -8.48445936e-01  6.56652823e-01  6.56652823e-01  6.56652823e-01
  2.00567593e+00  3.01873129e+00  3.01873129e+00  3.01873129e+00
  1.02658238e+01  1.02658238e+01  1.02658238e+01  1.92745931e+01
  3.39234455e+01  3.39234455e+01  3.39234455e+01  9.36558676e+01
  1.32131868e+02  1.32131868e+02  1.32131868e+02  3.55969390e+02
  1.34931288e+03  5.83573041e+03  3.50983289e+04]
E1 = -182.5744296067541  E_coul = 54.03954652564201
cycle= 3 E= -128.534883081112  delta_E= -0.000951  |g|= 0.000396  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.001022
diis-c [-9.74334466e-08 -1.95593421e-03 -3.00280914e-04  1.00225622e+00]
  HOMO = -0.848645156115735  LUMO = 0.6566391455059
  mo_energy =
[-3.27726393e+01 -1.92863398e+00 -8.48645156e-01 -8.48645156e-01
 -8.48645156e-01  6.56639146e-01  6.56639146e-01  6.56639146e-01
  2.00559774e+00  3.01863325e+00  3.01863325e+00  3.01863325e+00
  1.02656214e+01  1.02656214e+01  1.02656214e+01  1.92743449e+01
  3.39231480e+01  3.39231480e+01  3.39231480e+01  9.36555023e+01
  1.32131463e+02  1.32131463e+02  1.32131463e+02  3.55968906e+02
  1.34931226e+03  5.83572968e+03  3.50983281e+04]
E1 = -182.57480568844795  E_coul = 54.03992259347867
cycle= 4 E= -128.534883094969  delta_E= -1.39e-08  |g|= 7.01e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018323
diis-c [-4.62898924e-10  9.04092416e-05  4.93837839e-04 -1.16687097e-01
  1.11610285e+00]
  HOMO = -0.84868060178535  LUMO = 0.656630534743917
  mo_energy =
[-3.27727079e+01 -1.92866670e+00 -8.48680602e-01 -8.48680602e-01
 -8.48680602e-01  6.56630535e-01  6.56630535e-01  6.56630535e-01
  2.00557174e+00  3.01860482e+00  3.01860482e+00  3.01860482e+00
  1.02655742e+01  1.02655742e+01  1.02655742e+01  1.92742898e+01
  3.39230877e+01  3.39230877e+01  3.39230877e+01  9.36554358e+01
  1.32131394e+02  1.32131394e+02  1.32131394e+02  3.55968833e+02
  1.34931218e+03  5.83572960e+03  3.50983280e+04]
E1 = -182.57494154698344  E_coul = 54.0400584515654
cycle= 5 E= -128.534883095418  delta_E= -4.49e-10  |g|= 1.86e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57494154698344  E_coul = 54.0400584515654
  HOMO = -0.848680042201258  LUMO = 0.656630589054989
  mo_energy =
[-3.27727063e+01 -1.92866590e+00 -8.48680042e-01 -8.48680042e-01
 -8.48680042e-01  6.56630589e-01  6.56630589e-01  6.56630589e-01
  2.00557224e+00  3.01860515e+00  3.01860515e+00  3.01860515e+00
  1.02655751e+01  1.02655751e+01  1.02655751e+01  1.92742912e+01
  3.39230891e+01  3.39230891e+01  3.39230891e+01  9.36554373e+01
  1.32131396e+02  1.32131396e+02  1.32131396e+02  3.55968834e+02
  1.34931218e+03  5.83572960e+03  3.50983280e+04]
E1 = -182.5749357778222  E_coul = 54.040052682403854
Extra cycle  E= -128.534883095418  delta_E= -3.13e-13  |g|= 7.55e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.3255907520746
E1 = -182.5749357778222  E_coul = 54.040052682403854
init E= -128.534883095418
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.84868046974449  LUMO = 0.656630502728254
  mo_energy =
[-3.27727075e+01 -1.92866632e+00 -8.48680470e-01 -8.48680470e-01
 -8.48680470e-01  6.56630503e-01  6.56630503e-01  6.56630503e-01
  2.00557194e+00  3.01860484e+00  3.01860484e+00  3.01860484e+00
  1.02655745e+01  1.02655745e+01  1.02655745e+01  1.92742904e+01
  3.39230882e+01  3.39230882e+01  3.39230882e+01  9.36554362e+01
  1.32131395e+02  1.32131395e+02  1.32131395e+02  3.55968833e+02
  1.34931218e+03  5.83572960e+03  3.50983280e+04]
E1 = -182.57493848841384  E_coul = 54.04005539299537
cycle= 1 E= -128.534883095418  delta_E= -1.42e-13  |g|= 3.75e-07  |ddm|= 2.32e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57493848841384  E_coul = 54.04005539299537
  HOMO = -0.848680281180306  LUMO = 0.656630536121406
  mo_energy =
[-3.27727069e+01 -1.92866612e+00 -8.48680281e-01 -8.48680281e-01
 -8.48680281e-01  6.56630536e-01  6.56630536e-01  6.56630536e-01
  2.00557208e+00  3.01860497e+00  3.01860497e+00  3.01860497e+00
  1.02655748e+01  1.02655748e+01  1.02655748e+01  1.92742908e+01
  3.39230887e+01  3.39230887e+01  3.39230887e+01  9.36554368e+01
  1.32131395e+02  1.32131395e+02  1.32131395e+02  3.55968834e+02
  1.34931218e+03  5.83572960e+03  3.50983280e+04]
E1 = -182.57493706109247  E_coul = 54.04005396567405
Extra cycle  E= -128.534883095418  delta_E= 5.68e-14  |g|= 1.93e-07  |ddm|= 1.41e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498632e+02 1.74905463e+02
 2.04884447e+01 5.69667851e+01 4.87198948e-01 7.82172966e+00
 1.65231468e+00 4.98999240e+00 1.44804279e+01 5.46291848e+01
 2.29488178e-01 1.84766654e+00 6.70372178e-01]
grad_E = [ 6.03788379e-11 -2.84945621e-09  4.77925872e-08 -2.81988605e-07
  5.65837715e-06 -5.64375719e-07  1.72331327e-04 -8.95037174e-06
 -1.91551525e-04 -4.16709894e-05 -1.16981238e-05 -2.07977376e-04
  7.12915872e-05  1.28423335e-04 -1.41915088e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681762        1
[INPUT] 0    0    [1    /1   ]  617.498630715        1
[INPUT] 0    0    [1    /1   ]  174.905469453        1
[INPUT] 0    0    [1    /1   ]  20.4884343165        1
[INPUT] 0    0    [1    /1   ]  56.9667745187        1
[INPUT] 0    0    [1    /1   ]  0.487376106446       1
[INPUT] 0    0    [1    /1   ]  7.82180985504        1
[INPUT] 0    0    [1    /1   ]  1.65228158405        1
[INPUT] 1    0    [1    /1   ]  4.99021458441        1
[INPUT] 1    0    [1    /1   ]  14.4733779478        1
[INPUT] 1    0    [1    /1   ]  54.6324974107        1
[INPUT] 1    0    [1    /1   ]  0.229547911277       1
[INPUT] 1    0    [1    /1   ]  1.84896144151        1
[INPUT] 1    0    [1    /1   ]  0.670781717303       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730081984, 1.0]], [0, [2712.0968176155475, 1.0]], [0, [617.4986307149024, 1.0]], [0, [174.90546945331113, 1.0]], [0, [20.488434316513352, 1.0]], [0, [56.96677451866358, 1.0]], [0, [0.48737610644579293, 1.0]], [0, [7.8218098550399, 1.0]], [0, [1.6522815840483822, 1.0]], [1, [4.990214584411123, 1.0]], [1, [14.473377947826386, 1.0]], [1, [54.63249741069884, 1.0]], [1, [0.22954791127713356, 1.0]], [1, [1.848961441511136, 1.0]], [1, [0.670781717303196, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681762]
bas 2, expnt(s) = [617.49863071]
bas 3, expnt(s) = [174.90546945]
bas 4, expnt(s) = [20.48843432]
bas 5, expnt(s) = [56.96677452]
bas 6, expnt(s) = [0.48737611]
bas 7, expnt(s) = [7.82180986]
bas 8, expnt(s) = [1.65228158]
bas 9, expnt(s) = [4.99021458]
bas 10, expnt(s) = [14.47337795]
bas 11, expnt(s) = [54.63249741]
bas 12, expnt(s) = [0.22954791]
bas 13, expnt(s) = [1.84896144]
bas 14, expnt(s) = [0.67078172]
CPU time:       129.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498631e+02 3.12962299e+02 1.74905469e+02 1.21511552e+02
 2.04884343e+01 2.43302518e+01 5.69667745e+01 5.23879310e+01
 4.87376106e-01 1.47371397e+00 7.82180986e+00 1.18166797e+01
 1.65228158e+00 3.68195156e+00 4.99021458e+00 2.17587238e+01
 1.44733779e+01 8.23562895e+01 5.46324974e+01 4.33309499e+02
 2.29547911e-01 4.63528108e-01 1.84896144e+00 6.28990680e+00
 6.70781717e-01 1.77096882e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999405819806775
cond(S) = 239.33849400726396
E1 = -183.58367470048194  E_coul = 55.08128015233389
init E= -128.502394548148
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774886087855909  LUMO = 0.670201924650194
  mo_energy =
[-3.25543545e+01 -1.85119756e+00 -7.74886088e-01 -7.74886088e-01
 -7.74886088e-01  6.70201925e-01  6.70201925e-01  6.70201925e-01
  2.05904953e+00  3.07258861e+00  3.07258861e+00  3.07258861e+00
  1.03780014e+01  1.03780014e+01  1.03780014e+01  1.94250526e+01
  3.40898635e+01  3.40898635e+01  3.40898635e+01  9.38617215e+01
  1.32339532e+02  1.32339532e+02  1.32339532e+02  3.56210105e+02
  1.34958549e+03  5.83603184e+03  3.50986507e+04]
E1 = -182.06189488672132  E_coul = 53.53063243762777
cycle= 1 E= -128.531262449094  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540353
diis-c [-0.29198095  1.        ]
  HOMO = -0.884720097374055  LUMO = 0.650300762649977
  mo_energy =
[-3.28821027e+01 -1.96679520e+00 -8.84720097e-01 -8.84720097e-01
 -8.84720097e-01  6.50300763e-01  6.50300763e-01  6.50300763e-01
  1.98043375e+00  2.99526134e+00  2.99526134e+00  2.99526134e+00
  1.02178753e+01  1.02178753e+01  1.02178753e+01  1.91997913e+01
  3.38379766e+01  3.38379766e+01  3.38379766e+01  9.35529439e+01
  1.32011423e+02  1.32011423e+02  1.32011423e+02  3.55853363e+02
  1.34919042e+03  5.83560489e+03  3.50982021e+04]
E1 = -182.83742084492243  E_coul = 54.3034876754667
cycle= 2 E= -128.533933169456  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.274682
diis-c [-6.01516159e-04  3.36354933e-01  6.63645067e-01]
  HOMO = -0.848430072284497  LUMO = 0.656925629903004
  mo_energy =
[-3.27722288e+01 -1.92846989e+00 -8.48430072e-01 -8.48430072e-01
 -8.48430072e-01  6.56925630e-01  6.56925630e-01  6.56925630e-01
  2.00624985e+00  3.02053942e+00  3.02053942e+00  3.02053942e+00
  1.02709344e+01  1.02709344e+01  1.02709344e+01  1.92754070e+01
  3.39224858e+01  3.39224858e+01  3.39224858e+01  9.36566986e+01
  1.32120736e+02  1.32120736e+02  1.32120736e+02  3.55970142e+02
  1.34931355e+03  5.83573100e+03  3.50983294e+04]
E1 = -182.57458225393833  E_coul = 54.03969879681271
cycle= 3 E= -128.534883457126  delta_E= -0.00095  |g|= 0.000395  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00101815
diis-c [-9.67300404e-08 -1.95466549e-03 -3.10791353e-04  1.00226546e+00]
  HOMO = -0.848629133438174  LUMO = 0.656911915187303
  mo_energy =
[-3.27726212e+01 -1.92862596e+00 -8.48629133e-01 -8.48629133e-01
 -8.48629133e-01  6.56911915e-01  6.56911915e-01  6.56911915e-01
  2.00617120e+00  3.02044133e+00  3.02044133e+00  3.02044133e+00
  1.02707321e+01  1.02707321e+01  1.02707321e+01  1.92751589e+01
  3.39221885e+01  3.39221885e+01  3.39221885e+01  9.36563336e+01
  1.32120331e+02  1.32120331e+02  1.32120331e+02  3.55969659e+02
  1.34931293e+03  5.83573028e+03  3.50983286e+04]
E1 = -182.57495647520824  E_coul = 54.040073004288715
cycle= 4 E= -128.53488347092  delta_E= -1.38e-08  |g|= 6.98e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000182059
diis-c [-4.58464380e-10  8.90011034e-05  4.90520514e-04 -1.15847329e-01
  1.11526781e+00]
  HOMO = -0.848664481953826  LUMO = 0.656903308422275
  mo_energy =
[-3.27726896e+01 -1.92865873e+00 -8.48664482e-01 -8.48664482e-01
 -8.48664482e-01  6.56903308e-01  6.56903308e-01  6.56903308e-01
  2.00614514e+00  3.02041293e+00  3.02041293e+00  3.02041293e+00
  1.02706850e+01  1.02706850e+01  1.02706850e+01  1.92751039e+01
  3.39221283e+01  3.39221283e+01  3.39221283e+01  9.36562673e+01
  1.32120263e+02  1.32120263e+02  1.32120263e+02  3.55969586e+02
  1.34931285e+03  5.83573019e+03  3.50983285e+04]
E1 = -182.57509142743044  E_coul = 54.04020795606654
cycle= 5 E= -128.534883471364  delta_E= -4.44e-10  |g|= 1.84e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57509142743044  E_coul = 54.04020795606654
  HOMO = -0.848663939346566  LUMO = 0.656903356983234
  mo_energy =
[-3.27726880e+01 -1.92865797e+00 -8.48663939e-01 -8.48663939e-01
 -8.48663939e-01  6.56903357e-01  6.56903357e-01  6.56903357e-01
  2.00614561e+00  3.02041325e+00  3.02041325e+00  3.02041325e+00
  1.02706859e+01  1.02706859e+01  1.02706859e+01  1.92751053e+01
  3.39221297e+01  3.39221297e+01  3.39221297e+01  9.36562689e+01
  1.32120264e+02  1.32120264e+02  1.32120264e+02  3.55969587e+02
  1.34931285e+03  5.83573019e+03  3.50983285e+04]
E1 = -182.5750856606782  E_coul = 54.04020218931354
Extra cycle  E= -128.534883471365  delta_E= -7.67e-13  |g|= 7.54e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498631e+02 1.74905469e+02
 2.04884343e+01 5.69667745e+01 4.87376106e-01 7.82180986e+00
 1.65228158e+00 4.99021458e+00 1.44733779e+01 5.46324974e+01
 2.29547911e-01 1.84896144e+00 6.70781717e-01]
E = -128.53488347136468
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681762        1
[INPUT] 0    0    [1    /1   ]  617.498630715        1
[INPUT] 0    0    [1    /1   ]  174.905469453        1
[INPUT] 0    0    [1    /1   ]  20.4884343165        1
[INPUT] 0    0    [1    /1   ]  56.9667745187        1
[INPUT] 0    0    [1    /1   ]  0.487376106446       1
[INPUT] 0    0    [1    /1   ]  7.82180985504        1
[INPUT] 0    0    [1    /1   ]  1.65228158405        1
[INPUT] 1    0    [1    /1   ]  4.99021458441        1
[INPUT] 1    0    [1    /1   ]  14.4733779478        1
[INPUT] 1    0    [1    /1   ]  54.6324974107        1
[INPUT] 1    0    [1    /1   ]  0.229547911277       1
[INPUT] 1    0    [1    /1   ]  1.84896144151        1
[INPUT] 1    0    [1    /1   ]  0.670781717303       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730081984, 1.0]], [0, [2712.0968176155475, 1.0]], [0, [617.4986307149024, 1.0]], [0, [174.90546945331113, 1.0]], [0, [20.488434316513352, 1.0]], [0, [56.96677451866358, 1.0]], [0, [0.48737610644579293, 1.0]], [0, [7.8218098550399, 1.0]], [0, [1.6522815840483822, 1.0]], [1, [4.990214584411123, 1.0]], [1, [14.473377947826386, 1.0]], [1, [54.63249741069884, 1.0]], [1, [0.22954791127713356, 1.0]], [1, [1.848961441511136, 1.0]], [1, [0.670781717303196, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681762]
bas 2, expnt(s) = [617.49863071]
bas 3, expnt(s) = [174.90546945]
bas 4, expnt(s) = [20.48843432]
bas 5, expnt(s) = [56.96677452]
bas 6, expnt(s) = [0.48737611]
bas 7, expnt(s) = [7.82180986]
bas 8, expnt(s) = [1.65228158]
bas 9, expnt(s) = [4.99021458]
bas 10, expnt(s) = [14.47337795]
bas 11, expnt(s) = [54.63249741]
bas 12, expnt(s) = [0.22954791]
bas 13, expnt(s) = [1.84896144]
bas 14, expnt(s) = [0.67078172]
CPU time:       129.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498631e+02 3.12962299e+02 1.74905469e+02 1.21511552e+02
 2.04884343e+01 2.43302518e+01 5.69667745e+01 5.23879310e+01
 4.87376106e-01 1.47371397e+00 7.82180986e+00 1.18166797e+01
 1.65228158e+00 3.68195156e+00 4.99021458e+00 2.17587238e+01
 1.44733779e+01 8.23562895e+01 5.46324974e+01 4.33309499e+02
 2.29547911e-01 4.63528108e-01 1.84896144e+00 6.28990680e+00
 6.70781717e-01 1.77096882e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999405819806775
cond(S) = 239.33849400726396
E1 = -183.58367470048194  E_coul = 55.08128015233389
init E= -128.502394548148
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774886087855909  LUMO = 0.670201924650194
  mo_energy =
[-3.25543545e+01 -1.85119756e+00 -7.74886088e-01 -7.74886088e-01
 -7.74886088e-01  6.70201925e-01  6.70201925e-01  6.70201925e-01
  2.05904953e+00  3.07258861e+00  3.07258861e+00  3.07258861e+00
  1.03780014e+01  1.03780014e+01  1.03780014e+01  1.94250526e+01
  3.40898635e+01  3.40898635e+01  3.40898635e+01  9.38617215e+01
  1.32339532e+02  1.32339532e+02  1.32339532e+02  3.56210105e+02
  1.34958549e+03  5.83603184e+03  3.50986507e+04]
E1 = -182.06189488672132  E_coul = 53.53063243762777
cycle= 1 E= -128.531262449094  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540353
diis-c [-0.29198095  1.        ]
  HOMO = -0.884720097374055  LUMO = 0.650300762649977
  mo_energy =
[-3.28821027e+01 -1.96679520e+00 -8.84720097e-01 -8.84720097e-01
 -8.84720097e-01  6.50300763e-01  6.50300763e-01  6.50300763e-01
  1.98043375e+00  2.99526134e+00  2.99526134e+00  2.99526134e+00
  1.02178753e+01  1.02178753e+01  1.02178753e+01  1.91997913e+01
  3.38379766e+01  3.38379766e+01  3.38379766e+01  9.35529439e+01
  1.32011423e+02  1.32011423e+02  1.32011423e+02  3.55853363e+02
  1.34919042e+03  5.83560489e+03  3.50982021e+04]
E1 = -182.83742084492243  E_coul = 54.3034876754667
cycle= 2 E= -128.533933169456  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274682
diis-c [-6.01516159e-04  3.36354933e-01  6.63645067e-01]
  HOMO = -0.848430072284497  LUMO = 0.656925629903004
  mo_energy =
[-3.27722288e+01 -1.92846989e+00 -8.48430072e-01 -8.48430072e-01
 -8.48430072e-01  6.56925630e-01  6.56925630e-01  6.56925630e-01
  2.00624985e+00  3.02053942e+00  3.02053942e+00  3.02053942e+00
  1.02709344e+01  1.02709344e+01  1.02709344e+01  1.92754070e+01
  3.39224858e+01  3.39224858e+01  3.39224858e+01  9.36566986e+01
  1.32120736e+02  1.32120736e+02  1.32120736e+02  3.55970142e+02
  1.34931355e+03  5.83573100e+03  3.50983294e+04]
E1 = -182.57458225393833  E_coul = 54.03969879681271
cycle= 3 E= -128.534883457126  delta_E= -0.00095  |g|= 0.000395  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101815
diis-c [-9.67300404e-08 -1.95466549e-03 -3.10791353e-04  1.00226546e+00]
  HOMO = -0.848629133438174  LUMO = 0.656911915187303
  mo_energy =
[-3.27726212e+01 -1.92862596e+00 -8.48629133e-01 -8.48629133e-01
 -8.48629133e-01  6.56911915e-01  6.56911915e-01  6.56911915e-01
  2.00617120e+00  3.02044133e+00  3.02044133e+00  3.02044133e+00
  1.02707321e+01  1.02707321e+01  1.02707321e+01  1.92751589e+01
  3.39221885e+01  3.39221885e+01  3.39221885e+01  9.36563336e+01
  1.32120331e+02  1.32120331e+02  1.32120331e+02  3.55969659e+02
  1.34931293e+03  5.83573028e+03  3.50983286e+04]
E1 = -182.57495647520824  E_coul = 54.040073004288715
cycle= 4 E= -128.53488347092  delta_E= -1.38e-08  |g|= 6.98e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182059
diis-c [-4.58464380e-10  8.90011034e-05  4.90520514e-04 -1.15847329e-01
  1.11526781e+00]
  HOMO = -0.848664481953826  LUMO = 0.656903308422275
  mo_energy =
[-3.27726896e+01 -1.92865873e+00 -8.48664482e-01 -8.48664482e-01
 -8.48664482e-01  6.56903308e-01  6.56903308e-01  6.56903308e-01
  2.00614514e+00  3.02041293e+00  3.02041293e+00  3.02041293e+00
  1.02706850e+01  1.02706850e+01  1.02706850e+01  1.92751039e+01
  3.39221283e+01  3.39221283e+01  3.39221283e+01  9.36562673e+01
  1.32120263e+02  1.32120263e+02  1.32120263e+02  3.55969586e+02
  1.34931285e+03  5.83573019e+03  3.50983285e+04]
E1 = -182.57509142743044  E_coul = 54.04020795606654
cycle= 5 E= -128.534883471364  delta_E= -4.44e-10  |g|= 1.84e-06  |ddm|= 2.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57509142743044  E_coul = 54.04020795606654
  HOMO = -0.848663939346566  LUMO = 0.656903356983234
  mo_energy =
[-3.27726880e+01 -1.92865797e+00 -8.48663939e-01 -8.48663939e-01
 -8.48663939e-01  6.56903357e-01  6.56903357e-01  6.56903357e-01
  2.00614561e+00  3.02041325e+00  3.02041325e+00  3.02041325e+00
  1.02706859e+01  1.02706859e+01  1.02706859e+01  1.92751053e+01
  3.39221297e+01  3.39221297e+01  3.39221297e+01  9.36562689e+01
  1.32120264e+02  1.32120264e+02  1.32120264e+02  3.55969587e+02
  1.34931285e+03  5.83573019e+03  3.50983285e+04]
E1 = -182.5750856606782  E_coul = 54.04020218931354
Extra cycle  E= -128.534883471365  delta_E= -7.67e-13  |g|= 7.54e-07  |ddm|= 1.12e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.33849400726396
E1 = -182.5750856606782  E_coul = 54.04020218931354
init E= -128.534883471365
    CPU time for initialize scf      0.26 sec, wall time      0.26 sec
  HOMO = -0.848664366818217  LUMO = 0.656903270164569
  mo_energy =
[-3.27726891e+01 -1.92865840e+00 -8.48664367e-01 -8.48664367e-01
 -8.48664367e-01  6.56903270e-01  6.56903270e-01  6.56903270e-01
  2.00614531e+00  3.02041294e+00  3.02041294e+00  3.02041294e+00
  1.02706853e+01  1.02706853e+01  1.02706853e+01  1.92751045e+01
  3.39221288e+01  3.39221288e+01  3.39221288e+01  9.36562678e+01
  1.32120263e+02  1.32120263e+02  1.32120263e+02  3.55969586e+02
  1.34931285e+03  5.83573019e+03  3.50983285e+04]
E1 = -182.5750883524832  E_coul = 54.04020488111897
cycle= 1 E= -128.534883471364  delta_E= 4.55e-13  |g|= 3.73e-07  |ddm|= 2.35e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5750883524832  E_coul = 54.04020488111897
  HOMO = -0.848664179575475  LUMO = 0.656903303256166
  mo_energy =
[-3.27726886e+01 -1.92865819e+00 -8.48664180e-01 -8.48664180e-01
 -8.48664180e-01  6.56903303e-01  6.56903303e-01  6.56903303e-01
  2.00614545e+00  3.02041307e+00  3.02041307e+00  3.02041307e+00
  1.02706855e+01  1.02706855e+01  1.02706855e+01  1.92751049e+01
  3.39221292e+01  3.39221292e+01  3.39221292e+01  9.36562683e+01
  1.32120264e+02  1.32120264e+02  1.32120264e+02  3.55969586e+02
  1.34931285e+03  5.83573019e+03  3.50983285e+04]
E1 = -182.5750869316481  E_coul = 54.04020346028357
Extra cycle  E= -128.534883471365  delta_E= -2.84e-13  |g|= 1.92e-07  |ddm|= 1.4e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.32 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498631e+02 1.74905469e+02
 2.04884343e+01 5.69667745e+01 4.87376106e-01 7.82180986e+00
 1.65228158e+00 4.99021458e+00 1.44733779e+01 5.46324974e+01
 2.29547911e-01 1.84896144e+00 6.70781717e-01]
grad_E = [ 5.97283830e-11 -2.81123684e-09  4.71407737e-08 -2.71729839e-07
  6.48666880e-06 -6.37724209e-07  5.67597383e-04 -1.08148238e-05
 -2.97640231e-04 -4.46201029e-05 -1.96696493e-05 -2.06683962e-04
  7.64878627e-05  1.88482683e-04 -2.12341892e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681774        1
[INPUT] 0    0    [1    /1   ]  617.498628637        1
[INPUT] 0    0    [1    /1   ]  174.90548443         1
[INPUT] 0    0    [1    /1   ]  20.4883833555        1
[INPUT] 0    0    [1    /1   ]  56.9667631003        1
[INPUT] 0    0    [1    /1   ]  0.487671476247       1
[INPUT] 0    0    [1    /1   ]  7.8220071802         1
[INPUT] 0    0    [1    /1   ]  1.65225509124        1
[INPUT] 1    0    [1    /1   ]  4.99110099425        1
[INPUT] 1    0    [1    /1   ]  14.4638000597        1
[INPUT] 1    0    [1    /1   ]  54.6409766034        1
[INPUT] 1    0    [1    /1   ]  0.229639523771       1
[INPUT] 1    0    [1    /1   ]  1.85106433247        1
[INPUT] 1    0    [1    /1   ]  0.67143293475        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730079496, 1.0]], [0, [2712.0968177363898, 1.0]], [0, [617.498628637456, 1.0]], [0, [174.90548443045404, 1.0]], [0, [20.488383355456392, 1.0]], [0, [56.96676310027085, 1.0]], [0, [0.48767147624735124, 1.0]], [0, [7.822007180203622, 1.0]], [0, [1.652255091243645, 1.0]], [1, [4.991100994250504, 1.0]], [1, [14.463800059671131, 1.0]], [1, [54.64097660343729, 1.0]], [1, [0.2296395237708293, 1.0]], [1, [1.851064332469074, 1.0]], [1, [0.6714329347500317, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681774]
bas 2, expnt(s) = [617.49862864]
bas 3, expnt(s) = [174.90548443]
bas 4, expnt(s) = [20.48838336]
bas 5, expnt(s) = [56.9667631]
bas 6, expnt(s) = [0.48767148]
bas 7, expnt(s) = [7.82200718]
bas 8, expnt(s) = [1.65225509]
bas 9, expnt(s) = [4.99110099]
bas 10, expnt(s) = [14.46380006]
bas 11, expnt(s) = [54.6409766]
bas 12, expnt(s) = [0.22963952]
bas 13, expnt(s) = [1.85106433]
bas 14, expnt(s) = [0.67143293]
CPU time:       133.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498629e+02 3.12962298e+02 1.74905484e+02 1.21511560e+02
 2.04883834e+01 2.43302064e+01 5.69667631e+01 5.23879231e+01
 4.87671476e-01 1.47438377e+00 7.82200718e+00 1.18169033e+01
 1.65225509e+00 3.68190729e+00 4.99110099e+00 2.17635551e+01
 1.44638001e+01 8.22881701e+01 5.46409766e+01 4.33393565e+02
 2.29639524e-01 4.63759362e-01 1.85106433e+00 6.29885025e+00
 6.71432935e-01 1.77311822e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99940510620911
cond(S) = 239.36331777416024
E1 = -183.58364697465882  E_coul = 55.081256895124625
init E= -128.502390079534
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774886611314719  LUMO = 0.670639730417779
  mo_energy =
[-3.25543630e+01 -1.85119802e+00 -7.74886611e-01 -7.74886611e-01
 -7.74886611e-01  6.70639730e-01  6.70639730e-01  6.70639730e-01
  2.06003397e+00  3.07550688e+00  3.07550688e+00  3.07550688e+00
  1.03866115e+01  1.03866115e+01  1.03866115e+01  1.94265709e+01
  3.40916587e+01  3.40916587e+01  3.40916587e+01  9.38633414e+01
  1.32333542e+02  1.32333542e+02  1.32333542e+02  3.56211571e+02
  1.34958681e+03  5.83603300e+03  3.50986516e+04]
E1 = -182.06229196194025  E_coul = 53.531026667156574
cycle= 1 E= -128.531265294784  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540224
diis-c [-0.29184149  1.        ]
  HOMO = -0.884683332229547  LUMO = 0.650723985244443
  mo_energy =
[-3.28820415e+01 -1.96676947e+00 -8.84683332e-01 -8.84683332e-01
 -8.84683332e-01  6.50723985e-01  6.50723985e-01  6.50723985e-01
  1.98141952e+00  2.99813774e+00  2.99813774e+00  2.99813774e+00
  1.02264972e+01  1.02264972e+01  1.02264972e+01  1.92013726e+01
  3.38398783e+01  3.38398783e+01  3.38398783e+01  9.35546315e+01
  1.32005503e+02  1.32005503e+02  1.32005503e+02  3.55854898e+02
  1.34919181e+03  5.83560612e+03  3.50982031e+04]
E1 = -182.83758410165944  E_coul = 54.30364941448409
cycle= 2 E= -128.533934687175  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.274615
diis-c [-6.01234123e-04  3.36354523e-01  6.63645477e-01]
  HOMO = -0.848404445725605  LUMO = 0.657353686989484
  mo_energy =
[-3.27721996e+01 -1.92845619e+00 -8.48404446e-01 -8.48404446e-01
 -8.48404446e-01  6.57353687e-01  6.57353687e-01  6.57353687e-01
  2.00723266e+00  3.02343016e+00  3.02343016e+00  3.02343016e+00
  1.02795513e+01  1.02795513e+01  1.02795513e+01  1.92769655e+01
  3.39243473e+01  3.39243473e+01  3.39243473e+01  9.36583558e+01
  1.32114783e+02  1.32114783e+02  1.32114783e+02  3.55971644e+02
  1.34931490e+03  5.83573220e+03  3.50983304e+04]
E1 = -182.5748303264297  E_coul = 54.039945926056895
cycle= 3 E= -128.534884400373  delta_E= -0.00095  |g|= 0.000394  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00101192
diis-c [-9.56348252e-08 -1.95278518e-03 -3.28202259e-04  1.00228099e+00]
  HOMO = -0.848603274923183  LUMO = 0.657339898293011
  mo_energy =
[-3.27725914e+01 -1.92861316e+00 -8.48603275e-01 -8.48603275e-01
 -8.48603275e-01  6.57339898e-01  6.57339898e-01  6.57339898e-01
  2.00715321e+00  3.02333195e+00  3.02333195e+00  3.02333195e+00
  1.02793490e+01  1.02793490e+01  1.02793490e+01  1.92767174e+01
  3.39240503e+01  3.39240503e+01  3.39240503e+01  9.36579913e+01
  1.32114379e+02  1.32114379e+02  1.32114379e+02  3.55971162e+02
  1.34931428e+03  5.83573147e+03  3.50983296e+04]
E1 = -182.57520148113352  E_coul = 54.04031706705889
cycle= 4 E= -128.534884414075  delta_E= -1.37e-08  |g|= 6.93e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000180152
diis-c [-4.51750381e-10  8.67625137e-05  4.85083267e-04 -1.14511343e-01
  1.11393950e+00]
  HOMO = -0.848638472108868  LUMO = 0.657331295630941
  mo_energy =
[-3.27726593e+01 -1.92864602e+00 -8.48638472e-01 -8.48638472e-01
 -8.48638472e-01  6.57331296e-01  6.57331296e-01  6.57331296e-01
  2.00712704e+00  3.02330361e+00  3.02330361e+00  3.02330361e+00
  1.02793021e+01  1.02793021e+01  1.02793021e+01  1.92766626e+01
  3.39239904e+01  3.39239904e+01  3.39239904e+01  9.36579254e+01
  1.32114311e+02  1.32114311e+02  1.32114311e+02  3.55971090e+02
  1.34931420e+03  5.83573139e+03  3.50983295e+04]
E1 = -182.57533495479942  E_coul = 54.04045054028598
cycle= 5 E= -128.534884414513  delta_E= -4.39e-10  |g|= 1.8e-06  |ddm|= 2.34e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57533495479942  E_coul = 54.04045054028598
  HOMO = -0.848637955597649  LUMO = 0.657331335047782
  mo_energy =
[-3.27726578e+01 -1.92864531e+00 -8.48637956e-01 -8.48637956e-01
 -8.48637956e-01  6.57331335e-01  6.57331335e-01  6.57331335e-01
  2.00712747e+00  3.02330390e+00  3.02330390e+00  3.02330390e+00
  1.02793029e+01  1.02793029e+01  1.02793029e+01  1.92766640e+01
  3.39239918e+01  3.39239918e+01  3.39239918e+01  9.36579269e+01
  1.32114313e+02  1.32114313e+02  1.32114313e+02  3.55971091e+02
  1.34931420e+03  5.83573139e+03  3.50983295e+04]
E1 = -182.57532917961905  E_coul = 54.040444765105526
Extra cycle  E= -128.534884414514  delta_E= -8.53e-14  |g|= 7.53e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.16 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498629e+02 1.74905484e+02
 2.04883834e+01 5.69667631e+01 4.87671476e-01 7.82200718e+00
 1.65225509e+00 4.99110099e+00 1.44638001e+01 5.46409766e+01
 2.29639524e-01 1.85106433e+00 6.71432935e-01]
E = -128.53488441451353
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681774        1
[INPUT] 0    0    [1    /1   ]  617.498628637        1
[INPUT] 0    0    [1    /1   ]  174.90548443         1
[INPUT] 0    0    [1    /1   ]  20.4883833555        1
[INPUT] 0    0    [1    /1   ]  56.9667631003        1
[INPUT] 0    0    [1    /1   ]  0.487671476247       1
[INPUT] 0    0    [1    /1   ]  7.8220071802         1
[INPUT] 0    0    [1    /1   ]  1.65225509124        1
[INPUT] 1    0    [1    /1   ]  4.99110099425        1
[INPUT] 1    0    [1    /1   ]  14.4638000597        1
[INPUT] 1    0    [1    /1   ]  54.6409766034        1
[INPUT] 1    0    [1    /1   ]  0.229639523771       1
[INPUT] 1    0    [1    /1   ]  1.85106433247        1
[INPUT] 1    0    [1    /1   ]  0.67143293475        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730079496, 1.0]], [0, [2712.0968177363898, 1.0]], [0, [617.498628637456, 1.0]], [0, [174.90548443045404, 1.0]], [0, [20.488383355456392, 1.0]], [0, [56.96676310027085, 1.0]], [0, [0.48767147624735124, 1.0]], [0, [7.822007180203622, 1.0]], [0, [1.652255091243645, 1.0]], [1, [4.991100994250504, 1.0]], [1, [14.463800059671131, 1.0]], [1, [54.64097660343729, 1.0]], [1, [0.2296395237708293, 1.0]], [1, [1.851064332469074, 1.0]], [1, [0.6714329347500317, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873008]
bas 1, expnt(s) = [2712.09681774]
bas 2, expnt(s) = [617.49862864]
bas 3, expnt(s) = [174.90548443]
bas 4, expnt(s) = [20.48838336]
bas 5, expnt(s) = [56.9667631]
bas 6, expnt(s) = [0.48767148]
bas 7, expnt(s) = [7.82200718]
bas 8, expnt(s) = [1.65225509]
bas 9, expnt(s) = [4.99110099]
bas 10, expnt(s) = [14.46380006]
bas 11, expnt(s) = [54.6409766]
bas 12, expnt(s) = [0.22963952]
bas 13, expnt(s) = [1.85106433]
bas 14, expnt(s) = [0.67143293]
CPU time:       133.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498629e+02 3.12962298e+02 1.74905484e+02 1.21511560e+02
 2.04883834e+01 2.43302064e+01 5.69667631e+01 5.23879231e+01
 4.87671476e-01 1.47438377e+00 7.82200718e+00 1.18169033e+01
 1.65225509e+00 3.68190729e+00 4.99110099e+00 2.17635551e+01
 1.44638001e+01 8.22881701e+01 5.46409766e+01 4.33393565e+02
 2.29639524e-01 4.63759362e-01 1.85106433e+00 6.29885025e+00
 6.71432935e-01 1.77311822e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99940510620911
cond(S) = 239.36331777416024
E1 = -183.58364697465882  E_coul = 55.081256895124625
init E= -128.502390079534
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.774886611314719  LUMO = 0.670639730417779
  mo_energy =
[-3.25543630e+01 -1.85119802e+00 -7.74886611e-01 -7.74886611e-01
 -7.74886611e-01  6.70639730e-01  6.70639730e-01  6.70639730e-01
  2.06003397e+00  3.07550688e+00  3.07550688e+00  3.07550688e+00
  1.03866115e+01  1.03866115e+01  1.03866115e+01  1.94265709e+01
  3.40916587e+01  3.40916587e+01  3.40916587e+01  9.38633414e+01
  1.32333542e+02  1.32333542e+02  1.32333542e+02  3.56211571e+02
  1.34958681e+03  5.83603300e+03  3.50986516e+04]
E1 = -182.06229196194025  E_coul = 53.531026667156574
cycle= 1 E= -128.531265294784  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.540224
diis-c [-0.29184149  1.        ]
  HOMO = -0.884683332229547  LUMO = 0.650723985244443
  mo_energy =
[-3.28820415e+01 -1.96676947e+00 -8.84683332e-01 -8.84683332e-01
 -8.84683332e-01  6.50723985e-01  6.50723985e-01  6.50723985e-01
  1.98141952e+00  2.99813774e+00  2.99813774e+00  2.99813774e+00
  1.02264972e+01  1.02264972e+01  1.02264972e+01  1.92013726e+01
  3.38398783e+01  3.38398783e+01  3.38398783e+01  9.35546315e+01
  1.32005503e+02  1.32005503e+02  1.32005503e+02  3.55854898e+02
  1.34919181e+03  5.83560612e+03  3.50982031e+04]
E1 = -182.83758410165944  E_coul = 54.30364941448409
cycle= 2 E= -128.533934687175  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274615
diis-c [-6.01234123e-04  3.36354523e-01  6.63645477e-01]
  HOMO = -0.848404445725605  LUMO = 0.657353686989484
  mo_energy =
[-3.27721996e+01 -1.92845619e+00 -8.48404446e-01 -8.48404446e-01
 -8.48404446e-01  6.57353687e-01  6.57353687e-01  6.57353687e-01
  2.00723266e+00  3.02343016e+00  3.02343016e+00  3.02343016e+00
  1.02795513e+01  1.02795513e+01  1.02795513e+01  1.92769655e+01
  3.39243473e+01  3.39243473e+01  3.39243473e+01  9.36583558e+01
  1.32114783e+02  1.32114783e+02  1.32114783e+02  3.55971644e+02
  1.34931490e+03  5.83573220e+03  3.50983304e+04]
E1 = -182.5748303264297  E_coul = 54.039945926056895
cycle= 3 E= -128.534884400373  delta_E= -0.00095  |g|= 0.000394  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101192
diis-c [-9.56348252e-08 -1.95278518e-03 -3.28202259e-04  1.00228099e+00]
  HOMO = -0.848603274923183  LUMO = 0.657339898293011
  mo_energy =
[-3.27725914e+01 -1.92861316e+00 -8.48603275e-01 -8.48603275e-01
 -8.48603275e-01  6.57339898e-01  6.57339898e-01  6.57339898e-01
  2.00715321e+00  3.02333195e+00  3.02333195e+00  3.02333195e+00
  1.02793490e+01  1.02793490e+01  1.02793490e+01  1.92767174e+01
  3.39240503e+01  3.39240503e+01  3.39240503e+01  9.36579913e+01
  1.32114379e+02  1.32114379e+02  1.32114379e+02  3.55971162e+02
  1.34931428e+03  5.83573147e+03  3.50983296e+04]
E1 = -182.57520148113352  E_coul = 54.04031706705889
cycle= 4 E= -128.534884414075  delta_E= -1.37e-08  |g|= 6.93e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000180152
diis-c [-4.51750381e-10  8.67625137e-05  4.85083267e-04 -1.14511343e-01
  1.11393950e+00]
  HOMO = -0.848638472108868  LUMO = 0.657331295630941
  mo_energy =
[-3.27726593e+01 -1.92864602e+00 -8.48638472e-01 -8.48638472e-01
 -8.48638472e-01  6.57331296e-01  6.57331296e-01  6.57331296e-01
  2.00712704e+00  3.02330361e+00  3.02330361e+00  3.02330361e+00
  1.02793021e+01  1.02793021e+01  1.02793021e+01  1.92766626e+01
  3.39239904e+01  3.39239904e+01  3.39239904e+01  9.36579254e+01
  1.32114311e+02  1.32114311e+02  1.32114311e+02  3.55971090e+02
  1.34931420e+03  5.83573139e+03  3.50983295e+04]
E1 = -182.57533495479942  E_coul = 54.04045054028598
cycle= 5 E= -128.534884414513  delta_E= -4.39e-10  |g|= 1.8e-06  |ddm|= 2.34e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57533495479942  E_coul = 54.04045054028598
  HOMO = -0.848637955597649  LUMO = 0.657331335047782
  mo_energy =
[-3.27726578e+01 -1.92864531e+00 -8.48637956e-01 -8.48637956e-01
 -8.48637956e-01  6.57331335e-01  6.57331335e-01  6.57331335e-01
  2.00712747e+00  3.02330390e+00  3.02330390e+00  3.02330390e+00
  1.02793029e+01  1.02793029e+01  1.02793029e+01  1.92766640e+01
  3.39239918e+01  3.39239918e+01  3.39239918e+01  9.36579269e+01
  1.32114313e+02  1.32114313e+02  1.32114313e+02  3.55971091e+02
  1.34931420e+03  5.83573139e+03  3.50983295e+04]
E1 = -182.57532917961905  E_coul = 54.040444765105526
Extra cycle  E= -128.534884414514  delta_E= -8.53e-14  |g|= 7.53e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.36331777416024
E1 = -182.57532917961905  E_coul = 54.040444765105526
init E= -128.534884414514
    CPU time for initialize scf      0.26 sec, wall time      0.27 sec
  HOMO = -0.848638383802106  LUMO = 0.657331247261966
  mo_energy =
[-3.27726589e+01 -1.92864574e+00 -8.48638384e-01 -8.48638384e-01
 -8.48638384e-01  6.57331247e-01  6.57331247e-01  6.57331247e-01
  2.00712716e+00  3.02330358e+00  3.02330358e+00  3.02330358e+00
  1.02793023e+01  1.02793023e+01  1.02793023e+01  1.92766631e+01
  3.39239909e+01  3.39239909e+01  3.39239909e+01  9.36579258e+01
  1.32114312e+02  1.32114312e+02  1.32114312e+02  3.55971090e+02
  1.34931420e+03  5.83573139e+03  3.50983295e+04]
E1 = -182.57533184666062  E_coul = 54.04044743214693
cycle= 1 E= -128.534884414514  delta_E= -1.71e-13  |g|= 3.69e-07  |ddm|= 2.4e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57533184666062  E_coul = 54.04044743214693
  HOMO = -0.84863819829507  LUMO = 0.657331279933788
  mo_energy =
[-3.27726584e+01 -1.92864554e+00 -8.48638198e-01 -8.48638198e-01
 -8.48638198e-01  6.57331280e-01  6.57331280e-01  6.57331280e-01
  2.00712730e+00  3.02330371e+00  3.02330371e+00  3.02330371e+00
  1.02793026e+01  1.02793026e+01  1.02793026e+01  1.92766635e+01
  3.39239913e+01  3.39239913e+01  3.39239913e+01  9.36579263e+01
  1.32114312e+02  1.32114312e+02  1.32114312e+02  3.55971090e+02
  1.34931420e+03  5.83573139e+03  3.50983295e+04]
E1 = -182.57533043327243  E_coul = 54.040446018758594
Extra cycle  E= -128.534884414514  delta_E= -1.42e-13  |g|= 1.91e-07  |ddm|= 1.38e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.33 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498629e+02 1.74905484e+02
 2.04883834e+01 5.69667631e+01 4.87671476e-01 7.82200718e+00
 1.65225509e+00 4.99110099e+00 1.44638001e+01 5.46409766e+01
 2.29639524e-01 1.85106433e+00 6.71432935e-01]
grad_E = [ 6.02054726e-11 -2.82979826e-09  4.76779049e-08 -2.73456961e-07
  7.33489118e-06 -6.30735097e-07  1.20821265e-03 -1.30791051e-05
 -4.67595613e-04 -4.45186523e-05 -3.26620806e-05 -2.04622954e-04
  6.57276644e-05  2.69428560e-04 -3.04560895e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681806        1
[INPUT] 0    0    [1    /1   ]  617.49862305         1
[INPUT] 0    0    [1    /1   ]  174.905523149        1
[INPUT] 0    0    [1    /1   ]  20.4882142116        1
[INPUT] 0    0    [1    /1   ]  56.9667555245        1
[INPUT] 0    0    [1    /1   ]  0.488159664732       1
[INPUT] 0    0    [1    /1   ]  7.82251627538        1
[INPUT] 0    0    [1    /1   ]  1.65221405833        1
[INPUT] 1    0    [1    /1   ]  4.99354701233        1
[INPUT] 1    0    [1    /1   ]  14.4511957849        1
[INPUT] 1    0    [1    /1   ]  54.6635068913        1
[INPUT] 1    0    [1    /1   ]  0.229805159165       1
[INPUT] 1    0    [1    /1   ]  1.85475614104        1
[INPUT] 1    0    [1    /1   ]  0.672569594245       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730072686, 1.0]], [0, [2712.096818064817, 1.0]], [0, [617.4986230495367, 1.0]], [0, [174.9055231487839, 1.0]], [0, [20.488214211627298, 1.0]], [0, [56.966755524538826, 1.0]], [0, [0.48815966473225403, 1.0]], [0, [7.82251627537734, 1.0]], [0, [1.6522140583256477, 1.0]], [1, [4.993547012334009, 1.0]], [1, [14.451195784920673, 1.0]], [1, [54.663506891304806, 1.0]], [1, [0.2298051591651668, 1.0]], [1, [1.8547561410385294, 1.0]], [1, [0.6725695942451919, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681806]
bas 2, expnt(s) = [617.49862305]
bas 3, expnt(s) = [174.90552315]
bas 4, expnt(s) = [20.48821421]
bas 5, expnt(s) = [56.96675552]
bas 6, expnt(s) = [0.48815966]
bas 7, expnt(s) = [7.82251628]
bas 8, expnt(s) = [1.65221406]
bas 9, expnt(s) = [4.99354701]
bas 10, expnt(s) = [14.45119578]
bas 11, expnt(s) = [54.66350689]
bas 12, expnt(s) = [0.22980516]
bas 13, expnt(s) = [1.85475614]
bas 14, expnt(s) = [0.67256959]
CPU time:       137.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498623e+02 3.12962296e+02 1.74905523e+02 1.21511580e+02
 2.04882142e+01 2.43300557e+01 5.69667555e+01 5.23879179e+01
 4.88159665e-01 1.47549059e+00 7.82251628e+00 1.18174801e+01
 1.65221406e+00 3.68183871e+00 4.99354701e+00 2.17768882e+01
 1.44511958e+01 8.21985438e+01 5.46635069e+01 4.33616955e+02
 2.29805159e-01 4.64177527e-01 1.85475614e+00 6.31455739e+00
 6.72569594e-01 1.77687112e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999403760297538
cond(S) = 239.41029759434505
E1 = -183.5836002077702  E_coul = 55.08121853474071
init E= -128.502381673029
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774887712126854  LUMO = 0.671422328503981
  mo_energy =
[-3.25543768e+01 -1.85119867e+00 -7.74887712e-01 -7.74887712e-01
 -7.74887712e-01  6.71422329e-01  6.71422329e-01  6.71422329e-01
  2.06166684e+00  3.08065385e+00  3.08065385e+00  3.08065385e+00
  1.04023845e+01  1.04023845e+01  1.04023845e+01  1.94293472e+01
  3.41018404e+01  3.41018404e+01  3.41018404e+01  9.38664971e+01
  1.32350472e+02  1.32350472e+02  1.32350472e+02  3.56214446e+02
  1.34958941e+03  5.83603531e+03  3.50986535e+04]
E1 = -182.06295568976668  E_coul = 53.53168475408301
cycle= 1 E= -128.531270935684  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.539999
diis-c [-0.29159895  1.        ]
  HOMO = -0.884622436581001  LUMO = 0.651479914397159
  mo_energy =
[-3.28819386e+01 -1.96672642e+00 -8.84622437e-01 -8.84622437e-01
 -8.84622437e-01  6.51479914e-01  6.51479914e-01  6.51479914e-01
  1.98305466e+00  3.00320743e+00  3.00320743e+00  3.00320743e+00
  1.02422739e+01  1.02422739e+01  1.02422739e+01  1.92042528e+01
  3.38502198e+01  3.38502198e+01  3.38502198e+01  9.35579006e+01
  1.32022544e+02  1.32022544e+02  1.32022544e+02  3.55857890e+02
  1.34919453e+03  5.83560854e+03  3.50982051e+04]
E1 = -182.8378565560102  E_coul = 54.30391844532716
cycle= 2 E= -128.533938110683  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.2745
diis-c [-6.00782585e-04  3.36353496e-01  6.63646504e-01]
  HOMO = -0.848362177914785  LUMO = 0.658118403600809
  mo_energy =
[-3.27721499e+01 -1.92843324e+00 -8.48362178e-01 -8.48362178e-01
 -8.48362178e-01  6.58118404e-01  6.58118404e-01  6.58118404e-01
  2.00886282e+00  3.02852614e+00  3.02852614e+00  3.02852614e+00
  1.02953249e+01  1.02953249e+01  1.02953249e+01  1.92798079e+01
  3.39346278e+01  3.39346278e+01  3.39346278e+01  9.36615742e+01
  1.32131773e+02  1.32131773e+02  1.32131773e+02  3.55974580e+02
  1.34931756e+03  5.83573456e+03  3.50983323e+04]
E1 = -182.5752443926513  E_coul = 54.040357528691665
cycle= 3 E= -128.53488686396  delta_E= -0.000949  |g|= 0.000392  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00100177
diis-c [-9.39380455e-08 -1.95001130e-03 -3.57191667e-04  1.00230720e+00]
  HOMO = -0.848560652789291  LUMO = 0.658104478509074
  mo_energy =
[-3.27725408e+01 -1.92859172e+00 -8.48560653e-01 -8.48560653e-01
 -8.48560653e-01  6.58104479e-01  6.58104479e-01  6.58104479e-01
  2.00878203e+00  3.02842770e+00  3.02842770e+00  3.02842770e+00
  1.02951225e+01  1.02951225e+01  1.02951225e+01  1.92795598e+01
  3.39343311e+01  3.39343311e+01  3.39343311e+01  9.36612104e+01
  1.32131370e+02  1.32131370e+02  1.32131370e+02  3.55974100e+02
  1.34931695e+03  5.83573384e+03  3.50983315e+04]
E1 = -182.57561053282654  E_coul = 54.040723655297434
cycle= 4 E= -128.534886877529  delta_E= -1.36e-08  |g|= 6.86e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000177026
diis-c [-4.42140956e-10  8.32367944e-05  4.76092794e-04 -1.12398626e-01
  1.11183930e+00]
  HOMO = -0.848595608040137  LUMO = 0.658095879471135
  mo_energy =
[-3.27726081e+01 -1.92862476e+00 -8.48595608e-01 -8.48595608e-01
 -8.48595608e-01  6.58095879e-01  6.58095879e-01  6.58095879e-01
  2.00875567e+00  3.02839944e+00  3.02839944e+00  3.02839944e+00
  1.02950759e+01  1.02950759e+01  1.02950759e+01  1.92795053e+01
  3.39342718e+01  3.39342718e+01  3.39342718e+01  9.36611452e+01
  1.32131303e+02  1.32131303e+02  1.32131303e+02  3.55974028e+02
  1.34931687e+03  5.83573376e+03  3.50983315e+04]
E1 = -182.57574158896497  E_coul = 54.040854711006375
cycle= 5 E= -128.534886877959  delta_E= -4.29e-10  |g|= 1.77e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57574158896497  E_coul = 54.040854711006375
  HOMO = -0.84859513006374  LUMO = 0.658095904679864
  mo_energy =
[-3.27726066e+01 -1.92862412e+00 -8.48595130e-01 -8.48595130e-01
 -8.48595130e-01  6.58095905e-01  6.58095905e-01  6.58095905e-01
  2.00875604e+00  3.02839969e+00  3.02839969e+00  3.02839969e+00
  1.02950767e+01  1.02950767e+01  1.02950767e+01  1.92795066e+01
  3.39342731e+01  3.39342731e+01  3.39342731e+01  9.36611467e+01
  1.32131304e+02  1.32131304e+02  1.32131304e+02  3.55974030e+02
  1.34931687e+03  5.83573376e+03  3.50983315e+04]
E1 = -182.57573577296557  E_coul = 54.04084889500665
Extra cycle  E= -128.534886877959  delta_E= -3.13e-13  |g|= 7.57e-07  |ddm|= 1.16e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498623e+02 1.74905523e+02
 2.04882142e+01 5.69667555e+01 4.88159665e-01 7.82251628e+00
 1.65221406e+00 4.99354701e+00 1.44511958e+01 5.46635069e+01
 2.29805159e-01 1.85475614e+00 6.72569594e-01]
E = -128.5348868779589
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681806        1
[INPUT] 0    0    [1    /1   ]  617.49862305         1
[INPUT] 0    0    [1    /1   ]  174.905523149        1
[INPUT] 0    0    [1    /1   ]  20.4882142116        1
[INPUT] 0    0    [1    /1   ]  56.9667555245        1
[INPUT] 0    0    [1    /1   ]  0.488159664732       1
[INPUT] 0    0    [1    /1   ]  7.82251627538        1
[INPUT] 0    0    [1    /1   ]  1.65221405833        1
[INPUT] 1    0    [1    /1   ]  4.99354701233        1
[INPUT] 1    0    [1    /1   ]  14.4511957849        1
[INPUT] 1    0    [1    /1   ]  54.6635068913        1
[INPUT] 1    0    [1    /1   ]  0.229805159165       1
[INPUT] 1    0    [1    /1   ]  1.85475614104        1
[INPUT] 1    0    [1    /1   ]  0.672569594245       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478730072686, 1.0]], [0, [2712.096818064817, 1.0]], [0, [617.4986230495367, 1.0]], [0, [174.9055231487839, 1.0]], [0, [20.488214211627298, 1.0]], [0, [56.966755524538826, 1.0]], [0, [0.48815966473225403, 1.0]], [0, [7.82251627537734, 1.0]], [0, [1.6522140583256477, 1.0]], [1, [4.993547012334009, 1.0]], [1, [14.451195784920673, 1.0]], [1, [54.663506891304806, 1.0]], [1, [0.2298051591651668, 1.0]], [1, [1.8547561410385294, 1.0]], [1, [0.6725695942451919, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873007]
bas 1, expnt(s) = [2712.09681806]
bas 2, expnt(s) = [617.49862305]
bas 3, expnt(s) = [174.90552315]
bas 4, expnt(s) = [20.48821421]
bas 5, expnt(s) = [56.96675552]
bas 6, expnt(s) = [0.48815966]
bas 7, expnt(s) = [7.82251628]
bas 8, expnt(s) = [1.65221406]
bas 9, expnt(s) = [4.99354701]
bas 10, expnt(s) = [14.45119578]
bas 11, expnt(s) = [54.66350689]
bas 12, expnt(s) = [0.22980516]
bas 13, expnt(s) = [1.85475614]
bas 14, expnt(s) = [0.67256959]
CPU time:       137.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498623e+02 3.12962296e+02 1.74905523e+02 1.21511580e+02
 2.04882142e+01 2.43300557e+01 5.69667555e+01 5.23879179e+01
 4.88159665e-01 1.47549059e+00 7.82251628e+00 1.18174801e+01
 1.65221406e+00 3.68183871e+00 4.99354701e+00 2.17768882e+01
 1.44511958e+01 8.21985438e+01 5.46635069e+01 4.33616955e+02
 2.29805159e-01 4.64177527e-01 1.85475614e+00 6.31455739e+00
 6.72569594e-01 1.77687112e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999403760297538
cond(S) = 239.41029759434505
E1 = -183.5836002077702  E_coul = 55.08121853474071
init E= -128.502381673029
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774887712126854  LUMO = 0.671422328503981
  mo_energy =
[-3.25543768e+01 -1.85119867e+00 -7.74887712e-01 -7.74887712e-01
 -7.74887712e-01  6.71422329e-01  6.71422329e-01  6.71422329e-01
  2.06166684e+00  3.08065385e+00  3.08065385e+00  3.08065385e+00
  1.04023845e+01  1.04023845e+01  1.04023845e+01  1.94293472e+01
  3.41018404e+01  3.41018404e+01  3.41018404e+01  9.38664971e+01
  1.32350472e+02  1.32350472e+02  1.32350472e+02  3.56214446e+02
  1.34958941e+03  5.83603531e+03  3.50986535e+04]
E1 = -182.06295568976668  E_coul = 53.53168475408301
cycle= 1 E= -128.531270935684  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.158
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.539999
diis-c [-0.29159895  1.        ]
  HOMO = -0.884622436581001  LUMO = 0.651479914397159
  mo_energy =
[-3.28819386e+01 -1.96672642e+00 -8.84622437e-01 -8.84622437e-01
 -8.84622437e-01  6.51479914e-01  6.51479914e-01  6.51479914e-01
  1.98305466e+00  3.00320743e+00  3.00320743e+00  3.00320743e+00
  1.02422739e+01  1.02422739e+01  1.02422739e+01  1.92042528e+01
  3.38502198e+01  3.38502198e+01  3.38502198e+01  9.35579006e+01
  1.32022544e+02  1.32022544e+02  1.32022544e+02  3.55857890e+02
  1.34919453e+03  5.83560854e+03  3.50982051e+04]
E1 = -182.8378565560102  E_coul = 54.30391844532716
cycle= 2 E= -128.533938110683  delta_E= -0.00267  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.2745
diis-c [-6.00782585e-04  3.36353496e-01  6.63646504e-01]
  HOMO = -0.848362177914785  LUMO = 0.658118403600809
  mo_energy =
[-3.27721499e+01 -1.92843324e+00 -8.48362178e-01 -8.48362178e-01
 -8.48362178e-01  6.58118404e-01  6.58118404e-01  6.58118404e-01
  2.00886282e+00  3.02852614e+00  3.02852614e+00  3.02852614e+00
  1.02953249e+01  1.02953249e+01  1.02953249e+01  1.92798079e+01
  3.39346278e+01  3.39346278e+01  3.39346278e+01  9.36615742e+01
  1.32131773e+02  1.32131773e+02  1.32131773e+02  3.55974580e+02
  1.34931756e+03  5.83573456e+03  3.50983323e+04]
E1 = -182.5752443926513  E_coul = 54.040357528691665
cycle= 3 E= -128.53488686396  delta_E= -0.000949  |g|= 0.000392  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00100177
diis-c [-9.39380455e-08 -1.95001130e-03 -3.57191667e-04  1.00230720e+00]
  HOMO = -0.848560652789291  LUMO = 0.658104478509074
  mo_energy =
[-3.27725408e+01 -1.92859172e+00 -8.48560653e-01 -8.48560653e-01
 -8.48560653e-01  6.58104479e-01  6.58104479e-01  6.58104479e-01
  2.00878203e+00  3.02842770e+00  3.02842770e+00  3.02842770e+00
  1.02951225e+01  1.02951225e+01  1.02951225e+01  1.92795598e+01
  3.39343311e+01  3.39343311e+01  3.39343311e+01  9.36612104e+01
  1.32131370e+02  1.32131370e+02  1.32131370e+02  3.55974100e+02
  1.34931695e+03  5.83573384e+03  3.50983315e+04]
E1 = -182.57561053282654  E_coul = 54.040723655297434
cycle= 4 E= -128.534886877529  delta_E= -1.36e-08  |g|= 6.86e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000177026
diis-c [-4.42140956e-10  8.32367944e-05  4.76092794e-04 -1.12398626e-01
  1.11183930e+00]
  HOMO = -0.848595608040137  LUMO = 0.658095879471135
  mo_energy =
[-3.27726081e+01 -1.92862476e+00 -8.48595608e-01 -8.48595608e-01
 -8.48595608e-01  6.58095879e-01  6.58095879e-01  6.58095879e-01
  2.00875567e+00  3.02839944e+00  3.02839944e+00  3.02839944e+00
  1.02950759e+01  1.02950759e+01  1.02950759e+01  1.92795053e+01
  3.39342718e+01  3.39342718e+01  3.39342718e+01  9.36611452e+01
  1.32131303e+02  1.32131303e+02  1.32131303e+02  3.55974028e+02
  1.34931687e+03  5.83573376e+03  3.50983315e+04]
E1 = -182.57574158896497  E_coul = 54.040854711006375
cycle= 5 E= -128.534886877959  delta_E= -4.29e-10  |g|= 1.77e-06  |ddm|= 2.36e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57574158896497  E_coul = 54.040854711006375
  HOMO = -0.84859513006374  LUMO = 0.658095904679864
  mo_energy =
[-3.27726066e+01 -1.92862412e+00 -8.48595130e-01 -8.48595130e-01
 -8.48595130e-01  6.58095905e-01  6.58095905e-01  6.58095905e-01
  2.00875604e+00  3.02839969e+00  3.02839969e+00  3.02839969e+00
  1.02950767e+01  1.02950767e+01  1.02950767e+01  1.92795066e+01
  3.39342731e+01  3.39342731e+01  3.39342731e+01  9.36611467e+01
  1.32131304e+02  1.32131304e+02  1.32131304e+02  3.55974030e+02
  1.34931687e+03  5.83573376e+03  3.50983315e+04]
E1 = -182.57573577296557  E_coul = 54.04084889500665
Extra cycle  E= -128.534886877959  delta_E= -3.13e-13  |g|= 7.57e-07  |ddm|= 1.16e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.41029759434505
E1 = -182.57573577296557  E_coul = 54.04084889500665
init E= -128.534886877959
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.848595561308486  LUMO = 0.658095814952471
  mo_energy =
[-3.27726077e+01 -1.92862456e+00 -8.48595561e-01 -8.48595561e-01
 -8.48595561e-01  6.58095815e-01  6.58095815e-01  6.58095815e-01
  2.00875572e+00  3.02839937e+00  3.02839937e+00  3.02839937e+00
  1.02950761e+01  1.02950761e+01  1.02950761e+01  1.92795058e+01
  3.39342721e+01  3.39342721e+01  3.39342721e+01  9.36611455e+01
  1.32131303e+02  1.32131303e+02  1.32131303e+02  3.55974028e+02
  1.34931687e+03  5.83573376e+03  3.50983315e+04]
E1 = -182.57573841298537  E_coul = 54.04085153502621
cycle= 1 E= -128.534886877959  delta_E= -2.56e-13  |g|= 3.66e-07  |ddm|= 2.51e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57573841298537  E_coul = 54.04085153502621
  HOMO = -0.84859537767629  LUMO = 0.658095847114953
  mo_energy =
[-3.27726072e+01 -1.92862437e+00 -8.48595378e-01 -8.48595378e-01
 -8.48595378e-01  6.58095847e-01  6.58095847e-01  6.58095847e-01
  2.00875585e+00  3.02839950e+00  3.02839950e+00  3.02839950e+00
  1.02950763e+01  1.02950763e+01  1.02950763e+01  1.92795061e+01
  3.39342726e+01  3.39342726e+01  3.39342726e+01  9.36611461e+01
  1.32131304e+02  1.32131304e+02  1.32131304e+02  3.55974029e+02
  1.34931687e+03  5.83573376e+03  3.50983315e+04]
E1 = -182.5757370047236  E_coul = 54.0408501267649
Extra cycle  E= -128.534886877959  delta_E= 4.55e-13  |g|= 1.9e-07  |ddm|= 1.36e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.31 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498623e+02 1.74905523e+02
 2.04882142e+01 5.69667555e+01 4.88159665e-01 7.82251628e+00
 1.65221406e+00 4.99354701e+00 1.44511958e+01 5.46635069e+01
 2.29805159e-01 1.85475614e+00 6.72569594e-01]
grad_E = [ 6.49178118e-11 -3.06627127e-09  5.26568723e-08 -3.23232633e-07
  7.50147844e-06 -2.94563966e-07  2.25974890e-03 -1.48544028e-05
 -7.45903101e-04 -4.12616863e-05 -5.38709978e-05 -2.01201218e-04
  3.32586743e-05  3.90860018e-04 -4.39670417e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681894        1
[INPUT] 0    0    [1    /1   ]  617.498608254        1
[INPUT] 0    0    [1    /1   ]  174.905623363        1
[INPUT] 0    0    [1    /1   ]  20.4877223504        1
[INPUT] 0    0    [1    /1   ]  56.966769378         1
[INPUT] 0    0    [1    /1   ]  0.488946737487       1
[INPUT] 0    0    [1    /1   ]  7.82382456066        1
[INPUT] 0    0    [1    /1   ]  1.65213243136        1
[INPUT] 1    0    [1    /1   ]  4.99982665407        1
[INPUT] 1    0    [1    /1   ]  14.4378059121        1
[INPUT] 1    0    [1    /1   ]  54.7226877376        1
[INPUT] 1    0    [1    /1   ]  0.230132503741       1
[INPUT] 1    0    [1    /1   ]  1.86148857414        1
[INPUT] 1    0    [1    /1   ]  0.674645137728       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873005448, 1.0]], [0, [2712.096818939434, 1.0]], [0, [617.4986082537768, 1.0]], [0, [174.90562336286976, 1.0]], [0, [20.48772235035522, 1.0]], [0, [56.96676937801112, 1.0]], [0, [0.48894673748661555, 1.0]], [0, [7.823824560660867, 1.0]], [0, [1.6521324313557495, 1.0]], [1, [4.999826654072584, 1.0]], [1, [14.437805912149251, 1.0]], [1, [54.72268773758175, 1.0]], [1, [0.23013250374075606, 1.0]], [1, [1.861488574136728, 1.0]], [1, [0.6746451377276074, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873005]
bas 1, expnt(s) = [2712.09681894]
bas 2, expnt(s) = [617.49860825]
bas 3, expnt(s) = [174.90562336]
bas 4, expnt(s) = [20.48772235]
bas 5, expnt(s) = [56.96676938]
bas 6, expnt(s) = [0.48894674]
bas 7, expnt(s) = [7.82382456]
bas 8, expnt(s) = [1.65213243]
bas 9, expnt(s) = [4.99982665]
bas 10, expnt(s) = [14.43780591]
bas 11, expnt(s) = [54.72268774]
bas 12, expnt(s) = [0.2301325]
bas 13, expnt(s) = [1.86148857]
bas 14, expnt(s) = [0.67464514]
CPU time:       141.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498608e+02 3.12962290e+02 1.74905623e+02 1.21511632e+02
 2.04877224e+01 2.43296177e+01 5.69667694e+01 5.23879275e+01
 4.88946737e-01 1.47727446e+00 7.82382456e+00 1.18189624e+01
 1.65213243e+00 3.68170228e+00 4.99982665e+00 2.18111255e+01
 1.44378059e+01 8.21033526e+01 5.47226877e+01 4.34203847e+02
 2.30132504e-01 4.65004168e-01 1.86148857e+00 6.34322127e+00
 6.74645138e-01 1.78372803e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999401096956248
cond(S) = 239.50091326883532
E1 = -183.58352169923495  E_coul = 55.08115639100426
init E= -128.502365308231
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.774890111032101  LUMO = 0.672921663187887
  mo_energy =
[-3.25543985e+01 -1.85119946e+00 -7.74890111e-01 -7.74890111e-01
 -7.74890111e-01  6.72921663e-01  6.72921663e-01  6.72921663e-01
  2.06429425e+00  3.09019360e+00  3.09019360e+00  3.09019360e+00
  1.04326072e+01  1.04326072e+01  1.04326072e+01  1.94344444e+01
  3.41359469e+01  3.41359469e+01  3.41359469e+01  9.38727794e+01
  1.32444317e+02  1.32444317e+02  1.32444317e+02  3.56220215e+02
  1.34959469e+03  5.83604000e+03  3.50986574e+04]
E1 = -182.0640622697811  E_coul = 53.53277965859036
cycle= 1 E= -128.531282611191  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.539607
diis-c [-0.29117599  1.        ]
  HOMO = -0.884522442826397  LUMO = 0.652926570414643
  mo_energy =
[-3.28817651e+01 -1.96665417e+00 -8.84522443e-01 -8.84522443e-01
 -8.84522443e-01  6.52926570e-01  6.52926570e-01  6.52926570e-01
  1.98568764e+00  3.01259565e+00  3.01259565e+00  3.01259565e+00
  1.02724651e+01  1.02724651e+01  1.02724651e+01  1.92095196e+01
  3.38845525e+01  3.38845525e+01  3.38845525e+01  9.35643723e+01
  1.32116559e+02  1.32116559e+02  1.32116559e+02  3.55863856e+02
  1.34920000e+03  5.83561343e+03  3.50982092e+04]
E1 = -182.83830907664296  E_coul = 54.30436297598915
cycle= 2 E= -128.533946100654  delta_E= -0.00266  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.274297
diis-c [-6.00079898e-04  3.36350250e-01  6.63649750e-01]
  HOMO = -0.848293260736389  LUMO = 0.659582360500004
  mo_energy =
[-3.27720652e+01 -1.92839454e+00 -8.48293261e-01 -8.48293261e-01
 -8.48293261e-01  6.59582361e-01  6.59582361e-01  6.59582361e-01
  2.01148700e+00  3.03796547e+00  3.03796547e+00  3.03796547e+00
  1.03255238e+01  1.03255238e+01  1.03255238e+01  1.92850126e+01
  3.39688725e+01  3.39688725e+01  3.39688725e+01  9.36679615e+01
  1.32225706e+02  1.32225706e+02  1.32225706e+02  3.55980453e+02
  1.34932294e+03  5.83573936e+03  3.50983363e+04]
E1 = -182.57593362646884  E_coul = 54.04104037508647
cycle= 3 E= -128.534893251382  delta_E= -0.000947  |g|= 0.000388  |ddm|= 0.0246
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000985676
diis-c [-9.14474695e-08 -1.94622982e-03 -4.04590359e-04  1.00235082e+00]
  HOMO = -0.848491197607447  LUMO = 0.659568193411182
  mo_energy =
[-3.27724548e+01 -1.92855548e+00 -8.48491198e-01 -8.48491198e-01
 -8.48491198e-01  6.59568193e-01  6.59568193e-01  6.59568193e-01
  2.01140402e+00  3.03786658e+00  3.03786658e+00  3.03786658e+00
  1.03253212e+01  1.03253212e+01  1.03253212e+01  1.92847644e+01
  3.39685763e+01  3.39685763e+01  3.39685763e+01  9.36675989e+01
  1.32225305e+02  1.32225305e+02  1.32225305e+02  3.55979976e+02
  1.34932233e+03  5.83573864e+03  3.50983355e+04]
E1 = -182.57629183611476  E_coul = 54.041398571337794
cycle= 4 E= -128.534893264777  delta_E= -1.34e-08  |g|= 6.76e-05  |ddm|= 0.00015
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000172019
diis-c [-4.30662657e-10  7.80024039e-05  4.61547814e-04 -1.09234060e-01
  1.10869451e+00]
  HOMO = -0.8485257726989  LUMO = 0.659559594592059
  mo_energy =
[-3.27725209e+01 -1.92858880e+00 -8.48525773e-01 -8.48525773e-01
 -8.48525773e-01  6.59559595e-01  6.59559595e-01  6.59559595e-01
  2.01137737e+00  3.03783844e+00  3.03783844e+00  3.03783844e+00
  1.03252750e+01  1.03252750e+01  1.03252750e+01  1.92847104e+01
  3.39685177e+01  3.39685177e+01  3.39685177e+01  9.36675347e+01
  1.32225239e+02  1.32225239e+02  1.32225239e+02  3.55979906e+02
  1.34932225e+03  5.83573856e+03  3.50983354e+04]
E1 = -182.57641904952476  E_coul = 54.04152578433096
cycle= 5 E= -128.534893265194  delta_E= -4.17e-10  |g|= 1.74e-06  |ddm|= 2.41e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.57641904952476  E_coul = 54.04152578433096
  HOMO = -0.848525344659514  LUMO = 0.659559599402122
  mo_energy =
[-3.27725194e+01 -1.92858828e+00 -8.48525345e-01 -8.48525345e-01
 -8.48525345e-01  6.59559599e-01  6.59559599e-01  6.59559599e-01
  2.01137763e+00  3.03783863e+00  3.03783863e+00  3.03783863e+00
  1.03252757e+01  1.03252757e+01  1.03252757e+01  1.92847116e+01
  3.39685189e+01  3.39685189e+01  3.39685189e+01  9.36675361e+01
  1.32225240e+02  1.32225240e+02  1.32225240e+02  3.55979907e+02
  1.34932225e+03  5.83573856e+03  3.50983354e+04]
E1 = -182.5764131005233  E_coul = 54.041519835329424
Extra cycle  E= -128.534893265194  delta_E= -8.53e-14  |g|= 7.75e-07  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498608e+02 1.74905623e+02
 2.04877224e+01 5.69667694e+01 4.88946737e-01 7.82382456e+00
 1.65213243e+00 4.99982665e+00 1.44378059e+01 5.47226877e+01
 2.30132504e-01 1.86148857e+00 6.74645138e-01]
E = -128.5348932651939
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787301        1
[INPUT] 0    0    [1    /1   ]  2712.09681894        1
[INPUT] 0    0    [1    /1   ]  617.498608254        1
[INPUT] 0    0    [1    /1   ]  174.905623363        1
[INPUT] 0    0    [1    /1   ]  20.4877223504        1
[INPUT] 0    0    [1    /1   ]  56.966769378         1
[INPUT] 0    0    [1    /1   ]  0.488946737487       1
[INPUT] 0    0    [1    /1   ]  7.82382456066        1
[INPUT] 0    0    [1    /1   ]  1.65213243136        1
[INPUT] 1    0    [1    /1   ]  4.99982665407        1
[INPUT] 1    0    [1    /1   ]  14.4378059121        1
[INPUT] 1    0    [1    /1   ]  54.7226877376        1
[INPUT] 1    0    [1    /1   ]  0.230132503741       1
[INPUT] 1    0    [1    /1   ]  1.86148857414        1
[INPUT] 1    0    [1    /1   ]  0.674645137728       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873005448, 1.0]], [0, [2712.096818939434, 1.0]], [0, [617.4986082537768, 1.0]], [0, [174.90562336286976, 1.0]], [0, [20.48772235035522, 1.0]], [0, [56.96676937801112, 1.0]], [0, [0.48894673748661555, 1.0]], [0, [7.823824560660867, 1.0]], [0, [1.6521324313557495, 1.0]], [1, [4.999826654072584, 1.0]], [1, [14.437805912149251, 1.0]], [1, [54.72268773758175, 1.0]], [1, [0.23013250374075606, 1.0]], [1, [1.861488574136728, 1.0]], [1, [0.6746451377276074, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873005]
bas 1, expnt(s) = [2712.09681894]
bas 2, expnt(s) = [617.49860825]
bas 3, expnt(s) = [174.90562336]
bas 4, expnt(s) = [20.48772235]
bas 5, expnt(s) = [56.96676938]
bas 6, expnt(s) = [0.48894674]
bas 7, expnt(s) = [7.82382456]
bas 8, expnt(s) = [1.65213243]
bas 9, expnt(s) = [4.99982665]
bas 10, expnt(s) = [14.43780591]
bas 11, expnt(s) = [54.72268774]
bas 12, expnt(s) = [0.2301325]
bas 13, expnt(s) = [1.86148857]
bas 14, expnt(s) = [0.67464514]
CPU time:       141.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497698e+02
 6.17498608e+02 3.12962290e+02 1.74905623e+02 1.21511632e+02
 2.04877224e+01 2.43296177e+01 5.69667694e+01 5.23879275e+01
 4.88946737e-01 1.47727446e+00 7.82382456e+00 1.18189624e+01
 1.65213243e+00 3.68170228e+00 4.99982665e+00 2.18111255e+01
 1.44378059e+01 8.21033526e+01 5.47226877e+01 4.34203847e+02
 2.30132504e-01 4.65004168e-01 1.86148857e+00 6.34322127e+00
 6.74645138e-01 1.78372803e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999401096956248
cond(S) = 239.50091326883532
E1 = -183.58352169923495  E_coul = 55.08115639100426
init E= -128.502365308231
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774890111032101  LUMO = 0.672921663187887
  mo_energy =
[-3.25543985e+01 -1.85119946e+00 -7.74890111e-01 -7.74890111e-01
 -7.74890111e-01  6.72921663e-01  6.72921663e-01  6.72921663e-01
  2.06429425e+00  3.09019360e+00  3.09019360e+00  3.09019360e+00
  1.04326072e+01  1.04326072e+01  1.04326072e+01  1.94344444e+01
  3.41359469e+01  3.41359469e+01  3.41359469e+01  9.38727794e+01
  1.32444317e+02  1.32444317e+02  1.32444317e+02  3.56220215e+02
  1.34959469e+03  5.83604000e+03  3.50986574e+04]
E1 = -182.0640622697811  E_coul = 53.53277965859036
cycle= 1 E= -128.531282611191  delta_E= -0.0289  |g|= 0.207  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.539607
diis-c [-0.29117599  1.        ]
  HOMO = -0.884522442826397  LUMO = 0.652926570414643
  mo_energy =
[-3.28817651e+01 -1.96665417e+00 -8.84522443e-01 -8.84522443e-01
 -8.84522443e-01  6.52926570e-01  6.52926570e-01  6.52926570e-01
  1.98568764e+00  3.01259565e+00  3.01259565e+00  3.01259565e+00
  1.02724651e+01  1.02724651e+01  1.02724651e+01  1.92095196e+01
  3.38845525e+01  3.38845525e+01  3.38845525e+01  9.35643723e+01
  1.32116559e+02  1.32116559e+02  1.32116559e+02  3.55863856e+02
  1.34920000e+03  5.83561343e+03  3.50982092e+04]
E1 = -182.83830907664296  E_coul = 54.30436297598915
cycle= 2 E= -128.533946100654  delta_E= -0.00266  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.274297
diis-c [-6.00079898e-04  3.36350250e-01  6.63649750e-01]
  HOMO = -0.848293260736389  LUMO = 0.659582360500004
  mo_energy =
[-3.27720652e+01 -1.92839454e+00 -8.48293261e-01 -8.48293261e-01
 -8.48293261e-01  6.59582361e-01  6.59582361e-01  6.59582361e-01
  2.01148700e+00  3.03796547e+00  3.03796547e+00  3.03796547e+00
  1.03255238e+01  1.03255238e+01  1.03255238e+01  1.92850126e+01
  3.39688725e+01  3.39688725e+01  3.39688725e+01  9.36679615e+01
  1.32225706e+02  1.32225706e+02  1.32225706e+02  3.55980453e+02
  1.34932294e+03  5.83573936e+03  3.50983363e+04]
E1 = -182.57593362646884  E_coul = 54.04104037508647
cycle= 3 E= -128.534893251382  delta_E= -0.000947  |g|= 0.000388  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000985676
diis-c [-9.14474695e-08 -1.94622982e-03 -4.04590359e-04  1.00235082e+00]
  HOMO = -0.848491197607447  LUMO = 0.659568193411182
  mo_energy =
[-3.27724548e+01 -1.92855548e+00 -8.48491198e-01 -8.48491198e-01
 -8.48491198e-01  6.59568193e-01  6.59568193e-01  6.59568193e-01
  2.01140402e+00  3.03786658e+00  3.03786658e+00  3.03786658e+00
  1.03253212e+01  1.03253212e+01  1.03253212e+01  1.92847644e+01
  3.39685763e+01  3.39685763e+01  3.39685763e+01  9.36675989e+01
  1.32225305e+02  1.32225305e+02  1.32225305e+02  3.55979976e+02
  1.34932233e+03  5.83573864e+03  3.50983355e+04]
E1 = -182.57629183611476  E_coul = 54.041398571337794
cycle= 4 E= -128.534893264777  delta_E= -1.34e-08  |g|= 6.76e-05  |ddm|= 0.00015
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000172019
diis-c [-4.30662657e-10  7.80024039e-05  4.61547814e-04 -1.09234060e-01
  1.10869451e+00]
  HOMO = -0.8485257726989  LUMO = 0.659559594592059
  mo_energy =
[-3.27725209e+01 -1.92858880e+00 -8.48525773e-01 -8.48525773e-01
 -8.48525773e-01  6.59559595e-01  6.59559595e-01  6.59559595e-01
  2.01137737e+00  3.03783844e+00  3.03783844e+00  3.03783844e+00
  1.03252750e+01  1.03252750e+01  1.03252750e+01  1.92847104e+01
  3.39685177e+01  3.39685177e+01  3.39685177e+01  9.36675347e+01
  1.32225239e+02  1.32225239e+02  1.32225239e+02  3.55979906e+02
  1.34932225e+03  5.83573856e+03  3.50983354e+04]
E1 = -182.57641904952476  E_coul = 54.04152578433096
cycle= 5 E= -128.534893265194  delta_E= -4.17e-10  |g|= 1.74e-06  |ddm|= 2.41e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57641904952476  E_coul = 54.04152578433096
  HOMO = -0.848525344659514  LUMO = 0.659559599402122
  mo_energy =
[-3.27725194e+01 -1.92858828e+00 -8.48525345e-01 -8.48525345e-01
 -8.48525345e-01  6.59559599e-01  6.59559599e-01  6.59559599e-01
  2.01137763e+00  3.03783863e+00  3.03783863e+00  3.03783863e+00
  1.03252757e+01  1.03252757e+01  1.03252757e+01  1.92847116e+01
  3.39685189e+01  3.39685189e+01  3.39685189e+01  9.36675361e+01
  1.32225240e+02  1.32225240e+02  1.32225240e+02  3.55979907e+02
  1.34932225e+03  5.83573856e+03  3.50983354e+04]
E1 = -182.5764131005233  E_coul = 54.041519835329424
Extra cycle  E= -128.534893265194  delta_E= -8.53e-14  |g|= 7.75e-07  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.50091326883532
E1 = -182.5764131005233  E_coul = 54.041519835329424
init E= -128.534893265194
    CPU time for initialize scf      0.26 sec, wall time      0.25 sec
  HOMO = -0.848525785359236  LUMO = 0.659559505687367
  mo_energy =
[-3.27725206e+01 -1.92858874e+00 -8.48525785e-01 -8.48525785e-01
 -8.48525785e-01  6.59559506e-01  6.59559506e-01  6.59559506e-01
  2.01137729e+00  3.03783830e+00  3.03783830e+00  3.03783830e+00
  1.03252751e+01  1.03252751e+01  1.03252751e+01  1.92847107e+01
  3.39685180e+01  3.39685180e+01  3.39685180e+01  9.36675349e+01
  1.32225239e+02  1.32225239e+02  1.32225239e+02  3.55979906e+02
  1.34932225e+03  5.83573856e+03  3.50983354e+04]
E1 = -182.57641573242483  E_coul = 54.041522467231005
cycle= 1 E= -128.534893265194  delta_E= 5.68e-14  |g|= 3.65e-07  |ddm|= 2.77e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57641573242483  E_coul = 54.041522467231005
  HOMO = -0.848525602215418  LUMO = 0.659559537510425
  mo_energy =
[-3.27725200e+01 -1.92858855e+00 -8.48525602e-01 -8.48525602e-01
 -8.48525602e-01  6.59559538e-01  6.59559538e-01  6.59559538e-01
  2.01137742e+00  3.03783843e+00  3.03783843e+00  3.03783843e+00
  1.03252753e+01  1.03252753e+01  1.03252753e+01  1.92847111e+01
  3.39685184e+01  3.39685184e+01  3.39685184e+01  9.36675355e+01
  1.32225240e+02  1.32225240e+02  1.32225240e+02  3.55979906e+02
  1.34932225e+03  5.83573856e+03  3.50983354e+04]
E1 = -182.57641431426583  E_coul = 54.04152104907171
Extra cycle  E= -128.534893265194  delta_E= -2.84e-13  |g|= 1.91e-07  |ddm|= 1.34e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.31 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498608e+02 1.74905623e+02
 2.04877224e+01 5.69667694e+01 4.88946737e-01 7.82382456e+00
 1.65213243e+00 4.99982665e+00 1.44378059e+01 5.47226877e+01
 2.30132504e-01 1.86148857e+00 6.74645138e-01]
grad_E = [ 8.27161665e-11 -3.98223457e-09  7.13266319e-08 -5.25430516e-07
  4.58275296e-06  1.09288725e-06  3.94902477e-03 -1.26333147e-05
 -1.19281227e-03 -3.41398770e-05 -8.75953167e-05 -1.95495416e-04
 -3.10721030e-05  5.77551844e-04 -6.43671384e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:54:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682124        1
[INPUT] 0    0    [1    /1   ]  617.49856945         1
[INPUT] 0    0    [1    /1   ]  174.905882797        1
[INPUT] 0    0    [1    /1   ]  20.4863749673        1
[INPUT] 0    0    [1    /1   ]  56.9668552196        1
[INPUT] 0    0    [1    /1   ]  0.49019583536        1
[INPUT] 0    0    [1    /1   ]  7.8271781863         1
[INPUT] 0    0    [1    /1   ]  1.65195972213        1
[INPUT] 1    0    [1    /1   ]  5.01568444204        1
[INPUT] 1    0    [1    /1   ]  14.4334409707        1
[INPUT] 1    0    [1    /1   ]  54.8770393911        1
[INPUT] 1    0    [1    /1   ]  0.230825074259       1
[INPUT] 1    0    [1    /1   ]  1.8743398218         1
[INPUT] 1    0    [1    /1   ]  0.678625697688       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873000648, 1.0]], [0, [2712.096821240597, 1.0]], [0, [617.4985694504225, 1.0]], [0, [174.90588279664672, 1.0]], [0, [20.486374967328825, 1.0]], [0, [56.96685521956502, 1.0]], [0, [0.49019583536028216, 1.0]], [0, [7.8271781862974805, 1.0]], [0, [1.6519597221297653, 1.0]], [1, [5.015684442035664, 1.0]], [1, [14.433440970658612, 1.0]], [1, [54.877039391146454, 1.0]], [1, [0.23082507425931376, 1.0]], [1, [1.8743398218004743, 1.0]], [1, [0.6786256976877858, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873001]
bas 1, expnt(s) = [2712.09682124]
bas 2, expnt(s) = [617.49856945]
bas 3, expnt(s) = [174.9058828]
bas 4, expnt(s) = [20.48637497]
bas 5, expnt(s) = [56.96685522]
bas 6, expnt(s) = [0.49019584]
bas 7, expnt(s) = [7.82717819]
bas 8, expnt(s) = [1.65195972]
bas 9, expnt(s) = [5.01568444]
bas 10, expnt(s) = [14.43344097]
bas 11, expnt(s) = [54.87703939]
bas 12, expnt(s) = [0.23082507]
bas 13, expnt(s) = [1.87433982]
bas 14, expnt(s) = [0.6786257]
CPU time:       145.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498569e+02 3.12962276e+02 1.74905883e+02 1.21511767e+02
 2.04863750e+01 2.43284176e+01 5.69668552e+01 5.23879867e+01
 4.90195835e-01 1.48010402e+00 7.82717819e+00 1.18227618e+01
 1.65195972e+00 3.68141362e+00 5.01568444e+00 2.18976318e+01
 1.44334410e+01 8.20723262e+01 5.48770394e+01 4.35735289e+02
 2.30825074e-01 4.66754080e-01 1.87433982e+00 6.39800843e+00
 6.78625698e-01 1.79689322e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999395531803945
cond(S) = 239.68370453926414
E1 = -183.5833892499044  E_coul = 55.081056952578834
init E= -128.502332297326
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.774895534222801  LUMO = 0.675976708054716
  mo_energy =
[-3.25544320e+01 -1.85120009e+00 -7.74895534e-01 -7.74895534e-01
 -7.74895534e-01  6.75976708e-01  6.75976708e-01  6.75976708e-01
  2.06844810e+00  3.10882481e+00  3.10882481e+00  3.10882481e+00
  1.04935111e+01  1.04935111e+01  1.04935111e+01  1.94441517e+01
  3.42350373e+01  3.42350373e+01  3.42350373e+01  9.38858807e+01
  1.32764322e+02  1.32764322e+02  1.32764322e+02  3.56232351e+02
  1.34960589e+03  5.83605002e+03  3.50986657e+04]
E1 = -182.06592392344166  E_coul = 53.534615964104304
cycle= 1 E= -128.531307959337  delta_E= -0.029  |g|= 0.206  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.538909
diis-c [-0.29042257  1.        ]
  HOMO = -0.884358176687682  LUMO = 0.655870882426762
  mo_energy =
[-3.28814685e+01 -1.96653117e+00 -8.84358177e-01 -8.84358177e-01
 -8.84358177e-01  6.55870882e-01  6.55870882e-01  6.55870882e-01
  1.98985616e+00  3.03091319e+00  3.03091319e+00  3.03091319e+00
  1.03332242e+01  1.03332242e+01  1.03332242e+01  1.92195030e+01
  3.39839279e+01  3.39839279e+01  3.39839279e+01  9.35777934e+01
  1.32436808e+02  1.32436808e+02  1.32436808e+02  3.55876327e+02
  1.34921154e+03  5.83562378e+03  3.50982179e+04]
E1 = -182.83906566293763  E_coul = 54.30510038074419
cycle= 2 E= -128.533965282193  delta_E= -0.00266  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.273931
diis-c [-5.99023774e-04  3.36340385e-01  6.63659615e-01]
  HOMO = -0.84818132173285  LUMO = 0.662562973546194
  mo_energy =
[-3.27719175e+01 -1.92832805e+00 -8.48181322e-01 -8.48181322e-01
 -8.48181322e-01  6.62562974e-01  6.62562974e-01  6.62562974e-01
  2.01563928e+00  3.05638788e+00  3.05638788e+00  3.05638788e+00
  1.03863265e+01  1.03863265e+01  1.03863265e+01  1.92948944e+01
  3.40681321e+01  3.40681321e+01  3.40681321e+01  9.36812412e+01
  1.32545831e+02  1.32545831e+02  1.32545831e+02  3.55992768e+02
  1.34933432e+03  5.83574954e+03  3.50983448e+04]
E1 = -182.57709080135047  E_coul = 54.04218107159819
cycle= 3 E= -128.534909729752  delta_E= -0.000944  |g|= 0.000384  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000960764
diis-c [-8.80749061e-08 -1.94186165e-03 -4.81370788e-04  1.00242323e+00]
  HOMO = -0.848378458292469  LUMO = 0.662548377480293
  mo_energy =
[-3.27723052e+01 -1.92849297e+00 -8.48378458e-01 -8.48378458e-01
 -8.48378458e-01  6.62548377e-01  6.62548377e-01  6.62548377e-01
  2.01555277e+00  3.05628813e+00  3.05628813e+00  3.05628813e+00
  1.03861235e+01  1.03861235e+01  1.03861235e+01  1.92946459e+01
  3.40678364e+01  3.40678364e+01  3.40678364e+01  9.36808802e+01
  1.32545432e+02  1.32545432e+02  1.32545432e+02  3.55992295e+02
  1.34933371e+03  5.83574883e+03  3.50983440e+04]
E1 = -182.57743687398602  E_coul = 54.042527131025146
cycle= 4 E= -128.534909742961  delta_E= -1.32e-08  |g|= 6.6e-05  |ddm|= 0.000152
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000164155
diis-c [-4.23495473e-10  7.09496474e-05  4.38455107e-04 -1.04888962e-01
  1.10437956e+00]
  HOMO = -0.84841244843545  LUMO = 0.662539766477928
  mo_energy =
[-3.27723696e+01 -1.92852673e+00 -8.48412448e-01 -8.48412448e-01
 -8.48412448e-01  6.62539766e-01  6.62539766e-01  6.62539766e-01
  2.01552563e+00  3.05626014e+00  3.05626014e+00  3.05626014e+00
  1.03860778e+01  1.03860778e+01  1.03860778e+01  1.92945926e+01
  3.40677789e+01  3.40677789e+01  3.40677789e+01  9.36808176e+01
  1.32545367e+02  1.32545367e+02  1.32545367e+02  3.55992227e+02
  1.34933364e+03  5.83574876e+03  3.50983439e+04]
E1 = -182.57755813419396  E_coul = 54.0426483908342
cycle= 5 E= -128.53490974336  delta_E= -3.99e-10  |g|= 1.81e-06  |ddm|= 2.5e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57755813419396  E_coul = 54.0426483908342
  HOMO = -0.848412066812904  LUMO = 0.662539745961661
  mo_energy =
[-3.27723681e+01 -1.92852637e+00 -8.48412067e-01 -8.48412067e-01
 -8.48412067e-01  6.62539746e-01  6.62539746e-01  6.62539746e-01
  2.01552575e+00  3.05626027e+00  3.05626027e+00  3.05626027e+00
  1.03860785e+01  1.03860785e+01  1.03860785e+01  1.92945937e+01
  3.40677801e+01  3.40677801e+01  3.40677801e+01  9.36808190e+01
  1.32545369e+02  1.32545369e+02  1.32545369e+02  3.55992228e+02
  1.34933364e+03  5.83574876e+03  3.50983439e+04]
E1 = -182.57755180384825  E_coul = 54.04264206048774
Extra cycle  E= -128.534909743361  delta_E= -7.39e-13  |g|= 8.34e-07  |ddm|= 1.36e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498569e+02 1.74905883e+02
 2.04863750e+01 5.69668552e+01 4.90195835e-01 7.82717819e+00
 1.65195972e+00 5.01568444e+00 1.44334410e+01 5.48770394e+01
 2.30825074e-01 1.87433982e+00 6.78625698e-01]
E = -128.53490974336052
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.47873          1
[INPUT] 0    0    [1    /1   ]  2712.09682124        1
[INPUT] 0    0    [1    /1   ]  617.49856945         1
[INPUT] 0    0    [1    /1   ]  174.905882797        1
[INPUT] 0    0    [1    /1   ]  20.4863749673        1
[INPUT] 0    0    [1    /1   ]  56.9668552196        1
[INPUT] 0    0    [1    /1   ]  0.49019583536        1
[INPUT] 0    0    [1    /1   ]  7.8271781863         1
[INPUT] 0    0    [1    /1   ]  1.65195972213        1
[INPUT] 1    0    [1    /1   ]  5.01568444204        1
[INPUT] 1    0    [1    /1   ]  14.4334409707        1
[INPUT] 1    0    [1    /1   ]  54.8770393911        1
[INPUT] 1    0    [1    /1   ]  0.230825074259       1
[INPUT] 1    0    [1    /1   ]  1.8743398218         1
[INPUT] 1    0    [1    /1   ]  0.678625697688       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47873000648, 1.0]], [0, [2712.096821240597, 1.0]], [0, [617.4985694504225, 1.0]], [0, [174.90588279664672, 1.0]], [0, [20.486374967328825, 1.0]], [0, [56.96685521956502, 1.0]], [0, [0.49019583536028216, 1.0]], [0, [7.8271781862974805, 1.0]], [0, [1.6519597221297653, 1.0]], [1, [5.015684442035664, 1.0]], [1, [14.433440970658612, 1.0]], [1, [54.877039391146454, 1.0]], [1, [0.23082507425931376, 1.0]], [1, [1.8743398218004743, 1.0]], [1, [0.6786256976877858, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47873001]
bas 1, expnt(s) = [2712.09682124]
bas 2, expnt(s) = [617.49856945]
bas 3, expnt(s) = [174.9058828]
bas 4, expnt(s) = [20.48637497]
bas 5, expnt(s) = [56.96685522]
bas 6, expnt(s) = [0.49019584]
bas 7, expnt(s) = [7.82717819]
bas 8, expnt(s) = [1.65195972]
bas 9, expnt(s) = [5.01568444]
bas 10, expnt(s) = [14.43344097]
bas 11, expnt(s) = [54.87703939]
bas 12, expnt(s) = [0.23082507]
bas 13, expnt(s) = [1.87433982]
bas 14, expnt(s) = [0.6786257]
CPU time:       145.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209682e+03 9.49497699e+02
 6.17498569e+02 3.12962276e+02 1.74905883e+02 1.21511767e+02
 2.04863750e+01 2.43284176e+01 5.69668552e+01 5.23879867e+01
 4.90195835e-01 1.48010402e+00 7.82717819e+00 1.18227618e+01
 1.65195972e+00 3.68141362e+00 5.01568444e+00 2.18976318e+01
 1.44334410e+01 8.20723262e+01 5.48770394e+01 4.35735289e+02
 2.30825074e-01 4.66754080e-01 1.87433982e+00 6.39800843e+00
 6.78625698e-01 1.79689322e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999395531803945
cond(S) = 239.68370453926414
E1 = -183.5833892499044  E_coul = 55.081056952578834
init E= -128.502332297326
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774895534222801  LUMO = 0.675976708054716
  mo_energy =
[-3.25544320e+01 -1.85120009e+00 -7.74895534e-01 -7.74895534e-01
 -7.74895534e-01  6.75976708e-01  6.75976708e-01  6.75976708e-01
  2.06844810e+00  3.10882481e+00  3.10882481e+00  3.10882481e+00
  1.04935111e+01  1.04935111e+01  1.04935111e+01  1.94441517e+01
  3.42350373e+01  3.42350373e+01  3.42350373e+01  9.38858807e+01
  1.32764322e+02  1.32764322e+02  1.32764322e+02  3.56232351e+02
  1.34960589e+03  5.83605002e+03  3.50986657e+04]
E1 = -182.06592392344166  E_coul = 53.534615964104304
cycle= 1 E= -128.531307959337  delta_E= -0.029  |g|= 0.206  |ddm|= 0.157
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.538909
diis-c [-0.29042257  1.        ]
  HOMO = -0.884358176687682  LUMO = 0.655870882426762
  mo_energy =
[-3.28814685e+01 -1.96653117e+00 -8.84358177e-01 -8.84358177e-01
 -8.84358177e-01  6.55870882e-01  6.55870882e-01  6.55870882e-01
  1.98985616e+00  3.03091319e+00  3.03091319e+00  3.03091319e+00
  1.03332242e+01  1.03332242e+01  1.03332242e+01  1.92195030e+01
  3.39839279e+01  3.39839279e+01  3.39839279e+01  9.35777934e+01
  1.32436808e+02  1.32436808e+02  1.32436808e+02  3.55876327e+02
  1.34921154e+03  5.83562378e+03  3.50982179e+04]
E1 = -182.83906566293763  E_coul = 54.30510038074419
cycle= 2 E= -128.533965282193  delta_E= -0.00266  |g|= 0.105  |ddm|= 0.0713
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.273931
diis-c [-5.99023774e-04  3.36340385e-01  6.63659615e-01]
  HOMO = -0.84818132173285  LUMO = 0.662562973546194
  mo_energy =
[-3.27719175e+01 -1.92832805e+00 -8.48181322e-01 -8.48181322e-01
 -8.48181322e-01  6.62562974e-01  6.62562974e-01  6.62562974e-01
  2.01563928e+00  3.05638788e+00  3.05638788e+00  3.05638788e+00
  1.03863265e+01  1.03863265e+01  1.03863265e+01  1.92948944e+01
  3.40681321e+01  3.40681321e+01  3.40681321e+01  9.36812412e+01
  1.32545831e+02  1.32545831e+02  1.32545831e+02  3.55992768e+02
  1.34933432e+03  5.83574954e+03  3.50983448e+04]
E1 = -182.57709080135047  E_coul = 54.04218107159819
cycle= 3 E= -128.534909729752  delta_E= -0.000944  |g|= 0.000384  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000960764
diis-c [-8.80749061e-08 -1.94186165e-03 -4.81370788e-04  1.00242323e+00]
  HOMO = -0.848378458292469  LUMO = 0.662548377480293
  mo_energy =
[-3.27723052e+01 -1.92849297e+00 -8.48378458e-01 -8.48378458e-01
 -8.48378458e-01  6.62548377e-01  6.62548377e-01  6.62548377e-01
  2.01555277e+00  3.05628813e+00  3.05628813e+00  3.05628813e+00
  1.03861235e+01  1.03861235e+01  1.03861235e+01  1.92946459e+01
  3.40678364e+01  3.40678364e+01  3.40678364e+01  9.36808802e+01
  1.32545432e+02  1.32545432e+02  1.32545432e+02  3.55992295e+02
  1.34933371e+03  5.83574883e+03  3.50983440e+04]
E1 = -182.57743687398602  E_coul = 54.042527131025146
cycle= 4 E= -128.534909742961  delta_E= -1.32e-08  |g|= 6.6e-05  |ddm|= 0.000152
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000164155
diis-c [-4.23495473e-10  7.09496474e-05  4.38455107e-04 -1.04888962e-01
  1.10437956e+00]
  HOMO = -0.84841244843545  LUMO = 0.662539766477928
  mo_energy =
[-3.27723696e+01 -1.92852673e+00 -8.48412448e-01 -8.48412448e-01
 -8.48412448e-01  6.62539766e-01  6.62539766e-01  6.62539766e-01
  2.01552563e+00  3.05626014e+00  3.05626014e+00  3.05626014e+00
  1.03860778e+01  1.03860778e+01  1.03860778e+01  1.92945926e+01
  3.40677789e+01  3.40677789e+01  3.40677789e+01  9.36808176e+01
  1.32545367e+02  1.32545367e+02  1.32545367e+02  3.55992227e+02
  1.34933364e+03  5.83574876e+03  3.50983439e+04]
E1 = -182.57755813419396  E_coul = 54.0426483908342
cycle= 5 E= -128.53490974336  delta_E= -3.99e-10  |g|= 1.81e-06  |ddm|= 2.5e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57755813419396  E_coul = 54.0426483908342
  HOMO = -0.848412066812904  LUMO = 0.662539745961661
  mo_energy =
[-3.27723681e+01 -1.92852637e+00 -8.48412067e-01 -8.48412067e-01
 -8.48412067e-01  6.62539746e-01  6.62539746e-01  6.62539746e-01
  2.01552575e+00  3.05626027e+00  3.05626027e+00  3.05626027e+00
  1.03860785e+01  1.03860785e+01  1.03860785e+01  1.92945937e+01
  3.40677801e+01  3.40677801e+01  3.40677801e+01  9.36808190e+01
  1.32545369e+02  1.32545369e+02  1.32545369e+02  3.55992228e+02
  1.34933364e+03  5.83574876e+03  3.50983439e+04]
E1 = -182.57755180384825  E_coul = 54.04264206048774
Extra cycle  E= -128.534909743361  delta_E= -7.39e-13  |g|= 8.34e-07  |ddm|= 1.36e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.68370453926414
E1 = -182.57755180384825  E_coul = 54.04264206048774
init E= -128.534909743361
    CPU time for initialize scf      0.28 sec, wall time      0.27 sec
  HOMO = -0.848412534031003  LUMO = 0.662539643757385
  mo_energy =
[-3.27723694e+01 -1.92852688e+00 -8.48412534e-01 -8.48412534e-01
 -8.48412534e-01  6.62539644e-01  6.62539644e-01  6.62539644e-01
  2.01552537e+00  3.05625992e+00  3.05625992e+00  3.05625992e+00
  1.03860778e+01  1.03860778e+01  1.03860778e+01  1.92945928e+01
  3.40677792e+01  3.40677792e+01  3.40677792e+01  9.36808178e+01
  1.32545368e+02  1.32545368e+02  1.32545368e+02  3.55992227e+02
  1.34933364e+03  5.83574876e+03  3.50983439e+04]
E1 = -182.57755451478238  E_coul = 54.04264477142181
cycle= 1 E= -128.534909743361  delta_E= -5.68e-14  |g|= 3.76e-07  |ddm|= 3.31e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57755451478238  E_coul = 54.04264477142181
  HOMO = -0.848412345091485  LUMO = 0.662539676319052
  mo_energy =
[-3.27723688e+01 -1.92852669e+00 -8.48412345e-01 -8.48412345e-01
 -8.48412345e-01  6.62539676e-01  6.62539676e-01  6.62539676e-01
  2.01552550e+00  3.05626005e+00  3.05626005e+00  3.05626005e+00
  1.03860781e+01  1.03860781e+01  1.03860781e+01  1.92945932e+01
  3.40677796e+01  3.40677796e+01  3.40677796e+01  9.36808184e+01
  1.32545368e+02  1.32545368e+02  1.32545368e+02  3.55992228e+02
  1.34933364e+03  5.83574876e+03  3.50983439e+04]
E1 = -182.57755303423636  E_coul = 54.04264329087566
Extra cycle  E= -128.534909743361  delta_E= -1.14e-13  |g|= 2e-07  |ddm|= 1.36e-07
    CPU time for scf_cycle      0.34 sec, wall time      0.33 sec
exp = [1.80764787e+04 2.71209682e+03 6.17498569e+02 1.74905883e+02
 2.04863750e+01 5.69668552e+01 4.90195835e-01 7.82717819e+00
 1.65195972e+00 5.01568444e+00 1.44334410e+01 5.48770394e+01
 2.30825074e-01 1.87433982e+00 6.78625698e-01]
grad_E = [ 1.37475042e-10 -6.82546441e-09  1.28623833e-07 -1.16338836e-06
 -8.34054930e-06  5.49568061e-06  6.61638563e-03  4.12115611e-06
 -1.89842491e-03 -2.22965164e-05 -1.39855936e-04 -1.85875003e-04
 -1.44553162e-04  8.65691700e-04 -9.53002820e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787299        1
[INPUT] 0    0    [1    /1   ]  2712.09682715        1
[INPUT] 0    0    [1    /1   ]  617.498469983        1
[INPUT] 0    0    [1    /1   ]  174.906543069        1
[INPUT] 0    0    [1    /1   ]  20.4828599632        1
[INPUT] 0    0    [1    /1   ]  56.9671437888        1
[INPUT] 0    0    [1    /1   ]  0.492098600391       1
[INPUT] 0    0    [1    /1   ]  7.83561433704        1
[INPUT] 0    0    [1    /1   ]  1.65159424556        1
[INPUT] 1    0    [1    /1   ]  5.05480214524        1
[INPUT] 1    0    [1    /1   ]  14.469048057         1
[INPUT] 1    0    [1    /1   ]  55.27107624          1
[INPUT] 1    0    [1    /1   ]  0.232338856352       1
[INPUT] 1    0    [1    /1   ]  1.89959426307        1
[INPUT] 1    0    [1    /1   ]  0.686497920252       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478729883078, 1.0]], [0, [2712.0968271498023, 1.0]], [0, [617.4984699830469, 1.0]], [0, [174.9065430686761, 1.0]], [0, [20.482859963185042, 1.0]], [0, [56.96714378883496, 1.0]], [0, [0.492098600390983, 1.0]], [0, [7.835614337040236, 1.0]], [0, [1.6515942455565373, 1.0]], [1, [5.054802145238549, 1.0]], [1, [14.469048056956348, 1.0]], [1, [55.27107623996443, 1.0]], [1, [0.23233885635241935, 1.0]], [1, [1.8995942630727298, 1.0]], [1, [0.6864979202516982, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872988]
bas 1, expnt(s) = [2712.09682715]
bas 2, expnt(s) = [617.49846998]
bas 3, expnt(s) = [174.90654307]
bas 4, expnt(s) = [20.48285996]
bas 5, expnt(s) = [56.96714379]
bas 6, expnt(s) = [0.4920986]
bas 7, expnt(s) = [7.83561434]
bas 8, expnt(s) = [1.65159425]
bas 9, expnt(s) = [5.05480215]
bas 10, expnt(s) = [14.46904806]
bas 11, expnt(s) = [55.27107624]
bas 12, expnt(s) = [0.23233886]
bas 13, expnt(s) = [1.89959426]
bas 14, expnt(s) = [0.68649792]
CPU time:       149.09
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498470e+02 3.12962238e+02 1.74906543e+02 1.21512111e+02
 2.04828600e+01 2.43252869e+01 5.69671438e+01 5.23881857e+01
 4.92098600e-01 1.48441086e+00 7.83561434e+00 1.18323175e+01
 1.65159425e+00 3.68080275e+00 5.05480215e+00 2.21113161e+01
 1.44690481e+01 8.23254932e+01 5.52710762e+01 4.39649713e+02
 2.32338856e-01 4.70583507e-01 1.89959426e+00 6.50594600e+00
 6.86497920e-01 1.82298638e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999383594477369
cond(S) = 240.06473914061098
E1 = -183.58316927281456  E_coul = 55.08090375405052
init E= -128.502265518764
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774907888141789  LUMO = 0.682419280800992
  mo_energy =
[-3.25544798e+01 -1.85119970e+00 -7.74907888e-01 -7.74907888e-01
 -7.74907888e-01  6.82419281e-01  6.82419281e-01  6.82419281e-01
  2.07474400e+00  3.14641320e+00  3.14641320e+00  3.14641320e+00
  1.06199555e+01  1.06199555e+01  1.06199555e+01  1.94631935e+01
  3.45004139e+01  3.45004139e+01  3.45004139e+01  9.39140559e+01
  1.33693624e+02  1.33693624e+02  1.33693624e+02  3.56258669e+02
  1.34963041e+03  5.83607201e+03  3.50986839e+04]
E1 = -182.06904333304726  E_coul = 53.53767904718373
cycle= 1 E= -128.531364285864  delta_E= -0.0291  |g|= 0.206  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.537646
diis-c [-0.28906354  1.        ]
  HOMO = -0.884092701977222  LUMO = 0.662073563524993
  mo_energy =
[-3.28809595e+01 -1.96632157e+00 -8.84092702e-01 -8.84092702e-01
 -8.84092702e-01  6.62073564e-01  6.62073564e-01  6.62073564e-01
  1.99618983e+00  3.06783552e+00  3.06783552e+00  3.06783552e+00
  1.04592121e+01  1.04592121e+01  1.04592121e+01  1.92389850e+01
  3.42495564e+01  3.42495564e+01  3.42495564e+01  9.36065072e+01
  1.33366422e+02  1.33366422e+02  1.33366422e+02  3.55903214e+02
  1.34923662e+03  5.83564635e+03  3.50982367e+04]
E1 = -182.840321505171  E_coul = 54.30631013911908
cycle= 2 E= -128.534011366052  delta_E= -0.00265  |g|= 0.105  |ddm|= 0.0714
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.273257
diis-c [-5.97561582e-04  3.36312239e-01  6.63687761e-01]
  HOMO = -0.848003623828464  LUMO = 0.668844209290914
  mo_energy =
[-3.27716573e+01 -1.92821328e+00 -8.48003624e-01 -8.48003624e-01
 -8.48003624e-01  6.68844209e-01  6.68844209e-01  6.68844209e-01
  2.02194220e+00  3.09353109e+00  3.09353109e+00  3.09353109e+00
  1.05124592e+01  1.05124592e+01  1.05124592e+01  1.93142123e+01
  3.43336426e+01  3.43336426e+01  3.43336426e+01  9.37097192e+01
  1.33475268e+02  1.33475268e+02  1.33475268e+02  3.56019395e+02
  1.34935913e+03  5.83577184e+03  3.50983633e+04]
E1 = -182.579024600076  E_coul = 54.04407333451139
cycle= 3 E= -128.534951265565  delta_E= -0.00094  |g|= 0.000379  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000924441
diis-c [-8.42230042e-08 -1.93903097e-03 -6.01454622e-04  1.00254049e+00]
  HOMO = -0.84819964546121  LUMO = 0.668828856978121
  mo_energy =
[-3.27720423e+01 -1.92838434e+00 -8.48199645e-01 -8.48199645e-01
 -8.48199645e-01  6.68828857e-01  6.68828857e-01  6.68828857e-01
  2.02185023e+00  3.09342967e+00  3.09342967e+00  3.09342967e+00
  1.05122550e+01  1.05122550e+01  1.05122550e+01  1.93139632e+01
  3.43333473e+01  3.43333473e+01  3.43333473e+01  9.37093606e+01
  1.33474871e+02  1.33474871e+02  1.33474871e+02  3.56018927e+02
  1.34935854e+03  5.83577114e+03  3.50983626e+04]
E1 = -182.5793534698301  E_coul = 54.04440219114177
cycle= 4 E= -128.534951278688  delta_E= -1.31e-08  |g|= 6.4e-05  |ddm|= 0.000158
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000152401
diis-c [-4.41090038e-10  6.35373091e-05  4.03735496e-04 -1.00078024e-01
  1.09961075e+00]
  HOMO = -0.848232781549873  LUMO = 0.66882019837252
  mo_energy =
[-3.27721043e+01 -1.92841880e+00 -8.48232782e-01 -8.48232782e-01
 -8.48232782e-01  6.68820198e-01  6.68820198e-01  6.68820198e-01
  2.02182235e+00  3.09340185e+00  3.09340185e+00  3.09340185e+00
  1.05122102e+01  1.05122102e+01  1.05122102e+01  1.93139110e+01
  3.43332915e+01  3.43332915e+01  3.43332915e+01  9.37093002e+01
  1.33474810e+02  1.33474810e+02  1.33474810e+02  3.56018863e+02
  1.34935847e+03  5.83577108e+03  3.50983625e+04]
E1 = -182.57946602391266  E_coul = 54.04451474484232
cycle= 5 E= -128.53495127907  delta_E= -3.82e-10  |g|= 2.14e-06  |ddm|= 2.66e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57946602391266  E_coul = 54.04451474484232
  HOMO = -0.848232388317189  LUMO = 0.668820158001705
  mo_energy =
[-3.27721025e+01 -1.92841860e+00 -8.48232388e-01 -8.48232388e-01
 -8.48232388e-01  6.68820158e-01  6.68820158e-01  6.68820158e-01
  2.02182231e+00  3.09340196e+00  3.09340196e+00  3.09340196e+00
  1.05122108e+01  1.05122108e+01  1.05122108e+01  1.93139122e+01
  3.43332928e+01  3.43332928e+01  3.43332928e+01  9.37093018e+01
  1.33474811e+02  1.33474811e+02  1.33474811e+02  3.56018865e+02
  1.34935847e+03  5.83577108e+03  3.50983625e+04]
E1 = -182.57945871775502  E_coul = 54.044507438683894
Extra cycle  E= -128.534951279071  delta_E= -7.67e-13  |g|= 9.93e-07  |ddm|= 1.65e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498470e+02 1.74906543e+02
 2.04828600e+01 5.69671438e+01 4.92098600e-01 7.83561434e+00
 1.65159425e+00 5.05480215e+00 1.44690481e+01 5.52710762e+01
 2.32338856e-01 1.89959426e+00 6.86497920e-01]
E = -128.53495127907112
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787299        1
[INPUT] 0    0    [1    /1   ]  2712.09682715        1
[INPUT] 0    0    [1    /1   ]  617.498469983        1
[INPUT] 0    0    [1    /1   ]  174.906543069        1
[INPUT] 0    0    [1    /1   ]  20.4828599632        1
[INPUT] 0    0    [1    /1   ]  56.9671437888        1
[INPUT] 0    0    [1    /1   ]  0.492098600391       1
[INPUT] 0    0    [1    /1   ]  7.83561433704        1
[INPUT] 0    0    [1    /1   ]  1.65159424556        1
[INPUT] 1    0    [1    /1   ]  5.05480214524        1
[INPUT] 1    0    [1    /1   ]  14.469048057         1
[INPUT] 1    0    [1    /1   ]  55.27107624          1
[INPUT] 1    0    [1    /1   ]  0.232338856352       1
[INPUT] 1    0    [1    /1   ]  1.89959426307        1
[INPUT] 1    0    [1    /1   ]  0.686497920252       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478729883078, 1.0]], [0, [2712.0968271498023, 1.0]], [0, [617.4984699830469, 1.0]], [0, [174.9065430686761, 1.0]], [0, [20.482859963185042, 1.0]], [0, [56.96714378883496, 1.0]], [0, [0.492098600390983, 1.0]], [0, [7.835614337040236, 1.0]], [0, [1.6515942455565373, 1.0]], [1, [5.054802145238549, 1.0]], [1, [14.469048056956348, 1.0]], [1, [55.27107623996443, 1.0]], [1, [0.23233885635241935, 1.0]], [1, [1.8995942630727298, 1.0]], [1, [0.6864979202516982, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872988]
bas 1, expnt(s) = [2712.09682715]
bas 2, expnt(s) = [617.49846998]
bas 3, expnt(s) = [174.90654307]
bas 4, expnt(s) = [20.48285996]
bas 5, expnt(s) = [56.96714379]
bas 6, expnt(s) = [0.4920986]
bas 7, expnt(s) = [7.83561434]
bas 8, expnt(s) = [1.65159425]
bas 9, expnt(s) = [5.05480215]
bas 10, expnt(s) = [14.46904806]
bas 11, expnt(s) = [55.27107624]
bas 12, expnt(s) = [0.23233886]
bas 13, expnt(s) = [1.89959426]
bas 14, expnt(s) = [0.68649792]
CPU time:       149.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209683e+03 9.49497700e+02
 6.17498470e+02 3.12962238e+02 1.74906543e+02 1.21512111e+02
 2.04828600e+01 2.43252869e+01 5.69671438e+01 5.23881857e+01
 4.92098600e-01 1.48441086e+00 7.83561434e+00 1.18323175e+01
 1.65159425e+00 3.68080275e+00 5.05480215e+00 2.21113161e+01
 1.44690481e+01 8.23254932e+01 5.52710762e+01 4.39649713e+02
 2.32338856e-01 4.70583507e-01 1.89959426e+00 6.50594600e+00
 6.86497920e-01 1.82298638e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999383594477369
cond(S) = 240.06473914061098
E1 = -183.58316927281456  E_coul = 55.08090375405052
init E= -128.502265518764
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774907888141789  LUMO = 0.682419280800992
  mo_energy =
[-3.25544798e+01 -1.85119970e+00 -7.74907888e-01 -7.74907888e-01
 -7.74907888e-01  6.82419281e-01  6.82419281e-01  6.82419281e-01
  2.07474400e+00  3.14641320e+00  3.14641320e+00  3.14641320e+00
  1.06199555e+01  1.06199555e+01  1.06199555e+01  1.94631935e+01
  3.45004139e+01  3.45004139e+01  3.45004139e+01  9.39140559e+01
  1.33693624e+02  1.33693624e+02  1.33693624e+02  3.56258669e+02
  1.34963041e+03  5.83607201e+03  3.50986839e+04]
E1 = -182.06904333304726  E_coul = 53.53767904718373
cycle= 1 E= -128.531364285864  delta_E= -0.0291  |g|= 0.206  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.537646
diis-c [-0.28906354  1.        ]
  HOMO = -0.884092701977222  LUMO = 0.662073563524993
  mo_energy =
[-3.28809595e+01 -1.96632157e+00 -8.84092702e-01 -8.84092702e-01
 -8.84092702e-01  6.62073564e-01  6.62073564e-01  6.62073564e-01
  1.99618983e+00  3.06783552e+00  3.06783552e+00  3.06783552e+00
  1.04592121e+01  1.04592121e+01  1.04592121e+01  1.92389850e+01
  3.42495564e+01  3.42495564e+01  3.42495564e+01  9.36065072e+01
  1.33366422e+02  1.33366422e+02  1.33366422e+02  3.55903214e+02
  1.34923662e+03  5.83564635e+03  3.50982367e+04]
E1 = -182.840321505171  E_coul = 54.30631013911908
cycle= 2 E= -128.534011366052  delta_E= -0.00265  |g|= 0.105  |ddm|= 0.0714
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.273257
diis-c [-5.97561582e-04  3.36312239e-01  6.63687761e-01]
  HOMO = -0.848003623828464  LUMO = 0.668844209290914
  mo_energy =
[-3.27716573e+01 -1.92821328e+00 -8.48003624e-01 -8.48003624e-01
 -8.48003624e-01  6.68844209e-01  6.68844209e-01  6.68844209e-01
  2.02194220e+00  3.09353109e+00  3.09353109e+00  3.09353109e+00
  1.05124592e+01  1.05124592e+01  1.05124592e+01  1.93142123e+01
  3.43336426e+01  3.43336426e+01  3.43336426e+01  9.37097192e+01
  1.33475268e+02  1.33475268e+02  1.33475268e+02  3.56019395e+02
  1.34935913e+03  5.83577184e+03  3.50983633e+04]
E1 = -182.579024600076  E_coul = 54.04407333451139
cycle= 3 E= -128.534951265565  delta_E= -0.00094  |g|= 0.000379  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000924441
diis-c [-8.42230042e-08 -1.93903097e-03 -6.01454622e-04  1.00254049e+00]
  HOMO = -0.84819964546121  LUMO = 0.668828856978121
  mo_energy =
[-3.27720423e+01 -1.92838434e+00 -8.48199645e-01 -8.48199645e-01
 -8.48199645e-01  6.68828857e-01  6.68828857e-01  6.68828857e-01
  2.02185023e+00  3.09342967e+00  3.09342967e+00  3.09342967e+00
  1.05122550e+01  1.05122550e+01  1.05122550e+01  1.93139632e+01
  3.43333473e+01  3.43333473e+01  3.43333473e+01  9.37093606e+01
  1.33474871e+02  1.33474871e+02  1.33474871e+02  3.56018927e+02
  1.34935854e+03  5.83577114e+03  3.50983626e+04]
E1 = -182.5793534698301  E_coul = 54.04440219114177
cycle= 4 E= -128.534951278688  delta_E= -1.31e-08  |g|= 6.4e-05  |ddm|= 0.000158
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000152401
diis-c [-4.41090038e-10  6.35373091e-05  4.03735496e-04 -1.00078024e-01
  1.09961075e+00]
  HOMO = -0.848232781549873  LUMO = 0.66882019837252
  mo_energy =
[-3.27721043e+01 -1.92841880e+00 -8.48232782e-01 -8.48232782e-01
 -8.48232782e-01  6.68820198e-01  6.68820198e-01  6.68820198e-01
  2.02182235e+00  3.09340185e+00  3.09340185e+00  3.09340185e+00
  1.05122102e+01  1.05122102e+01  1.05122102e+01  1.93139110e+01
  3.43332915e+01  3.43332915e+01  3.43332915e+01  9.37093002e+01
  1.33474810e+02  1.33474810e+02  1.33474810e+02  3.56018863e+02
  1.34935847e+03  5.83577108e+03  3.50983625e+04]
E1 = -182.57946602391266  E_coul = 54.04451474484232
cycle= 5 E= -128.53495127907  delta_E= -3.82e-10  |g|= 2.14e-06  |ddm|= 2.66e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.57946602391266  E_coul = 54.04451474484232
  HOMO = -0.848232388317189  LUMO = 0.668820158001705
  mo_energy =
[-3.27721025e+01 -1.92841860e+00 -8.48232388e-01 -8.48232388e-01
 -8.48232388e-01  6.68820158e-01  6.68820158e-01  6.68820158e-01
  2.02182231e+00  3.09340196e+00  3.09340196e+00  3.09340196e+00
  1.05122108e+01  1.05122108e+01  1.05122108e+01  1.93139122e+01
  3.43332928e+01  3.43332928e+01  3.43332928e+01  9.37093018e+01
  1.33474811e+02  1.33474811e+02  1.33474811e+02  3.56018865e+02
  1.34935847e+03  5.83577108e+03  3.50983625e+04]
E1 = -182.57945871775502  E_coul = 54.044507438683894
Extra cycle  E= -128.534951279071  delta_E= -7.67e-13  |g|= 9.93e-07  |ddm|= 1.65e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.06473914061098
E1 = -182.57945871775502  E_coul = 54.044507438683894
init E= -128.534951279071
    CPU time for initialize scf      0.31 sec, wall time      0.31 sec
  HOMO = -0.848232922563053  LUMO = 0.668820037811785
  mo_energy =
[-3.27721039e+01 -1.92841922e+00 -8.48232923e-01 -8.48232923e-01
 -8.48232923e-01  6.68820038e-01  6.68820038e-01  6.68820038e-01
  2.02182186e+00  3.09340154e+00  3.09340154e+00  3.09340154e+00
  1.05122101e+01  1.05122101e+01  1.05122101e+01  1.93139111e+01
  3.43332916e+01  3.43332916e+01  3.43332916e+01  9.37093004e+01
  1.33474810e+02  1.33474810e+02  1.33474810e+02  3.56018863e+02
  1.34935847e+03  5.83577108e+03  3.50983625e+04]
E1 = -182.57946176903698  E_coul = 54.04451048996584
cycle= 1 E= -128.534951279071  delta_E= -2.84e-14  |g|= 4.25e-07  |ddm|= 4.39e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.57946176903698  E_coul = 54.04451048996584
  HOMO = -0.848232709076254  LUMO = 0.668820074680985
  mo_energy =
[-3.27721033e+01 -1.92841901e+00 -8.48232709e-01 -8.48232709e-01
 -8.48232709e-01  6.68820075e-01  6.68820075e-01  6.68820075e-01
  2.02182199e+00  3.09340169e+00  3.09340169e+00  3.09340169e+00
  1.05122104e+01  1.05122104e+01  1.05122104e+01  1.93139116e+01
  3.43332921e+01  3.43332921e+01  3.43332921e+01  9.37093011e+01
  1.33474811e+02  1.33474811e+02  1.33474811e+02  3.56018864e+02
  1.34935847e+03  5.83577108e+03  3.50983625e+04]
E1 = -182.57946008312743  E_coul = 54.04450880405648
Extra cycle  E= -128.534951279071  delta_E= 1.99e-13  |g|= 2.28e-07  |ddm|= 1.51e-07
    CPU time for scf_cycle      0.37 sec, wall time      0.36 sec
exp = [1.80764787e+04 2.71209683e+03 6.17498470e+02 1.74906543e+02
 2.04828600e+01 5.69671438e+01 4.92098600e-01 7.83561434e+00
 1.65159425e+00 5.05480215e+00 1.44690481e+01 5.52710762e+01
 2.32338856e-01 1.89959426e+00 6.86497920e-01]
grad_E = [ 2.89501092e-10 -1.47515862e-08  2.87530698e-07 -2.95569087e-06
 -4.94786110e-05  1.79078253e-05  1.06428806e-02  6.38616961e-05
 -2.96371724e-03 -6.86050809e-06 -2.15559189e-04 -1.69825384e-04
 -3.30045161e-04  1.29580376e-03 -1.40233663e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787296        1
[INPUT] 0    0    [1    /1   ]  2712.0968416         1
[INPUT] 0    0    [1    /1   ]  617.498226944        1
[INPUT] 0    0    [1    /1   ]  174.908150647        1
[INPUT] 0    0    [1    /1   ]  20.4742541686        1
[INPUT] 0    0    [1    /1   ]  56.9679287741        1
[INPUT] 0    0    [1    /1   ]  0.49471635014        1
[INPUT] 0    0    [1    /1   ]  7.8558825468         1
[INPUT] 0    0    [1    /1   ]  1.65086436588        1
[INPUT] 1    0    [1    /1   ]  5.14613484066        1
[INPUT] 1    0    [1    /1   ]  14.6234476984        1
[INPUT] 1    0    [1    /1   ]  56.2306550052        1
[INPUT] 1    0    [1    /1   ]  0.235589927467       1
[INPUT] 1    0    [1    /1   ]  1.94876917494        1
[INPUT] 1    0    [1    /1   ]  0.701929029089       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478729581104, 1.0]], [0, [2712.096841601305, 1.0]], [0, [617.4982269437539, 1.0]], [0, [174.90815064730245, 1.0]], [0, [20.474254168569754, 1.0]], [0, [56.9679287740862, 1.0]], [0, [0.4947163501395076, 1.0]], [0, [7.85588254680333, 1.0]], [0, [1.6508643658773277, 1.0]], [1, [5.146134840660187, 1.0]], [1, [14.623447698441227, 1.0]], [1, [56.23065500517709, 1.0]], [1, [0.23558992746679064, 1.0]], [1, [1.948769174935991, 1.0]], [1, [0.7019290290890247, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872958]
bas 1, expnt(s) = [2712.0968416]
bas 2, expnt(s) = [617.49822694]
bas 3, expnt(s) = [174.90815065]
bas 4, expnt(s) = [20.47425417]
bas 5, expnt(s) = [56.96792877]
bas 6, expnt(s) = [0.49471635]
bas 7, expnt(s) = [7.85588255]
bas 8, expnt(s) = [1.65086437]
bas 9, expnt(s) = [5.14613484]
bas 10, expnt(s) = [14.6234477]
bas 11, expnt(s) = [56.23065501]
bas 12, expnt(s) = [0.23558993]
bas 13, expnt(s) = [1.94876917]
bas 14, expnt(s) = [0.70192903]
CPU time:       153.13
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209684e+03 9.49497704e+02
 6.17498227e+02 3.12962146e+02 1.74908151e+02 1.21512949e+02
 2.04742542e+01 2.43176214e+01 5.69679288e+01 5.23887271e+01
 4.94716350e-01 1.49032924e+00 7.85588255e+00 1.18552648e+01
 1.65086437e+00 3.67958271e+00 5.14613484e+00 2.26118369e+01
 1.46234477e+01 8.34250763e+01 5.62306550e+01 4.49211453e+02
 2.35589927e-01 4.78828829e-01 1.94876917e+00 6.71714765e+00
 7.01929029e-01 1.87435089e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999358744065399
cond(S) = 240.8606583516171
E1 = -183.5828307987342  E_coul = 55.08069166014267
init E= -128.502139138592
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774934712173903  LUMO = 0.695856583009802
  mo_energy =
[-3.25545363e+01 -1.85119756e+00 -7.74934712e-01 -7.74934712e-01
 -7.74934712e-01  6.95856583e-01  6.95856583e-01  6.95856583e-01
  2.08336325e+00  3.22164733e+00  3.22164733e+00  3.22164733e+00
  1.08794856e+01  1.08794856e+01  1.08794856e+01  1.95006072e+01
  3.51533542e+01  3.51533542e+01  3.51533542e+01  9.39744074e+01
  1.36110200e+02  1.36110200e+02  1.36110200e+02  3.56315484e+02
  1.34968371e+03  5.83612001e+03  3.50987238e+04]
E1 = -182.07408692887986  E_coul = 53.54259994076789
cycle= 1 E= -128.531486988112  delta_E= -0.0293  |g|= 0.205  |ddm|= 0.155
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.535395
diis-c [-0.28664786  1.        ]
  HOMO = -0.883686198514181  LUMO = 0.675000498233911
  mo_energy =
[-3.28801074e+01 -1.96597551e+00 -8.83686199e-01 -8.83686199e-01
 -8.83686199e-01  6.75000498e-01  6.75000498e-01  6.75000498e-01
  2.00490063e+00  3.14168739e+00  3.14168739e+00  3.14168739e+00
  1.07175419e+01  1.07175419e+01  1.07175419e+01  1.92770567e+01
  3.49024059e+01  3.49024059e+01  3.49024059e+01  9.36677354e+01
  1.35783275e+02  1.35783275e+02  1.35783275e+02  3.55960970e+02
  1.34929089e+03  5.83569530e+03  3.50982775e+04]
E1 = -182.8423240334123  E_coul = 54.308206297336994
cycle= 2 E= -128.534117736075  delta_E= -0.00263  |g|= 0.104  |ddm|= 0.0716
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.272027
diis-c [-5.95899544e-04  3.36237298e-01  6.63762702e-01]
  HOMO = -0.847739188529245  LUMO = 0.681938134209984
  mo_energy =
[-3.27712048e+01 -1.92802081e+00 -8.47739189e-01 -8.47739189e-01
 -8.47739189e-01  6.81938134e-01  6.81938134e-01  6.81938134e-01
  2.03059536e+00  3.16783810e+00  3.16783810e+00  3.16783810e+00
  1.07711775e+01  1.07711775e+01  1.07711775e+01  1.93520343e+01
  3.49864691e+01  3.49864691e+01  3.49864691e+01  9.37705695e+01
  1.35891908e+02  1.35891908e+02  1.35891908e+02  3.56076732e+02
  1.34941297e+03  5.83582036e+03  3.50984037e+04]
E1 = -182.582141444701  E_coul = 54.04709120841123
cycle= 3 E= -128.53505023629  delta_E= -0.000933  |g|= 0.000376  |ddm|= 0.0245
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000878244
diis-c [-8.11155869e-08 -1.94297319e-03 -7.70602184e-04  1.00271358e+00]
  HOMO = -0.847933845076642  LUMO = 0.681921516876417
  mo_energy =
[-3.27715868e+01 -1.92820041e+00 -8.47933845e-01 -8.47933845e-01
 -8.47933845e-01  6.81921517e-01  6.81921517e-01  6.81921517e-01
  2.03049579e+00  3.16773361e+00  3.16773361e+00  3.16773361e+00
  1.07709708e+01  1.07709708e+01  1.07709708e+01  1.93517839e+01
  3.49861733e+01  3.49861733e+01  3.49861733e+01  9.37702134e+01
  1.35891515e+02  1.35891515e+02  1.35891515e+02  3.56076272e+02
  1.34941239e+03  5.83581968e+03  3.50984029e+04]
E1 = -182.58245021946627  E_coul = 54.04739996982864
cycle= 4 E= -128.535050249638  delta_E= -1.33e-08  |g|= 6.19e-05  |ddm|= 0.000167
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000136746
diis-c [-5.22978445e-10  6.04885662e-05  3.58198738e-04 -9.72709184e-02
  1.09685223e+00]
  HOMO = -0.847965841466344  LUMO = 0.681912736300651
  mo_energy =
[-3.27716454e+01 -1.92823580e+00 -8.47965841e-01 -8.47965841e-01
 -8.47965841e-01  6.81912736e-01  6.81912736e-01  6.81912736e-01
  2.03046692e+00  3.16770592e+00  3.16770592e+00  3.16770592e+00
  1.07709270e+01  1.07709270e+01  1.07709270e+01  1.93517330e+01
  3.49861195e+01  3.49861195e+01  3.49861195e+01  9.37701560e+01
  1.35891456e+02  1.35891456e+02  1.35891456e+02  3.56076213e+02
  1.34941232e+03  5.83581962e+03  3.50984029e+04]
E1 = -182.58255153794642  E_coul = 54.04750128793571
cycle= 5 E= -128.535050250011  delta_E= -3.73e-10  |g|= 2.87e-06  |ddm|= 2.92e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58255153794642  E_coul = 54.04750128793571
  HOMO = -0.847965270025313  LUMO = 0.681912709606387
  mo_energy =
[-3.27716430e+01 -1.92823565e+00 -8.47965270e-01 -8.47965270e-01
 -8.47965270e-01  6.81912710e-01  6.81912710e-01  6.81912710e-01
  2.03046679e+00  3.16770612e+00  3.16770612e+00  3.16770612e+00
  1.07709279e+01  1.07709279e+01  1.07709279e+01  1.93517345e+01
  3.49861213e+01  3.49861213e+01  3.49861213e+01  9.37701582e+01
  1.35891459e+02  1.35891459e+02  1.35891459e+02  3.56076215e+02
  1.34941233e+03  5.83581962e+03  3.50984029e+04]
E1 = -182.58254220886883  E_coul = 54.04749195885638
Extra cycle  E= -128.535050250012  delta_E= -1.76e-12  |g|= 1.32e-06  |ddm|= 2.06e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209684e+03 6.17498227e+02 1.74908151e+02
 2.04742542e+01 5.69679288e+01 4.94716350e-01 7.85588255e+00
 1.65086437e+00 5.14613484e+00 1.46234477e+01 5.62306550e+01
 2.35589927e-01 1.94876917e+00 7.01929029e-01]
E = -128.53505025001246
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787296        1
[INPUT] 0    0    [1    /1   ]  2712.0968416         1
[INPUT] 0    0    [1    /1   ]  617.498226944        1
[INPUT] 0    0    [1    /1   ]  174.908150647        1
[INPUT] 0    0    [1    /1   ]  20.4742541686        1
[INPUT] 0    0    [1    /1   ]  56.9679287741        1
[INPUT] 0    0    [1    /1   ]  0.49471635014        1
[INPUT] 0    0    [1    /1   ]  7.8558825468         1
[INPUT] 0    0    [1    /1   ]  1.65086436588        1
[INPUT] 1    0    [1    /1   ]  5.14613484066        1
[INPUT] 1    0    [1    /1   ]  14.6234476984        1
[INPUT] 1    0    [1    /1   ]  56.2306550052        1
[INPUT] 1    0    [1    /1   ]  0.235589927467       1
[INPUT] 1    0    [1    /1   ]  1.94876917494        1
[INPUT] 1    0    [1    /1   ]  0.701929029089       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478729581104, 1.0]], [0, [2712.096841601305, 1.0]], [0, [617.4982269437539, 1.0]], [0, [174.90815064730245, 1.0]], [0, [20.474254168569754, 1.0]], [0, [56.9679287740862, 1.0]], [0, [0.4947163501395076, 1.0]], [0, [7.85588254680333, 1.0]], [0, [1.6508643658773277, 1.0]], [1, [5.146134840660187, 1.0]], [1, [14.623447698441227, 1.0]], [1, [56.23065500517709, 1.0]], [1, [0.23558992746679064, 1.0]], [1, [1.948769174935991, 1.0]], [1, [0.7019290290890247, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872958]
bas 1, expnt(s) = [2712.0968416]
bas 2, expnt(s) = [617.49822694]
bas 3, expnt(s) = [174.90815065]
bas 4, expnt(s) = [20.47425417]
bas 5, expnt(s) = [56.96792877]
bas 6, expnt(s) = [0.49471635]
bas 7, expnt(s) = [7.85588255]
bas 8, expnt(s) = [1.65086437]
bas 9, expnt(s) = [5.14613484]
bas 10, expnt(s) = [14.6234477]
bas 11, expnt(s) = [56.23065501]
bas 12, expnt(s) = [0.23558993]
bas 13, expnt(s) = [1.94876917]
bas 14, expnt(s) = [0.70192903]
CPU time:       153.96
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209684e+03 9.49497704e+02
 6.17498227e+02 3.12962146e+02 1.74908151e+02 1.21512949e+02
 2.04742542e+01 2.43176214e+01 5.69679288e+01 5.23887271e+01
 4.94716350e-01 1.49032924e+00 7.85588255e+00 1.18552648e+01
 1.65086437e+00 3.67958271e+00 5.14613484e+00 2.26118369e+01
 1.46234477e+01 8.34250763e+01 5.62306550e+01 4.49211453e+02
 2.35589927e-01 4.78828829e-01 1.94876917e+00 6.71714765e+00
 7.01929029e-01 1.87435089e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999358744065399
cond(S) = 240.8606583516171
E1 = -183.5828307987342  E_coul = 55.08069166014267
init E= -128.502139138592
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774934712173903  LUMO = 0.695856583009802
  mo_energy =
[-3.25545363e+01 -1.85119756e+00 -7.74934712e-01 -7.74934712e-01
 -7.74934712e-01  6.95856583e-01  6.95856583e-01  6.95856583e-01
  2.08336325e+00  3.22164733e+00  3.22164733e+00  3.22164733e+00
  1.08794856e+01  1.08794856e+01  1.08794856e+01  1.95006072e+01
  3.51533542e+01  3.51533542e+01  3.51533542e+01  9.39744074e+01
  1.36110200e+02  1.36110200e+02  1.36110200e+02  3.56315484e+02
  1.34968371e+03  5.83612001e+03  3.50987238e+04]
E1 = -182.07408692887986  E_coul = 53.54259994076789
cycle= 1 E= -128.531486988112  delta_E= -0.0293  |g|= 0.205  |ddm|= 0.155
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.535395
diis-c [-0.28664786  1.        ]
  HOMO = -0.883686198514181  LUMO = 0.675000498233911
  mo_energy =
[-3.28801074e+01 -1.96597551e+00 -8.83686199e-01 -8.83686199e-01
 -8.83686199e-01  6.75000498e-01  6.75000498e-01  6.75000498e-01
  2.00490063e+00  3.14168739e+00  3.14168739e+00  3.14168739e+00
  1.07175419e+01  1.07175419e+01  1.07175419e+01  1.92770567e+01
  3.49024059e+01  3.49024059e+01  3.49024059e+01  9.36677354e+01
  1.35783275e+02  1.35783275e+02  1.35783275e+02  3.55960970e+02
  1.34929089e+03  5.83569530e+03  3.50982775e+04]
E1 = -182.8423240334123  E_coul = 54.308206297336994
cycle= 2 E= -128.534117736075  delta_E= -0.00263  |g|= 0.104  |ddm|= 0.0716
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.272027
diis-c [-5.95899544e-04  3.36237298e-01  6.63762702e-01]
  HOMO = -0.847739188529245  LUMO = 0.681938134209984
  mo_energy =
[-3.27712048e+01 -1.92802081e+00 -8.47739189e-01 -8.47739189e-01
 -8.47739189e-01  6.81938134e-01  6.81938134e-01  6.81938134e-01
  2.03059536e+00  3.16783810e+00  3.16783810e+00  3.16783810e+00
  1.07711775e+01  1.07711775e+01  1.07711775e+01  1.93520343e+01
  3.49864691e+01  3.49864691e+01  3.49864691e+01  9.37705695e+01
  1.35891908e+02  1.35891908e+02  1.35891908e+02  3.56076732e+02
  1.34941297e+03  5.83582036e+03  3.50984037e+04]
E1 = -182.582141444701  E_coul = 54.04709120841123
cycle= 3 E= -128.53505023629  delta_E= -0.000933  |g|= 0.000376  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000878244
diis-c [-8.11155869e-08 -1.94297319e-03 -7.70602184e-04  1.00271358e+00]
  HOMO = -0.847933845076642  LUMO = 0.681921516876417
  mo_energy =
[-3.27715868e+01 -1.92820041e+00 -8.47933845e-01 -8.47933845e-01
 -8.47933845e-01  6.81921517e-01  6.81921517e-01  6.81921517e-01
  2.03049579e+00  3.16773361e+00  3.16773361e+00  3.16773361e+00
  1.07709708e+01  1.07709708e+01  1.07709708e+01  1.93517839e+01
  3.49861733e+01  3.49861733e+01  3.49861733e+01  9.37702134e+01
  1.35891515e+02  1.35891515e+02  1.35891515e+02  3.56076272e+02
  1.34941239e+03  5.83581968e+03  3.50984029e+04]
E1 = -182.58245021946627  E_coul = 54.04739996982864
cycle= 4 E= -128.535050249638  delta_E= -1.33e-08  |g|= 6.19e-05  |ddm|= 0.000167
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000136746
diis-c [-5.22978445e-10  6.04885662e-05  3.58198738e-04 -9.72709184e-02
  1.09685223e+00]
  HOMO = -0.847965841466344  LUMO = 0.681912736300651
  mo_energy =
[-3.27716454e+01 -1.92823580e+00 -8.47965841e-01 -8.47965841e-01
 -8.47965841e-01  6.81912736e-01  6.81912736e-01  6.81912736e-01
  2.03046692e+00  3.16770592e+00  3.16770592e+00  3.16770592e+00
  1.07709270e+01  1.07709270e+01  1.07709270e+01  1.93517330e+01
  3.49861195e+01  3.49861195e+01  3.49861195e+01  9.37701560e+01
  1.35891456e+02  1.35891456e+02  1.35891456e+02  3.56076213e+02
  1.34941232e+03  5.83581962e+03  3.50984029e+04]
E1 = -182.58255153794642  E_coul = 54.04750128793571
cycle= 5 E= -128.535050250011  delta_E= -3.73e-10  |g|= 2.87e-06  |ddm|= 2.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58255153794642  E_coul = 54.04750128793571
  HOMO = -0.847965270025313  LUMO = 0.681912709606387
  mo_energy =
[-3.27716430e+01 -1.92823565e+00 -8.47965270e-01 -8.47965270e-01
 -8.47965270e-01  6.81912710e-01  6.81912710e-01  6.81912710e-01
  2.03046679e+00  3.16770612e+00  3.16770612e+00  3.16770612e+00
  1.07709279e+01  1.07709279e+01  1.07709279e+01  1.93517345e+01
  3.49861213e+01  3.49861213e+01  3.49861213e+01  9.37701582e+01
  1.35891459e+02  1.35891459e+02  1.35891459e+02  3.56076215e+02
  1.34941233e+03  5.83581962e+03  3.50984029e+04]
E1 = -182.58254220886883  E_coul = 54.04749195885638
Extra cycle  E= -128.535050250012  delta_E= -1.76e-12  |g|= 1.32e-06  |ddm|= 2.06e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.8606583516171
E1 = -182.58254220886883  E_coul = 54.04749195885638
init E= -128.535050250012
    CPU time for initialize scf      0.32 sec, wall time      0.31 sec
  HOMO = -0.847965942084193  LUMO = 0.681912555458403
  mo_energy =
[-3.27716448e+01 -1.92823647e+00 -8.47965942e-01 -8.47965942e-01
 -8.47965942e-01  6.81912555e-01  6.81912555e-01  6.81912555e-01
  2.03046620e+00  3.16770559e+00  3.16770559e+00  3.16770559e+00
  1.07709269e+01  1.07709269e+01  1.07709269e+01  1.93517331e+01
  3.49861198e+01  3.49861198e+01  3.49861198e+01  9.37701565e+01
  1.35891457e+02  1.35891457e+02  1.35891457e+02  3.56076213e+02
  1.34941233e+03  5.83581962e+03  3.50984029e+04]
E1 = -182.58254612948764  E_coul = 54.04749587947549
cycle= 1 E= -128.535050250012  delta_E= 3.13e-13  |g|= 5.46e-07  |ddm|= 6.14e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58254612948764  E_coul = 54.04749587947549
  HOMO = -0.847965666171822  LUMO = 0.681912604656523
  mo_energy =
[-3.27716440e+01 -1.92823620e+00 -8.47965666e-01 -8.47965666e-01
 -8.47965666e-01  6.81912605e-01  6.81912605e-01  6.81912605e-01
  2.03046637e+00  3.16770579e+00  3.16770579e+00  3.16770579e+00
  1.07709273e+01  1.07709273e+01  1.07709273e+01  1.93517337e+01
  3.49861205e+01  3.49861205e+01  3.49861205e+01  9.37701573e+01
  1.35891458e+02  1.35891458e+02  1.35891458e+02  3.56076214e+02
  1.34941233e+03  5.83581962e+03  3.50984029e+04]
E1 = -182.58254396434273  E_coul = 54.04749371433028
Extra cycle  E= -128.535050250012  delta_E= -3.13e-13  |g|= 2.94e-07  |ddm|= 1.9e-07
    CPU time for scf_cycle      0.39 sec, wall time      0.38 sec
exp = [1.80764787e+04 2.71209684e+03 6.17498227e+02 1.74908151e+02
 2.04742542e+01 5.69679288e+01 4.94716350e-01 7.85588255e+00
 1.65086437e+00 5.14613484e+00 1.46234477e+01 5.62306550e+01
 2.35589927e-01 1.94876917e+00 7.01929029e-01]
grad_E = [ 6.75737516e-10 -3.49270837e-08  6.91120806e-07 -7.53703558e-06
 -1.61221075e-04  4.97453824e-05  1.60900690e-02  2.33881492e-04
 -4.40633858e-03  1.80736656e-06 -3.08310325e-04 -1.44591038e-04
 -5.82486350e-04  1.88571759e-03 -1.98570406e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787289        1
[INPUT] 0    0    [1    /1   ]  2712.09687308        1
[INPUT] 0    0    [1    /1   ]  617.497697651        1
[INPUT] 0    0    [1    /1   ]  174.911647911        1
[INPUT] 0    0    [1    /1   ]  20.4556923195        1
[INPUT] 0    0    [1    /1   ]  56.9696805525        1
[INPUT] 0    0    [1    /1   ]  0.497417195502       1
[INPUT] 0    0    [1    /1   ]  7.89928688903        1
[INPUT] 0    0    [1    /1   ]  1.64966837917        1
[INPUT] 1    0    [1    /1   ]  5.33135441626        1
[INPUT] 1    0    [1    /1   ]  15.0421118413        1
[INPUT] 1    0    [1    /1   ]  58.3139770536        1
[INPUT] 1    0    [1    /1   ]  0.241721877118       1
[INPUT] 1    0    [1    /1   ]  2.0343671246         1
[INPUT] 1    0    [1    /1   ]  0.728882787585       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47872892311, 1.0]], [0, [2712.096873083118, 1.0]], [0, [617.4976976514841, 1.0]], [0, [174.91164791106274, 1.0]], [0, [20.455692319467378, 1.0]], [0, [56.96968055251045, 1.0]], [0, [0.49741719550229124, 1.0]], [0, [7.899286889028149, 1.0]], [0, [1.6496683791724303, 1.0]], [1, [5.3313544162625, 1.0]], [1, [15.042111841329566, 1.0]], [1, [58.31397705355962, 1.0]], [1, [0.24172187711752027, 1.0]], [1, [2.03436712459673, 1.0]], [1, [0.7288827875849515, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872892]
bas 1, expnt(s) = [2712.09687308]
bas 2, expnt(s) = [617.49769765]
bas 3, expnt(s) = [174.91164791]
bas 4, expnt(s) = [20.45569232]
bas 5, expnt(s) = [56.96968055]
bas 6, expnt(s) = [0.4974172]
bas 7, expnt(s) = [7.89928689]
bas 8, expnt(s) = [1.64966838]
bas 9, expnt(s) = [5.33135442]
bas 10, expnt(s) = [15.04211184]
bas 11, expnt(s) = [58.31397705]
bas 12, expnt(s) = [0.24172188]
bas 13, expnt(s) = [2.03436712]
bas 14, expnt(s) = [0.72888279]
CPU time:       157.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209687e+03 9.49497712e+02
 6.17497698e+02 3.12961944e+02 1.74911648e+02 1.21514771e+02
 2.04556923e+01 2.43010848e+01 5.69696806e+01 5.23899353e+01
 4.97417196e-01 1.49642729e+00 7.89928689e+00 1.19043569e+01
 1.64966838e+00 3.67758324e+00 5.33135442e+00 2.36336792e+01
 1.50421118e+01 8.64212233e+01 5.83139771e+01 4.70110790e+02
 2.41721877e-01 4.94457923e-01 2.03436712e+00 7.08795667e+00
 7.28882788e-01 1.96474644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999314694692027
cond(S) = 242.40607295298122
E1 = -183.5824339301663  E_coul = 55.080486752375016
init E= -128.501947177791
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.774984002732153  LUMO = 0.720708668108245
  mo_energy =
[-3.25545636e+01 -1.85119914e+00 -7.74984003e-01 -7.74984003e-01
 -7.74984003e-01  7.20708668e-01  7.20708668e-01  7.20708668e-01
  2.09229944e+00  3.35610270e+00  3.35610270e+00  3.35610270e+00
  1.13553332e+01  1.13553332e+01  1.13553332e+01  1.95688337e+01
  3.65314250e+01  3.65314250e+01  3.65314250e+01  9.40933893e+01
  1.41507554e+02  1.41507554e+02  1.41507554e+02  3.56428373e+02
  1.34979028e+03  5.83621622e+03  3.50988037e+04]
E1 = -182.08123109234805  E_coul = 53.54950509959116
cycle= 1 E= -128.531725992757  delta_E= -0.0298  |g|= 0.204  |ddm|= 0.155
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.531729
diis-c [-0.28273608  1.        ]
  HOMO = -0.88315792444098  LUMO = 0.69889683607667
  mo_energy =
[-3.28788322e+01 -1.96547625e+00 -8.83157924e-01 -8.83157924e-01
 -8.83157924e-01  6.98896836e-01  6.98896836e-01  6.98896836e-01
  2.01402702e+00  3.27362483e+00  3.27362483e+00  3.27362483e+00
  1.11908302e+01  1.11908302e+01  1.11908302e+01  1.93460961e+01
  3.62793777e+01  3.62793777e+01  3.62793777e+01  9.37879697e+01
  1.41180552e+02  1.41180552e+02  1.41180552e+02  3.56075235e+02
  1.34939888e+03  5.83579295e+03  3.50983588e+04]
E1 = -182.84510757008917  E_coul = 54.31077345401688
cycle= 2 E= -128.534334116072  delta_E= -0.00261  |g|= 0.104  |ddm|= 0.0718
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269967
diis-c [-5.94930407e-04  3.36064845e-01  6.63935155e-01]
  HOMO = -0.84741202159316  LUMO = 0.706146940013829
  mo_energy =
[-3.27704890e+01 -1.92773916e+00 -8.47412022e-01 -8.47412022e-01
 -8.47412022e-01  7.06146940e-01  7.06146940e-01  7.06146940e-01
  2.03962512e+00  3.30059917e+00  3.30059917e+00  3.30059917e+00
  1.12453027e+01  1.12453027e+01  1.12453027e+01  1.94207543e+01
  3.63637334e+01  3.63637334e+01  3.63637334e+01  9.38902767e+01
  1.41289032e+02  1.41289032e+02  1.41289032e+02  3.56190410e+02
  1.34952035e+03  5.83591738e+03  3.50984844e+04]
E1 = -182.5865473016402  E_coul = 54.051291266171525
cycle= 3 E= -128.535256035469  delta_E= -0.000922  |g|= 0.000376  |ddm|= 0.0245
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000836724
diis-c [-7.91073466e-08 -1.95858918e-03 -9.41723397e-04  1.00290031e+00]
  HOMO = -0.847605278752864  LUMO = 0.706128633146864
  mo_energy =
[-3.27708688e+01 -1.92792723e+00 -8.47605279e-01 -8.47605279e-01
 -8.47605279e-01  7.06128633e-01  7.06128633e-01  7.06128633e-01
  2.03951800e+00  3.30049007e+00  3.30049007e+00  3.30049007e+00
  1.12450915e+01  1.12450915e+01  1.12450915e+01  1.94205020e+01
  3.63634351e+01  3.63634351e+01  3.63634351e+01  9.38899226e+01
  1.41288639e+02  1.41288639e+02  1.41288639e+02  3.56189957e+02
  1.34951978e+03  5.83591672e+03  3.50984837e+04]
E1 = -182.58684418770486  E_coul = 54.05158813846869
cycle= 4 E= -128.535256049236  delta_E= -1.38e-08  |g|= 6.03e-05  |ddm|= 0.000175
    CPU time for cycle= 4      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000121165
diis-c [-6.57419056e-10  6.50148475e-05  3.15250057e-04 -9.78737464e-02
  1.09749348e+00]
  HOMO = -0.847635919786946  LUMO = 0.706119671327335
  mo_energy =
[-3.27709240e+01 -1.92796325e+00 -8.47635920e-01 -8.47635920e-01
 -8.47635920e-01  7.06119671e-01  7.06119671e-01  7.06119671e-01
  2.03948841e+00  3.30046247e+00  3.30046247e+00  3.30046247e+00
  1.12450488e+01  1.12450488e+01  1.12450488e+01  1.94204528e+01
  3.63633836e+01  3.63633836e+01  3.63633836e+01  9.38898684e+01
  1.41288585e+02  1.41288585e+02  1.41288585e+02  3.56189902e+02
  1.34951973e+03  5.83591667e+03  3.50984836e+04]
E1 = -182.58693492164585  E_coul = 54.05167887203893
cycle= 5 E= -128.535256049607  delta_E= -3.71e-10  |g|= 3.7e-06  |ddm|= 3.15e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58693492164585  E_coul = 54.05167887203893
  HOMO = -0.847635012860056  LUMO = 0.706119708678938
  mo_energy =
[-3.27709206e+01 -1.92796298e+00 -8.47635013e-01 -8.47635013e-01
 -8.47635013e-01  7.06119709e-01  7.06119709e-01  7.06119709e-01
  2.03948834e+00  3.30046293e+00  3.30046293e+00  3.30046293e+00
  1.12450502e+01  1.12450502e+01  1.12450502e+01  1.94204548e+01
  3.63633861e+01  3.63633861e+01  3.63633861e+01  9.38898716e+01
  1.41288588e+02  1.41288588e+02  1.41288588e+02  3.56189906e+02
  1.34951973e+03  5.83591667e+03  3.50984836e+04]
E1 = -182.58692311045883  E_coul = 54.05166706084973
Extra cycle  E= -128.535256049609  delta_E= -2.19e-12  |g|= 1.7e-06  |ddm|= 2.39e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [1.80764787e+04 2.71209687e+03 6.17497698e+02 1.74911648e+02
 2.04556923e+01 5.69696806e+01 4.97417196e-01 7.89928689e+00
 1.64966838e+00 5.33135442e+00 1.50421118e+01 5.83139771e+01
 2.41721877e-01 2.03436712e+00 7.28882788e-01]
E = -128.5352560496091
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787289        1
[INPUT] 0    0    [1    /1   ]  2712.09687308        1
[INPUT] 0    0    [1    /1   ]  617.497697651        1
[INPUT] 0    0    [1    /1   ]  174.911647911        1
[INPUT] 0    0    [1    /1   ]  20.4556923195        1
[INPUT] 0    0    [1    /1   ]  56.9696805525        1
[INPUT] 0    0    [1    /1   ]  0.497417195502       1
[INPUT] 0    0    [1    /1   ]  7.89928688903        1
[INPUT] 0    0    [1    /1   ]  1.64966837917        1
[INPUT] 1    0    [1    /1   ]  5.33135441626        1
[INPUT] 1    0    [1    /1   ]  15.0421118413        1
[INPUT] 1    0    [1    /1   ]  58.3139770536        1
[INPUT] 1    0    [1    /1   ]  0.241721877118       1
[INPUT] 1    0    [1    /1   ]  2.0343671246         1
[INPUT] 1    0    [1    /1   ]  0.728882787585       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47872892311, 1.0]], [0, [2712.096873083118, 1.0]], [0, [617.4976976514841, 1.0]], [0, [174.91164791106274, 1.0]], [0, [20.455692319467378, 1.0]], [0, [56.96968055251045, 1.0]], [0, [0.49741719550229124, 1.0]], [0, [7.899286889028149, 1.0]], [0, [1.6496683791724303, 1.0]], [1, [5.3313544162625, 1.0]], [1, [15.042111841329566, 1.0]], [1, [58.31397705355962, 1.0]], [1, [0.24172187711752027, 1.0]], [1, [2.03436712459673, 1.0]], [1, [0.7288827875849515, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872892]
bas 1, expnt(s) = [2712.09687308]
bas 2, expnt(s) = [617.49769765]
bas 3, expnt(s) = [174.91164791]
bas 4, expnt(s) = [20.45569232]
bas 5, expnt(s) = [56.96968055]
bas 6, expnt(s) = [0.4974172]
bas 7, expnt(s) = [7.89928689]
bas 8, expnt(s) = [1.64966838]
bas 9, expnt(s) = [5.33135442]
bas 10, expnt(s) = [15.04211184]
bas 11, expnt(s) = [58.31397705]
bas 12, expnt(s) = [0.24172188]
bas 13, expnt(s) = [2.03436712]
bas 14, expnt(s) = [0.72888279]
CPU time:       158.02
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209687e+03 9.49497712e+02
 6.17497698e+02 3.12961944e+02 1.74911648e+02 1.21514771e+02
 2.04556923e+01 2.43010848e+01 5.69696806e+01 5.23899353e+01
 4.97417196e-01 1.49642729e+00 7.89928689e+00 1.19043569e+01
 1.64966838e+00 3.67758324e+00 5.33135442e+00 2.36336792e+01
 1.50421118e+01 8.64212233e+01 5.83139771e+01 4.70110790e+02
 2.41721877e-01 4.94457923e-01 2.03436712e+00 7.08795667e+00
 7.28882788e-01 1.96474644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999314694692027
cond(S) = 242.40607295298122
E1 = -183.5824339301663  E_coul = 55.080486752375016
init E= -128.501947177791
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.774984002732153  LUMO = 0.720708668108245
  mo_energy =
[-3.25545636e+01 -1.85119914e+00 -7.74984003e-01 -7.74984003e-01
 -7.74984003e-01  7.20708668e-01  7.20708668e-01  7.20708668e-01
  2.09229944e+00  3.35610270e+00  3.35610270e+00  3.35610270e+00
  1.13553332e+01  1.13553332e+01  1.13553332e+01  1.95688337e+01
  3.65314250e+01  3.65314250e+01  3.65314250e+01  9.40933893e+01
  1.41507554e+02  1.41507554e+02  1.41507554e+02  3.56428373e+02
  1.34979028e+03  5.83621622e+03  3.50988037e+04]
E1 = -182.08123109234805  E_coul = 53.54950509959116
cycle= 1 E= -128.531725992757  delta_E= -0.0298  |g|= 0.204  |ddm|= 0.155
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.531729
diis-c [-0.28273608  1.        ]
  HOMO = -0.88315792444098  LUMO = 0.69889683607667
  mo_energy =
[-3.28788322e+01 -1.96547625e+00 -8.83157924e-01 -8.83157924e-01
 -8.83157924e-01  6.98896836e-01  6.98896836e-01  6.98896836e-01
  2.01402702e+00  3.27362483e+00  3.27362483e+00  3.27362483e+00
  1.11908302e+01  1.11908302e+01  1.11908302e+01  1.93460961e+01
  3.62793777e+01  3.62793777e+01  3.62793777e+01  9.37879697e+01
  1.41180552e+02  1.41180552e+02  1.41180552e+02  3.56075235e+02
  1.34939888e+03  5.83579295e+03  3.50983588e+04]
E1 = -182.84510757008917  E_coul = 54.31077345401688
cycle= 2 E= -128.534334116072  delta_E= -0.00261  |g|= 0.104  |ddm|= 0.0718
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.269967
diis-c [-5.94930407e-04  3.36064845e-01  6.63935155e-01]
  HOMO = -0.84741202159316  LUMO = 0.706146940013829
  mo_energy =
[-3.27704890e+01 -1.92773916e+00 -8.47412022e-01 -8.47412022e-01
 -8.47412022e-01  7.06146940e-01  7.06146940e-01  7.06146940e-01
  2.03962512e+00  3.30059917e+00  3.30059917e+00  3.30059917e+00
  1.12453027e+01  1.12453027e+01  1.12453027e+01  1.94207543e+01
  3.63637334e+01  3.63637334e+01  3.63637334e+01  9.38902767e+01
  1.41289032e+02  1.41289032e+02  1.41289032e+02  3.56190410e+02
  1.34952035e+03  5.83591738e+03  3.50984844e+04]
E1 = -182.5865473016402  E_coul = 54.051291266171525
cycle= 3 E= -128.535256035469  delta_E= -0.000922  |g|= 0.000376  |ddm|= 0.0245
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000836724
diis-c [-7.91073466e-08 -1.95858918e-03 -9.41723397e-04  1.00290031e+00]
  HOMO = -0.847605278752864  LUMO = 0.706128633146864
  mo_energy =
[-3.27708688e+01 -1.92792723e+00 -8.47605279e-01 -8.47605279e-01
 -8.47605279e-01  7.06128633e-01  7.06128633e-01  7.06128633e-01
  2.03951800e+00  3.30049007e+00  3.30049007e+00  3.30049007e+00
  1.12450915e+01  1.12450915e+01  1.12450915e+01  1.94205020e+01
  3.63634351e+01  3.63634351e+01  3.63634351e+01  9.38899226e+01
  1.41288639e+02  1.41288639e+02  1.41288639e+02  3.56189957e+02
  1.34951978e+03  5.83591672e+03  3.50984837e+04]
E1 = -182.58684418770486  E_coul = 54.05158813846869
cycle= 4 E= -128.535256049236  delta_E= -1.38e-08  |g|= 6.03e-05  |ddm|= 0.000175
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000121165
diis-c [-6.57419056e-10  6.50148475e-05  3.15250057e-04 -9.78737464e-02
  1.09749348e+00]
  HOMO = -0.847635919786946  LUMO = 0.706119671327335
  mo_energy =
[-3.27709240e+01 -1.92796325e+00 -8.47635920e-01 -8.47635920e-01
 -8.47635920e-01  7.06119671e-01  7.06119671e-01  7.06119671e-01
  2.03948841e+00  3.30046247e+00  3.30046247e+00  3.30046247e+00
  1.12450488e+01  1.12450488e+01  1.12450488e+01  1.94204528e+01
  3.63633836e+01  3.63633836e+01  3.63633836e+01  9.38898684e+01
  1.41288585e+02  1.41288585e+02  1.41288585e+02  3.56189902e+02
  1.34951973e+03  5.83591667e+03  3.50984836e+04]
E1 = -182.58693492164585  E_coul = 54.05167887203893
cycle= 5 E= -128.535256049607  delta_E= -3.71e-10  |g|= 3.7e-06  |ddm|= 3.15e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58693492164585  E_coul = 54.05167887203893
  HOMO = -0.847635012860056  LUMO = 0.706119708678938
  mo_energy =
[-3.27709206e+01 -1.92796298e+00 -8.47635013e-01 -8.47635013e-01
 -8.47635013e-01  7.06119709e-01  7.06119709e-01  7.06119709e-01
  2.03948834e+00  3.30046293e+00  3.30046293e+00  3.30046293e+00
  1.12450502e+01  1.12450502e+01  1.12450502e+01  1.94204548e+01
  3.63633861e+01  3.63633861e+01  3.63633861e+01  9.38898716e+01
  1.41288588e+02  1.41288588e+02  1.41288588e+02  3.56189906e+02
  1.34951973e+03  5.83591667e+03  3.50984836e+04]
E1 = -182.58692311045883  E_coul = 54.05166706084973
Extra cycle  E= -128.535256049609  delta_E= -2.19e-12  |g|= 1.7e-06  |ddm|= 2.39e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 242.40607295298122
E1 = -182.58692311045883  E_coul = 54.05166706084973
init E= -128.535256049609
    CPU time for initialize scf      0.30 sec, wall time      0.29 sec
  HOMO = -0.847635852352779  LUMO = 0.706119511578959
  mo_energy =
[-3.27709229e+01 -1.92796402e+00 -8.47635852e-01 -8.47635852e-01
 -8.47635852e-01  7.06119512e-01  7.06119512e-01  7.06119512e-01
  2.03948759e+00  3.30046226e+00  3.30046226e+00  3.30046226e+00
  1.12450489e+01  1.12450489e+01  1.12450489e+01  1.94204531e+01
  3.63633842e+01  3.63633842e+01  3.63633842e+01  9.38898693e+01
  1.41288586e+02  1.41288586e+02  1.41288586e+02  3.56189903e+02
  1.34951973e+03  5.83591667e+03  3.50984836e+04]
E1 = -182.5869282214934  E_coul = 54.05167217188402
cycle= 1 E= -128.535256049609  delta_E= -2.56e-13  |g|= 7.07e-07  |ddm|= 7.98e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5869282214934  E_coul = 54.05167217188402
  HOMO = -0.84763549101445  LUMO = 0.706119580335646
  mo_energy =
[-3.27709218e+01 -1.92796367e+00 -8.47635491e-01 -8.47635491e-01
 -8.47635491e-01  7.06119580e-01  7.06119580e-01  7.06119580e-01
  2.03948782e+00  3.30046252e+00  3.30046252e+00  3.30046252e+00
  1.12450495e+01  1.12450495e+01  1.12450495e+01  1.94204538e+01
  3.63633850e+01  3.63633850e+01  3.63633850e+01  9.38898704e+01
  1.41288587e+02  1.41288587e+02  1.41288587e+02  3.56189905e+02
  1.34951973e+03  5.83591667e+03  3.50984836e+04]
E1 = -182.586925430026  E_coul = 54.051669380416456
Extra cycle  E= -128.53525604961  delta_E= -1.99e-13  |g|= 3.8e-07  |ddm|= 2.44e-07
    CPU time for scf_cycle      0.38 sec, wall time      0.37 sec
exp = [1.80764787e+04 2.71209687e+03 6.17497698e+02 1.74911648e+02
 2.04556923e+01 5.69696806e+01 4.97417196e-01 7.89928689e+00
 1.64966838e+00 5.33135442e+00 1.50421118e+01 5.83139771e+01
 2.41721877e-01 2.03436712e+00 7.28882788e-01]
grad_E = [ 1.52897922e-09 -7.95130217e-08  1.58297106e-06 -1.76836382e-05
 -4.16800683e-04  1.20637301e-04  2.15015469e-02  6.32070862e-04
 -5.84484058e-03 -2.71243376e-05 -3.80018721e-04 -1.11119091e-04
 -6.88893422e-04  2.56291855e-03 -2.59544235e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787278        1
[INPUT] 0    0    [1    /1   ]  2712.09692723        1
[INPUT] 0    0    [1    /1   ]  617.496787157        1
[INPUT] 0    0    [1    /1   ]  174.917670614        1
[INPUT] 0    0    [1    /1   ]  20.4244772772        1
[INPUT] 0    0    [1    /1   ]  56.9725644387        1
[INPUT] 0    0    [1    /1   ]  0.498256404859       1
[INPUT] 0    0    [1    /1   ]  7.97248795415        1
[INPUT] 0    0    [1    /1   ]  1.64853655754        1
[INPUT] 1    0    [1    /1   ]  5.60754519814        1
[INPUT] 1    0    [1    /1   ]  15.828687823         1
[INPUT] 1    0    [1    /1   ]  61.885237789         1
[INPUT] 1    0    [1    /1   ]  0.249723051605       1
[INPUT] 1    0    [1    /1   ]  2.14156444357        1
[INPUT] 1    0    [1    /1   ]  0.762149147871       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478727791546, 1.0]], [0, [2712.0969272262905, 1.0]], [0, [617.4967871574695, 1.0]], [0, [174.91767061437056, 1.0]], [0, [20.42447727717246, 1.0]], [0, [56.9725644386521, 1.0]], [0, [0.4982564048587765, 1.0]], [0, [7.972487954150139, 1.0]], [0, [1.6485365575374324, 1.0]], [1, [5.607545198135204, 1.0]], [1, [15.82868782295765, 1.0]], [1, [61.88523778901125, 1.0]], [1, [0.2497230516046757, 1.0]], [1, [2.1415644435683197, 1.0]], [1, [0.7621491478710565, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872779]
bas 1, expnt(s) = [2712.09692723]
bas 2, expnt(s) = [617.49678716]
bas 3, expnt(s) = [174.91767061]
bas 4, expnt(s) = [20.42447728]
bas 5, expnt(s) = [56.97256444]
bas 6, expnt(s) = [0.4982564]
bas 7, expnt(s) = [7.97248795]
bas 8, expnt(s) = [1.64853656]
bas 9, expnt(s) = [5.6075452]
bas 10, expnt(s) = [15.82868782]
bas 11, expnt(s) = [61.88523779]
bas 12, expnt(s) = [0.24972305]
bas 13, expnt(s) = [2.14156444]
bas 14, expnt(s) = [0.76214915]
CPU time:       161.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209693e+03 9.49497727e+02
 6.17496787e+02 3.12961598e+02 1.74917671e+02 1.21517909e+02
 2.04244773e+01 2.42732672e+01 5.69725644e+01 5.23919244e+01
 4.98256405e-01 1.49832040e+00 7.97248795e+00 1.19869979e+01
 1.64853656e+00 3.67569071e+00 5.60754520e+00 2.51738924e+01
 1.58286878e+01 9.21065541e+01 6.18852378e+01 5.06370297e+02
 2.49723052e-01 5.15000540e-01 2.14156444e+00 7.55785102e+00
 7.62149148e-01 2.07746805e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999264326875771
cond(S) = 244.859514977507
E1 = -183.5822698663277  E_coul = 55.080509740889255
init E= -128.501760125438
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775048846073221  LUMO = 0.752928855690886
  mo_energy =
[-3.25544696e+01 -1.85122612e+00 -7.75048846e-01 -7.75048846e-01
 -7.75048846e-01  7.52928856e-01  7.52928856e-01  7.52928856e-01
  2.09561192e+00  3.52727488e+00  3.52727488e+00  3.52727488e+00
  1.19909790e+01  1.19909790e+01  1.19909790e+01  1.96701247e+01
  3.86805504e+01  3.86805504e+01  3.86805504e+01  9.42827415e+01
  1.50733048e+02  1.50733048e+02  1.50733048e+02  3.56609592e+02
  1.34996223e+03  5.83637181e+03  3.50989329e+04]
E1 = -182.0881000819434  E_coul = 53.55601282073175
cycle= 1 E= -128.532087261212  delta_E= -0.0303  |g|= 0.204  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.527047
diis-c [-0.27777896  1.        ]
  HOMO = -0.882740279214677  LUMO = 0.729858360472055
  mo_energy =
[-3.28774601e+01 -1.96500317e+00 -8.82740279e-01 -8.82740279e-01
 -8.82740279e-01  7.29858360e-01  7.29858360e-01  7.29858360e-01
  2.01759986e+00  3.44150147e+00  3.44150147e+00  3.44150147e+00
  1.18225683e+01  1.18225683e+01  1.18225683e+01  1.94479206e+01
  3.84257346e+01  3.84257346e+01  3.84257346e+01  9.39785445e+01
  1.50405044e+02  1.50405044e+02  1.50405044e+02  3.56257856e+02
  1.34957233e+03  5.83595004e+03  3.50984896e+04]
E1 = -182.84773138278427  E_coul = 54.31305704595567
cycle= 2 E= -128.534674336829  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0721
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.267288
diis-c [-5.96306668e-04  3.35796854e-01  6.64203146e-01]
  HOMO = -0.84718618139555  LUMO = 0.737518907116867
  mo_energy =
[-3.27696406e+01 -1.92747364e+00 -8.47186181e-01 -8.47186181e-01
 -8.47186181e-01  7.37518907e-01  7.37518907e-01  7.37518907e-01
  2.04308729e+00  3.46954434e+00  3.46954434e+00  3.46954434e+00
  1.18783294e+01  1.18783294e+01  1.18783294e+01  1.95223453e+01
  3.85109419e+01  3.85109419e+01  3.85109419e+01  9.40803622e+01
  1.50513669e+02  1.50513669e+02  1.50513669e+02  3.56372479e+02
  1.34969323e+03  5.83607390e+03  3.50986146e+04]
E1 = -182.59079567182565  E_coul = 54.05520970762702
cycle= 3 E= -128.535585964199  delta_E= -0.000912  |g|= 0.000376  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000829668
diis-c [-7.40688347e-08 -1.97760911e-03 -9.70835881e-04  1.00294844e+00]
  HOMO = -0.84737835248385  LUMO = 0.737499511684345
  mo_energy =
[-3.27700207e+01 -1.92766259e+00 -8.47378352e-01 -8.47378352e-01
 -8.47378352e-01  7.37499512e-01  7.37499512e-01  7.37499512e-01
  2.04297930e+00  3.46943105e+00  3.46943105e+00  3.46943105e+00
  1.18781135e+01  1.18781135e+01  1.18781135e+01  1.95220922e+01
  3.85106394e+01  3.85106394e+01  3.85106394e+01  9.40800084e+01
  1.50513273e+02  1.50513273e+02  1.50513273e+02  3.56372027e+02
  1.34969266e+03  5.83607324e+03  3.50986139e+04]
E1 = -182.59110716474817  E_coul = 54.055521187327045
cycle= 4 E= -128.535585977421  delta_E= -1.32e-08  |g|= 5.84e-05  |ddm|= 0.000169
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000115551
diis-c [-6.38372349e-10  6.28376930e-05  3.02071312e-04 -9.39597592e-02
  1.09359485e+00]
  HOMO = -0.847407749099733  LUMO = 0.737490503896715
  mo_energy =
[-3.27700738e+01 -1.92769756e+00 -8.47407749e-01 -8.47407749e-01
 -8.47407749e-01  7.37490504e-01  7.37490504e-01  7.37490504e-01
  2.04295058e+00  3.46940374e+00  3.46940374e+00  3.46940374e+00
  1.18780718e+01  1.18780718e+01  1.18780718e+01  1.95220447e+01
  3.85105895e+01  3.85105895e+01  3.85105895e+01  9.40799563e+01
  1.50513220e+02  1.50513220e+02  1.50513220e+02  3.56371975e+02
  1.34969261e+03  5.83607318e+03  3.50986138e+04]
E1 = -182.5911955709354  E_coul = 54.05560959317371
cycle= 5 E= -128.535585977762  delta_E= -3.41e-10  |g|= 3.7e-06  |ddm|= 2.99e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5911955709354  E_coul = 54.05560959317371
  HOMO = -0.847406826240197  LUMO = 0.737490561428471
  mo_energy =
[-3.27700704e+01 -1.92769729e+00 -8.47406826e-01 -8.47406826e-01
 -8.47406826e-01  7.37490561e-01  7.37490561e-01  7.37490561e-01
  2.04295052e+00  3.46940426e+00  3.46940426e+00  3.46940426e+00
  1.18780733e+01  1.18780733e+01  1.18780733e+01  1.95220467e+01
  3.85105920e+01  3.85105920e+01  3.85105920e+01  9.40799594e+01
  1.50513223e+02  1.50513223e+02  1.50513223e+02  3.56371978e+02
  1.34969261e+03  5.83607319e+03  3.50986138e+04]
E1 = -182.59118395541284  E_coul = 54.055597977649285
Extra cycle  E= -128.535585977764  delta_E= -1.88e-12  |g|= 1.68e-06  |ddm|= 2.33e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209693e+03 6.17496787e+02 1.74917671e+02
 2.04244773e+01 5.69725644e+01 4.98256405e-01 7.97248795e+00
 1.64853656e+00 5.60754520e+00 1.58286878e+01 6.18852378e+01
 2.49723052e-01 2.14156444e+00 7.62149148e-01]
E = -128.53558597776356
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787278        1
[INPUT] 0    0    [1    /1   ]  2712.09692723        1
[INPUT] 0    0    [1    /1   ]  617.496787157        1
[INPUT] 0    0    [1    /1   ]  174.917670614        1
[INPUT] 0    0    [1    /1   ]  20.4244772772        1
[INPUT] 0    0    [1    /1   ]  56.9725644387        1
[INPUT] 0    0    [1    /1   ]  0.498256404859       1
[INPUT] 0    0    [1    /1   ]  7.97248795415        1
[INPUT] 0    0    [1    /1   ]  1.64853655754        1
[INPUT] 1    0    [1    /1   ]  5.60754519814        1
[INPUT] 1    0    [1    /1   ]  15.828687823         1
[INPUT] 1    0    [1    /1   ]  61.885237789         1
[INPUT] 1    0    [1    /1   ]  0.249723051605       1
[INPUT] 1    0    [1    /1   ]  2.14156444357        1
[INPUT] 1    0    [1    /1   ]  0.762149147871       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478727791546, 1.0]], [0, [2712.0969272262905, 1.0]], [0, [617.4967871574695, 1.0]], [0, [174.91767061437056, 1.0]], [0, [20.42447727717246, 1.0]], [0, [56.9725644386521, 1.0]], [0, [0.4982564048587765, 1.0]], [0, [7.972487954150139, 1.0]], [0, [1.6485365575374324, 1.0]], [1, [5.607545198135204, 1.0]], [1, [15.82868782295765, 1.0]], [1, [61.88523778901125, 1.0]], [1, [0.2497230516046757, 1.0]], [1, [2.1415644435683197, 1.0]], [1, [0.7621491478710565, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872779]
bas 1, expnt(s) = [2712.09692723]
bas 2, expnt(s) = [617.49678716]
bas 3, expnt(s) = [174.91767061]
bas 4, expnt(s) = [20.42447728]
bas 5, expnt(s) = [56.97256444]
bas 6, expnt(s) = [0.4982564]
bas 7, expnt(s) = [7.97248795]
bas 8, expnt(s) = [1.64853656]
bas 9, expnt(s) = [5.6075452]
bas 10, expnt(s) = [15.82868782]
bas 11, expnt(s) = [61.88523779]
bas 12, expnt(s) = [0.24972305]
bas 13, expnt(s) = [2.14156444]
bas 14, expnt(s) = [0.76214915]
CPU time:       162.10
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209693e+03 9.49497727e+02
 6.17496787e+02 3.12961598e+02 1.74917671e+02 1.21517909e+02
 2.04244773e+01 2.42732672e+01 5.69725644e+01 5.23919244e+01
 4.98256405e-01 1.49832040e+00 7.97248795e+00 1.19869979e+01
 1.64853656e+00 3.67569071e+00 5.60754520e+00 2.51738924e+01
 1.58286878e+01 9.21065541e+01 6.18852378e+01 5.06370297e+02
 2.49723052e-01 5.15000540e-01 2.14156444e+00 7.55785102e+00
 7.62149148e-01 2.07746805e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999264326875771
cond(S) = 244.859514977507
E1 = -183.5822698663277  E_coul = 55.080509740889255
init E= -128.501760125438
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775048846073221  LUMO = 0.752928855690886
  mo_energy =
[-3.25544696e+01 -1.85122612e+00 -7.75048846e-01 -7.75048846e-01
 -7.75048846e-01  7.52928856e-01  7.52928856e-01  7.52928856e-01
  2.09561192e+00  3.52727488e+00  3.52727488e+00  3.52727488e+00
  1.19909790e+01  1.19909790e+01  1.19909790e+01  1.96701247e+01
  3.86805504e+01  3.86805504e+01  3.86805504e+01  9.42827415e+01
  1.50733048e+02  1.50733048e+02  1.50733048e+02  3.56609592e+02
  1.34996223e+03  5.83637181e+03  3.50989329e+04]
E1 = -182.0881000819434  E_coul = 53.55601282073175
cycle= 1 E= -128.532087261212  delta_E= -0.0303  |g|= 0.204  |ddm|= 0.156
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.527047
diis-c [-0.27777896  1.        ]
  HOMO = -0.882740279214677  LUMO = 0.729858360472055
  mo_energy =
[-3.28774601e+01 -1.96500317e+00 -8.82740279e-01 -8.82740279e-01
 -8.82740279e-01  7.29858360e-01  7.29858360e-01  7.29858360e-01
  2.01759986e+00  3.44150147e+00  3.44150147e+00  3.44150147e+00
  1.18225683e+01  1.18225683e+01  1.18225683e+01  1.94479206e+01
  3.84257346e+01  3.84257346e+01  3.84257346e+01  9.39785445e+01
  1.50405044e+02  1.50405044e+02  1.50405044e+02  3.56257856e+02
  1.34957233e+03  5.83595004e+03  3.50984896e+04]
E1 = -182.84773138278427  E_coul = 54.31305704595567
cycle= 2 E= -128.534674336829  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0721
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.267288
diis-c [-5.96306668e-04  3.35796854e-01  6.64203146e-01]
  HOMO = -0.84718618139555  LUMO = 0.737518907116867
  mo_energy =
[-3.27696406e+01 -1.92747364e+00 -8.47186181e-01 -8.47186181e-01
 -8.47186181e-01  7.37518907e-01  7.37518907e-01  7.37518907e-01
  2.04308729e+00  3.46954434e+00  3.46954434e+00  3.46954434e+00
  1.18783294e+01  1.18783294e+01  1.18783294e+01  1.95223453e+01
  3.85109419e+01  3.85109419e+01  3.85109419e+01  9.40803622e+01
  1.50513669e+02  1.50513669e+02  1.50513669e+02  3.56372479e+02
  1.34969323e+03  5.83607390e+03  3.50986146e+04]
E1 = -182.59079567182565  E_coul = 54.05520970762702
cycle= 3 E= -128.535585964199  delta_E= -0.000912  |g|= 0.000376  |ddm|= 0.0246
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000829668
diis-c [-7.40688347e-08 -1.97760911e-03 -9.70835881e-04  1.00294844e+00]
  HOMO = -0.84737835248385  LUMO = 0.737499511684345
  mo_energy =
[-3.27700207e+01 -1.92766259e+00 -8.47378352e-01 -8.47378352e-01
 -8.47378352e-01  7.37499512e-01  7.37499512e-01  7.37499512e-01
  2.04297930e+00  3.46943105e+00  3.46943105e+00  3.46943105e+00
  1.18781135e+01  1.18781135e+01  1.18781135e+01  1.95220922e+01
  3.85106394e+01  3.85106394e+01  3.85106394e+01  9.40800084e+01
  1.50513273e+02  1.50513273e+02  1.50513273e+02  3.56372027e+02
  1.34969266e+03  5.83607324e+03  3.50986139e+04]
E1 = -182.59110716474817  E_coul = 54.055521187327045
cycle= 4 E= -128.535585977421  delta_E= -1.32e-08  |g|= 5.84e-05  |ddm|= 0.000169
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000115551
diis-c [-6.38372349e-10  6.28376930e-05  3.02071312e-04 -9.39597592e-02
  1.09359485e+00]
  HOMO = -0.847407749099733  LUMO = 0.737490503896715
  mo_energy =
[-3.27700738e+01 -1.92769756e+00 -8.47407749e-01 -8.47407749e-01
 -8.47407749e-01  7.37490504e-01  7.37490504e-01  7.37490504e-01
  2.04295058e+00  3.46940374e+00  3.46940374e+00  3.46940374e+00
  1.18780718e+01  1.18780718e+01  1.18780718e+01  1.95220447e+01
  3.85105895e+01  3.85105895e+01  3.85105895e+01  9.40799563e+01
  1.50513220e+02  1.50513220e+02  1.50513220e+02  3.56371975e+02
  1.34969261e+03  5.83607318e+03  3.50986138e+04]
E1 = -182.5911955709354  E_coul = 54.05560959317371
cycle= 5 E= -128.535585977762  delta_E= -3.41e-10  |g|= 3.7e-06  |ddm|= 2.99e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5911955709354  E_coul = 54.05560959317371
  HOMO = -0.847406826240197  LUMO = 0.737490561428471
  mo_energy =
[-3.27700704e+01 -1.92769729e+00 -8.47406826e-01 -8.47406826e-01
 -8.47406826e-01  7.37490561e-01  7.37490561e-01  7.37490561e-01
  2.04295052e+00  3.46940426e+00  3.46940426e+00  3.46940426e+00
  1.18780733e+01  1.18780733e+01  1.18780733e+01  1.95220467e+01
  3.85105920e+01  3.85105920e+01  3.85105920e+01  9.40799594e+01
  1.50513223e+02  1.50513223e+02  1.50513223e+02  3.56371978e+02
  1.34969261e+03  5.83607319e+03  3.50986138e+04]
E1 = -182.59118395541284  E_coul = 54.055597977649285
Extra cycle  E= -128.535585977764  delta_E= -1.88e-12  |g|= 1.68e-06  |ddm|= 2.33e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 244.859514977507
E1 = -182.59118395541284  E_coul = 54.055597977649285
init E= -128.535585977764
    CPU time for initialize scf      0.30 sec, wall time      0.29 sec
  HOMO = -0.847407648793801  LUMO = 0.737490358510073
  mo_energy =
[-3.27700727e+01 -1.92769831e+00 -8.47407649e-01 -8.47407649e-01
 -8.47407649e-01  7.37490359e-01  7.37490359e-01  7.37490359e-01
  2.04294978e+00  3.46940357e+00  3.46940357e+00  3.46940357e+00
  1.18780720e+01  1.18780720e+01  1.18780720e+01  1.95220450e+01
  3.85105901e+01  3.85105901e+01  3.85105901e+01  9.40799572e+01
  1.50513221e+02  1.50513221e+02  1.50513221e+02  3.56371976e+02
  1.34969261e+03  5.83607318e+03  3.50986138e+04]
E1 = -182.59118901691573  E_coul = 54.05560303915157
cycle= 1 E= -128.535585977764  delta_E= -5.97e-13  |g|= 7e-07  |ddm|= 7.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59118901691573  E_coul = 54.05560303915157
  HOMO = -0.847407290477065  LUMO = 0.737490431410108
  mo_energy =
[-3.27700716e+01 -1.92769797e+00 -8.47407290e-01 -8.47407290e-01
 -8.47407290e-01  7.37490431e-01  7.37490431e-01  7.37490431e-01
  2.04295001e+00  3.46940385e+00  3.46940385e+00  3.46940385e+00
  1.18780725e+01  1.18780725e+01  1.18780725e+01  1.95220457e+01
  3.85105910e+01  3.85105910e+01  3.85105910e+01  9.40799583e+01
  1.50513222e+02  1.50513222e+02  1.50513222e+02  3.56371977e+02
  1.34969261e+03  5.83607319e+03  3.50986138e+04]
E1 = -182.59118626569924  E_coul = 54.055600287935306
Extra cycle  E= -128.535585977764  delta_E= 2.27e-13  |g|= 3.74e-07  |ddm|= 2.42e-07
    CPU time for scf_cycle      0.38 sec, wall time      0.37 sec
exp = [1.80764787e+04 2.71209693e+03 6.17496787e+02 1.74917671e+02
 2.04244773e+01 5.69725644e+01 4.98256405e-01 7.97248795e+00
 1.64853656e+00 5.60754520e+00 1.58286878e+01 6.18852378e+01
 2.49723052e-01 2.14156444e+00 7.62149148e-01]
grad_E = [ 2.98941898e-09 -1.55744084e-07  3.11103750e-06 -3.50466780e-05
 -8.61243041e-04  2.43033986e-04  2.26447107e-02  1.33403451e-03
 -6.15208559e-03 -1.19357255e-04 -3.74109845e-04 -7.92090528e-05
 -1.36900166e-04  3.11184731e-03 -3.07493148e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787264        1
[INPUT] 0    0    [1    /1   ]  2712.09699477        1
[INPUT] 0    0    [1    /1   ]  617.495650454        1
[INPUT] 0    0    [1    /1   ]  174.925216565        1
[INPUT] 0    0    [1    /1   ]  20.3871670195        1
[INPUT] 0    0    [1    /1   ]  56.9757033979        1
[INPUT] 0    0    [1    /1   ]  0.495664620621       1
[INPUT] 0    0    [1    /1   ]  8.0612579636         1
[INPUT] 0    0    [1    /1   ]  1.64857553519        1
[INPUT] 1    0    [1    /1   ]  5.85565127884        1
[INPUT] 1    0    [1    /1   ]  16.8283180413        1
[INPUT] 1    0    [1    /1   ]  66.3215249782        1
[INPUT] 1    0    [1    /1   ]  0.253972007705       1
[INPUT] 1    0    [1    /1   ]  2.20334189447        1
[INPUT] 1    0    [1    /1   ]  0.779024609357       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478726380523, 1.0]], [0, [2712.0969947663207, 1.0]], [0, [617.495650453867, 1.0]], [0, [174.92521656540802, 1.0]], [0, [20.387167019521506, 1.0]], [0, [56.97570339787186, 1.0]], [0, [0.49566462062139577, 1.0]], [0, [8.061257963599727, 1.0]], [0, [1.6485755351889326, 1.0]], [1, [5.855651278843577, 1.0]], [1, [16.828318041299642, 1.0]], [1, [66.32152497822727, 1.0]], [1, [0.25397200770511985, 1.0]], [1, [2.2033418944729872, 1.0]], [1, [0.7790246093568689, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872638]
bas 1, expnt(s) = [2712.09699477]
bas 2, expnt(s) = [617.49565045]
bas 3, expnt(s) = [174.92521657]
bas 4, expnt(s) = [20.38716702]
bas 5, expnt(s) = [56.9757034]
bas 6, expnt(s) = [0.49566462]
bas 7, expnt(s) = [8.06125796]
bas 8, expnt(s) = [1.64857554]
bas 9, expnt(s) = [5.85565128]
bas 10, expnt(s) = [16.82831804]
bas 11, expnt(s) = [66.32152498]
bas 12, expnt(s) = [0.25397201]
bas 13, expnt(s) = [2.20334189]
bas 14, expnt(s) = [0.77902461]
CPU time:       165.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209699e+03 9.49497744e+02
 6.17495650e+02 3.12961166e+02 1.74925217e+02 1.21521841e+02
 2.03871670e+01 2.42400039e+01 5.69757034e+01 5.23940893e+01
 4.95664621e-01 1.49247122e+00 8.06125796e+00 1.20869615e+01
 1.64857554e+00 3.67575589e+00 5.85565128e+00 2.65737839e+01
 1.68283180e+01 9.94340850e+01 6.63215250e+01 5.52144210e+02
 2.53972008e-01 5.25976944e-01 2.20334189e+00 7.83135223e+00
 7.79024609e-01 2.13512529e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999250299919463
cond(S) = 247.75313337128543
E1 = -183.58253943370187  E_coul = 55.08094254272311
init E= -128.501596890979
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775112105561337  LUMO = 0.770297961528685
  mo_energy =
[-3.25541943e+01 -1.85128367e+00 -7.75112106e-01 -7.75112106e-01
 -7.75112106e-01  7.70297962e-01  7.70297962e-01  7.70297962e-01
  2.08870670e+00  3.62274592e+00  3.62274592e+00  3.62274592e+00
  1.24273140e+01  1.24273140e+01  1.24273140e+01  1.97815933e+01
  4.07883664e+01  4.07883664e+01  4.07883664e+01  9.45040507e+01
  1.61757184e+02  1.61757184e+02  1.61757184e+02  3.56823454e+02
  1.35016605e+03  5.83655658e+03  3.50990864e+04]
E1 = -182.08933623530382  E_coul = 53.55685869279032
cycle= 1 E= -128.532477542514  delta_E= -0.0309  |g|= 0.204  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.523056
diis-c [-0.27358768  1.        ]
  HOMO = -0.882863755565833  LUMO = 0.746483577552326
  mo_energy =
[-3.28768847e+01 -1.96497629e+00 -8.82863756e-01 -8.82863756e-01
 -8.82863756e-01  7.46483578e-01  7.46483578e-01  7.46483578e-01
  2.01078497e+00  3.53472862e+00  3.53472862e+00  3.53472862e+00
  1.22551082e+01  1.22551082e+01  1.22551082e+01  1.95589280e+01
  4.05293010e+01  4.05293010e+01  4.05293010e+01  9.42001277e+01
  1.61426806e+02  1.61426806e+02  1.61426806e+02  3.56472165e+02
  1.34977673e+03  5.83613539e+03  3.50986438e+04]
E1 = -182.8482212388429  E_coul = 54.313160100760555
cycle= 2 E= -128.535061138082  delta_E= -0.00258  |g|= 0.103  |ddm|= 0.0722
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.265112
diis-c [-6.01288761e-04  3.35652181e-01  6.64347819e-01]
  HOMO = -0.84733945337731  LUMO = 0.754382045953051
  mo_energy =
[-3.27691372e+01 -1.92747824e+00 -8.47339453e-01 -8.47339453e-01
 -8.47339453e-01  7.54382046e-01  7.54382046e-01  7.54382046e-01
  2.03624269e+00  3.56348143e+00  3.56348143e+00  3.56348143e+00
  1.23121423e+01  1.23121423e+01  1.23121423e+01  1.96334813e+01
  4.06159156e+01  4.06159156e+01  4.06159156e+01  9.43018880e+01
  1.61536144e+02  1.61536144e+02  1.61536144e+02  3.56586706e+02
  1.34989754e+03  5.83625915e+03  3.50987687e+04]
E1 = -182.59159955906918  E_coul = 54.05562856879696
cycle= 3 E= -128.535970990272  delta_E= -0.00091  |g|= 0.000375  |ddm|= 0.0247
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000875025
diis-c [-6.87350526e-08 -1.99347167e-03 -7.84853982e-04  1.00277833e+00]
  HOMO = -0.847532311521887  LUMO = 0.754363171949393
  mo_energy =
[-3.27695206e+01 -1.92765634e+00 -8.47532312e-01 -8.47532312e-01
 -8.47532312e-01  7.54363172e-01  7.54363172e-01  7.54363172e-01
  2.03614408e+00  3.56336685e+00  3.56336685e+00  3.56336685e+00
  1.23119239e+01  1.23119239e+01  1.23119239e+01  1.96332293e+01
  4.06156079e+01  4.06156079e+01  4.06156079e+01  9.43015323e+01
  1.61535739e+02  1.61535739e+02  1.61535739e+02  3.56586246e+02
  1.34989696e+03  5.83625847e+03  3.50987679e+04]
E1 = -182.5919496270087  E_coul = 54.05597862492785
cycle= 4 E= -128.535971002081  delta_E= -1.18e-08  |g|= 5.78e-05  |ddm|= 0.000144
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000128889
diis-c [-4.05792259e-10  5.19592640e-05  3.46789260e-04 -8.64967136e-02
  1.08609797e+00]
  HOMO = -0.847561759373405  LUMO = 0.754354267409328
  mo_energy =
[-3.27695755e+01 -1.92768873e+00 -8.47561759e-01 -8.47561759e-01
 -8.47561759e-01  7.54354267e-01  7.54354267e-01  7.54354267e-01
  2.03611776e+00  3.56333954e+00  3.56333954e+00  3.56333954e+00
  1.23118818e+01  1.23118818e+01  1.23118818e+01  1.96331820e+01
  4.06155570e+01  4.06155570e+01  4.06155570e+01  9.43014787e+01
  1.61535684e+02  1.61535684e+02  1.61535684e+02  3.56586190e+02
  1.34989690e+03  5.83625841e+03  3.50987679e+04]
E1 = -182.5920494791885  E_coul = 54.05607847680983
cycle= 5 E= -128.535971002379  delta_E= -2.98e-10  |g|= 2.36e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5920494791885  E_coul = 54.05607847680983
  HOMO = -0.847561337781608  LUMO = 0.7543542449225
  mo_energy =
[-3.27695736e+01 -1.92768867e+00 -8.47561338e-01 -8.47561338e-01
 -8.47561338e-01  7.54354245e-01  7.54354245e-01  7.54354245e-01
  2.03611761e+00  3.56333972e+00  3.56333972e+00  3.56333972e+00
  1.23118826e+01  1.23118826e+01  1.23118826e+01  1.96331832e+01
  4.06155584e+01  4.06155584e+01  4.06155584e+01  9.43014805e+01
  1.61535686e+02  1.61535686e+02  1.61535686e+02  3.56586192e+02
  1.34989690e+03  5.83625842e+03  3.50987679e+04]
E1 = -182.59204205554113  E_coul = 54.05607105316137
Extra cycle  E= -128.53597100238  delta_E= -1.11e-12  |g|= 1.05e-06  |ddm|= 1.65e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209699e+03 6.17495650e+02 1.74925217e+02
 2.03871670e+01 5.69757034e+01 4.95664621e-01 8.06125796e+00
 1.64857554e+00 5.85565128e+00 1.68283180e+01 6.63215250e+01
 2.53972008e-01 2.20334189e+00 7.79024609e-01]
E = -128.53597100237977
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787264        1
[INPUT] 0    0    [1    /1   ]  2712.09699477        1
[INPUT] 0    0    [1    /1   ]  617.495650454        1
[INPUT] 0    0    [1    /1   ]  174.925216565        1
[INPUT] 0    0    [1    /1   ]  20.3871670195        1
[INPUT] 0    0    [1    /1   ]  56.9757033979        1
[INPUT] 0    0    [1    /1   ]  0.495664620621       1
[INPUT] 0    0    [1    /1   ]  8.0612579636         1
[INPUT] 0    0    [1    /1   ]  1.64857553519        1
[INPUT] 1    0    [1    /1   ]  5.85565127884        1
[INPUT] 1    0    [1    /1   ]  16.8283180413        1
[INPUT] 1    0    [1    /1   ]  66.3215249782        1
[INPUT] 1    0    [1    /1   ]  0.253972007705       1
[INPUT] 1    0    [1    /1   ]  2.20334189447        1
[INPUT] 1    0    [1    /1   ]  0.779024609357       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478726380523, 1.0]], [0, [2712.0969947663207, 1.0]], [0, [617.495650453867, 1.0]], [0, [174.92521656540802, 1.0]], [0, [20.387167019521506, 1.0]], [0, [56.97570339787186, 1.0]], [0, [0.49566462062139577, 1.0]], [0, [8.061257963599727, 1.0]], [0, [1.6485755351889326, 1.0]], [1, [5.855651278843577, 1.0]], [1, [16.828318041299642, 1.0]], [1, [66.32152497822727, 1.0]], [1, [0.25397200770511985, 1.0]], [1, [2.2033418944729872, 1.0]], [1, [0.7790246093568689, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872638]
bas 1, expnt(s) = [2712.09699477]
bas 2, expnt(s) = [617.49565045]
bas 3, expnt(s) = [174.92521657]
bas 4, expnt(s) = [20.38716702]
bas 5, expnt(s) = [56.9757034]
bas 6, expnt(s) = [0.49566462]
bas 7, expnt(s) = [8.06125796]
bas 8, expnt(s) = [1.64857554]
bas 9, expnt(s) = [5.85565128]
bas 10, expnt(s) = [16.82831804]
bas 11, expnt(s) = [66.32152498]
bas 12, expnt(s) = [0.25397201]
bas 13, expnt(s) = [2.20334189]
bas 14, expnt(s) = [0.77902461]
CPU time:       166.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209699e+03 9.49497744e+02
 6.17495650e+02 3.12961166e+02 1.74925217e+02 1.21521841e+02
 2.03871670e+01 2.42400039e+01 5.69757034e+01 5.23940893e+01
 4.95664621e-01 1.49247122e+00 8.06125796e+00 1.20869615e+01
 1.64857554e+00 3.67575589e+00 5.85565128e+00 2.65737839e+01
 1.68283180e+01 9.94340850e+01 6.63215250e+01 5.52144210e+02
 2.53972008e-01 5.25976944e-01 2.20334189e+00 7.83135223e+00
 7.79024609e-01 2.13512529e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999250299919463
cond(S) = 247.75313337128543
E1 = -183.58253943370187  E_coul = 55.08094254272311
init E= -128.501596890979
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775112105561337  LUMO = 0.770297961528685
  mo_energy =
[-3.25541943e+01 -1.85128367e+00 -7.75112106e-01 -7.75112106e-01
 -7.75112106e-01  7.70297962e-01  7.70297962e-01  7.70297962e-01
  2.08870670e+00  3.62274592e+00  3.62274592e+00  3.62274592e+00
  1.24273140e+01  1.24273140e+01  1.24273140e+01  1.97815933e+01
  4.07883664e+01  4.07883664e+01  4.07883664e+01  9.45040507e+01
  1.61757184e+02  1.61757184e+02  1.61757184e+02  3.56823454e+02
  1.35016605e+03  5.83655658e+03  3.50990864e+04]
E1 = -182.08933623530382  E_coul = 53.55685869279032
cycle= 1 E= -128.532477542514  delta_E= -0.0309  |g|= 0.204  |ddm|= 0.159
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.523056
diis-c [-0.27358768  1.        ]
  HOMO = -0.882863755565833  LUMO = 0.746483577552326
  mo_energy =
[-3.28768847e+01 -1.96497629e+00 -8.82863756e-01 -8.82863756e-01
 -8.82863756e-01  7.46483578e-01  7.46483578e-01  7.46483578e-01
  2.01078497e+00  3.53472862e+00  3.53472862e+00  3.53472862e+00
  1.22551082e+01  1.22551082e+01  1.22551082e+01  1.95589280e+01
  4.05293010e+01  4.05293010e+01  4.05293010e+01  9.42001277e+01
  1.61426806e+02  1.61426806e+02  1.61426806e+02  3.56472165e+02
  1.34977673e+03  5.83613539e+03  3.50986438e+04]
E1 = -182.8482212388429  E_coul = 54.313160100760555
cycle= 2 E= -128.535061138082  delta_E= -0.00258  |g|= 0.103  |ddm|= 0.0722
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.265112
diis-c [-6.01288761e-04  3.35652181e-01  6.64347819e-01]
  HOMO = -0.84733945337731  LUMO = 0.754382045953051
  mo_energy =
[-3.27691372e+01 -1.92747824e+00 -8.47339453e-01 -8.47339453e-01
 -8.47339453e-01  7.54382046e-01  7.54382046e-01  7.54382046e-01
  2.03624269e+00  3.56348143e+00  3.56348143e+00  3.56348143e+00
  1.23121423e+01  1.23121423e+01  1.23121423e+01  1.96334813e+01
  4.06159156e+01  4.06159156e+01  4.06159156e+01  9.43018880e+01
  1.61536144e+02  1.61536144e+02  1.61536144e+02  3.56586706e+02
  1.34989754e+03  5.83625915e+03  3.50987687e+04]
E1 = -182.59159955906918  E_coul = 54.05562856879696
cycle= 3 E= -128.535970990272  delta_E= -0.00091  |g|= 0.000375  |ddm|= 0.0247
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000875025
diis-c [-6.87350526e-08 -1.99347167e-03 -7.84853982e-04  1.00277833e+00]
  HOMO = -0.847532311521887  LUMO = 0.754363171949393
  mo_energy =
[-3.27695206e+01 -1.92765634e+00 -8.47532312e-01 -8.47532312e-01
 -8.47532312e-01  7.54363172e-01  7.54363172e-01  7.54363172e-01
  2.03614408e+00  3.56336685e+00  3.56336685e+00  3.56336685e+00
  1.23119239e+01  1.23119239e+01  1.23119239e+01  1.96332293e+01
  4.06156079e+01  4.06156079e+01  4.06156079e+01  9.43015323e+01
  1.61535739e+02  1.61535739e+02  1.61535739e+02  3.56586246e+02
  1.34989696e+03  5.83625847e+03  3.50987679e+04]
E1 = -182.5919496270087  E_coul = 54.05597862492785
cycle= 4 E= -128.535971002081  delta_E= -1.18e-08  |g|= 5.78e-05  |ddm|= 0.000144
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000128889
diis-c [-4.05792259e-10  5.19592640e-05  3.46789260e-04 -8.64967136e-02
  1.08609797e+00]
  HOMO = -0.847561759373405  LUMO = 0.754354267409328
  mo_energy =
[-3.27695755e+01 -1.92768873e+00 -8.47561759e-01 -8.47561759e-01
 -8.47561759e-01  7.54354267e-01  7.54354267e-01  7.54354267e-01
  2.03611776e+00  3.56333954e+00  3.56333954e+00  3.56333954e+00
  1.23118818e+01  1.23118818e+01  1.23118818e+01  1.96331820e+01
  4.06155570e+01  4.06155570e+01  4.06155570e+01  9.43014787e+01
  1.61535684e+02  1.61535684e+02  1.61535684e+02  3.56586190e+02
  1.34989690e+03  5.83625841e+03  3.50987679e+04]
E1 = -182.5920494791885  E_coul = 54.05607847680983
cycle= 5 E= -128.535971002379  delta_E= -2.98e-10  |g|= 2.36e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5920494791885  E_coul = 54.05607847680983
  HOMO = -0.847561337781608  LUMO = 0.7543542449225
  mo_energy =
[-3.27695736e+01 -1.92768867e+00 -8.47561338e-01 -8.47561338e-01
 -8.47561338e-01  7.54354245e-01  7.54354245e-01  7.54354245e-01
  2.03611761e+00  3.56333972e+00  3.56333972e+00  3.56333972e+00
  1.23118826e+01  1.23118826e+01  1.23118826e+01  1.96331832e+01
  4.06155584e+01  4.06155584e+01  4.06155584e+01  9.43014805e+01
  1.61535686e+02  1.61535686e+02  1.61535686e+02  3.56586192e+02
  1.34989690e+03  5.83625842e+03  3.50987679e+04]
E1 = -182.59204205554113  E_coul = 54.05607105316137
Extra cycle  E= -128.53597100238  delta_E= -1.11e-12  |g|= 1.05e-06  |ddm|= 1.65e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 247.75313337128543
E1 = -182.59204205554113  E_coul = 54.05607105316137
init E= -128.53597100238
    CPU time for initialize scf      0.31 sec, wall time      0.30 sec
  HOMO = -0.847561871743812  LUMO = 0.754354106373352
  mo_energy =
[-3.27695750e+01 -1.92768932e+00 -8.47561872e-01 -8.47561872e-01
 -8.47561872e-01  7.54354106e-01  7.54354106e-01  7.54354106e-01
  2.03611713e+00  3.56333926e+00  3.56333926e+00  3.56333926e+00
  1.23118817e+01  1.23118817e+01  1.23118817e+01  1.96331821e+01
  4.06155572e+01  4.06155572e+01  4.06155572e+01  9.43014791e+01
  1.61535685e+02  1.61535685e+02  1.61535685e+02  3.56586191e+02
  1.34989690e+03  5.83625842e+03  3.50987679e+04]
E1 = -182.59204518180985  E_coul = 54.05607417942969
cycle= 1 E= -128.53597100238  delta_E= -3.98e-13  |g|= 4.34e-07  |ddm|= 4.9e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59204518180985  E_coul = 54.05607417942969
  HOMO = -0.847561651412531  LUMO = 0.754354152222112
  mo_energy =
[-3.27695743e+01 -1.92768911e+00 -8.47561651e-01 -8.47561651e-01
 -8.47561651e-01  7.54354152e-01  7.54354152e-01  7.54354152e-01
  2.03611726e+00  3.56333943e+00  3.56333943e+00  3.56333943e+00
  1.23118821e+01  1.23118821e+01  1.23118821e+01  1.96331825e+01
  4.06155578e+01  4.06155578e+01  4.06155578e+01  9.43014797e+01
  1.61535685e+02  1.61535685e+02  1.61535685e+02  3.56586192e+02
  1.34989690e+03  5.83625842e+03  3.50987679e+04]
E1 = -182.59204346832652  E_coul = 54.056072465946265
Extra cycle  E= -128.53597100238  delta_E= -8.53e-14  |g|= 2.33e-07  |ddm|= 1.54e-07
    CPU time for scf_cycle      0.38 sec, wall time      0.37 sec
exp = [1.80764787e+04 2.71209699e+03 6.17495650e+02 1.74925217e+02
 2.03871670e+01 5.69757034e+01 4.95664621e-01 8.06125796e+00
 1.64857554e+00 5.85565128e+00 1.68283180e+01 6.63215250e+01
 2.53972008e-01 2.20334189e+00 7.79024609e-01]
grad_E = [ 4.76450699e-09 -2.48192263e-07  4.97146443e-06 -5.61077213e-05
 -1.40379836e-03  3.93361641e-04  1.60305549e-02  2.20005957e-03
 -4.36403583e-03 -2.05360932e-04 -2.87526529e-04 -5.97402658e-05
  5.71426409e-04  3.10893320e-03 -3.10108051e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787251        1
[INPUT] 0    0    [1    /1   ]  2712.0970541         1
[INPUT] 0    0    [1    /1   ]  617.494650208        1
[INPUT] 0    0    [1    /1   ]  174.931904138        1
[INPUT] 0    0    [1    /1   ]  20.3571221238        1
[INPUT] 0    0    [1    /1   ]  56.9776546935        1
[INPUT] 0    0    [1    /1   ]  0.491001439381       1
[INPUT] 0    0    [1    /1   ]  8.1351576474         1
[INPUT] 0    0    [1    /1   ]  1.64941867901        1
[INPUT] 1    0    [1    /1   ]  5.93531472648        1
[INPUT] 1    0    [1    /1   ]  17.6957609532        1
[INPUT] 1    0    [1    /1   ]  70.190191337         1
[INPUT] 1    0    [1    /1   ]  0.250474833707       1
[INPUT] 1    0    [1    /1   ]  2.16110739144        1
[INPUT] 1    0    [1    /1   ]  0.761610831018       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478725141907, 1.0]], [0, [2712.0970541000133, 1.0]], [0, [617.4946502084774, 1.0]], [0, [174.93190413829433, 1.0]], [0, [20.357122123821533, 1.0]], [0, [56.977654693476715, 1.0]], [0, [0.4910014393808782, 1.0]], [0, [8.135157647399625, 1.0]], [0, [1.6494186790131697, 1.0]], [1, [5.935314726480284, 1.0]], [1, [17.695760953163425, 1.0]], [1, [70.19019133696881, 1.0]], [1, [0.25047483370701984, 1.0]], [1, [2.161107391435056, 1.0]], [1, [0.7616108310178205, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872514]
bas 1, expnt(s) = [2712.0970541]
bas 2, expnt(s) = [617.49465021]
bas 3, expnt(s) = [174.93190414]
bas 4, expnt(s) = [20.35712212]
bas 5, expnt(s) = [56.97765469]
bas 6, expnt(s) = [0.49100144]
bas 7, expnt(s) = [8.13515765]
bas 8, expnt(s) = [1.64941868]
bas 9, expnt(s) = [5.93531473]
bas 10, expnt(s) = [17.69576095]
bas 11, expnt(s) = [70.19019134]
bas 12, expnt(s) = [0.25047483]
bas 13, expnt(s) = [2.16110739]
bas 14, expnt(s) = [0.76161083]
CPU time:       169.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209705e+03 9.49497760e+02
 6.17494650e+02 3.12960786e+02 1.74931904e+02 1.21525325e+02
 2.03571221e+01 2.42132068e+01 5.69776547e+01 5.23954351e+01
 4.91001439e-01 1.48192798e+00 8.13515765e+00 1.21699699e+01
 1.64941868e+00 3.67716574e+00 5.93531473e+00 2.70264550e+01
 1.76957610e+01 1.05881710e+02 7.01901913e+01 5.92693174e+02
 2.50474834e-01 5.16939256e-01 2.16110739e+00 7.64416105e+00
 7.61610831e-01 2.07563403e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999289857524902
cond(S) = 250.11573263566964
E1 = -183.58286778086855  E_coul = 55.0815546757278
init E= -128.501313105141
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775167878593617  LUMO = 0.756018597776151
  mo_energy =
[-3.25538470e+01 -1.85132552e+00 -7.75167879e-01 -7.75167879e-01
 -7.75167879e-01  7.56018598e-01  7.56018598e-01  7.56018598e-01
  2.07514700e+00  3.54875714e+00  3.54875714e+00  3.54875714e+00
  1.23186139e+01  1.23186139e+01  1.23186139e+01  1.98659281e+01
  4.17964597e+01  4.17964597e+01  4.17964597e+01  9.46828521e+01
  1.70629091e+02  1.70629091e+02  1.70629091e+02  3.56998218e+02
  1.35033345e+03  5.83670867e+03  3.50992128e+04]
E1 = -182.08354200089994  E_coul = 53.55079571595385
cycle= 1 E= -128.532746284946  delta_E= -0.0314  |g|= 0.204  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520984
diis-c [-0.2714245  1.       ]
  HOMO = -0.883556947079683  LUMO = 0.732676836854295
  mo_energy =
[-3.28774922e+01 -1.96547669e+00 -8.83556947e-01 -8.83556947e-01
 -8.83556947e-01  7.32676837e-01  7.32676837e-01  7.32676837e-01
  1.99702719e+00  3.46138579e+00  3.46138579e+00  3.46138579e+00
  1.21446751e+01  1.21446751e+01  1.21446751e+01  1.96418422e+01
  4.15329419e+01  4.15329419e+01  4.15329419e+01  9.43779912e+01
  1.70295503e+02  1.70295503e+02  1.70295503e+02  3.56646090e+02
  1.34994341e+03  5.83628676e+03  3.50987695e+04]
E1 = -182.84619539207935  E_coul = 54.3108475762402
cycle= 2 E= -128.535347815839  delta_E= -0.0026  |g|= 0.104  |ddm|= 0.0722
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264256
diis-c [-6.08729021e-04  3.35802073e-01  6.64197927e-01]
  HOMO = -0.84785806284296  LUMO = 0.740412153301493
  mo_energy =
[-3.27692648e+01 -1.92778828e+00 -8.47858063e-01 -8.47858063e-01
 -8.47858063e-01  7.40412153e-01  7.40412153e-01  7.40412153e-01
  2.02257643e+00  3.48990229e+00  3.48990229e+00  3.48990229e+00
  1.22023256e+01  1.22023256e+01  1.22023256e+01  1.97169007e+01
  4.16211221e+01  4.16211221e+01  4.16211221e+01  9.44802183e+01
  1.70405991e+02  1.70405991e+02  1.70405991e+02  3.56761127e+02
  1.35006472e+03  5.83641104e+03  3.50988949e+04]
E1 = -182.58813257882125  E_coul = 54.05186572522207
cycle= 3 E= -128.536266853599  delta_E= -0.000919  |g|= 0.000384  |ddm|= 0.0249
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000947486
diis-c [-7.62007295e-08 -2.01453825e-03 -5.39162602e-04  1.00255370e+00]
  HOMO = -0.848053608016602  LUMO = 0.740394909812278
  mo_energy =
[-3.27696531e+01 -1.92795051e+00 -8.48053608e-01 -8.48053608e-01
 -8.48053608e-01  7.40394910e-01  7.40394910e-01  7.40394910e-01
  2.02249143e+00  3.48979024e+00  3.48979024e+00  3.48979024e+00
  1.22021079e+01  1.22021079e+01  1.22021079e+01  1.97166507e+01
  4.16208095e+01  4.16208095e+01  4.16208095e+01  9.44798593e+01
  1.70405574e+02  1.70405574e+02  1.70405574e+02  3.56760655e+02
  1.35006412e+03  5.83641033e+03  3.50988942e+04]
E1 = -182.588516858752  E_coul = 54.052249993228884
cycle= 4 E= -128.536266865523  delta_E= -1.19e-08  |g|= 6.24e-05  |ddm|= 0.000129
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00015584
diis-c [-3.49471215e-10  7.38821606e-05  4.41665163e-04 -9.94771950e-02
  1.09896165e+00]
  HOMO = -0.848085218226248  LUMO = 0.740385977095273
  mo_energy =
[-3.27697140e+01 -1.92798115e+00 -8.48085218e-01 -8.48085218e-01
 -8.48085218e-01  7.40385977e-01  7.40385977e-01  7.40385977e-01
  2.02246690e+00  3.48976193e+00  3.48976193e+00  3.48976193e+00
  1.22020630e+01  1.22020630e+01  1.22020630e+01  1.97166008e+01
  4.16207540e+01  4.16207540e+01  4.16207540e+01  9.44798002e+01
  1.70405512e+02  1.70405512e+02  1.70405512e+02  3.56760591e+02
  1.35006405e+03  5.83641026e+03  3.50988941e+04]
E1 = -182.58863731229914  E_coul = 54.052370446440996
cycle= 5 E= -128.536266865858  delta_E= -3.35e-10  |g|= 1.42e-06  |ddm|= 1.89e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58863731229914  E_coul = 54.052370446440996
  HOMO = -0.848084885270121  LUMO = 0.740385994551913
  mo_energy =
[-3.27697128e+01 -1.92798072e+00 -8.48084885e-01 -8.48084885e-01
 -8.48084885e-01  7.40385995e-01  7.40385995e-01  7.40385995e-01
  2.02246713e+00  3.48976213e+00  3.48976213e+00  3.48976213e+00
  1.22020637e+01  1.22020637e+01  1.22020637e+01  1.97166018e+01
  4.16207551e+01  4.16207551e+01  4.16207551e+01  9.44798013e+01
  1.70405513e+02  1.70405513e+02  1.70405513e+02  3.56760592e+02
  1.35006405e+03  5.83641026e+03  3.50988941e+04]
E1 = -182.58863262044477  E_coul = 54.052365754586255
Extra cycle  E= -128.536266865859  delta_E= -3.69e-13  |g|= 6.09e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [1.80764787e+04 2.71209705e+03 6.17494650e+02 1.74931904e+02
 2.03571221e+01 5.69776547e+01 4.91001439e-01 8.13515765e+00
 1.64941868e+00 5.93531473e+00 1.76957610e+01 7.01901913e+01
 2.50474834e-01 2.16110739e+00 7.61610831e-01]
E = -128.53626686585852
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787251        1
[INPUT] 0    0    [1    /1   ]  2712.0970541         1
[INPUT] 0    0    [1    /1   ]  617.494650208        1
[INPUT] 0    0    [1    /1   ]  174.931904138        1
[INPUT] 0    0    [1    /1   ]  20.3571221238        1
[INPUT] 0    0    [1    /1   ]  56.9776546935        1
[INPUT] 0    0    [1    /1   ]  0.491001439381       1
[INPUT] 0    0    [1    /1   ]  8.1351576474         1
[INPUT] 0    0    [1    /1   ]  1.64941867901        1
[INPUT] 1    0    [1    /1   ]  5.93531472648        1
[INPUT] 1    0    [1    /1   ]  17.6957609532        1
[INPUT] 1    0    [1    /1   ]  70.190191337         1
[INPUT] 1    0    [1    /1   ]  0.250474833707       1
[INPUT] 1    0    [1    /1   ]  2.16110739144        1
[INPUT] 1    0    [1    /1   ]  0.761610831018       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478725141907, 1.0]], [0, [2712.0970541000133, 1.0]], [0, [617.4946502084774, 1.0]], [0, [174.93190413829433, 1.0]], [0, [20.357122123821533, 1.0]], [0, [56.977654693476715, 1.0]], [0, [0.4910014393808782, 1.0]], [0, [8.135157647399625, 1.0]], [0, [1.6494186790131697, 1.0]], [1, [5.935314726480284, 1.0]], [1, [17.695760953163425, 1.0]], [1, [70.19019133696881, 1.0]], [1, [0.25047483370701984, 1.0]], [1, [2.161107391435056, 1.0]], [1, [0.7616108310178205, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872514]
bas 1, expnt(s) = [2712.0970541]
bas 2, expnt(s) = [617.49465021]
bas 3, expnt(s) = [174.93190414]
bas 4, expnt(s) = [20.35712212]
bas 5, expnt(s) = [56.97765469]
bas 6, expnt(s) = [0.49100144]
bas 7, expnt(s) = [8.13515765]
bas 8, expnt(s) = [1.64941868]
bas 9, expnt(s) = [5.93531473]
bas 10, expnt(s) = [17.69576095]
bas 11, expnt(s) = [70.19019134]
bas 12, expnt(s) = [0.25047483]
bas 13, expnt(s) = [2.16110739]
bas 14, expnt(s) = [0.76161083]
CPU time:       170.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209705e+03 9.49497760e+02
 6.17494650e+02 3.12960786e+02 1.74931904e+02 1.21525325e+02
 2.03571221e+01 2.42132068e+01 5.69776547e+01 5.23954351e+01
 4.91001439e-01 1.48192798e+00 8.13515765e+00 1.21699699e+01
 1.64941868e+00 3.67716574e+00 5.93531473e+00 2.70264550e+01
 1.76957610e+01 1.05881710e+02 7.01901913e+01 5.92693174e+02
 2.50474834e-01 5.16939256e-01 2.16110739e+00 7.64416105e+00
 7.61610831e-01 2.07563403e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999289857524902
cond(S) = 250.11573263566964
E1 = -183.58286778086855  E_coul = 55.0815546757278
init E= -128.501313105141
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775167878593617  LUMO = 0.756018597776151
  mo_energy =
[-3.25538470e+01 -1.85132552e+00 -7.75167879e-01 -7.75167879e-01
 -7.75167879e-01  7.56018598e-01  7.56018598e-01  7.56018598e-01
  2.07514700e+00  3.54875714e+00  3.54875714e+00  3.54875714e+00
  1.23186139e+01  1.23186139e+01  1.23186139e+01  1.98659281e+01
  4.17964597e+01  4.17964597e+01  4.17964597e+01  9.46828521e+01
  1.70629091e+02  1.70629091e+02  1.70629091e+02  3.56998218e+02
  1.35033345e+03  5.83670867e+03  3.50992128e+04]
E1 = -182.08354200089994  E_coul = 53.55079571595385
cycle= 1 E= -128.532746284946  delta_E= -0.0314  |g|= 0.204  |ddm|= 0.162
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.520984
diis-c [-0.2714245  1.       ]
  HOMO = -0.883556947079683  LUMO = 0.732676836854295
  mo_energy =
[-3.28774922e+01 -1.96547669e+00 -8.83556947e-01 -8.83556947e-01
 -8.83556947e-01  7.32676837e-01  7.32676837e-01  7.32676837e-01
  1.99702719e+00  3.46138579e+00  3.46138579e+00  3.46138579e+00
  1.21446751e+01  1.21446751e+01  1.21446751e+01  1.96418422e+01
  4.15329419e+01  4.15329419e+01  4.15329419e+01  9.43779912e+01
  1.70295503e+02  1.70295503e+02  1.70295503e+02  3.56646090e+02
  1.34994341e+03  5.83628676e+03  3.50987695e+04]
E1 = -182.84619539207935  E_coul = 54.3108475762402
cycle= 2 E= -128.535347815839  delta_E= -0.0026  |g|= 0.104  |ddm|= 0.0722
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264256
diis-c [-6.08729021e-04  3.35802073e-01  6.64197927e-01]
  HOMO = -0.84785806284296  LUMO = 0.740412153301493
  mo_energy =
[-3.27692648e+01 -1.92778828e+00 -8.47858063e-01 -8.47858063e-01
 -8.47858063e-01  7.40412153e-01  7.40412153e-01  7.40412153e-01
  2.02257643e+00  3.48990229e+00  3.48990229e+00  3.48990229e+00
  1.22023256e+01  1.22023256e+01  1.22023256e+01  1.97169007e+01
  4.16211221e+01  4.16211221e+01  4.16211221e+01  9.44802183e+01
  1.70405991e+02  1.70405991e+02  1.70405991e+02  3.56761127e+02
  1.35006472e+03  5.83641104e+03  3.50988949e+04]
E1 = -182.58813257882125  E_coul = 54.05186572522207
cycle= 3 E= -128.536266853599  delta_E= -0.000919  |g|= 0.000384  |ddm|= 0.0249
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000947486
diis-c [-7.62007295e-08 -2.01453825e-03 -5.39162602e-04  1.00255370e+00]
  HOMO = -0.848053608016602  LUMO = 0.740394909812278
  mo_energy =
[-3.27696531e+01 -1.92795051e+00 -8.48053608e-01 -8.48053608e-01
 -8.48053608e-01  7.40394910e-01  7.40394910e-01  7.40394910e-01
  2.02249143e+00  3.48979024e+00  3.48979024e+00  3.48979024e+00
  1.22021079e+01  1.22021079e+01  1.22021079e+01  1.97166507e+01
  4.16208095e+01  4.16208095e+01  4.16208095e+01  9.44798593e+01
  1.70405574e+02  1.70405574e+02  1.70405574e+02  3.56760655e+02
  1.35006412e+03  5.83641033e+03  3.50988942e+04]
E1 = -182.588516858752  E_coul = 54.052249993228884
cycle= 4 E= -128.536266865523  delta_E= -1.19e-08  |g|= 6.24e-05  |ddm|= 0.000129
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00015584
diis-c [-3.49471215e-10  7.38821606e-05  4.41665163e-04 -9.94771950e-02
  1.09896165e+00]
  HOMO = -0.848085218226248  LUMO = 0.740385977095273
  mo_energy =
[-3.27697140e+01 -1.92798115e+00 -8.48085218e-01 -8.48085218e-01
 -8.48085218e-01  7.40385977e-01  7.40385977e-01  7.40385977e-01
  2.02246690e+00  3.48976193e+00  3.48976193e+00  3.48976193e+00
  1.22020630e+01  1.22020630e+01  1.22020630e+01  1.97166008e+01
  4.16207540e+01  4.16207540e+01  4.16207540e+01  9.44798002e+01
  1.70405512e+02  1.70405512e+02  1.70405512e+02  3.56760591e+02
  1.35006405e+03  5.83641026e+03  3.50988941e+04]
E1 = -182.58863731229914  E_coul = 54.052370446440996
cycle= 5 E= -128.536266865858  delta_E= -3.35e-10  |g|= 1.42e-06  |ddm|= 1.89e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58863731229914  E_coul = 54.052370446440996
  HOMO = -0.848084885270121  LUMO = 0.740385994551913
  mo_energy =
[-3.27697128e+01 -1.92798072e+00 -8.48084885e-01 -8.48084885e-01
 -8.48084885e-01  7.40385995e-01  7.40385995e-01  7.40385995e-01
  2.02246713e+00  3.48976213e+00  3.48976213e+00  3.48976213e+00
  1.22020637e+01  1.22020637e+01  1.22020637e+01  1.97166018e+01
  4.16207551e+01  4.16207551e+01  4.16207551e+01  9.44798013e+01
  1.70405513e+02  1.70405513e+02  1.70405513e+02  3.56760592e+02
  1.35006405e+03  5.83641026e+03  3.50988941e+04]
E1 = -182.58863262044477  E_coul = 54.052365754586255
Extra cycle  E= -128.536266865859  delta_E= -3.69e-13  |g|= 6.09e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 250.11573263566964
E1 = -182.58863262044477  E_coul = 54.052365754586255
init E= -128.536266865859
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.848085233333736  LUMO = 0.740385910122951
  mo_energy =
[-3.27697138e+01 -1.92798108e+00 -8.48085233e-01 -8.48085233e-01
 -8.48085233e-01  7.40385910e-01  7.40385910e-01  7.40385910e-01
  2.02246687e+00  3.48976184e+00  3.48976184e+00  3.48976184e+00
  1.22020631e+01  1.22020631e+01  1.22020631e+01  1.97166011e+01
  4.16207543e+01  4.16207543e+01  4.16207543e+01  9.44798005e+01
  1.70405512e+02  1.70405512e+02  1.70405512e+02  3.56760591e+02
  1.35006405e+03  5.83641026e+03  3.50988941e+04]
E1 = -182.5886347333247  E_coul = 54.052367867466145
cycle= 1 E= -128.536266865859  delta_E= -5.68e-14  |g|= 2.92e-07  |ddm|= 2.04e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5886347333247  E_coul = 54.052367867466145
  HOMO = -0.848085086255992  LUMO = 0.740385940871396
  mo_energy =
[-3.27697133e+01 -1.92798092e+00 -8.48085086e-01 -8.48085086e-01
 -8.48085086e-01  7.40385941e-01  7.40385941e-01  7.40385941e-01
  2.02246697e+00  3.48976196e+00  3.48976196e+00  3.48976196e+00
  1.22020634e+01  1.22020634e+01  1.22020634e+01  1.97166014e+01
  4.16207547e+01  4.16207547e+01  4.16207547e+01  9.44798009e+01
  1.70405513e+02  1.70405513e+02  1.70405513e+02  3.56760591e+02
  1.35006405e+03  5.83641026e+03  3.50988941e+04]
E1 = -182.58863361081004  E_coul = 54.05236674495148
Extra cycle  E= -128.536266865859  delta_E= 2.84e-14  |g|= 1.52e-07  |ddm|= 1.1e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.36 sec
exp = [1.80764787e+04 2.71209705e+03 6.17494650e+02 1.74931904e+02
 2.03571221e+01 5.69776547e+01 4.91001439e-01 8.13515765e+00
 1.64941868e+00 5.93531473e+00 1.76957610e+01 7.01901913e+01
 2.50474834e-01 2.16110739e+00 7.61610831e-01]
grad_E = [ 6.22740175e-09 -3.24196396e-07  6.50805698e-06 -7.34398005e-05
 -1.85189591e-03  5.18816135e-04  4.76727887e-03  2.92514287e-03
 -1.30891085e-03 -3.70747484e-05 -1.54797340e-04 -5.52431786e-05
  6.31488532e-04  1.40758721e-03 -1.49344634e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787248        1
[INPUT] 0    0    [1    /1   ]  2712.09706827        1
[INPUT] 0    0    [1    /1   ]  617.494409736        1
[INPUT] 0    0    [1    /1   ]  174.933558667        1
[INPUT] 0    0    [1    /1   ]  20.3530144111        1
[INPUT] 0    0    [1    /1   ]  56.9773009492        1
[INPUT] 0    0    [1    /1   ]  0.488545127339       1
[INPUT] 0    0    [1    /1   ]  8.14781684152        1
[INPUT] 0    0    [1    /1   ]  1.64911438167        1
[INPUT] 1    0    [1    /1   ]  5.87578163141        1
[INPUT] 1    0    [1    /1   ]  17.9221566671        1
[INPUT] 1    0    [1    /1   ]  71.0802540729        1
[INPUT] 1    0    [1    /1   ]  0.245162191011       1
[INPUT] 1    0    [1    /1   ]  2.09396766916        1
[INPUT] 1    0    [1    /1   ]  0.73796550721        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478724847006, 1.0]], [0, [2712.0970682682137, 1.0]], [0, [617.4944097364964, 1.0]], [0, [174.93355866697706, 1.0]], [0, [20.353014411104194, 1.0]], [0, [56.97730094918503, 1.0]], [0, [0.4885451273387926, 1.0]], [0, [8.147816841523152, 1.0]], [0, [1.6491143816746723, 1.0]], [1, [5.875781631413155, 1.0]], [1, [17.922156667074656, 1.0]], [1, [71.08025407292412, 1.0]], [1, [0.24516219101059797, 1.0]], [1, [2.0939676691562883, 1.0]], [1, [0.7379655072099294, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872485]
bas 1, expnt(s) = [2712.09706827]
bas 2, expnt(s) = [617.49440974]
bas 3, expnt(s) = [174.93355867]
bas 4, expnt(s) = [20.35301441]
bas 5, expnt(s) = [56.97730095]
bas 6, expnt(s) = [0.48854513]
bas 7, expnt(s) = [8.14781684]
bas 8, expnt(s) = [1.64911438]
bas 9, expnt(s) = [5.87578163]
bas 10, expnt(s) = [17.92215667]
bas 11, expnt(s) = [71.08025407]
bas 12, expnt(s) = [0.24516219]
bas 13, expnt(s) = [2.09396767]
bas 14, expnt(s) = [0.73796551]
CPU time:       173.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209707e+03 9.49497764e+02
 6.17494410e+02 3.12960695e+02 1.74933559e+02 1.21526187e+02
 2.03530144e+01 2.42095423e+01 5.69773009e+01 5.23951911e+01
 4.88545127e-01 1.47636431e+00 8.14781684e+00 1.21841705e+01
 1.64911438e+00 3.67665694e+00 5.87578163e+00 2.66880260e+01
 1.79221567e+01 1.07577694e+02 7.10802541e+01 6.02102745e+02
 2.45162191e-01 5.03270252e-01 2.09396767e+00 7.34846885e+00
 7.37965507e-01 1.99539772e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999325452588508
cond(S) = 250.3977229973086
E1 = -183.58300440842797  E_coul = 55.081757167375315
init E= -128.501247241053
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775184363206025  LUMO = 0.73461166378629
  mo_energy =
[-3.25537369e+01 -1.85133258e+00 -7.75184363e-01 -7.75184363e-01
 -7.75184363e-01  7.34611664e-01  7.34611664e-01  7.34611664e-01
  2.06676489e+00  3.43592135e+00  3.43592135e+00  3.43592135e+00
  1.19987620e+01  1.19987620e+01  1.19987620e+01  1.98713457e+01
  4.15653976e+01  4.15653976e+01  4.15653976e+01  9.47069772e+01
  1.72303238e+02  1.72303238e+02  1.72303238e+02  3.57023286e+02
  1.35035841e+03  5.83673177e+03  3.50992321e+04]
E1 = -182.07830904657996  E_coul = 53.54552745731037
cycle= 1 E= -128.53278158927  delta_E= -0.0315  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.521035
diis-c [-0.27147734  1.        ]
  HOMO = -0.884040531280543  LUMO = 0.712081354007445
  mo_energy =
[-3.28783024e+01 -1.96588689e+00 -8.84040531e-01 -8.84040531e-01
 -8.84040531e-01  7.12081354e-01  7.12081354e-01  7.12081354e-01
  1.98848070e+00  3.35034342e+00  3.35034342e+00  3.35034342e+00
  1.18253192e+01  1.18253192e+01  1.18253192e+01  1.96463758e+01
  4.13001702e+01  4.13001702e+01  4.13001702e+01  9.44012213e+01
  1.71968138e+02  1.71968138e+02  1.71968138e+02  3.56670253e+02
  1.34996748e+03  5.83630898e+03  3.50987879e+04]
E1 = -182.8443303473654  E_coul = 54.3089311225648
cycle= 2 E= -128.535399224801  delta_E= -0.00262  |g|= 0.104  |ddm|= 0.0722
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264496
diis-c [-6.12416328e-04  3.35980408e-01  6.64019592e-01]
  HOMO = -0.848187102736385  LUMO = 0.719546755817581
  mo_energy =
[-3.27696564e+01 -1.92803100e+00 -8.48187103e-01 -8.48187103e-01
 -8.48187103e-01  7.19546756e-01  7.19546756e-01  7.19546756e-01
  2.01410599e+00  3.37826739e+00  3.37826739e+00  3.37826739e+00
  1.18828306e+01  1.18828306e+01  1.18828306e+01  1.97217699e+01
  4.13889925e+01  4.13889925e+01  4.13889925e+01  9.45038496e+01
  1.72079228e+02  1.72079228e+02  1.72079228e+02  3.56785727e+02
  1.35008925e+03  5.83643371e+03  3.50989138e+04]
E1 = -182.5849544314153  E_coul = 54.04862797772279
cycle= 3 E= -128.536326453693  delta_E= -0.000927  |g|= 0.000396  |ddm|= 0.0249
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000984429
diis-c [-8.56523803e-08 -2.02831647e-03 -4.38118941e-04  1.00246644e+00]
  HOMO = -0.84838563167527  LUMO = 0.719530013061853
  mo_energy =
[-3.27700498e+01 -1.92818807e+00 -8.48385632e-01 -8.48385632e-01
 -8.48385632e-01  7.19530013e-01  7.19530013e-01  7.19530013e-01
  2.01402545e+00  3.37815697e+00  3.37815697e+00  3.37815697e+00
  1.18826126e+01  1.18826126e+01  1.18826126e+01  1.97215186e+01
  4.13886759e+01  4.13886759e+01  4.13886759e+01  9.45034862e+01
  1.72078802e+02  1.72078802e+02  1.72078802e+02  3.56785246e+02
  1.35008863e+03  5.83643298e+03  3.50989130e+04]
E1 = -182.58534845756353  E_coul = 54.0490219908794
cycle= 4 E= -128.536326466684  delta_E= -1.3e-08  |g|= 6.63e-05  |ddm|= 0.000135
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000169545
diis-c [-4.09202667e-10  9.29201479e-05  4.85931561e-04 -1.11305915e-01
  1.11072706e+00]
  HOMO = -0.848419033271245  LUMO = 0.719520990196883
  mo_energy =
[-3.27701147e+01 -1.92821886e+00 -8.48419033e-01 -8.48419033e-01
 -8.48419033e-01  7.19520990e-01  7.19520990e-01  7.19520990e-01
  2.01400092e+00  3.37812785e+00  3.37812785e+00  3.37812785e+00
  1.18825657e+01  1.18825657e+01  1.18825657e+01  1.97214663e+01
  4.13886172e+01  4.13886172e+01  4.13886172e+01  9.45034234e+01
  1.72078736e+02  1.72078736e+02  1.72078736e+02  3.56785177e+02
  1.35008856e+03  5.83643290e+03  3.50989129e+04]
E1 = -182.5854790317176  E_coul = 54.04915256464468
cycle= 5 E= -128.536326467073  delta_E= -3.89e-10  |g|= 1.7e-06  |ddm|= 1.95e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5854790317176  E_coul = 54.04915256464468
  HOMO = -0.848418524983452  LUMO = 0.719521067360049
  mo_energy =
[-3.27701133e+01 -1.92821810e+00 -8.48418525e-01 -8.48418525e-01
 -8.48418525e-01  7.19521067e-01  7.19521067e-01  7.19521067e-01
  2.01400142e+00  3.37812822e+00  3.37812822e+00  3.37812822e+00
  1.18825666e+01  1.18825666e+01  1.18825666e+01  1.97214676e+01
  4.13886186e+01  4.13886186e+01  4.13886186e+01  9.45034247e+01
  1.72078738e+02  1.72078738e+02  1.72078738e+02  3.56785178e+02
  1.35008856e+03  5.83643290e+03  3.50989129e+04]
E1 = -182.5854741367419  E_coul = 54.04914766966898
Extra cycle  E= -128.536326467073  delta_E=    0  |g|= 6.48e-07  |ddm|= 9.42e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209707e+03 6.17494410e+02 1.74933559e+02
 2.03530144e+01 5.69773009e+01 4.88545127e-01 8.14781684e+00
 1.64911438e+00 5.87578163e+00 1.79221567e+01 7.10802541e+01
 2.45162191e-01 2.09396767e+00 7.37965507e-01]
E = -128.5363264670729
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787248        1
[INPUT] 0    0    [1    /1   ]  2712.09706827        1
[INPUT] 0    0    [1    /1   ]  617.494409736        1
[INPUT] 0    0    [1    /1   ]  174.933558667        1
[INPUT] 0    0    [1    /1   ]  20.3530144111        1
[INPUT] 0    0    [1    /1   ]  56.9773009492        1
[INPUT] 0    0    [1    /1   ]  0.488545127339       1
[INPUT] 0    0    [1    /1   ]  8.14781684152        1
[INPUT] 0    0    [1    /1   ]  1.64911438167        1
[INPUT] 1    0    [1    /1   ]  5.87578163141        1
[INPUT] 1    0    [1    /1   ]  17.9221566671        1
[INPUT] 1    0    [1    /1   ]  71.0802540729        1
[INPUT] 1    0    [1    /1   ]  0.245162191011       1
[INPUT] 1    0    [1    /1   ]  2.09396766916        1
[INPUT] 1    0    [1    /1   ]  0.73796550721        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478724847006, 1.0]], [0, [2712.0970682682137, 1.0]], [0, [617.4944097364964, 1.0]], [0, [174.93355866697706, 1.0]], [0, [20.353014411104194, 1.0]], [0, [56.97730094918503, 1.0]], [0, [0.4885451273387926, 1.0]], [0, [8.147816841523152, 1.0]], [0, [1.6491143816746723, 1.0]], [1, [5.875781631413155, 1.0]], [1, [17.922156667074656, 1.0]], [1, [71.08025407292412, 1.0]], [1, [0.24516219101059797, 1.0]], [1, [2.0939676691562883, 1.0]], [1, [0.7379655072099294, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872485]
bas 1, expnt(s) = [2712.09706827]
bas 2, expnt(s) = [617.49440974]
bas 3, expnt(s) = [174.93355867]
bas 4, expnt(s) = [20.35301441]
bas 5, expnt(s) = [56.97730095]
bas 6, expnt(s) = [0.48854513]
bas 7, expnt(s) = [8.14781684]
bas 8, expnt(s) = [1.64911438]
bas 9, expnt(s) = [5.87578163]
bas 10, expnt(s) = [17.92215667]
bas 11, expnt(s) = [71.08025407]
bas 12, expnt(s) = [0.24516219]
bas 13, expnt(s) = [2.09396767]
bas 14, expnt(s) = [0.73796551]
CPU time:       174.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209707e+03 9.49497764e+02
 6.17494410e+02 3.12960695e+02 1.74933559e+02 1.21526187e+02
 2.03530144e+01 2.42095423e+01 5.69773009e+01 5.23951911e+01
 4.88545127e-01 1.47636431e+00 8.14781684e+00 1.21841705e+01
 1.64911438e+00 3.67665694e+00 5.87578163e+00 2.66880260e+01
 1.79221567e+01 1.07577694e+02 7.10802541e+01 6.02102745e+02
 2.45162191e-01 5.03270252e-01 2.09396767e+00 7.34846885e+00
 7.37965507e-01 1.99539772e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999325452588508
cond(S) = 250.3977229973086
E1 = -183.58300440842797  E_coul = 55.081757167375315
init E= -128.501247241053
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775184363206025  LUMO = 0.73461166378629
  mo_energy =
[-3.25537369e+01 -1.85133258e+00 -7.75184363e-01 -7.75184363e-01
 -7.75184363e-01  7.34611664e-01  7.34611664e-01  7.34611664e-01
  2.06676489e+00  3.43592135e+00  3.43592135e+00  3.43592135e+00
  1.19987620e+01  1.19987620e+01  1.19987620e+01  1.98713457e+01
  4.15653976e+01  4.15653976e+01  4.15653976e+01  9.47069772e+01
  1.72303238e+02  1.72303238e+02  1.72303238e+02  3.57023286e+02
  1.35035841e+03  5.83673177e+03  3.50992321e+04]
E1 = -182.07830904657996  E_coul = 53.54552745731037
cycle= 1 E= -128.53278158927  delta_E= -0.0315  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.521035
diis-c [-0.27147734  1.        ]
  HOMO = -0.884040531280543  LUMO = 0.712081354007445
  mo_energy =
[-3.28783024e+01 -1.96588689e+00 -8.84040531e-01 -8.84040531e-01
 -8.84040531e-01  7.12081354e-01  7.12081354e-01  7.12081354e-01
  1.98848070e+00  3.35034342e+00  3.35034342e+00  3.35034342e+00
  1.18253192e+01  1.18253192e+01  1.18253192e+01  1.96463758e+01
  4.13001702e+01  4.13001702e+01  4.13001702e+01  9.44012213e+01
  1.71968138e+02  1.71968138e+02  1.71968138e+02  3.56670253e+02
  1.34996748e+03  5.83630898e+03  3.50987879e+04]
E1 = -182.8443303473654  E_coul = 54.3089311225648
cycle= 2 E= -128.535399224801  delta_E= -0.00262  |g|= 0.104  |ddm|= 0.0722
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264496
diis-c [-6.12416328e-04  3.35980408e-01  6.64019592e-01]
  HOMO = -0.848187102736385  LUMO = 0.719546755817581
  mo_energy =
[-3.27696564e+01 -1.92803100e+00 -8.48187103e-01 -8.48187103e-01
 -8.48187103e-01  7.19546756e-01  7.19546756e-01  7.19546756e-01
  2.01410599e+00  3.37826739e+00  3.37826739e+00  3.37826739e+00
  1.18828306e+01  1.18828306e+01  1.18828306e+01  1.97217699e+01
  4.13889925e+01  4.13889925e+01  4.13889925e+01  9.45038496e+01
  1.72079228e+02  1.72079228e+02  1.72079228e+02  3.56785727e+02
  1.35008925e+03  5.83643371e+03  3.50989138e+04]
E1 = -182.5849544314153  E_coul = 54.04862797772279
cycle= 3 E= -128.536326453693  delta_E= -0.000927  |g|= 0.000396  |ddm|= 0.0249
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000984429
diis-c [-8.56523803e-08 -2.02831647e-03 -4.38118941e-04  1.00246644e+00]
  HOMO = -0.84838563167527  LUMO = 0.719530013061853
  mo_energy =
[-3.27700498e+01 -1.92818807e+00 -8.48385632e-01 -8.48385632e-01
 -8.48385632e-01  7.19530013e-01  7.19530013e-01  7.19530013e-01
  2.01402545e+00  3.37815697e+00  3.37815697e+00  3.37815697e+00
  1.18826126e+01  1.18826126e+01  1.18826126e+01  1.97215186e+01
  4.13886759e+01  4.13886759e+01  4.13886759e+01  9.45034862e+01
  1.72078802e+02  1.72078802e+02  1.72078802e+02  3.56785246e+02
  1.35008863e+03  5.83643298e+03  3.50989130e+04]
E1 = -182.58534845756353  E_coul = 54.0490219908794
cycle= 4 E= -128.536326466684  delta_E= -1.3e-08  |g|= 6.63e-05  |ddm|= 0.000135
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000169545
diis-c [-4.09202667e-10  9.29201479e-05  4.85931561e-04 -1.11305915e-01
  1.11072706e+00]
  HOMO = -0.848419033271245  LUMO = 0.719520990196883
  mo_energy =
[-3.27701147e+01 -1.92821886e+00 -8.48419033e-01 -8.48419033e-01
 -8.48419033e-01  7.19520990e-01  7.19520990e-01  7.19520990e-01
  2.01400092e+00  3.37812785e+00  3.37812785e+00  3.37812785e+00
  1.18825657e+01  1.18825657e+01  1.18825657e+01  1.97214663e+01
  4.13886172e+01  4.13886172e+01  4.13886172e+01  9.45034234e+01
  1.72078736e+02  1.72078736e+02  1.72078736e+02  3.56785177e+02
  1.35008856e+03  5.83643290e+03  3.50989129e+04]
E1 = -182.5854790317176  E_coul = 54.04915256464468
cycle= 5 E= -128.536326467073  delta_E= -3.89e-10  |g|= 1.7e-06  |ddm|= 1.95e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5854790317176  E_coul = 54.04915256464468
  HOMO = -0.848418524983452  LUMO = 0.719521067360049
  mo_energy =
[-3.27701133e+01 -1.92821810e+00 -8.48418525e-01 -8.48418525e-01
 -8.48418525e-01  7.19521067e-01  7.19521067e-01  7.19521067e-01
  2.01400142e+00  3.37812822e+00  3.37812822e+00  3.37812822e+00
  1.18825666e+01  1.18825666e+01  1.18825666e+01  1.97214676e+01
  4.13886186e+01  4.13886186e+01  4.13886186e+01  9.45034247e+01
  1.72078738e+02  1.72078738e+02  1.72078738e+02  3.56785178e+02
  1.35008856e+03  5.83643290e+03  3.50989129e+04]
E1 = -182.5854741367419  E_coul = 54.04914766966898
Extra cycle  E= -128.536326467073  delta_E=    0  |g|= 6.48e-07  |ddm|= 9.42e-07
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 250.3977229973086
E1 = -182.5854741367419  E_coul = 54.04914766966898
init E= -128.536326467073
    CPU time for initialize scf      0.29 sec, wall time      0.28 sec
  HOMO = -0.848418888103166  LUMO = 0.719520986759789
  mo_energy =
[-3.27701143e+01 -1.92821844e+00 -8.48418888e-01 -8.48418888e-01
 -8.48418888e-01  7.19520987e-01  7.19520987e-01  7.19520987e-01
  2.01400118e+00  3.37812793e+00  3.37812793e+00  3.37812793e+00
  1.18825660e+01  1.18825660e+01  1.18825660e+01  1.97214669e+01
  4.13886177e+01  4.13886177e+01  4.13886177e+01  9.45034238e+01
  1.72078737e+02  1.72078737e+02  1.72078737e+02  3.56785177e+02
  1.35008856e+03  5.83643290e+03  3.50989129e+04]
E1 = -182.58547650311502  E_coul = 54.049150036041915
cycle= 1 E= -128.536326467073  delta_E= -1.99e-13  |g|= 3.28e-07  |ddm|= 1.93e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58547650311502  E_coul = 54.049150036041915
  HOMO = -0.848418723476405  LUMO = 0.719521020643065
  mo_energy =
[-3.27701138e+01 -1.92821826e+00 -8.48418723e-01 -8.48418723e-01
 -8.48418723e-01  7.19521021e-01  7.19521021e-01  7.19521021e-01
  2.01400130e+00  3.37812805e+00  3.37812805e+00  3.37812805e+00
  1.18825663e+01  1.18825663e+01  1.18825663e+01  1.97214673e+01
  4.13886182e+01  4.13886182e+01  4.13886182e+01  9.45034243e+01
  1.72078737e+02  1.72078737e+02  1.72078737e+02  3.56785177e+02
  1.35008856e+03  5.83643290e+03  3.50989129e+04]
E1 = -182.58547527572347  E_coul = 54.04914880865044
Extra cycle  E= -128.536326467073  delta_E= 8.53e-14  |g|= 1.66e-07  |ddm|= 1.27e-07
    CPU time for scf_cycle      0.37 sec, wall time      0.36 sec
exp = [1.80764787e+04 2.71209707e+03 6.17494410e+02 1.74933559e+02
 2.03530144e+01 5.69773009e+01 4.88545127e-01 8.14781684e+00
 1.64911438e+00 5.87578163e+00 1.79221567e+01 7.10802541e+01
 2.45162191e-01 2.09396767e+00 7.37965507e-01]
grad_E = [ 6.46527923e-09 -3.36573921e-07  6.75948885e-06 -7.63177157e-05
 -1.93224697e-03  5.40202091e-04 -4.64820944e-04  3.06354027e-03
  7.21238205e-05  2.14607281e-04 -5.61924163e-05 -6.17300479e-05
 -2.87362545e-04 -6.07634960e-04  5.24076423e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.478725         1
[INPUT] 0    0    [1    /1   ]  2712.09706277        1
[INPUT] 0    0    [1    /1   ]  617.49450112         1
[INPUT] 0    0    [1    /1   ]  174.932984908        1
[INPUT] 0    0    [1    /1   ]  20.3585604866        1
[INPUT] 0    0    [1    /1   ]  56.9764481312        1
[INPUT] 0    0    [1    /1   ]  0.487959198718       1
[INPUT] 0    0    [1    /1   ]  8.13616182975        1
[INPUT] 0    0    [1    /1   ]  1.64843022505        1
[INPUT] 1    0    [1    /1   ]  5.85944584381        1
[INPUT] 1    0    [1    /1   ]  17.8812057995        1
[INPUT] 1    0    [1    /1   ]  70.6903538582        1
[INPUT] 1    0    [1    /1   ]  0.244717261246       1
[INPUT] 1    0    [1    /1   ]  2.08805410468        1
[INPUT] 1    0    [1    /1   ]  0.736101423341       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478724962373, 1.0]], [0, [2712.0970627714796, 1.0]], [0, [617.4945011197675, 1.0]], [0, [174.93298490759133, 1.0]], [0, [20.358560486606873, 1.0]], [0, [56.976448131219705, 1.0]], [0, [0.4879591987178253, 1.0]], [0, [8.136161829752005, 1.0]], [0, [1.6484302250459149, 1.0]], [1, [5.8594458438118755, 1.0]], [1, [17.88120579945669, 1.0]], [1, [70.69035385824718, 1.0]], [1, [0.24471726124555412, 1.0]], [1, [2.0880541046789647, 1.0]], [1, [0.7361014233413776, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872496]
bas 1, expnt(s) = [2712.09706277]
bas 2, expnt(s) = [617.49450112]
bas 3, expnt(s) = [174.93298491]
bas 4, expnt(s) = [20.35856049]
bas 5, expnt(s) = [56.97644813]
bas 6, expnt(s) = [0.4879592]
bas 7, expnt(s) = [8.13616183]
bas 8, expnt(s) = [1.64843023]
bas 9, expnt(s) = [5.85944584]
bas 10, expnt(s) = [17.8812058]
bas 11, expnt(s) = [70.69035386]
bas 12, expnt(s) = [0.24471726]
bas 13, expnt(s) = [2.0880541]
bas 14, expnt(s) = [0.73610142]
CPU time:       177.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209706e+03 9.49497762e+02
 6.17494501e+02 3.12960729e+02 1.74932985e+02 1.21525888e+02
 2.03585605e+01 2.42144899e+01 5.69764481e+01 5.23946029e+01
 4.87959199e-01 1.47503612e+00 8.13616183e+00 1.21710966e+01
 1.64843023e+00 3.67551290e+00 5.85944584e+00 2.65953110e+01
 1.78812058e+01 1.07270522e+02 7.06903539e+01 5.97977147e+02
 2.44717261e-01 5.02128818e-01 2.08805410e+00 7.32253704e+00
 7.36101423e-01 1.98909930e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999329911549767
cond(S) = 249.90507296812535
E1 = -183.58316511756382  E_coul = 55.08176977441047
init E= -128.501395343153
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775181345218483  LUMO = 0.732808365953056
  mo_energy =
[-3.25537572e+01 -1.85132854e+00 -7.75181345e-01 -7.75181345e-01
 -7.75181345e-01  7.32808366e-01  7.32808366e-01  7.32808366e-01
  2.06391613e+00  3.42643934e+00  3.42643934e+00  3.42643934e+00
  1.19618356e+01  1.19618356e+01  1.19618356e+01  1.98501740e+01
  4.14434349e+01  4.14434349e+01  4.14434349e+01  9.46728824e+01
  1.71483101e+02  1.71483101e+02  1.71483101e+02  3.56991133e+02
  1.35032852e+03  5.83670502e+03  3.50992099e+04]
E1 = -182.07746025886394  E_coul = 53.544663637570906
cycle= 1 E= -128.532796621293  delta_E= -0.0314  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.521546
diis-c [-0.27201049  1.        ]
  HOMO = -0.884108082990649  LUMO = 0.710340896437262
  mo_energy =
[-3.28784917e+01 -1.96593760e+00 -8.84108083e-01 -8.84108083e-01
 -8.84108083e-01  7.10340896e-01  7.10340896e-01  7.10340896e-01
  1.98566426e+00  3.34101226e+00  3.34101226e+00  3.34101226e+00
  1.17885511e+01  1.17885511e+01  1.17885511e+01  1.96251407e+01
  4.11782444e+01  4.11782444e+01  4.11782444e+01  9.43669635e+01
  1.71148014e+02  1.71148014e+02  1.71148014e+02  3.56637912e+02
  1.34993738e+03  5.83628202e+03  3.50987655e+04]
E1 = -182.84401915812307  E_coul = 54.3086019531064
cycle= 2 E= -128.535417205017  delta_E= -0.00262  |g|= 0.104  |ddm|= 0.0721
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264757
diis-c [-6.12535233e-04  3.35982996e-01  6.64017004e-01]
  HOMO = -0.848228867547057  LUMO = 0.717786556343973
  mo_energy =
[-3.27697733e+01 -1.92805421e+00 -8.48228868e-01 -8.48228868e-01
 -8.48228868e-01  7.17786556e-01  7.17786556e-01  7.17786556e-01
  2.01128533e+00  3.36888822e+00  3.36888822e+00  3.36888822e+00
  1.18460136e+01  1.18460136e+01  1.18460136e+01  1.97005646e+01
  4.12670678e+01  4.12670678e+01  4.12670678e+01  9.44696601e+01
  1.71259123e+02  1.71259123e+02  1.71259123e+02  3.56753462e+02
  1.35005923e+03  5.83640683e+03  3.50988915e+04]
E1 = -182.584444748166  E_coul = 54.048099024701415
cycle= 3 E= -128.536345723465  delta_E= -0.000929  |g|= 0.000398  |ddm|= 0.0249
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000996631
diis-c [-8.76519415e-08 -2.03064465e-03 -4.01471695e-04  1.00243212e+00]
  HOMO = -0.848428086172129  LUMO = 0.717769931809455
  mo_energy =
[-3.27701685e+01 -1.92821040e+00 -8.48428086e-01 -8.48428086e-01
 -8.48428086e-01  7.17769932e-01  7.17769932e-01  7.17769932e-01
  2.01120572e+00  3.36877783e+00  3.36877783e+00  3.36877783e+00
  1.18457952e+01  1.18457952e+01  1.18457952e+01  1.97003127e+01
  4.12667502e+01  4.12667502e+01  4.12667502e+01  9.44692949e+01
  1.71258696e+02  1.71258696e+02  1.71258696e+02  3.56752978e+02
  1.35005861e+03  5.83640610e+03  3.50988907e+04]
E1 = -182.5848453365752  E_coul = 54.048499599925044
cycle= 4 E= -128.53634573665  delta_E= -1.32e-08  |g|= 6.71e-05  |ddm|= 0.000135
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000172525
diis-c [-4.21664764e-10  9.64837703e-05  4.93257690e-04 -1.13482259e-01
  1.11289252e+00]
  HOMO = -0.848461760442962  LUMO = 0.717760900521071
  mo_energy =
[-3.27702342e+01 -1.92824112e+00 -8.48461760e-01 -8.48461760e-01
 -8.48461760e-01  7.17760901e-01  7.17760901e-01  7.17760901e-01
  2.01118130e+00  3.36874858e+00  3.36874858e+00  3.36874858e+00
  1.18457479e+01  1.18457479e+01  1.18457479e+01  1.97002601e+01
  4.12666910e+01  4.12666910e+01  4.12666910e+01  9.44692314e+01
  1.71258629e+02  1.71258629e+02  1.71258629e+02  3.56752908e+02
  1.35005854e+03  5.83640602e+03  3.50988906e+04]
E1 = -182.58497823021844  E_coul = 54.04863249316921
cycle= 5 E= -128.536345737049  delta_E= -3.99e-10  |g|= 1.79e-06  |ddm|= 1.94e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58497823021844  E_coul = 54.04863249316921
  HOMO = -0.848461207076651  LUMO = 0.717760992939217
  mo_energy =
[-3.27702327e+01 -1.92824028e+00 -8.48461207e-01 -8.48461207e-01
 -8.48461207e-01  7.17760993e-01  7.17760993e-01  7.17760993e-01
  2.01118187e+00  3.36874900e+00  3.36874900e+00  3.36874900e+00
  1.18457488e+01  1.18457488e+01  1.18457488e+01  1.97002614e+01
  4.12666924e+01  4.12666924e+01  4.12666924e+01  9.44692328e+01
  1.71258631e+02  1.71258631e+02  1.71258631e+02  3.56752909e+02
  1.35005854e+03  5.83640602e+03  3.50988906e+04]
E1 = -182.5849732775093  E_coul = 54.048627540459826
Extra cycle  E= -128.536345737049  delta_E= -2.56e-13  |g|= 6.61e-07  |ddm|= 9.72e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209706e+03 6.17494501e+02 1.74932985e+02
 2.03585605e+01 5.69764481e+01 4.87959199e-01 8.13616183e+00
 1.64843023e+00 5.85944584e+00 1.78812058e+01 7.06903539e+01
 2.44717261e-01 2.08805410e+00 7.36101423e-01]
E = -128.5363457370495
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.478725         1
[INPUT] 0    0    [1    /1   ]  2712.09706277        1
[INPUT] 0    0    [1    /1   ]  617.49450112         1
[INPUT] 0    0    [1    /1   ]  174.932984908        1
[INPUT] 0    0    [1    /1   ]  20.3585604866        1
[INPUT] 0    0    [1    /1   ]  56.9764481312        1
[INPUT] 0    0    [1    /1   ]  0.487959198718       1
[INPUT] 0    0    [1    /1   ]  8.13616182975        1
[INPUT] 0    0    [1    /1   ]  1.64843022505        1
[INPUT] 1    0    [1    /1   ]  5.85944584381        1
[INPUT] 1    0    [1    /1   ]  17.8812057995        1
[INPUT] 1    0    [1    /1   ]  70.6903538582        1
[INPUT] 1    0    [1    /1   ]  0.244717261246       1
[INPUT] 1    0    [1    /1   ]  2.08805410468        1
[INPUT] 1    0    [1    /1   ]  0.736101423341       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478724962373, 1.0]], [0, [2712.0970627714796, 1.0]], [0, [617.4945011197675, 1.0]], [0, [174.93298490759133, 1.0]], [0, [20.358560486606873, 1.0]], [0, [56.976448131219705, 1.0]], [0, [0.4879591987178253, 1.0]], [0, [8.136161829752005, 1.0]], [0, [1.6484302250459149, 1.0]], [1, [5.8594458438118755, 1.0]], [1, [17.88120579945669, 1.0]], [1, [70.69035385824718, 1.0]], [1, [0.24471726124555412, 1.0]], [1, [2.0880541046789647, 1.0]], [1, [0.7361014233413776, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872496]
bas 1, expnt(s) = [2712.09706277]
bas 2, expnt(s) = [617.49450112]
bas 3, expnt(s) = [174.93298491]
bas 4, expnt(s) = [20.35856049]
bas 5, expnt(s) = [56.97644813]
bas 6, expnt(s) = [0.4879592]
bas 7, expnt(s) = [8.13616183]
bas 8, expnt(s) = [1.64843023]
bas 9, expnt(s) = [5.85944584]
bas 10, expnt(s) = [17.8812058]
bas 11, expnt(s) = [70.69035386]
bas 12, expnt(s) = [0.24471726]
bas 13, expnt(s) = [2.0880541]
bas 14, expnt(s) = [0.73610142]
CPU time:       178.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209706e+03 9.49497762e+02
 6.17494501e+02 3.12960729e+02 1.74932985e+02 1.21525888e+02
 2.03585605e+01 2.42144899e+01 5.69764481e+01 5.23946029e+01
 4.87959199e-01 1.47503612e+00 8.13616183e+00 1.21710966e+01
 1.64843023e+00 3.67551290e+00 5.85944584e+00 2.65953110e+01
 1.78812058e+01 1.07270522e+02 7.06903539e+01 5.97977147e+02
 2.44717261e-01 5.02128818e-01 2.08805410e+00 7.32253704e+00
 7.36101423e-01 1.98909930e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999329911549767
cond(S) = 249.90507296812535
E1 = -183.58316511756382  E_coul = 55.08176977441047
init E= -128.501395343153
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775181345218483  LUMO = 0.732808365953056
  mo_energy =
[-3.25537572e+01 -1.85132854e+00 -7.75181345e-01 -7.75181345e-01
 -7.75181345e-01  7.32808366e-01  7.32808366e-01  7.32808366e-01
  2.06391613e+00  3.42643934e+00  3.42643934e+00  3.42643934e+00
  1.19618356e+01  1.19618356e+01  1.19618356e+01  1.98501740e+01
  4.14434349e+01  4.14434349e+01  4.14434349e+01  9.46728824e+01
  1.71483101e+02  1.71483101e+02  1.71483101e+02  3.56991133e+02
  1.35032852e+03  5.83670502e+03  3.50992099e+04]
E1 = -182.07746025886394  E_coul = 53.544663637570906
cycle= 1 E= -128.532796621293  delta_E= -0.0314  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.521546
diis-c [-0.27201049  1.        ]
  HOMO = -0.884108082990649  LUMO = 0.710340896437262
  mo_energy =
[-3.28784917e+01 -1.96593760e+00 -8.84108083e-01 -8.84108083e-01
 -8.84108083e-01  7.10340896e-01  7.10340896e-01  7.10340896e-01
  1.98566426e+00  3.34101226e+00  3.34101226e+00  3.34101226e+00
  1.17885511e+01  1.17885511e+01  1.17885511e+01  1.96251407e+01
  4.11782444e+01  4.11782444e+01  4.11782444e+01  9.43669635e+01
  1.71148014e+02  1.71148014e+02  1.71148014e+02  3.56637912e+02
  1.34993738e+03  5.83628202e+03  3.50987655e+04]
E1 = -182.84401915812307  E_coul = 54.3086019531064
cycle= 2 E= -128.535417205017  delta_E= -0.00262  |g|= 0.104  |ddm|= 0.0721
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264757
diis-c [-6.12535233e-04  3.35982996e-01  6.64017004e-01]
  HOMO = -0.848228867547057  LUMO = 0.717786556343973
  mo_energy =
[-3.27697733e+01 -1.92805421e+00 -8.48228868e-01 -8.48228868e-01
 -8.48228868e-01  7.17786556e-01  7.17786556e-01  7.17786556e-01
  2.01128533e+00  3.36888822e+00  3.36888822e+00  3.36888822e+00
  1.18460136e+01  1.18460136e+01  1.18460136e+01  1.97005646e+01
  4.12670678e+01  4.12670678e+01  4.12670678e+01  9.44696601e+01
  1.71259123e+02  1.71259123e+02  1.71259123e+02  3.56753462e+02
  1.35005923e+03  5.83640683e+03  3.50988915e+04]
E1 = -182.584444748166  E_coul = 54.048099024701415
cycle= 3 E= -128.536345723465  delta_E= -0.000929  |g|= 0.000398  |ddm|= 0.0249
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000996631
diis-c [-8.76519415e-08 -2.03064465e-03 -4.01471695e-04  1.00243212e+00]
  HOMO = -0.848428086172129  LUMO = 0.717769931809455
  mo_energy =
[-3.27701685e+01 -1.92821040e+00 -8.48428086e-01 -8.48428086e-01
 -8.48428086e-01  7.17769932e-01  7.17769932e-01  7.17769932e-01
  2.01120572e+00  3.36877783e+00  3.36877783e+00  3.36877783e+00
  1.18457952e+01  1.18457952e+01  1.18457952e+01  1.97003127e+01
  4.12667502e+01  4.12667502e+01  4.12667502e+01  9.44692949e+01
  1.71258696e+02  1.71258696e+02  1.71258696e+02  3.56752978e+02
  1.35005861e+03  5.83640610e+03  3.50988907e+04]
E1 = -182.5848453365752  E_coul = 54.048499599925044
cycle= 4 E= -128.53634573665  delta_E= -1.32e-08  |g|= 6.71e-05  |ddm|= 0.000135
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000172525
diis-c [-4.21664764e-10  9.64837703e-05  4.93257690e-04 -1.13482259e-01
  1.11289252e+00]
  HOMO = -0.848461760442962  LUMO = 0.717760900521071
  mo_energy =
[-3.27702342e+01 -1.92824112e+00 -8.48461760e-01 -8.48461760e-01
 -8.48461760e-01  7.17760901e-01  7.17760901e-01  7.17760901e-01
  2.01118130e+00  3.36874858e+00  3.36874858e+00  3.36874858e+00
  1.18457479e+01  1.18457479e+01  1.18457479e+01  1.97002601e+01
  4.12666910e+01  4.12666910e+01  4.12666910e+01  9.44692314e+01
  1.71258629e+02  1.71258629e+02  1.71258629e+02  3.56752908e+02
  1.35005854e+03  5.83640602e+03  3.50988906e+04]
E1 = -182.58497823021844  E_coul = 54.04863249316921
cycle= 5 E= -128.536345737049  delta_E= -3.99e-10  |g|= 1.79e-06  |ddm|= 1.94e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58497823021844  E_coul = 54.04863249316921
  HOMO = -0.848461207076651  LUMO = 0.717760992939217
  mo_energy =
[-3.27702327e+01 -1.92824028e+00 -8.48461207e-01 -8.48461207e-01
 -8.48461207e-01  7.17760993e-01  7.17760993e-01  7.17760993e-01
  2.01118187e+00  3.36874900e+00  3.36874900e+00  3.36874900e+00
  1.18457488e+01  1.18457488e+01  1.18457488e+01  1.97002614e+01
  4.12666924e+01  4.12666924e+01  4.12666924e+01  9.44692328e+01
  1.71258631e+02  1.71258631e+02  1.71258631e+02  3.56752909e+02
  1.35005854e+03  5.83640602e+03  3.50988906e+04]
E1 = -182.5849732775093  E_coul = 54.048627540459826
Extra cycle  E= -128.536345737049  delta_E= -2.56e-13  |g|= 6.61e-07  |ddm|= 9.72e-07
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 249.90507296812535
E1 = -182.5849732775093  E_coul = 54.048627540459826
init E= -128.536345737049
    CPU time for initialize scf      0.31 sec, wall time      0.30 sec
  HOMO = -0.848461574134966  LUMO = 0.717760912763547
  mo_energy =
[-3.27702338e+01 -1.92824063e+00 -8.48461574e-01 -8.48461574e-01
 -8.48461574e-01  7.17760913e-01  7.17760913e-01  7.17760913e-01
  2.01118163e+00  3.36874871e+00  3.36874871e+00  3.36874871e+00
  1.18457483e+01  1.18457483e+01  1.18457483e+01  1.97002607e+01
  4.12666915e+01  4.12666915e+01  4.12666915e+01  9.44692318e+01
  1.71258630e+02  1.71258630e+02  1.71258630e+02  3.56752908e+02
  1.35005854e+03  5.83640602e+03  3.50988906e+04]
E1 = -182.58497571004156  E_coul = 54.04862997299221
cycle= 1 E= -128.536345737049  delta_E= 1.42e-13  |g|= 3.37e-07  |ddm|= 1.95e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58497571004156  E_coul = 54.04862997299221
  HOMO = -0.848461404871022  LUMO = 0.717760947668969
  mo_energy =
[-3.27702332e+01 -1.92824044e+00 -8.48461405e-01 -8.48461405e-01
 -8.48461405e-01  7.17760948e-01  7.17760948e-01  7.17760948e-01
  2.01118176e+00  3.36874884e+00  3.36874884e+00  3.36874884e+00
  1.18457485e+01  1.18457485e+01  1.18457485e+01  1.97002611e+01
  4.12666920e+01  4.12666920e+01  4.12666920e+01  9.44692323e+01
  1.71258630e+02  1.71258630e+02  1.71258630e+02  3.56752909e+02
  1.35005854e+03  5.83640602e+03  3.50988906e+04]
E1 = -182.58497445500123  E_coul = 54.048628717951814
Extra cycle  E= -128.536345737049  delta_E= -8.53e-14  |g|= 1.69e-07  |ddm|= 1.31e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.36 sec
exp = [1.80764787e+04 2.71209706e+03 6.17494501e+02 1.74932985e+02
 2.03585605e+01 5.69764481e+01 4.87959199e-01 8.13616183e+00
 1.64843023e+00 5.85944584e+00 1.78812058e+01 7.06903539e+01
 2.44717261e-01 2.08805410e+00 7.36101423e-01]
grad_E = [ 6.22600091e-09 -3.24196386e-07  6.50914701e-06 -7.35487332e-05
 -1.86669270e-03  5.20399314e-04 -1.12522654e-03  2.96364230e-03
  2.02129360e-04  1.30338404e-04 -2.42145253e-05 -6.68431321e-05
 -1.79258273e-04 -4.97011149e-04  3.71346416e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787253        1
[INPUT] 0    0    [1    /1   ]  2712.09704688        1
[INPUT] 0    0    [1    /1   ]  617.494761739        1
[INPUT] 0    0    [1    /1   ]  174.931456272        1
[INPUT] 0    0    [1    /1   ]  20.3825394428        1
[INPUT] 0    0    [1    /1   ]  56.972058834         1
[INPUT] 0    0    [1    /1   ]  0.486094878319       1
[INPUT] 0    0    [1    /1   ]  8.08853802422        1
[INPUT] 0    0    [1    /1   ]  1.64671709231        1
[INPUT] 1    0    [1    /1   ]  5.85260875673        1
[INPUT] 1    0    [1    /1   ]  17.8513150522        1
[INPUT] 1    0    [1    /1   ]  69.4738919838        1
[INPUT] 1    0    [1    /1   ]  0.245286924383       1
[INPUT] 1    0    [1    /1   ]  2.08878361166        1
[INPUT] 1    0    [1    /1   ]  0.737314699725       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478725297766, 1.0]], [0, [2712.097046875164, 1.0]], [0, [617.4947617390923, 1.0]], [0, [174.93145627182602, 1.0]], [0, [20.38253944276544, 1.0]], [0, [56.97205883401685, 1.0]], [0, [0.4860948783189115, 1.0]], [0, [8.0885380242228, 1.0]], [0, [1.6467170923140104, 1.0]], [1, [5.852608756732911, 1.0]], [1, [17.851315052190493, 1.0]], [1, [69.47389198379798, 1.0]], [1, [0.24528692438273786, 1.0]], [1, [2.0887836116643554, 1.0]], [1, [0.7373146997254257, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.4787253]
bas 1, expnt(s) = [2712.09704688]
bas 2, expnt(s) = [617.49476174]
bas 3, expnt(s) = [174.93145627]
bas 4, expnt(s) = [20.38253944]
bas 5, expnt(s) = [56.97205883]
bas 6, expnt(s) = [0.48609488]
bas 7, expnt(s) = [8.08853802]
bas 8, expnt(s) = [1.64671709]
bas 9, expnt(s) = [5.85260876]
bas 10, expnt(s) = [17.85131505]
bas 11, expnt(s) = [69.47389198]
bas 12, expnt(s) = [0.24528692]
bas 13, expnt(s) = [2.08878361]
bas 14, expnt(s) = [0.7373147]
CPU time:       181.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209705e+03 9.49497758e+02
 6.17494762e+02 3.12960828e+02 1.74931456e+02 1.21525092e+02
 2.03825394e+01 2.42358772e+01 5.69720588e+01 5.23915756e+01
 4.86094878e-01 1.47080741e+00 8.08853802e+00 1.21176261e+01
 1.64671709e+00 3.67264769e+00 5.85260876e+00 2.65565258e+01
 1.78513151e+01 1.07046423e+02 6.94738920e+01 5.85142212e+02
 2.45286924e-01 5.03590339e-01 2.08878361e+00 7.32573504e+00
 7.37314700e-01 1.99319830e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999333674666918
cond(S) = 248.01084533702758
E1 = -183.583808468874  E_coul = 55.08181873691624
init E= -128.501989731958
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775169024003048  LUMO = 0.734608353437453
  mo_energy =
[-3.25538397e+01 -1.85130749e+00 -7.75169024e-01 -7.75169024e-01
 -7.75169024e-01  7.34608353e-01  7.34608353e-01  7.34608353e-01
  2.05506748e+00  3.43205037e+00  3.43205037e+00  3.43205037e+00
  1.19618787e+01  1.19618787e+01  1.19618787e+01  1.97706731e+01
  4.13946443e+01  4.13946443e+01  4.13946443e+01  9.45421757e+01
  1.69447683e+02  1.69447683e+02  1.69447683e+02  3.56868615e+02
  1.35021530e+03  5.83660402e+03  3.50991262e+04]
E1 = -182.0756944620668  E_coul = 53.542829866661506
cycle= 1 E= -128.532864595405  delta_E= -0.0309  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.52309
diis-c [-0.27362323  1.        ]
  HOMO = -0.884248684063891  LUMO = 0.712049519986958
  mo_energy =
[-3.28789624e+01 -1.96600342e+00 -8.84248684e-01 -8.84248684e-01
 -8.84248684e-01  7.12049520e-01  7.12049520e-01  7.12049520e-01
  1.97698753e+00  3.34646237e+00  3.34646237e+00  3.34646237e+00
  1.17885104e+01  1.17885104e+01  1.17885104e+01  1.95456174e+01
  4.11293514e+01  4.11293514e+01  4.11293514e+01  9.42358816e+01
  1.69112782e+02  1.69112782e+02  1.69112782e+02  3.56514940e+02
  1.34982366e+03  5.83618051e+03  3.50986813e+04]
E1 = -182.84334727540593  E_coul = 54.307854896869536
cycle= 2 E= -128.535492378536  delta_E= -0.00263  |g|= 0.104  |ddm|= 0.0721
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.265443
diis-c [-6.12729804e-04  3.35904578e-01  6.64095422e-01]
  HOMO = -0.848313603578351  LUMO = 0.719528758403576
  mo_energy =
[-3.27700782e+01 -1.92806092e+00 -8.48313604e-01 -8.48313604e-01
 -8.48313604e-01  7.19528758e-01  7.19528758e-01  7.19528758e-01
  2.00257436e+00  3.37439616e+00  3.37439616e+00  3.37439616e+00
  1.18460128e+01  1.18460128e+01  1.18460128e+01  1.96210680e+01
  4.12182443e+01  4.12182443e+01  4.12182443e+01  9.43387326e+01
  1.69223885e+02  1.69223885e+02  1.69223885e+02  3.56630666e+02
  1.34994569e+03  5.83630551e+03  3.50988074e+04]
E1 = -182.58339926946798  E_coul = 54.04697579277842
cycle= 3 E= -128.53642347669  delta_E= -0.000931  |g|= 0.00041  |ddm|= 0.025
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104581
diis-c [-9.50586997e-08 -2.04398669e-03 -2.57224018e-04  1.00230121e+00]
  HOMO = -0.848515341892087  LUMO = 0.719512310922741
  mo_energy =
[-3.27704809e+01 -1.92821394e+00 -8.48515342e-01 -8.48515342e-01
 -8.48515342e-01  7.19512311e-01  7.19512311e-01  7.19512311e-01
  2.00249811e+00  3.37428477e+00  3.37428477e+00  3.37428477e+00
  1.18457916e+01  1.18457916e+01  1.18457916e+01  1.96208134e+01
  4.12179219e+01  4.12179219e+01  4.12179219e+01  9.43383602e+01
  1.69223450e+02  1.69223450e+02  1.69223450e+02  3.56630171e+02
  1.34994505e+03  5.83630476e+03  3.50988066e+04]
E1 = -182.5838301982256  E_coul = 54.04740670761246
cycle= 4 E= -128.536423490613  delta_E= -1.39e-08  |g|= 6.98e-05  |ddm|= 0.000132
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183309
diis-c [-4.71329897e-10  1.10688389e-04  5.18263865e-04 -1.21568610e-01
  1.12093966e+00]
  HOMO = -0.848549827617445  LUMO = 0.719503209980319
  mo_energy =
[-3.27705491e+01 -1.92824417e+00 -8.48549828e-01 -8.48549828e-01
 -8.48549828e-01  7.19503210e-01  7.19503210e-01  7.19503210e-01
  2.00247431e+00  3.37425508e+00  3.37425508e+00  3.37425508e+00
  1.18457432e+01  1.18457432e+01  1.18457432e+01  1.96207596e+01
  4.12178608e+01  4.12178608e+01  4.12178608e+01  9.43382943e+01
  1.69223381e+02  1.69223381e+02  1.69223381e+02  3.56630097e+02
  1.34994497e+03  5.83630467e+03  3.50988065e+04]
E1 = -182.58397187437805  E_coul = 54.04754838332697
cycle= 5 E= -128.536423491051  delta_E= -4.38e-10  |g|= 2.15e-06  |ddm|= 1.9e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58397187437805  E_coul = 54.04754838332697
  HOMO = -0.848549074878842  LUMO = 0.719503370207214
  mo_energy =
[-3.27705473e+01 -1.92824302e+00 -8.48549075e-01 -8.48549075e-01
 -8.48549075e-01  7.19503370e-01  7.19503370e-01  7.19503370e-01
  2.00247513e+00  3.37425569e+00  3.37425569e+00  3.37425569e+00
  1.18457444e+01  1.18457444e+01  1.18457444e+01  1.96207614e+01
  4.12178626e+01  4.12178626e+01  4.12178626e+01  9.43382961e+01
  1.69223382e+02  1.69223382e+02  1.69223382e+02  3.56630099e+02
  1.34994497e+03  5.83630467e+03  3.50988065e+04]
E1 = -182.58396659535543  E_coul = 54.04754310430412
Extra cycle  E= -128.536423491051  delta_E= -2.27e-13  |g|= 7.31e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209705e+03 6.17494762e+02 1.74931456e+02
 2.03825394e+01 5.69720588e+01 4.86094878e-01 8.08853802e+00
 1.64671709e+00 5.85260876e+00 1.78513151e+01 6.94738920e+01
 2.45286924e-01 2.08878361e+00 7.37314700e-01]
E = -128.53642349105132
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787253        1
[INPUT] 0    0    [1    /1   ]  2712.09704688        1
[INPUT] 0    0    [1    /1   ]  617.494761739        1
[INPUT] 0    0    [1    /1   ]  174.931456272        1
[INPUT] 0    0    [1    /1   ]  20.3825394428        1
[INPUT] 0    0    [1    /1   ]  56.972058834         1
[INPUT] 0    0    [1    /1   ]  0.486094878319       1
[INPUT] 0    0    [1    /1   ]  8.08853802422        1
[INPUT] 0    0    [1    /1   ]  1.64671709231        1
[INPUT] 1    0    [1    /1   ]  5.85260875673        1
[INPUT] 1    0    [1    /1   ]  17.8513150522        1
[INPUT] 1    0    [1    /1   ]  69.4738919838        1
[INPUT] 1    0    [1    /1   ]  0.245286924383       1
[INPUT] 1    0    [1    /1   ]  2.08878361166        1
[INPUT] 1    0    [1    /1   ]  0.737314699725       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478725297766, 1.0]], [0, [2712.097046875164, 1.0]], [0, [617.4947617390923, 1.0]], [0, [174.93145627182602, 1.0]], [0, [20.38253944276544, 1.0]], [0, [56.97205883401685, 1.0]], [0, [0.4860948783189115, 1.0]], [0, [8.0885380242228, 1.0]], [0, [1.6467170923140104, 1.0]], [1, [5.852608756732911, 1.0]], [1, [17.851315052190493, 1.0]], [1, [69.47389198379798, 1.0]], [1, [0.24528692438273786, 1.0]], [1, [2.0887836116643554, 1.0]], [1, [0.7373146997254257, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.4787253]
bas 1, expnt(s) = [2712.09704688]
bas 2, expnt(s) = [617.49476174]
bas 3, expnt(s) = [174.93145627]
bas 4, expnt(s) = [20.38253944]
bas 5, expnt(s) = [56.97205883]
bas 6, expnt(s) = [0.48609488]
bas 7, expnt(s) = [8.08853802]
bas 8, expnt(s) = [1.64671709]
bas 9, expnt(s) = [5.85260876]
bas 10, expnt(s) = [17.85131505]
bas 11, expnt(s) = [69.47389198]
bas 12, expnt(s) = [0.24528692]
bas 13, expnt(s) = [2.08878361]
bas 14, expnt(s) = [0.7373147]
CPU time:       182.55
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209705e+03 9.49497758e+02
 6.17494762e+02 3.12960828e+02 1.74931456e+02 1.21525092e+02
 2.03825394e+01 2.42358772e+01 5.69720588e+01 5.23915756e+01
 4.86094878e-01 1.47080741e+00 8.08853802e+00 1.21176261e+01
 1.64671709e+00 3.67264769e+00 5.85260876e+00 2.65565258e+01
 1.78513151e+01 1.07046423e+02 6.94738920e+01 5.85142212e+02
 2.45286924e-01 5.03590339e-01 2.08878361e+00 7.32573504e+00
 7.37314700e-01 1.99319830e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999333674666918
cond(S) = 248.01084533702758
E1 = -183.583808468874  E_coul = 55.08181873691624
init E= -128.501989731958
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775169024003048  LUMO = 0.734608353437453
  mo_energy =
[-3.25538397e+01 -1.85130749e+00 -7.75169024e-01 -7.75169024e-01
 -7.75169024e-01  7.34608353e-01  7.34608353e-01  7.34608353e-01
  2.05506748e+00  3.43205037e+00  3.43205037e+00  3.43205037e+00
  1.19618787e+01  1.19618787e+01  1.19618787e+01  1.97706731e+01
  4.13946443e+01  4.13946443e+01  4.13946443e+01  9.45421757e+01
  1.69447683e+02  1.69447683e+02  1.69447683e+02  3.56868615e+02
  1.35021530e+03  5.83660402e+03  3.50991262e+04]
E1 = -182.0756944620668  E_coul = 53.542829866661506
cycle= 1 E= -128.532864595405  delta_E= -0.0309  |g|= 0.205  |ddm|= 0.164
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.52309
diis-c [-0.27362323  1.        ]
  HOMO = -0.884248684063891  LUMO = 0.712049519986958
  mo_energy =
[-3.28789624e+01 -1.96600342e+00 -8.84248684e-01 -8.84248684e-01
 -8.84248684e-01  7.12049520e-01  7.12049520e-01  7.12049520e-01
  1.97698753e+00  3.34646237e+00  3.34646237e+00  3.34646237e+00
  1.17885104e+01  1.17885104e+01  1.17885104e+01  1.95456174e+01
  4.11293514e+01  4.11293514e+01  4.11293514e+01  9.42358816e+01
  1.69112782e+02  1.69112782e+02  1.69112782e+02  3.56514940e+02
  1.34982366e+03  5.83618051e+03  3.50986813e+04]
E1 = -182.84334727540593  E_coul = 54.307854896869536
cycle= 2 E= -128.535492378536  delta_E= -0.00263  |g|= 0.104  |ddm|= 0.0721
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.265443
diis-c [-6.12729804e-04  3.35904578e-01  6.64095422e-01]
  HOMO = -0.848313603578351  LUMO = 0.719528758403576
  mo_energy =
[-3.27700782e+01 -1.92806092e+00 -8.48313604e-01 -8.48313604e-01
 -8.48313604e-01  7.19528758e-01  7.19528758e-01  7.19528758e-01
  2.00257436e+00  3.37439616e+00  3.37439616e+00  3.37439616e+00
  1.18460128e+01  1.18460128e+01  1.18460128e+01  1.96210680e+01
  4.12182443e+01  4.12182443e+01  4.12182443e+01  9.43387326e+01
  1.69223885e+02  1.69223885e+02  1.69223885e+02  3.56630666e+02
  1.34994569e+03  5.83630551e+03  3.50988074e+04]
E1 = -182.58339926946798  E_coul = 54.04697579277842
cycle= 3 E= -128.53642347669  delta_E= -0.000931  |g|= 0.00041  |ddm|= 0.025
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104581
diis-c [-9.50586997e-08 -2.04398669e-03 -2.57224018e-04  1.00230121e+00]
  HOMO = -0.848515341892087  LUMO = 0.719512310922741
  mo_energy =
[-3.27704809e+01 -1.92821394e+00 -8.48515342e-01 -8.48515342e-01
 -8.48515342e-01  7.19512311e-01  7.19512311e-01  7.19512311e-01
  2.00249811e+00  3.37428477e+00  3.37428477e+00  3.37428477e+00
  1.18457916e+01  1.18457916e+01  1.18457916e+01  1.96208134e+01
  4.12179219e+01  4.12179219e+01  4.12179219e+01  9.43383602e+01
  1.69223450e+02  1.69223450e+02  1.69223450e+02  3.56630171e+02
  1.34994505e+03  5.83630476e+03  3.50988066e+04]
E1 = -182.5838301982256  E_coul = 54.04740670761246
cycle= 4 E= -128.536423490613  delta_E= -1.39e-08  |g|= 6.98e-05  |ddm|= 0.000132
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000183309
diis-c [-4.71329897e-10  1.10688389e-04  5.18263865e-04 -1.21568610e-01
  1.12093966e+00]
  HOMO = -0.848549827617445  LUMO = 0.719503209980319
  mo_energy =
[-3.27705491e+01 -1.92824417e+00 -8.48549828e-01 -8.48549828e-01
 -8.48549828e-01  7.19503210e-01  7.19503210e-01  7.19503210e-01
  2.00247431e+00  3.37425508e+00  3.37425508e+00  3.37425508e+00
  1.18457432e+01  1.18457432e+01  1.18457432e+01  1.96207596e+01
  4.12178608e+01  4.12178608e+01  4.12178608e+01  9.43382943e+01
  1.69223381e+02  1.69223381e+02  1.69223381e+02  3.56630097e+02
  1.34994497e+03  5.83630467e+03  3.50988065e+04]
E1 = -182.58397187437805  E_coul = 54.04754838332697
cycle= 5 E= -128.536423491051  delta_E= -4.38e-10  |g|= 2.15e-06  |ddm|= 1.9e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58397187437805  E_coul = 54.04754838332697
  HOMO = -0.848549074878842  LUMO = 0.719503370207214
  mo_energy =
[-3.27705473e+01 -1.92824302e+00 -8.48549075e-01 -8.48549075e-01
 -8.48549075e-01  7.19503370e-01  7.19503370e-01  7.19503370e-01
  2.00247513e+00  3.37425569e+00  3.37425569e+00  3.37425569e+00
  1.18457444e+01  1.18457444e+01  1.18457444e+01  1.96207614e+01
  4.12178626e+01  4.12178626e+01  4.12178626e+01  9.43382961e+01
  1.69223382e+02  1.69223382e+02  1.69223382e+02  3.56630099e+02
  1.34994497e+03  5.83630467e+03  3.50988065e+04]
E1 = -182.58396659535543  E_coul = 54.04754310430412
Extra cycle  E= -128.536423491051  delta_E= -2.27e-13  |g|= 7.31e-07  |ddm|= 1.15e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 248.01084533702758
E1 = -182.58396659535543  E_coul = 54.04754310430412
init E= -128.536423491051
    CPU time for initialize scf      0.33 sec, wall time      0.32 sec
  HOMO = -0.848549463697201  LUMO = 0.71950328933637
  mo_energy =
[-3.27705484e+01 -1.92824336e+00 -8.48549464e-01 -8.48549464e-01
 -8.48549464e-01  7.19503289e-01  7.19503289e-01  7.19503289e-01
  2.00247491e+00  3.37425539e+00  3.37425539e+00  3.37425539e+00
  1.18457438e+01  1.18457438e+01  1.18457438e+01  1.96207606e+01
  4.12178617e+01  4.12178617e+01  4.12178617e+01  9.43382950e+01
  1.69223381e+02  1.69223381e+02  1.69223381e+02  3.56630097e+02
  1.34994497e+03  5.83630467e+03  3.50988065e+04]
E1 = -182.58396934301834  E_coul = 54.04754585196677
cycle= 1 E= -128.536423491052  delta_E= -2.56e-13  |g|= 3.81e-07  |ddm|= 2.24e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58396934301834  E_coul = 54.04754585196677
  HOMO = -0.848549272213211  LUMO = 0.71950332967845
  mo_energy =
[-3.27705479e+01 -1.92824315e+00 -8.48549272e-01 -8.48549272e-01
 -8.48549272e-01  7.19503330e-01  7.19503330e-01  7.19503330e-01
  2.00247505e+00  3.37425554e+00  3.37425554e+00  3.37425554e+00
  1.18457441e+01  1.18457441e+01  1.18457441e+01  1.96207610e+01
  4.12178621e+01  4.12178621e+01  4.12178621e+01  9.43382956e+01
  1.69223382e+02  1.69223382e+02  1.69223382e+02  3.56630098e+02
  1.34994497e+03  5.83630467e+03  3.50988065e+04]
E1 = -182.58396795198516  E_coul = 54.04754446093354
Extra cycle  E= -128.536423491052  delta_E= -2.84e-14  |g|= 1.88e-07  |ddm|= 1.51e-07
    CPU time for scf_cycle      0.40 sec, wall time      0.39 sec
exp = [1.80764787e+04 2.71209705e+03 6.17494762e+02 1.74931456e+02
 2.03825394e+01 5.69720588e+01 4.86094878e-01 8.08853802e+00
 1.64671709e+00 5.85260876e+00 1.78513151e+01 6.94738920e+01
 2.45286924e-01 2.08878361e+00 7.37314700e-01]
grad_E = [ 5.20473079e-09 -2.71321463e-07  5.44305506e-06 -6.17618261e-05
 -1.58768937e-03  4.36795717e-04 -3.30206189e-03  2.53745537e-03
  6.56295669e-04 -2.12878233e-04  1.03880803e-04 -8.81883019e-05
  6.17329285e-04  6.43177178e-05 -2.25648301e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787253        1
[INPUT] 0    0    [1    /1   ]  2712.0970459         1
[INPUT] 0    0    [1    /1   ]  617.494766929        1
[INPUT] 0    0    [1    /1   ]  174.931749134        1
[INPUT] 0    0    [1    /1   ]  20.4071162281        1
[INPUT] 0    0    [1    /1   ]  56.9661222059        1
[INPUT] 0    0    [1    /1   ]  0.484688156918       1
[INPUT] 0    0    [1    /1   ]  8.04550426365        1
[INPUT] 0    0    [1    /1   ]  1.64604438712        1
[INPUT] 1    0    [1    /1   ]  5.92062532975        1
[INPUT] 1    0    [1    /1   ]  18.0692666664        1
[INPUT] 1    0    [1    /1   ]  69.1428772739        1
[INPUT] 1    0    [1    /1   ]  0.247109906305       1
[INPUT] 1    0    [1    /1   ]  2.1117273476         1
[INPUT] 1    0    [1    /1   ]  0.744808309563       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478725323675, 1.0]], [0, [2712.097045897562, 1.0]], [0, [617.4947669290067, 1.0]], [0, [174.93174913439805, 1.0]], [0, [20.40711622806266, 1.0]], [0, [56.966122205872495, 1.0]], [0, [0.4846881569181418, 1.0]], [0, [8.04550426364861, 1.0]], [0, [1.6460443871166426, 1.0]], [1, [5.92062532975486, 1.0]], [1, [18.06926666644139, 1.0]], [1, [69.14287727386005, 1.0]], [1, [0.24710990630520296, 1.0]], [1, [2.1117273476022853, 1.0]], [1, [0.7448083095626641, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872532]
bas 1, expnt(s) = [2712.0970459]
bas 2, expnt(s) = [617.49476693]
bas 3, expnt(s) = [174.93174913]
bas 4, expnt(s) = [20.40711623]
bas 5, expnt(s) = [56.96612221]
bas 6, expnt(s) = [0.48468816]
bas 7, expnt(s) = [8.04550426]
bas 8, expnt(s) = [1.64604439]
bas 9, expnt(s) = [5.92062533]
bas 10, expnt(s) = [18.06926667]
bas 11, expnt(s) = [69.14287727]
bas 12, expnt(s) = [0.24710991]
bas 13, expnt(s) = [2.11172735]
bas 14, expnt(s) = [0.74480831]
CPU time:       185.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209705e+03 9.49497758e+02
 6.17494767e+02 3.12960830e+02 1.74931749e+02 1.21525244e+02
 2.04071162e+01 2.42577912e+01 5.69661222e+01 5.23874811e+01
 4.84688157e-01 1.46761395e+00 8.04550426e+00 1.20692415e+01
 1.64604439e+00 3.67152239e+00 5.92062533e+00 2.69428706e+01
 1.80692667e+01 1.08682608e+02 6.91428773e+01 5.81659335e+02
 2.47109906e-01 5.08273056e-01 2.11172735e+00 7.42645746e+00
 7.44808310e-01 2.01855243e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999326704579445
cond(S) = 246.4069699538242
E1 = -183.58438026298583  E_coul = 55.08185844805972
init E= -128.502521814926
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775163361855308  LUMO = 0.74190601601336
  mo_energy =
[-3.25539069e+01 -1.85128516e+00 -7.75163362e-01 -7.75163362e-01
 -7.75163362e-01  7.41906016e-01  7.41906016e-01  7.41906016e-01
  2.04880732e+00  3.47039832e+00  3.47039832e+00  3.47039832e+00
  1.21054479e+01  1.21054479e+01  1.21054479e+01  1.97042975e+01
  4.19441406e+01  4.19441406e+01  4.19441406e+01  9.44335835e+01
  1.69906599e+02  1.69906599e+02  1.69906599e+02  3.56768854e+02
  1.35012480e+03  5.83652410e+03  3.50990601e+04]
E1 = -182.07485041355474  E_coul = 53.54190744373164
cycle= 1 E= -128.532942969823  delta_E= -0.0304  |g|= 0.205  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.523586
diis-c [-0.27414237  1.        ]
  HOMO = -0.88432654416223  LUMO = 0.719018144243014
  mo_energy =
[-3.28792339e+01 -1.96600260e+00 -8.84326544e-01 -8.84326544e-01
 -8.84326544e-01  7.19018144e-01  7.19018144e-01  7.19018144e-01
  1.97088058e+00  3.38392161e+00  3.38392161e+00  3.38392161e+00
  1.19309564e+01  1.19309564e+01  1.19309564e+01  1.94793207e+01
  4.16779376e+01  4.16779376e+01  4.16779376e+01  9.41270874e+01
  1.69571601e+02  1.69571601e+02  1.69571601e+02  3.56414925e+02
  1.34973287e+03  5.83610030e+03  3.50986149e+04]
E1 = -182.84295872555052  E_coul = 54.30738382799093
cycle= 2 E= -128.53557489756  delta_E= -0.00263  |g|= 0.104  |ddm|= 0.0722
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.265555
diis-c [-6.13142437e-04  3.35787116e-01  6.64212884e-01]
  HOMO = -0.848364977367918  LUMO = 0.726606547929169
  mo_energy =
[-3.27702612e+01 -1.92803237e+00 -8.48364977e-01 -8.48364977e-01
 -8.48364977e-01  7.26606548e-01  7.26606548e-01  7.26606548e-01
  1.99643206e+00  3.41214757e+00  3.41214757e+00  3.41214757e+00
  1.19888446e+01  1.19888446e+01  1.19888446e+01  1.95547513e+01
  4.17671596e+01  4.17671596e+01  4.17671596e+01  9.42300195e+01
  1.69682749e+02  1.69682749e+02  1.69682749e+02  3.56530745e+02
  1.34985499e+03  5.83622539e+03  3.50987411e+04]
E1 = -182.5828624961362  E_coul = 54.04635539737268
cycle= 3 E= -128.536507098764  delta_E= -0.000932  |g|= 0.000424  |ddm|= 0.025
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109558
diis-c [-1.02841865e-07 -2.06658860e-03 -1.22294411e-04  1.00218888e+00]
  HOMO = -0.848570467680887  LUMO = 0.726589486315963
  mo_energy =
[-3.27706735e+01 -1.92818443e+00 -8.48570468e-01 -8.48570468e-01
 -8.48570468e-01  7.26589486e-01  7.26589486e-01  7.26589486e-01
  1.99635719e+00  3.41203272e+00  3.41203272e+00  3.41203272e+00
  1.19886174e+01  1.19886174e+01  1.19886174e+01  1.95544917e+01
  4.17668291e+01  4.17668291e+01  4.17668291e+01  9.42296378e+01
  1.69682304e+02  1.69682304e+02  1.69682304e+02  3.56530238e+02
  1.34985434e+03  5.83622462e+03  3.50987403e+04]
E1 = -182.58332616991422  E_coul = 54.04681905624936
cycle= 4 E= -128.536507113665  delta_E= -1.49e-08  |g|= 7.24e-05  |ddm|= 0.000131
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000192769
diis-c [-5.18818548e-10  1.24386404e-04  5.37170556e-04 -1.28897203e-01
  1.12823565e+00]
  HOMO = -0.848605762552311  LUMO = 0.726580204256935
  mo_energy =
[-3.27707441e+01 -1.92821436e+00 -8.48605763e-01 -8.48605763e-01
 -8.48605763e-01  7.26580204e-01  7.26580204e-01  7.26580204e-01
  1.99633380e+00  3.41200233e+00  3.41200233e+00  3.41200233e+00
  1.19885677e+01  1.19885677e+01  1.19885677e+01  1.95544369e+01
  4.17667662e+01  4.17667662e+01  4.17667662e+01  9.42295698e+01
  1.69682231e+02  1.69682231e+02  1.69682231e+02  3.56530161e+02
  1.34985426e+03  5.83622453e+03  3.50987402e+04]
E1 = -182.5834758548593  E_coul = 54.04696874071568
cycle= 5 E= -128.536507114144  delta_E= -4.79e-10  |g|= 2.52e-06  |ddm|= 1.91e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5834758548593  E_coul = 54.04696874071568
  HOMO = -0.848604796700035  LUMO = 0.726580434902729
  mo_energy =
[-3.27707419e+01 -1.92821291e+00 -8.48604797e-01 -8.48604797e-01
 -8.48604797e-01  7.26580435e-01  7.26580435e-01  7.26580435e-01
  1.99633487e+00  3.41200315e+00  3.41200315e+00  3.41200315e+00
  1.19885693e+01  1.19885693e+01  1.19885693e+01  1.95544389e+01
  4.17667683e+01  4.17667683e+01  4.17667683e+01  9.42295719e+01
  1.69682233e+02  1.69682233e+02  1.69682233e+02  3.56530163e+02
  1.34985426e+03  5.83622453e+03  3.50987402e+04]
E1 = -182.5834700331302  E_coul = 54.04696291898607
Extra cycle  E= -128.536507114144  delta_E= -4.83e-13  |g|= 8.28e-07  |ddm|= 1.35e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209705e+03 6.17494767e+02 1.74931749e+02
 2.04071162e+01 5.69661222e+01 4.84688157e-01 8.04550426e+00
 1.64604439e+00 5.92062533e+00 1.80692667e+01 6.91428773e+01
 2.47109906e-01 2.11172735e+00 7.44808310e-01]
E = -128.53650711414411
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787253        1
[INPUT] 0    0    [1    /1   ]  2712.0970459         1
[INPUT] 0    0    [1    /1   ]  617.494766929        1
[INPUT] 0    0    [1    /1   ]  174.931749134        1
[INPUT] 0    0    [1    /1   ]  20.4071162281        1
[INPUT] 0    0    [1    /1   ]  56.9661222059        1
[INPUT] 0    0    [1    /1   ]  0.484688156918       1
[INPUT] 0    0    [1    /1   ]  8.04550426365        1
[INPUT] 0    0    [1    /1   ]  1.64604438712        1
[INPUT] 1    0    [1    /1   ]  5.92062532975        1
[INPUT] 1    0    [1    /1   ]  18.0692666664        1
[INPUT] 1    0    [1    /1   ]  69.1428772739        1
[INPUT] 1    0    [1    /1   ]  0.247109906305       1
[INPUT] 1    0    [1    /1   ]  2.1117273476         1
[INPUT] 1    0    [1    /1   ]  0.744808309563       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478725323675, 1.0]], [0, [2712.097045897562, 1.0]], [0, [617.4947669290067, 1.0]], [0, [174.93174913439805, 1.0]], [0, [20.40711622806266, 1.0]], [0, [56.966122205872495, 1.0]], [0, [0.4846881569181418, 1.0]], [0, [8.04550426364861, 1.0]], [0, [1.6460443871166426, 1.0]], [1, [5.92062532975486, 1.0]], [1, [18.06926666644139, 1.0]], [1, [69.14287727386005, 1.0]], [1, [0.24710990630520296, 1.0]], [1, [2.1117273476022853, 1.0]], [1, [0.7448083095626641, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872532]
bas 1, expnt(s) = [2712.0970459]
bas 2, expnt(s) = [617.49476693]
bas 3, expnt(s) = [174.93174913]
bas 4, expnt(s) = [20.40711623]
bas 5, expnt(s) = [56.96612221]
bas 6, expnt(s) = [0.48468816]
bas 7, expnt(s) = [8.04550426]
bas 8, expnt(s) = [1.64604439]
bas 9, expnt(s) = [5.92062533]
bas 10, expnt(s) = [18.06926667]
bas 11, expnt(s) = [69.14287727]
bas 12, expnt(s) = [0.24710991]
bas 13, expnt(s) = [2.11172735]
bas 14, expnt(s) = [0.74480831]
CPU time:       186.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209705e+03 9.49497758e+02
 6.17494767e+02 3.12960830e+02 1.74931749e+02 1.21525244e+02
 2.04071162e+01 2.42577912e+01 5.69661222e+01 5.23874811e+01
 4.84688157e-01 1.46761395e+00 8.04550426e+00 1.20692415e+01
 1.64604439e+00 3.67152239e+00 5.92062533e+00 2.69428706e+01
 1.80692667e+01 1.08682608e+02 6.91428773e+01 5.81659335e+02
 2.47109906e-01 5.08273056e-01 2.11172735e+00 7.42645746e+00
 7.44808310e-01 2.01855243e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999326704579445
cond(S) = 246.4069699538242
E1 = -183.58438026298583  E_coul = 55.08185844805972
init E= -128.502521814926
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775163361855308  LUMO = 0.74190601601336
  mo_energy =
[-3.25539069e+01 -1.85128516e+00 -7.75163362e-01 -7.75163362e-01
 -7.75163362e-01  7.41906016e-01  7.41906016e-01  7.41906016e-01
  2.04880732e+00  3.47039832e+00  3.47039832e+00  3.47039832e+00
  1.21054479e+01  1.21054479e+01  1.21054479e+01  1.97042975e+01
  4.19441406e+01  4.19441406e+01  4.19441406e+01  9.44335835e+01
  1.69906599e+02  1.69906599e+02  1.69906599e+02  3.56768854e+02
  1.35012480e+03  5.83652410e+03  3.50990601e+04]
E1 = -182.07485041355474  E_coul = 53.54190744373164
cycle= 1 E= -128.532942969823  delta_E= -0.0304  |g|= 0.205  |ddm|= 0.165
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.523586
diis-c [-0.27414237  1.        ]
  HOMO = -0.88432654416223  LUMO = 0.719018144243014
  mo_energy =
[-3.28792339e+01 -1.96600260e+00 -8.84326544e-01 -8.84326544e-01
 -8.84326544e-01  7.19018144e-01  7.19018144e-01  7.19018144e-01
  1.97088058e+00  3.38392161e+00  3.38392161e+00  3.38392161e+00
  1.19309564e+01  1.19309564e+01  1.19309564e+01  1.94793207e+01
  4.16779376e+01  4.16779376e+01  4.16779376e+01  9.41270874e+01
  1.69571601e+02  1.69571601e+02  1.69571601e+02  3.56414925e+02
  1.34973287e+03  5.83610030e+03  3.50986149e+04]
E1 = -182.84295872555052  E_coul = 54.30738382799093
cycle= 2 E= -128.53557489756  delta_E= -0.00263  |g|= 0.104  |ddm|= 0.0722
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.265555
diis-c [-6.13142437e-04  3.35787116e-01  6.64212884e-01]
  HOMO = -0.848364977367918  LUMO = 0.726606547929169
  mo_energy =
[-3.27702612e+01 -1.92803237e+00 -8.48364977e-01 -8.48364977e-01
 -8.48364977e-01  7.26606548e-01  7.26606548e-01  7.26606548e-01
  1.99643206e+00  3.41214757e+00  3.41214757e+00  3.41214757e+00
  1.19888446e+01  1.19888446e+01  1.19888446e+01  1.95547513e+01
  4.17671596e+01  4.17671596e+01  4.17671596e+01  9.42300195e+01
  1.69682749e+02  1.69682749e+02  1.69682749e+02  3.56530745e+02
  1.34985499e+03  5.83622539e+03  3.50987411e+04]
E1 = -182.5828624961362  E_coul = 54.04635539737268
cycle= 3 E= -128.536507098764  delta_E= -0.000932  |g|= 0.000424  |ddm|= 0.025
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00109558
diis-c [-1.02841865e-07 -2.06658860e-03 -1.22294411e-04  1.00218888e+00]
  HOMO = -0.848570467680887  LUMO = 0.726589486315963
  mo_energy =
[-3.27706735e+01 -1.92818443e+00 -8.48570468e-01 -8.48570468e-01
 -8.48570468e-01  7.26589486e-01  7.26589486e-01  7.26589486e-01
  1.99635719e+00  3.41203272e+00  3.41203272e+00  3.41203272e+00
  1.19886174e+01  1.19886174e+01  1.19886174e+01  1.95544917e+01
  4.17668291e+01  4.17668291e+01  4.17668291e+01  9.42296378e+01
  1.69682304e+02  1.69682304e+02  1.69682304e+02  3.56530238e+02
  1.34985434e+03  5.83622462e+03  3.50987403e+04]
E1 = -182.58332616991422  E_coul = 54.04681905624936
cycle= 4 E= -128.536507113665  delta_E= -1.49e-08  |g|= 7.24e-05  |ddm|= 0.000131
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000192769
diis-c [-5.18818548e-10  1.24386404e-04  5.37170556e-04 -1.28897203e-01
  1.12823565e+00]
  HOMO = -0.848605762552311  LUMO = 0.726580204256935
  mo_energy =
[-3.27707441e+01 -1.92821436e+00 -8.48605763e-01 -8.48605763e-01
 -8.48605763e-01  7.26580204e-01  7.26580204e-01  7.26580204e-01
  1.99633380e+00  3.41200233e+00  3.41200233e+00  3.41200233e+00
  1.19885677e+01  1.19885677e+01  1.19885677e+01  1.95544369e+01
  4.17667662e+01  4.17667662e+01  4.17667662e+01  9.42295698e+01
  1.69682231e+02  1.69682231e+02  1.69682231e+02  3.56530161e+02
  1.34985426e+03  5.83622453e+03  3.50987402e+04]
E1 = -182.5834758548593  E_coul = 54.04696874071568
cycle= 5 E= -128.536507114144  delta_E= -4.79e-10  |g|= 2.52e-06  |ddm|= 1.91e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5834758548593  E_coul = 54.04696874071568
  HOMO = -0.848604796700035  LUMO = 0.726580434902729
  mo_energy =
[-3.27707419e+01 -1.92821291e+00 -8.48604797e-01 -8.48604797e-01
 -8.48604797e-01  7.26580435e-01  7.26580435e-01  7.26580435e-01
  1.99633487e+00  3.41200315e+00  3.41200315e+00  3.41200315e+00
  1.19885693e+01  1.19885693e+01  1.19885693e+01  1.95544389e+01
  4.17667683e+01  4.17667683e+01  4.17667683e+01  9.42295719e+01
  1.69682233e+02  1.69682233e+02  1.69682233e+02  3.56530163e+02
  1.34985426e+03  5.83622453e+03  3.50987402e+04]
E1 = -182.5834700331302  E_coul = 54.04696291898607
Extra cycle  E= -128.536507114144  delta_E= -4.83e-13  |g|= 8.28e-07  |ddm|= 1.35e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 246.4069699538242
E1 = -182.5834700331302  E_coul = 54.04696291898607
init E= -128.536507114144
    CPU time for initialize scf      0.31 sec, wall time      0.31 sec
  HOMO = -0.84860522202433  LUMO = 0.726580348693534
  mo_energy =
[-3.27707432e+01 -1.92821328e+00 -8.48605222e-01 -8.48605222e-01
 -8.48605222e-01  7.26580349e-01  7.26580349e-01  7.26580349e-01
  1.99633463e+00  3.41200282e+00  3.41200282e+00  3.41200282e+00
  1.19885686e+01  1.19885686e+01  1.19885686e+01  1.95544381e+01
  4.17667673e+01  4.17667673e+01  4.17667673e+01  9.42295707e+01
  1.69682232e+02  1.69682232e+02  1.69682232e+02  3.56530161e+02
  1.34985425e+03  5.83622453e+03  3.50987402e+04]
E1 = -182.58347318310723  E_coul = 54.04696606896319
cycle= 1 E= -128.536507114144  delta_E= 5.68e-14  |g|= 4.37e-07  |ddm|= 2.7e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58347318310723  E_coul = 54.04696606896319
  HOMO = -0.848605002050766  LUMO = 0.726580396192823
  mo_energy =
[-3.27707425e+01 -1.92821303e+00 -8.48605002e-01 -8.48605002e-01
 -8.48605002e-01  7.26580396e-01  7.26580396e-01  7.26580396e-01
  1.99633480e+00  3.41200299e+00  3.41200299e+00  3.41200299e+00
  1.19885690e+01  1.19885690e+01  1.19885690e+01  1.95544386e+01
  4.17667679e+01  4.17667679e+01  4.17667679e+01  9.42295713e+01
  1.69682233e+02  1.69682233e+02  1.69682233e+02  3.56530162e+02
  1.34985426e+03  5.83622453e+03  3.50987402e+04]
E1 = -182.5834716067809  E_coul = 54.04696449263675
Extra cycle  E= -128.536507114144  delta_E= -1.14e-13  |g|= 2.13e-07  |ddm|= 1.75e-07
    CPU time for scf_cycle      0.39 sec, wall time      0.39 sec
exp = [1.80764787e+04 2.71209705e+03 6.17494767e+02 1.74931749e+02
 2.04071162e+01 5.69661222e+01 4.84688157e-01 8.04550426e+00
 1.64604439e+00 5.92062533e+00 1.80692667e+01 6.91428773e+01
 2.47109906e-01 2.11172735e+00 7.44808310e-01]
grad_E = [ 4.19616877e-09 -2.19038616e-07  4.39494079e-06 -5.02030240e-05
 -1.31677940e-03  3.56168695e-04 -5.16941501e-03  2.12591955e-03
  1.08381477e-03 -4.83590336e-04  2.25302492e-04 -1.06819636e-04
  7.57943608e-04  4.52065944e-04 -4.07413391e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787248        1
[INPUT] 0    0    [1    /1   ]  2712.09707088        1
[INPUT] 0    0    [1    /1   ]  617.494323718        1
[INPUT] 0    0    [1    /1   ]  174.935349989        1
[INPUT] 0    0    [1    /1   ]  20.4405485325        1
[INPUT] 0    0    [1    /1   ]  56.9554984396        1
[INPUT] 0    0    [1    /1   ]  0.483790168095       1
[INPUT] 0    0    [1    /1   ]  7.99728850162        1
[INPUT] 0    0    [1    /1   ]  1.64645106358        1
[INPUT] 1    0    [1    /1   ]  6.1205817385         1
[INPUT] 1    0    [1    /1   ]  18.7354460755        1
[INPUT] 1    0    [1    /1   ]  70.2699671432        1
[INPUT] 1    0    [1    /1   ]  0.25188077944        1
[INPUT] 1    0    [1    /1   ]  2.17534738332        1
[INPUT] 1    0    [1    /1   ]  0.764531676702       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47872481297, 1.0]], [0, [2712.0970708827704, 1.0]], [0, [617.4943237184552, 1.0]], [0, [174.93534998855145, 1.0]], [0, [20.440548532529967, 1.0]], [0, [56.95549843964879, 1.0]], [0, [0.48379016809503156, 1.0]], [0, [7.997288501620269, 1.0]], [0, [1.6464510635831993, 1.0]], [1, [6.120581738503693, 1.0]], [1, [18.735446075538196, 1.0]], [1, [70.26996714318729, 1.0]], [1, [0.2518807794402174, 1.0]], [1, [2.17534738331824, 1.0]], [1, [0.7645316767020722, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872481]
bas 1, expnt(s) = [2712.09707088]
bas 2, expnt(s) = [617.49432372]
bas 3, expnt(s) = [174.93534999]
bas 4, expnt(s) = [20.44054853]
bas 5, expnt(s) = [56.95549844]
bas 6, expnt(s) = [0.48379017]
bas 7, expnt(s) = [7.9972885]
bas 8, expnt(s) = [1.64645106]
bas 9, expnt(s) = [6.12058174]
bas 10, expnt(s) = [18.73544608]
bas 11, expnt(s) = [70.26996714]
bas 12, expnt(s) = [0.25188078]
bas 13, expnt(s) = [2.17534738]
bas 14, expnt(s) = [0.76453168]
CPU time:       190.03
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209707e+03 9.49497764e+02
 6.17494324e+02 3.12960662e+02 1.74935350e+02 1.21527121e+02
 2.04405485e+01 2.42875906e+01 5.69554984e+01 5.23801535e+01
 4.83790168e-01 1.46557417e+00 7.99728850e+00 1.20149536e+01
 1.64645106e+00 3.67220269e+00 6.12058174e+00 2.80850545e+01
 1.87354461e+01 1.13714132e+02 7.02699671e+01 5.93535337e+02
 2.51880779e-01 5.20568851e-01 2.17534738e+00 7.70717406e+00
 7.64531677e-01 2.08558910e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999299402915792
cond(S) = 244.77788004349324
E1 = -183.58504449733596  E_coul = 55.0818744529608
init E= -128.503170044375
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775168904662822  LUMO = 0.761232582855494
  mo_energy =
[-3.25539832e+01 -1.85125728e+00 -7.75168905e-01 -7.75168905e-01
 -7.75168905e-01  7.61232583e-01  7.61232583e-01  7.61232583e-01
  2.04513791e+00  3.57327449e+00  3.57327449e+00  3.57327449e+00
  1.25140076e+01  1.25140076e+01  1.25140076e+01  1.96392379e+01
  4.35765602e+01  4.35765602e+01  4.35765602e+01  9.43293795e+01
  1.74638377e+02  1.74638377e+02  1.74638377e+02  3.56677367e+02
  1.35004539e+03  5.83645576e+03  3.50990039e+04]
E1 = -182.07625438786246  E_coul = 53.54315825239546
cycle= 1 E= -128.533096135467  delta_E= -0.0299  |g|= 0.205  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.522275
diis-c [-0.27277097  1.        ]
  HOMO = -0.884243929462958  LUMO = 0.737536892419275
  mo_energy =
[-3.28791172e+01 -1.96581425e+00 -8.84243929e-01 -8.84243929e-01
 -8.84243929e-01  7.37536892e-01  7.37536892e-01  7.37536892e-01
  1.96744484e+00  3.48462891e+00  3.48462891e+00  3.48462891e+00
  1.23366898e+01  1.23366898e+01  1.23366898e+01  1.94146660e+01
  4.33081757e+01  4.33081757e+01  4.33081757e+01  9.40230558e+01
  1.74302869e+02  1.74302869e+02  1.74302869e+02  3.56323589e+02
  1.34965358e+03  5.83603208e+03  3.50985587e+04]
E1 = -182.84339188923124  E_coul = 54.3076659713606
cycle= 2 E= -128.535725917871  delta_E= -0.00263  |g|= 0.104  |ddm|= 0.0724
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.264598
diis-c [-6.13225150e-04  3.35534713e-01  6.64465287e-01]
  HOMO = -0.848318918817172  LUMO = 0.745390713517631
  mo_energy =
[-3.27702208e+01 -1.92788423e+00 -8.48318919e-01 -8.48318919e-01
 -8.48318919e-01  7.45390714e-01  7.45390714e-01  7.45390714e-01
  1.99293106e+00  3.51356579e+00  3.51356579e+00  3.51356579e+00
  1.23955339e+01  1.23955339e+01  1.23955339e+01  1.94899482e+01
  4.33981362e+01  4.33981362e+01  4.33981362e+01  9.41259126e+01
  1.74414117e+02  1.74414117e+02  1.74414117e+02  3.56439333e+02
  1.34977562e+03  5.83615708e+03  3.50986848e+04]
E1 = -182.5836996827678  E_coul = 54.0470439407598
cycle= 3 E= -128.536655742008  delta_E= -0.00093  |g|= 0.000441  |ddm|= 0.0251
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115223
diis-c [-1.10708497e-07 -2.10014872e-03  3.27141729e-05  1.00206743e+00]
  HOMO = -0.848529319249451  LUMO = 0.745372123868757
  mo_energy =
[-3.27706462e+01 -1.92803709e+00 -8.48529319e-01 -8.48529319e-01
 -8.48529319e-01  7.45372124e-01  7.45372124e-01  7.45372124e-01
  1.99285609e+00  3.51344419e+00  3.51344419e+00  3.51344419e+00
  1.23952961e+01  1.23952961e+01  1.23952961e+01  1.94896811e+01
  4.33977925e+01  4.33977925e+01  4.33977925e+01  9.41255181e+01
  1.74413655e+02  1.74413655e+02  1.74413655e+02  3.56438809e+02
  1.34977495e+03  5.83615629e+03  3.50986840e+04]
E1 = -182.5842075625248  E_coul = 54.047551804435365
cycle= 4 E= -128.536655758089  delta_E= -1.61e-08  |g|= 7.48e-05  |ddm|= 0.000129
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000200971
diis-c [-5.60141654e-10  1.38742306e-04  5.49540195e-04 -1.35581930e-01
  1.13489365e+00]
  HOMO = -0.848565227402858  LUMO = 0.745362542661982
  mo_energy =
[-3.27707190e+01 -1.92806660e+00 -8.48565227e-01 -8.48565227e-01
 -8.48565227e-01  7.45362543e-01  7.45362543e-01  7.45362543e-01
  1.99283322e+00  3.51341286e+00  3.51341286e+00  3.51341286e+00
  1.23952451e+01  1.23952451e+01  1.23952451e+01  1.94896253e+01
  4.33977278e+01  4.33977278e+01  4.33977278e+01  9.41254481e+01
  1.74413580e+02  1.74413580e+02  1.74413580e+02  3.56438729e+02
  1.34977486e+03  5.83615620e+03  3.50986839e+04]
E1 = -182.58436499105872  E_coul = 54.04770923245132
cycle= 5 E= -128.536655758607  delta_E= -5.18e-10  |g|= 2.91e-06  |ddm|= 1.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58436499105872  E_coul = 54.04770923245132
  HOMO = -0.848564029077123  LUMO = 0.745362856120392
  mo_energy =
[-3.27707163e+01 -1.92806485e+00 -8.48564029e-01 -8.48564029e-01
 -8.48564029e-01  7.45362856e-01  7.45362856e-01  7.45362856e-01
  1.99283453e+00  3.51341392e+00  3.51341392e+00  3.51341392e+00
  1.23952470e+01  1.23952470e+01  1.23952470e+01  1.94896278e+01
  4.33977303e+01  4.33977303e+01  4.33977303e+01  9.41254507e+01
  1.74413583e+02  1.74413583e+02  1.74413583e+02  3.56438731e+02
  1.34977486e+03  5.83615620e+03  3.50986839e+04]
E1 = -182.58435849241164  E_coul = 54.04770273380328
Extra cycle  E= -128.536655758608  delta_E= -9.66e-13  |g|= 9.4e-07  |ddm|= 1.57e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209707e+03 6.17494324e+02 1.74935350e+02
 2.04405485e+01 5.69554984e+01 4.83790168e-01 7.99728850e+00
 1.64645106e+00 6.12058174e+00 1.87354461e+01 7.02699671e+01
 2.51880779e-01 2.17534738e+00 7.64531677e-01]
E = -128.53665575860836
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787248        1
[INPUT] 0    0    [1    /1   ]  2712.09707088        1
[INPUT] 0    0    [1    /1   ]  617.494323718        1
[INPUT] 0    0    [1    /1   ]  174.935349989        1
[INPUT] 0    0    [1    /1   ]  20.4405485325        1
[INPUT] 0    0    [1    /1   ]  56.9554984396        1
[INPUT] 0    0    [1    /1   ]  0.483790168095       1
[INPUT] 0    0    [1    /1   ]  7.99728850162        1
[INPUT] 0    0    [1    /1   ]  1.64645106358        1
[INPUT] 1    0    [1    /1   ]  6.1205817385         1
[INPUT] 1    0    [1    /1   ]  18.7354460755        1
[INPUT] 1    0    [1    /1   ]  70.2699671432        1
[INPUT] 1    0    [1    /1   ]  0.25188077944        1
[INPUT] 1    0    [1    /1   ]  2.17534738332        1
[INPUT] 1    0    [1    /1   ]  0.764531676702       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47872481297, 1.0]], [0, [2712.0970708827704, 1.0]], [0, [617.4943237184552, 1.0]], [0, [174.93534998855145, 1.0]], [0, [20.440548532529967, 1.0]], [0, [56.95549843964879, 1.0]], [0, [0.48379016809503156, 1.0]], [0, [7.997288501620269, 1.0]], [0, [1.6464510635831993, 1.0]], [1, [6.120581738503693, 1.0]], [1, [18.735446075538196, 1.0]], [1, [70.26996714318729, 1.0]], [1, [0.2518807794402174, 1.0]], [1, [2.17534738331824, 1.0]], [1, [0.7645316767020722, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872481]
bas 1, expnt(s) = [2712.09707088]
bas 2, expnt(s) = [617.49432372]
bas 3, expnt(s) = [174.93534999]
bas 4, expnt(s) = [20.44054853]
bas 5, expnt(s) = [56.95549844]
bas 6, expnt(s) = [0.48379017]
bas 7, expnt(s) = [7.9972885]
bas 8, expnt(s) = [1.64645106]
bas 9, expnt(s) = [6.12058174]
bas 10, expnt(s) = [18.73544608]
bas 11, expnt(s) = [70.26996714]
bas 12, expnt(s) = [0.25188078]
bas 13, expnt(s) = [2.17534738]
bas 14, expnt(s) = [0.76453168]
CPU time:       190.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209707e+03 9.49497764e+02
 6.17494324e+02 3.12960662e+02 1.74935350e+02 1.21527121e+02
 2.04405485e+01 2.42875906e+01 5.69554984e+01 5.23801535e+01
 4.83790168e-01 1.46557417e+00 7.99728850e+00 1.20149536e+01
 1.64645106e+00 3.67220269e+00 6.12058174e+00 2.80850545e+01
 1.87354461e+01 1.13714132e+02 7.02699671e+01 5.93535337e+02
 2.51880779e-01 5.20568851e-01 2.17534738e+00 7.70717406e+00
 7.64531677e-01 2.08558910e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999299402915792
cond(S) = 244.77788004349324
E1 = -183.58504449733596  E_coul = 55.0818744529608
init E= -128.503170044375
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775168904662822  LUMO = 0.761232582855494
  mo_energy =
[-3.25539832e+01 -1.85125728e+00 -7.75168905e-01 -7.75168905e-01
 -7.75168905e-01  7.61232583e-01  7.61232583e-01  7.61232583e-01
  2.04513791e+00  3.57327449e+00  3.57327449e+00  3.57327449e+00
  1.25140076e+01  1.25140076e+01  1.25140076e+01  1.96392379e+01
  4.35765602e+01  4.35765602e+01  4.35765602e+01  9.43293795e+01
  1.74638377e+02  1.74638377e+02  1.74638377e+02  3.56677367e+02
  1.35004539e+03  5.83645576e+03  3.50990039e+04]
E1 = -182.07625438786246  E_coul = 53.54315825239546
cycle= 1 E= -128.533096135467  delta_E= -0.0299  |g|= 0.205  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.522275
diis-c [-0.27277097  1.        ]
  HOMO = -0.884243929462958  LUMO = 0.737536892419275
  mo_energy =
[-3.28791172e+01 -1.96581425e+00 -8.84243929e-01 -8.84243929e-01
 -8.84243929e-01  7.37536892e-01  7.37536892e-01  7.37536892e-01
  1.96744484e+00  3.48462891e+00  3.48462891e+00  3.48462891e+00
  1.23366898e+01  1.23366898e+01  1.23366898e+01  1.94146660e+01
  4.33081757e+01  4.33081757e+01  4.33081757e+01  9.40230558e+01
  1.74302869e+02  1.74302869e+02  1.74302869e+02  3.56323589e+02
  1.34965358e+03  5.83603208e+03  3.50985587e+04]
E1 = -182.84339188923124  E_coul = 54.3076659713606
cycle= 2 E= -128.535725917871  delta_E= -0.00263  |g|= 0.104  |ddm|= 0.0724
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.264598
diis-c [-6.13225150e-04  3.35534713e-01  6.64465287e-01]
  HOMO = -0.848318918817172  LUMO = 0.745390713517631
  mo_energy =
[-3.27702208e+01 -1.92788423e+00 -8.48318919e-01 -8.48318919e-01
 -8.48318919e-01  7.45390714e-01  7.45390714e-01  7.45390714e-01
  1.99293106e+00  3.51356579e+00  3.51356579e+00  3.51356579e+00
  1.23955339e+01  1.23955339e+01  1.23955339e+01  1.94899482e+01
  4.33981362e+01  4.33981362e+01  4.33981362e+01  9.41259126e+01
  1.74414117e+02  1.74414117e+02  1.74414117e+02  3.56439333e+02
  1.34977562e+03  5.83615708e+03  3.50986848e+04]
E1 = -182.5836996827678  E_coul = 54.0470439407598
cycle= 3 E= -128.536655742008  delta_E= -0.00093  |g|= 0.000441  |ddm|= 0.0251
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00115223
diis-c [-1.10708497e-07 -2.10014872e-03  3.27141729e-05  1.00206743e+00]
  HOMO = -0.848529319249451  LUMO = 0.745372123868757
  mo_energy =
[-3.27706462e+01 -1.92803709e+00 -8.48529319e-01 -8.48529319e-01
 -8.48529319e-01  7.45372124e-01  7.45372124e-01  7.45372124e-01
  1.99285609e+00  3.51344419e+00  3.51344419e+00  3.51344419e+00
  1.23952961e+01  1.23952961e+01  1.23952961e+01  1.94896811e+01
  4.33977925e+01  4.33977925e+01  4.33977925e+01  9.41255181e+01
  1.74413655e+02  1.74413655e+02  1.74413655e+02  3.56438809e+02
  1.34977495e+03  5.83615629e+03  3.50986840e+04]
E1 = -182.5842075625248  E_coul = 54.047551804435365
cycle= 4 E= -128.536655758089  delta_E= -1.61e-08  |g|= 7.48e-05  |ddm|= 0.000129
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000200971
diis-c [-5.60141654e-10  1.38742306e-04  5.49540195e-04 -1.35581930e-01
  1.13489365e+00]
  HOMO = -0.848565227402858  LUMO = 0.745362542661982
  mo_energy =
[-3.27707190e+01 -1.92806660e+00 -8.48565227e-01 -8.48565227e-01
 -8.48565227e-01  7.45362543e-01  7.45362543e-01  7.45362543e-01
  1.99283322e+00  3.51341286e+00  3.51341286e+00  3.51341286e+00
  1.23952451e+01  1.23952451e+01  1.23952451e+01  1.94896253e+01
  4.33977278e+01  4.33977278e+01  4.33977278e+01  9.41254481e+01
  1.74413580e+02  1.74413580e+02  1.74413580e+02  3.56438729e+02
  1.34977486e+03  5.83615620e+03  3.50986839e+04]
E1 = -182.58436499105872  E_coul = 54.04770923245132
cycle= 5 E= -128.536655758607  delta_E= -5.18e-10  |g|= 2.91e-06  |ddm|= 1.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58436499105872  E_coul = 54.04770923245132
  HOMO = -0.848564029077123  LUMO = 0.745362856120392
  mo_energy =
[-3.27707163e+01 -1.92806485e+00 -8.48564029e-01 -8.48564029e-01
 -8.48564029e-01  7.45362856e-01  7.45362856e-01  7.45362856e-01
  1.99283453e+00  3.51341392e+00  3.51341392e+00  3.51341392e+00
  1.23952470e+01  1.23952470e+01  1.23952470e+01  1.94896278e+01
  4.33977303e+01  4.33977303e+01  4.33977303e+01  9.41254507e+01
  1.74413583e+02  1.74413583e+02  1.74413583e+02  3.56438731e+02
  1.34977486e+03  5.83615620e+03  3.50986839e+04]
E1 = -182.58435849241164  E_coul = 54.04770273380328
Extra cycle  E= -128.536655758608  delta_E= -9.66e-13  |g|= 9.4e-07  |ddm|= 1.57e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 244.77788004349324
E1 = -182.58435849241164  E_coul = 54.04770273380328
init E= -128.536655758608
    CPU time for initialize scf      0.31 sec, wall time      0.30 sec
  HOMO = -0.848564499899127  LUMO = 0.745362760237522
  mo_energy =
[-3.27707178e+01 -1.92806525e+00 -8.48564500e-01 -8.48564500e-01
 -8.48564500e-01  7.45362760e-01  7.45362760e-01  7.45362760e-01
  1.99283428e+00  3.51341355e+00  3.51341355e+00  3.51341355e+00
  1.23952462e+01  1.23952462e+01  1.23952462e+01  1.94896269e+01
  4.33977291e+01  4.33977291e+01  4.33977291e+01  9.41254493e+01
  1.74413581e+02  1.74413581e+02  1.74413581e+02  3.56438730e+02
  1.34977486e+03  5.83615620e+03  3.50986839e+04]
E1 = -182.58436210644203  E_coul = 54.04770634783368
cycle= 1 E= -128.536655758608  delta_E= 2.84e-14  |g|= 5e-07  |ddm|= 3.25e-07
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
E1 = -182.58436210644203  E_coul = 54.04770634783368
  HOMO = -0.848564247041687  LUMO = 0.745362817172193
  mo_energy =
[-3.27707170e+01 -1.92806496e+00 -8.48564247e-01 -8.48564247e-01
 -8.48564247e-01  7.45362817e-01  7.45362817e-01  7.45362817e-01
  1.99283448e+00  3.51341376e+00  3.51341376e+00  3.51341376e+00
  1.23952466e+01  1.23952466e+01  1.23952466e+01  1.94896274e+01
  4.33977298e+01  4.33977298e+01  4.33977298e+01  9.41254500e+01
  1.74413582e+02  1.74413582e+02  1.74413582e+02  3.56438731e+02
  1.34977486e+03  5.83615620e+03  3.50986839e+04]
E1 = -182.58436031231898  E_coul = 54.04770455371087
Extra cycle  E= -128.536655758608  delta_E= 2.27e-13  |g|= 2.43e-07  |ddm|= 2.01e-07
    CPU time for scf_cycle      0.39 sec, wall time      0.38 sec
exp = [1.80764787e+04 2.71209707e+03 6.17494324e+02 1.74935350e+02
 2.04405485e+01 5.69554984e+01 4.83790168e-01 7.99728850e+00
 1.64645106e+00 6.12058174e+00 1.87354461e+01 7.02699671e+01
 2.51880779e-01 2.17534738e+00 7.64531677e-01]
grad_E = [ 2.89694534e-09 -1.51596508e-07  3.05308163e-06 -3.54752907e-05
 -9.78257116e-04  2.55754084e-04 -6.43114060e-03  1.61596553e-03
  1.39639895e-03 -7.02403000e-04  3.38563978e-04 -1.19431089e-04
  9.68775320e-04  7.65827887e-04 -3.83876619e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787232        1
[INPUT] 0    0    [1    /1   ]  2712.09714921        1
[INPUT] 0    0    [1    /1   ]  617.492960563        1
[INPUT] 0    0    [1    /1   ]  174.94570117         1
[INPUT] 0    0    [1    /1   ]  20.48886392          1
[INPUT] 0    0    [1    /1   ]  56.9359527057        1
[INPUT] 0    0    [1    /1   ]  0.484192778163       1
[INPUT] 0    0    [1    /1   ]  7.94469009249        1
[INPUT] 0    0    [1    /1   ]  1.64909030627        1
[INPUT] 1    0    [1    /1   ]  6.54356344234        1
[INPUT] 1    0    [1    /1   ]  20.2178834265        1
[INPUT] 1    0    [1    /1   ]  74.4345064782        1
[INPUT] 1    0    [1    /1   ]  0.260094835983       1
[INPUT] 1    0    [1    /1   ]  2.30229070715        1
[INPUT] 1    0    [1    /1   ]  0.801218272451       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478723199314, 1.0]], [0, [2712.0971492066824, 1.0]], [0, [617.4929605629849, 1.0]], [0, [174.94570116988402, 1.0]], [0, [20.488863920026855, 1.0]], [0, [56.935952705675376, 1.0]], [0, [0.4841927781626314, 1.0]], [0, [7.944690092491117, 1.0]], [0, [1.649090306269951, 1.0]], [1, [6.543563442340942, 1.0]], [1, [20.217883426469143, 1.0]], [1, [74.43450647817795, 1.0]], [1, [0.26009483598334165, 1.0]], [1, [2.3022907071482805, 1.0]], [1, [0.8012182724505857, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.4787232]
bas 1, expnt(s) = [2712.09714921]
bas 2, expnt(s) = [617.49296056]
bas 3, expnt(s) = [174.94570117]
bas 4, expnt(s) = [20.48886392]
bas 5, expnt(s) = [56.93595271]
bas 6, expnt(s) = [0.48419278]
bas 7, expnt(s) = [7.94469009]
bas 8, expnt(s) = [1.64909031]
bas 9, expnt(s) = [6.54356344]
bas 10, expnt(s) = [20.21788343]
bas 11, expnt(s) = [74.43450648]
bas 12, expnt(s) = [0.26009484]
bas 13, expnt(s) = [2.30229071]
bas 14, expnt(s) = [0.80121827]
CPU time:       194.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209715e+03 9.49497785e+02
 6.17492961e+02 3.12960144e+02 1.74945701e+02 1.21532514e+02
 2.04888639e+01 2.43306344e+01 5.69359527e+01 5.23666712e+01
 4.84192778e-01 1.46648881e+00 7.94469009e+00 1.19556377e+01
 1.64909031e+00 3.67661668e+00 6.54356344e+00 3.05317916e+01
 2.02178834e+01 1.25070246e+02 7.44345065e+01 6.37826096e+02
 2.60094836e-01 5.41874925e-01 2.30229071e+00 8.27341088e+00
 8.01218272e-01 2.21142874e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999238271424035
cond(S) = 243.30563765603833
E1 = -183.58578555967978  E_coul = 55.08181719645017
init E= -128.50396836323
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775194789131456  LUMO = 0.795868381010398
  mo_energy =
[-3.25540764e+01 -1.85122626e+00 -7.75194789e-01 -7.75194789e-01
 -7.75194789e-01  7.95868381e-01  7.95868381e-01  7.95868381e-01
  2.04779315e+00  3.76838421e+00  3.76838421e+00  3.76838421e+00
  1.33460267e+01  1.33460267e+01  1.33460267e+01  1.95866662e+01
  4.70994123e+01  4.70994123e+01  4.70994123e+01  9.42505107e+01
  1.87695111e+02  1.87695111e+02  1.87695111e+02  3.56617813e+02
  1.35000220e+03  5.83642301e+03  3.50989776e+04]
E1 = -182.08119777807218  E_coul = 53.5478307725936
cycle= 1 E= -128.533367005479  delta_E= -0.0294  |g|= 0.205  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.517323
diis-c [-0.26762323  1.        ]
  HOMO = -0.88390696275804  LUMO = 0.770740044074833
  mo_energy =
[-3.28783721e+01 -1.96535254e+00 -8.83906963e-01 -8.83906963e-01
 -8.83906963e-01  7.70740044e-01  7.70740044e-01  7.70740044e-01
  1.97039039e+00  3.67571369e+00  3.67571369e+00  3.67571369e+00
  1.31632367e+01  1.31632367e+01  1.31632367e+01  1.93629959e+01
  4.68268130e+01  4.68268130e+01  4.68268130e+01  9.39449644e+01
  1.87358177e+02  1.87358177e+02  1.87358177e+02  3.56264845e+02
  1.34961116e+03  5.83600012e+03  3.50985332e+04]
E1 = -182.84510211466431  E_coul = 54.30911810665765
cycle= 2 E= -128.535984008007  delta_E= -0.00262  |g|= 0.104  |ddm|= 0.0729
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.2616
diis-c [-6.12437758e-04  3.35101568e-01  6.64898432e-01]
  HOMO = -0.848120100338939  LUMO = 0.779061085016443
  mo_energy =
[-3.27698210e+01 -1.92757191e+00 -8.48120100e-01 -8.48120100e-01
 -8.48120100e-01  7.79061085e-01  7.79061085e-01  7.79061085e-01
  1.99577980e+00  3.70596617e+00  3.70596617e+00  3.70596617e+00
  1.32239182e+01  1.32239182e+01  1.32239182e+01  1.94379314e+01
  4.69181604e+01  4.69181604e+01  4.69181604e+01  9.40474914e+01
  1.87469672e+02  1.87469672e+02  1.87469672e+02  3.56380231e+02
  1.34973283e+03  5.83612474e+03  3.50986589e+04]
E1 = -182.58665586442362  E_coul = 54.04974983134743
cycle= 3 E= -128.536906033076  delta_E= -0.000922  |g|= 0.000462  |ddm|= 0.0253
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00121013
diis-c [-1.15528720e-07 -2.14734659e-03  2.03809646e-04  1.00194354e+00]
  HOMO = -0.848338144229698  LUMO = 0.779038968597067
  mo_energy =
[-3.27702660e+01 -1.92773113e+00 -8.48338144e-01 -8.48338144e-01
 -8.48338144e-01  7.79038969e-01  7.79038969e-01  7.79038969e-01
  1.99569999e+00  3.70583134e+00  3.70583134e+00  3.70583134e+00
  1.32236608e+01  1.32236608e+01  1.32236608e+01  1.94376507e+01
  4.69177935e+01  4.69177935e+01  4.69177935e+01  9.40470776e+01
  1.87469183e+02  1.87469183e+02  1.87469183e+02  3.56379684e+02
  1.34973213e+03  5.83612392e+03  3.50986580e+04]
E1 = -182.58722211949396  E_coul = 54.050316069041166
cycle= 4 E= -128.536906050453  delta_E= -1.74e-08  |g|= 7.59e-05  |ddm|= 0.000125
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000203865
diis-c [-5.63143015e-10  1.48422947e-04  5.43819719e-04 -1.38208128e-01
  1.13751589e+00]
  HOMO = -0.848374250990362  LUMO = 0.77902891232473
  mo_energy =
[-3.27703398e+01 -1.92776038e+00 -8.48374251e-01 -8.48374251e-01
 -8.48374251e-01  7.79028912e-01  7.79028912e-01  7.79028912e-01
  1.99567742e+00  3.70579875e+00  3.70579875e+00  3.70579875e+00
  1.32236082e+01  1.32236082e+01  1.32236082e+01  1.94375945e+01
  4.69177273e+01  4.69177273e+01  4.69177273e+01  9.40470065e+01
  1.87469106e+02  1.87469106e+02  1.87469106e+02  3.56379603e+02
  1.34973204e+03  5.83612383e+03  3.50986579e+04]
E1 = -182.58738409011687  E_coul = 54.05047803912827
cycle= 5 E= -128.536906050989  delta_E= -5.36e-10  |g|= 3.16e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.58738409011687  E_coul = 54.05047803912827
  HOMO = -0.848372897226902  LUMO = 0.779029296854445
  mo_energy =
[-3.27703369e+01 -1.92775844e+00 -8.48372897e-01 -8.48372897e-01
 -8.48372897e-01  7.79029297e-01  7.79029297e-01  7.79029297e-01
  1.99567889e+00  3.70580001e+00  3.70580001e+00  3.70580001e+00
  1.32236104e+01  1.32236104e+01  1.32236104e+01  1.94375973e+01
  4.69177302e+01  4.69177302e+01  4.69177302e+01  9.40470094e+01
  1.87469109e+02  1.87469109e+02  1.87469109e+02  3.56379605e+02
  1.34973204e+03  5.83612383e+03  3.50986579e+04]
E1 = -182.58737709477612  E_coul = 54.0504710437866
Extra cycle  E= -128.53690605099  delta_E= -9.09e-13  |g|= 1.02e-06  |ddm|= 1.71e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209715e+03 6.17492961e+02 1.74945701e+02
 2.04888639e+01 5.69359527e+01 4.84192778e-01 7.94469009e+00
 1.64909031e+00 6.54356344e+00 2.02178834e+01 7.44345065e+01
 2.60094836e-01 2.30229071e+00 8.01218272e-01]
E = -128.5369060509895
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787232        1
[INPUT] 0    0    [1    /1   ]  2712.09714921        1
[INPUT] 0    0    [1    /1   ]  617.492960563        1
[INPUT] 0    0    [1    /1   ]  174.94570117         1
[INPUT] 0    0    [1    /1   ]  20.48886392          1
[INPUT] 0    0    [1    /1   ]  56.9359527057        1
[INPUT] 0    0    [1    /1   ]  0.484192778163       1
[INPUT] 0    0    [1    /1   ]  7.94469009249        1
[INPUT] 0    0    [1    /1   ]  1.64909030627        1
[INPUT] 1    0    [1    /1   ]  6.54356344234        1
[INPUT] 1    0    [1    /1   ]  20.2178834265        1
[INPUT] 1    0    [1    /1   ]  74.4345064782        1
[INPUT] 1    0    [1    /1   ]  0.260094835983       1
[INPUT] 1    0    [1    /1   ]  2.30229070715        1
[INPUT] 1    0    [1    /1   ]  0.801218272451       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478723199314, 1.0]], [0, [2712.0971492066824, 1.0]], [0, [617.4929605629849, 1.0]], [0, [174.94570116988402, 1.0]], [0, [20.488863920026855, 1.0]], [0, [56.935952705675376, 1.0]], [0, [0.4841927781626314, 1.0]], [0, [7.944690092491117, 1.0]], [0, [1.649090306269951, 1.0]], [1, [6.543563442340942, 1.0]], [1, [20.217883426469143, 1.0]], [1, [74.43450647817795, 1.0]], [1, [0.26009483598334165, 1.0]], [1, [2.3022907071482805, 1.0]], [1, [0.8012182724505857, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.4787232]
bas 1, expnt(s) = [2712.09714921]
bas 2, expnt(s) = [617.49296056]
bas 3, expnt(s) = [174.94570117]
bas 4, expnt(s) = [20.48886392]
bas 5, expnt(s) = [56.93595271]
bas 6, expnt(s) = [0.48419278]
bas 7, expnt(s) = [7.94469009]
bas 8, expnt(s) = [1.64909031]
bas 9, expnt(s) = [6.54356344]
bas 10, expnt(s) = [20.21788343]
bas 11, expnt(s) = [74.43450648]
bas 12, expnt(s) = [0.26009484]
bas 13, expnt(s) = [2.30229071]
bas 14, expnt(s) = [0.80121827]
CPU time:       194.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209715e+03 9.49497785e+02
 6.17492961e+02 3.12960144e+02 1.74945701e+02 1.21532514e+02
 2.04888639e+01 2.43306344e+01 5.69359527e+01 5.23666712e+01
 4.84192778e-01 1.46648881e+00 7.94469009e+00 1.19556377e+01
 1.64909031e+00 3.67661668e+00 6.54356344e+00 3.05317916e+01
 2.02178834e+01 1.25070246e+02 7.44345065e+01 6.37826096e+02
 2.60094836e-01 5.41874925e-01 2.30229071e+00 8.27341088e+00
 8.01218272e-01 2.21142874e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999238271424035
cond(S) = 243.30563765603833
E1 = -183.58578555967978  E_coul = 55.08181719645017
init E= -128.50396836323
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775194789131456  LUMO = 0.795868381010398
  mo_energy =
[-3.25540764e+01 -1.85122626e+00 -7.75194789e-01 -7.75194789e-01
 -7.75194789e-01  7.95868381e-01  7.95868381e-01  7.95868381e-01
  2.04779315e+00  3.76838421e+00  3.76838421e+00  3.76838421e+00
  1.33460267e+01  1.33460267e+01  1.33460267e+01  1.95866662e+01
  4.70994123e+01  4.70994123e+01  4.70994123e+01  9.42505107e+01
  1.87695111e+02  1.87695111e+02  1.87695111e+02  3.56617813e+02
  1.35000220e+03  5.83642301e+03  3.50989776e+04]
E1 = -182.08119777807218  E_coul = 53.5478307725936
cycle= 1 E= -128.533367005479  delta_E= -0.0294  |g|= 0.205  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.517323
diis-c [-0.26762323  1.        ]
  HOMO = -0.88390696275804  LUMO = 0.770740044074833
  mo_energy =
[-3.28783721e+01 -1.96535254e+00 -8.83906963e-01 -8.83906963e-01
 -8.83906963e-01  7.70740044e-01  7.70740044e-01  7.70740044e-01
  1.97039039e+00  3.67571369e+00  3.67571369e+00  3.67571369e+00
  1.31632367e+01  1.31632367e+01  1.31632367e+01  1.93629959e+01
  4.68268130e+01  4.68268130e+01  4.68268130e+01  9.39449644e+01
  1.87358177e+02  1.87358177e+02  1.87358177e+02  3.56264845e+02
  1.34961116e+03  5.83600012e+03  3.50985332e+04]
E1 = -182.84510211466431  E_coul = 54.30911810665765
cycle= 2 E= -128.535984008007  delta_E= -0.00262  |g|= 0.104  |ddm|= 0.0729
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.2616
diis-c [-6.12437758e-04  3.35101568e-01  6.64898432e-01]
  HOMO = -0.848120100338939  LUMO = 0.779061085016443
  mo_energy =
[-3.27698210e+01 -1.92757191e+00 -8.48120100e-01 -8.48120100e-01
 -8.48120100e-01  7.79061085e-01  7.79061085e-01  7.79061085e-01
  1.99577980e+00  3.70596617e+00  3.70596617e+00  3.70596617e+00
  1.32239182e+01  1.32239182e+01  1.32239182e+01  1.94379314e+01
  4.69181604e+01  4.69181604e+01  4.69181604e+01  9.40474914e+01
  1.87469672e+02  1.87469672e+02  1.87469672e+02  3.56380231e+02
  1.34973283e+03  5.83612474e+03  3.50986589e+04]
E1 = -182.58665586442362  E_coul = 54.04974983134743
cycle= 3 E= -128.536906033076  delta_E= -0.000922  |g|= 0.000462  |ddm|= 0.0253
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00121013
diis-c [-1.15528720e-07 -2.14734659e-03  2.03809646e-04  1.00194354e+00]
  HOMO = -0.848338144229698  LUMO = 0.779038968597067
  mo_energy =
[-3.27702660e+01 -1.92773113e+00 -8.48338144e-01 -8.48338144e-01
 -8.48338144e-01  7.79038969e-01  7.79038969e-01  7.79038969e-01
  1.99569999e+00  3.70583134e+00  3.70583134e+00  3.70583134e+00
  1.32236608e+01  1.32236608e+01  1.32236608e+01  1.94376507e+01
  4.69177935e+01  4.69177935e+01  4.69177935e+01  9.40470776e+01
  1.87469183e+02  1.87469183e+02  1.87469183e+02  3.56379684e+02
  1.34973213e+03  5.83612392e+03  3.50986580e+04]
E1 = -182.58722211949396  E_coul = 54.050316069041166
cycle= 4 E= -128.536906050453  delta_E= -1.74e-08  |g|= 7.59e-05  |ddm|= 0.000125
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000203865
diis-c [-5.63143015e-10  1.48422947e-04  5.43819719e-04 -1.38208128e-01
  1.13751589e+00]
  HOMO = -0.848374250990362  LUMO = 0.77902891232473
  mo_energy =
[-3.27703398e+01 -1.92776038e+00 -8.48374251e-01 -8.48374251e-01
 -8.48374251e-01  7.79028912e-01  7.79028912e-01  7.79028912e-01
  1.99567742e+00  3.70579875e+00  3.70579875e+00  3.70579875e+00
  1.32236082e+01  1.32236082e+01  1.32236082e+01  1.94375945e+01
  4.69177273e+01  4.69177273e+01  4.69177273e+01  9.40470065e+01
  1.87469106e+02  1.87469106e+02  1.87469106e+02  3.56379603e+02
  1.34973204e+03  5.83612383e+03  3.50986579e+04]
E1 = -182.58738409011687  E_coul = 54.05047803912827
cycle= 5 E= -128.536906050989  delta_E= -5.36e-10  |g|= 3.16e-06  |ddm|= 1.88e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.58738409011687  E_coul = 54.05047803912827
  HOMO = -0.848372897226902  LUMO = 0.779029296854445
  mo_energy =
[-3.27703369e+01 -1.92775844e+00 -8.48372897e-01 -8.48372897e-01
 -8.48372897e-01  7.79029297e-01  7.79029297e-01  7.79029297e-01
  1.99567889e+00  3.70580001e+00  3.70580001e+00  3.70580001e+00
  1.32236104e+01  1.32236104e+01  1.32236104e+01  1.94375973e+01
  4.69177302e+01  4.69177302e+01  4.69177302e+01  9.40470094e+01
  1.87469109e+02  1.87469109e+02  1.87469109e+02  3.56379605e+02
  1.34973204e+03  5.83612383e+03  3.50986579e+04]
E1 = -182.58737709477612  E_coul = 54.0504710437866
Extra cycle  E= -128.53690605099  delta_E= -9.09e-13  |g|= 1.02e-06  |ddm|= 1.71e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 243.30563765603833
E1 = -182.58737709477612  E_coul = 54.0504710437866
init E= -128.53690605099
    CPU time for initialize scf      0.29 sec, wall time      0.29 sec
  HOMO = -0.848373401272525  LUMO = 0.779029189019169
  mo_energy =
[-3.27703384e+01 -1.92775886e+00 -8.48373401e-01 -8.48373401e-01
 -8.48373401e-01  7.79029189e-01  7.79029189e-01  7.79029189e-01
  1.99567862e+00  3.70579959e+00  3.70579959e+00  3.70579959e+00
  1.32236096e+01  1.32236096e+01  1.32236096e+01  1.94375963e+01
  4.69177289e+01  4.69177289e+01  4.69177289e+01  9.40470079e+01
  1.87469107e+02  1.87469107e+02  1.87469107e+02  3.56379603e+02
  1.34973204e+03  5.83612383e+03  3.50986579e+04]
E1 = -182.58738102731266  E_coul = 54.050474976322874
cycle= 1 E= -128.53690605099  delta_E= -2.84e-13  |g|= 5.44e-07  |ddm|= 3.65e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.58738102731266  E_coul = 54.050474976322874
  HOMO = -0.848373125886485  LUMO = 0.779029255057217
  mo_energy =
[-3.27703376e+01 -1.92775855e+00 -8.48373126e-01 -8.48373126e-01
 -8.48373126e-01  7.79029255e-01  7.79029255e-01  7.79029255e-01
  1.99567884e+00  3.70579983e+00  3.70579983e+00  3.70579983e+00
  1.32236101e+01  1.32236101e+01  1.32236101e+01  1.94375969e+01
  4.69177296e+01  4.69177296e+01  4.69177296e+01  9.40470087e+01
  1.87469108e+02  1.87469108e+02  1.87469108e+02  3.56379604e+02
  1.34973204e+03  5.83612383e+03  3.50986579e+04]
E1 = -182.5873790821878  E_coul = 54.05047303119813
Extra cycle  E= -128.53690605099  delta_E= 1.14e-13  |g|= 2.64e-07  |ddm|= 2.19e-07
    CPU time for scf_cycle      0.37 sec, wall time      0.36 sec
exp = [1.80764787e+04 2.71209715e+03 6.17492961e+02 1.74945701e+02
 2.04888639e+01 5.69359527e+01 4.84192778e-01 7.94469009e+00
 1.64909031e+00 6.54356344e+00 2.02178834e+01 7.44345065e+01
 2.60094836e-01 2.30229071e+00 8.01218272e-01]
grad_E = [ 1.14731738e-09 -6.06051322e-08  1.26064858e-06 -1.59277505e-05
 -5.43824619e-04  1.26569862e-04 -5.99572123e-03  9.68282605e-04
  1.36337170e-03 -7.48315602e-04  3.93589184e-04 -1.13575218e-04
  3.08484610e-04  8.63577913e-04  1.25605497e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787209        1
[INPUT] 0    0    [1    /1   ]  2712.09725949        1
[INPUT] 0    0    [1    /1   ]  617.491054059        1
[INPUT] 0    0    [1    /1   ]  174.959814672        1
[INPUT] 0    0    [1    /1   ]  20.5282820057        1
[INPUT] 0    0    [1    /1   ]  56.915261855         1
[INPUT] 0    0    [1    /1   ]  0.486269824204       1
[INPUT] 0    0    [1    /1   ]  7.92125258362        1
[INPUT] 0    0    [1    /1   ]  1.65285935209        1
[INPUT] 1    0    [1    /1   ]  6.98077787989        1
[INPUT] 1    0    [1    /1   ]  21.8981998465        1
[INPUT] 1    0    [1    /1   ]  80.625873699         1
[INPUT] 1    0    [1    /1   ]  0.266935374438       1
[INPUT] 1    0    [1    /1   ]  2.42140247544        1
[INPUT] 1    0    [1    /1   ]  0.832877571319       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478720921106, 1.0]], [0, [2712.0972594911154, 1.0]], [0, [617.4910540589267, 1.0]], [0, [174.95981467240438, 1.0]], [0, [20.528282005665044, 1.0]], [0, [56.91526185499973, 1.0]], [0, [0.48626982420421155, 1.0]], [0, [7.921252583621073, 1.0]], [0, [1.6528593520912342, 1.0]], [1, [6.980777879890558, 1.0]], [1, [21.898199846538475, 1.0]], [1, [80.6258736989893, 1.0]], [1, [0.2669353744380316, 1.0]], [1, [2.421402475440257, 1.0]], [1, [0.8328775713189293, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872092]
bas 1, expnt(s) = [2712.09725949]
bas 2, expnt(s) = [617.49105406]
bas 3, expnt(s) = [174.95981467]
bas 4, expnt(s) = [20.52828201]
bas 5, expnt(s) = [56.91526185]
bas 6, expnt(s) = [0.48626982]
bas 7, expnt(s) = [7.92125258]
bas 8, expnt(s) = [1.65285935]
bas 9, expnt(s) = [6.98077788]
bas 10, expnt(s) = [21.89819985]
bas 11, expnt(s) = [80.6258737]
bas 12, expnt(s) = [0.26693537]
bas 13, expnt(s) = [2.42140248]
bas 14, expnt(s) = [0.83287757]
CPU time:       198.37
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209726e+03 9.49497814e+02
 6.17491054e+02 3.12959419e+02 1.74959815e+02 1.21539867e+02
 2.05282820e+01 2.43657328e+01 5.69152619e+01 5.23523978e+01
 4.86269824e-01 1.47120440e+00 7.92125258e+00 1.19291753e+01
 1.65285935e+00 3.68291715e+00 6.98077788e+00 3.31027571e+01
 2.18981998e+01 1.38195821e+02 8.06258737e+01 7.04818727e+02
 2.66935374e-01 5.59747362e-01 2.42140248e+00 8.81187078e+00
 8.32877571e-01 2.32119086e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999174425379616
cond(S) = 243.01793247354408
E1 = -183.58617678713796  E_coul = 55.08167708121454
init E= -128.504499705923
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77522836612481  LUMO = 0.82553150021042
  mo_energy =
[-3.25541502e+01 -1.85121343e+00 -7.75228366e-01 -7.75228366e-01
 -7.75228366e-01  8.25531500e-01  8.25531500e-01  8.25531500e-01
  2.05774328e+00  3.94312518e+00  3.94312518e+00  3.94312518e+00
  1.41612985e+01  1.41612985e+01  1.41612985e+01  1.95876806e+01
  5.09034474e+01  5.09034474e+01  5.09034474e+01  9.42646863e+01
  2.04716205e+02  2.04716205e+02  2.04716205e+02  3.56648708e+02
  1.35004513e+03  5.83646838e+03  3.50990162e+04]
E1 = -182.08786914431306  E_coul = 53.554247014068814
cycle= 1 E= -128.533622130244  delta_E= -0.0291  |g|= 0.204  |ddm|= 0.168
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.510562
diis-c [-0.26067351  1.        ]
  HOMO = -0.883419636401798  LUMO = 0.799223218848673
  mo_energy =
[-3.28772720e+01 -1.96481083e+00 -8.83419636e-01 -8.83419636e-01
 -8.83419636e-01  7.99223219e-01  7.99223219e-01  7.99223219e-01
  1.98052697e+00  3.84698892e+00  3.84698892e+00  3.84698892e+00
  1.39734382e+01  1.39734382e+01  1.39734382e+01  1.93650111e+01
  5.06267935e+01  5.06267935e+01  5.06267935e+01  9.39602382e+01
  2.04377469e+02  2.04377469e+02  2.04377469e+02  3.56296921e+02
  1.34965526e+03  5.83604668e+03  3.50985729e+04]
E1 = -182.84760716401553  E_coul = 54.31138689220171
cycle= 2 E= -128.536220271814  delta_E= -0.0026  |g|= 0.103  |ddm|= 0.0733
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.257752
diis-c [-6.11052607e-04  3.34709114e-01  6.65290886e-01]
  HOMO = -0.847816990974942  LUMO = 0.807929479756875
  mo_energy =
[-3.27692059e+01 -1.92722836e+00 -8.47816991e-01 -8.47816991e-01
 -8.47816991e-01  8.07929480e-01  8.07929480e-01  8.07929480e-01
  2.00584299e+00  3.87837886e+00  3.87837886e+00  3.87837886e+00
  1.40358158e+01  1.40358158e+01  1.40358158e+01  1.94395617e+01
  5.07194434e+01  5.07194434e+01  5.07194434e+01  9.40623061e+01
  2.04489249e+02  2.04489249e+02  2.04489249e+02  3.56411802e+02
  1.34977640e+03  5.83617077e+03  3.50986982e+04]
E1 = -182.5907493255519  E_coul = 54.05361711930953
cycle= 3 E= -128.537132206242  delta_E= -0.000912  |g|= 0.00047  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00122264
diis-c [-1.10147356e-07 -2.17107015e-03  2.76223304e-04  1.00189485e+00]
  HOMO = -0.848039552131509  LUMO = 0.807904189344314
  mo_energy =
[-3.27696640e+01 -1.92739594e+00 -8.48039552e-01 -8.48039552e-01
 -8.48039552e-01  8.07904189e-01  8.07904189e-01  8.07904189e-01
  2.00575631e+00  3.87823303e+00  3.87823303e+00  3.87823303e+00
  1.40355418e+01  1.40355418e+01  1.40355418e+01  1.94392704e+01
  5.07190574e+01  5.07190574e+01  5.07190574e+01  9.40618790e+01
  2.04488737e+02  2.04488737e+02  2.04488737e+02  3.56411241e+02
  1.34977569e+03  5.83616994e+03  3.50986973e+04]
E1 = -182.59135173712133  E_coul = 54.054219513366725
cycle= 4 E= -128.537132223755  delta_E= -1.75e-08  |g|= 7.39e-05  |ddm|= 0.000118
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000196007
diis-c [-5.07207740e-10  1.42593919e-04  5.17319400e-04 -1.32474313e-01
  1.13181440e+00]
  HOMO = -0.848074817346127  LUMO = 0.807893906925449
  mo_energy =
[-3.27697362e+01 -1.92742509e+00 -8.48074817e-01 -8.48074817e-01
 -8.48074817e-01  8.07893907e-01  8.07893907e-01  8.07893907e-01
  2.00573376e+00  3.87820006e+00  3.87820006e+00  3.87820006e+00
  1.40354893e+01  1.40354893e+01  1.40354893e+01  1.94392153e+01
  5.07189919e+01  5.07189919e+01  5.07189919e+01  9.40618095e+01
  2.04488662e+02  2.04488662e+02  2.04488662e+02  3.56411162e+02
  1.34977560e+03  5.83616984e+03  3.50986972e+04]
E1 = -182.59150967610324  E_coul = 54.05437745185169
cycle= 5 E= -128.537132224252  delta_E= -4.97e-10  |g|= 2.98e-06  |ddm|= 1.75e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59150967610324  E_coul = 54.05437745185169
  HOMO = -0.848073561134323  LUMO = 0.807894279645296
  mo_energy =
[-3.27697334e+01 -1.92742327e+00 -8.48073561e-01 -8.48073561e-01
 -8.48073561e-01  8.07894280e-01  8.07894280e-01  8.07894280e-01
  2.00573513e+00  3.87820127e+00  3.87820127e+00  3.87820127e+00
  1.40354914e+01  1.40354914e+01  1.40354914e+01  1.94392179e+01
  5.07189946e+01  5.07189946e+01  5.07189946e+01  9.40618122e+01
  2.04488665e+02  2.04488665e+02  2.04488665e+02  3.56411164e+02
  1.34977561e+03  5.83616984e+03  3.50986972e+04]
E1 = -182.5915030502944  E_coul = 54.05437082604232
Extra cycle  E= -128.537132224252  delta_E= -5.4e-13  |g|= 9.64e-07  |ddm|= 1.62e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209726e+03 6.17491054e+02 1.74959815e+02
 2.05282820e+01 5.69152619e+01 4.86269824e-01 7.92125258e+00
 1.65285935e+00 6.98077788e+00 2.18981998e+01 8.06258737e+01
 2.66935374e-01 2.42140248e+00 8.32877571e-01]
E = -128.53713222425208
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787209        1
[INPUT] 0    0    [1    /1   ]  2712.09725949        1
[INPUT] 0    0    [1    /1   ]  617.491054059        1
[INPUT] 0    0    [1    /1   ]  174.959814672        1
[INPUT] 0    0    [1    /1   ]  20.5282820057        1
[INPUT] 0    0    [1    /1   ]  56.915261855         1
[INPUT] 0    0    [1    /1   ]  0.486269824204       1
[INPUT] 0    0    [1    /1   ]  7.92125258362        1
[INPUT] 0    0    [1    /1   ]  1.65285935209        1
[INPUT] 1    0    [1    /1   ]  6.98077787989        1
[INPUT] 1    0    [1    /1   ]  21.8981998465        1
[INPUT] 1    0    [1    /1   ]  80.625873699         1
[INPUT] 1    0    [1    /1   ]  0.266935374438       1
[INPUT] 1    0    [1    /1   ]  2.42140247544        1
[INPUT] 1    0    [1    /1   ]  0.832877571319       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478720921106, 1.0]], [0, [2712.0972594911154, 1.0]], [0, [617.4910540589267, 1.0]], [0, [174.95981467240438, 1.0]], [0, [20.528282005665044, 1.0]], [0, [56.91526185499973, 1.0]], [0, [0.48626982420421155, 1.0]], [0, [7.921252583621073, 1.0]], [0, [1.6528593520912342, 1.0]], [1, [6.980777879890558, 1.0]], [1, [21.898199846538475, 1.0]], [1, [80.6258736989893, 1.0]], [1, [0.2669353744380316, 1.0]], [1, [2.421402475440257, 1.0]], [1, [0.8328775713189293, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47872092]
bas 1, expnt(s) = [2712.09725949]
bas 2, expnt(s) = [617.49105406]
bas 3, expnt(s) = [174.95981467]
bas 4, expnt(s) = [20.52828201]
bas 5, expnt(s) = [56.91526185]
bas 6, expnt(s) = [0.48626982]
bas 7, expnt(s) = [7.92125258]
bas 8, expnt(s) = [1.65285935]
bas 9, expnt(s) = [6.98077788]
bas 10, expnt(s) = [21.89819985]
bas 11, expnt(s) = [80.6258737]
bas 12, expnt(s) = [0.26693537]
bas 13, expnt(s) = [2.42140248]
bas 14, expnt(s) = [0.83287757]
CPU time:       199.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209726e+03 9.49497814e+02
 6.17491054e+02 3.12959419e+02 1.74959815e+02 1.21539867e+02
 2.05282820e+01 2.43657328e+01 5.69152619e+01 5.23523978e+01
 4.86269824e-01 1.47120440e+00 7.92125258e+00 1.19291753e+01
 1.65285935e+00 3.68291715e+00 6.98077788e+00 3.31027571e+01
 2.18981998e+01 1.38195821e+02 8.06258737e+01 7.04818727e+02
 2.66935374e-01 5.59747362e-01 2.42140248e+00 8.81187078e+00
 8.32877571e-01 2.32119086e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999174425379616
cond(S) = 243.01793247354408
E1 = -183.58617678713796  E_coul = 55.08167708121454
init E= -128.504499705923
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77522836612481  LUMO = 0.82553150021042
  mo_energy =
[-3.25541502e+01 -1.85121343e+00 -7.75228366e-01 -7.75228366e-01
 -7.75228366e-01  8.25531500e-01  8.25531500e-01  8.25531500e-01
  2.05774328e+00  3.94312518e+00  3.94312518e+00  3.94312518e+00
  1.41612985e+01  1.41612985e+01  1.41612985e+01  1.95876806e+01
  5.09034474e+01  5.09034474e+01  5.09034474e+01  9.42646863e+01
  2.04716205e+02  2.04716205e+02  2.04716205e+02  3.56648708e+02
  1.35004513e+03  5.83646838e+03  3.50990162e+04]
E1 = -182.08786914431306  E_coul = 53.554247014068814
cycle= 1 E= -128.533622130244  delta_E= -0.0291  |g|= 0.204  |ddm|= 0.168
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.510562
diis-c [-0.26067351  1.        ]
  HOMO = -0.883419636401798  LUMO = 0.799223218848673
  mo_energy =
[-3.28772720e+01 -1.96481083e+00 -8.83419636e-01 -8.83419636e-01
 -8.83419636e-01  7.99223219e-01  7.99223219e-01  7.99223219e-01
  1.98052697e+00  3.84698892e+00  3.84698892e+00  3.84698892e+00
  1.39734382e+01  1.39734382e+01  1.39734382e+01  1.93650111e+01
  5.06267935e+01  5.06267935e+01  5.06267935e+01  9.39602382e+01
  2.04377469e+02  2.04377469e+02  2.04377469e+02  3.56296921e+02
  1.34965526e+03  5.83604668e+03  3.50985729e+04]
E1 = -182.84760716401553  E_coul = 54.31138689220171
cycle= 2 E= -128.536220271814  delta_E= -0.0026  |g|= 0.103  |ddm|= 0.0733
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.257752
diis-c [-6.11052607e-04  3.34709114e-01  6.65290886e-01]
  HOMO = -0.847816990974942  LUMO = 0.807929479756875
  mo_energy =
[-3.27692059e+01 -1.92722836e+00 -8.47816991e-01 -8.47816991e-01
 -8.47816991e-01  8.07929480e-01  8.07929480e-01  8.07929480e-01
  2.00584299e+00  3.87837886e+00  3.87837886e+00  3.87837886e+00
  1.40358158e+01  1.40358158e+01  1.40358158e+01  1.94395617e+01
  5.07194434e+01  5.07194434e+01  5.07194434e+01  9.40623061e+01
  2.04489249e+02  2.04489249e+02  2.04489249e+02  3.56411802e+02
  1.34977640e+03  5.83617077e+03  3.50986982e+04]
E1 = -182.5907493255519  E_coul = 54.05361711930953
cycle= 3 E= -128.537132206242  delta_E= -0.000912  |g|= 0.00047  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00122264
diis-c [-1.10147356e-07 -2.17107015e-03  2.76223304e-04  1.00189485e+00]
  HOMO = -0.848039552131509  LUMO = 0.807904189344314
  mo_energy =
[-3.27696640e+01 -1.92739594e+00 -8.48039552e-01 -8.48039552e-01
 -8.48039552e-01  8.07904189e-01  8.07904189e-01  8.07904189e-01
  2.00575631e+00  3.87823303e+00  3.87823303e+00  3.87823303e+00
  1.40355418e+01  1.40355418e+01  1.40355418e+01  1.94392704e+01
  5.07190574e+01  5.07190574e+01  5.07190574e+01  9.40618790e+01
  2.04488737e+02  2.04488737e+02  2.04488737e+02  3.56411241e+02
  1.34977569e+03  5.83616994e+03  3.50986973e+04]
E1 = -182.59135173712133  E_coul = 54.054219513366725
cycle= 4 E= -128.537132223755  delta_E= -1.75e-08  |g|= 7.39e-05  |ddm|= 0.000118
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000196007
diis-c [-5.07207740e-10  1.42593919e-04  5.17319400e-04 -1.32474313e-01
  1.13181440e+00]
  HOMO = -0.848074817346127  LUMO = 0.807893906925449
  mo_energy =
[-3.27697362e+01 -1.92742509e+00 -8.48074817e-01 -8.48074817e-01
 -8.48074817e-01  8.07893907e-01  8.07893907e-01  8.07893907e-01
  2.00573376e+00  3.87820006e+00  3.87820006e+00  3.87820006e+00
  1.40354893e+01  1.40354893e+01  1.40354893e+01  1.94392153e+01
  5.07189919e+01  5.07189919e+01  5.07189919e+01  9.40618095e+01
  2.04488662e+02  2.04488662e+02  2.04488662e+02  3.56411162e+02
  1.34977560e+03  5.83616984e+03  3.50986972e+04]
E1 = -182.59150967610324  E_coul = 54.05437745185169
cycle= 5 E= -128.537132224252  delta_E= -4.97e-10  |g|= 2.98e-06  |ddm|= 1.75e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59150967610324  E_coul = 54.05437745185169
  HOMO = -0.848073561134323  LUMO = 0.807894279645296
  mo_energy =
[-3.27697334e+01 -1.92742327e+00 -8.48073561e-01 -8.48073561e-01
 -8.48073561e-01  8.07894280e-01  8.07894280e-01  8.07894280e-01
  2.00573513e+00  3.87820127e+00  3.87820127e+00  3.87820127e+00
  1.40354914e+01  1.40354914e+01  1.40354914e+01  1.94392179e+01
  5.07189946e+01  5.07189946e+01  5.07189946e+01  9.40618122e+01
  2.04488665e+02  2.04488665e+02  2.04488665e+02  3.56411164e+02
  1.34977561e+03  5.83616984e+03  3.50986972e+04]
E1 = -182.5915030502944  E_coul = 54.05437082604232
Extra cycle  E= -128.537132224252  delta_E= -5.4e-13  |g|= 9.64e-07  |ddm|= 1.62e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 243.01793247354408
E1 = -182.5915030502944  E_coul = 54.05437082604232
init E= -128.537132224252
    CPU time for initialize scf      0.31 sec, wall time      0.30 sec
  HOMO = -0.848074039381164  LUMO = 0.807894171302908
  mo_energy =
[-3.27697349e+01 -1.92742367e+00 -8.48074039e-01 -8.48074039e-01
 -8.48074039e-01  8.07894171e-01  8.07894171e-01  8.07894171e-01
  2.00573488e+00  3.87820086e+00  3.87820086e+00  3.87820086e+00
  1.40354906e+01  1.40354906e+01  1.40354906e+01  1.94392169e+01
  5.07189934e+01  5.07189934e+01  5.07189934e+01  9.40618108e+01
  2.04488663e+02  2.04488663e+02  2.04488663e+02  3.56411163e+02
  1.34977560e+03  5.83616984e+03  3.50986972e+04]
E1 = -182.59150675208838  E_coul = 54.054374527835954
cycle= 1 E= -128.537132224252  delta_E= -3.41e-13  |g|= 5.12e-07  |ddm|= 3.47e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59150675208838  E_coul = 54.054374527835954
  HOMO = -0.848073780379608  LUMO = 0.80789423650044
  mo_energy =
[-3.27697341e+01 -1.92742338e+00 -8.48073780e-01 -8.48073780e-01
 -8.48073780e-01  8.07894237e-01  8.07894237e-01  8.07894237e-01
  2.00573508e+00  3.87820110e+00  3.87820110e+00  3.87820110e+00
  1.40354910e+01  1.40354910e+01  1.40354910e+01  1.94392175e+01
  5.07189940e+01  5.07189940e+01  5.07189940e+01  9.40618115e+01
  2.04488664e+02  2.04488664e+02  2.04488664e+02  3.56411164e+02
  1.34977560e+03  5.83616984e+03  3.50986972e+04]
E1 = -182.5915049209175  E_coul = 54.05437269666557
Extra cycle  E= -128.537132224252  delta_E= 4.83e-13  |g|= 2.48e-07  |ddm|= 2.08e-07
    CPU time for scf_cycle      0.38 sec, wall time      0.39 sec
exp = [1.80764787e+04 2.71209726e+03 6.17491054e+02 1.74959815e+02
 2.05282820e+01 5.69152619e+01 4.86269824e-01 7.92125258e+00
 1.65285935e+00 6.98077788e+00 2.18981998e+01 8.06258737e+01
 2.66935374e-01 2.42140248e+00 8.32877571e-01]
grad_E = [-1.20617311e-10  5.40330039e-09 -2.16495797e-08 -2.17362130e-06
 -2.61648522e-04  4.01089939e-05 -3.03960121e-03  5.59113773e-04
  7.55085761e-04 -5.72754727e-04  3.65317663e-04 -9.16435602e-05
 -1.19802742e-04  6.12289751e-04  4.64930312e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787187        1
[INPUT] 0    0    [1    /1   ]  2712.09736484        1
[INPUT] 0    0    [1    /1   ]  617.489239285        1
[INPUT] 0    0    [1    /1   ]  174.973065283        1
[INPUT] 0    0    [1    /1   ]  20.5504575252        1
[INPUT] 0    0    [1    /1   ]  56.8990009519        1
[INPUT] 0    0    [1    /1   ]  0.488332737357       1
[INPUT] 0    0    [1    /1   ]  7.92726704806        1
[INPUT] 0    0    [1    /1   ]  1.65515935114        1
[INPUT] 1    0    [1    /1   ]  7.25636702968        1
[INPUT] 1    0    [1    /1   ]  23.1272788732        1
[INPUT] 1    0    [1    /1   ]  86.7296987076        1
[INPUT] 1    0    [1    /1   ]  0.270024278616       1
[INPUT] 1    0    [1    /1   ]  2.48840617297        1
[INPUT] 1    0    [1    /1   ]  0.848949788123       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478718741993, 1.0]], [0, [2712.0973648416852, 1.0]], [0, [617.4892392845288, 1.0]], [0, [174.9730652830922, 1.0]], [0, [20.550457525198503, 1.0]], [0, [56.89900095194541, 1.0]], [0, [0.4883327373568531, 1.0]], [0, [7.927267048060548, 1.0]], [0, [1.6551593511423073, 1.0]], [1, [7.256367029682678, 1.0]], [1, [23.127278873198716, 1.0]], [1, [86.72969870755375, 1.0]], [1, [0.2700242786160073, 1.0]], [1, [2.488406172966987, 1.0]], [1, [0.8489497881228327, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871874]
bas 1, expnt(s) = [2712.09736484]
bas 2, expnt(s) = [617.48923928]
bas 3, expnt(s) = [174.97306528]
bas 4, expnt(s) = [20.55045753]
bas 5, expnt(s) = [56.89900095]
bas 6, expnt(s) = [0.48833274]
bas 7, expnt(s) = [7.92726705]
bas 8, expnt(s) = [1.65515935]
bas 9, expnt(s) = [7.25636703]
bas 10, expnt(s) = [23.12727887]
bas 11, expnt(s) = [86.72969871]
bas 12, expnt(s) = [0.27002428]
bas 13, expnt(s) = [2.48840617]
bas 14, expnt(s) = [0.84894979]
CPU time:       202.52
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209736e+03 9.49497841e+02
 6.17489239e+02 3.12958729e+02 1.74973065e+02 1.21546771e+02
 2.05504575e+01 2.43854709e+01 5.68990010e+01 5.23411795e+01
 4.88332737e-01 1.47588291e+00 7.92726705e+00 1.19359679e+01
 1.65515935e+00 3.68676014e+00 7.25636703e+00 3.47442902e+01
 2.31272789e+01 1.47958549e+02 8.67296987e+01 7.72136690e+02
 2.70024279e-01 5.67855597e-01 2.48840617e+00 9.11771431e+00
 8.48949788e-01 2.37731592e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999137797070597
cond(S) = 243.61130887588394
E1 = -183.58627594007922  E_coul = 55.08153774804162
init E= -128.504738192038
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775258842266371  LUMO = 0.839765007001013
  mo_energy =
[-3.25541941e+01 -1.85121575e+00 -7.75258842e-01 -7.75258842e-01
 -7.75258842e-01  8.39765007e-01  8.39765007e-01  8.39765007e-01
  2.06693068e+00  4.03521506e+00  4.03521506e+00  4.03521506e+00
  1.46455284e+01  1.46455284e+01  1.46455284e+01  1.96224105e+01
  5.35064177e+01  5.35064177e+01  5.35064177e+01  9.43413831e+01
  2.19610301e+02  2.19610301e+02  2.19610301e+02  3.56736389e+02
  1.35013865e+03  5.83655802e+03  3.50990914e+04]
E1 = -182.0923731281953  E_coul = 53.55856213728554
cycle= 1 E= -128.53381099091  delta_E= -0.0291  |g|= 0.203  |ddm|= 0.168
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505162
diis-c [-0.25518835  1.        ]
  HOMO = -0.883090442625229  LUMO = 0.812895228439053
  mo_energy =
[-3.28765039e+01 -1.96448731e+00 -8.83090443e-01 -8.83090443e-01
 -8.83090443e-01  8.12895228e-01  8.12895228e-01  8.12895228e-01
  1.98975038e+00  3.93723620e+00  3.93723620e+00  3.93723620e+00
  1.44546492e+01  1.44546492e+01  1.44546492e+01  1.94003045e+01
  5.32270320e+01  5.32270320e+01  5.32270320e+01  9.40376901e+01
  2.19269784e+02  2.19269784e+02  2.19269784e+02  3.56385437e+02
  1.34974962e+03  5.83613717e+03  3.50986490e+04]
E1 = -182.84936212753294  E_coul = 54.31296665926483
cycle= 2 E= -128.536395468268  delta_E= -0.00258  |g|= 0.103  |ddm|= 0.0736
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254836
diis-c [-6.10257598e-04  3.34526508e-01  6.65473492e-01]
  HOMO = -0.847612206973291  LUMO = 0.821782898435592
  mo_energy =
[-3.27687758e+01 -1.92703842e+00 -8.47612207e-01 -8.47612207e-01
 -8.47612207e-01  8.21782898e-01  8.21782898e-01  8.21782898e-01
  2.01503689e+00  3.96923032e+00  3.96923032e+00  3.96923032e+00
  1.45180320e+01  1.45180320e+01  1.45180320e+01  1.94746361e+01
  5.33205455e+01  5.33205455e+01  5.33205455e+01  9.41394416e+01
  2.19381886e+02  2.19381886e+02  2.19381886e+02  3.56499965e+02
  1.34987040e+03  5.83626089e+03  3.50987738e+04]
E1 = -182.5935156414137  E_coul = 54.05621482615782
cycle= 3 E= -128.537300815256  delta_E= -0.000905  |g|= 0.00047  |ddm|= 0.0255
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120719
diis-c [-1.01959100e-07 -2.17741751e-03  2.63504949e-04  1.00191391e+00]
  HOMO = -0.847837183890453  LUMO = 0.821755416805573
  mo_energy =
[-3.27692406e+01 -1.92721402e+00 -8.47837184e-01 -8.47837184e-01
 -8.47837184e-01  8.21755417e-01  8.21755417e-01  8.21755417e-01
  2.01494334e+00  3.96907775e+00  3.96907775e+00  3.96907775e+00
  1.45177479e+01  1.45177479e+01  1.45177479e+01  1.94743380e+01
  5.33201479e+01  5.33201479e+01  5.33201479e+01  9.41390078e+01
  2.19381361e+02  2.19381361e+02  2.19381361e+02  3.56499399e+02
  1.34986968e+03  5.83626006e+03  3.50987729e+04]
E1 = -182.59412842794833  E_coul = 54.056827595542714
cycle= 4 E= -128.537300832406  delta_E= -1.71e-08  |g|= 7.11e-05  |ddm|= 0.000114
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185272
diis-c [-4.38291468e-10  1.28584863e-04  4.88549992e-04 -1.23548906e-01
  1.12293177e+00]
  HOMO = -0.847871526180847  LUMO = 0.821745082548686
  mo_energy =
[-3.27693103e+01 -1.92724345e+00 -8.47871526e-01 -8.47871526e-01
 -8.47871526e-01  8.21745083e-01  8.21745083e-01  8.21745083e-01
  2.01492040e+00  3.96904491e+00  3.96904491e+00  3.96904491e+00
  1.45176961e+01  1.45176961e+01  1.45176961e+01  1.94742841e+01
  5.33200839e+01  5.33200839e+01  5.33200839e+01  9.41389405e+01
  2.19381288e+02  2.19381288e+02  2.19381288e+02  3.56499323e+02
  1.34986960e+03  5.83625997e+03  3.50987728e+04]
E1 = -182.5942791023791  E_coul = 54.05697826952743
cycle= 5 E= -128.537300832852  delta_E= -4.46e-10  |g|= 2.6e-06  |ddm|= 1.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5942791023791  E_coul = 54.05697826952743
  HOMO = -0.847870474246862  LUMO = 0.82174539415567
  mo_energy =
[-3.27693079e+01 -1.92724191e+00 -8.47870474e-01 -8.47870474e-01
 -8.47870474e-01  8.21745394e-01  8.21745394e-01  8.21745394e-01
  2.01492155e+00  3.96904593e+00  3.96904593e+00  3.96904593e+00
  1.45176979e+01  1.45176979e+01  1.45176979e+01  1.94742863e+01
  5.33200862e+01  5.33200862e+01  5.33200862e+01  9.41389428e+01
  2.19381290e+02  2.19381290e+02  2.19381290e+02  3.56499325e+02
  1.34986960e+03  5.83625997e+03  3.50987728e+04]
E1 = -182.594273149962  E_coul = 54.05697231711022
Extra cycle  E= -128.537300832852  delta_E= -1.14e-13  |g|= 8.56e-07  |ddm|= 1.41e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209736e+03 6.17489239e+02 1.74973065e+02
 2.05504575e+01 5.68990010e+01 4.88332737e-01 7.92726705e+00
 1.65515935e+00 7.25636703e+00 2.31272789e+01 8.67296987e+01
 2.70024279e-01 2.48840617e+00 8.48949788e-01]
E = -128.53730083285177
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787187        1
[INPUT] 0    0    [1    /1   ]  2712.09736484        1
[INPUT] 0    0    [1    /1   ]  617.489239285        1
[INPUT] 0    0    [1    /1   ]  174.973065283        1
[INPUT] 0    0    [1    /1   ]  20.5504575252        1
[INPUT] 0    0    [1    /1   ]  56.8990009519        1
[INPUT] 0    0    [1    /1   ]  0.488332737357       1
[INPUT] 0    0    [1    /1   ]  7.92726704806        1
[INPUT] 0    0    [1    /1   ]  1.65515935114        1
[INPUT] 1    0    [1    /1   ]  7.25636702968        1
[INPUT] 1    0    [1    /1   ]  23.1272788732        1
[INPUT] 1    0    [1    /1   ]  86.7296987076        1
[INPUT] 1    0    [1    /1   ]  0.270024278616       1
[INPUT] 1    0    [1    /1   ]  2.48840617297        1
[INPUT] 1    0    [1    /1   ]  0.848949788123       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478718741993, 1.0]], [0, [2712.0973648416852, 1.0]], [0, [617.4892392845288, 1.0]], [0, [174.9730652830922, 1.0]], [0, [20.550457525198503, 1.0]], [0, [56.89900095194541, 1.0]], [0, [0.4883327373568531, 1.0]], [0, [7.927267048060548, 1.0]], [0, [1.6551593511423073, 1.0]], [1, [7.256367029682678, 1.0]], [1, [23.127278873198716, 1.0]], [1, [86.72969870755375, 1.0]], [1, [0.2700242786160073, 1.0]], [1, [2.488406172966987, 1.0]], [1, [0.8489497881228327, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871874]
bas 1, expnt(s) = [2712.09736484]
bas 2, expnt(s) = [617.48923928]
bas 3, expnt(s) = [174.97306528]
bas 4, expnt(s) = [20.55045753]
bas 5, expnt(s) = [56.89900095]
bas 6, expnt(s) = [0.48833274]
bas 7, expnt(s) = [7.92726705]
bas 8, expnt(s) = [1.65515935]
bas 9, expnt(s) = [7.25636703]
bas 10, expnt(s) = [23.12727887]
bas 11, expnt(s) = [86.72969871]
bas 12, expnt(s) = [0.27002428]
bas 13, expnt(s) = [2.48840617]
bas 14, expnt(s) = [0.84894979]
CPU time:       203.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209736e+03 9.49497841e+02
 6.17489239e+02 3.12958729e+02 1.74973065e+02 1.21546771e+02
 2.05504575e+01 2.43854709e+01 5.68990010e+01 5.23411795e+01
 4.88332737e-01 1.47588291e+00 7.92726705e+00 1.19359679e+01
 1.65515935e+00 3.68676014e+00 7.25636703e+00 3.47442902e+01
 2.31272789e+01 1.47958549e+02 8.67296987e+01 7.72136690e+02
 2.70024279e-01 5.67855597e-01 2.48840617e+00 9.11771431e+00
 8.48949788e-01 2.37731592e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999137797070597
cond(S) = 243.61130887588394
E1 = -183.58627594007922  E_coul = 55.08153774804162
init E= -128.504738192038
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775258842266371  LUMO = 0.839765007001013
  mo_energy =
[-3.25541941e+01 -1.85121575e+00 -7.75258842e-01 -7.75258842e-01
 -7.75258842e-01  8.39765007e-01  8.39765007e-01  8.39765007e-01
  2.06693068e+00  4.03521506e+00  4.03521506e+00  4.03521506e+00
  1.46455284e+01  1.46455284e+01  1.46455284e+01  1.96224105e+01
  5.35064177e+01  5.35064177e+01  5.35064177e+01  9.43413831e+01
  2.19610301e+02  2.19610301e+02  2.19610301e+02  3.56736389e+02
  1.35013865e+03  5.83655802e+03  3.50990914e+04]
E1 = -182.0923731281953  E_coul = 53.55856213728554
cycle= 1 E= -128.53381099091  delta_E= -0.0291  |g|= 0.203  |ddm|= 0.168
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.505162
diis-c [-0.25518835  1.        ]
  HOMO = -0.883090442625229  LUMO = 0.812895228439053
  mo_energy =
[-3.28765039e+01 -1.96448731e+00 -8.83090443e-01 -8.83090443e-01
 -8.83090443e-01  8.12895228e-01  8.12895228e-01  8.12895228e-01
  1.98975038e+00  3.93723620e+00  3.93723620e+00  3.93723620e+00
  1.44546492e+01  1.44546492e+01  1.44546492e+01  1.94003045e+01
  5.32270320e+01  5.32270320e+01  5.32270320e+01  9.40376901e+01
  2.19269784e+02  2.19269784e+02  2.19269784e+02  3.56385437e+02
  1.34974962e+03  5.83613717e+03  3.50986490e+04]
E1 = -182.84936212753294  E_coul = 54.31296665926483
cycle= 2 E= -128.536395468268  delta_E= -0.00258  |g|= 0.103  |ddm|= 0.0736
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254836
diis-c [-6.10257598e-04  3.34526508e-01  6.65473492e-01]
  HOMO = -0.847612206973291  LUMO = 0.821782898435592
  mo_energy =
[-3.27687758e+01 -1.92703842e+00 -8.47612207e-01 -8.47612207e-01
 -8.47612207e-01  8.21782898e-01  8.21782898e-01  8.21782898e-01
  2.01503689e+00  3.96923032e+00  3.96923032e+00  3.96923032e+00
  1.45180320e+01  1.45180320e+01  1.45180320e+01  1.94746361e+01
  5.33205455e+01  5.33205455e+01  5.33205455e+01  9.41394416e+01
  2.19381886e+02  2.19381886e+02  2.19381886e+02  3.56499965e+02
  1.34987040e+03  5.83626089e+03  3.50987738e+04]
E1 = -182.5935156414137  E_coul = 54.05621482615782
cycle= 3 E= -128.537300815256  delta_E= -0.000905  |g|= 0.00047  |ddm|= 0.0255
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120719
diis-c [-1.01959100e-07 -2.17741751e-03  2.63504949e-04  1.00191391e+00]
  HOMO = -0.847837183890453  LUMO = 0.821755416805573
  mo_energy =
[-3.27692406e+01 -1.92721402e+00 -8.47837184e-01 -8.47837184e-01
 -8.47837184e-01  8.21755417e-01  8.21755417e-01  8.21755417e-01
  2.01494334e+00  3.96907775e+00  3.96907775e+00  3.96907775e+00
  1.45177479e+01  1.45177479e+01  1.45177479e+01  1.94743380e+01
  5.33201479e+01  5.33201479e+01  5.33201479e+01  9.41390078e+01
  2.19381361e+02  2.19381361e+02  2.19381361e+02  3.56499399e+02
  1.34986968e+03  5.83626006e+03  3.50987729e+04]
E1 = -182.59412842794833  E_coul = 54.056827595542714
cycle= 4 E= -128.537300832406  delta_E= -1.71e-08  |g|= 7.11e-05  |ddm|= 0.000114
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000185272
diis-c [-4.38291468e-10  1.28584863e-04  4.88549992e-04 -1.23548906e-01
  1.12293177e+00]
  HOMO = -0.847871526180847  LUMO = 0.821745082548686
  mo_energy =
[-3.27693103e+01 -1.92724345e+00 -8.47871526e-01 -8.47871526e-01
 -8.47871526e-01  8.21745083e-01  8.21745083e-01  8.21745083e-01
  2.01492040e+00  3.96904491e+00  3.96904491e+00  3.96904491e+00
  1.45176961e+01  1.45176961e+01  1.45176961e+01  1.94742841e+01
  5.33200839e+01  5.33200839e+01  5.33200839e+01  9.41389405e+01
  2.19381288e+02  2.19381288e+02  2.19381288e+02  3.56499323e+02
  1.34986960e+03  5.83625997e+03  3.50987728e+04]
E1 = -182.5942791023791  E_coul = 54.05697826952743
cycle= 5 E= -128.537300832852  delta_E= -4.46e-10  |g|= 2.6e-06  |ddm|= 1.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5942791023791  E_coul = 54.05697826952743
  HOMO = -0.847870474246862  LUMO = 0.82174539415567
  mo_energy =
[-3.27693079e+01 -1.92724191e+00 -8.47870474e-01 -8.47870474e-01
 -8.47870474e-01  8.21745394e-01  8.21745394e-01  8.21745394e-01
  2.01492155e+00  3.96904593e+00  3.96904593e+00  3.96904593e+00
  1.45176979e+01  1.45176979e+01  1.45176979e+01  1.94742863e+01
  5.33200862e+01  5.33200862e+01  5.33200862e+01  9.41389428e+01
  2.19381290e+02  2.19381290e+02  2.19381290e+02  3.56499325e+02
  1.34986960e+03  5.83625997e+03  3.50987728e+04]
E1 = -182.594273149962  E_coul = 54.05697231711022
Extra cycle  E= -128.537300832852  delta_E= -1.14e-13  |g|= 8.56e-07  |ddm|= 1.41e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 243.61130887588394
E1 = -182.594273149962  E_coul = 54.05697231711022
init E= -128.537300832852
    CPU time for initialize scf      0.28 sec, wall time      0.28 sec
  HOMO = -0.847870905903338  LUMO = 0.821745292182172
  mo_energy =
[-3.27693093e+01 -1.92724228e+00 -8.47870906e-01 -8.47870906e-01
 -8.47870906e-01  8.21745292e-01  8.21745292e-01  8.21745292e-01
  2.01492131e+00  3.96904555e+00  3.96904555e+00  3.96904555e+00
  1.45176971e+01  1.45176971e+01  1.45176971e+01  1.94742855e+01
  5.33200851e+01  5.33200851e+01  5.33200851e+01  9.41389416e+01
  2.19381289e+02  2.19381289e+02  2.19381289e+02  3.56499323e+02
  1.34986960e+03  5.83625996e+03  3.50987728e+04]
E1 = -182.5942764166563  E_coul = 54.05697558380456
cycle= 1 E= -128.537300832852  delta_E= 2.84e-14  |g|= 4.52e-07  |ddm|= 3.02e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5942764166563  E_coul = 54.05697558380456
  HOMO = -0.847870677612795  LUMO = 0.821745350827069
  mo_energy =
[-3.27693086e+01 -1.92724202e+00 -8.47870678e-01 -8.47870678e-01
 -8.47870678e-01  8.21745351e-01  8.21745351e-01  8.21745351e-01
  2.01492149e+00  3.96904576e+00  3.96904576e+00  3.96904576e+00
  1.45176975e+01  1.45176975e+01  1.45176975e+01  1.94742859e+01
  5.33200857e+01  5.33200857e+01  5.33200857e+01  9.41389422e+01
  2.19381289e+02  2.19381289e+02  2.19381289e+02  3.56499324e+02
  1.34986960e+03  5.83625997e+03  3.50987728e+04]
E1 = -182.59427479464776  E_coul = 54.05697396179565
Extra cycle  E= -128.537300832852  delta_E= -3.69e-13  |g|= 2.2e-07  |ddm|= 1.84e-07
    CPU time for scf_cycle      0.35 sec, wall time      0.35 sec
exp = [1.80764787e+04 2.71209736e+03 6.17489239e+02 1.74973065e+02
 2.05504575e+01 5.68990010e+01 4.88332737e-01 7.92726705e+00
 1.65515935e+00 7.25636703e+00 2.31272789e+01 8.67296987e+01
 2.70024279e-01 2.48840617e+00 8.48949788e-01]
grad_E = [-6.64208943e-10  3.36055157e-08 -5.54560930e-07  3.19691316e-06
 -1.81638310e-04  1.07230964e-05  1.72524909e-04  4.64259212e-04
  3.73785814e-05 -3.89956646e-04  3.18908074e-04 -6.96387915e-05
 -1.09572036e-03  2.40841840e-04  8.54568337e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:55:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787166        1
[INPUT] 0    0    [1    /1   ]  2712.09746733        1
[INPUT] 0    0    [1    /1   ]  617.487475737        1
[INPUT] 0    0    [1    /1   ]  174.985886151        1
[INPUT] 0    0    [1    /1   ]  20.5653652704        1
[INPUT] 0    0    [1    /1   ]  56.88437492          1
[INPUT] 0    0    [1    /1   ]  0.489698778242       1
[INPUT] 0    0    [1    /1   ]  7.94701143178        1
[INPUT] 0    0    [1    /1   ]  1.65545570264        1
[INPUT] 1    0    [1    /1   ]  7.38521841526        1
[INPUT] 1    0    [1    /1   ]  23.8928960601        1
[INPUT] 1    0    [1    /1   ]  92.7705376637        1
[INPUT] 1    0    [1    /1   ]  0.271933812581       1
[INPUT] 1    0    [1    /1   ]  2.51827815723        1
[INPUT] 1    0    [1    /1   ]  0.856701796792       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478716621692, 1.0]], [0, [2712.0974673276423, 1.0]], [0, [617.4874757372003, 1.0]], [0, [174.98588615126215, 1.0]], [0, [20.565365270415953, 1.0]], [0, [56.88437492004026, 1.0]], [0, [0.48969877824153923, 1.0]], [0, [7.947011431784802, 1.0]], [0, [1.6554557026424321, 1.0]], [1, [7.385218415258041, 1.0]], [1, [23.892896060053154, 1.0]], [1, [92.77053766374028, 1.0]], [1, [0.27193381258059673, 1.0]], [1, [2.5182781572305064, 1.0]], [1, [0.8567017967916342, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871662]
bas 1, expnt(s) = [2712.09746733]
bas 2, expnt(s) = [617.48747574]
bas 3, expnt(s) = [174.98588615]
bas 4, expnt(s) = [20.56536527]
bas 5, expnt(s) = [56.88437492]
bas 6, expnt(s) = [0.48969878]
bas 7, expnt(s) = [7.94701143]
bas 8, expnt(s) = [1.6554557]
bas 9, expnt(s) = [7.38521842]
bas 10, expnt(s) = [23.89289606]
bas 11, expnt(s) = [92.77053766]
bas 12, expnt(s) = [0.27193381]
bas 13, expnt(s) = [2.51827816]
bas 14, expnt(s) = [0.8567018]
CPU time:       206.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209747e+03 9.49497868e+02
 6.17487476e+02 3.12958059e+02 1.74985886e+02 1.21553450e+02
 2.05653653e+01 2.43987370e+01 5.68843749e+01 5.23310883e+01
 4.89698778e-01 1.47897826e+00 7.94701143e+00 1.19582575e+01
 1.65545570e+00 3.68725521e+00 7.38521842e+00 3.55171879e+01
 2.38928961e+01 1.54106297e+02 9.27705377e+01 8.39937526e+02
 2.71933813e-01 5.72879665e-01 2.51827816e+00 9.25473560e+00
 8.56701797e-01 2.40448178e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999117367428273
cond(S) = 244.51369830800772
E1 = -183.58631699731637  E_coul = 55.08144258282543
init E= -128.504874414491
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775286022447904  LUMO = 0.847784996203188
  mo_energy =
[-3.25542198e+01 -1.85122079e+00 -7.75286022e-01 -7.75286022e-01
 -7.75286022e-01  8.47784996e-01  8.47784996e-01  8.47784996e-01
  2.07221822e+00  4.08042281e+00  4.08042281e+00  4.08042281e+00
  1.48772449e+01  1.48772449e+01  1.48772449e+01  1.96647189e+01
  5.49873012e+01  5.49873012e+01  5.49873012e+01  9.44405506e+01
  2.32480873e+02  2.32480873e+02  2.32480873e+02  3.56844996e+02
  1.35025059e+03  5.83666370e+03  3.50991798e+04]
E1 = -182.09625290246487  E_coul = 53.56226936185138
cycle= 1 E= -128.533983540613  delta_E= -0.0291  |g|= 0.203  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.501167
diis-c [-0.25116847  1.        ]
  HOMO = -0.882808553778632  LUMO = 0.820659656987362
  mo_energy =
[-3.28758481e+01 -1.96420828e+00 -8.82808554e-01 -8.82808554e-01
 -8.82808554e-01  8.20659657e-01  8.20659657e-01  8.20659657e-01
  1.99513438e+00  3.98173447e+00  3.98173447e+00  3.98173447e+00
  1.46851155e+01  1.46851155e+01  1.46851155e+01  1.94430115e+01
  5.47064416e+01  5.47064416e+01  5.47064416e+01  9.41374902e+01
  2.32138736e+02  2.32138736e+02  2.32138736e+02  3.56494749e+02
  1.34986228e+03  5.83624356e+03  3.50987381e+04]
E1 = -182.8510324927762  E_coul = 54.314475805801656
cycle= 2 E= -128.536556686975  delta_E= -0.00257  |g|= 0.103  |ddm|= 0.0737
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.252696
diis-c [-6.09240535e-04  3.34404043e-01  6.65595957e-01]
  HOMO = -0.847430468295049  LUMO = 0.829632518867585
  mo_energy =
[-3.27684000e+01 -1.92686727e+00 -8.47430468e-01 -8.47430468e-01
 -8.47430468e-01  8.29632519e-01  8.29632519e-01  8.29632519e-01
  2.02038257e+00  4.01396692e+00  4.01396692e+00  4.01396692e+00
  1.47489117e+01  1.47489117e+01  1.47489117e+01  1.95171934e+01
  5.48004033e+01  5.48004033e+01  5.48004033e+01  9.42389831e+01
  2.32251128e+02  2.32251128e+02  2.32251128e+02  3.56608984e+02
  1.34998275e+03  5.83636698e+03  3.50988626e+04]
E1 = -182.59603009863275  E_coul = 54.058573491755006
cycle= 3 E= -128.537456606878  delta_E= -0.0009  |g|= 0.000465  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118288
diis-c [-9.53547347e-08 -2.17013464e-03  2.25820997e-04  1.00194431e+00]
  HOMO = -0.847654302743564  LUMO = 0.829604564540478
  mo_energy =
[-3.27688643e+01 -1.92704567e+00 -8.47654303e-01 -8.47654303e-01
 -8.47654303e-01  8.29604565e-01  8.29604565e-01  8.29604565e-01
  2.02028655e+00  4.01381318e+00  4.01381318e+00  4.01381318e+00
  1.47486255e+01  1.47486255e+01  1.47486255e+01  1.95168947e+01
  5.48000026e+01  5.48000026e+01  5.48000026e+01  9.42385497e+01
  2.32250597e+02  2.32250597e+02  2.32250597e+02  3.56608420e+02
  1.34998204e+03  5.83636615e+03  3.50988617e+04]
E1 = -182.59664133627103  E_coul = 54.05918471284829
cycle= 4 E= -128.537456623423  delta_E= -1.65e-08  |g|= 6.86e-05  |ddm|= 0.000111
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00017654
diis-c [-3.93888304e-10  1.17965606e-04  4.68361169e-04 -1.17104776e-01
  1.11651845e+00]
  HOMO = -0.847687674455901  LUMO = 0.829594347664237
  mo_energy =
[-3.27689319e+01 -1.92707496e+00 -8.47687674e-01 -8.47687674e-01
 -8.47687674e-01  8.29594348e-01  8.29594348e-01  8.29594348e-01
  2.02026363e+00  4.01378092e+00  4.01378092e+00  4.01378092e+00
  1.47485748e+01  1.47485748e+01  1.47485748e+01  1.95168422e+01
  5.47999403e+01  5.47999403e+01  5.47999403e+01  9.42384845e+01
  2.32250526e+02  2.32250526e+02  2.32250526e+02  3.56608347e+02
  1.34998196e+03  5.83636606e+03  3.50988616e+04]
E1 = -182.5967858840345  E_coul = 54.059329260204144
cycle= 5 E= -128.53745662383  delta_E= -4.08e-10  |g|= 2.31e-06  |ddm|= 1.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5967858840345  E_coul = 54.059329260204144
  HOMO = -0.84768677538438  LUMO = 0.829594609989747
  mo_energy =
[-3.27689297e+01 -1.92707362e+00 -8.47686775e-01 -8.47686775e-01
 -8.47686775e-01  8.29594610e-01  8.29594610e-01  8.29594610e-01
  2.02026461e+00  4.01378179e+00  4.01378179e+00  4.01378179e+00
  1.47485763e+01  1.47485763e+01  1.47485763e+01  1.95168441e+01
  5.47999423e+01  5.47999423e+01  5.47999423e+01  9.42384866e+01
  2.32250528e+02  2.32250528e+02  2.32250528e+02  3.56608348e+02
  1.34998196e+03  5.83636606e+03  3.50988616e+04]
E1 = -182.5967804386061  E_coul = 54.05932381477534
Extra cycle  E= -128.537456623831  delta_E= -3.98e-13  |g|= 7.74e-07  |ddm|= 1.25e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209747e+03 6.17487476e+02 1.74985886e+02
 2.05653653e+01 5.68843749e+01 4.89698778e-01 7.94701143e+00
 1.65545570e+00 7.38521842e+00 2.38928961e+01 9.27705377e+01
 2.71933813e-01 2.51827816e+00 8.56701797e-01]
E = -128.53745662383074
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787166        1
[INPUT] 0    0    [1    /1   ]  2712.09746733        1
[INPUT] 0    0    [1    /1   ]  617.487475737        1
[INPUT] 0    0    [1    /1   ]  174.985886151        1
[INPUT] 0    0    [1    /1   ]  20.5653652704        1
[INPUT] 0    0    [1    /1   ]  56.88437492          1
[INPUT] 0    0    [1    /1   ]  0.489698778242       1
[INPUT] 0    0    [1    /1   ]  7.94701143178        1
[INPUT] 0    0    [1    /1   ]  1.65545570264        1
[INPUT] 1    0    [1    /1   ]  7.38521841526        1
[INPUT] 1    0    [1    /1   ]  23.8928960601        1
[INPUT] 1    0    [1    /1   ]  92.7705376637        1
[INPUT] 1    0    [1    /1   ]  0.271933812581       1
[INPUT] 1    0    [1    /1   ]  2.51827815723        1
[INPUT] 1    0    [1    /1   ]  0.856701796792       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478716621692, 1.0]], [0, [2712.0974673276423, 1.0]], [0, [617.4874757372003, 1.0]], [0, [174.98588615126215, 1.0]], [0, [20.565365270415953, 1.0]], [0, [56.88437492004026, 1.0]], [0, [0.48969877824153923, 1.0]], [0, [7.947011431784802, 1.0]], [0, [1.6554557026424321, 1.0]], [1, [7.385218415258041, 1.0]], [1, [23.892896060053154, 1.0]], [1, [92.77053766374028, 1.0]], [1, [0.27193381258059673, 1.0]], [1, [2.5182781572305064, 1.0]], [1, [0.8567017967916342, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871662]
bas 1, expnt(s) = [2712.09746733]
bas 2, expnt(s) = [617.48747574]
bas 3, expnt(s) = [174.98588615]
bas 4, expnt(s) = [20.56536527]
bas 5, expnt(s) = [56.88437492]
bas 6, expnt(s) = [0.48969878]
bas 7, expnt(s) = [7.94701143]
bas 8, expnt(s) = [1.6554557]
bas 9, expnt(s) = [7.38521842]
bas 10, expnt(s) = [23.89289606]
bas 11, expnt(s) = [92.77053766]
bas 12, expnt(s) = [0.27193381]
bas 13, expnt(s) = [2.51827816]
bas 14, expnt(s) = [0.8567018]
CPU time:       207.46
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209747e+03 9.49497868e+02
 6.17487476e+02 3.12958059e+02 1.74985886e+02 1.21553450e+02
 2.05653653e+01 2.43987370e+01 5.68843749e+01 5.23310883e+01
 4.89698778e-01 1.47897826e+00 7.94701143e+00 1.19582575e+01
 1.65545570e+00 3.68725521e+00 7.38521842e+00 3.55171879e+01
 2.38928961e+01 1.54106297e+02 9.27705377e+01 8.39937526e+02
 2.71933813e-01 5.72879665e-01 2.51827816e+00 9.25473560e+00
 8.56701797e-01 2.40448178e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999117367428273
cond(S) = 244.51369830800772
E1 = -183.58631699731637  E_coul = 55.08144258282543
init E= -128.504874414491
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775286022447904  LUMO = 0.847784996203188
  mo_energy =
[-3.25542198e+01 -1.85122079e+00 -7.75286022e-01 -7.75286022e-01
 -7.75286022e-01  8.47784996e-01  8.47784996e-01  8.47784996e-01
  2.07221822e+00  4.08042281e+00  4.08042281e+00  4.08042281e+00
  1.48772449e+01  1.48772449e+01  1.48772449e+01  1.96647189e+01
  5.49873012e+01  5.49873012e+01  5.49873012e+01  9.44405506e+01
  2.32480873e+02  2.32480873e+02  2.32480873e+02  3.56844996e+02
  1.35025059e+03  5.83666370e+03  3.50991798e+04]
E1 = -182.09625290246487  E_coul = 53.56226936185138
cycle= 1 E= -128.533983540613  delta_E= -0.0291  |g|= 0.203  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.501167
diis-c [-0.25116847  1.        ]
  HOMO = -0.882808553778632  LUMO = 0.820659656987362
  mo_energy =
[-3.28758481e+01 -1.96420828e+00 -8.82808554e-01 -8.82808554e-01
 -8.82808554e-01  8.20659657e-01  8.20659657e-01  8.20659657e-01
  1.99513438e+00  3.98173447e+00  3.98173447e+00  3.98173447e+00
  1.46851155e+01  1.46851155e+01  1.46851155e+01  1.94430115e+01
  5.47064416e+01  5.47064416e+01  5.47064416e+01  9.41374902e+01
  2.32138736e+02  2.32138736e+02  2.32138736e+02  3.56494749e+02
  1.34986228e+03  5.83624356e+03  3.50987381e+04]
E1 = -182.8510324927762  E_coul = 54.314475805801656
cycle= 2 E= -128.536556686975  delta_E= -0.00257  |g|= 0.103  |ddm|= 0.0737
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.252696
diis-c [-6.09240535e-04  3.34404043e-01  6.65595957e-01]
  HOMO = -0.847430468295049  LUMO = 0.829632518867585
  mo_energy =
[-3.27684000e+01 -1.92686727e+00 -8.47430468e-01 -8.47430468e-01
 -8.47430468e-01  8.29632519e-01  8.29632519e-01  8.29632519e-01
  2.02038257e+00  4.01396692e+00  4.01396692e+00  4.01396692e+00
  1.47489117e+01  1.47489117e+01  1.47489117e+01  1.95171934e+01
  5.48004033e+01  5.48004033e+01  5.48004033e+01  9.42389831e+01
  2.32251128e+02  2.32251128e+02  2.32251128e+02  3.56608984e+02
  1.34998275e+03  5.83636698e+03  3.50988626e+04]
E1 = -182.59603009863275  E_coul = 54.058573491755006
cycle= 3 E= -128.537456606878  delta_E= -0.0009  |g|= 0.000465  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118288
diis-c [-9.53547347e-08 -2.17013464e-03  2.25820997e-04  1.00194431e+00]
  HOMO = -0.847654302743564  LUMO = 0.829604564540478
  mo_energy =
[-3.27688643e+01 -1.92704567e+00 -8.47654303e-01 -8.47654303e-01
 -8.47654303e-01  8.29604565e-01  8.29604565e-01  8.29604565e-01
  2.02028655e+00  4.01381318e+00  4.01381318e+00  4.01381318e+00
  1.47486255e+01  1.47486255e+01  1.47486255e+01  1.95168947e+01
  5.48000026e+01  5.48000026e+01  5.48000026e+01  9.42385497e+01
  2.32250597e+02  2.32250597e+02  2.32250597e+02  3.56608420e+02
  1.34998204e+03  5.83636615e+03  3.50988617e+04]
E1 = -182.59664133627103  E_coul = 54.05918471284829
cycle= 4 E= -128.537456623423  delta_E= -1.65e-08  |g|= 6.86e-05  |ddm|= 0.000111
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00017654
diis-c [-3.93888304e-10  1.17965606e-04  4.68361169e-04 -1.17104776e-01
  1.11651845e+00]
  HOMO = -0.847687674455901  LUMO = 0.829594347664237
  mo_energy =
[-3.27689319e+01 -1.92707496e+00 -8.47687674e-01 -8.47687674e-01
 -8.47687674e-01  8.29594348e-01  8.29594348e-01  8.29594348e-01
  2.02026363e+00  4.01378092e+00  4.01378092e+00  4.01378092e+00
  1.47485748e+01  1.47485748e+01  1.47485748e+01  1.95168422e+01
  5.47999403e+01  5.47999403e+01  5.47999403e+01  9.42384845e+01
  2.32250526e+02  2.32250526e+02  2.32250526e+02  3.56608347e+02
  1.34998196e+03  5.83636606e+03  3.50988616e+04]
E1 = -182.5967858840345  E_coul = 54.059329260204144
cycle= 5 E= -128.53745662383  delta_E= -4.08e-10  |g|= 2.31e-06  |ddm|= 1.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5967858840345  E_coul = 54.059329260204144
  HOMO = -0.84768677538438  LUMO = 0.829594609989747
  mo_energy =
[-3.27689297e+01 -1.92707362e+00 -8.47686775e-01 -8.47686775e-01
 -8.47686775e-01  8.29594610e-01  8.29594610e-01  8.29594610e-01
  2.02026461e+00  4.01378179e+00  4.01378179e+00  4.01378179e+00
  1.47485763e+01  1.47485763e+01  1.47485763e+01  1.95168441e+01
  5.47999423e+01  5.47999423e+01  5.47999423e+01  9.42384866e+01
  2.32250528e+02  2.32250528e+02  2.32250528e+02  3.56608348e+02
  1.34998196e+03  5.83636606e+03  3.50988616e+04]
E1 = -182.5967804386061  E_coul = 54.05932381477534
Extra cycle  E= -128.537456623831  delta_E= -3.98e-13  |g|= 7.74e-07  |ddm|= 1.25e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 244.51369830800772
E1 = -182.5967804386061  E_coul = 54.05932381477534
init E= -128.537456623831
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.847687171872364  LUMO = 0.829594513714234
  mo_energy =
[-3.27689309e+01 -1.92707397e+00 -8.47687172e-01 -8.47687172e-01
 -8.47687172e-01  8.29594514e-01  8.29594514e-01  8.29594514e-01
  2.02026439e+00  4.01378144e+00  4.01378144e+00  4.01378144e+00
  1.47485756e+01  1.47485756e+01  1.47485756e+01  1.95168433e+01
  5.47999413e+01  5.47999413e+01  5.47999413e+01  9.42384855e+01
  2.32250527e+02  2.32250527e+02  2.32250527e+02  3.56608347e+02
  1.34998196e+03  5.83636606e+03  3.50988616e+04]
E1 = -182.5967833781066  E_coul = 54.05932675427564
cycle= 1 E= -128.537456623831  delta_E= -2.27e-13  |g|= 4.07e-07  |ddm|= 2.68e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5967833781066  E_coul = 54.05932675427564
  HOMO = -0.847686966646026  LUMO = 0.829594566906813
  mo_energy =
[-3.27689303e+01 -1.92707373e+00 -8.47686967e-01 -8.47686967e-01
 -8.47686967e-01  8.29594567e-01  8.29594567e-01  8.29594567e-01
  2.02026455e+00  4.01378163e+00  4.01378163e+00  4.01378163e+00
  1.47485760e+01  1.47485760e+01  1.47485760e+01  1.95168438e+01
  5.47999418e+01  5.47999418e+01  5.47999418e+01  9.42384860e+01
  2.32250527e+02  2.32250527e+02  2.32250527e+02  3.56608348e+02
  1.34998196e+03  5.83636606e+03  3.50988616e+04]
E1 = -182.5967819134195  E_coul = 54.05932528958857
Extra cycle  E= -128.537456623831  delta_E= 2.84e-14  |g|= 1.98e-07  |ddm|= 1.66e-07
    CPU time for scf_cycle      0.33 sec, wall time      0.32 sec
exp = [1.80764787e+04 2.71209747e+03 6.17487476e+02 1.74985886e+02
 2.05653653e+01 5.68843749e+01 4.89698778e-01 7.94701143e+00
 1.65545570e+00 7.38521842e+00 2.38928961e+01 9.27705377e+01
 2.71933813e-01 2.51827816e+00 8.56701797e-01]
grad_E = [-8.84182111e-10  4.48733371e-08 -7.52805899e-07  4.79478694e-06
 -1.93552746e-04  6.98622958e-06  2.76925037e-03  5.16986511e-04
 -6.23866369e-04 -3.32226858e-04  2.70727365e-04 -4.83685472e-05
 -3.91812896e-04  1.18256946e-04  7.38013006e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787147        1
[INPUT] 0    0    [1    /1   ]  2712.0975609         1
[INPUT] 0    0    [1    /1   ]  617.485863213        1
[INPUT] 0    0    [1    /1   ]  174.997671358        1
[INPUT] 0    0    [1    /1   ]  20.5803262496        1
[INPUT] 0    0    [1    /1   ]  56.8701000101        1
[INPUT] 0    0    [1    /1   ]  0.489915926121       1
[INPUT] 0    0    [1    /1   ]  7.96574403445        1
[INPUT] 0    0    [1    /1   ]  1.65489041887        1
[INPUT] 1    0    [1    /1   ]  7.35883843879        1
[INPUT] 1    0    [1    /1   ]  24.1040624004        1
[INPUT] 1    0    [1    /1   ]  98.3122558896        1
[INPUT] 1    0    [1    /1   ]  0.269811985513       1
[INPUT] 1    0    [1    /1   ]  2.50800099832        1
[INPUT] 1    0    [1    /1   ]  0.851792748226       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478714687477, 1.0]], [0, [2712.0975609033885, 1.0]], [0, [617.4858632134684, 1.0]], [0, [174.99767135783395, 1.0]], [0, [20.580326249581553, 1.0]], [0, [56.87010001011714, 1.0]], [0, [0.4899159261207459, 1.0]], [0, [7.965744034451132, 1.0]], [0, [1.6548904188701075, 1.0]], [1, [7.358838438793366, 1.0]], [1, [24.104062400441364, 1.0]], [1, [98.31225588959155, 1.0]], [1, [0.26981198551317315, 1.0]], [1, [2.5080009983232427, 1.0]], [1, [0.851792748226482, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871469]
bas 1, expnt(s) = [2712.0975609]
bas 2, expnt(s) = [617.48586321]
bas 3, expnt(s) = [174.99767136]
bas 4, expnt(s) = [20.58032625]
bas 5, expnt(s) = [56.87010001]
bas 6, expnt(s) = [0.48991593]
bas 7, expnt(s) = [7.96574403]
bas 8, expnt(s) = [1.65489042]
bas 9, expnt(s) = [7.35883844]
bas 10, expnt(s) = [24.1040624]
bas 11, expnt(s) = [98.31225589]
bas 12, expnt(s) = [0.26981199]
bas 13, expnt(s) = [2.508001]
bas 14, expnt(s) = [0.85179275]
CPU time:       210.94
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209756e+03 9.49497893e+02
 6.17485863e+02 3.12957446e+02 1.74997671e+02 1.21559590e+02
 2.05803262e+01 2.44120480e+01 5.68701000e+01 5.23212388e+01
 4.89915926e-01 1.47947010e+00 7.96574403e+00 1.19793922e+01
 1.65489042e+00 3.68631086e+00 7.35883844e+00 3.53586746e+01
 2.41040624e+01 1.55810670e+02 9.83122559e+01 9.03116901e+02
 2.69811986e-01 5.67297592e-01 2.50800100e+00 9.20754868e+00
 8.51792748e-01 2.38727151e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999131793805077
cond(S) = 245.26786093012393
E1 = -183.5863760673241  E_coul = 55.08139214299319
init E= -128.504983924331
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775313354395385  LUMO = 0.84037066205799
  mo_energy =
[-3.25542297e+01 -1.85122590e+00 -7.75313354e-01 -7.75313354e-01
 -7.75313354e-01  8.40370662e-01  8.40370662e-01  8.40370662e-01
  2.07279085e+00  4.05483349e+00  4.05483349e+00  4.05483349e+00
  1.48120467e+01  1.48120467e+01  1.48120467e+01  1.96968167e+01
  5.51507150e+01  5.51507150e+01  5.51507150e+01  9.45284262e+01
  2.42261379e+02  2.42261379e+02  2.42261379e+02  3.56942844e+02
  1.35035139e+03  5.83675889e+03  3.50992594e+04]
E1 = -182.09493766261963  E_coul = 53.56081805726796
cycle= 1 E= -128.534119605352  delta_E= -0.0291  |g|= 0.203  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.499508
diis-c [-0.24950778  1.        ]
  HOMO = -0.88295486606849  LUMO = 0.813463884414872
  mo_energy =
[-3.28760510e+01 -1.96436419e+00 -8.82954866e-01 -8.82954866e-01
 -8.82954866e-01  8.13463884e-01  8.13463884e-01  8.13463884e-01
  1.99555809e+00  3.95634358e+00  3.95634358e+00  3.95634358e+00
  1.46198337e+01  1.46198337e+01  1.46198337e+01  1.94747863e+01
  5.48689687e+01  5.48689687e+01  5.48689687e+01  9.42251496e+01
  2.41917089e+02  2.41917089e+02  2.41917089e+02  3.56592397e+02
  1.34996286e+03  5.83633853e+03  3.50988175e+04]
E1 = -182.8505882613349  E_coul = 54.313893060089
cycle= 2 E= -128.536695201246  delta_E= -0.00258  |g|= 0.103  |ddm|= 0.0737
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.252039
diis-c [-6.08945325e-04  3.34559346e-01  6.65440654e-01]
  HOMO = -0.847541508941097  LUMO = 0.822359703731617
  mo_energy =
[-3.27685154e+01 -1.92698497e+00 -8.47541509e-01 -8.47541509e-01
 -8.47541509e-01  8.22359704e-01  8.22359704e-01  8.22359704e-01
  2.02084033e+00  3.98850156e+00  3.98850156e+00  3.98850156e+00
  1.46836594e+01  1.46836594e+01  1.46836594e+01  1.95490843e+01
  5.49632360e+01  5.49632360e+01  5.49632360e+01  9.43267342e+01
  2.42030049e+02  2.42030049e+02  2.42030049e+02  3.56706722e+02
  1.35008343e+03  5.83646204e+03  3.50989421e+04]
E1 = -182.59516559226293  E_coul = 54.057568140685305
cycle= 3 E= -128.537597451578  delta_E= -0.000902  |g|= 0.000466  |ddm|= 0.0255
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116918
diis-c [-9.41682644e-08 -2.17019794e-03  1.86020078e-04  1.00198418e+00]
  HOMO = -0.847767393271863  LUMO = 0.822331020571609
  mo_energy =
[-3.27689808e+01 -1.92716756e+00 -8.47767393e-01 -8.47767393e-01
 -8.47767393e-01  8.22331021e-01  8.22331021e-01  8.22331021e-01
  2.02074055e+00  3.98834592e+00  3.98834592e+00  3.98834592e+00
  1.46833707e+01  1.46833707e+01  1.46833707e+01  1.95487829e+01
  5.49628323e+01  5.49628323e+01  5.49628323e+01  9.43262994e+01
  2.42029511e+02  2.42029511e+02  2.42029511e+02  3.56706158e+02
  1.35008272e+03  5.83646121e+03  3.50989412e+04]
E1 = -182.59576773583063  E_coul = 54.05817026766201
cycle= 4 E= -128.537597468169  delta_E= -1.66e-08  |g|= 6.82e-05  |ddm|= 0.000114
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000173251
diis-c [-3.72750178e-10  1.11380368e-04  4.59450713e-04 -1.14165345e-01
  1.11359451e+00]
  HOMO = -0.847800919245485  LUMO = 0.822320745338459
  mo_energy =
[-3.27690480e+01 -1.92719754e+00 -8.47800919e-01 -8.47800919e-01
 -8.47800919e-01  8.22320745e-01  8.22320745e-01  8.22320745e-01
  2.02071697e+00  3.98831346e+00  3.98831346e+00  3.98831346e+00
  1.46833198e+01  1.46833198e+01  1.46833198e+01  1.95487302e+01
  5.49627701e+01  5.49627701e+01  5.49627701e+01  9.43262345e+01
  2.42029440e+02  2.42029440e+02  2.42029440e+02  3.56706085e+02
  1.35008264e+03  5.83646113e+03  3.50989411e+04]
E1 = -182.59590971473256  E_coul = 54.05831224616504
cycle= 5 E= -128.537597468568  delta_E= -3.99e-10  |g|= 2.12e-06  |ddm|= 1.56e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59590971473256  E_coul = 54.05831224616504
  HOMO = -0.84780009173271  LUMO = 0.822320976236906
  mo_energy =
[-3.27690460e+01 -1.92719633e+00 -8.47800092e-01 -8.47800092e-01
 -8.47800092e-01  8.22320976e-01  8.22320976e-01  8.22320976e-01
  2.02071785e+00  3.98831426e+00  3.98831426e+00  3.98831426e+00
  1.46833213e+01  1.46833213e+01  1.46833213e+01  1.95487320e+01
  5.49627720e+01  5.49627720e+01  5.49627720e+01  9.43262364e+01
  2.42029442e+02  2.42029442e+02  2.42029442e+02  3.56706087e+02
  1.35008264e+03  5.83646113e+03  3.50989411e+04]
E1 = -182.5959043601406  E_coul = 54.058306891572954
Extra cycle  E= -128.537597468568  delta_E= -1.14e-13  |g|= 7.47e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209756e+03 6.17485863e+02 1.74997671e+02
 2.05803262e+01 5.68701000e+01 4.89915926e-01 7.96574403e+00
 1.65489042e+00 7.35883844e+00 2.41040624e+01 9.83122559e+01
 2.69811986e-01 2.50800100e+00 8.51792748e-01]
E = -128.53759746856764
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787147        1
[INPUT] 0    0    [1    /1   ]  2712.0975609         1
[INPUT] 0    0    [1    /1   ]  617.485863213        1
[INPUT] 0    0    [1    /1   ]  174.997671358        1
[INPUT] 0    0    [1    /1   ]  20.5803262496        1
[INPUT] 0    0    [1    /1   ]  56.8701000101        1
[INPUT] 0    0    [1    /1   ]  0.489915926121       1
[INPUT] 0    0    [1    /1   ]  7.96574403445        1
[INPUT] 0    0    [1    /1   ]  1.65489041887        1
[INPUT] 1    0    [1    /1   ]  7.35883843879        1
[INPUT] 1    0    [1    /1   ]  24.1040624004        1
[INPUT] 1    0    [1    /1   ]  98.3122558896        1
[INPUT] 1    0    [1    /1   ]  0.269811985513       1
[INPUT] 1    0    [1    /1   ]  2.50800099832        1
[INPUT] 1    0    [1    /1   ]  0.851792748226       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478714687477, 1.0]], [0, [2712.0975609033885, 1.0]], [0, [617.4858632134684, 1.0]], [0, [174.99767135783395, 1.0]], [0, [20.580326249581553, 1.0]], [0, [56.87010001011714, 1.0]], [0, [0.4899159261207459, 1.0]], [0, [7.965744034451132, 1.0]], [0, [1.6548904188701075, 1.0]], [1, [7.358838438793366, 1.0]], [1, [24.104062400441364, 1.0]], [1, [98.31225588959155, 1.0]], [1, [0.26981198551317315, 1.0]], [1, [2.5080009983232427, 1.0]], [1, [0.851792748226482, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871469]
bas 1, expnt(s) = [2712.0975609]
bas 2, expnt(s) = [617.48586321]
bas 3, expnt(s) = [174.99767136]
bas 4, expnt(s) = [20.58032625]
bas 5, expnt(s) = [56.87010001]
bas 6, expnt(s) = [0.48991593]
bas 7, expnt(s) = [7.96574403]
bas 8, expnt(s) = [1.65489042]
bas 9, expnt(s) = [7.35883844]
bas 10, expnt(s) = [24.1040624]
bas 11, expnt(s) = [98.31225589]
bas 12, expnt(s) = [0.26981199]
bas 13, expnt(s) = [2.508001]
bas 14, expnt(s) = [0.85179275]
CPU time:       211.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209756e+03 9.49497893e+02
 6.17485863e+02 3.12957446e+02 1.74997671e+02 1.21559590e+02
 2.05803262e+01 2.44120480e+01 5.68701000e+01 5.23212388e+01
 4.89915926e-01 1.47947010e+00 7.96574403e+00 1.19793922e+01
 1.65489042e+00 3.68631086e+00 7.35883844e+00 3.53586746e+01
 2.41040624e+01 1.55810670e+02 9.83122559e+01 9.03116901e+02
 2.69811986e-01 5.67297592e-01 2.50800100e+00 9.20754868e+00
 8.51792748e-01 2.38727151e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999131793805077
cond(S) = 245.26786093012393
E1 = -183.5863760673241  E_coul = 55.08139214299319
init E= -128.504983924331
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775313354395385  LUMO = 0.84037066205799
  mo_energy =
[-3.25542297e+01 -1.85122590e+00 -7.75313354e-01 -7.75313354e-01
 -7.75313354e-01  8.40370662e-01  8.40370662e-01  8.40370662e-01
  2.07279085e+00  4.05483349e+00  4.05483349e+00  4.05483349e+00
  1.48120467e+01  1.48120467e+01  1.48120467e+01  1.96968167e+01
  5.51507150e+01  5.51507150e+01  5.51507150e+01  9.45284262e+01
  2.42261379e+02  2.42261379e+02  2.42261379e+02  3.56942844e+02
  1.35035139e+03  5.83675889e+03  3.50992594e+04]
E1 = -182.09493766261963  E_coul = 53.56081805726796
cycle= 1 E= -128.534119605352  delta_E= -0.0291  |g|= 0.203  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.499508
diis-c [-0.24950778  1.        ]
  HOMO = -0.88295486606849  LUMO = 0.813463884414872
  mo_energy =
[-3.28760510e+01 -1.96436419e+00 -8.82954866e-01 -8.82954866e-01
 -8.82954866e-01  8.13463884e-01  8.13463884e-01  8.13463884e-01
  1.99555809e+00  3.95634358e+00  3.95634358e+00  3.95634358e+00
  1.46198337e+01  1.46198337e+01  1.46198337e+01  1.94747863e+01
  5.48689687e+01  5.48689687e+01  5.48689687e+01  9.42251496e+01
  2.41917089e+02  2.41917089e+02  2.41917089e+02  3.56592397e+02
  1.34996286e+03  5.83633853e+03  3.50988175e+04]
E1 = -182.8505882613349  E_coul = 54.313893060089
cycle= 2 E= -128.536695201246  delta_E= -0.00258  |g|= 0.103  |ddm|= 0.0737
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.252039
diis-c [-6.08945325e-04  3.34559346e-01  6.65440654e-01]
  HOMO = -0.847541508941097  LUMO = 0.822359703731617
  mo_energy =
[-3.27685154e+01 -1.92698497e+00 -8.47541509e-01 -8.47541509e-01
 -8.47541509e-01  8.22359704e-01  8.22359704e-01  8.22359704e-01
  2.02084033e+00  3.98850156e+00  3.98850156e+00  3.98850156e+00
  1.46836594e+01  1.46836594e+01  1.46836594e+01  1.95490843e+01
  5.49632360e+01  5.49632360e+01  5.49632360e+01  9.43267342e+01
  2.42030049e+02  2.42030049e+02  2.42030049e+02  3.56706722e+02
  1.35008343e+03  5.83646204e+03  3.50989421e+04]
E1 = -182.59516559226293  E_coul = 54.057568140685305
cycle= 3 E= -128.537597451578  delta_E= -0.000902  |g|= 0.000466  |ddm|= 0.0255
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00116918
diis-c [-9.41682644e-08 -2.17019794e-03  1.86020078e-04  1.00198418e+00]
  HOMO = -0.847767393271863  LUMO = 0.822331020571609
  mo_energy =
[-3.27689808e+01 -1.92716756e+00 -8.47767393e-01 -8.47767393e-01
 -8.47767393e-01  8.22331021e-01  8.22331021e-01  8.22331021e-01
  2.02074055e+00  3.98834592e+00  3.98834592e+00  3.98834592e+00
  1.46833707e+01  1.46833707e+01  1.46833707e+01  1.95487829e+01
  5.49628323e+01  5.49628323e+01  5.49628323e+01  9.43262994e+01
  2.42029511e+02  2.42029511e+02  2.42029511e+02  3.56706158e+02
  1.35008272e+03  5.83646121e+03  3.50989412e+04]
E1 = -182.59576773583063  E_coul = 54.05817026766201
cycle= 4 E= -128.537597468169  delta_E= -1.66e-08  |g|= 6.82e-05  |ddm|= 0.000114
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000173251
diis-c [-3.72750178e-10  1.11380368e-04  4.59450713e-04 -1.14165345e-01
  1.11359451e+00]
  HOMO = -0.847800919245485  LUMO = 0.822320745338459
  mo_energy =
[-3.27690480e+01 -1.92719754e+00 -8.47800919e-01 -8.47800919e-01
 -8.47800919e-01  8.22320745e-01  8.22320745e-01  8.22320745e-01
  2.02071697e+00  3.98831346e+00  3.98831346e+00  3.98831346e+00
  1.46833198e+01  1.46833198e+01  1.46833198e+01  1.95487302e+01
  5.49627701e+01  5.49627701e+01  5.49627701e+01  9.43262345e+01
  2.42029440e+02  2.42029440e+02  2.42029440e+02  3.56706085e+02
  1.35008264e+03  5.83646113e+03  3.50989411e+04]
E1 = -182.59590971473256  E_coul = 54.05831224616504
cycle= 5 E= -128.537597468568  delta_E= -3.99e-10  |g|= 2.12e-06  |ddm|= 1.56e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59590971473256  E_coul = 54.05831224616504
  HOMO = -0.84780009173271  LUMO = 0.822320976236906
  mo_energy =
[-3.27690460e+01 -1.92719633e+00 -8.47800092e-01 -8.47800092e-01
 -8.47800092e-01  8.22320976e-01  8.22320976e-01  8.22320976e-01
  2.02071785e+00  3.98831426e+00  3.98831426e+00  3.98831426e+00
  1.46833213e+01  1.46833213e+01  1.46833213e+01  1.95487320e+01
  5.49627720e+01  5.49627720e+01  5.49627720e+01  9.43262364e+01
  2.42029442e+02  2.42029442e+02  2.42029442e+02  3.56706087e+02
  1.35008264e+03  5.83646113e+03  3.50989411e+04]
E1 = -182.5959043601406  E_coul = 54.058306891572954
Extra cycle  E= -128.537597468568  delta_E= -1.14e-13  |g|= 7.47e-07  |ddm|= 1.13e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 245.26786093012393
E1 = -182.5959043601406  E_coul = 54.058306891572954
init E= -128.537597468568
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.847800481975615  LUMO = 0.822320880862126
  mo_energy =
[-3.27690472e+01 -1.92719668e+00 -8.47800482e-01 -8.47800482e-01
 -8.47800482e-01  8.22320881e-01  8.22320881e-01  8.22320881e-01
  2.02071762e+00  3.98831391e+00  3.98831391e+00  3.98831391e+00
  1.46833206e+01  1.46833206e+01  1.46833206e+01  1.95487312e+01
  5.49627710e+01  5.49627710e+01  5.49627710e+01  9.43262353e+01
  2.42029441e+02  2.42029441e+02  2.42029441e+02  3.56706086e+02
  1.35008264e+03  5.83646113e+03  3.50989411e+04]
E1 = -182.5959072008213  E_coul = 54.05830973225334
cycle= 1 E= -128.537597468568  delta_E= -3.13e-13  |g|= 3.93e-07  |ddm|= 2.52e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5959072008213  E_coul = 54.05830973225334
  HOMO = -0.84780028359307  LUMO = 0.82232093157137
  mo_energy =
[-3.27690466e+01 -1.92719645e+00 -8.47800284e-01 -8.47800284e-01
 -8.47800284e-01  8.22320932e-01  8.22320932e-01  8.22320932e-01
  2.02071777e+00  3.98831409e+00  3.98831409e+00  3.98831409e+00
  1.46833210e+01  1.46833210e+01  1.46833210e+01  1.95487316e+01
  5.49627715e+01  5.49627715e+01  5.49627715e+01  9.43262359e+01
  2.42029442e+02  2.42029442e+02  2.42029442e+02  3.56706086e+02
  1.35008264e+03  5.83646113e+03  3.50989411e+04]
E1 = -182.5959057767239  E_coul = 54.058308308156306
Extra cycle  E= -128.537597468568  delta_E= 3.69e-13  |g|= 1.93e-07  |ddm|= 1.58e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209756e+03 6.17485863e+02 1.74997671e+02
 2.05803262e+01 5.68701000e+01 4.89915926e-01 7.96574403e+00
 1.65489042e+00 7.35883844e+00 2.41040624e+01 9.83122559e+01
 2.69811986e-01 2.50800100e+00 8.51792748e-01]
grad_E = [-1.09991286e-09  5.59289322e-08 -9.48241615e-07  6.38382366e-06
 -2.06000624e-04  3.12518674e-06  3.37464832e-03  5.73774163e-04
 -8.23068326e-04 -4.16338142e-04  2.10906383e-04 -2.68310853e-05
 -2.63566233e-03  4.31181049e-04  7.48908804e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787135        1
[INPUT] 0    0    [1    /1   ]  2712.0976174         1
[INPUT] 0    0    [1    /1   ]  617.484883753        1
[INPUT] 0    0    [1    /1   ]  175.004993           1
[INPUT] 0    0    [1    /1   ]  20.5983976936        1
[INPUT] 0    0    [1    /1   ]  56.8586977059        1
[INPUT] 0    0    [1    /1   ]  0.489318354165       1
[INPUT] 0    0    [1    /1   ]  7.96428406047        1
[INPUT] 0    0    [1    /1   ]  1.65412759201        1
[INPUT] 1    0    [1    /1   ]  7.23563716712        1
[INPUT] 1    0    [1    /1   ]  23.8116380963        1
[INPUT] 1    0    [1    /1   ]  101.602167422        1
[INPUT] 1    0    [1    /1   ]  0.270550428862       1
[INPUT] 1    0    [1    /1   ]  2.47687335454        1
[INPUT] 1    0    [1    /1   ]  0.84601828869        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478713523087, 1.0]], [0, [2712.0976174021807, 1.0]], [0, [617.4848837525537, 1.0]], [0, [175.00499300013527, 1.0]], [0, [20.59839769362595, 1.0]], [0, [56.85869770585681, 1.0]], [0, [0.48931835416451674, 1.0]], [0, [7.964284060468147, 1.0]], [0, [1.6541275920096419, 1.0]], [1, [7.235637167118671, 1.0]], [1, [23.81163809633705, 1.0]], [1, [101.6021674223124, 1.0]], [1, [0.270550428862014, 1.0]], [1, [2.476873354544742, 1.0]], [1, [0.8460182886902132, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871352]
bas 1, expnt(s) = [2712.0976174]
bas 2, expnt(s) = [617.48488375]
bas 3, expnt(s) = [175.004993]
bas 4, expnt(s) = [20.59839769]
bas 5, expnt(s) = [56.85869771]
bas 6, expnt(s) = [0.48931835]
bas 7, expnt(s) = [7.96428406]
bas 8, expnt(s) = [1.65412759]
bas 9, expnt(s) = [7.23563717]
bas 10, expnt(s) = [23.8116381]
bas 11, expnt(s) = [101.60216742]
bas 12, expnt(s) = [0.27055043]
bas 13, expnt(s) = [2.47687335]
bas 14, expnt(s) = [0.84601829]
CPU time:       215.18
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209762e+03 9.49497908e+02
 6.17484884e+02 3.12957074e+02 1.75004993e+02 1.21563404e+02
 2.05983977e+01 2.44281233e+01 5.68586977e+01 5.23133709e+01
 4.89318354e-01 1.47811646e+00 7.96428406e+00 1.19777455e+01
 1.65412759e+00 3.68503637e+00 7.23563717e+00 3.46202635e+01
 2.38116381e+01 1.53451446e+02 1.01602167e+02 9.41050887e+02
 2.70550429e-01 5.69239038e-01 2.47687335e+00 9.06492351e+00
 8.46018289e-01 2.36705899e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999138618523807
cond(S) = 245.25264421023388
E1 = -183.58660901143344  E_coul = 55.08143519555888
init E= -128.505173815875
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775319275277154  LUMO = 0.840268680537781
  mo_energy =
[-3.25542380e+01 -1.85121554e+00 -7.75319275e-01 -7.75319275e-01
 -7.75319275e-01  8.40268681e-01  8.40268681e-01  8.40268681e-01
  2.06999919e+00  4.02532822e+00  4.02532822e+00  4.02532822e+00
  1.46128286e+01  1.46128286e+01  1.46128286e+01  1.96944740e+01
  5.43256461e+01  5.43256461e+01  5.43256461e+01  9.45499823e+01
  2.46405650e+02  2.46405650e+02  2.46405650e+02  3.56974135e+02
  1.35038686e+03  5.83679391e+03  3.50992889e+04]
E1 = -182.09702717589442  E_coul = 53.56282752458911
cycle= 1 E= -128.534199651305  delta_E= -0.029  |g|= 0.203  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.49944
diis-c [-0.24944072  1.        ]
  HOMO = -0.882799892369398  LUMO = 0.813547714869454
  mo_energy =
[-3.28757662e+01 -1.96414486e+00 -8.82799892e-01 -8.82799892e-01
 -8.82799892e-01  8.13547715e-01  8.13547715e-01  8.13547715e-01
  1.99301337e+00  3.92793645e+00  3.92793645e+00  3.92793645e+00
  1.44222372e+01  1.44222372e+01  1.44222372e+01  1.94726599e+01
  5.40448118e+01  5.40448118e+01  5.40448118e+01  9.42469676e+01
  2.46060537e+02  2.46060537e+02  2.46060537e+02  3.56623948e+02
  1.34999856e+03  5.83637377e+03  3.50988472e+04]
E1 = -182.85193796769423  E_coul = 54.31516554529655
cycle= 2 E= -128.536772422398  delta_E= -0.00257  |g|= 0.103  |ddm|= 0.0735
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.251891
diis-c [-6.06243283e-04  3.34461067e-01  6.65538933e-01]
  HOMO = -0.847416259206298  LUMO = 0.822398262722705
  mo_energy =
[-3.27683189e+01 -1.92679753e+00 -8.47416259e-01 -8.47416259e-01
 -8.47416259e-01  8.22398263e-01  8.22398263e-01  8.22398263e-01
  2.01825567e+00  3.95976295e+00  3.95976295e+00  3.95976295e+00
  1.44855373e+01  1.44855373e+01  1.44855373e+01  1.95469027e+01
  5.41387873e+01  5.41387873e+01  5.41387873e+01  9.43484738e+01
  2.46173663e+02  2.46173663e+02  2.46173663e+02  3.56738181e+02
  1.35011903e+03  5.83649718e+03  3.50989717e+04]
E1 = -182.59696177641072  E_coul = 54.05928946939598
cycle= 3 E= -128.537672307015  delta_E= -0.0009  |g|= 0.000453  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115579
diis-c [-9.55757980e-08 -2.13651996e-03  1.95664287e-04  1.00194086e+00]
  HOMO = -0.847632880294486  LUMO = 0.822373568435212
  mo_energy =
[-3.27687698e+01 -1.92696633e+00 -8.47632880e-01 -8.47632880e-01
 -8.47632880e-01  8.22373568e-01  8.22373568e-01  8.22373568e-01
  2.01816781e+00  3.95961872e+00  3.95961872e+00  3.95961872e+00
  1.44852637e+01  1.44852637e+01  1.44852637e+01  1.95466155e+01
  5.41383988e+01  5.41383988e+01  5.41383988e+01  9.43480533e+01
  2.46173136e+02  2.46173136e+02  2.46173136e+02  3.56737630e+02
  1.35011833e+03  5.83649636e+03  3.50989708e+04]
E1 = -182.59755556637512  E_coul = 54.05988324361168
cycle= 4 E= -128.537672322763  delta_E= -1.57e-08  |g|= 6.82e-05  |ddm|= 0.000107
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000176353
diis-c [-4.17211663e-10  1.22704570e-04  4.76315982e-04 -1.20670489e-01
  1.12007147e+00]
  HOMO = -0.847665746158825  LUMO = 0.822363714259838
  mo_energy =
[-3.27688368e+01 -1.92699455e+00 -8.47665746e-01 -8.47665746e-01
 -8.47665746e-01  8.22363714e-01  8.22363714e-01  8.22363714e-01
  2.01814583e+00  3.95958737e+00  3.95958737e+00  3.95958737e+00
  1.44852140e+01  1.44852140e+01  1.44852140e+01  1.95465638e+01
  5.41383372e+01  5.41383372e+01  5.41383372e+01  9.43479887e+01
  2.46173065e+02  2.46173065e+02  2.46173065e+02  3.56737557e+02
  1.35011825e+03  5.83649627e+03  3.50989707e+04]
E1 = -182.59770049305618  E_coul = 54.06002816988337
cycle= 5 E= -128.537672323173  delta_E= -4.09e-10  |g|= 2.46e-06  |ddm|= 1.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59770049305618  E_coul = 54.06002816988337
  HOMO = -0.847664792827659  LUMO = 0.822363994548869
  mo_energy =
[-3.27688346e+01 -1.92699312e+00 -8.47664793e-01 -8.47664793e-01
 -8.47664793e-01  8.22363995e-01  8.22363995e-01  8.22363995e-01
  2.01814690e+00  3.95958830e+00  3.95958830e+00  3.95958830e+00
  1.44852157e+01  1.44852157e+01  1.44852157e+01  1.95465658e+01
  5.41383393e+01  5.41383393e+01  5.41383393e+01  9.43479909e+01
  2.46173067e+02  2.46173067e+02  2.46173067e+02  3.56737559e+02
  1.35011825e+03  5.83649627e+03  3.50989707e+04]
E1 = -182.59769499244223  E_coul = 54.06002266926852
Extra cycle  E= -128.537672323174  delta_E= -8.81e-13  |g|= 7.95e-07  |ddm|= 1.35e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209762e+03 6.17484884e+02 1.75004993e+02
 2.05983977e+01 5.68586977e+01 4.89318354e-01 7.96428406e+00
 1.65412759e+00 7.23563717e+00 2.38116381e+01 1.01602167e+02
 2.70550429e-01 2.47687335e+00 8.46018289e-01]
E = -128.5376723231737
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787135        1
[INPUT] 0    0    [1    /1   ]  2712.0976174         1
[INPUT] 0    0    [1    /1   ]  617.484883753        1
[INPUT] 0    0    [1    /1   ]  175.004993           1
[INPUT] 0    0    [1    /1   ]  20.5983976936        1
[INPUT] 0    0    [1    /1   ]  56.8586977059        1
[INPUT] 0    0    [1    /1   ]  0.489318354165       1
[INPUT] 0    0    [1    /1   ]  7.96428406047        1
[INPUT] 0    0    [1    /1   ]  1.65412759201        1
[INPUT] 1    0    [1    /1   ]  7.23563716712        1
[INPUT] 1    0    [1    /1   ]  23.8116380963        1
[INPUT] 1    0    [1    /1   ]  101.602167422        1
[INPUT] 1    0    [1    /1   ]  0.270550428862       1
[INPUT] 1    0    [1    /1   ]  2.47687335454        1
[INPUT] 1    0    [1    /1   ]  0.84601828869        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478713523087, 1.0]], [0, [2712.0976174021807, 1.0]], [0, [617.4848837525537, 1.0]], [0, [175.00499300013527, 1.0]], [0, [20.59839769362595, 1.0]], [0, [56.85869770585681, 1.0]], [0, [0.48931835416451674, 1.0]], [0, [7.964284060468147, 1.0]], [0, [1.6541275920096419, 1.0]], [1, [7.235637167118671, 1.0]], [1, [23.81163809633705, 1.0]], [1, [101.6021674223124, 1.0]], [1, [0.270550428862014, 1.0]], [1, [2.476873354544742, 1.0]], [1, [0.8460182886902132, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871352]
bas 1, expnt(s) = [2712.0976174]
bas 2, expnt(s) = [617.48488375]
bas 3, expnt(s) = [175.004993]
bas 4, expnt(s) = [20.59839769]
bas 5, expnt(s) = [56.85869771]
bas 6, expnt(s) = [0.48931835]
bas 7, expnt(s) = [7.96428406]
bas 8, expnt(s) = [1.65412759]
bas 9, expnt(s) = [7.23563717]
bas 10, expnt(s) = [23.8116381]
bas 11, expnt(s) = [101.60216742]
bas 12, expnt(s) = [0.27055043]
bas 13, expnt(s) = [2.47687335]
bas 14, expnt(s) = [0.84601829]
CPU time:       215.96
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209762e+03 9.49497908e+02
 6.17484884e+02 3.12957074e+02 1.75004993e+02 1.21563404e+02
 2.05983977e+01 2.44281233e+01 5.68586977e+01 5.23133709e+01
 4.89318354e-01 1.47811646e+00 7.96428406e+00 1.19777455e+01
 1.65412759e+00 3.68503637e+00 7.23563717e+00 3.46202635e+01
 2.38116381e+01 1.53451446e+02 1.01602167e+02 9.41050887e+02
 2.70550429e-01 5.69239038e-01 2.47687335e+00 9.06492351e+00
 8.46018289e-01 2.36705899e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999138618523807
cond(S) = 245.25264421023388
E1 = -183.58660901143344  E_coul = 55.08143519555888
init E= -128.505173815875
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775319275277154  LUMO = 0.840268680537781
  mo_energy =
[-3.25542380e+01 -1.85121554e+00 -7.75319275e-01 -7.75319275e-01
 -7.75319275e-01  8.40268681e-01  8.40268681e-01  8.40268681e-01
  2.06999919e+00  4.02532822e+00  4.02532822e+00  4.02532822e+00
  1.46128286e+01  1.46128286e+01  1.46128286e+01  1.96944740e+01
  5.43256461e+01  5.43256461e+01  5.43256461e+01  9.45499823e+01
  2.46405650e+02  2.46405650e+02  2.46405650e+02  3.56974135e+02
  1.35038686e+03  5.83679391e+03  3.50992889e+04]
E1 = -182.09702717589442  E_coul = 53.56282752458911
cycle= 1 E= -128.534199651305  delta_E= -0.029  |g|= 0.203  |ddm|= 0.166
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.49944
diis-c [-0.24944072  1.        ]
  HOMO = -0.882799892369398  LUMO = 0.813547714869454
  mo_energy =
[-3.28757662e+01 -1.96414486e+00 -8.82799892e-01 -8.82799892e-01
 -8.82799892e-01  8.13547715e-01  8.13547715e-01  8.13547715e-01
  1.99301337e+00  3.92793645e+00  3.92793645e+00  3.92793645e+00
  1.44222372e+01  1.44222372e+01  1.44222372e+01  1.94726599e+01
  5.40448118e+01  5.40448118e+01  5.40448118e+01  9.42469676e+01
  2.46060537e+02  2.46060537e+02  2.46060537e+02  3.56623948e+02
  1.34999856e+03  5.83637377e+03  3.50988472e+04]
E1 = -182.85193796769423  E_coul = 54.31516554529655
cycle= 2 E= -128.536772422398  delta_E= -0.00257  |g|= 0.103  |ddm|= 0.0735
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.251891
diis-c [-6.06243283e-04  3.34461067e-01  6.65538933e-01]
  HOMO = -0.847416259206298  LUMO = 0.822398262722705
  mo_energy =
[-3.27683189e+01 -1.92679753e+00 -8.47416259e-01 -8.47416259e-01
 -8.47416259e-01  8.22398263e-01  8.22398263e-01  8.22398263e-01
  2.01825567e+00  3.95976295e+00  3.95976295e+00  3.95976295e+00
  1.44855373e+01  1.44855373e+01  1.44855373e+01  1.95469027e+01
  5.41387873e+01  5.41387873e+01  5.41387873e+01  9.43484738e+01
  2.46173663e+02  2.46173663e+02  2.46173663e+02  3.56738181e+02
  1.35011903e+03  5.83649718e+03  3.50989717e+04]
E1 = -182.59696177641072  E_coul = 54.05928946939598
cycle= 3 E= -128.537672307015  delta_E= -0.0009  |g|= 0.000453  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00115579
diis-c [-9.55757980e-08 -2.13651996e-03  1.95664287e-04  1.00194086e+00]
  HOMO = -0.847632880294486  LUMO = 0.822373568435212
  mo_energy =
[-3.27687698e+01 -1.92696633e+00 -8.47632880e-01 -8.47632880e-01
 -8.47632880e-01  8.22373568e-01  8.22373568e-01  8.22373568e-01
  2.01816781e+00  3.95961872e+00  3.95961872e+00  3.95961872e+00
  1.44852637e+01  1.44852637e+01  1.44852637e+01  1.95466155e+01
  5.41383988e+01  5.41383988e+01  5.41383988e+01  9.43480533e+01
  2.46173136e+02  2.46173136e+02  2.46173136e+02  3.56737630e+02
  1.35011833e+03  5.83649636e+03  3.50989708e+04]
E1 = -182.59755556637512  E_coul = 54.05988324361168
cycle= 4 E= -128.537672322763  delta_E= -1.57e-08  |g|= 6.82e-05  |ddm|= 0.000107
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000176353
diis-c [-4.17211663e-10  1.22704570e-04  4.76315982e-04 -1.20670489e-01
  1.12007147e+00]
  HOMO = -0.847665746158825  LUMO = 0.822363714259838
  mo_energy =
[-3.27688368e+01 -1.92699455e+00 -8.47665746e-01 -8.47665746e-01
 -8.47665746e-01  8.22363714e-01  8.22363714e-01  8.22363714e-01
  2.01814583e+00  3.95958737e+00  3.95958737e+00  3.95958737e+00
  1.44852140e+01  1.44852140e+01  1.44852140e+01  1.95465638e+01
  5.41383372e+01  5.41383372e+01  5.41383372e+01  9.43479887e+01
  2.46173065e+02  2.46173065e+02  2.46173065e+02  3.56737557e+02
  1.35011825e+03  5.83649627e+03  3.50989707e+04]
E1 = -182.59770049305618  E_coul = 54.06002816988337
cycle= 5 E= -128.537672323173  delta_E= -4.09e-10  |g|= 2.46e-06  |ddm|= 1.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59770049305618  E_coul = 54.06002816988337
  HOMO = -0.847664792827659  LUMO = 0.822363994548869
  mo_energy =
[-3.27688346e+01 -1.92699312e+00 -8.47664793e-01 -8.47664793e-01
 -8.47664793e-01  8.22363995e-01  8.22363995e-01  8.22363995e-01
  2.01814690e+00  3.95958830e+00  3.95958830e+00  3.95958830e+00
  1.44852157e+01  1.44852157e+01  1.44852157e+01  1.95465658e+01
  5.41383393e+01  5.41383393e+01  5.41383393e+01  9.43479909e+01
  2.46173067e+02  2.46173067e+02  2.46173067e+02  3.56737559e+02
  1.35011825e+03  5.83649627e+03  3.50989707e+04]
E1 = -182.59769499244223  E_coul = 54.06002266926852
Extra cycle  E= -128.537672323174  delta_E= -8.81e-13  |g|= 7.95e-07  |ddm|= 1.35e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 245.25264421023388
E1 = -182.59769499244223  E_coul = 54.06002266926852
init E= -128.537672323174
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.84766519331276  LUMO = 0.82236389987238
  mo_energy =
[-3.27688358e+01 -1.92699346e+00 -8.47665193e-01 -8.47665193e-01
 -8.47665193e-01  8.22363900e-01  8.22363900e-01  8.22363900e-01
  2.01814669e+00  3.95958795e+00  3.95958795e+00  3.95958795e+00
  1.44852150e+01  1.44852150e+01  1.44852150e+01  1.95465650e+01
  5.41383382e+01  5.41383382e+01  5.41383382e+01  9.43479897e+01
  2.46173066e+02  2.46173066e+02  2.46173066e+02  3.56737558e+02
  1.35011825e+03  5.83649627e+03  3.50989707e+04]
E1 = -182.59769800280927  E_coul = 54.0600256796355
cycle= 1 E= -128.537672323174  delta_E= -5.68e-14  |g|= 4.18e-07  |ddm|= 2.8e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59769800280927  E_coul = 54.0600256796355
  HOMO = -0.847664983194117  LUMO = 0.822363953770714
  mo_energy =
[-3.27688352e+01 -1.92699322e+00 -8.47664983e-01 -8.47664983e-01
 -8.47664983e-01  8.22363954e-01  8.22363954e-01  8.22363954e-01
  2.01814685e+00  3.95958814e+00  3.95958814e+00  3.95958814e+00
  1.44852154e+01  1.44852154e+01  1.44852154e+01  1.95465655e+01
  5.41383388e+01  5.41383388e+01  5.41383388e+01  9.43479903e+01
  2.46173066e+02  2.46173066e+02  2.46173066e+02  3.56737558e+02
  1.35011825e+03  5.83649627e+03  3.50989707e+04]
E1 = -182.59769650939853  E_coul = 54.060024186224624
Extra cycle  E= -128.537672323174  delta_E= -1.71e-13  |g|= 2.02e-07  |ddm|= 1.71e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [1.80764787e+04 2.71209762e+03 6.17484884e+02 1.75004993e+02
 2.05983977e+01 5.68586977e+01 4.89318354e-01 7.96428406e+00
 1.65412759e+00 7.23563717e+00 2.38116381e+01 1.01602167e+02
 2.70550429e-01 2.47687335e+00 8.46018289e-01]
grad_E = [-1.57327047e-09  8.06077526e-08 -1.41970595e-06  1.13216620e-05
 -1.22067254e-04 -2.55530873e-05  2.71858001e-03  4.67351996e-04
 -7.28952266e-04 -4.60504108e-04  1.24629458e-04 -8.18766661e-06
  3.45072889e-03  7.83201388e-04 -1.20702765e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787134        1
[INPUT] 0    0    [1    /1   ]  2712.09762561        1
[INPUT] 0    0    [1    /1   ]  617.484735247        1
[INPUT] 0    0    [1    /1   ]  175.006276253        1
[INPUT] 0    0    [1    /1   ]  20.6118702714        1
[INPUT] 0    0    [1    /1   ]  56.8539931609        1
[INPUT] 0    0    [1    /1   ]  0.488249964211       1
[INPUT] 0    0    [1    /1   ]  7.94722719142        1
[INPUT] 0    0    [1    /1   ]  1.65475733169        1
[INPUT] 1    0    [1    /1   ]  7.15993556877        1
[INPUT] 1    0    [1    /1   ]  23.4955439948        1
[INPUT] 1    0    [1    /1   ]  101.996965629        1
[INPUT] 1    0    [1    /1   ]  0.265597337893       1
[INPUT] 1    0    [1    /1   ]  2.453093116          1
[INPUT] 1    0    [1    /1   ]  0.834881190569       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478713357348, 1.0]], [0, [2712.097625609477, 1.0]], [0, [617.4847352467715, 1.0]], [0, [175.00627625332777, 1.0]], [0, [20.611870271358157, 1.0]], [0, [56.853993160898845, 1.0]], [0, [0.4882499642110335, 1.0]], [0, [7.9472271914231225, 1.0]], [0, [1.65475733168706, 1.0]], [1, [7.159935568774462, 1.0]], [1, [23.495543994807015, 1.0]], [1, [101.99696562907418, 1.0]], [1, [0.26559733789347095, 1.0]], [1, [2.4530931159966776, 1.0]], [1, [0.8348811905686355, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871336]
bas 1, expnt(s) = [2712.09762561]
bas 2, expnt(s) = [617.48473525]
bas 3, expnt(s) = [175.00627625]
bas 4, expnt(s) = [20.61187027]
bas 5, expnt(s) = [56.85399316]
bas 6, expnt(s) = [0.48824996]
bas 7, expnt(s) = [7.94722719]
bas 8, expnt(s) = [1.65475733]
bas 9, expnt(s) = [7.15993557]
bas 10, expnt(s) = [23.49554399]
bas 11, expnt(s) = [101.99696563]
bas 12, expnt(s) = [0.26559734]
bas 13, expnt(s) = [2.45309312]
bas 14, expnt(s) = [0.83488119]
CPU time:       219.42
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209763e+03 9.49497910e+02
 6.17484735e+02 3.12957017e+02 1.75006276e+02 1.21564073e+02
 2.06118703e+01 2.44401054e+01 5.68539932e+01 5.23101245e+01
 4.88249964e-01 1.47569528e+00 7.94722719e+00 1.19585010e+01
 1.65475733e+00 3.68608851e+00 7.15993557e+00 3.41680965e+01
 2.34955440e+01 1.50909393e+02 1.01996966e+02 9.45623937e+02
 2.65597338e-01 5.56242335e-01 2.45309312e+00 8.95626499e+00
 8.34881191e-01 2.32817295e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999171514248548
cond(S) = 244.6836923306813
E1 = -183.58672907580677  E_coul = 55.08144830359368
init E= -128.505280772213
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775329455289988  LUMO = 0.823082564675535
  mo_energy =
[-3.25542348e+01 -1.85120975e+00 -7.75329455e-01 -7.75329455e-01
 -7.75329455e-01  8.23082565e-01  8.23082565e-01  8.23082565e-01
  2.06657055e+00  3.96432186e+00  3.96432186e+00  3.96432186e+00
  1.44313762e+01  1.44313762e+01  1.44313762e+01  1.96702034e+01
  5.35888601e+01  5.35888601e+01  5.35888601e+01  9.45148401e+01
  2.45754929e+02  2.45754929e+02  2.45754929e+02  3.56944418e+02
  1.35036085e+03  5.83677147e+03  3.50992704e+04]
E1 = -182.09017256205496  E_coul = 53.55598015593376
cycle= 1 E= -128.534192406121  delta_E= -0.0289  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.501189
diis-c [-0.25119054  1.        ]
  HOMO = -0.883380803937134  LUMO = 0.796790685729888
  mo_energy =
[-3.28768876e+01 -1.96472337e+00 -8.83380804e-01 -8.83380804e-01
 -8.83380804e-01  7.96790686e-01  7.96790686e-01  7.96790686e-01
  1.98918532e+00  3.86724849e+00  3.86724849e+00  3.86724849e+00
  1.42407818e+01  1.42407818e+01  1.42407818e+01  1.94475091e+01
  5.33076806e+01  5.33076806e+01  5.33076806e+01  9.42107131e+01
  2.45408524e+02  2.45408524e+02  2.45408524e+02  3.56593055e+02
  1.34997132e+03  5.83635008e+03  3.50988274e+04]
E1 = -182.8490294706748  E_coul = 54.31224655109419
cycle= 2 E= -128.536782919581  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0736
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.25314
diis-c [-6.07380686e-04  3.34791671e-01  6.65208329e-01]
  HOMO = -0.84782350215986  LUMO = 0.805485767246077
  mo_energy =
[-3.27689613e+01 -1.92718829e+00 -8.47823502e-01 -8.47823502e-01
 -8.47823502e-01  8.05485767e-01  8.05485767e-01  8.05485767e-01
  2.01453797e+00  3.89894364e+00  3.89894364e+00  3.89894364e+00
  1.43040907e+01  1.43040907e+01  1.43040907e+01  1.95220704e+01
  5.34018450e+01  5.34018450e+01  5.34018450e+01  9.43126746e+01
  2.45522178e+02  2.45522178e+02  2.45522178e+02  3.56707789e+02
  1.35009231e+03  5.83647402e+03  3.50989525e+04]
E1 = -182.59236893993534  E_coul = 54.05467597511017
cycle= 3 E= -128.537692964825  delta_E= -0.00091  |g|= 0.000469  |ddm|= 0.0255
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118573
diis-c [-1.03540759e-07 -2.16583115e-03  2.31271423e-04  1.00193456e+00]
  HOMO = -0.848049371952062  LUMO = 0.805458596677251
  mo_energy =
[-3.27694242e+01 -1.92736514e+00 -8.48049372e-01 -8.48049372e-01
 -8.48049372e-01  8.05458597e-01  8.05458597e-01  8.05458597e-01
  2.01444308e+00  3.89879187e+00  3.89879187e+00  3.89879187e+00
  1.43038070e+01  1.43038070e+01  1.43038070e+01  1.95217723e+01
  5.34014458e+01  5.34014458e+01  5.34014458e+01  9.43122420e+01
  2.45521637e+02  2.45521637e+02  2.45521637e+02  3.56707225e+02
  1.35009160e+03  5.83647319e+03  3.50989516e+04]
E1 = -182.5929672253963  E_coul = 54.05527424335992
cycle= 4 E= -128.537692982036  delta_E= -1.72e-08  |g|= 7.13e-05  |ddm|= 0.000118
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182982
diis-c [-4.29429880e-10  1.24647671e-04  4.84176401e-04 -1.23188978e-01
  1.12258015e+00]
  HOMO = -0.848084100821619  LUMO = 0.805448286416207
  mo_energy =
[-3.27694941e+01 -1.92739516e+00 -8.48084101e-01 -8.48084101e-01
 -8.48084101e-01  8.05448286e-01  8.05448286e-01  8.05448286e-01
  2.01441958e+00  3.89875886e+00  3.89875886e+00  3.89875886e+00
  1.43037548e+01  1.43037548e+01  1.43037548e+01  1.95217181e+01
  5.34013814e+01  5.34013814e+01  5.34013814e+01  9.43121745e+01
  2.45521563e+02  2.45521563e+02  2.45521563e+02  3.56707148e+02
  1.35009152e+03  5.83647310e+03  3.50989515e+04]
E1 = -182.59311666005246  E_coul = 54.05542367757021
cycle= 5 E= -128.537692982482  delta_E= -4.46e-10  |g|= 2.51e-06  |ddm|= 1.66e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59311666005246  E_coul = 54.05542367757021
  HOMO = -0.848083076702455  LUMO = 0.805448578100066
  mo_energy =
[-3.27694918e+01 -1.92739367e+00 -8.48083077e-01 -8.48083077e-01
 -8.48083077e-01  8.05448578e-01  8.05448578e-01  8.05448578e-01
  2.01442069e+00  3.89875984e+00  3.89875984e+00  3.89875984e+00
  1.43037566e+01  1.43037566e+01  1.43037566e+01  1.95217202e+01
  5.34013837e+01  5.34013837e+01  5.34013837e+01  9.43121768e+01
  2.45521565e+02  2.45521565e+02  2.45521565e+02  3.56707150e+02
  1.35009152e+03  5.83647310e+03  3.50989515e+04]
E1 = -182.5931106904838  E_coul = 54.05541770800073
Extra cycle  E= -128.537692982483  delta_E= -8.24e-13  |g|= 8.49e-07  |ddm|= 1.35e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209763e+03 6.17484735e+02 1.75006276e+02
 2.06118703e+01 5.68539932e+01 4.88249964e-01 7.94722719e+00
 1.65475733e+00 7.15993557e+00 2.34955440e+01 1.01996966e+02
 2.65597338e-01 2.45309312e+00 8.34881191e-01]
E = -128.53769298248307
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787134        1
[INPUT] 0    0    [1    /1   ]  2712.09762561        1
[INPUT] 0    0    [1    /1   ]  617.484735247        1
[INPUT] 0    0    [1    /1   ]  175.006276253        1
[INPUT] 0    0    [1    /1   ]  20.6118702714        1
[INPUT] 0    0    [1    /1   ]  56.8539931609        1
[INPUT] 0    0    [1    /1   ]  0.488249964211       1
[INPUT] 0    0    [1    /1   ]  7.94722719142        1
[INPUT] 0    0    [1    /1   ]  1.65475733169        1
[INPUT] 1    0    [1    /1   ]  7.15993556877        1
[INPUT] 1    0    [1    /1   ]  23.4955439948        1
[INPUT] 1    0    [1    /1   ]  101.996965629        1
[INPUT] 1    0    [1    /1   ]  0.265597337893       1
[INPUT] 1    0    [1    /1   ]  2.453093116          1
[INPUT] 1    0    [1    /1   ]  0.834881190569       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478713357348, 1.0]], [0, [2712.097625609477, 1.0]], [0, [617.4847352467715, 1.0]], [0, [175.00627625332777, 1.0]], [0, [20.611870271358157, 1.0]], [0, [56.853993160898845, 1.0]], [0, [0.4882499642110335, 1.0]], [0, [7.9472271914231225, 1.0]], [0, [1.65475733168706, 1.0]], [1, [7.159935568774462, 1.0]], [1, [23.495543994807015, 1.0]], [1, [101.99696562907418, 1.0]], [1, [0.26559733789347095, 1.0]], [1, [2.4530931159966776, 1.0]], [1, [0.8348811905686355, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871336]
bas 1, expnt(s) = [2712.09762561]
bas 2, expnt(s) = [617.48473525]
bas 3, expnt(s) = [175.00627625]
bas 4, expnt(s) = [20.61187027]
bas 5, expnt(s) = [56.85399316]
bas 6, expnt(s) = [0.48824996]
bas 7, expnt(s) = [7.94722719]
bas 8, expnt(s) = [1.65475733]
bas 9, expnt(s) = [7.15993557]
bas 10, expnt(s) = [23.49554399]
bas 11, expnt(s) = [101.99696563]
bas 12, expnt(s) = [0.26559734]
bas 13, expnt(s) = [2.45309312]
bas 14, expnt(s) = [0.83488119]
CPU time:       220.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209763e+03 9.49497910e+02
 6.17484735e+02 3.12957017e+02 1.75006276e+02 1.21564073e+02
 2.06118703e+01 2.44401054e+01 5.68539932e+01 5.23101245e+01
 4.88249964e-01 1.47569528e+00 7.94722719e+00 1.19585010e+01
 1.65475733e+00 3.68608851e+00 7.15993557e+00 3.41680965e+01
 2.34955440e+01 1.50909393e+02 1.01996966e+02 9.45623937e+02
 2.65597338e-01 5.56242335e-01 2.45309312e+00 8.95626499e+00
 8.34881191e-01 2.32817295e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999171514248548
cond(S) = 244.6836923306813
E1 = -183.58672907580677  E_coul = 55.08144830359368
init E= -128.505280772213
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775329455289988  LUMO = 0.823082564675535
  mo_energy =
[-3.25542348e+01 -1.85120975e+00 -7.75329455e-01 -7.75329455e-01
 -7.75329455e-01  8.23082565e-01  8.23082565e-01  8.23082565e-01
  2.06657055e+00  3.96432186e+00  3.96432186e+00  3.96432186e+00
  1.44313762e+01  1.44313762e+01  1.44313762e+01  1.96702034e+01
  5.35888601e+01  5.35888601e+01  5.35888601e+01  9.45148401e+01
  2.45754929e+02  2.45754929e+02  2.45754929e+02  3.56944418e+02
  1.35036085e+03  5.83677147e+03  3.50992704e+04]
E1 = -182.09017256205496  E_coul = 53.55598015593376
cycle= 1 E= -128.534192406121  delta_E= -0.0289  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.501189
diis-c [-0.25119054  1.        ]
  HOMO = -0.883380803937134  LUMO = 0.796790685729888
  mo_energy =
[-3.28768876e+01 -1.96472337e+00 -8.83380804e-01 -8.83380804e-01
 -8.83380804e-01  7.96790686e-01  7.96790686e-01  7.96790686e-01
  1.98918532e+00  3.86724849e+00  3.86724849e+00  3.86724849e+00
  1.42407818e+01  1.42407818e+01  1.42407818e+01  1.94475091e+01
  5.33076806e+01  5.33076806e+01  5.33076806e+01  9.42107131e+01
  2.45408524e+02  2.45408524e+02  2.45408524e+02  3.56593055e+02
  1.34997132e+03  5.83635008e+03  3.50988274e+04]
E1 = -182.8490294706748  E_coul = 54.31224655109419
cycle= 2 E= -128.536782919581  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0736
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.25314
diis-c [-6.07380686e-04  3.34791671e-01  6.65208329e-01]
  HOMO = -0.84782350215986  LUMO = 0.805485767246077
  mo_energy =
[-3.27689613e+01 -1.92718829e+00 -8.47823502e-01 -8.47823502e-01
 -8.47823502e-01  8.05485767e-01  8.05485767e-01  8.05485767e-01
  2.01453797e+00  3.89894364e+00  3.89894364e+00  3.89894364e+00
  1.43040907e+01  1.43040907e+01  1.43040907e+01  1.95220704e+01
  5.34018450e+01  5.34018450e+01  5.34018450e+01  9.43126746e+01
  2.45522178e+02  2.45522178e+02  2.45522178e+02  3.56707789e+02
  1.35009231e+03  5.83647402e+03  3.50989525e+04]
E1 = -182.59236893993534  E_coul = 54.05467597511017
cycle= 3 E= -128.537692964825  delta_E= -0.00091  |g|= 0.000469  |ddm|= 0.0255
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00118573
diis-c [-1.03540759e-07 -2.16583115e-03  2.31271423e-04  1.00193456e+00]
  HOMO = -0.848049371952062  LUMO = 0.805458596677251
  mo_energy =
[-3.27694242e+01 -1.92736514e+00 -8.48049372e-01 -8.48049372e-01
 -8.48049372e-01  8.05458597e-01  8.05458597e-01  8.05458597e-01
  2.01444308e+00  3.89879187e+00  3.89879187e+00  3.89879187e+00
  1.43038070e+01  1.43038070e+01  1.43038070e+01  1.95217723e+01
  5.34014458e+01  5.34014458e+01  5.34014458e+01  9.43122420e+01
  2.45521637e+02  2.45521637e+02  2.45521637e+02  3.56707225e+02
  1.35009160e+03  5.83647319e+03  3.50989516e+04]
E1 = -182.5929672253963  E_coul = 54.05527424335992
cycle= 4 E= -128.537692982036  delta_E= -1.72e-08  |g|= 7.13e-05  |ddm|= 0.000118
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000182982
diis-c [-4.29429880e-10  1.24647671e-04  4.84176401e-04 -1.23188978e-01
  1.12258015e+00]
  HOMO = -0.848084100821619  LUMO = 0.805448286416207
  mo_energy =
[-3.27694941e+01 -1.92739516e+00 -8.48084101e-01 -8.48084101e-01
 -8.48084101e-01  8.05448286e-01  8.05448286e-01  8.05448286e-01
  2.01441958e+00  3.89875886e+00  3.89875886e+00  3.89875886e+00
  1.43037548e+01  1.43037548e+01  1.43037548e+01  1.95217181e+01
  5.34013814e+01  5.34013814e+01  5.34013814e+01  9.43121745e+01
  2.45521563e+02  2.45521563e+02  2.45521563e+02  3.56707148e+02
  1.35009152e+03  5.83647310e+03  3.50989515e+04]
E1 = -182.59311666005246  E_coul = 54.05542367757021
cycle= 5 E= -128.537692982482  delta_E= -4.46e-10  |g|= 2.51e-06  |ddm|= 1.66e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59311666005246  E_coul = 54.05542367757021
  HOMO = -0.848083076702455  LUMO = 0.805448578100066
  mo_energy =
[-3.27694918e+01 -1.92739367e+00 -8.48083077e-01 -8.48083077e-01
 -8.48083077e-01  8.05448578e-01  8.05448578e-01  8.05448578e-01
  2.01442069e+00  3.89875984e+00  3.89875984e+00  3.89875984e+00
  1.43037566e+01  1.43037566e+01  1.43037566e+01  1.95217202e+01
  5.34013837e+01  5.34013837e+01  5.34013837e+01  9.43121768e+01
  2.45521565e+02  2.45521565e+02  2.45521565e+02  3.56707150e+02
  1.35009152e+03  5.83647310e+03  3.50989515e+04]
E1 = -182.5931106904838  E_coul = 54.05541770800073
Extra cycle  E= -128.537692982483  delta_E= -8.24e-13  |g|= 8.49e-07  |ddm|= 1.35e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 244.6836923306813
E1 = -182.5931106904838  E_coul = 54.05541770800073
init E= -128.537692982483
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.848083509718014  LUMO = 0.805448477440169
  mo_energy =
[-3.27694931e+01 -1.92739405e+00 -8.48083510e-01 -8.48083510e-01
 -8.48083510e-01  8.05448477e-01  8.05448477e-01  8.05448477e-01
  2.01442044e+00  3.89875946e+00  3.89875946e+00  3.89875946e+00
  1.43037559e+01  1.43037559e+01  1.43037559e+01  1.95217194e+01
  5.34013825e+01  5.34013825e+01  5.34013825e+01  9.43121756e+01
  2.45521563e+02  2.45521563e+02  2.45521563e+02  3.56707149e+02
  1.35009152e+03  5.83647310e+03  3.50989515e+04]
E1 = -182.59311394118905  E_coul = 54.05542095870595
cycle= 1 E= -128.537692982483  delta_E= -2.84e-14  |g|= 4.49e-07  |ddm|= 2.95e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59311394118905  E_coul = 54.05542095870595
  HOMO = -0.848083282447743  LUMO = 0.805448534329283
  mo_energy =
[-3.27694924e+01 -1.92739379e+00 -8.48083282e-01 -8.48083282e-01
 -8.48083282e-01  8.05448534e-01  8.05448534e-01  8.05448534e-01
  2.01442062e+00  3.89875967e+00  3.89875967e+00  3.89875967e+00
  1.43037563e+01  1.43037563e+01  1.43037563e+01  1.95217198e+01
  5.34013831e+01  5.34013831e+01  5.34013831e+01  9.43121762e+01
  2.45521564e+02  2.45521564e+02  2.45521564e+02  3.56707150e+02
  1.35009152e+03  5.83647310e+03  3.50989515e+04]
E1 = -182.59311232118282  E_coul = 54.05541933869947
Extra cycle  E= -128.537692982483  delta_E= -2.56e-13  |g|= 2.19e-07  |ddm|= 1.82e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [1.80764787e+04 2.71209763e+03 6.17484735e+02 1.75006276e+02
 2.06118703e+01 5.68539932e+01 4.88249964e-01 7.94722719e+00
 1.65475733e+00 7.15993557e+00 2.34955440e+01 1.01996966e+02
 2.65597338e-01 2.45309312e+00 8.34881191e-01]
grad_E = [-2.06700579e-09  1.06494747e-07 -1.92633646e-06  1.69792086e-05
  3.03631621e-06 -6.25208666e-05  3.60273013e-04  2.76991851e-04
 -1.00812097e-04 -2.86883395e-04  4.35622614e-05  8.34226734e-07
 -2.79345725e-03  6.41364930e-04  2.36090116e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787137        1
[INPUT] 0    0    [1    /1   ]  2712.09761007        1
[INPUT] 0    0    [1    /1   ]  617.484998947        1
[INPUT] 0    0    [1    /1   ]  175.00446187         1
[INPUT] 0    0    [1    /1   ]  20.6168344917        1
[INPUT] 0    0    [1    /1   ]  56.8543636904        1
[INPUT] 0    0    [1    /1   ]  0.487955575437       1
[INPUT] 0    0    [1    /1   ]  7.93209256623        1
[INPUT] 0    0    [1    /1   ]  1.6549739405         1
[INPUT] 1    0    [1    /1   ]  7.14039859794        1
[INPUT] 1    0    [1    /1   ]  23.3311041591        1
[INPUT] 1    0    [1    /1   ]  101.018142583        1
[INPUT] 1    0    [1    /1   ]  0.266918258182       1
[INPUT] 1    0    [1    /1   ]  2.4476374185         1
[INPUT] 1    0    [1    /1   ]  0.83510500236        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478713680597, 1.0]], [0, [2712.0976100728003, 1.0]], [0, [617.4849989473347, 1.0]], [0, [175.00446186988466, 1.0]], [0, [20.61683449174219, 1.0]], [0, [56.85436369042225, 1.0]], [0, [0.48795557543724327, 1.0]], [0, [7.932092566226102, 1.0]], [0, [1.6549739405005537, 1.0]], [1, [7.140398597936775, 1.0]], [1, [23.331104159118883, 1.0]], [1, [101.01814258289929, 1.0]], [1, [0.26691825818190723, 1.0]], [1, [2.4476374184966754, 1.0]], [1, [0.8351050023604828, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871368]
bas 1, expnt(s) = [2712.09761007]
bas 2, expnt(s) = [617.48499895]
bas 3, expnt(s) = [175.00446187]
bas 4, expnt(s) = [20.61683449]
bas 5, expnt(s) = [56.85436369]
bas 6, expnt(s) = [0.48795558]
bas 7, expnt(s) = [7.93209257]
bas 8, expnt(s) = [1.65497394]
bas 9, expnt(s) = [7.1403986]
bas 10, expnt(s) = [23.33110416]
bas 11, expnt(s) = [101.01814258]
bas 12, expnt(s) = [0.26691826]
bas 13, expnt(s) = [2.44763742]
bas 14, expnt(s) = [0.835105]
CPU time:       223.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209761e+03 9.49497906e+02
 6.17484999e+02 3.12957117e+02 1.75004462e+02 1.21563128e+02
 2.06168345e+01 2.44445199e+01 5.68543637e+01 5.23103802e+01
 4.87955575e-01 1.47502791e+00 7.93209257e+00 1.19414167e+01
 1.65497394e+00 3.68645039e+00 7.14039860e+00 3.40515953e+01
 2.33311042e+01 1.49590326e+02 1.01018143e+02 9.34294121e+02
 2.66918258e-01 5.59702498e-01 2.44763742e+00 8.93137342e+00
 8.35105002e-01 2.32895313e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99916790043585
cond(S) = 244.16555471482295
E1 = -183.5868603106517  E_coul = 55.08147636045735
init E= -128.505383950194
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775328542167251  LUMO = 0.826717325045085
  mo_energy =
[-3.25542365e+01 -1.85120019e+00 -7.75328542e-01 -7.75328542e-01
 -7.75328542e-01  8.26717325e-01  8.26717325e-01  8.26717325e-01
  2.06545301e+00  3.96639922e+00  3.96639922e+00  3.96639922e+00
  1.44049267e+01  1.44049267e+01  1.44049267e+01  1.96480437e+01
  5.33119155e+01  5.33119155e+01  5.33119155e+01  9.44724408e+01
  2.43514841e+02  2.43514841e+02  2.43514841e+02  3.56903111e+02
  1.35032138e+03  5.83673559e+03  3.50992406e+04]
E1 = -182.0916763689705  E_coul = 53.55747078740477
cycle= 1 E= -128.534205581566  delta_E= -0.0288  |g|= 0.203  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.501794
diis-c [-0.25179682  1.        ]
  HOMO = -0.883261021314323  LUMO = 0.800379985858079
  mo_energy =
[-3.28766684e+01 -1.96455949e+00 -8.83261021e-01 -8.83261021e-01
 -8.83261021e-01  8.00379986e-01  8.00379986e-01  8.00379986e-01
  1.98823169e+00  3.86960133e+00  3.86960133e+00  3.86960133e+00
  1.42148169e+01  1.42148169e+01  1.42148169e+01  1.94256174e+01
  5.30313752e+01  5.30313752e+01  5.30313752e+01  9.41685238e+01
  2.43168979e+02  2.43168979e+02  2.43168979e+02  3.56551957e+02
  1.34993205e+03  5.83631440e+03  3.50987978e+04]
E1 = -182.84983157726174  E_coul = 54.31303777288787
cycle= 2 E= -128.536793804374  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0735
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253305
diis-c [-6.06637697e-04  3.34669960e-01  6.65330040e-01]
  HOMO = -0.847731590063621  LUMO = 0.809097210930408
  mo_energy =
[-3.27688161e+01 -1.92705437e+00 -8.47731590e-01 -8.47731590e-01
 -8.47731590e-01  8.09097211e-01  8.09097211e-01  8.09097211e-01
  2.01355361e+00  3.90122162e+00  3.90122162e+00  3.90122162e+00
  1.42779710e+01  1.42779710e+01  1.42779710e+01  1.95000934e+01
  5.31253313e+01  5.31253313e+01  5.31253313e+01  9.42704131e+01
  2.43282476e+02  2.43282476e+02  2.43282476e+02  3.56666614e+02
  1.35005296e+03  5.83643826e+03  3.50989228e+04]
E1 = -182.59353065006053  E_coul = 54.05582881703481
cycle= 3 E= -128.537701833026  delta_E= -0.000908  |g|= 0.000467  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011933
diis-c [-1.05864406e-07 -2.15909325e-03  2.66577642e-04  1.00189252e+00]
  HOMO = -0.84795407919033  LUMO = 0.80907145548855
  mo_energy =
[-3.27692756e+01 -1.92722515e+00 -8.47954079e-01 -8.47954079e-01
 -8.47954079e-01  8.09071455e-01  8.09071455e-01  8.09071455e-01
  2.01346408e+00  3.90107386e+00  3.90107386e+00  3.90107386e+00
  1.42776921e+01  1.42776921e+01  1.42776921e+01  1.94998002e+01
  5.31249368e+01  5.31249368e+01  5.31249368e+01  9.42699840e+01
  2.43281938e+02  2.43281938e+02  2.43281938e+02  3.56666052e+02
  1.35005225e+03  5.83643743e+03  3.50989219e+04]
E1 = -182.59413459179692  E_coul = 54.05643274165482
cycle= 4 E= -128.537701850142  delta_E= -1.71e-08  |g|= 7.17e-05  |ddm|= 0.000115
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186162
diis-c [-4.59555701e-10  1.32153398e-04  4.93566985e-04 -1.27104756e-01
  1.12647904e+00]
  HOMO = -0.847988610966725  LUMO = 0.809061282116392
  mo_energy =
[-3.27693458e+01 -1.92725431e+00 -8.47988611e-01 -8.47988611e-01
 -8.47988611e-01  8.09061282e-01  8.09061282e-01  8.09061282e-01
  2.01344139e+00  3.90104123e+00  3.90104123e+00  3.90104123e+00
  1.42776402e+01  1.42776402e+01  1.42776402e+01  1.94997463e+01
  5.31248723e+01  5.31248723e+01  5.31248723e+01  9.42699163e+01
  2.43281863e+02  2.43281863e+02  2.43281863e+02  3.56665975e+02
  1.35005216e+03  5.83643734e+03  3.50989218e+04]
E1 = -182.5942867552621  E_coul = 54.05658490466017
cycle= 5 E= -128.537701850602  delta_E= -4.6e-10  |g|= 2.72e-06  |ddm|= 1.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5942867552621  E_coul = 54.05658490466017
  HOMO = -0.847987494507373  LUMO = 0.809061608998686
  mo_energy =
[-3.27693433e+01 -1.92725267e+00 -8.47987495e-01 -8.47987495e-01
 -8.47987495e-01  8.09061609e-01  8.09061609e-01  8.09061609e-01
  2.01344261e+00  3.90104230e+00  3.90104230e+00  3.90104230e+00
  1.42776421e+01  1.42776421e+01  1.42776421e+01  1.94997486e+01
  5.31248748e+01  5.31248748e+01  5.31248748e+01  9.42699187e+01
  2.43281865e+02  2.43281865e+02  2.43281865e+02  3.56665977e+02
  1.35005216e+03  5.83643734e+03  3.50989218e+04]
E1 = -182.5942805892709  E_coul = 54.05657873866815
Extra cycle  E= -128.537701850603  delta_E= -8.24e-13  |g|= 8.9e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209761e+03 6.17484999e+02 1.75004462e+02
 2.06168345e+01 5.68543637e+01 4.87955575e-01 7.93209257e+00
 1.65497394e+00 7.14039860e+00 2.33311042e+01 1.01018143e+02
 2.66918258e-01 2.44763742e+00 8.35105002e-01]
E = -128.53770185060276
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787137        1
[INPUT] 0    0    [1    /1   ]  2712.09761007        1
[INPUT] 0    0    [1    /1   ]  617.484998947        1
[INPUT] 0    0    [1    /1   ]  175.00446187         1
[INPUT] 0    0    [1    /1   ]  20.6168344917        1
[INPUT] 0    0    [1    /1   ]  56.8543636904        1
[INPUT] 0    0    [1    /1   ]  0.487955575437       1
[INPUT] 0    0    [1    /1   ]  7.93209256623        1
[INPUT] 0    0    [1    /1   ]  1.6549739405         1
[INPUT] 1    0    [1    /1   ]  7.14039859794        1
[INPUT] 1    0    [1    /1   ]  23.3311041591        1
[INPUT] 1    0    [1    /1   ]  101.018142583        1
[INPUT] 1    0    [1    /1   ]  0.266918258182       1
[INPUT] 1    0    [1    /1   ]  2.4476374185         1
[INPUT] 1    0    [1    /1   ]  0.83510500236        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478713680597, 1.0]], [0, [2712.0976100728003, 1.0]], [0, [617.4849989473347, 1.0]], [0, [175.00446186988466, 1.0]], [0, [20.61683449174219, 1.0]], [0, [56.85436369042225, 1.0]], [0, [0.48795557543724327, 1.0]], [0, [7.932092566226102, 1.0]], [0, [1.6549739405005537, 1.0]], [1, [7.140398597936775, 1.0]], [1, [23.331104159118883, 1.0]], [1, [101.01814258289929, 1.0]], [1, [0.26691825818190723, 1.0]], [1, [2.4476374184966754, 1.0]], [1, [0.8351050023604828, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871368]
bas 1, expnt(s) = [2712.09761007]
bas 2, expnt(s) = [617.48499895]
bas 3, expnt(s) = [175.00446187]
bas 4, expnt(s) = [20.61683449]
bas 5, expnt(s) = [56.85436369]
bas 6, expnt(s) = [0.48795558]
bas 7, expnt(s) = [7.93209257]
bas 8, expnt(s) = [1.65497394]
bas 9, expnt(s) = [7.1403986]
bas 10, expnt(s) = [23.33110416]
bas 11, expnt(s) = [101.01814258]
bas 12, expnt(s) = [0.26691826]
bas 13, expnt(s) = [2.44763742]
bas 14, expnt(s) = [0.835105]
CPU time:       224.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209761e+03 9.49497906e+02
 6.17484999e+02 3.12957117e+02 1.75004462e+02 1.21563128e+02
 2.06168345e+01 2.44445199e+01 5.68543637e+01 5.23103802e+01
 4.87955575e-01 1.47502791e+00 7.93209257e+00 1.19414167e+01
 1.65497394e+00 3.68645039e+00 7.14039860e+00 3.40515953e+01
 2.33311042e+01 1.49590326e+02 1.01018143e+02 9.34294121e+02
 2.66918258e-01 5.59702498e-01 2.44763742e+00 8.93137342e+00
 8.35105002e-01 2.32895313e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99916790043585
cond(S) = 244.16555471482295
E1 = -183.5868603106517  E_coul = 55.08147636045735
init E= -128.505383950194
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775328542167251  LUMO = 0.826717325045085
  mo_energy =
[-3.25542365e+01 -1.85120019e+00 -7.75328542e-01 -7.75328542e-01
 -7.75328542e-01  8.26717325e-01  8.26717325e-01  8.26717325e-01
  2.06545301e+00  3.96639922e+00  3.96639922e+00  3.96639922e+00
  1.44049267e+01  1.44049267e+01  1.44049267e+01  1.96480437e+01
  5.33119155e+01  5.33119155e+01  5.33119155e+01  9.44724408e+01
  2.43514841e+02  2.43514841e+02  2.43514841e+02  3.56903111e+02
  1.35032138e+03  5.83673559e+03  3.50992406e+04]
E1 = -182.0916763689705  E_coul = 53.55747078740477
cycle= 1 E= -128.534205581566  delta_E= -0.0288  |g|= 0.203  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.501794
diis-c [-0.25179682  1.        ]
  HOMO = -0.883261021314323  LUMO = 0.800379985858079
  mo_energy =
[-3.28766684e+01 -1.96455949e+00 -8.83261021e-01 -8.83261021e-01
 -8.83261021e-01  8.00379986e-01  8.00379986e-01  8.00379986e-01
  1.98823169e+00  3.86960133e+00  3.86960133e+00  3.86960133e+00
  1.42148169e+01  1.42148169e+01  1.42148169e+01  1.94256174e+01
  5.30313752e+01  5.30313752e+01  5.30313752e+01  9.41685238e+01
  2.43168979e+02  2.43168979e+02  2.43168979e+02  3.56551957e+02
  1.34993205e+03  5.83631440e+03  3.50987978e+04]
E1 = -182.84983157726174  E_coul = 54.31303777288787
cycle= 2 E= -128.536793804374  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0735
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253305
diis-c [-6.06637697e-04  3.34669960e-01  6.65330040e-01]
  HOMO = -0.847731590063621  LUMO = 0.809097210930408
  mo_energy =
[-3.27688161e+01 -1.92705437e+00 -8.47731590e-01 -8.47731590e-01
 -8.47731590e-01  8.09097211e-01  8.09097211e-01  8.09097211e-01
  2.01355361e+00  3.90122162e+00  3.90122162e+00  3.90122162e+00
  1.42779710e+01  1.42779710e+01  1.42779710e+01  1.95000934e+01
  5.31253313e+01  5.31253313e+01  5.31253313e+01  9.42704131e+01
  2.43282476e+02  2.43282476e+02  2.43282476e+02  3.56666614e+02
  1.35005296e+03  5.83643826e+03  3.50989228e+04]
E1 = -182.59353065006053  E_coul = 54.05582881703481
cycle= 3 E= -128.537701833026  delta_E= -0.000908  |g|= 0.000467  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011933
diis-c [-1.05864406e-07 -2.15909325e-03  2.66577642e-04  1.00189252e+00]
  HOMO = -0.84795407919033  LUMO = 0.80907145548855
  mo_energy =
[-3.27692756e+01 -1.92722515e+00 -8.47954079e-01 -8.47954079e-01
 -8.47954079e-01  8.09071455e-01  8.09071455e-01  8.09071455e-01
  2.01346408e+00  3.90107386e+00  3.90107386e+00  3.90107386e+00
  1.42776921e+01  1.42776921e+01  1.42776921e+01  1.94998002e+01
  5.31249368e+01  5.31249368e+01  5.31249368e+01  9.42699840e+01
  2.43281938e+02  2.43281938e+02  2.43281938e+02  3.56666052e+02
  1.35005225e+03  5.83643743e+03  3.50989219e+04]
E1 = -182.59413459179692  E_coul = 54.05643274165482
cycle= 4 E= -128.537701850142  delta_E= -1.71e-08  |g|= 7.17e-05  |ddm|= 0.000115
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186162
diis-c [-4.59555701e-10  1.32153398e-04  4.93566985e-04 -1.27104756e-01
  1.12647904e+00]
  HOMO = -0.847988610966725  LUMO = 0.809061282116392
  mo_energy =
[-3.27693458e+01 -1.92725431e+00 -8.47988611e-01 -8.47988611e-01
 -8.47988611e-01  8.09061282e-01  8.09061282e-01  8.09061282e-01
  2.01344139e+00  3.90104123e+00  3.90104123e+00  3.90104123e+00
  1.42776402e+01  1.42776402e+01  1.42776402e+01  1.94997463e+01
  5.31248723e+01  5.31248723e+01  5.31248723e+01  9.42699163e+01
  2.43281863e+02  2.43281863e+02  2.43281863e+02  3.56665975e+02
  1.35005216e+03  5.83643734e+03  3.50989218e+04]
E1 = -182.5942867552621  E_coul = 54.05658490466017
cycle= 5 E= -128.537701850602  delta_E= -4.6e-10  |g|= 2.72e-06  |ddm|= 1.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5942867552621  E_coul = 54.05658490466017
  HOMO = -0.847987494507373  LUMO = 0.809061608998686
  mo_energy =
[-3.27693433e+01 -1.92725267e+00 -8.47987495e-01 -8.47987495e-01
 -8.47987495e-01  8.09061609e-01  8.09061609e-01  8.09061609e-01
  2.01344261e+00  3.90104230e+00  3.90104230e+00  3.90104230e+00
  1.42776421e+01  1.42776421e+01  1.42776421e+01  1.94997486e+01
  5.31248748e+01  5.31248748e+01  5.31248748e+01  9.42699187e+01
  2.43281865e+02  2.43281865e+02  2.43281865e+02  3.56665977e+02
  1.35005216e+03  5.83643734e+03  3.50989218e+04]
E1 = -182.5942805892709  E_coul = 54.05657873866815
Extra cycle  E= -128.537701850603  delta_E= -8.24e-13  |g|= 8.9e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 244.16555471482295
E1 = -182.5942805892709  E_coul = 54.05657873866815
init E= -128.537701850603
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.847987941051606  LUMO = 0.809061506375549
  mo_energy =
[-3.27693447e+01 -1.92725305e+00 -8.47987941e-01 -8.47987941e-01
 -8.47987941e-01  8.09061506e-01  8.09061506e-01  8.09061506e-01
  2.01344237e+00  3.90104192e+00  3.90104192e+00  3.90104192e+00
  1.42776414e+01  1.42776414e+01  1.42776414e+01  1.94997477e+01
  5.31248736e+01  5.31248736e+01  5.31248736e+01  9.42699174e+01
  2.43281864e+02  2.43281864e+02  2.43281864e+02  3.56665976e+02
  1.35005216e+03  5.83643734e+03  3.50989218e+04]
E1 = -182.59428399670773  E_coul = 54.05658214610501
cycle= 1 E= -128.537701850603  delta_E= 2.84e-14  |g|= 4.72e-07  |ddm|= 3.16e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59428399670773  E_coul = 54.05658214610501
  HOMO = -0.8479877028209  LUMO = 0.809061566415431
  mo_energy =
[-3.27693440e+01 -1.92725278e+00 -8.47987703e-01 -8.47987703e-01
 -8.47987703e-01  8.09061566e-01  8.09061566e-01  8.09061566e-01
  2.01344256e+00  3.90104213e+00  3.90104213e+00  3.90104213e+00
  1.42776418e+01  1.42776418e+01  1.42776418e+01  1.94997482e+01
  5.31248742e+01  5.31248742e+01  5.31248742e+01  9.42699181e+01
  2.43281865e+02  2.43281865e+02  2.43281865e+02  3.56665976e+02
  1.35005216e+03  5.83643734e+03  3.50989218e+04]
E1 = -182.59428230704415  E_coul = 54.056580456441495
Extra cycle  E= -128.537701850603  delta_E= 5.68e-14  |g|= 2.29e-07  |ddm|= 1.92e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209761e+03 6.17484999e+02 1.75004462e+02
 2.06168345e+01 5.68543637e+01 4.87955575e-01 7.93209257e+00
 1.65497394e+00 7.14039860e+00 2.33311042e+01 1.01018143e+02
 2.66918258e-01 2.44763742e+00 8.35105002e-01]
grad_E = [-2.33463281e-09  1.20606745e-07 -2.20684523e-06  2.02647843e-05
  8.93804440e-05 -8.55087989e-05 -1.24408390e-04  1.34870310e-04
  1.97791657e-05 -9.11385101e-05  9.51005353e-06  1.43515595e-06
  2.48205284e-04  2.32089132e-04 -3.02824527e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787141        1
[INPUT] 0    0    [1    /1   ]  2712.09758802        1
[INPUT] 0    0    [1    /1   ]  617.485377559        1
[INPUT] 0    0    [1    /1   ]  175.001733948        1
[INPUT] 0    0    [1    /1   ]  20.6157895673        1
[INPUT] 0    0    [1    /1   ]  56.8570481981        1
[INPUT] 0    0    [1    /1   ]  0.487965589458       1
[INPUT] 0    0    [1    /1   ]  7.92376277536        1
[INPUT] 0    0    [1    /1   ]  1.65529996248        1
[INPUT] 1    0    [1    /1   ]  7.12094638736        1
[INPUT] 1    0    [1    /1   ]  23.1805130119        1
[INPUT] 1    0    [1    /1   ]  99.7045650373        1
[INPUT] 1    0    [1    /1   ]  0.266701779789       1
[INPUT] 1    0    [1    /1   ]  2.44173863789        1
[INPUT] 1    0    [1    /1   ]  0.833647476179       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47871413717, 1.0]], [0, [2712.0975880184187, 1.0]], [0, [617.4853775589817, 1.0]], [0, [175.00173394805188, 1.0]], [0, [20.61578956730736, 1.0]], [0, [56.85704819807453, 1.0]], [0, [0.48796558945768775, 1.0]], [0, [7.923762775356473, 1.0]], [0, [1.655299962484914, 1.0]], [1, [7.12094638735553, 1.0]], [1, [23.180513011853293, 1.0]], [1, [99.7045650372837, 1.0]], [1, [0.26670177978876203, 1.0]], [1, [2.4417386378873247, 1.0]], [1, [0.8336474761785844, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871414]
bas 1, expnt(s) = [2712.09758802]
bas 2, expnt(s) = [617.48537756]
bas 3, expnt(s) = [175.00173395]
bas 4, expnt(s) = [20.61578957]
bas 5, expnt(s) = [56.8570482]
bas 6, expnt(s) = [0.48796559]
bas 7, expnt(s) = [7.92376278]
bas 8, expnt(s) = [1.65529996]
bas 9, expnt(s) = [7.12094639]
bas 10, expnt(s) = [23.18051301]
bas 11, expnt(s) = [99.70456504]
bas 12, expnt(s) = [0.26670178]
bas 13, expnt(s) = [2.44173864]
bas 14, expnt(s) = [0.83364748]
CPU time:       228.12
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209759e+03 9.49497900e+02
 6.17485378e+02 3.12957261e+02 1.75001734e+02 1.21561706e+02
 2.06157896e+01 2.44435907e+01 5.68570482e+01 5.23122327e+01
 4.87965589e-01 1.47505061e+00 7.92376278e+00 1.19320104e+01
 1.65529996e+00 3.68699504e+00 7.12094639e+00 3.39356786e+01
 2.31805130e+01 1.48384383e+02 9.97045650e+01 9.19132656e+02
 2.66701780e-01 5.59135137e-01 2.44173864e+00 8.90447588e+00
 8.33647476e-01 2.32387328e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999170348087665
cond(S) = 243.87844054127126
E1 = -183.58689369018865  E_coul = 55.081479075268305
init E= -128.50541461492
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775329221787554  LUMO = 0.825629905850344
  mo_energy =
[-3.25542382e+01 -1.85119702e+00 -7.75329222e-01 -7.75329222e-01
 -7.75329222e-01  8.25629906e-01  8.25629906e-01  8.25629906e-01
  2.06561831e+00  3.95820550e+00  3.95820550e+00  3.95820550e+00
  1.43656708e+01  1.43656708e+01  1.43656708e+01  1.96362704e+01
  5.30406544e+01  5.30406544e+01  5.30406544e+01  9.44439622e+01
  2.40750368e+02  2.40750368e+02  2.40750368e+02  3.56873081e+02
  1.35029128e+03  5.83670755e+03  3.50992172e+04]
E1 = -182.09153936681366  E_coul = 53.55733234112956
cycle= 1 E= -128.534207025684  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502436
diis-c [-0.25244211  1.        ]
  HOMO = -0.883272639455887  LUMO = 0.799341780286395
  mo_energy =
[-3.28766976e+01 -1.96456606e+00 -8.83272639e-01 -8.83272639e-01
 -8.83272639e-01  7.99341780e-01  7.99341780e-01  7.99341780e-01
  1.98839041e+00  3.86159218e+00  3.86159218e+00  3.86159218e+00
  1.41758282e+01  1.41758282e+01  1.41758282e+01  1.94138754e+01
  5.27604909e+01  5.27604909e+01  5.27604909e+01  9.41400200e+01
  2.40404921e+02  2.40404921e+02  2.40404921e+02  3.56521896e+02
  1.34990192e+03  5.83628633e+03  3.50987744e+04]
E1 = -182.84981554644725  E_coul = 54.31301966649037
cycle= 2 E= -128.536795879957  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0735
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253627
diis-c [-6.06749625e-04  3.34670144e-01  6.65329856e-01]
  HOMO = -0.847737386541338  LUMO = 0.808042752081653
  mo_energy =
[-3.27688291e+01 -1.92705453e+00 -8.47737387e-01 -8.47737387e-01
 -8.47737387e-01  8.08042752e-01  8.08042752e-01  8.08042752e-01
  2.01371669e+00  3.89315307e+00  3.89315307e+00  3.89315307e+00
  1.42388932e+01  1.42388932e+01  1.42388932e+01  1.94883439e+01
  5.28543284e+01  5.28543284e+01  5.28543284e+01  9.42419226e+01
  2.40518326e+02  2.40518326e+02  2.40518326e+02  3.56636570e+02
  1.35002284e+03  5.83641020e+03  3.50988994e+04]
E1 = -182.59346547689645  E_coul = 54.05576128181805
cycle= 3 E= -128.537704195078  delta_E= -0.000908  |g|= 0.000468  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119815
diis-c [-1.06634545e-07 -2.16166711e-03  2.74274358e-04  1.00188739e+00]
  HOMO = -0.847960302218317  LUMO = 0.808016897638766
  mo_energy =
[-3.27692897e+01 -1.92722561e+00 -8.47960302e-01 -8.47960302e-01
 -8.47960302e-01  8.08016898e-01  8.08016898e-01  8.08016898e-01
  2.01362692e+00  3.89300520e+00  3.89300520e+00  3.89300520e+00
  1.42386140e+01  1.42386140e+01  1.42386140e+01  1.94880500e+01
  5.28539335e+01  5.28539335e+01  5.28539335e+01  9.42414923e+01
  2.40517789e+02  2.40517789e+02  2.40517789e+02  3.56636006e+02
  1.35002213e+03  5.83640936e+03  3.50988985e+04]
E1 = -182.59407099109535  E_coul = 54.0563667787825
cycle= 4 E= -128.537704212313  delta_E= -1.72e-08  |g|= 7.2e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187002
diis-c [-4.61639625e-10  1.32227071e-04  4.94319799e-04 -1.27209679e-01
  1.12658313e+00]
  HOMO = -0.847994953444328  LUMO = 0.808006702876925
  mo_energy =
[-3.27693602e+01 -1.92725487e+00 -8.47994953e-01 -8.47994953e-01
 -8.47994953e-01  8.08006703e-01  8.08006703e-01  8.08006703e-01
  2.01360415e+00  3.89297250e+00  3.89297250e+00  3.89297250e+00
  1.42385620e+01  1.42385620e+01  1.42385620e+01  1.94879959e+01
  5.28538689e+01  5.28538689e+01  5.28538689e+01  9.42414244e+01
  2.40517714e+02  2.40517714e+02  2.40517714e+02  3.56635929e+02
  1.35002204e+03  5.83640927e+03  3.50988984e+04]
E1 = -182.59422361151132  E_coul = 54.05651939873525
cycle= 5 E= -128.537704212776  delta_E= -4.63e-10  |g|= 2.73e-06  |ddm|= 1.68e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59422361151132  E_coul = 54.05651939873525
  HOMO = -0.847993835534712  LUMO = 0.808007029419285
  mo_energy =
[-3.27693577e+01 -1.92725323e+00 -8.47993836e-01 -8.47993836e-01
 -8.47993836e-01  8.08007029e-01  8.08007029e-01  8.08007029e-01
  2.01360537e+00  3.89297357e+00  3.89297357e+00  3.89297357e+00
  1.42385639e+01  1.42385639e+01  1.42385639e+01  1.94879982e+01
  5.28538713e+01  5.28538713e+01  5.28538713e+01  9.42414268e+01
  2.40517716e+02  2.40517716e+02  2.40517716e+02  3.56635931e+02
  1.35002204e+03  5.83640927e+03  3.50988984e+04]
E1 = -182.59421742973782  E_coul = 54.05651321696121
Extra cycle  E= -128.537704212777  delta_E= -5.4e-13  |g|= 8.92e-07  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209759e+03 6.17485378e+02 1.75001734e+02
 2.06157896e+01 5.68570482e+01 4.87965589e-01 7.92376278e+00
 1.65529996e+00 7.12094639e+00 2.31805130e+01 9.97045650e+01
 2.66701780e-01 2.44173864e+00 8.33647476e-01]
E = -128.53770421277662
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787141        1
[INPUT] 0    0    [1    /1   ]  2712.09758802        1
[INPUT] 0    0    [1    /1   ]  617.485377559        1
[INPUT] 0    0    [1    /1   ]  175.001733948        1
[INPUT] 0    0    [1    /1   ]  20.6157895673        1
[INPUT] 0    0    [1    /1   ]  56.8570481981        1
[INPUT] 0    0    [1    /1   ]  0.487965589458       1
[INPUT] 0    0    [1    /1   ]  7.92376277536        1
[INPUT] 0    0    [1    /1   ]  1.65529996248        1
[INPUT] 1    0    [1    /1   ]  7.12094638736        1
[INPUT] 1    0    [1    /1   ]  23.1805130119        1
[INPUT] 1    0    [1    /1   ]  99.7045650373        1
[INPUT] 1    0    [1    /1   ]  0.266701779789       1
[INPUT] 1    0    [1    /1   ]  2.44173863789        1
[INPUT] 1    0    [1    /1   ]  0.833647476179       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47871413717, 1.0]], [0, [2712.0975880184187, 1.0]], [0, [617.4853775589817, 1.0]], [0, [175.00173394805188, 1.0]], [0, [20.61578956730736, 1.0]], [0, [56.85704819807453, 1.0]], [0, [0.48796558945768775, 1.0]], [0, [7.923762775356473, 1.0]], [0, [1.655299962484914, 1.0]], [1, [7.12094638735553, 1.0]], [1, [23.180513011853293, 1.0]], [1, [99.7045650372837, 1.0]], [1, [0.26670177978876203, 1.0]], [1, [2.4417386378873247, 1.0]], [1, [0.8336474761785844, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871414]
bas 1, expnt(s) = [2712.09758802]
bas 2, expnt(s) = [617.48537756]
bas 3, expnt(s) = [175.00173395]
bas 4, expnt(s) = [20.61578957]
bas 5, expnt(s) = [56.8570482]
bas 6, expnt(s) = [0.48796559]
bas 7, expnt(s) = [7.92376278]
bas 8, expnt(s) = [1.65529996]
bas 9, expnt(s) = [7.12094639]
bas 10, expnt(s) = [23.18051301]
bas 11, expnt(s) = [99.70456504]
bas 12, expnt(s) = [0.26670178]
bas 13, expnt(s) = [2.44173864]
bas 14, expnt(s) = [0.83364748]
CPU time:       228.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209759e+03 9.49497900e+02
 6.17485378e+02 3.12957261e+02 1.75001734e+02 1.21561706e+02
 2.06157896e+01 2.44435907e+01 5.68570482e+01 5.23122327e+01
 4.87965589e-01 1.47505061e+00 7.92376278e+00 1.19320104e+01
 1.65529996e+00 3.68699504e+00 7.12094639e+00 3.39356786e+01
 2.31805130e+01 1.48384383e+02 9.97045650e+01 9.19132656e+02
 2.66701780e-01 5.59135137e-01 2.44173864e+00 8.90447588e+00
 8.33647476e-01 2.32387328e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999170348087665
cond(S) = 243.87844054127126
E1 = -183.58689369018865  E_coul = 55.081479075268305
init E= -128.50541461492
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775329221787554  LUMO = 0.825629905850344
  mo_energy =
[-3.25542382e+01 -1.85119702e+00 -7.75329222e-01 -7.75329222e-01
 -7.75329222e-01  8.25629906e-01  8.25629906e-01  8.25629906e-01
  2.06561831e+00  3.95820550e+00  3.95820550e+00  3.95820550e+00
  1.43656708e+01  1.43656708e+01  1.43656708e+01  1.96362704e+01
  5.30406544e+01  5.30406544e+01  5.30406544e+01  9.44439622e+01
  2.40750368e+02  2.40750368e+02  2.40750368e+02  3.56873081e+02
  1.35029128e+03  5.83670755e+03  3.50992172e+04]
E1 = -182.09153936681366  E_coul = 53.55733234112956
cycle= 1 E= -128.534207025684  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502436
diis-c [-0.25244211  1.        ]
  HOMO = -0.883272639455887  LUMO = 0.799341780286395
  mo_energy =
[-3.28766976e+01 -1.96456606e+00 -8.83272639e-01 -8.83272639e-01
 -8.83272639e-01  7.99341780e-01  7.99341780e-01  7.99341780e-01
  1.98839041e+00  3.86159218e+00  3.86159218e+00  3.86159218e+00
  1.41758282e+01  1.41758282e+01  1.41758282e+01  1.94138754e+01
  5.27604909e+01  5.27604909e+01  5.27604909e+01  9.41400200e+01
  2.40404921e+02  2.40404921e+02  2.40404921e+02  3.56521896e+02
  1.34990192e+03  5.83628633e+03  3.50987744e+04]
E1 = -182.84981554644725  E_coul = 54.31301966649037
cycle= 2 E= -128.536795879957  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0735
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253627
diis-c [-6.06749625e-04  3.34670144e-01  6.65329856e-01]
  HOMO = -0.847737386541338  LUMO = 0.808042752081653
  mo_energy =
[-3.27688291e+01 -1.92705453e+00 -8.47737387e-01 -8.47737387e-01
 -8.47737387e-01  8.08042752e-01  8.08042752e-01  8.08042752e-01
  2.01371669e+00  3.89315307e+00  3.89315307e+00  3.89315307e+00
  1.42388932e+01  1.42388932e+01  1.42388932e+01  1.94883439e+01
  5.28543284e+01  5.28543284e+01  5.28543284e+01  9.42419226e+01
  2.40518326e+02  2.40518326e+02  2.40518326e+02  3.56636570e+02
  1.35002284e+03  5.83641020e+03  3.50988994e+04]
E1 = -182.59346547689645  E_coul = 54.05576128181805
cycle= 3 E= -128.537704195078  delta_E= -0.000908  |g|= 0.000468  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119815
diis-c [-1.06634545e-07 -2.16166711e-03  2.74274358e-04  1.00188739e+00]
  HOMO = -0.847960302218317  LUMO = 0.808016897638766
  mo_energy =
[-3.27692897e+01 -1.92722561e+00 -8.47960302e-01 -8.47960302e-01
 -8.47960302e-01  8.08016898e-01  8.08016898e-01  8.08016898e-01
  2.01362692e+00  3.89300520e+00  3.89300520e+00  3.89300520e+00
  1.42386140e+01  1.42386140e+01  1.42386140e+01  1.94880500e+01
  5.28539335e+01  5.28539335e+01  5.28539335e+01  9.42414923e+01
  2.40517789e+02  2.40517789e+02  2.40517789e+02  3.56636006e+02
  1.35002213e+03  5.83640936e+03  3.50988985e+04]
E1 = -182.59407099109535  E_coul = 54.0563667787825
cycle= 4 E= -128.537704212313  delta_E= -1.72e-08  |g|= 7.2e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187002
diis-c [-4.61639625e-10  1.32227071e-04  4.94319799e-04 -1.27209679e-01
  1.12658313e+00]
  HOMO = -0.847994953444328  LUMO = 0.808006702876925
  mo_energy =
[-3.27693602e+01 -1.92725487e+00 -8.47994953e-01 -8.47994953e-01
 -8.47994953e-01  8.08006703e-01  8.08006703e-01  8.08006703e-01
  2.01360415e+00  3.89297250e+00  3.89297250e+00  3.89297250e+00
  1.42385620e+01  1.42385620e+01  1.42385620e+01  1.94879959e+01
  5.28538689e+01  5.28538689e+01  5.28538689e+01  9.42414244e+01
  2.40517714e+02  2.40517714e+02  2.40517714e+02  3.56635929e+02
  1.35002204e+03  5.83640927e+03  3.50988984e+04]
E1 = -182.59422361151132  E_coul = 54.05651939873525
cycle= 5 E= -128.537704212776  delta_E= -4.63e-10  |g|= 2.73e-06  |ddm|= 1.68e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59422361151132  E_coul = 54.05651939873525
  HOMO = -0.847993835534712  LUMO = 0.808007029419285
  mo_energy =
[-3.27693577e+01 -1.92725323e+00 -8.47993836e-01 -8.47993836e-01
 -8.47993836e-01  8.08007029e-01  8.08007029e-01  8.08007029e-01
  2.01360537e+00  3.89297357e+00  3.89297357e+00  3.89297357e+00
  1.42385639e+01  1.42385639e+01  1.42385639e+01  1.94879982e+01
  5.28538713e+01  5.28538713e+01  5.28538713e+01  9.42414268e+01
  2.40517716e+02  2.40517716e+02  2.40517716e+02  3.56635931e+02
  1.35002204e+03  5.83640927e+03  3.50988984e+04]
E1 = -182.59421742973782  E_coul = 54.05651321696121
Extra cycle  E= -128.537704212777  delta_E= -5.4e-13  |g|= 8.92e-07  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 243.87844054127126
E1 = -182.59421742973782  E_coul = 54.05651321696121
init E= -128.537704212777
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.847994283223885  LUMO = 0.808006926722348
  mo_energy =
[-3.27693590e+01 -1.92725361e+00 -8.47994283e-01 -8.47994283e-01
 -8.47994283e-01  8.08006927e-01  8.08006927e-01  8.08006927e-01
  2.01360513e+00  3.89297319e+00  3.89297319e+00  3.89297319e+00
  1.42385631e+01  1.42385631e+01  1.42385631e+01  1.94879973e+01
  5.28538701e+01  5.28538701e+01  5.28538701e+01  9.42414255e+01
  2.40517715e+02  2.40517715e+02  2.40517715e+02  3.56635930e+02
  1.35002204e+03  5.83640927e+03  3.50988984e+04]
E1 = -182.5942208451564  E_coul = 54.05651663237979
cycle= 1 E= -128.537704212777  delta_E=    0  |g|= 4.73e-07  |ddm|= 3.17e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5942208451564  E_coul = 54.05651663237979
  HOMO = -0.847994044430388  LUMO = 0.808006986781248
  mo_energy =
[-3.27693583e+01 -1.92725334e+00 -8.47994044e-01 -8.47994044e-01
 -8.47994044e-01  8.08006987e-01  8.08006987e-01  8.08006987e-01
  2.01360532e+00  3.89297340e+00  3.89297340e+00  3.89297340e+00
  1.42385636e+01  1.42385636e+01  1.42385636e+01  1.94879978e+01
  5.28538708e+01  5.28538708e+01  5.28538708e+01  9.42414262e+01
  2.40517715e+02  2.40517715e+02  2.40517715e+02  3.56635930e+02
  1.35002204e+03  5.83640927e+03  3.50988984e+04]
E1 = -182.59421915138404  E_coul = 54.05651493860724
Extra cycle  E= -128.537704212777  delta_E= -1.71e-13  |g|= 2.3e-07  |ddm|= 1.92e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [1.80764787e+04 2.71209759e+03 6.17485378e+02 1.75001734e+02
 2.06157896e+01 5.68570482e+01 4.87965589e-01 7.92376278e+00
 1.65529996e+00 7.12094639e+00 2.31805130e+01 9.97045650e+01
 2.66701780e-01 2.44173864e+00 8.33647476e-01]
grad_E = [-2.38539081e-09  1.23337295e-07 -2.26562460e-06  2.10784930e-05
  1.20992263e-04 -9.25207354e-05 -1.79883286e-04  7.62177281e-05
  4.91138514e-05  2.43730341e-05 -1.36576510e-06 -2.93224446e-07
  2.26013048e-04 -5.27248599e-05  1.40983951e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787143        1
[INPUT] 0    0    [1    /1   ]  2712.09757844        1
[INPUT] 0    0    [1    /1   ]  617.48554277         1
[INPUT] 0    0    [1    /1   ]  175.00052215         1
[INPUT] 0    0    [1    /1   ]  20.613782593         1
[INPUT] 0    0    [1    /1   ]  56.8586084687        1
[INPUT] 0    0    [1    /1   ]  0.48804062178        1
[INPUT] 0    0    [1    /1   ]  7.92279122338        1
[INPUT] 0    0    [1    /1   ]  1.65532764512        1
[INPUT] 1    0    [1    /1   ]  7.10017136221        1
[INPUT] 1    0    [1    /1   ]  23.0853826467        1
[INPUT] 1    0    [1    /1   ]  99.1566631878        1
[INPUT] 1    0    [1    /1   ]  0.266296976337       1
[INPUT] 1    0    [1    /1   ]  2.4361813712         1
[INPUT] 1    0    [1    /1   ]  0.832086803329       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478714335113, 1.0]], [0, [2712.0975784375046, 1.0]], [0, [617.4855427699525, 1.0]], [0, [175.00052214982162, 1.0]], [0, [20.613782592975607, 1.0]], [0, [56.85860846865064, 1.0]], [0, [0.48804062178025903, 1.0]], [0, [7.922791223383886, 1.0]], [0, [1.6553276451164094, 1.0]], [1, [7.100171362212452, 1.0]], [1, [23.085382646671324, 1.0]], [1, [99.15666318778479, 1.0]], [1, [0.2662969763372881, 1.0]], [1, [2.436181371197525, 1.0]], [1, [0.8320868033290252, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871434]
bas 1, expnt(s) = [2712.09757844]
bas 2, expnt(s) = [617.48554277]
bas 3, expnt(s) = [175.00052215]
bas 4, expnt(s) = [20.61378259]
bas 5, expnt(s) = [56.85860847]
bas 6, expnt(s) = [0.48804062]
bas 7, expnt(s) = [7.92279122]
bas 8, expnt(s) = [1.65532765]
bas 9, expnt(s) = [7.10017136]
bas 10, expnt(s) = [23.08538265]
bas 11, expnt(s) = [99.15666319]
bas 12, expnt(s) = [0.26629698]
bas 13, expnt(s) = [2.43618137]
bas 14, expnt(s) = [0.8320868]
CPU time:       232.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209758e+03 9.49497898e+02
 6.17485543e+02 3.12957324e+02 1.75000522e+02 1.21561075e+02
 2.06137826e+01 2.44418060e+01 5.68586085e+01 5.23133093e+01
 4.88040622e-01 1.47522072e+00 7.92279122e+00 1.19309131e+01
 1.65532765e+00 3.68704128e+00 7.10017136e+00 3.38119666e+01
 2.30853826e+01 1.47623582e+02 9.91566632e+01 9.12823415e+02
 2.66296976e-01 5.58074510e-01 2.43618137e+00 8.87915045e+00
 8.32086803e-01 2.31843639e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999173704014908
cond(S) = 243.83740260714782
E1 = -183.5868861292329  E_coul = 55.08147535279759
init E= -128.505410776435
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77532940341842  LUMO = 0.823986611283894
  mo_energy =
[-3.25542400e+01 -1.85119718e+00 -7.75329403e-01 -7.75329403e-01
 -7.75329403e-01  8.23986611e-01  8.23986611e-01  8.23986611e-01
  2.06588323e+00  3.94944860e+00  3.94944860e+00  3.94944860e+00
  1.43261097e+01  1.43261097e+01  1.43261097e+01  1.96346039e+01
  5.28366843e+01  5.28366843e+01  5.28366843e+01  9.44375735e+01
  2.39447999e+02  2.39447999e+02  2.39447999e+02  3.56865477e+02
  1.35028313e+03  5.83669972e+03  3.50992107e+04]
E1 = -182.09131326513676  E_coul = 53.55710681905972
cycle= 1 E= -128.534206446077  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502739
diis-c [-0.25274651  1.        ]
  HOMO = -0.883289284694237  LUMO = 0.797761472648513
  mo_energy =
[-3.28767378e+01 -1.96458918e+00 -8.83289285e-01 -8.83289285e-01
 -8.83289285e-01  7.97761473e-01  7.97761473e-01  7.97761473e-01
  1.98863250e+00  3.85300121e+00  3.85300121e+00  3.85300121e+00
  1.41365057e+01  1.41365057e+01  1.41365057e+01  1.94121896e+01
  5.25567406e+01  5.25567406e+01  5.25567406e+01  9.41335963e+01
  2.39102699e+02  2.39102699e+02  2.39102699e+02  3.56514253e+02
  1.34989373e+03  5.83627845e+03  3.50987678e+04]
E1 = -182.84974168131495  E_coul = 54.312945853896785
cycle= 2 E= -128.536795827418  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0735
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253805
diis-c [-6.06762762e-04  3.34693253e-01  6.65306747e-01]
  HOMO = -0.84774768577218  LUMO = 0.806441394095019
  mo_energy =
[-3.27688533e+01 -1.92707076e+00 -8.47747686e-01 -8.47747686e-01
 -8.47747686e-01  8.06441394e-01  8.06441394e-01  8.06441394e-01
  2.01396502e+00  3.88450726e+00  3.88450726e+00  3.88450726e+00
  1.41994900e+01  1.41994900e+01  1.41994900e+01  1.94866665e+01
  5.26505076e+01  5.26505076e+01  5.26505076e+01  9.42355134e+01
  2.39216076e+02  2.39216076e+02  2.39216076e+02  3.56628943e+02
  1.35001467e+03  5.83640234e+03  3.50988928e+04]
E1 = -182.5933242288404  E_coul = 54.05561969754763
cycle= 3 E= -128.537704531293  delta_E= -0.000909  |g|= 0.000468  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119643
diis-c [-1.06231159e-07 -2.16072842e-03  2.66964686e-04  1.00189376e+00]
  HOMO = -0.847970703105419  LUMO = 0.806415517289882
  mo_energy =
[-3.27693138e+01 -1.92724235e+00 -8.47970703e-01 -8.47970703e-01
 -8.47970703e-01  8.06415517e-01  8.06415517e-01  8.06415517e-01
  2.01387479e+00  3.88435950e+00  3.88435950e+00  3.88435950e+00
  1.41992110e+01  1.41992110e+01  1.41992110e+01  1.94863726e+01
  5.26501131e+01  5.26501131e+01  5.26501131e+01  9.42350832e+01
  2.39215540e+02  2.39215540e+02  2.39215540e+02  3.56628380e+02
  1.35001396e+03  5.83640151e+03  3.50988919e+04]
E1 = -182.59392759029353  E_coul = 54.05622304179996
cycle= 4 E= -128.537704548494  delta_E= -1.72e-08  |g|= 7.19e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186627
diis-c [-4.57503741e-10  1.30754495e-04  4.93184503e-04 -1.26529635e-01
  1.12590570e+00]
  HOMO = -0.848005369547376  LUMO = 0.806405324149809
  mo_energy =
[-3.27693842e+01 -1.92727173e+00 -8.48005370e-01 -8.48005370e-01
 -8.48005370e-01  8.06405324e-01  8.06405324e-01  8.06405324e-01
  2.01385190e+00  3.88432681e+00  3.88432681e+00  3.88432681e+00
  1.41991590e+01  1.41991590e+01  1.41991590e+01  1.94863184e+01
  5.26500485e+01  5.26500485e+01  5.26500485e+01  9.42350153e+01
  2.39215465e+02  2.39215465e+02  2.39215465e+02  3.56628303e+02
  1.35001387e+03  5.83640142e+03  3.50988918e+04]
E1 = -182.5940797550561  E_coul = 54.056375206101826
cycle= 5 E= -128.537704548954  delta_E= -4.61e-10  |g|= 2.69e-06  |ddm|= 1.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5940797550561  E_coul = 54.056375206101826
  HOMO = -0.848004271141917  LUMO = 0.806405642922403
  mo_energy =
[-3.27693817e+01 -1.92727012e+00 -8.48004271e-01 -8.48004271e-01
 -8.48004271e-01  8.06405643e-01  8.06405643e-01  8.06405643e-01
  2.01385311e+00  3.88432787e+00  3.88432787e+00  3.88432787e+00
  1.41991609e+01  1.41991609e+01  1.41991609e+01  1.94863207e+01
  5.26500509e+01  5.26500509e+01  5.26500509e+01  9.42350177e+01
  2.39215467e+02  2.39215467e+02  2.39215467e+02  3.56628305e+02
  1.35001387e+03  5.83640142e+03  3.50988918e+04]
E1 = -182.59407362348594  E_coul = 54.05636907453078
Extra cycle  E= -128.537704548955  delta_E= -8.81e-13  |g|= 8.83e-07  |ddm|= 1.46e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209758e+03 6.17485543e+02 1.75000522e+02
 2.06137826e+01 5.68586085e+01 4.88040622e-01 7.92279122e+00
 1.65532765e+00 7.10017136e+00 2.30853826e+01 9.91566632e+01
 2.66296976e-01 2.43618137e+00 8.32086803e-01]
E = -128.53770454895516
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787143        1
[INPUT] 0    0    [1    /1   ]  2712.09757844        1
[INPUT] 0    0    [1    /1   ]  617.48554277         1
[INPUT] 0    0    [1    /1   ]  175.00052215         1
[INPUT] 0    0    [1    /1   ]  20.613782593         1
[INPUT] 0    0    [1    /1   ]  56.8586084687        1
[INPUT] 0    0    [1    /1   ]  0.48804062178        1
[INPUT] 0    0    [1    /1   ]  7.92279122338        1
[INPUT] 0    0    [1    /1   ]  1.65532764512        1
[INPUT] 1    0    [1    /1   ]  7.10017136221        1
[INPUT] 1    0    [1    /1   ]  23.0853826467        1
[INPUT] 1    0    [1    /1   ]  99.1566631878        1
[INPUT] 1    0    [1    /1   ]  0.266296976337       1
[INPUT] 1    0    [1    /1   ]  2.4361813712         1
[INPUT] 1    0    [1    /1   ]  0.832086803329       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478714335113, 1.0]], [0, [2712.0975784375046, 1.0]], [0, [617.4855427699525, 1.0]], [0, [175.00052214982162, 1.0]], [0, [20.613782592975607, 1.0]], [0, [56.85860846865064, 1.0]], [0, [0.48804062178025903, 1.0]], [0, [7.922791223383886, 1.0]], [0, [1.6553276451164094, 1.0]], [1, [7.100171362212452, 1.0]], [1, [23.085382646671324, 1.0]], [1, [99.15666318778479, 1.0]], [1, [0.2662969763372881, 1.0]], [1, [2.436181371197525, 1.0]], [1, [0.8320868033290252, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871434]
bas 1, expnt(s) = [2712.09757844]
bas 2, expnt(s) = [617.48554277]
bas 3, expnt(s) = [175.00052215]
bas 4, expnt(s) = [20.61378259]
bas 5, expnt(s) = [56.85860847]
bas 6, expnt(s) = [0.48804062]
bas 7, expnt(s) = [7.92279122]
bas 8, expnt(s) = [1.65532765]
bas 9, expnt(s) = [7.10017136]
bas 10, expnt(s) = [23.08538265]
bas 11, expnt(s) = [99.15666319]
bas 12, expnt(s) = [0.26629698]
bas 13, expnt(s) = [2.43618137]
bas 14, expnt(s) = [0.8320868]
CPU time:       233.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209758e+03 9.49497898e+02
 6.17485543e+02 3.12957324e+02 1.75000522e+02 1.21561075e+02
 2.06137826e+01 2.44418060e+01 5.68586085e+01 5.23133093e+01
 4.88040622e-01 1.47522072e+00 7.92279122e+00 1.19309131e+01
 1.65532765e+00 3.68704128e+00 7.10017136e+00 3.38119666e+01
 2.30853826e+01 1.47623582e+02 9.91566632e+01 9.12823415e+02
 2.66296976e-01 5.58074510e-01 2.43618137e+00 8.87915045e+00
 8.32086803e-01 2.31843639e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999173704014908
cond(S) = 243.83740260714782
E1 = -183.5868861292329  E_coul = 55.08147535279759
init E= -128.505410776435
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77532940341842  LUMO = 0.823986611283894
  mo_energy =
[-3.25542400e+01 -1.85119718e+00 -7.75329403e-01 -7.75329403e-01
 -7.75329403e-01  8.23986611e-01  8.23986611e-01  8.23986611e-01
  2.06588323e+00  3.94944860e+00  3.94944860e+00  3.94944860e+00
  1.43261097e+01  1.43261097e+01  1.43261097e+01  1.96346039e+01
  5.28366843e+01  5.28366843e+01  5.28366843e+01  9.44375735e+01
  2.39447999e+02  2.39447999e+02  2.39447999e+02  3.56865477e+02
  1.35028313e+03  5.83669972e+03  3.50992107e+04]
E1 = -182.09131326513676  E_coul = 53.55710681905972
cycle= 1 E= -128.534206446077  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502739
diis-c [-0.25274651  1.        ]
  HOMO = -0.883289284694237  LUMO = 0.797761472648513
  mo_energy =
[-3.28767378e+01 -1.96458918e+00 -8.83289285e-01 -8.83289285e-01
 -8.83289285e-01  7.97761473e-01  7.97761473e-01  7.97761473e-01
  1.98863250e+00  3.85300121e+00  3.85300121e+00  3.85300121e+00
  1.41365057e+01  1.41365057e+01  1.41365057e+01  1.94121896e+01
  5.25567406e+01  5.25567406e+01  5.25567406e+01  9.41335963e+01
  2.39102699e+02  2.39102699e+02  2.39102699e+02  3.56514253e+02
  1.34989373e+03  5.83627845e+03  3.50987678e+04]
E1 = -182.84974168131495  E_coul = 54.312945853896785
cycle= 2 E= -128.536795827418  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0735
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253805
diis-c [-6.06762762e-04  3.34693253e-01  6.65306747e-01]
  HOMO = -0.84774768577218  LUMO = 0.806441394095019
  mo_energy =
[-3.27688533e+01 -1.92707076e+00 -8.47747686e-01 -8.47747686e-01
 -8.47747686e-01  8.06441394e-01  8.06441394e-01  8.06441394e-01
  2.01396502e+00  3.88450726e+00  3.88450726e+00  3.88450726e+00
  1.41994900e+01  1.41994900e+01  1.41994900e+01  1.94866665e+01
  5.26505076e+01  5.26505076e+01  5.26505076e+01  9.42355134e+01
  2.39216076e+02  2.39216076e+02  2.39216076e+02  3.56628943e+02
  1.35001467e+03  5.83640234e+03  3.50988928e+04]
E1 = -182.5933242288404  E_coul = 54.05561969754763
cycle= 3 E= -128.537704531293  delta_E= -0.000909  |g|= 0.000468  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119643
diis-c [-1.06231159e-07 -2.16072842e-03  2.66964686e-04  1.00189376e+00]
  HOMO = -0.847970703105419  LUMO = 0.806415517289882
  mo_energy =
[-3.27693138e+01 -1.92724235e+00 -8.47970703e-01 -8.47970703e-01
 -8.47970703e-01  8.06415517e-01  8.06415517e-01  8.06415517e-01
  2.01387479e+00  3.88435950e+00  3.88435950e+00  3.88435950e+00
  1.41992110e+01  1.41992110e+01  1.41992110e+01  1.94863726e+01
  5.26501131e+01  5.26501131e+01  5.26501131e+01  9.42350832e+01
  2.39215540e+02  2.39215540e+02  2.39215540e+02  3.56628380e+02
  1.35001396e+03  5.83640151e+03  3.50988919e+04]
E1 = -182.59392759029353  E_coul = 54.05622304179996
cycle= 4 E= -128.537704548494  delta_E= -1.72e-08  |g|= 7.19e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186627
diis-c [-4.57503741e-10  1.30754495e-04  4.93184503e-04 -1.26529635e-01
  1.12590570e+00]
  HOMO = -0.848005369547376  LUMO = 0.806405324149809
  mo_energy =
[-3.27693842e+01 -1.92727173e+00 -8.48005370e-01 -8.48005370e-01
 -8.48005370e-01  8.06405324e-01  8.06405324e-01  8.06405324e-01
  2.01385190e+00  3.88432681e+00  3.88432681e+00  3.88432681e+00
  1.41991590e+01  1.41991590e+01  1.41991590e+01  1.94863184e+01
  5.26500485e+01  5.26500485e+01  5.26500485e+01  9.42350153e+01
  2.39215465e+02  2.39215465e+02  2.39215465e+02  3.56628303e+02
  1.35001387e+03  5.83640142e+03  3.50988918e+04]
E1 = -182.5940797550561  E_coul = 54.056375206101826
cycle= 5 E= -128.537704548954  delta_E= -4.61e-10  |g|= 2.69e-06  |ddm|= 1.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5940797550561  E_coul = 54.056375206101826
  HOMO = -0.848004271141917  LUMO = 0.806405642922403
  mo_energy =
[-3.27693817e+01 -1.92727012e+00 -8.48004271e-01 -8.48004271e-01
 -8.48004271e-01  8.06405643e-01  8.06405643e-01  8.06405643e-01
  2.01385311e+00  3.88432787e+00  3.88432787e+00  3.88432787e+00
  1.41991609e+01  1.41991609e+01  1.41991609e+01  1.94863207e+01
  5.26500509e+01  5.26500509e+01  5.26500509e+01  9.42350177e+01
  2.39215467e+02  2.39215467e+02  2.39215467e+02  3.56628305e+02
  1.35001387e+03  5.83640142e+03  3.50988918e+04]
E1 = -182.59407362348594  E_coul = 54.05636907453078
Extra cycle  E= -128.537704548955  delta_E= -8.81e-13  |g|= 8.83e-07  |ddm|= 1.46e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 243.83740260714782
E1 = -182.59407362348594  E_coul = 54.05636907453078
init E= -128.537704548955
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.848004715425783  LUMO = 0.806405541029712
  mo_energy =
[-3.27693831e+01 -1.92727050e+00 -8.48004715e-01 -8.48004715e-01
 -8.48004715e-01  8.06405541e-01  8.06405541e-01  8.06405541e-01
  2.01385286e+00  3.88432748e+00  3.88432748e+00  3.88432748e+00
  1.41991601e+01  1.41991601e+01  1.41991601e+01  1.94863198e+01
  5.26500498e+01  5.26500498e+01  5.26500498e+01  9.42350164e+01
  2.39215465e+02  2.39215465e+02  2.39215465e+02  3.56628303e+02
  1.35001387e+03  5.83640142e+03  3.50988918e+04]
E1 = -182.59407700321677  E_coul = 54.0563724542615
cycle= 1 E= -128.537704548955  delta_E= -1.14e-13  |g|= 4.68e-07  |ddm|= 3.12e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59407700321677  E_coul = 54.0563724542615
  HOMO = -0.848004479143845  LUMO = 0.806405600274196
  mo_energy =
[-3.27693824e+01 -1.92727023e+00 -8.48004479e-01 -8.48004479e-01
 -8.48004479e-01  8.06405600e-01  8.06405600e-01  8.06405600e-01
  2.01385305e+00  3.88432769e+00  3.88432769e+00  3.88432769e+00
  1.41991606e+01  1.41991606e+01  1.41991606e+01  1.94863203e+01
  5.26500504e+01  5.26500504e+01  5.26500504e+01  9.42350171e+01
  2.39215466e+02  2.39215466e+02  2.39215466e+02  3.56628304e+02
  1.35001387e+03  5.83640142e+03  3.50988918e+04]
E1 = -182.5940753259323  E_coul = 54.056370776976685
Extra cycle  E= -128.537704548956  delta_E= -3.41e-13  |g|= 2.27e-07  |ddm|= 1.9e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209758e+03 6.17485543e+02 1.75000522e+02
 2.06137826e+01 5.68586085e+01 4.88040622e-01 7.92279122e+00
 1.65532765e+00 7.10017136e+00 2.30853826e+01 9.91566632e+01
 2.66296976e-01 2.43618137e+00 8.32086803e-01]
grad_E = [-2.34309630e-09  1.21140975e-07 -2.22477915e-06  2.06781265e-05
  1.16861361e-04 -9.05413972e-05 -3.84145151e-05  7.89499556e-05
  1.54202445e-05  3.16916844e-05 -3.63279821e-06 -6.64322227e-07
  3.64695741e-05 -7.11471570e-05  6.84068767e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787144        1
[INPUT] 0    0    [1    /1   ]  2712.09757428        1
[INPUT] 0    0    [1    /1   ]  617.485614778        1
[INPUT] 0    0    [1    /1   ]  174.999984624        1
[INPUT] 0    0    [1    /1   ]  20.6124464201        1
[INPUT] 0    0    [1    /1   ]  56.8594488462        1
[INPUT] 0    0    [1    /1   ]  0.488069429227       1
[INPUT] 0    0    [1    /1   ]  7.92295100287        1
[INPUT] 0    0    [1    /1   ]  1.6552617645         1
[INPUT] 1    0    [1    /1   ]  7.08809593856        1
[INPUT] 1    0    [1    /1   ]  23.0405659704        1
[INPUT] 1    0    [1    /1   ]  98.9304579637        1
[INPUT] 1    0    [1    /1   ]  0.266047087508       1
[INPUT] 1    0    [1    /1   ]  2.433009033          1
[INPUT] 1    0    [1    /1   ]  0.831165072763       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478714420766, 1.0]], [0, [2712.0975742796436, 1.0]], [0, [617.4856147775703, 1.0]], [0, [174.99998462414572, 1.0]], [0, [20.612446420134038, 1.0]], [0, [56.85944884615853, 1.0]], [0, [0.4880694292269015, 1.0]], [0, [7.922951002867902, 1.0]], [0, [1.6552617644995713, 1.0]], [1, [7.088095938559068, 1.0]], [1, [23.04056597036983, 1.0]], [1, [98.93045796371774, 1.0]], [1, [0.2660470875082063, 1.0]], [1, [2.4330090330022807, 1.0]], [1, [0.8311650727633432, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871442]
bas 1, expnt(s) = [2712.09757428]
bas 2, expnt(s) = [617.48561478]
bas 3, expnt(s) = [174.99998462]
bas 4, expnt(s) = [20.61244642]
bas 5, expnt(s) = [56.85944885]
bas 6, expnt(s) = [0.48806943]
bas 7, expnt(s) = [7.922951]
bas 8, expnt(s) = [1.65526176]
bas 9, expnt(s) = [7.08809594]
bas 10, expnt(s) = [23.04056597]
bas 11, expnt(s) = [98.93045796]
bas 12, expnt(s) = [0.26604709]
bas 13, expnt(s) = [2.43300903]
bas 14, expnt(s) = [0.83116507]
CPU time:       236.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209757e+03 9.49497896e+02
 6.17485615e+02 3.12957351e+02 1.74999985e+02 1.21560795e+02
 2.06124464e+01 2.44406178e+01 5.68594488e+01 5.23138892e+01
 4.88069429e-01 1.47528603e+00 7.92295100e+00 1.19310936e+01
 1.65526176e+00 3.68693123e+00 7.08809594e+00 3.37401009e+01
 2.30405660e+01 1.47265434e+02 9.89304580e+01 9.10221138e+02
 2.66047088e-01 5.57419977e-01 2.43300903e+00 8.86470003e+00
 8.31165073e-01 2.31522658e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999175798573747
cond(S) = 243.83339104301353
E1 = -183.58687811376862  E_coul = 55.08147275873846
init E= -128.50540535503
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.7753294926867  LUMO = 0.822985631923576
  mo_energy =
[-3.25542410e+01 -1.85119763e+00 -7.75329493e-01 -7.75329493e-01
 -7.75329493e-01  8.22985632e-01  8.22985632e-01  8.22985632e-01
  2.06592720e+00  3.94434065e+00  3.94434065e+00  3.94434065e+00
  1.43032697e+01  1.43032697e+01  1.43032697e+01  1.96343003e+01
  5.27314324e+01  5.27314324e+01  5.27314324e+01  9.44356032e+01
  2.38879453e+02  2.38879453e+02  2.38879453e+02  3.56862858e+02
  1.35028025e+03  5.83669691e+03  3.50992083e+04]
E1 = -182.09117141132666  E_coul = 53.55696542217161
cycle= 1 E= -128.534205989155  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502869
diis-c [-0.25287725  1.        ]
  HOMO = -0.883299638356647  LUMO = 0.796798598253014
  mo_energy =
[-3.28767630e+01 -1.96460382e+00 -8.83299638e-01 -8.83299638e-01
 -8.83299638e-01  7.96798598e-01  7.96798598e-01  7.96798598e-01
  1.98866505e+00  3.84798705e+00  3.84798705e+00  3.84798705e+00
  1.41137987e+01  1.41137987e+01  1.41137987e+01  1.94118698e+01
  5.24515886e+01  5.24515886e+01  5.24515886e+01  9.41316044e+01
  2.38534205e+02  2.38534205e+02  2.38534205e+02  3.56511609e+02
  1.34989082e+03  5.83627562e+03  3.50987654e+04]
E1 = -182.84969401110044  E_coul = 54.31289832483286
cycle= 2 E= -128.536795686268  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253888
diis-c [-6.06762541e-04  3.34708334e-01  6.65291666e-01]
  HOMO = -0.847754130068354  LUMO = 0.805465919433885
  mo_energy =
[-3.27688688e+01 -1.92708118e+00 -8.47754130e-01 -8.47754130e-01
 -8.47754130e-01  8.05465919e-01  8.05465919e-01  8.05465919e-01
  2.01400057e+00  3.87946213e+00  3.87946213e+00  3.87946213e+00
  1.41767381e+01  1.41767381e+01  1.41767381e+01  1.94863535e+01
  5.25453238e+01  5.25453238e+01  5.25453238e+01  9.42335304e+01
  2.38647574e+02  2.38647574e+02  2.38647574e+02  3.56626310e+02
  1.35001177e+03  5.83639952e+03  3.50988904e+04]
E1 = -182.59323591632324  E_coul = 54.055531288043916
cycle= 3 E= -128.537704628279  delta_E= -0.000909  |g|= 0.000468  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119483
diis-c [-1.05925116e-07 -2.15964654e-03  2.61839552e-04  1.00189781e+00]
  HOMO = -0.847977111487952  LUMO = 0.80544007277407
  mo_energy =
[-3.27693291e+01 -1.92725296e+00 -8.47977111e-01 -8.47977111e-01
 -8.47977111e-01  8.05440073e-01  8.05440073e-01  8.05440073e-01
  2.01391016e+00  3.87931453e+00  3.87931453e+00  3.87931453e+00
  1.41764594e+01  1.41764594e+01  1.41764594e+01  1.94860596e+01
  5.25449296e+01  5.25449296e+01  5.25449296e+01  9.42331004e+01
  2.38647038e+02  2.38647038e+02  2.38647038e+02  3.56625747e+02
  1.35001106e+03  5.83639868e+03  3.50988895e+04]
E1 = -182.59383775762205  E_coul = 54.05613311217831
cycle= 4 E= -128.537704645444  delta_E= -1.72e-08  |g|= 7.18e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186342
diis-c [-4.55200516e-10  1.29932181e-04  4.92513160e-04 -1.26157056e-01
  1.12553461e+00]
  HOMO = -0.84801177211176  LUMO = 0.805429886678547
  mo_energy =
[-3.27693994e+01 -1.92728239e+00 -8.48011772e-01 -8.48011772e-01
 -8.48011772e-01  8.05429887e-01  8.05429887e-01  8.05429887e-01
  2.01388723e+00  3.87928186e+00  3.87928186e+00  3.87928186e+00
  1.41764075e+01  1.41764075e+01  1.41764075e+01  1.94860054e+01
  5.25448651e+01  5.25448651e+01  5.25448651e+01  9.42330326e+01
  2.38646963e+02  2.38646963e+02  2.38646963e+02  3.56625670e+02
  1.35001098e+03  5.83639859e+03  3.50988894e+04]
E1 = -182.59398962543406  E_coul = 54.05628497953108
cycle= 5 E= -128.537704645903  delta_E= -4.59e-10  |g|= 2.67e-06  |ddm|= 1.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59398962543406  E_coul = 54.05628497953108
  HOMO = -0.84801068450633  LUMO = 0.805430201114882
  mo_energy =
[-3.27693970e+01 -1.92728080e+00 -8.48010685e-01 -8.48010685e-01
 -8.48010685e-01  8.05430201e-01  8.05430201e-01  8.05430201e-01
  2.01388842e+00  3.87928291e+00  3.87928291e+00  3.87928291e+00
  1.41764093e+01  1.41764093e+01  1.41764093e+01  1.94860077e+01
  5.25448675e+01  5.25448675e+01  5.25448675e+01  9.42330350e+01
  2.38646965e+02  2.38646965e+02  2.38646965e+02  3.56625672e+02
  1.35001098e+03  5.83639860e+03  3.50988894e+04]
E1 = -182.59398352207864  E_coul = 54.056278876174844
Extra cycle  E= -128.537704645904  delta_E= -8.24e-13  |g|= 8.78e-07  |ddm|= 1.45e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209757e+03 6.17485615e+02 1.74999985e+02
 2.06124464e+01 5.68594488e+01 4.88069429e-01 7.92295100e+00
 1.65526176e+00 7.08809594e+00 2.30405660e+01 9.89304580e+01
 2.66047088e-01 2.43300903e+00 8.31165073e-01]
E = -128.5377046459038
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787144        1
[INPUT] 0    0    [1    /1   ]  2712.09757428        1
[INPUT] 0    0    [1    /1   ]  617.485614778        1
[INPUT] 0    0    [1    /1   ]  174.999984624        1
[INPUT] 0    0    [1    /1   ]  20.6124464201        1
[INPUT] 0    0    [1    /1   ]  56.8594488462        1
[INPUT] 0    0    [1    /1   ]  0.488069429227       1
[INPUT] 0    0    [1    /1   ]  7.92295100287        1
[INPUT] 0    0    [1    /1   ]  1.6552617645         1
[INPUT] 1    0    [1    /1   ]  7.08809593856        1
[INPUT] 1    0    [1    /1   ]  23.0405659704        1
[INPUT] 1    0    [1    /1   ]  98.9304579637        1
[INPUT] 1    0    [1    /1   ]  0.266047087508       1
[INPUT] 1    0    [1    /1   ]  2.433009033          1
[INPUT] 1    0    [1    /1   ]  0.831165072763       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478714420766, 1.0]], [0, [2712.0975742796436, 1.0]], [0, [617.4856147775703, 1.0]], [0, [174.99998462414572, 1.0]], [0, [20.612446420134038, 1.0]], [0, [56.85944884615853, 1.0]], [0, [0.4880694292269015, 1.0]], [0, [7.922951002867902, 1.0]], [0, [1.6552617644995713, 1.0]], [1, [7.088095938559068, 1.0]], [1, [23.04056597036983, 1.0]], [1, [98.93045796371774, 1.0]], [1, [0.2660470875082063, 1.0]], [1, [2.4330090330022807, 1.0]], [1, [0.8311650727633432, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871442]
bas 1, expnt(s) = [2712.09757428]
bas 2, expnt(s) = [617.48561478]
bas 3, expnt(s) = [174.99998462]
bas 4, expnt(s) = [20.61244642]
bas 5, expnt(s) = [56.85944885]
bas 6, expnt(s) = [0.48806943]
bas 7, expnt(s) = [7.922951]
bas 8, expnt(s) = [1.65526176]
bas 9, expnt(s) = [7.08809594]
bas 10, expnt(s) = [23.04056597]
bas 11, expnt(s) = [98.93045796]
bas 12, expnt(s) = [0.26604709]
bas 13, expnt(s) = [2.43300903]
bas 14, expnt(s) = [0.83116507]
CPU time:       237.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209757e+03 9.49497896e+02
 6.17485615e+02 3.12957351e+02 1.74999985e+02 1.21560795e+02
 2.06124464e+01 2.44406178e+01 5.68594488e+01 5.23138892e+01
 4.88069429e-01 1.47528603e+00 7.92295100e+00 1.19310936e+01
 1.65526176e+00 3.68693123e+00 7.08809594e+00 3.37401009e+01
 2.30405660e+01 1.47265434e+02 9.89304580e+01 9.10221138e+02
 2.66047088e-01 5.57419977e-01 2.43300903e+00 8.86470003e+00
 8.31165073e-01 2.31522658e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999175798573747
cond(S) = 243.83339104301353
E1 = -183.58687811376862  E_coul = 55.08147275873846
init E= -128.50540535503
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.7753294926867  LUMO = 0.822985631923576
  mo_energy =
[-3.25542410e+01 -1.85119763e+00 -7.75329493e-01 -7.75329493e-01
 -7.75329493e-01  8.22985632e-01  8.22985632e-01  8.22985632e-01
  2.06592720e+00  3.94434065e+00  3.94434065e+00  3.94434065e+00
  1.43032697e+01  1.43032697e+01  1.43032697e+01  1.96343003e+01
  5.27314324e+01  5.27314324e+01  5.27314324e+01  9.44356032e+01
  2.38879453e+02  2.38879453e+02  2.38879453e+02  3.56862858e+02
  1.35028025e+03  5.83669691e+03  3.50992083e+04]
E1 = -182.09117141132666  E_coul = 53.55696542217161
cycle= 1 E= -128.534205989155  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502869
diis-c [-0.25287725  1.        ]
  HOMO = -0.883299638356647  LUMO = 0.796798598253014
  mo_energy =
[-3.28767630e+01 -1.96460382e+00 -8.83299638e-01 -8.83299638e-01
 -8.83299638e-01  7.96798598e-01  7.96798598e-01  7.96798598e-01
  1.98866505e+00  3.84798705e+00  3.84798705e+00  3.84798705e+00
  1.41137987e+01  1.41137987e+01  1.41137987e+01  1.94118698e+01
  5.24515886e+01  5.24515886e+01  5.24515886e+01  9.41316044e+01
  2.38534205e+02  2.38534205e+02  2.38534205e+02  3.56511609e+02
  1.34989082e+03  5.83627562e+03  3.50987654e+04]
E1 = -182.84969401110044  E_coul = 54.31289832483286
cycle= 2 E= -128.536795686268  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253888
diis-c [-6.06762541e-04  3.34708334e-01  6.65291666e-01]
  HOMO = -0.847754130068354  LUMO = 0.805465919433885
  mo_energy =
[-3.27688688e+01 -1.92708118e+00 -8.47754130e-01 -8.47754130e-01
 -8.47754130e-01  8.05465919e-01  8.05465919e-01  8.05465919e-01
  2.01400057e+00  3.87946213e+00  3.87946213e+00  3.87946213e+00
  1.41767381e+01  1.41767381e+01  1.41767381e+01  1.94863535e+01
  5.25453238e+01  5.25453238e+01  5.25453238e+01  9.42335304e+01
  2.38647574e+02  2.38647574e+02  2.38647574e+02  3.56626310e+02
  1.35001177e+03  5.83639952e+03  3.50988904e+04]
E1 = -182.59323591632324  E_coul = 54.055531288043916
cycle= 3 E= -128.537704628279  delta_E= -0.000909  |g|= 0.000468  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119483
diis-c [-1.05925116e-07 -2.15964654e-03  2.61839552e-04  1.00189781e+00]
  HOMO = -0.847977111487952  LUMO = 0.80544007277407
  mo_energy =
[-3.27693291e+01 -1.92725296e+00 -8.47977111e-01 -8.47977111e-01
 -8.47977111e-01  8.05440073e-01  8.05440073e-01  8.05440073e-01
  2.01391016e+00  3.87931453e+00  3.87931453e+00  3.87931453e+00
  1.41764594e+01  1.41764594e+01  1.41764594e+01  1.94860596e+01
  5.25449296e+01  5.25449296e+01  5.25449296e+01  9.42331004e+01
  2.38647038e+02  2.38647038e+02  2.38647038e+02  3.56625747e+02
  1.35001106e+03  5.83639868e+03  3.50988895e+04]
E1 = -182.59383775762205  E_coul = 54.05613311217831
cycle= 4 E= -128.537704645444  delta_E= -1.72e-08  |g|= 7.18e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186342
diis-c [-4.55200516e-10  1.29932181e-04  4.92513160e-04 -1.26157056e-01
  1.12553461e+00]
  HOMO = -0.84801177211176  LUMO = 0.805429886678547
  mo_energy =
[-3.27693994e+01 -1.92728239e+00 -8.48011772e-01 -8.48011772e-01
 -8.48011772e-01  8.05429887e-01  8.05429887e-01  8.05429887e-01
  2.01388723e+00  3.87928186e+00  3.87928186e+00  3.87928186e+00
  1.41764075e+01  1.41764075e+01  1.41764075e+01  1.94860054e+01
  5.25448651e+01  5.25448651e+01  5.25448651e+01  9.42330326e+01
  2.38646963e+02  2.38646963e+02  2.38646963e+02  3.56625670e+02
  1.35001098e+03  5.83639859e+03  3.50988894e+04]
E1 = -182.59398962543406  E_coul = 54.05628497953108
cycle= 5 E= -128.537704645903  delta_E= -4.59e-10  |g|= 2.67e-06  |ddm|= 1.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59398962543406  E_coul = 54.05628497953108
  HOMO = -0.84801068450633  LUMO = 0.805430201114882
  mo_energy =
[-3.27693970e+01 -1.92728080e+00 -8.48010685e-01 -8.48010685e-01
 -8.48010685e-01  8.05430201e-01  8.05430201e-01  8.05430201e-01
  2.01388842e+00  3.87928291e+00  3.87928291e+00  3.87928291e+00
  1.41764093e+01  1.41764093e+01  1.41764093e+01  1.94860077e+01
  5.25448675e+01  5.25448675e+01  5.25448675e+01  9.42330350e+01
  2.38646965e+02  2.38646965e+02  2.38646965e+02  3.56625672e+02
  1.35001098e+03  5.83639860e+03  3.50988894e+04]
E1 = -182.59398352207864  E_coul = 54.056278876174844
Extra cycle  E= -128.537704645904  delta_E= -8.24e-13  |g|= 8.78e-07  |ddm|= 1.45e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 243.83339104301353
E1 = -182.59398352207864  E_coul = 54.056278876174844
init E= -128.537704645904
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.848011126877935  LUMO = 0.805430099684629
  mo_energy =
[-3.27693983e+01 -1.92728117e+00 -8.48011127e-01 -8.48011127e-01
 -8.48011127e-01  8.05430100e-01  8.05430100e-01  8.05430100e-01
  2.01388817e+00  3.87928252e+00  3.87928252e+00  3.87928252e+00
  1.41764086e+01  1.41764086e+01  1.41764086e+01  1.94860068e+01
  5.25448663e+01  5.25448663e+01  5.25448663e+01  9.42330337e+01
  2.38646964e+02  2.38646964e+02  2.38646964e+02  3.56625671e+02
  1.35001098e+03  5.83639859e+03  3.50988894e+04]
E1 = -182.59398688184694  E_coul = 54.0562822359434
cycle= 1 E= -128.537704645904  delta_E= 2.56e-13  |g|= 4.65e-07  |ddm|= 3.1e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59398688184694  E_coul = 54.0562822359434
  HOMO = -0.848010892001265  LUMO = 0.805430158468979
  mo_energy =
[-3.27693976e+01 -1.92728091e+00 -8.48010892e-01 -8.48010892e-01
 -8.48010892e-01  8.05430158e-01  8.05430158e-01  8.05430158e-01
  2.01388836e+00  3.87928273e+00  3.87928273e+00  3.87928273e+00
  1.41764090e+01  1.41764090e+01  1.41764090e+01  1.94860073e+01
  5.25448670e+01  5.25448670e+01  5.25448670e+01  9.42330344e+01
  2.38646965e+02  2.38646965e+02  2.38646965e+02  3.56625671e+02
  1.35001098e+03  5.83639859e+03  3.50988894e+04]
E1 = -182.5939852137877  E_coul = 54.05628056788433
Extra cycle  E= -128.537704645903  delta_E= 1.71e-13  |g|= 2.26e-07  |ddm|= 1.89e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209757e+03 6.17485615e+02 1.74999985e+02
 2.06124464e+01 5.68594488e+01 4.88069429e-01 7.92295100e+00
 1.65526176e+00 7.08809594e+00 2.30405660e+01 9.89304580e+01
 2.66047088e-01 2.43300903e+00 8.31165073e-01]
grad_E = [-2.30776068e-09  1.19296106e-07 -2.18959007e-06  2.03080338e-05
  1.10635761e-04 -8.83973082e-05  4.69661225e-05  8.70338656e-05
 -9.54058509e-06  1.39697416e-05 -1.78294719e-06 -8.57636508e-07
 -4.11205982e-05 -2.99645149e-05  4.11825664e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787145        1
[INPUT] 0    0    [1    /1   ]  2712.09757279        1
[INPUT] 0    0    [1    /1   ]  617.485640822        1
[INPUT] 0    0    [1    /1   ]  174.999784683        1
[INPUT] 0    0    [1    /1   ]  20.6118785833        1
[INPUT] 0    0    [1    /1   ]  56.8598403499        1
[INPUT] 0    0    [1    /1   ]  0.488060784151       1
[INPUT] 0    0    [1    /1   ]  7.92284533803        1
[INPUT] 0    0    [1    /1   ]  1.65521315557        1
[INPUT] 1    0    [1    /1   ]  7.08274265558        1
[INPUT] 1    0    [1    /1   ]  23.0244199028        1
[INPUT] 1    0    [1    /1   ]  98.8590173842        1
[INPUT] 1    0    [1    /1   ]  0.265942737724       1
[INPUT] 1    0    [1    /1   ]  2.43162305086        1
[INPUT] 1    0    [1    /1   ]  0.830768026918       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47871445133, 1.0]], [0, [2712.0975727855707, 1.0]], [0, [617.4856408218744, 1.0]], [0, [174.9997846832296, 1.0]], [0, [20.611878583348098, 1.0]], [0, [56.85984034985175, 1.0]], [0, [0.48806078415077103, 1.0]], [0, [7.922845338030512, 1.0]], [0, [1.6552131555683873, 1.0]], [1, [7.082742655580346, 1.0]], [1, [23.024419902837423, 1.0]], [1, [98.85901738423169, 1.0]], [1, [0.2659427377242974, 1.0]], [1, [2.431623050860041, 1.0]], [1, [0.8307680269176576, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871445]
bas 1, expnt(s) = [2712.09757279]
bas 2, expnt(s) = [617.48564082]
bas 3, expnt(s) = [174.99978468]
bas 4, expnt(s) = [20.61187858]
bas 5, expnt(s) = [56.85984035]
bas 6, expnt(s) = [0.48806078]
bas 7, expnt(s) = [7.92284534]
bas 8, expnt(s) = [1.65521316]
bas 9, expnt(s) = [7.08274266]
bas 10, expnt(s) = [23.0244199]
bas 11, expnt(s) = [98.85901738]
bas 12, expnt(s) = [0.26594274]
bas 13, expnt(s) = [2.43162305]
bas 14, expnt(s) = [0.83076803]
CPU time:       241.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209757e+03 9.49497896e+02
 6.17485641e+02 3.12957361e+02 1.74999785e+02 1.21560691e+02
 2.06118786e+01 2.44401128e+01 5.68598403e+01 5.23141594e+01
 4.88060784e-01 1.47526643e+00 7.92284534e+00 1.19309742e+01
 1.65521316e+00 3.68685002e+00 7.08274266e+00 3.37082511e+01
 2.30244199e+01 1.47136447e+02 9.88590174e+01 9.09399591e+02
 2.65942738e-01 5.57146699e-01 2.43162305e+00 8.85838817e+00
 8.30768027e-01 2.31384418e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999176728377106
cond(S) = 243.8231287277458
E1 = -183.58687636295002  E_coul = 55.08147241786828
init E= -128.505403945082
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775329526748874  LUMO = 0.822562324707411
  mo_energy =
[-3.25542412e+01 -1.85119773e+00 -7.75329527e-01 -7.75329527e-01
 -7.75329527e-01  8.22562325e-01  8.22562325e-01  8.22562325e-01
  2.06585252e+00  3.94215642e+00  3.94215642e+00  3.94215642e+00
  1.42932904e+01  1.42932904e+01  1.42932904e+01  1.96337276e+01
  5.26895519e+01  5.26895519e+01  5.26895519e+01  9.44340130e+01
  2.38687709e+02  2.38687709e+02  2.38687709e+02  3.56861041e+02
  1.35027847e+03  5.83669525e+03  3.50992069e+04]
E1 = -182.0910954225188  E_coul = 53.556889693708705
cycle= 1 E= -128.53420572881  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502919
diis-c [-0.25292748  1.        ]
  HOMO = -0.883305472013764  LUMO = 0.796391385462445
  mo_energy =
[-3.28767767e+01 -1.96461065e+00 -8.83305472e-01 -8.83305472e-01
 -8.83305472e-01  7.96391385e-01  7.96391385e-01  7.96391385e-01
  1.98858723e+00  3.84584226e+00  3.84584226e+00  3.84584226e+00
  1.41038754e+01  1.41038754e+01  1.41038754e+01  1.94112889e+01
  5.24097408e+01  5.24097408e+01  5.24097408e+01  9.41300021e+01
  2.38342470e+02  2.38342470e+02  2.38342470e+02  3.56509777e+02
  1.34988903e+03  5.83627395e+03  3.50987640e+04]
E1 = -182.84966760917726  E_coul = 54.31287199205544
cycle= 2 E= -128.536795617122  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.25392
diis-c [-6.06758682e-04  3.34714534e-01  6.65285466e-01]
  HOMO = -0.847757832822446  LUMO = 0.805053462654625
  mo_energy =
[-3.27688770e+01 -1.92708572e+00 -8.47757833e-01 -8.47757833e-01
 -8.47757833e-01  8.05053463e-01  8.05053463e-01  8.05053463e-01
  2.01392369e+00  3.87730436e+00  3.87730436e+00  3.87730436e+00
  1.41667962e+01  1.41667962e+01  1.41667962e+01  1.94857760e+01
  5.25034659e+01  5.25034659e+01  5.25034659e+01  9.42319332e+01
  2.38455839e+02  2.38455839e+02  2.38455839e+02  3.56624484e+02
  1.35000999e+03  5.83639786e+03  3.50988890e+04]
E1 = -182.59318939236024  E_coul = 54.05548471045309
cycle= 3 E= -128.537704681907  delta_E= -0.000909  |g|= 0.000467  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119437
diis-c [-1.05879240e-07 -2.15915029e-03  2.60561430e-04  1.00189859e+00]
  HOMO = -0.847980776465374  LUMO = 0.805027649467513
  mo_energy =
[-3.27693371e+01 -1.92725749e+00 -8.47980776e-01 -8.47980776e-01
 -8.47980776e-01  8.05027649e-01  8.05027649e-01  8.05027649e-01
  2.01383330e+00  3.87715687e+00  3.87715687e+00  3.87715687e+00
  1.41665176e+01  1.41665176e+01  1.41665176e+01  1.94854822e+01
  5.25030719e+01  5.25030719e+01  5.25030719e+01  9.42315034e+01
  2.38455303e+02  2.38455303e+02  2.38455303e+02  3.56623921e+02
  1.35000927e+03  5.83639703e+03  3.50988881e+04]
E1 = -182.5937907376537  E_coul = 54.056086038592994
cycle= 4 E= -128.537704699061  delta_E= -1.72e-08  |g|= 7.18e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186313
diis-c [-4.55017071e-10  1.29801843e-04  4.92474453e-04 -1.26119567e-01
  1.12549729e+00]
  HOMO = -0.848015438396626  LUMO = 0.805017467603012
  mo_energy =
[-3.27694075e+01 -1.92728693e+00 -8.48015438e-01 -8.48015438e-01
 -8.48015438e-01  8.05017468e-01  8.05017468e-01  8.05017468e-01
  2.01381035e+00  3.87712421e+00  3.87712421e+00  3.87712421e+00
  1.41664657e+01  1.41664657e+01  1.41664657e+01  1.94854280e+01
  5.25030074e+01  5.25030074e+01  5.25030074e+01  9.42314356e+01
  2.38455229e+02  2.38455229e+02  2.38455229e+02  3.56623844e+02
  1.35000919e+03  5.83639693e+03  3.50988880e+04]
E1 = -182.59394256408206  E_coul = 54.0562378645622
cycle= 5 E= -128.53770469952  delta_E= -4.59e-10  |g|= 2.66e-06  |ddm|= 1.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59394256408206  E_coul = 54.0562378645622
  HOMO = -0.848014352231932  LUMO = 0.805017781279581
  mo_energy =
[-3.27694050e+01 -1.92728533e+00 -8.48014352e-01 -8.48014352e-01
 -8.48014352e-01  8.05017781e-01  8.05017781e-01  8.05017781e-01
  2.01381154e+00  3.87712525e+00  3.87712525e+00  3.87712525e+00
  1.41664676e+01  1.41664676e+01  1.41664676e+01  1.94854303e+01
  5.25030098e+01  5.25030098e+01  5.25030098e+01  9.42314380e+01
  2.38455231e+02  2.38455231e+02  2.38455231e+02  3.56623846e+02
  1.35000919e+03  5.83639694e+03  3.50988880e+04]
E1 = -182.593936463481  E_coul = 54.056231763960184
Extra cycle  E= -128.537704699521  delta_E= -9.66e-13  |g|= 8.78e-07  |ddm|= 1.45e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209757e+03 6.17485641e+02 1.74999785e+02
 2.06118786e+01 5.68598403e+01 4.88060784e-01 7.92284534e+00
 1.65521316e+00 7.08274266e+00 2.30244199e+01 9.88590174e+01
 2.65942738e-01 2.43162305e+00 8.30768027e-01]
E = -128.53770469952082
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:34 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787145        1
[INPUT] 0    0    [1    /1   ]  2712.09757279        1
[INPUT] 0    0    [1    /1   ]  617.485640822        1
[INPUT] 0    0    [1    /1   ]  174.999784683        1
[INPUT] 0    0    [1    /1   ]  20.6118785833        1
[INPUT] 0    0    [1    /1   ]  56.8598403499        1
[INPUT] 0    0    [1    /1   ]  0.488060784151       1
[INPUT] 0    0    [1    /1   ]  7.92284533803        1
[INPUT] 0    0    [1    /1   ]  1.65521315557        1
[INPUT] 1    0    [1    /1   ]  7.08274265558        1
[INPUT] 1    0    [1    /1   ]  23.0244199028        1
[INPUT] 1    0    [1    /1   ]  98.8590173842        1
[INPUT] 1    0    [1    /1   ]  0.265942737724       1
[INPUT] 1    0    [1    /1   ]  2.43162305086        1
[INPUT] 1    0    [1    /1   ]  0.830768026918       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47871445133, 1.0]], [0, [2712.0975727855707, 1.0]], [0, [617.4856408218744, 1.0]], [0, [174.9997846832296, 1.0]], [0, [20.611878583348098, 1.0]], [0, [56.85984034985175, 1.0]], [0, [0.48806078415077103, 1.0]], [0, [7.922845338030512, 1.0]], [0, [1.6552131555683873, 1.0]], [1, [7.082742655580346, 1.0]], [1, [23.024419902837423, 1.0]], [1, [98.85901738423169, 1.0]], [1, [0.2659427377242974, 1.0]], [1, [2.431623050860041, 1.0]], [1, [0.8307680269176576, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871445]
bas 1, expnt(s) = [2712.09757279]
bas 2, expnt(s) = [617.48564082]
bas 3, expnt(s) = [174.99978468]
bas 4, expnt(s) = [20.61187858]
bas 5, expnt(s) = [56.85984035]
bas 6, expnt(s) = [0.48806078]
bas 7, expnt(s) = [7.92284534]
bas 8, expnt(s) = [1.65521316]
bas 9, expnt(s) = [7.08274266]
bas 10, expnt(s) = [23.0244199]
bas 11, expnt(s) = [98.85901738]
bas 12, expnt(s) = [0.26594274]
bas 13, expnt(s) = [2.43162305]
bas 14, expnt(s) = [0.83076803]
CPU time:       242.04
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209757e+03 9.49497896e+02
 6.17485641e+02 3.12957361e+02 1.74999785e+02 1.21560691e+02
 2.06118786e+01 2.44401128e+01 5.68598403e+01 5.23141594e+01
 4.88060784e-01 1.47526643e+00 7.92284534e+00 1.19309742e+01
 1.65521316e+00 3.68685002e+00 7.08274266e+00 3.37082511e+01
 2.30244199e+01 1.47136447e+02 9.88590174e+01 9.09399591e+02
 2.65942738e-01 5.57146699e-01 2.43162305e+00 8.85838817e+00
 8.30768027e-01 2.31384418e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999176728377106
cond(S) = 243.8231287277458
E1 = -183.58687636295002  E_coul = 55.08147241786828
init E= -128.505403945082
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775329526748874  LUMO = 0.822562324707411
  mo_energy =
[-3.25542412e+01 -1.85119773e+00 -7.75329527e-01 -7.75329527e-01
 -7.75329527e-01  8.22562325e-01  8.22562325e-01  8.22562325e-01
  2.06585252e+00  3.94215642e+00  3.94215642e+00  3.94215642e+00
  1.42932904e+01  1.42932904e+01  1.42932904e+01  1.96337276e+01
  5.26895519e+01  5.26895519e+01  5.26895519e+01  9.44340130e+01
  2.38687709e+02  2.38687709e+02  2.38687709e+02  3.56861041e+02
  1.35027847e+03  5.83669525e+03  3.50992069e+04]
E1 = -182.0910954225188  E_coul = 53.556889693708705
cycle= 1 E= -128.53420572881  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502919
diis-c [-0.25292748  1.        ]
  HOMO = -0.883305472013764  LUMO = 0.796391385462445
  mo_energy =
[-3.28767767e+01 -1.96461065e+00 -8.83305472e-01 -8.83305472e-01
 -8.83305472e-01  7.96391385e-01  7.96391385e-01  7.96391385e-01
  1.98858723e+00  3.84584226e+00  3.84584226e+00  3.84584226e+00
  1.41038754e+01  1.41038754e+01  1.41038754e+01  1.94112889e+01
  5.24097408e+01  5.24097408e+01  5.24097408e+01  9.41300021e+01
  2.38342470e+02  2.38342470e+02  2.38342470e+02  3.56509777e+02
  1.34988903e+03  5.83627395e+03  3.50987640e+04]
E1 = -182.84966760917726  E_coul = 54.31287199205544
cycle= 2 E= -128.536795617122  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.25392
diis-c [-6.06758682e-04  3.34714534e-01  6.65285466e-01]
  HOMO = -0.847757832822446  LUMO = 0.805053462654625
  mo_energy =
[-3.27688770e+01 -1.92708572e+00 -8.47757833e-01 -8.47757833e-01
 -8.47757833e-01  8.05053463e-01  8.05053463e-01  8.05053463e-01
  2.01392369e+00  3.87730436e+00  3.87730436e+00  3.87730436e+00
  1.41667962e+01  1.41667962e+01  1.41667962e+01  1.94857760e+01
  5.25034659e+01  5.25034659e+01  5.25034659e+01  9.42319332e+01
  2.38455839e+02  2.38455839e+02  2.38455839e+02  3.56624484e+02
  1.35000999e+03  5.83639786e+03  3.50988890e+04]
E1 = -182.59318939236024  E_coul = 54.05548471045309
cycle= 3 E= -128.537704681907  delta_E= -0.000909  |g|= 0.000467  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119437
diis-c [-1.05879240e-07 -2.15915029e-03  2.60561430e-04  1.00189859e+00]
  HOMO = -0.847980776465374  LUMO = 0.805027649467513
  mo_energy =
[-3.27693371e+01 -1.92725749e+00 -8.47980776e-01 -8.47980776e-01
 -8.47980776e-01  8.05027649e-01  8.05027649e-01  8.05027649e-01
  2.01383330e+00  3.87715687e+00  3.87715687e+00  3.87715687e+00
  1.41665176e+01  1.41665176e+01  1.41665176e+01  1.94854822e+01
  5.25030719e+01  5.25030719e+01  5.25030719e+01  9.42315034e+01
  2.38455303e+02  2.38455303e+02  2.38455303e+02  3.56623921e+02
  1.35000927e+03  5.83639703e+03  3.50988881e+04]
E1 = -182.5937907376537  E_coul = 54.056086038592994
cycle= 4 E= -128.537704699061  delta_E= -1.72e-08  |g|= 7.18e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186313
diis-c [-4.55017071e-10  1.29801843e-04  4.92474453e-04 -1.26119567e-01
  1.12549729e+00]
  HOMO = -0.848015438396626  LUMO = 0.805017467603012
  mo_energy =
[-3.27694075e+01 -1.92728693e+00 -8.48015438e-01 -8.48015438e-01
 -8.48015438e-01  8.05017468e-01  8.05017468e-01  8.05017468e-01
  2.01381035e+00  3.87712421e+00  3.87712421e+00  3.87712421e+00
  1.41664657e+01  1.41664657e+01  1.41664657e+01  1.94854280e+01
  5.25030074e+01  5.25030074e+01  5.25030074e+01  9.42314356e+01
  2.38455229e+02  2.38455229e+02  2.38455229e+02  3.56623844e+02
  1.35000919e+03  5.83639693e+03  3.50988880e+04]
E1 = -182.59394256408206  E_coul = 54.0562378645622
cycle= 5 E= -128.53770469952  delta_E= -4.59e-10  |g|= 2.66e-06  |ddm|= 1.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59394256408206  E_coul = 54.0562378645622
  HOMO = -0.848014352231932  LUMO = 0.805017781279581
  mo_energy =
[-3.27694050e+01 -1.92728533e+00 -8.48014352e-01 -8.48014352e-01
 -8.48014352e-01  8.05017781e-01  8.05017781e-01  8.05017781e-01
  2.01381154e+00  3.87712525e+00  3.87712525e+00  3.87712525e+00
  1.41664676e+01  1.41664676e+01  1.41664676e+01  1.94854303e+01
  5.25030098e+01  5.25030098e+01  5.25030098e+01  9.42314380e+01
  2.38455231e+02  2.38455231e+02  2.38455231e+02  3.56623846e+02
  1.35000919e+03  5.83639694e+03  3.50988880e+04]
E1 = -182.593936463481  E_coul = 54.056231763960184
Extra cycle  E= -128.537704699521  delta_E= -9.66e-13  |g|= 8.78e-07  |ddm|= 1.45e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 243.8231287277458
E1 = -182.593936463481  E_coul = 54.056231763960184
init E= -128.537704699521
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.848014794425094  LUMO = 0.805017679934704
  mo_energy =
[-3.27694064e+01 -1.92728571e+00 -8.48014794e-01 -8.48014794e-01
 -8.48014794e-01  8.05017680e-01  8.05017680e-01  8.05017680e-01
  2.01381130e+00  3.87712487e+00  3.87712487e+00  3.87712487e+00
  1.41664668e+01  1.41664668e+01  1.41664668e+01  1.94854294e+01
  5.25030086e+01  5.25030086e+01  5.25030086e+01  9.42314367e+01
  2.38455229e+02  2.38455229e+02  2.38455229e+02  3.56623845e+02
  1.35000919e+03  5.83639693e+03  3.50988880e+04]
E1 = -182.59393982100556  E_coul = 54.05623512148512
cycle= 1 E= -128.53770469952  delta_E= 3.69e-13  |g|= 4.65e-07  |ddm|= 3.09e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59393982100556  E_coul = 54.05623512148512
  HOMO = -0.84801455970587  LUMO = 0.805017738638024
  mo_energy =
[-3.27694057e+01 -1.92728545e+00 -8.48014560e-01 -8.48014560e-01
 -8.48014560e-01  8.05017739e-01  8.05017739e-01  8.05017739e-01
  2.01381148e+00  3.87712508e+00  3.87712508e+00  3.87712508e+00
  1.41664672e+01  1.41664672e+01  1.41664672e+01  1.94854299e+01
  5.25030093e+01  5.25030093e+01  5.25030093e+01  9.42314374e+01
  2.38455230e+02  2.38455230e+02  2.38455230e+02  3.56623845e+02
  1.35000919e+03  5.83639693e+03  3.50988880e+04]
E1 = -182.59393815392022  E_coul = 54.056233454399994
Extra cycle  E= -128.53770469952  delta_E= 2.27e-13  |g|= 2.26e-07  |ddm|= 1.89e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [1.80764787e+04 2.71209757e+03 6.17485641e+02 1.74999785e+02
 2.06118786e+01 5.68598403e+01 4.88060784e-01 7.92284534e+00
 1.65521316e+00 7.08274266e+00 2.30244199e+01 9.88590174e+01
 2.65942738e-01 2.43162305e+00 8.30768027e-01]
grad_E = [-2.29479552e-09  1.18619900e-07 -2.17675521e-06  2.01755030e-05
  1.08713480e-04 -8.76666654e-05  5.25713012e-05  8.92598530e-05
 -1.37265379e-05 -1.66207343e-06  2.94630079e-07 -9.53119955e-07
 -4.89531426e-05  4.99787491e-06  5.85804375e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787145        1
[INPUT] 0    0    [1    /1   ]  2712.0975704         1
[INPUT] 0    0    [1    /1   ]  617.485682766        1
[INPUT] 0    0    [1    /1   ]  174.999451085        1
[INPUT] 0    0    [1    /1   ]  20.6108695906        1
[INPUT] 0    0    [1    /1   ]  56.8606507741        1
[INPUT] 0    0    [1    /1   ]  0.488023243792       1
[INPUT] 0    0    [1    /1   ]  7.92210786536        1
[INPUT] 0    0    [1    /1   ]  1.65513845578        1
[INPUT] 1    0    [1    /1   ]  7.07454755898        1
[INPUT] 1    0    [1    /1   ]  23.0026404606        1
[INPUT] 1    0    [1    /1   ]  98.7661264205        1
[INPUT] 1    0    [1    /1   ]  0.265791869371       1
[INPUT] 1    0    [1    /1   ]  2.42950805652        1
[INPUT] 1    0    [1    /1   ]  0.83016570044        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47871449965, 1.0]], [0, [2712.0975703996733, 1.0]], [0, [617.4856827661064, 1.0]], [0, [174.99945108523224, 1.0]], [0, [20.61086959063103, 1.0]], [0, [56.86065077406818, 1.0]], [0, [0.4880232437916947, 1.0]], [0, [7.922107865362293, 1.0]], [0, [1.6551384557824682, 1.0]], [1, [7.074547558980954, 1.0]], [1, [23.00264046061865, 1.0]], [1, [98.76612642053949, 1.0]], [1, [0.26579186937050936, 1.0]], [1, [2.4295080565194827, 1.0]], [1, [0.8301657004404841, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.4787145]
bas 1, expnt(s) = [2712.0975704]
bas 2, expnt(s) = [617.48568277]
bas 3, expnt(s) = [174.99945109]
bas 4, expnt(s) = [20.61086959]
bas 5, expnt(s) = [56.86065077]
bas 6, expnt(s) = [0.48802324]
bas 7, expnt(s) = [7.92210787]
bas 8, expnt(s) = [1.65513846]
bas 9, expnt(s) = [7.07454756]
bas 10, expnt(s) = [23.00264046]
bas 11, expnt(s) = [98.76612642]
bas 12, expnt(s) = [0.26579187]
bas 13, expnt(s) = [2.42950806]
bas 14, expnt(s) = [0.8301657]
CPU time:       245.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209757e+03 9.49497895e+02
 6.17485683e+02 3.12957377e+02 1.74999451e+02 1.21560517e+02
 2.06108696e+01 2.44392155e+01 5.68606508e+01 5.23147186e+01
 4.88023244e-01 1.47518132e+00 7.92210787e+00 1.19301413e+01
 1.65513846e+00 3.68672523e+00 7.07454756e+00 3.36595054e+01
 2.30026405e+01 1.46962492e+02 9.87661264e+01 9.08331591e+02
 2.65791869e-01 5.56751643e-01 2.42950806e+00 8.84875808e+00
 8.30165700e-01 2.31174738e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999178137989258
cond(S) = 243.78431949937303
E1 = -183.58687687739462  E_coul = 55.08147300706237
init E= -128.505403870332
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775329579311996  LUMO = 0.821939482788508
  mo_energy =
[-3.25542413e+01 -1.85119764e+00 -7.75329579e-01 -7.75329579e-01
 -7.75329579e-01  8.21939483e-01  8.21939483e-01  8.21939483e-01
  2.06564368e+00  3.93887632e+00  3.93887632e+00  3.93887632e+00
  1.42780952e+01  1.42780952e+01  1.42780952e+01  1.96318122e+01
  5.26291542e+01  5.26291542e+01  5.26291542e+01  9.44292918e+01
  2.38431167e+02  2.38431167e+02  2.38431167e+02  3.56855969e+02
  1.35027378e+03  5.83669102e+03  3.50992034e+04]
E1 = -182.09096364251934  E_coul = 53.556758358761904
cycle= 1 E= -128.534205283757  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502995
diis-c [-0.25300424  1.        ]
  HOMO = -0.883315917403342  LUMO = 0.795792375660999
  mo_energy =
[-3.28768006e+01 -1.96462130e+00 -8.83315917e-01 -8.83315917e-01
 -8.83315917e-01  7.95792376e-01  7.95792376e-01  7.95792376e-01
  1.98837574e+00  3.84262086e+00  3.84262086e+00  3.84262086e+00
  1.40887630e+01  1.40887630e+01  1.40887630e+01  1.94093621e+01
  5.23493833e+01  5.23493833e+01  5.23493833e+01  9.41252599e+01
  2.38085934e+02  2.38085934e+02  2.38085934e+02  3.56504680e+02
  1.34988431e+03  5.83626969e+03  3.50987604e+04]
E1 = -182.84962192805366  E_coul = 54.31282639313353
cycle= 2 E= -128.53679553492  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253968
diis-c [-6.06747846e-04  3.34723112e-01  6.65276888e-01]
  HOMO = -0.847764491312162  LUMO = 0.804446805622873
  mo_energy =
[-3.27688910e+01 -1.92709230e+00 -8.47764491e-01 -8.47764491e-01
 -8.47764491e-01  8.04446806e-01  8.04446806e-01  8.04446806e-01
  2.01371333e+00  3.87406375e+00  3.87406375e+00  3.87406375e+00
  1.41516565e+01  1.41516565e+01  1.41516565e+01  1.94838542e+01
  5.24430967e+01  5.24430967e+01  5.24430967e+01  9.42272001e+01
  2.38199306e+02  2.38199306e+02  2.38199306e+02  3.56619397e+02
  1.35000528e+03  5.83639361e+03  3.50988855e+04]
E1 = -182.59311028289326  E_coul = 54.05540547313855
cycle= 3 E= -128.537704809755  delta_E= -0.000909  |g|= 0.000467  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011941
diis-c [-1.05939237e-07 -2.15841078e-03  2.60105766e-04  1.00189831e+00]
  HOMO = -0.847987350138639  LUMO = 0.804421070353247
  mo_energy =
[-3.27693509e+01 -1.92726390e+00 -8.47987350e-01 -8.47987350e-01
 -8.47987350e-01  8.04421070e-01  8.04421070e-01  8.04421070e-01
  2.01362308e+00  3.87391646e+00  3.87391646e+00  3.87391646e+00
  1.41513782e+01  1.41513782e+01  1.41513782e+01  1.94835606e+01
  5.24427031e+01  5.24427031e+01  5.24427031e+01  9.42267706e+01
  2.38198770e+02  2.38198770e+02  2.38198770e+02  3.56618834e+02
  1.35000457e+03  5.83639277e+03  3.50988846e+04]
E1 = -182.59371115200048  E_coul = 54.0560063251003
cycle= 4 E= -128.5377048269  delta_E= -1.71e-08  |g|= 7.18e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186413
diis-c [-4.55905131e-10  1.29923685e-04  4.92778096e-04 -1.26236490e-01
  1.12561379e+00]
  HOMO = -0.848022020237229  LUMO = 0.804410896335109
  mo_energy =
[-3.27694212e+01 -1.92729334e+00 -8.48022020e-01 -8.48022020e-01
 -8.48022020e-01  8.04410896e-01  8.04410896e-01  8.04410896e-01
  2.01360014e+00  3.87388382e+00  3.87388382e+00  3.87388382e+00
  1.41513263e+01  1.41513263e+01  1.41513263e+01  1.94835064e+01
  5.24426385e+01  5.24426385e+01  5.24426385e+01  9.42267027e+01
  2.38198696e+02  2.38198696e+02  2.38198696e+02  3.56618758e+02
  1.35000448e+03  5.83639268e+03  3.50988845e+04]
E1 = -182.59386304472403  E_coul = 54.0561582173644
cycle= 5 E= -128.53770482736  delta_E= -4.59e-10  |g|= 2.67e-06  |ddm|= 1.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59386304472403  E_coul = 54.0561582173644
  HOMO = -0.84802093168953  LUMO = 0.804411210437072
  mo_energy =
[-3.27694188e+01 -1.92729174e+00 -8.48020932e-01 -8.48020932e-01
 -8.48020932e-01  8.04411210e-01  8.04411210e-01  8.04411210e-01
  2.01360133e+00  3.87388486e+00  3.87388486e+00  3.87388486e+00
  1.41513281e+01  1.41513281e+01  1.41513281e+01  1.94835087e+01
  5.24426409e+01  5.24426409e+01  5.24426409e+01  9.42267051e+01
  2.38198698e+02  2.38198698e+02  2.38198698e+02  3.56618760e+02
  1.35000449e+03  5.83639268e+03  3.50988845e+04]
E1 = -182.59385693494482  E_coul = 54.056152107584055
Extra cycle  E= -128.537704827361  delta_E= -1.14e-12  |g|= 8.79e-07  |ddm|= 1.45e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209757e+03 6.17485683e+02 1.74999451e+02
 2.06108696e+01 5.68606508e+01 4.88023244e-01 7.92210787e+00
 1.65513846e+00 7.07454756e+00 2.30026405e+01 9.87661264e+01
 2.65791869e-01 2.42950806e+00 8.30165700e-01]
E = -128.53770482736076
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787145        1
[INPUT] 0    0    [1    /1   ]  2712.0975704         1
[INPUT] 0    0    [1    /1   ]  617.485682766        1
[INPUT] 0    0    [1    /1   ]  174.999451085        1
[INPUT] 0    0    [1    /1   ]  20.6108695906        1
[INPUT] 0    0    [1    /1   ]  56.8606507741        1
[INPUT] 0    0    [1    /1   ]  0.488023243792       1
[INPUT] 0    0    [1    /1   ]  7.92210786536        1
[INPUT] 0    0    [1    /1   ]  1.65513845578        1
[INPUT] 1    0    [1    /1   ]  7.07454755898        1
[INPUT] 1    0    [1    /1   ]  23.0026404606        1
[INPUT] 1    0    [1    /1   ]  98.7661264205        1
[INPUT] 1    0    [1    /1   ]  0.265791869371       1
[INPUT] 1    0    [1    /1   ]  2.42950805652        1
[INPUT] 1    0    [1    /1   ]  0.83016570044        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47871449965, 1.0]], [0, [2712.0975703996733, 1.0]], [0, [617.4856827661064, 1.0]], [0, [174.99945108523224, 1.0]], [0, [20.61086959063103, 1.0]], [0, [56.86065077406818, 1.0]], [0, [0.4880232437916947, 1.0]], [0, [7.922107865362293, 1.0]], [0, [1.6551384557824682, 1.0]], [1, [7.074547558980954, 1.0]], [1, [23.00264046061865, 1.0]], [1, [98.76612642053949, 1.0]], [1, [0.26579186937050936, 1.0]], [1, [2.4295080565194827, 1.0]], [1, [0.8301657004404841, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.4787145]
bas 1, expnt(s) = [2712.0975704]
bas 2, expnt(s) = [617.48568277]
bas 3, expnt(s) = [174.99945109]
bas 4, expnt(s) = [20.61086959]
bas 5, expnt(s) = [56.86065077]
bas 6, expnt(s) = [0.48802324]
bas 7, expnt(s) = [7.92210787]
bas 8, expnt(s) = [1.65513846]
bas 9, expnt(s) = [7.07454756]
bas 10, expnt(s) = [23.00264046]
bas 11, expnt(s) = [98.76612642]
bas 12, expnt(s) = [0.26579187]
bas 13, expnt(s) = [2.42950806]
bas 14, expnt(s) = [0.8301657]
CPU time:       246.42
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209757e+03 9.49497895e+02
 6.17485683e+02 3.12957377e+02 1.74999451e+02 1.21560517e+02
 2.06108696e+01 2.44392155e+01 5.68606508e+01 5.23147186e+01
 4.88023244e-01 1.47518132e+00 7.92210787e+00 1.19301413e+01
 1.65513846e+00 3.68672523e+00 7.07454756e+00 3.36595054e+01
 2.30026405e+01 1.46962492e+02 9.87661264e+01 9.08331591e+02
 2.65791869e-01 5.56751643e-01 2.42950806e+00 8.84875808e+00
 8.30165700e-01 2.31174738e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999178137989258
cond(S) = 243.78431949937303
E1 = -183.58687687739462  E_coul = 55.08147300706237
init E= -128.505403870332
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775329579311996  LUMO = 0.821939482788508
  mo_energy =
[-3.25542413e+01 -1.85119764e+00 -7.75329579e-01 -7.75329579e-01
 -7.75329579e-01  8.21939483e-01  8.21939483e-01  8.21939483e-01
  2.06564368e+00  3.93887632e+00  3.93887632e+00  3.93887632e+00
  1.42780952e+01  1.42780952e+01  1.42780952e+01  1.96318122e+01
  5.26291542e+01  5.26291542e+01  5.26291542e+01  9.44292918e+01
  2.38431167e+02  2.38431167e+02  2.38431167e+02  3.56855969e+02
  1.35027378e+03  5.83669102e+03  3.50992034e+04]
E1 = -182.09096364251934  E_coul = 53.556758358761904
cycle= 1 E= -128.534205283757  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502995
diis-c [-0.25300424  1.        ]
  HOMO = -0.883315917403342  LUMO = 0.795792375660999
  mo_energy =
[-3.28768006e+01 -1.96462130e+00 -8.83315917e-01 -8.83315917e-01
 -8.83315917e-01  7.95792376e-01  7.95792376e-01  7.95792376e-01
  1.98837574e+00  3.84262086e+00  3.84262086e+00  3.84262086e+00
  1.40887630e+01  1.40887630e+01  1.40887630e+01  1.94093621e+01
  5.23493833e+01  5.23493833e+01  5.23493833e+01  9.41252599e+01
  2.38085934e+02  2.38085934e+02  2.38085934e+02  3.56504680e+02
  1.34988431e+03  5.83626969e+03  3.50987604e+04]
E1 = -182.84962192805366  E_coul = 54.31282639313353
cycle= 2 E= -128.53679553492  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253968
diis-c [-6.06747846e-04  3.34723112e-01  6.65276888e-01]
  HOMO = -0.847764491312162  LUMO = 0.804446805622873
  mo_energy =
[-3.27688910e+01 -1.92709230e+00 -8.47764491e-01 -8.47764491e-01
 -8.47764491e-01  8.04446806e-01  8.04446806e-01  8.04446806e-01
  2.01371333e+00  3.87406375e+00  3.87406375e+00  3.87406375e+00
  1.41516565e+01  1.41516565e+01  1.41516565e+01  1.94838542e+01
  5.24430967e+01  5.24430967e+01  5.24430967e+01  9.42272001e+01
  2.38199306e+02  2.38199306e+02  2.38199306e+02  3.56619397e+02
  1.35000528e+03  5.83639361e+03  3.50988855e+04]
E1 = -182.59311028289326  E_coul = 54.05540547313855
cycle= 3 E= -128.537704809755  delta_E= -0.000909  |g|= 0.000467  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0011941
diis-c [-1.05939237e-07 -2.15841078e-03  2.60105766e-04  1.00189831e+00]
  HOMO = -0.847987350138639  LUMO = 0.804421070353247
  mo_energy =
[-3.27693509e+01 -1.92726390e+00 -8.47987350e-01 -8.47987350e-01
 -8.47987350e-01  8.04421070e-01  8.04421070e-01  8.04421070e-01
  2.01362308e+00  3.87391646e+00  3.87391646e+00  3.87391646e+00
  1.41513782e+01  1.41513782e+01  1.41513782e+01  1.94835606e+01
  5.24427031e+01  5.24427031e+01  5.24427031e+01  9.42267706e+01
  2.38198770e+02  2.38198770e+02  2.38198770e+02  3.56618834e+02
  1.35000457e+03  5.83639277e+03  3.50988846e+04]
E1 = -182.59371115200048  E_coul = 54.0560063251003
cycle= 4 E= -128.5377048269  delta_E= -1.71e-08  |g|= 7.18e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186413
diis-c [-4.55905131e-10  1.29923685e-04  4.92778096e-04 -1.26236490e-01
  1.12561379e+00]
  HOMO = -0.848022020237229  LUMO = 0.804410896335109
  mo_energy =
[-3.27694212e+01 -1.92729334e+00 -8.48022020e-01 -8.48022020e-01
 -8.48022020e-01  8.04410896e-01  8.04410896e-01  8.04410896e-01
  2.01360014e+00  3.87388382e+00  3.87388382e+00  3.87388382e+00
  1.41513263e+01  1.41513263e+01  1.41513263e+01  1.94835064e+01
  5.24426385e+01  5.24426385e+01  5.24426385e+01  9.42267027e+01
  2.38198696e+02  2.38198696e+02  2.38198696e+02  3.56618758e+02
  1.35000448e+03  5.83639268e+03  3.50988845e+04]
E1 = -182.59386304472403  E_coul = 54.0561582173644
cycle= 5 E= -128.53770482736  delta_E= -4.59e-10  |g|= 2.67e-06  |ddm|= 1.67e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59386304472403  E_coul = 54.0561582173644
  HOMO = -0.84802093168953  LUMO = 0.804411210437072
  mo_energy =
[-3.27694188e+01 -1.92729174e+00 -8.48020932e-01 -8.48020932e-01
 -8.48020932e-01  8.04411210e-01  8.04411210e-01  8.04411210e-01
  2.01360133e+00  3.87388486e+00  3.87388486e+00  3.87388486e+00
  1.41513281e+01  1.41513281e+01  1.41513281e+01  1.94835087e+01
  5.24426409e+01  5.24426409e+01  5.24426409e+01  9.42267051e+01
  2.38198698e+02  2.38198698e+02  2.38198698e+02  3.56618760e+02
  1.35000449e+03  5.83639268e+03  3.50988845e+04]
E1 = -182.59385693494482  E_coul = 54.056152107584055
Extra cycle  E= -128.537704827361  delta_E= -1.14e-12  |g|= 8.79e-07  |ddm|= 1.45e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 243.78431949937303
E1 = -182.59385693494482  E_coul = 54.056152107584055
init E= -128.537704827361
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.848021374528552  LUMO = 0.804411109060853
  mo_energy =
[-3.27694201e+01 -1.92729212e+00 -8.48021375e-01 -8.48021375e-01
 -8.48021375e-01  8.04411109e-01  8.04411109e-01  8.04411109e-01
  2.01360109e+00  3.87388448e+00  3.87388448e+00  3.87388448e+00
  1.41513274e+01  1.41513274e+01  1.41513274e+01  1.94835078e+01
  5.24426398e+01  5.24426398e+01  5.24426398e+01  9.42267038e+01
  2.38198696e+02  2.38198696e+02  2.38198696e+02  3.56618758e+02
  1.35000448e+03  5.83639268e+03  3.50988845e+04]
E1 = -182.5938602981177  E_coul = 54.0561554707572
cycle= 1 E= -128.53770482736  delta_E= 2.56e-13  |g|= 4.66e-07  |ddm|= 3.1e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5938602981177  E_coul = 54.0561554707572
  HOMO = -0.84802113941029  LUMO = 0.80441116780824
  mo_energy =
[-3.27694194e+01 -1.92729185e+00 -8.48021139e-01 -8.48021139e-01
 -8.48021139e-01  8.04411168e-01  8.04411168e-01  8.04411168e-01
  2.01360127e+00  3.87388469e+00  3.87388469e+00  3.87388469e+00
  1.41513278e+01  1.41513278e+01  1.41513278e+01  1.94835083e+01
  5.24426404e+01  5.24426404e+01  5.24426404e+01  9.42267045e+01
  2.38198697e+02  2.38198697e+02  2.38198697e+02  3.56618759e+02
  1.35000448e+03  5.83639268e+03  3.50988845e+04]
E1 = -182.59385862824277  E_coul = 54.05615380088249
Extra cycle  E= -128.53770482736  delta_E= 2.27e-13  |g|= 2.26e-07  |ddm|= 1.89e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.29 sec
exp = [1.80764787e+04 2.71209757e+03 6.17485683e+02 1.74999451e+02
 2.06108696e+01 5.68606508e+01 4.88023244e-01 7.92210787e+00
 1.65513846e+00 7.07454756e+00 2.30026405e+01 9.87661264e+01
 2.65791869e-01 2.42950806e+00 8.30165700e-01]
grad_E = [-2.27791286e-09  1.17742517e-07 -2.16041028e-06  2.00170811e-05
  1.07624079e-04 -8.69441181e-05  1.63662118e-05  8.91719367e-05
 -8.98124145e-06 -3.25510875e-05  4.75260561e-06 -1.14074191e-06
 -2.16498743e-05  7.41104909e-05 -7.55439728e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787146        1
[INPUT] 0    0    [1    /1   ]  2712.09756724        1
[INPUT] 0    0    [1    /1   ]  617.485739028        1
[INPUT] 0    0    [1    /1   ]  174.998981883        1
[INPUT] 0    0    [1    /1   ]  20.6092198115        1
[INPUT] 0    0    [1    /1   ]  56.8620791208        1
[INPUT] 0    0    [1    /1   ]  0.487960349294       1
[INPUT] 0    0    [1    /1   ]  7.92037763413        1
[INPUT] 0    0    [1    /1   ]  1.65506652031        1
[INPUT] 1    0    [1    /1   ]  7.06584898538        1
[INPUT] 1    0    [1    /1   ]  22.9819678105        1
[INPUT] 1    0    [1    /1   ]  98.6806105487        1
[INPUT] 1    0    [1    /1   ]  0.26564162743        1
[INPUT] 1    0    [1    /1   ]  2.42727463721        1
[INPUT] 1    0    [1    /1   ]  0.829536996806       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478714562818, 1.0]], [0, [2712.097567238056, 1.0]], [0, [617.4857390278962, 1.0]], [0, [174.99898188306446, 1.0]], [0, [20.609219811482788, 1.0]], [0, [56.862079120834046, 1.0]], [0, [0.4879603492936079, 1.0]], [0, [7.920377634131332, 1.0]], [0, [1.6550665203078256, 1.0]], [1, [7.0658489853806845, 1.0]], [1, [22.981967810525454, 1.0]], [1, [98.68061054866372, 1.0]], [1, [0.26564162742981445, 1.0]], [1, [2.4272746372098055, 1.0]], [1, [0.8295369968061544, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871456]
bas 1, expnt(s) = [2712.09756724]
bas 2, expnt(s) = [617.48573903]
bas 3, expnt(s) = [174.99898188]
bas 4, expnt(s) = [20.60921981]
bas 5, expnt(s) = [56.86207912]
bas 6, expnt(s) = [0.48796035]
bas 7, expnt(s) = [7.92037763]
bas 8, expnt(s) = [1.65506652]
bas 9, expnt(s) = [7.06584899]
bas 10, expnt(s) = [22.98196781]
bas 11, expnt(s) = [98.68061055]
bas 12, expnt(s) = [0.26564163]
bas 13, expnt(s) = [2.42727464]
bas 14, expnt(s) = [0.829537]
CPU time:       249.94
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209757e+03 9.49497895e+02
 6.17485739e+02 3.12957399e+02 1.74998982e+02 1.21560273e+02
 2.06092198e+01 2.44377483e+01 5.68620791e+01 5.23157042e+01
 4.87960349e-01 1.47503873e+00 7.92037763e+00 1.19281870e+01
 1.65506652e+00 3.68660506e+00 7.06584899e+00 3.36077805e+01
 2.29819678e+01 1.46797415e+02 9.86806105e+01 9.07348608e+02
 2.65641627e-01 5.56358283e-01 2.42727464e+00 8.83859105e+00
 8.29536997e-01 2.30955917e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999179605515243
cond(S) = 243.70433042123753
E1 = -183.58688027145692  E_coul = 55.08147454838338
init E= -128.505405723074
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775329644085052  LUMO = 0.821308024388326
  mo_energy =
[-3.25542413e+01 -1.85119730e+00 -7.75329644e-01 -7.75329644e-01
 -7.75329644e-01  8.21308024e-01  8.21308024e-01  8.21308024e-01
  2.06533199e+00  3.93547611e+00  3.93547611e+00  3.93547611e+00
  1.42620799e+01  1.42620799e+01  1.42620799e+01  1.96280696e+01
  5.25681814e+01  5.25681814e+01  5.25681814e+01  9.44199975e+01
  2.38188627e+02  2.38188627e+02  2.38188627e+02  3.56846159e+02
  1.35026496e+03  5.83668316e+03  3.50991969e+04]
E1 = -182.09080860803513  E_coul = 53.556603779888
cycle= 1 E= -128.534204828147  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503078
diis-c [-0.25308768  1.        ]
  HOMO = -0.883328500816674  LUMO = 0.795185191044774
  mo_energy =
[-3.28768290e+01 -1.96463277e+00 -8.83328501e-01 -8.83328501e-01
 -8.83328501e-01  7.95185191e-01  7.95185191e-01  7.95185191e-01
  1.98806354e+00  3.83928111e+00  3.83928111e+00  3.83928111e+00
  1.40728330e+01  1.40728330e+01  1.40728330e+01  1.94056119e+01
  5.22884446e+01  5.22884446e+01  5.22884446e+01  9.41159414e+01
  2.37843391e+02  2.37843391e+02  2.37843391e+02  3.56494840e+02
  1.34987546e+03  5.83626180e+03  3.50987539e+04]
E1 = -182.84956786494038  E_coul = 54.31277233315795
cycle= 2 E= -128.536795531782  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254018
diis-c [-6.06726304e-04  3.34731266e-01  6.65268734e-01]
  HOMO = -0.847772562559535  LUMO = 0.803831937851035
  mo_energy =
[-3.27689073e+01 -1.92709890e+00 -8.47772563e-01 -8.47772563e-01
 -8.47772563e-01  8.03831938e-01  8.03831938e-01  8.03831938e-01
  2.01340192e+00  3.87070428e+00  3.87070428e+00  3.87070428e+00
  1.41356986e+01  1.41356986e+01  1.41356986e+01  1.94801080e+01
  5.23821488e+01  5.23821488e+01  5.23821488e+01  9.42178924e+01
  2.37956768e+02  2.37956768e+02  2.37956768e+02  3.56609570e+02
  1.34999645e+03  5.83638573e+03  3.50988790e+04]
E1 = -182.59301817308955  E_coul = 54.05531312212538
cycle= 3 E= -128.537705050964  delta_E= -0.00091  |g|= 0.000467  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119428
diis-c [-1.06137101e-07 -2.15768880e-03  2.61177623e-04  1.00189651e+00]
  HOMO = -0.84799531564771  LUMO = 0.803806306987473
  mo_energy =
[-3.27693669e+01 -1.92727022e+00 -8.47995316e-01 -8.47995316e-01
 -8.47995316e-01  8.03806307e-01  8.03806307e-01  8.03806307e-01
  2.01331192e+00  3.87055726e+00  3.87055726e+00  3.87055726e+00
  1.41354207e+01  1.41354207e+01  1.41354207e+01  1.94798146e+01
  5.23817555e+01  5.23817555e+01  5.23817555e+01  9.42174630e+01
  2.37956233e+02  2.37956233e+02  2.37956233e+02  3.56609007e+02
  1.34999573e+03  5.83638490e+03  3.50988781e+04]
E1 = -182.59361884103325  E_coul = 54.055913772921635
cycle= 4 E= -128.537705068112  delta_E= -1.71e-08  |g|= 7.19e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186664
diis-c [-4.57985815e-10  1.30366319e-04  4.93446932e-04 -1.26531059e-01
  1.12590725e+00]
  HOMO = -0.848030001685736  LUMO = 0.803796142106161
  mo_energy =
[-3.27694373e+01 -1.92729963e+00 -8.48030002e-01 -8.48030002e-01
 -8.48030002e-01  8.03796142e-01  8.03796142e-01  8.03796142e-01
  2.01328901e+00  3.87052463e+00  3.87052463e+00  3.87052463e+00
  1.41353687e+01  1.41353687e+01  1.41353687e+01  1.94797604e+01
  5.23816910e+01  5.23816910e+01  5.23816910e+01  9.42173951e+01
  2.37956158e+02  2.37956158e+02  2.37956158e+02  3.56608930e+02
  1.34999565e+03  5.83638481e+03  3.50988780e+04]
E1 = -182.59377093330136  E_coul = 54.05606586472876
cycle= 5 E= -128.537705068573  delta_E= -4.61e-10  |g|= 2.68e-06  |ddm|= 1.68e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59377093330136  E_coul = 54.05606586472876
  HOMO = -0.84802890606484  LUMO = 0.803796458222775
  mo_energy =
[-3.27694349e+01 -1.92729803e+00 -8.48028906e-01 -8.48028906e-01
 -8.48028906e-01  8.03796458e-01  8.03796458e-01  8.03796458e-01
  2.01329021e+00  3.87052568e+00  3.87052568e+00  3.87052568e+00
  1.41353706e+01  1.41353706e+01  1.41353706e+01  1.94797627e+01
  5.23816934e+01  5.23816934e+01  5.23816934e+01  9.42173975e+01
  2.37956161e+02  2.37956161e+02  2.37956161e+02  3.56608932e+02
  1.34999565e+03  5.83638481e+03  3.50988780e+04]
E1 = -182.59376480022416  E_coul = 54.05605973165116
Extra cycle  E= -128.537705068573  delta_E= -4.26e-13  |g|= 8.83e-07  |ddm|= 1.46e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209757e+03 6.17485739e+02 1.74998982e+02
 2.06092198e+01 5.68620791e+01 4.87960349e-01 7.92037763e+00
 1.65506652e+00 7.06584899e+00 2.29819678e+01 9.86806105e+01
 2.65641627e-01 2.42727464e+00 8.29536997e-01]
E = -128.53770506857302
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787146        1
[INPUT] 0    0    [1    /1   ]  2712.09756724        1
[INPUT] 0    0    [1    /1   ]  617.485739028        1
[INPUT] 0    0    [1    /1   ]  174.998981883        1
[INPUT] 0    0    [1    /1   ]  20.6092198115        1
[INPUT] 0    0    [1    /1   ]  56.8620791208        1
[INPUT] 0    0    [1    /1   ]  0.487960349294       1
[INPUT] 0    0    [1    /1   ]  7.92037763413        1
[INPUT] 0    0    [1    /1   ]  1.65506652031        1
[INPUT] 1    0    [1    /1   ]  7.06584898538        1
[INPUT] 1    0    [1    /1   ]  22.9819678105        1
[INPUT] 1    0    [1    /1   ]  98.6806105487        1
[INPUT] 1    0    [1    /1   ]  0.26564162743        1
[INPUT] 1    0    [1    /1   ]  2.42727463721        1
[INPUT] 1    0    [1    /1   ]  0.829536996806       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478714562818, 1.0]], [0, [2712.097567238056, 1.0]], [0, [617.4857390278962, 1.0]], [0, [174.99898188306446, 1.0]], [0, [20.609219811482788, 1.0]], [0, [56.862079120834046, 1.0]], [0, [0.4879603492936079, 1.0]], [0, [7.920377634131332, 1.0]], [0, [1.6550665203078256, 1.0]], [1, [7.0658489853806845, 1.0]], [1, [22.981967810525454, 1.0]], [1, [98.68061054866372, 1.0]], [1, [0.26564162742981445, 1.0]], [1, [2.4272746372098055, 1.0]], [1, [0.8295369968061544, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871456]
bas 1, expnt(s) = [2712.09756724]
bas 2, expnt(s) = [617.48573903]
bas 3, expnt(s) = [174.99898188]
bas 4, expnt(s) = [20.60921981]
bas 5, expnt(s) = [56.86207912]
bas 6, expnt(s) = [0.48796035]
bas 7, expnt(s) = [7.92037763]
bas 8, expnt(s) = [1.65506652]
bas 9, expnt(s) = [7.06584899]
bas 10, expnt(s) = [22.98196781]
bas 11, expnt(s) = [98.68061055]
bas 12, expnt(s) = [0.26564163]
bas 13, expnt(s) = [2.42727464]
bas 14, expnt(s) = [0.829537]
CPU time:       250.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209757e+03 9.49497895e+02
 6.17485739e+02 3.12957399e+02 1.74998982e+02 1.21560273e+02
 2.06092198e+01 2.44377483e+01 5.68620791e+01 5.23157042e+01
 4.87960349e-01 1.47503873e+00 7.92037763e+00 1.19281870e+01
 1.65506652e+00 3.68660506e+00 7.06584899e+00 3.36077805e+01
 2.29819678e+01 1.46797415e+02 9.86806105e+01 9.07348608e+02
 2.65641627e-01 5.56358283e-01 2.42727464e+00 8.83859105e+00
 8.29536997e-01 2.30955917e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999179605515243
cond(S) = 243.70433042123753
E1 = -183.58688027145692  E_coul = 55.08147454838338
init E= -128.505405723074
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775329644085052  LUMO = 0.821308024388326
  mo_energy =
[-3.25542413e+01 -1.85119730e+00 -7.75329644e-01 -7.75329644e-01
 -7.75329644e-01  8.21308024e-01  8.21308024e-01  8.21308024e-01
  2.06533199e+00  3.93547611e+00  3.93547611e+00  3.93547611e+00
  1.42620799e+01  1.42620799e+01  1.42620799e+01  1.96280696e+01
  5.25681814e+01  5.25681814e+01  5.25681814e+01  9.44199975e+01
  2.38188627e+02  2.38188627e+02  2.38188627e+02  3.56846159e+02
  1.35026496e+03  5.83668316e+03  3.50991969e+04]
E1 = -182.09080860803513  E_coul = 53.556603779888
cycle= 1 E= -128.534204828147  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503078
diis-c [-0.25308768  1.        ]
  HOMO = -0.883328500816674  LUMO = 0.795185191044774
  mo_energy =
[-3.28768290e+01 -1.96463277e+00 -8.83328501e-01 -8.83328501e-01
 -8.83328501e-01  7.95185191e-01  7.95185191e-01  7.95185191e-01
  1.98806354e+00  3.83928111e+00  3.83928111e+00  3.83928111e+00
  1.40728330e+01  1.40728330e+01  1.40728330e+01  1.94056119e+01
  5.22884446e+01  5.22884446e+01  5.22884446e+01  9.41159414e+01
  2.37843391e+02  2.37843391e+02  2.37843391e+02  3.56494840e+02
  1.34987546e+03  5.83626180e+03  3.50987539e+04]
E1 = -182.84956786494038  E_coul = 54.31277233315795
cycle= 2 E= -128.536795531782  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254018
diis-c [-6.06726304e-04  3.34731266e-01  6.65268734e-01]
  HOMO = -0.847772562559535  LUMO = 0.803831937851035
  mo_energy =
[-3.27689073e+01 -1.92709890e+00 -8.47772563e-01 -8.47772563e-01
 -8.47772563e-01  8.03831938e-01  8.03831938e-01  8.03831938e-01
  2.01340192e+00  3.87070428e+00  3.87070428e+00  3.87070428e+00
  1.41356986e+01  1.41356986e+01  1.41356986e+01  1.94801080e+01
  5.23821488e+01  5.23821488e+01  5.23821488e+01  9.42178924e+01
  2.37956768e+02  2.37956768e+02  2.37956768e+02  3.56609570e+02
  1.34999645e+03  5.83638573e+03  3.50988790e+04]
E1 = -182.59301817308955  E_coul = 54.05531312212538
cycle= 3 E= -128.537705050964  delta_E= -0.00091  |g|= 0.000467  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119428
diis-c [-1.06137101e-07 -2.15768880e-03  2.61177623e-04  1.00189651e+00]
  HOMO = -0.84799531564771  LUMO = 0.803806306987473
  mo_energy =
[-3.27693669e+01 -1.92727022e+00 -8.47995316e-01 -8.47995316e-01
 -8.47995316e-01  8.03806307e-01  8.03806307e-01  8.03806307e-01
  2.01331192e+00  3.87055726e+00  3.87055726e+00  3.87055726e+00
  1.41354207e+01  1.41354207e+01  1.41354207e+01  1.94798146e+01
  5.23817555e+01  5.23817555e+01  5.23817555e+01  9.42174630e+01
  2.37956233e+02  2.37956233e+02  2.37956233e+02  3.56609007e+02
  1.34999573e+03  5.83638490e+03  3.50988781e+04]
E1 = -182.59361884103325  E_coul = 54.055913772921635
cycle= 4 E= -128.537705068112  delta_E= -1.71e-08  |g|= 7.19e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000186664
diis-c [-4.57985815e-10  1.30366319e-04  4.93446932e-04 -1.26531059e-01
  1.12590725e+00]
  HOMO = -0.848030001685736  LUMO = 0.803796142106161
  mo_energy =
[-3.27694373e+01 -1.92729963e+00 -8.48030002e-01 -8.48030002e-01
 -8.48030002e-01  8.03796142e-01  8.03796142e-01  8.03796142e-01
  2.01328901e+00  3.87052463e+00  3.87052463e+00  3.87052463e+00
  1.41353687e+01  1.41353687e+01  1.41353687e+01  1.94797604e+01
  5.23816910e+01  5.23816910e+01  5.23816910e+01  9.42173951e+01
  2.37956158e+02  2.37956158e+02  2.37956158e+02  3.56608930e+02
  1.34999565e+03  5.83638481e+03  3.50988780e+04]
E1 = -182.59377093330136  E_coul = 54.05606586472876
cycle= 5 E= -128.537705068573  delta_E= -4.61e-10  |g|= 2.68e-06  |ddm|= 1.68e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59377093330136  E_coul = 54.05606586472876
  HOMO = -0.84802890606484  LUMO = 0.803796458222775
  mo_energy =
[-3.27694349e+01 -1.92729803e+00 -8.48028906e-01 -8.48028906e-01
 -8.48028906e-01  8.03796458e-01  8.03796458e-01  8.03796458e-01
  2.01329021e+00  3.87052568e+00  3.87052568e+00  3.87052568e+00
  1.41353706e+01  1.41353706e+01  1.41353706e+01  1.94797627e+01
  5.23816934e+01  5.23816934e+01  5.23816934e+01  9.42173975e+01
  2.37956161e+02  2.37956161e+02  2.37956161e+02  3.56608932e+02
  1.34999565e+03  5.83638481e+03  3.50988780e+04]
E1 = -182.59376480022416  E_coul = 54.05605973165116
Extra cycle  E= -128.537705068573  delta_E= -4.26e-13  |g|= 8.83e-07  |ddm|= 1.46e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 243.70433042123753
E1 = -182.59376480022416  E_coul = 54.05605973165116
init E= -128.537705068573
    CPU time for initialize scf      0.25 sec, wall time      0.25 sec
  HOMO = -0.848029350519516  LUMO = 0.803796356646273
  mo_energy =
[-3.27694362e+01 -1.92729840e+00 -8.48029351e-01 -8.48029351e-01
 -8.48029351e-01  8.03796357e-01  8.03796357e-01  8.03796357e-01
  2.01328997e+00  3.87052529e+00  3.87052529e+00  3.87052529e+00
  1.41353698e+01  1.41353698e+01  1.41353698e+01  1.94797618e+01
  5.23816922e+01  5.23816922e+01  5.23816922e+01  9.42173963e+01
  2.37956159e+02  2.37956159e+02  2.37956159e+02  3.56608931e+02
  1.34999565e+03  5.83638481e+03  3.50988780e+04]
E1 = -182.5937681784943  E_coul = 54.056063109921226
cycle= 1 E= -128.537705068573  delta_E= -5.68e-14  |g|= 4.68e-07  |ddm|= 3.11e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5937681784943  E_coul = 54.056063109921226
  HOMO = -0.848029114336025  LUMO = 0.803796415608506
  mo_energy =
[-3.27694355e+01 -1.92729814e+00 -8.48029114e-01 -8.48029114e-01
 -8.48029114e-01  8.03796416e-01  8.03796416e-01  8.03796416e-01
  2.01329015e+00  3.87052550e+00  3.87052550e+00  3.87052550e+00
  1.41353702e+01  1.41353702e+01  1.41353702e+01  1.94797623e+01
  5.23816928e+01  5.23816928e+01  5.23816928e+01  9.42173969e+01
  2.37956160e+02  2.37956160e+02  2.37956160e+02  3.56608932e+02
  1.34999565e+03  5.83638481e+03  3.50988780e+04]
E1 = -182.59376650135448  E_coul = 54.05606143278126
Extra cycle  E= -128.537705068573  delta_E= -1.42e-13  |g|= 2.27e-07  |ddm|= 1.9e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209757e+03 6.17485739e+02 1.74998982e+02
 2.06092198e+01 5.68620791e+01 4.87960349e-01 7.92037763e+00
 1.65506652e+00 7.06584899e+00 2.29819678e+01 9.86806105e+01
 2.65641627e-01 2.42727464e+00 8.29536997e-01]
grad_E = [-2.25661779e-09  1.16639185e-07 -2.14022492e-06  1.98344629e-05
  1.08087997e-04 -8.63249707e-05 -6.64728160e-05  8.50757239e-05
  7.77298262e-06 -7.13581858e-05  1.06050055e-05 -1.37865577e-06
  4.14395520e-05  1.60451024e-04 -1.84190727e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787147        1
[INPUT] 0    0    [1    /1   ]  2712.09756087        1
[INPUT] 0    0    [1    /1   ]  617.485853698        1
[INPUT] 0    0    [1    /1   ]  174.997982401        1
[INPUT] 0    0    [1    /1   ]  20.6050595787        1
[INPUT] 0    0    [1    /1   ]  56.8656759355        1
[INPUT] 0    0    [1    /1   ]  0.487842513543       1
[INPUT] 0    0    [1    /1   ]  7.91594367766        1
[INPUT] 0    0    [1    /1   ]  1.65496956376        1
[INPUT] 1    0    [1    /1   ]  7.05383386857        1
[INPUT] 1    0    [1    /1   ]  22.9565369848        1
[INPUT] 1    0    [1    /1   ]  98.580097646         1
[INPUT] 1    0    [1    /1   ]  0.265444393799       1
[INPUT] 1    0    [1    /1   ]  2.42420642952        1
[INPUT] 1    0    [1    /1   ]  0.828678713644       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478714688335, 1.0]], [0, [2712.0975608721524, 1.0]], [0, [617.4858536980463, 1.0]], [0, [174.99798240054818, 1.0]], [0, [20.605059578733798, 1.0]], [0, [56.86567593548889, 1.0]], [0, [0.48784251354327995, 1.0]], [0, [7.915943677657072, 1.0]], [0, [1.6549695637592416, 1.0]], [1, [7.053833868571625, 1.0]], [1, [22.956536984812903, 1.0]], [1, [98.58009764598226, 1.0]], [1, [0.2654443937993406, 1.0]], [1, [2.424206429524644, 1.0]], [1, [0.8286787136440638, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871469]
bas 1, expnt(s) = [2712.09756087]
bas 2, expnt(s) = [617.4858537]
bas 3, expnt(s) = [174.9979824]
bas 4, expnt(s) = [20.60505958]
bas 5, expnt(s) = [56.86567594]
bas 6, expnt(s) = [0.48784251]
bas 7, expnt(s) = [7.91594368]
bas 8, expnt(s) = [1.65496956]
bas 9, expnt(s) = [7.05383387]
bas 10, expnt(s) = [22.95653698]
bas 11, expnt(s) = [98.58009765]
bas 12, expnt(s) = [0.26544439]
bas 13, expnt(s) = [2.42420643]
bas 14, expnt(s) = [0.82867871]
CPU time:       254.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209756e+03 9.49497893e+02
 6.17485854e+02 3.12957442e+02 1.74997982e+02 1.21559752e+02
 2.06050596e+01 2.44340484e+01 5.68656759e+01 5.23181861e+01
 4.87842514e-01 1.47477157e+00 7.91594368e+00 1.19231785e+01
 1.65496956e+00 3.68644308e+00 7.05383387e+00 3.35363603e+01
 2.29565370e+01 1.46594394e+02 9.85800976e+01 9.06193510e+02
 2.65444394e-01 5.55841974e-01 2.42420643e+00 8.82462768e+00
 8.28678714e-01 2.30657256e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999181626878205
cond(S) = 243.50672905877903
E1 = -183.5868868362315  E_coul = 55.081477010934464
init E= -128.505409825297
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775329794006961  LUMO = 0.820466188485391
  mo_energy =
[-3.25542416e+01 -1.85119654e+00 -7.75329794e-01 -7.75329794e-01
 -7.75329794e-01  8.20466188e-01  8.20466188e-01  8.20466188e-01
  2.06476004e+00  3.93086715e+00  3.93086715e+00  3.93086715e+00
  1.42400905e+01  1.42400905e+01  1.42400905e+01  1.96190464e+01
  5.24879592e+01  5.24879592e+01  5.24879592e+01  9.43968149e+01
  2.37893130e+02  2.37893130e+02  2.37893130e+02  3.56821736e+02
  1.35024334e+03  5.83666403e+03  3.50991811e+04]
E1 = -182.0905738343636  E_coul = 53.556369470396056
cycle= 1 E= -128.534204363968  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503195
diis-c [-0.25320568  1.        ]
  HOMO = -0.883347863219235  LUMO = 0.794375796141629
  mo_energy =
[-3.28768726e+01 -1.96464892e+00 -8.83347863e-01 -8.83347863e-01
 -8.83347863e-01  7.94375796e-01  7.94375796e-01  7.94375796e-01
  1.98749517e+00  3.83475334e+00  3.83475334e+00  3.83475334e+00
  1.40509583e+01  1.40509583e+01  1.40509583e+01  1.93965914e+01
  5.22082584e+01  5.22082584e+01  5.22082584e+01  9.40927238e+01
  2.37547878e+02  2.37547878e+02  2.37547878e+02  3.56470369e+02
  1.34985378e+03  5.83624262e+03  3.50987380e+04]
E1 = -182.84948519248357  E_coul = 54.31268941494456
cycle= 2 E= -128.536795777539  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.254089
diis-c [-6.06670022e-04  3.34741478e-01  6.65258522e-01]
  HOMO = -0.847785054388746  LUMO = 0.80301240782619
  mo_energy =
[-3.27689322e+01 -1.92710765e+00 -8.47785054e-01 -8.47785054e-01
 -8.47785054e-01  8.03012408e-01  8.03012408e-01  8.03012408e-01
  2.01283365e+00  3.86615013e+00  3.86615013e+00  3.86615013e+00
  1.41137866e+01  1.41137866e+01  1.41137866e+01  1.94710885e+01
  5.23019541e+01  5.23019541e+01  5.23019541e+01  9.41946906e+01
  2.37661268e+02  2.37661268e+02  2.37661268e+02  3.56585118e+02
  1.34997479e+03  5.83636657e+03  3.50988631e+04]
E1 = -182.59287934747923  E_coul = 54.055173684294374
cycle= 3 E= -128.537705663185  delta_E= -0.00091  |g|= 0.000467  |ddm|= 0.0254
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00119513
diis-c [-1.06581795e-07 -2.15677108e-03  2.64646864e-04  1.00189212e+00]
  HOMO = -0.848007646255151  LUMO = 0.802986947297129
  mo_energy =
[-3.27693914e+01 -1.92727844e+00 -8.48007646e-01 -8.48007646e-01
 -8.48007646e-01  8.02986947e-01  8.02986947e-01  8.02986947e-01
  2.01274414e+00  3.86600350e+00  3.86600350e+00  3.86600350e+00
  1.41135092e+01  1.41135092e+01  1.41135092e+01  1.94707955e+01
  5.23015613e+01  5.23015613e+01  5.23015613e+01  9.41942616e+01
  2.37660733e+02  2.37660733e+02  2.37660733e+02  3.56584556e+02
  1.34997408e+03  5.83636574e+03  3.50988622e+04]
E1 = -182.59348013410715  E_coul = 54.05577445375901
cycle= 4 E= -128.537705680348  delta_E= -1.72e-08  |g|= 7.2e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187189
diis-c [-4.62276509e-10  1.31359524e-04  4.94770257e-04 -1.27148406e-01
  1.12652228e+00]
  HOMO = -0.848042363326368  LUMO = 0.802976796105466
  mo_energy =
[-3.27694619e+01 -1.92730779e+00 -8.48042363e-01 -8.48042363e-01
 -8.48042363e-01  8.02976796e-01  8.02976796e-01  8.02976796e-01
  2.01272129e+00  3.86597088e+00  3.86597088e+00  3.86597088e+00
  1.41134573e+01  1.41134573e+01  1.41134573e+01  1.94707413e+01
  5.23014967e+01  5.23014967e+01  5.23014967e+01  9.41941936e+01
  2.37660658e+02  2.37660658e+02  2.37660658e+02  3.56584479e+02
  1.34997399e+03  5.83636565e+03  3.50988621e+04]
E1 = -182.59363266130532  E_coul = 54.05592698049374
cycle= 5 E= -128.537705680812  delta_E= -4.63e-10  |g|= 2.71e-06  |ddm|= 1.68e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59363266130532  E_coul = 54.05592698049374
  HOMO = -0.848041252200078  LUMO = 0.802977116947635
  mo_energy =
[-3.27694594e+01 -1.92730617e+00 -8.48041252e-01 -8.48041252e-01
 -8.48041252e-01  8.02977117e-01  8.02977117e-01  8.02977117e-01
  2.01272250e+00  3.86597194e+00  3.86597194e+00  3.86597194e+00
  1.41134592e+01  1.41134592e+01  1.41134592e+01  1.94707436e+01
  5.23014991e+01  5.23014991e+01  5.23014991e+01  9.41941961e+01
  2.37660660e+02  2.37660660e+02  2.37660660e+02  3.56584481e+02
  1.34997399e+03  5.83636565e+03  3.50988621e+04]
E1 = -182.59362647829454  E_coul = 54.05592079748242
Extra cycle  E= -128.537705680812  delta_E= -5.12e-13  |g|= 8.91e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209756e+03 6.17485854e+02 1.74997982e+02
 2.06050596e+01 5.68656759e+01 4.87842514e-01 7.91594368e+00
 1.65496956e+00 7.05383387e+00 2.29565370e+01 9.85800976e+01
 2.65444394e-01 2.42420643e+00 8.28678714e-01]
E = -128.5377056808121
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787147        1
[INPUT] 0    0    [1    /1   ]  2712.09756087        1
[INPUT] 0    0    [1    /1   ]  617.485853698        1
[INPUT] 0    0    [1    /1   ]  174.997982401        1
[INPUT] 0    0    [1    /1   ]  20.6050595787        1
[INPUT] 0    0    [1    /1   ]  56.8656759355        1
[INPUT] 0    0    [1    /1   ]  0.487842513543       1
[INPUT] 0    0    [1    /1   ]  7.91594367766        1
[INPUT] 0    0    [1    /1   ]  1.65496956376        1
[INPUT] 1    0    [1    /1   ]  7.05383386857        1
[INPUT] 1    0    [1    /1   ]  22.9565369848        1
[INPUT] 1    0    [1    /1   ]  98.580097646         1
[INPUT] 1    0    [1    /1   ]  0.265444393799       1
[INPUT] 1    0    [1    /1   ]  2.42420642952        1
[INPUT] 1    0    [1    /1   ]  0.828678713644       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478714688335, 1.0]], [0, [2712.0975608721524, 1.0]], [0, [617.4858536980463, 1.0]], [0, [174.99798240054818, 1.0]], [0, [20.605059578733798, 1.0]], [0, [56.86567593548889, 1.0]], [0, [0.48784251354327995, 1.0]], [0, [7.915943677657072, 1.0]], [0, [1.6549695637592416, 1.0]], [1, [7.053833868571625, 1.0]], [1, [22.956536984812903, 1.0]], [1, [98.58009764598226, 1.0]], [1, [0.2654443937993406, 1.0]], [1, [2.424206429524644, 1.0]], [1, [0.8286787136440638, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871469]
bas 1, expnt(s) = [2712.09756087]
bas 2, expnt(s) = [617.4858537]
bas 3, expnt(s) = [174.9979824]
bas 4, expnt(s) = [20.60505958]
bas 5, expnt(s) = [56.86567594]
bas 6, expnt(s) = [0.48784251]
bas 7, expnt(s) = [7.91594368]
bas 8, expnt(s) = [1.65496956]
bas 9, expnt(s) = [7.05383387]
bas 10, expnt(s) = [22.95653698]
bas 11, expnt(s) = [98.58009765]
bas 12, expnt(s) = [0.26544439]
bas 13, expnt(s) = [2.42420643]
bas 14, expnt(s) = [0.82867871]
CPU time:       255.32
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209756e+03 9.49497893e+02
 6.17485854e+02 3.12957442e+02 1.74997982e+02 1.21559752e+02
 2.06050596e+01 2.44340484e+01 5.68656759e+01 5.23181861e+01
 4.87842514e-01 1.47477157e+00 7.91594368e+00 1.19231785e+01
 1.65496956e+00 3.68644308e+00 7.05383387e+00 3.35363603e+01
 2.29565370e+01 1.46594394e+02 9.85800976e+01 9.06193510e+02
 2.65444394e-01 5.55841974e-01 2.42420643e+00 8.82462768e+00
 8.28678714e-01 2.30657256e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999181626878205
cond(S) = 243.50672905877903
E1 = -183.5868868362315  E_coul = 55.081477010934464
init E= -128.505409825297
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775329794006961  LUMO = 0.820466188485391
  mo_energy =
[-3.25542416e+01 -1.85119654e+00 -7.75329794e-01 -7.75329794e-01
 -7.75329794e-01  8.20466188e-01  8.20466188e-01  8.20466188e-01
  2.06476004e+00  3.93086715e+00  3.93086715e+00  3.93086715e+00
  1.42400905e+01  1.42400905e+01  1.42400905e+01  1.96190464e+01
  5.24879592e+01  5.24879592e+01  5.24879592e+01  9.43968149e+01
  2.37893130e+02  2.37893130e+02  2.37893130e+02  3.56821736e+02
  1.35024334e+03  5.83666403e+03  3.50991811e+04]
E1 = -182.0905738343636  E_coul = 53.556369470396056
cycle= 1 E= -128.534204363968  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503195
diis-c [-0.25320568  1.        ]
  HOMO = -0.883347863219235  LUMO = 0.794375796141629
  mo_energy =
[-3.28768726e+01 -1.96464892e+00 -8.83347863e-01 -8.83347863e-01
 -8.83347863e-01  7.94375796e-01  7.94375796e-01  7.94375796e-01
  1.98749517e+00  3.83475334e+00  3.83475334e+00  3.83475334e+00
  1.40509583e+01  1.40509583e+01  1.40509583e+01  1.93965914e+01
  5.22082584e+01  5.22082584e+01  5.22082584e+01  9.40927238e+01
  2.37547878e+02  2.37547878e+02  2.37547878e+02  3.56470369e+02
  1.34985378e+03  5.83624262e+03  3.50987380e+04]
E1 = -182.84948519248357  E_coul = 54.31268941494456
cycle= 2 E= -128.536795777539  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254089
diis-c [-6.06670022e-04  3.34741478e-01  6.65258522e-01]
  HOMO = -0.847785054388746  LUMO = 0.80301240782619
  mo_energy =
[-3.27689322e+01 -1.92710765e+00 -8.47785054e-01 -8.47785054e-01
 -8.47785054e-01  8.03012408e-01  8.03012408e-01  8.03012408e-01
  2.01283365e+00  3.86615013e+00  3.86615013e+00  3.86615013e+00
  1.41137866e+01  1.41137866e+01  1.41137866e+01  1.94710885e+01
  5.23019541e+01  5.23019541e+01  5.23019541e+01  9.41946906e+01
  2.37661268e+02  2.37661268e+02  2.37661268e+02  3.56585118e+02
  1.34997479e+03  5.83636657e+03  3.50988631e+04]
E1 = -182.59287934747923  E_coul = 54.055173684294374
cycle= 3 E= -128.537705663185  delta_E= -0.00091  |g|= 0.000467  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119513
diis-c [-1.06581795e-07 -2.15677108e-03  2.64646864e-04  1.00189212e+00]
  HOMO = -0.848007646255151  LUMO = 0.802986947297129
  mo_energy =
[-3.27693914e+01 -1.92727844e+00 -8.48007646e-01 -8.48007646e-01
 -8.48007646e-01  8.02986947e-01  8.02986947e-01  8.02986947e-01
  2.01274414e+00  3.86600350e+00  3.86600350e+00  3.86600350e+00
  1.41135092e+01  1.41135092e+01  1.41135092e+01  1.94707955e+01
  5.23015613e+01  5.23015613e+01  5.23015613e+01  9.41942616e+01
  2.37660733e+02  2.37660733e+02  2.37660733e+02  3.56584556e+02
  1.34997408e+03  5.83636574e+03  3.50988622e+04]
E1 = -182.59348013410715  E_coul = 54.05577445375901
cycle= 4 E= -128.537705680348  delta_E= -1.72e-08  |g|= 7.2e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000187189
diis-c [-4.62276509e-10  1.31359524e-04  4.94770257e-04 -1.27148406e-01
  1.12652228e+00]
  HOMO = -0.848042363326368  LUMO = 0.802976796105466
  mo_energy =
[-3.27694619e+01 -1.92730779e+00 -8.48042363e-01 -8.48042363e-01
 -8.48042363e-01  8.02976796e-01  8.02976796e-01  8.02976796e-01
  2.01272129e+00  3.86597088e+00  3.86597088e+00  3.86597088e+00
  1.41134573e+01  1.41134573e+01  1.41134573e+01  1.94707413e+01
  5.23014967e+01  5.23014967e+01  5.23014967e+01  9.41941936e+01
  2.37660658e+02  2.37660658e+02  2.37660658e+02  3.56584479e+02
  1.34997399e+03  5.83636565e+03  3.50988621e+04]
E1 = -182.59363266130532  E_coul = 54.05592698049374
cycle= 5 E= -128.537705680812  delta_E= -4.63e-10  |g|= 2.71e-06  |ddm|= 1.68e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59363266130532  E_coul = 54.05592698049374
  HOMO = -0.848041252200078  LUMO = 0.802977116947635
  mo_energy =
[-3.27694594e+01 -1.92730617e+00 -8.48041252e-01 -8.48041252e-01
 -8.48041252e-01  8.02977117e-01  8.02977117e-01  8.02977117e-01
  2.01272250e+00  3.86597194e+00  3.86597194e+00  3.86597194e+00
  1.41134592e+01  1.41134592e+01  1.41134592e+01  1.94707436e+01
  5.23014991e+01  5.23014991e+01  5.23014991e+01  9.41941961e+01
  2.37660660e+02  2.37660660e+02  2.37660660e+02  3.56584481e+02
  1.34997399e+03  5.83636565e+03  3.50988621e+04]
E1 = -182.59362647829454  E_coul = 54.05592079748242
Extra cycle  E= -128.537705680812  delta_E= -5.12e-13  |g|= 8.91e-07  |ddm|= 1.48e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 243.50672905877903
E1 = -182.59362647829454  E_coul = 54.05592079748242
init E= -128.537705680812
    CPU time for initialize scf      0.26 sec, wall time      0.26 sec
  HOMO = -0.84804170010481  LUMO = 0.802977014872213
  mo_energy =
[-3.27694608e+01 -1.92730655e+00 -8.48041700e-01 -8.48041700e-01
 -8.48041700e-01  8.02977015e-01  8.02977015e-01  8.02977015e-01
  2.01272226e+00  3.86597156e+00  3.86597156e+00  3.86597156e+00
  1.41134584e+01  1.41134584e+01  1.41134584e+01  1.94707427e+01
  5.23014979e+01  5.23014979e+01  5.23014979e+01  9.41941948e+01
  2.37660659e+02  2.37660659e+02  2.37660659e+02  3.56584480e+02
  1.34997399e+03  5.83636565e+03  3.50988621e+04]
E1 = -182.59362988913887  E_coul = 54.055924208326616
cycle= 1 E= -128.537705680812  delta_E= -1.42e-13  |g|= 4.72e-07  |ddm|= 3.15e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59362988913887  E_coul = 54.055924208326616
  HOMO = -0.848041461623148  LUMO = 0.802977074345642
  mo_energy =
[-3.27694601e+01 -1.92730628e+00 -8.48041462e-01 -8.48041462e-01
 -8.48041462e-01  8.02977074e-01  8.02977074e-01  8.02977074e-01
  2.01272245e+00  3.86597177e+00  3.86597177e+00  3.86597177e+00
  1.41134588e+01  1.41134588e+01  1.41134588e+01  1.94707432e+01
  5.23014986e+01  5.23014986e+01  5.23014986e+01  9.41941954e+01
  2.37660660e+02  2.37660660e+02  2.37660660e+02  3.56584480e+02
  1.34997399e+03  5.83636565e+03  3.50988621e+04]
E1 = -182.5936281963943  E_coul = 54.05592251558154
Extra cycle  E= -128.537705680813  delta_E= -4.83e-13  |g|= 2.29e-07  |ddm|= 1.92e-07
    CPU time for scf_cycle      0.32 sec, wall time      0.32 sec
exp = [1.80764787e+04 2.71209756e+03 6.17485854e+02 1.74997982e+02
 2.06050596e+01 5.68656759e+01 4.87842514e-01 7.91594368e+00
 1.65496956e+00 7.05383387e+00 2.29565370e+01 9.85800976e+01
 2.65444394e-01 2.42420643e+00 8.28678714e-01]
grad_E = [-2.20506314e-09  1.13966935e-07 -2.09130128e-06  1.93925916e-05
  1.09637647e-04 -8.48739272e-05 -2.33663477e-04  7.39845015e-05
  4.49238328e-05 -1.33009729e-04  2.01419412e-05 -1.75353920e-06
  1.70255943e-04  2.97447106e-04 -3.64086453e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787149        1
[INPUT] 0    0    [1    /1   ]  2712.09754801        1
[INPUT] 0    0    [1    /1   ]  617.486087758        1
[INPUT] 0    0    [1    /1   ]  174.995869848        1
[INPUT] 0    0    [1    /1   ]  20.5949964136        1
[INPUT] 0    0    [1    /1   ]  56.8741768081        1
[INPUT] 0    0    [1    /1   ]  0.487653800829       1
[INPUT] 0    0    [1    /1   ]  7.9059994794         1
[INPUT] 0    0    [1    /1   ]  1.65483604229        1
[INPUT] 1    0    [1    /1   ]  7.03988719012        1
[INPUT] 1    0    [1    /1   ]  22.9319225642        1
[INPUT] 1    0    [1    /1   ]  98.4945928563        1
[INPUT] 1    0    [1    /1   ]  0.265227806286       1
[INPUT] 1    0    [1    /1   ]  2.42068366683        1
[INPUT] 1    0    [1    /1   ]  0.82769902742        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478714939196, 1.0]], [0, [2712.097548010316, 1.0]], [0, [617.4860877578207, 1.0]], [0, [174.99586984751556, 1.0]], [0, [20.594996413581693, 1.0]], [0, [56.87417680811682, 1.0]], [0, [0.4876538008292898, 1.0]], [0, [7.905999479404467, 1.0]], [0, [1.6548360422947375, 1.0]], [1, [7.039887190124943, 1.0]], [1, [22.93192256416726, 1.0]], [1, [98.49459285628929, 1.0]], [1, [0.2652278062864209, 1.0]], [1, [2.4206836668287757, 1.0]], [1, [0.8276990274200948, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871494]
bas 1, expnt(s) = [2712.09754801]
bas 2, expnt(s) = [617.48608776]
bas 3, expnt(s) = [174.99586985]
bas 4, expnt(s) = [20.59499641]
bas 5, expnt(s) = [56.87417681]
bas 6, expnt(s) = [0.4876538]
bas 7, expnt(s) = [7.90599948]
bas 8, expnt(s) = [1.65483604]
bas 9, expnt(s) = [7.03988719]
bas 10, expnt(s) = [22.93192256]
bas 11, expnt(s) = [98.49459286]
bas 12, expnt(s) = [0.26522781]
bas 13, expnt(s) = [2.42068367]
bas 14, expnt(s) = [0.82769903]
CPU time:       258.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209755e+03 9.49497890e+02
 6.17486088e+02 3.12957531e+02 1.74995870e+02 1.21558651e+02
 2.05949964e+01 2.44250980e+01 5.68741768e+01 5.23240518e+01
 4.87653801e-01 1.47434369e+00 7.90599948e+00 1.19119431e+01
 1.65483604e+00 3.68622001e+00 7.03988719e+00 3.34534966e+01
 2.29319226e+01 1.46397943e+02 9.84945929e+01 9.05211118e+02
 2.65227806e-01 5.55275113e-01 2.42068367e+00 8.80860108e+00
 8.27699027e-01 2.30316445e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999184029847573
cond(S) = 243.0682788173388
E1 = -183.58689331414612  E_coul = 55.081478571750814
init E= -128.505414742395
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.77533017634179  LUMO = 0.81952652435787
  mo_energy =
[-3.25542428e+01 -1.85119533e+00 -7.75330176e-01 -7.75330176e-01
 -7.75330176e-01  8.19526524e-01  8.19526524e-01  8.19526524e-01
  2.06381216e+00  3.92564889e+00  3.92564889e+00  3.92564889e+00
  1.42147998e+01  1.42147998e+01  1.42147998e+01  1.95992599e+01
  5.24011559e+01  5.24011559e+01  5.24011559e+01  9.43441385e+01
  2.37618100e+02  2.37618100e+02  2.37618100e+02  3.56766109e+02
  1.35019452e+03  5.83662103e+03  3.50991455e+04]
E1 = -182.09026769160542  E_coul = 53.55606332464192
cycle= 1 E= -128.534204366964  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503335
diis-c [-0.25334621  1.        ]
  HOMO = -0.883373483139525  LUMO = 0.793472250426218
  mo_energy =
[-3.28769305e+01 -1.96466839e+00 -8.83373483e-01 -8.83373483e-01
 -8.83373483e-01  7.93472250e-01  7.93472250e-01  7.93472250e-01
  1.98656109e+00  3.82962529e+00  3.82962529e+00  3.82962529e+00
  1.40257949e+01  1.40257949e+01  1.40257949e+01  1.93768435e+01
  5.21214791e+01  5.21214791e+01  5.21214791e+01  9.40400071e+01
  2.37272810e+02  2.37272810e+02  2.37272810e+02  3.56414676e+02
  1.34980490e+03  5.83619954e+03  3.50987024e+04]
E1 = -182.84937489685498  E_coul = 54.312578169350395
cycle= 2 E= -128.536796727505  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.25417
diis-c [-6.06535394e-04  3.34752045e-01  6.65247955e-01]
  HOMO = -0.847801743089785  LUMO = 0.802097757393095
  mo_energy =
[-3.27689654e+01 -1.92711750e+00 -8.47801743e-01 -8.47801743e-01
 -8.47801743e-01  8.02097757e-01  8.02097757e-01  8.02097757e-01
  2.01189702e+00  3.86099286e+00  3.86099286e+00  3.86099286e+00
  1.40885824e+01  1.40885824e+01  1.40885824e+01  1.94513298e+01
  5.22151716e+01  5.22151716e+01  5.22151716e+01  9.41419927e+01
  2.37386219e+02  2.37386219e+02  2.37386219e+02  3.56529452e+02
  1.34992593e+03  5.83632353e+03  3.50988275e+04]
E1 = -182.59269786839295  E_coul = 54.054990783970204
cycle= 3 E= -128.537707084423  delta_E= -0.00091  |g|= 0.000467  |ddm|= 0.0254
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00119703
diis-c [-1.07360670e-07 -2.15585519e-03  2.71698771e-04  1.00188416e+00]
  HOMO = -0.848024143526936  LUMO = 0.802072526686533
  mo_energy =
[-3.27694242e+01 -1.92728749e+00 -8.48024144e-01 -8.48024144e-01
 -8.48024144e-01  8.02072527e-01  8.02072527e-01  8.02072527e-01
  2.01180826e+00  3.86084674e+00  3.86084674e+00  3.86084674e+00
  1.40883056e+01  1.40883056e+01  1.40883056e+01  1.94510375e+01
  5.22147793e+01  5.22147793e+01  5.22147793e+01  9.41415641e+01
  2.37385685e+02  2.37385685e+02  2.37385685e+02  3.56528890e+02
  1.34992522e+03  5.83632269e+03  3.50988266e+04]
E1 = -182.59329941605384  E_coul = 54.05559231442791
cycle= 4 E= -128.537707101626  delta_E= -1.72e-08  |g|= 7.22e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188052
diis-c [-4.69292478e-10  1.33045559e-04  4.96809019e-04 -1.28164877e-01
  1.12753502e+00]
  HOMO = -0.848058910642692  LUMO = 0.802062392519878
  mo_energy =
[-3.27694949e+01 -1.92731675e+00 -8.48058911e-01 -8.48058911e-01
 -8.48058911e-01  8.02062393e-01  8.02062393e-01  8.02062393e-01
  2.01178550e+00  3.86081413e+00  3.86081413e+00  3.86081413e+00
  1.40882536e+01  1.40882536e+01  1.40882536e+01  1.94509832e+01
  5.22147146e+01  5.22147146e+01  5.22147146e+01  9.41414960e+01
  2.37385610e+02  2.37385610e+02  2.37385610e+02  3.56528813e+02
  1.34992514e+03  5.83632260e+03  3.50988265e+04]
E1 = -182.5934526759266  E_coul = 54.055745573832525
cycle= 5 E= -128.537707102094  delta_E= -4.68e-10  |g|= 2.76e-06  |ddm|= 1.69e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5934526759266  E_coul = 54.055745573832525
  HOMO = -0.848057773072895  LUMO = 0.802062721651738
  mo_energy =
[-3.27694924e+01 -1.92731509e+00 -8.48057773e-01 -8.48057773e-01
 -8.48057773e-01  8.02062722e-01  8.02062722e-01  8.02062722e-01
  2.01178674e+00  3.86081522e+00  3.86081522e+00  3.86081522e+00
  1.40882556e+01  1.40882556e+01  1.40882556e+01  1.94509856e+01
  5.22147170e+01  5.22147170e+01  5.22147170e+01  9.41414984e+01
  2.37385612e+02  2.37385612e+02  2.37385612e+02  3.56528815e+02
  1.34992514e+03  5.83632260e+03  3.50988265e+04]
E1 = -182.59344640728207  E_coul = 54.05573930518719
Extra cycle  E= -128.537707102095  delta_E= -7.96e-13  |g|= 9.05e-07  |ddm|= 1.5e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209755e+03 6.17486088e+02 1.74995870e+02
 2.05949964e+01 5.68741768e+01 4.87653801e-01 7.90599948e+00
 1.65483604e+00 7.03988719e+00 2.29319226e+01 9.84945929e+01
 2.65227806e-01 2.42068367e+00 8.27699027e-01]
E = -128.53770710209488
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787149        1
[INPUT] 0    0    [1    /1   ]  2712.09754801        1
[INPUT] 0    0    [1    /1   ]  617.486087758        1
[INPUT] 0    0    [1    /1   ]  174.995869848        1
[INPUT] 0    0    [1    /1   ]  20.5949964136        1
[INPUT] 0    0    [1    /1   ]  56.8741768081        1
[INPUT] 0    0    [1    /1   ]  0.487653800829       1
[INPUT] 0    0    [1    /1   ]  7.9059994794         1
[INPUT] 0    0    [1    /1   ]  1.65483604229        1
[INPUT] 1    0    [1    /1   ]  7.03988719012        1
[INPUT] 1    0    [1    /1   ]  22.9319225642        1
[INPUT] 1    0    [1    /1   ]  98.4945928563        1
[INPUT] 1    0    [1    /1   ]  0.265227806286       1
[INPUT] 1    0    [1    /1   ]  2.42068366683        1
[INPUT] 1    0    [1    /1   ]  0.82769902742        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478714939196, 1.0]], [0, [2712.097548010316, 1.0]], [0, [617.4860877578207, 1.0]], [0, [174.99586984751556, 1.0]], [0, [20.594996413581693, 1.0]], [0, [56.87417680811682, 1.0]], [0, [0.4876538008292898, 1.0]], [0, [7.905999479404467, 1.0]], [0, [1.6548360422947375, 1.0]], [1, [7.039887190124943, 1.0]], [1, [22.93192256416726, 1.0]], [1, [98.49459285628929, 1.0]], [1, [0.2652278062864209, 1.0]], [1, [2.4206836668287757, 1.0]], [1, [0.8276990274200948, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871494]
bas 1, expnt(s) = [2712.09754801]
bas 2, expnt(s) = [617.48608776]
bas 3, expnt(s) = [174.99586985]
bas 4, expnt(s) = [20.59499641]
bas 5, expnt(s) = [56.87417681]
bas 6, expnt(s) = [0.4876538]
bas 7, expnt(s) = [7.90599948]
bas 8, expnt(s) = [1.65483604]
bas 9, expnt(s) = [7.03988719]
bas 10, expnt(s) = [22.93192256]
bas 11, expnt(s) = [98.49459286]
bas 12, expnt(s) = [0.26522781]
bas 13, expnt(s) = [2.42068367]
bas 14, expnt(s) = [0.82769903]
CPU time:       259.77
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209755e+03 9.49497890e+02
 6.17486088e+02 3.12957531e+02 1.74995870e+02 1.21558651e+02
 2.05949964e+01 2.44250980e+01 5.68741768e+01 5.23240518e+01
 4.87653801e-01 1.47434369e+00 7.90599948e+00 1.19119431e+01
 1.65483604e+00 3.68622001e+00 7.03988719e+00 3.34534966e+01
 2.29319226e+01 1.46397943e+02 9.84945929e+01 9.05211118e+02
 2.65227806e-01 5.55275113e-01 2.42068367e+00 8.80860108e+00
 8.27699027e-01 2.30316445e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999184029847573
cond(S) = 243.0682788173388
E1 = -183.58689331414612  E_coul = 55.081478571750814
init E= -128.505414742395
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77533017634179  LUMO = 0.81952652435787
  mo_energy =
[-3.25542428e+01 -1.85119533e+00 -7.75330176e-01 -7.75330176e-01
 -7.75330176e-01  8.19526524e-01  8.19526524e-01  8.19526524e-01
  2.06381216e+00  3.92564889e+00  3.92564889e+00  3.92564889e+00
  1.42147998e+01  1.42147998e+01  1.42147998e+01  1.95992599e+01
  5.24011559e+01  5.24011559e+01  5.24011559e+01  9.43441385e+01
  2.37618100e+02  2.37618100e+02  2.37618100e+02  3.56766109e+02
  1.35019452e+03  5.83662103e+03  3.50991455e+04]
E1 = -182.09026769160542  E_coul = 53.55606332464192
cycle= 1 E= -128.534204366964  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503335
diis-c [-0.25334621  1.        ]
  HOMO = -0.883373483139525  LUMO = 0.793472250426218
  mo_energy =
[-3.28769305e+01 -1.96466839e+00 -8.83373483e-01 -8.83373483e-01
 -8.83373483e-01  7.93472250e-01  7.93472250e-01  7.93472250e-01
  1.98656109e+00  3.82962529e+00  3.82962529e+00  3.82962529e+00
  1.40257949e+01  1.40257949e+01  1.40257949e+01  1.93768435e+01
  5.21214791e+01  5.21214791e+01  5.21214791e+01  9.40400071e+01
  2.37272810e+02  2.37272810e+02  2.37272810e+02  3.56414676e+02
  1.34980490e+03  5.83619954e+03  3.50987024e+04]
E1 = -182.84937489685498  E_coul = 54.312578169350395
cycle= 2 E= -128.536796727505  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.25417
diis-c [-6.06535394e-04  3.34752045e-01  6.65247955e-01]
  HOMO = -0.847801743089785  LUMO = 0.802097757393095
  mo_energy =
[-3.27689654e+01 -1.92711750e+00 -8.47801743e-01 -8.47801743e-01
 -8.47801743e-01  8.02097757e-01  8.02097757e-01  8.02097757e-01
  2.01189702e+00  3.86099286e+00  3.86099286e+00  3.86099286e+00
  1.40885824e+01  1.40885824e+01  1.40885824e+01  1.94513298e+01
  5.22151716e+01  5.22151716e+01  5.22151716e+01  9.41419927e+01
  2.37386219e+02  2.37386219e+02  2.37386219e+02  3.56529452e+02
  1.34992593e+03  5.83632353e+03  3.50988275e+04]
E1 = -182.59269786839295  E_coul = 54.054990783970204
cycle= 3 E= -128.537707084423  delta_E= -0.00091  |g|= 0.000467  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00119703
diis-c [-1.07360670e-07 -2.15585519e-03  2.71698771e-04  1.00188416e+00]
  HOMO = -0.848024143526936  LUMO = 0.802072526686533
  mo_energy =
[-3.27694242e+01 -1.92728749e+00 -8.48024144e-01 -8.48024144e-01
 -8.48024144e-01  8.02072527e-01  8.02072527e-01  8.02072527e-01
  2.01180826e+00  3.86084674e+00  3.86084674e+00  3.86084674e+00
  1.40883056e+01  1.40883056e+01  1.40883056e+01  1.94510375e+01
  5.22147793e+01  5.22147793e+01  5.22147793e+01  9.41415641e+01
  2.37385685e+02  2.37385685e+02  2.37385685e+02  3.56528890e+02
  1.34992522e+03  5.83632269e+03  3.50988266e+04]
E1 = -182.59329941605384  E_coul = 54.05559231442791
cycle= 4 E= -128.537707101626  delta_E= -1.72e-08  |g|= 7.22e-05  |ddm|= 0.000117
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188052
diis-c [-4.69292478e-10  1.33045559e-04  4.96809019e-04 -1.28164877e-01
  1.12753502e+00]
  HOMO = -0.848058910642692  LUMO = 0.802062392519878
  mo_energy =
[-3.27694949e+01 -1.92731675e+00 -8.48058911e-01 -8.48058911e-01
 -8.48058911e-01  8.02062393e-01  8.02062393e-01  8.02062393e-01
  2.01178550e+00  3.86081413e+00  3.86081413e+00  3.86081413e+00
  1.40882536e+01  1.40882536e+01  1.40882536e+01  1.94509832e+01
  5.22147146e+01  5.22147146e+01  5.22147146e+01  9.41414960e+01
  2.37385610e+02  2.37385610e+02  2.37385610e+02  3.56528813e+02
  1.34992514e+03  5.83632260e+03  3.50988265e+04]
E1 = -182.5934526759266  E_coul = 54.055745573832525
cycle= 5 E= -128.537707102094  delta_E= -4.68e-10  |g|= 2.76e-06  |ddm|= 1.69e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5934526759266  E_coul = 54.055745573832525
  HOMO = -0.848057773072895  LUMO = 0.802062721651738
  mo_energy =
[-3.27694924e+01 -1.92731509e+00 -8.48057773e-01 -8.48057773e-01
 -8.48057773e-01  8.02062722e-01  8.02062722e-01  8.02062722e-01
  2.01178674e+00  3.86081522e+00  3.86081522e+00  3.86081522e+00
  1.40882556e+01  1.40882556e+01  1.40882556e+01  1.94509856e+01
  5.22147170e+01  5.22147170e+01  5.22147170e+01  9.41414984e+01
  2.37385612e+02  2.37385612e+02  2.37385612e+02  3.56528815e+02
  1.34992514e+03  5.83632260e+03  3.50988265e+04]
E1 = -182.59344640728207  E_coul = 54.05573930518719
Extra cycle  E= -128.537707102095  delta_E= -7.96e-13  |g|= 9.05e-07  |ddm|= 1.5e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 243.0682788173388
E1 = -182.59344640728207  E_coul = 54.05573930518719
init E= -128.537707102095
    CPU time for initialize scf      0.24 sec, wall time      0.23 sec
  HOMO = -0.848058226882305  LUMO = 0.802062618638544
  mo_energy =
[-3.27694937e+01 -1.92731548e+00 -8.48058227e-01 -8.48058227e-01
 -8.48058227e-01  8.02062619e-01  8.02062619e-01  8.02062619e-01
  2.01178650e+00  3.86081483e+00  3.86081483e+00  3.86081483e+00
  1.40882548e+01  1.40882548e+01  1.40882548e+01  1.94509846e+01
  5.22147158e+01  5.22147158e+01  5.22147158e+01  9.41414971e+01
  2.37385610e+02  2.37385610e+02  2.37385610e+02  3.56528813e+02
  1.34992514e+03  5.83632260e+03  3.50988265e+04]
E1 = -182.5934498737469  E_coul = 54.055742771652
cycle= 1 E= -128.537707102095  delta_E=    0  |g|= 4.8e-07  |ddm|= 3.21e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5934498737469  E_coul = 54.055742771652
  HOMO = -0.848057984475992  LUMO = 0.802062679028077
  mo_energy =
[-3.27694930e+01 -1.92731520e+00 -8.48057984e-01 -8.48057984e-01
 -8.48057984e-01  8.02062679e-01  8.02062679e-01  8.02062679e-01
  2.01178669e+00  3.86081504e+00  3.86081504e+00  3.86081504e+00
  1.40882552e+01  1.40882552e+01  1.40882552e+01  1.94509852e+01
  5.22147165e+01  5.22147165e+01  5.22147165e+01  9.41414978e+01
  2.37385611e+02  2.37385611e+02  2.37385611e+02  3.56528814e+02
  1.34992514e+03  5.83632260e+03  3.50988265e+04]
E1 = -182.59344815435875  E_coul = 54.05574105226382
Extra cycle  E= -128.537707102095  delta_E= -5.68e-14  |g|= 2.33e-07  |ddm|= 1.95e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.29 sec
exp = [1.80764787e+04 2.71209755e+03 6.17486088e+02 1.74995870e+02
 2.05949964e+01 5.68741768e+01 4.87653801e-01 7.90599948e+00
 1.65483604e+00 7.03988719e+00 2.29319226e+01 9.84945929e+01
 2.65227806e-01 2.42068367e+00 8.27699027e-01]
grad_E = [-2.07384565e-09  1.07155850e-07 -1.96560886e-06  1.82276448e-05
  1.10188047e-04 -8.05908899e-05 -4.98377276e-04  5.25412853e-05
  1.06384167e-04 -2.17381932e-04  3.34104407e-05 -2.24349283e-06
  3.74096614e-04  4.84785194e-04 -6.17056677e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787154        1
[INPUT] 0    0    [1    /1   ]  2712.0975219         1
[INPUT] 0    0    [1    /1   ]  617.486566692        1
[INPUT] 0    0    [1    /1   ]  174.991435156        1
[INPUT] 0    0    [1    /1   ]  20.571734928         1
[INPUT] 0    0    [1    /1   ]  56.893372337         1
[INPUT] 0    0    [1    /1   ]  0.487383013508       1
[INPUT] 0    0    [1    /1   ]  7.88492101564        1
[INPUT] 0    0    [1    /1   ]  1.65463987715        1
[INPUT] 1    0    [1    /1   ]  7.02863501545        1
[INPUT] 1    0    [1    /1   ]  22.922932861         1
[INPUT] 1    0    [1    /1   ]  98.5003657671        1
[INPUT] 1    0    [1    /1   ]  0.265072510913       1
[INPUT] 1    0    [1    /1   ]  2.41793204418        1
[INPUT] 1    0    [1    /1   ]  0.82693909683        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478715444307, 1.0]], [0, [2712.0975218974677, 1.0]], [0, [617.4865666924511, 1.0]], [0, [174.99143515616845, 1.0]], [0, [20.571734927998943, 1.0]], [0, [56.893372336966344, 1.0]], [0, [0.4873830135081979, 1.0]], [0, [7.884921015644272, 1.0]], [0, [1.654639877152415, 1.0]], [1, [7.028635015448194, 1.0]], [1, [22.922932860999467, 1.0]], [1, [98.5003657670655, 1.0]], [1, [0.26507251091291006, 1.0]], [1, [2.4179320441782424, 1.0]], [1, [0.8269390968298421, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871544]
bas 1, expnt(s) = [2712.0975219]
bas 2, expnt(s) = [617.48656669]
bas 3, expnt(s) = [174.99143516]
bas 4, expnt(s) = [20.57173493]
bas 5, expnt(s) = [56.89337234]
bas 6, expnt(s) = [0.48738301]
bas 7, expnt(s) = [7.88492102]
bas 8, expnt(s) = [1.65463988]
bas 9, expnt(s) = [7.02863502]
bas 10, expnt(s) = [22.92293286]
bas 11, expnt(s) = [98.50036577]
bas 12, expnt(s) = [0.26507251]
bas 13, expnt(s) = [2.41793204]
bas 14, expnt(s) = [0.8269391]
CPU time:       263.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209752e+03 9.49497883e+02
 6.17486567e+02 3.12957713e+02 1.74991435e+02 1.21556341e+02
 2.05717349e+01 2.44044045e+01 5.68933723e+01 5.23372961e+01
 4.87383014e-01 1.47372963e+00 7.88492102e+00 1.18881160e+01
 1.65463988e+00 3.68589228e+00 7.02863502e+00 3.33866721e+01
 2.29229329e+01 1.46326209e+02 9.85003658e+01 9.05277438e+02
 2.65072511e-01 5.54868739e-01 2.41793204e+00 8.79608680e+00
 8.26939097e-01 2.30052152e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999186230585483
cond(S) = 242.14241148872648
E1 = -183.58688927250947  E_coul = 55.08147407367691
init E= -128.505415198833
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775331184779147  LUMO = 0.818827832671441
  mo_energy =
[-3.25542463e+01 -1.85119386e+00 -7.75331185e-01 -7.75331185e-01
 -7.75331185e-01  8.18827833e-01  8.18827833e-01  8.18827833e-01
  2.06232496e+00  3.92168507e+00  3.92168507e+00  3.92168507e+00
  1.41948737e+01  1.41948737e+01  1.41948737e+01  1.95576492e+01
  5.23450890e+01  5.23450890e+01  5.23450890e+01  9.42298429e+01
  2.37556331e+02  2.37556331e+02  2.37556331e+02  3.56645049e+02
  1.35008894e+03  5.83652825e+03  3.50990688e+04]
E1 = -182.08994640978568  E_coul = 53.5557404415141
cycle= 1 E= -128.534205968272  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503453
diis-c [-0.25346531  1.        ]
  HOMO = -0.883401058763638  LUMO = 0.792799861191014
  mo_energy =
[-3.28769936e+01 -1.96468597e+00 -8.83401059e-01 -8.83401059e-01
 -8.83401059e-01  7.92799861e-01  7.92799861e-01  7.92799861e-01
  1.98511093e+00  3.82572527e+00  3.82572527e+00  3.82572527e+00
  1.40059585e+01  1.40059585e+01  1.40059585e+01  1.93353662e+01
  5.20653921e+01  5.20653921e+01  5.20653921e+01  9.39256843e+01
  2.37210963e+02  2.37210963e+02  2.37210963e+02  3.56293541e+02
  1.34969924e+03  5.83610668e+03  3.50986257e+04]
E1 = -182.84925260954597  E_coul = 54.31245326952089
cycle= 2 E= -128.536799340025  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.254236
diis-c [-6.06230363e-04  3.34758439e-01  6.65241561e-01]
  HOMO = -0.847820113678871  LUMO = 0.801417622120395
  mo_energy =
[-3.27690022e+01 -1.92712523e+00 -8.47820114e-01 -8.47820114e-01
 -8.47820114e-01  8.01417622e-01  8.01417622e-01  8.01417622e-01
  2.01043721e+00  3.85707234e+00  3.85707234e+00  3.85707234e+00
  1.40687182e+01  1.40687182e+01  1.40687182e+01  1.94098093e+01
  5.21590963e+01  5.21590963e+01  5.21590963e+01  9.40276842e+01
  2.37324401e+02  2.37324401e+02  2.37324401e+02  3.56408346e+02
  1.34982030e+03  5.83623070e+03  3.50987508e+04]
E1 = -182.5925045231465  E_coul = 54.05479434592634
cycle= 3 E= -128.53771017722  delta_E= -0.000911  |g|= 0.000468  |ddm|= 0.0254
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00120054
diis-c [-1.08545445e-07 -2.15547410e-03  2.83795379e-04  1.00187168e+00]
  HOMO = -0.848042380942516  LUMO = 0.801392632779942
  mo_energy =
[-3.27694609e+01 -1.92729424e+00 -8.48042381e-01 -8.48042381e-01
 -8.48042381e-01  8.01392633e-01  8.01392633e-01  8.01392633e-01
  2.01034938e+00  3.85692667e+00  3.85692667e+00  3.85692667e+00
  1.40684419e+01  1.40684419e+01  1.40684419e+01  1.94095176e+01
  5.21587044e+01  5.21587044e+01  5.21587044e+01  9.40272559e+01
  2.37323866e+02  2.37323866e+02  2.37323866e+02  3.56407784e+02
  1.34981959e+03  5.83622986e+03  3.50987499e+04]
E1 = -182.5931080336392  E_coul = 54.05539783913573
cycle= 4 E= -128.537710194503  delta_E= -1.73e-08  |g|= 7.26e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000189252
diis-c [-4.79018300e-10  1.35450543e-04  4.99339216e-04 -1.29583062e-01
  1.12894827e+00]
  HOMO = -0.848077218741389  LUMO = 0.801382513885748
  mo_energy =
[-3.27695319e+01 -1.92732338e+00 -8.48077219e-01 -8.48077219e-01
 -8.48077219e-01  8.01382514e-01  8.01382514e-01  8.01382514e-01
  2.01032675e+00  3.85689405e+00  3.85689405e+00  3.85689405e+00
  1.40683899e+01  1.40683899e+01  1.40683899e+01  1.94094633e+01
  5.21586394e+01  5.21586394e+01  5.21586394e+01  9.40271875e+01
  2.37323791e+02  2.37323791e+02  2.37323791e+02  3.56407706e+02
  1.34981950e+03  5.83622977e+03  3.50987498e+04]
E1 = -182.59326234101522  E_coul = 54.05555214603671
cycle= 5 E= -128.537710194979  delta_E= -4.75e-10  |g|= 2.83e-06  |ddm|= 1.71e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59326234101522  E_coul = 54.05555214603671
  HOMO = -0.848076042601695  LUMO = 0.801382855366423
  mo_energy =
[-3.27695292e+01 -1.92732167e+00 -8.48076043e-01 -8.48076043e-01
 -8.48076043e-01  8.01382855e-01  8.01382855e-01  8.01382855e-01
  2.01032804e+00  3.85689517e+00  3.85689517e+00  3.85689517e+00
  1.40683918e+01  1.40683918e+01  1.40683918e+01  1.94094657e+01
  5.21586420e+01  5.21586420e+01  5.21586420e+01  9.40271901e+01
  2.37323793e+02  2.37323793e+02  2.37323793e+02  3.56407708e+02
  1.34981950e+03  5.83622977e+03  3.50987498e+04]
E1 = -182.593255944612  E_coul = 54.05554574963289
Extra cycle  E= -128.537710194979  delta_E= -5.97e-13  |g|= 9.25e-07  |ddm|= 1.54e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209752e+03 6.17486567e+02 1.74991435e+02
 2.05717349e+01 5.68933723e+01 4.87383014e-01 7.88492102e+00
 1.65463988e+00 7.02863502e+00 2.29229329e+01 9.85003658e+01
 2.65072511e-01 2.41793204e+00 8.26939097e-01]
E = -128.5377101949791
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787154        1
[INPUT] 0    0    [1    /1   ]  2712.0975219         1
[INPUT] 0    0    [1    /1   ]  617.486566692        1
[INPUT] 0    0    [1    /1   ]  174.991435156        1
[INPUT] 0    0    [1    /1   ]  20.571734928         1
[INPUT] 0    0    [1    /1   ]  56.893372337         1
[INPUT] 0    0    [1    /1   ]  0.487383013508       1
[INPUT] 0    0    [1    /1   ]  7.88492101564        1
[INPUT] 0    0    [1    /1   ]  1.65463987715        1
[INPUT] 1    0    [1    /1   ]  7.02863501545        1
[INPUT] 1    0    [1    /1   ]  22.922932861         1
[INPUT] 1    0    [1    /1   ]  98.5003657671        1
[INPUT] 1    0    [1    /1   ]  0.265072510913       1
[INPUT] 1    0    [1    /1   ]  2.41793204418        1
[INPUT] 1    0    [1    /1   ]  0.82693909683        1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478715444307, 1.0]], [0, [2712.0975218974677, 1.0]], [0, [617.4865666924511, 1.0]], [0, [174.99143515616845, 1.0]], [0, [20.571734927998943, 1.0]], [0, [56.893372336966344, 1.0]], [0, [0.4873830135081979, 1.0]], [0, [7.884921015644272, 1.0]], [0, [1.654639877152415, 1.0]], [1, [7.028635015448194, 1.0]], [1, [22.922932860999467, 1.0]], [1, [98.5003657670655, 1.0]], [1, [0.26507251091291006, 1.0]], [1, [2.4179320441782424, 1.0]], [1, [0.8269390968298421, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871544]
bas 1, expnt(s) = [2712.0975219]
bas 2, expnt(s) = [617.48656669]
bas 3, expnt(s) = [174.99143516]
bas 4, expnt(s) = [20.57173493]
bas 5, expnt(s) = [56.89337234]
bas 6, expnt(s) = [0.48738301]
bas 7, expnt(s) = [7.88492102]
bas 8, expnt(s) = [1.65463988]
bas 9, expnt(s) = [7.02863502]
bas 10, expnt(s) = [22.92293286]
bas 11, expnt(s) = [98.50036577]
bas 12, expnt(s) = [0.26507251]
bas 13, expnt(s) = [2.41793204]
bas 14, expnt(s) = [0.8269391]
CPU time:       264.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209752e+03 9.49497883e+02
 6.17486567e+02 3.12957713e+02 1.74991435e+02 1.21556341e+02
 2.05717349e+01 2.44044045e+01 5.68933723e+01 5.23372961e+01
 4.87383014e-01 1.47372963e+00 7.88492102e+00 1.18881160e+01
 1.65463988e+00 3.68589228e+00 7.02863502e+00 3.33866721e+01
 2.29229329e+01 1.46326209e+02 9.85003658e+01 9.05277438e+02
 2.65072511e-01 5.54868739e-01 2.41793204e+00 8.79608680e+00
 8.26939097e-01 2.30052152e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999186230585483
cond(S) = 242.14241148872648
E1 = -183.58688927250947  E_coul = 55.08147407367691
init E= -128.505415198833
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775331184779147  LUMO = 0.818827832671441
  mo_energy =
[-3.25542463e+01 -1.85119386e+00 -7.75331185e-01 -7.75331185e-01
 -7.75331185e-01  8.18827833e-01  8.18827833e-01  8.18827833e-01
  2.06232496e+00  3.92168507e+00  3.92168507e+00  3.92168507e+00
  1.41948737e+01  1.41948737e+01  1.41948737e+01  1.95576492e+01
  5.23450890e+01  5.23450890e+01  5.23450890e+01  9.42298429e+01
  2.37556331e+02  2.37556331e+02  2.37556331e+02  3.56645049e+02
  1.35008894e+03  5.83652825e+03  3.50990688e+04]
E1 = -182.08994640978568  E_coul = 53.5557404415141
cycle= 1 E= -128.534205968272  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503453
diis-c [-0.25346531  1.        ]
  HOMO = -0.883401058763638  LUMO = 0.792799861191014
  mo_energy =
[-3.28769936e+01 -1.96468597e+00 -8.83401059e-01 -8.83401059e-01
 -8.83401059e-01  7.92799861e-01  7.92799861e-01  7.92799861e-01
  1.98511093e+00  3.82572527e+00  3.82572527e+00  3.82572527e+00
  1.40059585e+01  1.40059585e+01  1.40059585e+01  1.93353662e+01
  5.20653921e+01  5.20653921e+01  5.20653921e+01  9.39256843e+01
  2.37210963e+02  2.37210963e+02  2.37210963e+02  3.56293541e+02
  1.34969924e+03  5.83610668e+03  3.50986257e+04]
E1 = -182.84925260954597  E_coul = 54.31245326952089
cycle= 2 E= -128.536799340025  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254236
diis-c [-6.06230363e-04  3.34758439e-01  6.65241561e-01]
  HOMO = -0.847820113678871  LUMO = 0.801417622120395
  mo_energy =
[-3.27690022e+01 -1.92712523e+00 -8.47820114e-01 -8.47820114e-01
 -8.47820114e-01  8.01417622e-01  8.01417622e-01  8.01417622e-01
  2.01043721e+00  3.85707234e+00  3.85707234e+00  3.85707234e+00
  1.40687182e+01  1.40687182e+01  1.40687182e+01  1.94098093e+01
  5.21590963e+01  5.21590963e+01  5.21590963e+01  9.40276842e+01
  2.37324401e+02  2.37324401e+02  2.37324401e+02  3.56408346e+02
  1.34982030e+03  5.83623070e+03  3.50987508e+04]
E1 = -182.5925045231465  E_coul = 54.05479434592634
cycle= 3 E= -128.53771017722  delta_E= -0.000911  |g|= 0.000468  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120054
diis-c [-1.08545445e-07 -2.15547410e-03  2.83795379e-04  1.00187168e+00]
  HOMO = -0.848042380942516  LUMO = 0.801392632779942
  mo_energy =
[-3.27694609e+01 -1.92729424e+00 -8.48042381e-01 -8.48042381e-01
 -8.48042381e-01  8.01392633e-01  8.01392633e-01  8.01392633e-01
  2.01034938e+00  3.85692667e+00  3.85692667e+00  3.85692667e+00
  1.40684419e+01  1.40684419e+01  1.40684419e+01  1.94095176e+01
  5.21587044e+01  5.21587044e+01  5.21587044e+01  9.40272559e+01
  2.37323866e+02  2.37323866e+02  2.37323866e+02  3.56407784e+02
  1.34981959e+03  5.83622986e+03  3.50987499e+04]
E1 = -182.5931080336392  E_coul = 54.05539783913573
cycle= 4 E= -128.537710194503  delta_E= -1.73e-08  |g|= 7.26e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000189252
diis-c [-4.79018300e-10  1.35450543e-04  4.99339216e-04 -1.29583062e-01
  1.12894827e+00]
  HOMO = -0.848077218741389  LUMO = 0.801382513885748
  mo_energy =
[-3.27695319e+01 -1.92732338e+00 -8.48077219e-01 -8.48077219e-01
 -8.48077219e-01  8.01382514e-01  8.01382514e-01  8.01382514e-01
  2.01032675e+00  3.85689405e+00  3.85689405e+00  3.85689405e+00
  1.40683899e+01  1.40683899e+01  1.40683899e+01  1.94094633e+01
  5.21586394e+01  5.21586394e+01  5.21586394e+01  9.40271875e+01
  2.37323791e+02  2.37323791e+02  2.37323791e+02  3.56407706e+02
  1.34981950e+03  5.83622977e+03  3.50987498e+04]
E1 = -182.59326234101522  E_coul = 54.05555214603671
cycle= 5 E= -128.537710194979  delta_E= -4.75e-10  |g|= 2.83e-06  |ddm|= 1.71e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59326234101522  E_coul = 54.05555214603671
  HOMO = -0.848076042601695  LUMO = 0.801382855366423
  mo_energy =
[-3.27695292e+01 -1.92732167e+00 -8.48076043e-01 -8.48076043e-01
 -8.48076043e-01  8.01382855e-01  8.01382855e-01  8.01382855e-01
  2.01032804e+00  3.85689517e+00  3.85689517e+00  3.85689517e+00
  1.40683918e+01  1.40683918e+01  1.40683918e+01  1.94094657e+01
  5.21586420e+01  5.21586420e+01  5.21586420e+01  9.40271901e+01
  2.37323793e+02  2.37323793e+02  2.37323793e+02  3.56407708e+02
  1.34981950e+03  5.83622977e+03  3.50987498e+04]
E1 = -182.593255944612  E_coul = 54.05554574963289
Extra cycle  E= -128.537710194979  delta_E= -5.97e-13  |g|= 9.25e-07  |ddm|= 1.54e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 242.14241148872648
E1 = -182.593255944612  E_coul = 54.05554574963289
init E= -128.537710194979
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.84807650520694  LUMO = 0.801382750818699
  mo_energy =
[-3.27695306e+01 -1.92732206e+00 -8.48076505e-01 -8.48076505e-01
 -8.48076505e-01  8.01382751e-01  8.01382751e-01  8.01382751e-01
  2.01032779e+00  3.85689478e+00  3.85689478e+00  3.85689478e+00
  1.40683910e+01  1.40683910e+01  1.40683910e+01  1.94094648e+01
  5.21586407e+01  5.21586407e+01  5.21586407e+01  9.40271887e+01
  2.37323791e+02  2.37323791e+02  2.37323791e+02  3.56407707e+02
  1.34981950e+03  5.83622977e+03  3.50987498e+04]
E1 = -182.59325949309203  E_coul = 54.055549298112716
cycle= 1 E= -128.537710194979  delta_E= -2.27e-13  |g|= 4.91e-07  |ddm|= 3.3e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59325949309203  E_coul = 54.055549298112716
  HOMO = -0.848076257011993  LUMO = 0.801382812618162
  mo_energy =
[-3.27695299e+01 -1.92732178e+00 -8.48076257e-01 -8.48076257e-01
 -8.48076257e-01  8.01382813e-01  8.01382813e-01  8.01382813e-01
  2.01032798e+00  3.85689500e+00  3.85689500e+00  3.85689500e+00
  1.40683915e+01  1.40683915e+01  1.40683915e+01  1.94094653e+01
  5.21586414e+01  5.21586414e+01  5.21586414e+01  9.40271894e+01
  2.37323792e+02  2.37323792e+02  2.37323792e+02  3.56407707e+02
  1.34981950e+03  5.83622977e+03  3.50987498e+04]
E1 = -182.59325773432914  E_coul = 54.055547539349774
Extra cycle  E= -128.537710194979  delta_E= -2.84e-14  |g|= 2.38e-07  |ddm|= 1.99e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.28 sec
exp = [1.80764787e+04 2.71209752e+03 6.17486567e+02 1.74991435e+02
 2.05717349e+01 5.68933723e+01 4.87383014e-01 7.88492102e+00
 1.65463988e+00 7.02863502e+00 2.29229329e+01 9.85003658e+01
 2.65072511e-01 2.41793204e+00 8.26939097e-01]
grad_E = [-1.75129061e-09  9.03983445e-08 -1.65402977e-06  1.52747163e-05
  1.03275301e-04 -6.86526339e-05 -8.44894040e-04  1.67135081e-05
  1.89479163e-04 -3.12693486e-04  4.86248195e-05 -2.72422753e-06
  6.39713572e-04  6.97042792e-04 -9.12637364e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:56:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787163        1
[INPUT] 0    0    [1    /1   ]  2712.09747984        1
[INPUT] 0    0    [1    /1   ]  617.487343221        1
[INPUT] 0    0    [1    /1   ]  174.984092283        1
[INPUT] 0    0    [1    /1   ]  20.5301668727        1
[INPUT] 0    0    [1    /1   ]  56.9269594115        1
[INPUT] 0    0    [1    /1   ]  0.487136571641       1
[INPUT] 0    0    [1    /1   ]  7.85032039094        1
[INPUT] 0    0    [1    /1   ]  1.65441056041        1
[INPUT] 1    0    [1    /1   ]  7.03451235648        1
[INPUT] 1    0    [1    /1   ]  22.9635742342        1
[INPUT] 1    0    [1    /1   ]  98.752703573         1
[INPUT] 1    0    [1    /1   ]  0.265206801145       1
[INPUT] 1    0    [1    /1   ]  2.4196308831         1
[INPUT] 1    0    [1    /1   ]  0.827418890977       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478716252168, 1.0]], [0, [2712.0974798394327, 1.0]], [0, [617.4873432212663, 1.0]], [0, [174.98409228269395, 1.0]], [0, [20.530166872673135, 1.0]], [0, [56.926959411475394, 1.0]], [0, [0.4871365716411854, 1.0]], [0, [7.850320390942342, 1.0]], [0, [1.6544105604066737, 1.0]], [1, [7.034512356475636, 1.0]], [1, [22.96357423422041, 1.0]], [1, [98.75270357296068, 1.0]], [1, [0.2652068011448871, 1.0]], [1, [2.4196308830969286, 1.0]], [1, [0.8274188909772823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871625]
bas 1, expnt(s) = [2712.09747984]
bas 2, expnt(s) = [617.48734322]
bas 3, expnt(s) = [174.98409228]
bas 4, expnt(s) = [20.53016687]
bas 5, expnt(s) = [56.92695941]
bas 6, expnt(s) = [0.48713657]
bas 7, expnt(s) = [7.85032039]
bas 8, expnt(s) = [1.65441056]
bas 9, expnt(s) = [7.03451236]
bas 10, expnt(s) = [22.96357423]
bas 11, expnt(s) = [98.75270357]
bas 12, expnt(s) = [0.2652068]
bas 13, expnt(s) = [2.41963088]
bas 14, expnt(s) = [0.82741889]
CPU time:       267.60
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209748e+03 9.49497872e+02
 6.17487343e+02 3.12958008e+02 1.74984092e+02 1.21552516e+02
 2.05301669e+01 2.43674107e+01 5.69269594e+01 5.23604675e+01
 4.87136572e-01 1.47317071e+00 7.85032039e+00 1.18489689e+01
 1.65441056e+00 3.68550916e+00 7.03451236e+00 3.34215732e+01
 2.29635742e+01 1.46650568e+02 9.87527036e+01 9.08177285e+02
 2.65206801e-01 5.55220144e-01 2.41963088e+00 8.80381264e+00
 8.27418891e-01 2.30219010e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99918613823656
cond(S) = 240.6291899007103
E1 = -183.5868534017554  E_coul = 55.081454655493346
init E= -128.505398746262
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775333324140312  LUMO = 0.819353577621816
  mo_energy =
[-3.25542531e+01 -1.85119328e+00 -7.75333324e-01 -7.75333324e-01
 -7.75333324e-01  8.19353578e-01  8.19353578e-01  8.19353578e-01
  2.06064659e+00  3.92445633e+00  3.92445633e+00  3.92445633e+00
  1.42066590e+01  1.42066590e+01  1.42066590e+01  1.94895572e+01
  5.24203751e+01  5.24203751e+01  5.24203751e+01  9.40371641e+01
  2.38131685e+02  2.38131685e+02  2.38131685e+02  3.56440389e+02
  1.34991134e+03  5.83637250e+03  3.50989402e+04]
E1 = -182.08987646023712  E_coul = 53.55566574080029
cycle= 1 E= -128.534210719437  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503405
diis-c [-0.25341686  1.        ]
  HOMO = -0.883408913376774  LUMO = 0.793303568126534
  mo_energy =
[-3.28770129e+01 -1.96468303e+00 -8.83408913e-01 -8.83408913e-01
 -8.83408913e-01  7.93303568e-01  7.93303568e-01  7.93303568e-01
  1.98350317e+00  3.82843494e+00  3.82843494e+00  3.82843494e+00
  1.40176537e+01  1.40176537e+01  1.40176537e+01  1.92675680e+01
  5.21405589e+01  5.21405589e+01  5.21405589e+01  9.37330431e+01
  2.37786202e+02  2.37786202e+02  2.37786202e+02  3.56088849e+02
  1.34952161e+03  5.83595090e+03  3.50984970e+04]
E1 = -182.84920830232625  E_coul = 54.312403977052135
cycle= 2 E= -128.536804325274  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.254201
diis-c [-6.05695498e-04  3.34748952e-01  6.65251048e-01]
  HOMO = -0.847826490087914  LUMO = 0.801928927473788
  mo_energy =
[-3.27690153e+01 -1.92712085e+00 -8.47826490e-01 -8.47826490e-01
 -8.47826490e-01  8.01928927e-01  8.01928927e-01  8.01928927e-01
  2.00880762e+00  3.85980226e+00  3.85980226e+00  3.85980226e+00
  1.40804447e+01  1.40804447e+01  1.40804447e+01  1.93419105e+01
  5.22343041e+01  5.22343041e+01  5.22343041e+01  9.38350303e+01
  2.37899669e+02  2.37899669e+02  2.37899669e+02  3.56203662e+02
  1.34964268e+03  5.83607492e+03  3.50986221e+04]
E1 = -182.5924530485177  E_coul = 54.054737817275125
cycle= 3 E= -128.537715231243  delta_E= -0.000911  |g|= 0.000469  |ddm|= 0.0254
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00120506
diis-c [-1.09680553e-07 -2.15686765e-03  2.98138509e-04  1.00185873e+00]
  HOMO = -0.848048941900743  LUMO = 0.801903971997539
  mo_energy =
[-3.27694746e+01 -1.92728941e+00 -8.48048942e-01 -8.48048942e-01
 -8.48048942e-01  8.01903972e-01  8.01903972e-01  8.01903972e-01
  2.00872029e+00  3.85965646e+00  3.85965646e+00  3.85965646e+00
  1.40801681e+01  1.40801681e+01  1.40801681e+01  1.93416189e+01
  5.22339115e+01  5.22339115e+01  5.22339115e+01  9.38346014e+01
  2.37899133e+02  2.37899133e+02  2.37899133e+02  3.56203099e+02
  1.34964196e+03  5.83607409e+03  3.50986212e+04]
E1 = -182.5930599033827  E_coul = 54.05534465474406
cycle= 4 E= -128.537715248639  delta_E= -1.74e-08  |g|= 7.28e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000190197
diis-c [-4.86393754e-10  1.37405440e-04  5.00632921e-04 -1.30693035e-01
  1.13005500e+00]
  HOMO = -0.848083841475156  LUMO = 0.801893848340242
  mo_energy =
[-3.27695458e+01 -1.92731846e+00 -8.48083841e-01 -8.48083841e-01
 -8.48083841e-01  8.01893848e-01  8.01893848e-01  8.01893848e-01
  2.00869777e+00  3.85962379e+00  3.85962379e+00  3.85962379e+00
  1.40801159e+01  1.40801159e+01  1.40801159e+01  1.93415645e+01
  5.22338464e+01  5.22338464e+01  5.22338464e+01  9.38345329e+01
  2.37899057e+02  2.37899057e+02  2.37899057e+02  3.56203021e+02
  1.34964188e+03  5.83607399e+03  3.50986211e+04]
E1 = -182.59321508435931  E_coul = 54.05549983524061
cycle= 5 E= -128.537715249119  delta_E= -4.8e-10  |g|= 2.89e-06  |ddm|= 1.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59321508435931  E_coul = 54.05549983524061
  HOMO = -0.848082632050673  LUMO = 0.801894200986742
  mo_energy =
[-3.27695431e+01 -1.92731670e+00 -8.48082632e-01 -8.48082632e-01
 -8.48082632e-01  8.01894201e-01  8.01894201e-01  8.01894201e-01
  2.00869909e+00  3.85962495e+00  3.85962495e+00  3.85962495e+00
  1.40801180e+01  1.40801180e+01  1.40801180e+01  1.93415670e+01
  5.22338490e+01  5.22338490e+01  5.22338490e+01  9.38345355e+01
  2.37899059e+02  2.37899059e+02  2.37899059e+02  3.56203023e+02
  1.34964188e+03  5.83607400e+03  3.50986211e+04]
E1 = -182.59320857289956  E_coul = 54.05549332378021
Extra cycle  E= -128.537715249119  delta_E= -6.25e-13  |g|= 9.43e-07  |ddm|= 1.57e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [1.80764787e+04 2.71209748e+03 6.17487343e+02 1.74984092e+02
 2.05301669e+01 5.69269594e+01 4.87136572e-01 7.85032039e+00
 1.65441056e+00 7.03451236e+00 2.29635742e+01 9.87527036e+01
 2.65206801e-01 2.41963088e+00 8.27418891e-01]
E = -128.53771524911934
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787163        1
[INPUT] 0    0    [1    /1   ]  2712.09747984        1
[INPUT] 0    0    [1    /1   ]  617.487343221        1
[INPUT] 0    0    [1    /1   ]  174.984092283        1
[INPUT] 0    0    [1    /1   ]  20.5301668727        1
[INPUT] 0    0    [1    /1   ]  56.9269594115        1
[INPUT] 0    0    [1    /1   ]  0.487136571641       1
[INPUT] 0    0    [1    /1   ]  7.85032039094        1
[INPUT] 0    0    [1    /1   ]  1.65441056041        1
[INPUT] 1    0    [1    /1   ]  7.03451235648        1
[INPUT] 1    0    [1    /1   ]  22.9635742342        1
[INPUT] 1    0    [1    /1   ]  98.752703573         1
[INPUT] 1    0    [1    /1   ]  0.265206801145       1
[INPUT] 1    0    [1    /1   ]  2.4196308831         1
[INPUT] 1    0    [1    /1   ]  0.827418890977       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478716252168, 1.0]], [0, [2712.0974798394327, 1.0]], [0, [617.4873432212663, 1.0]], [0, [174.98409228269395, 1.0]], [0, [20.530166872673135, 1.0]], [0, [56.926959411475394, 1.0]], [0, [0.4871365716411854, 1.0]], [0, [7.850320390942342, 1.0]], [0, [1.6544105604066737, 1.0]], [1, [7.034512356475636, 1.0]], [1, [22.96357423422041, 1.0]], [1, [98.75270357296068, 1.0]], [1, [0.2652068011448871, 1.0]], [1, [2.4196308830969286, 1.0]], [1, [0.8274188909772823, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871625]
bas 1, expnt(s) = [2712.09747984]
bas 2, expnt(s) = [617.48734322]
bas 3, expnt(s) = [174.98409228]
bas 4, expnt(s) = [20.53016687]
bas 5, expnt(s) = [56.92695941]
bas 6, expnt(s) = [0.48713657]
bas 7, expnt(s) = [7.85032039]
bas 8, expnt(s) = [1.65441056]
bas 9, expnt(s) = [7.03451236]
bas 10, expnt(s) = [22.96357423]
bas 11, expnt(s) = [98.75270357]
bas 12, expnt(s) = [0.2652068]
bas 13, expnt(s) = [2.41963088]
bas 14, expnt(s) = [0.82741889]
CPU time:       268.65
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209748e+03 9.49497872e+02
 6.17487343e+02 3.12958008e+02 1.74984092e+02 1.21552516e+02
 2.05301669e+01 2.43674107e+01 5.69269594e+01 5.23604675e+01
 4.87136572e-01 1.47317071e+00 7.85032039e+00 1.18489689e+01
 1.65441056e+00 3.68550916e+00 7.03451236e+00 3.34215732e+01
 2.29635742e+01 1.46650568e+02 9.87527036e+01 9.08177285e+02
 2.65206801e-01 5.55220144e-01 2.41963088e+00 8.80381264e+00
 8.27418891e-01 2.30219010e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99918613823656
cond(S) = 240.6291899007103
E1 = -183.5868534017554  E_coul = 55.081454655493346
init E= -128.505398746262
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.775333324140312  LUMO = 0.819353577621816
  mo_energy =
[-3.25542531e+01 -1.85119328e+00 -7.75333324e-01 -7.75333324e-01
 -7.75333324e-01  8.19353578e-01  8.19353578e-01  8.19353578e-01
  2.06064659e+00  3.92445633e+00  3.92445633e+00  3.92445633e+00
  1.42066590e+01  1.42066590e+01  1.42066590e+01  1.94895572e+01
  5.24203751e+01  5.24203751e+01  5.24203751e+01  9.40371641e+01
  2.38131685e+02  2.38131685e+02  2.38131685e+02  3.56440389e+02
  1.34991134e+03  5.83637250e+03  3.50989402e+04]
E1 = -182.08987646023712  E_coul = 53.55566574080029
cycle= 1 E= -128.534210719437  delta_E= -0.0288  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503405
diis-c [-0.25341686  1.        ]
  HOMO = -0.883408913376774  LUMO = 0.793303568126534
  mo_energy =
[-3.28770129e+01 -1.96468303e+00 -8.83408913e-01 -8.83408913e-01
 -8.83408913e-01  7.93303568e-01  7.93303568e-01  7.93303568e-01
  1.98350317e+00  3.82843494e+00  3.82843494e+00  3.82843494e+00
  1.40176537e+01  1.40176537e+01  1.40176537e+01  1.92675680e+01
  5.21405589e+01  5.21405589e+01  5.21405589e+01  9.37330431e+01
  2.37786202e+02  2.37786202e+02  2.37786202e+02  3.56088849e+02
  1.34952161e+03  5.83595090e+03  3.50984970e+04]
E1 = -182.84920830232625  E_coul = 54.312403977052135
cycle= 2 E= -128.536804325274  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254201
diis-c [-6.05695498e-04  3.34748952e-01  6.65251048e-01]
  HOMO = -0.847826490087914  LUMO = 0.801928927473788
  mo_energy =
[-3.27690153e+01 -1.92712085e+00 -8.47826490e-01 -8.47826490e-01
 -8.47826490e-01  8.01928927e-01  8.01928927e-01  8.01928927e-01
  2.00880762e+00  3.85980226e+00  3.85980226e+00  3.85980226e+00
  1.40804447e+01  1.40804447e+01  1.40804447e+01  1.93419105e+01
  5.22343041e+01  5.22343041e+01  5.22343041e+01  9.38350303e+01
  2.37899669e+02  2.37899669e+02  2.37899669e+02  3.56203662e+02
  1.34964268e+03  5.83607492e+03  3.50986221e+04]
E1 = -182.5924530485177  E_coul = 54.054737817275125
cycle= 3 E= -128.537715231243  delta_E= -0.000911  |g|= 0.000469  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120506
diis-c [-1.09680553e-07 -2.15686765e-03  2.98138509e-04  1.00185873e+00]
  HOMO = -0.848048941900743  LUMO = 0.801903971997539
  mo_energy =
[-3.27694746e+01 -1.92728941e+00 -8.48048942e-01 -8.48048942e-01
 -8.48048942e-01  8.01903972e-01  8.01903972e-01  8.01903972e-01
  2.00872029e+00  3.85965646e+00  3.85965646e+00  3.85965646e+00
  1.40801681e+01  1.40801681e+01  1.40801681e+01  1.93416189e+01
  5.22339115e+01  5.22339115e+01  5.22339115e+01  9.38346014e+01
  2.37899133e+02  2.37899133e+02  2.37899133e+02  3.56203099e+02
  1.34964196e+03  5.83607409e+03  3.50986212e+04]
E1 = -182.5930599033827  E_coul = 54.05534465474406
cycle= 4 E= -128.537715248639  delta_E= -1.74e-08  |g|= 7.28e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000190197
diis-c [-4.86393754e-10  1.37405440e-04  5.00632921e-04 -1.30693035e-01
  1.13005500e+00]
  HOMO = -0.848083841475156  LUMO = 0.801893848340242
  mo_energy =
[-3.27695458e+01 -1.92731846e+00 -8.48083841e-01 -8.48083841e-01
 -8.48083841e-01  8.01893848e-01  8.01893848e-01  8.01893848e-01
  2.00869777e+00  3.85962379e+00  3.85962379e+00  3.85962379e+00
  1.40801159e+01  1.40801159e+01  1.40801159e+01  1.93415645e+01
  5.22338464e+01  5.22338464e+01  5.22338464e+01  9.38345329e+01
  2.37899057e+02  2.37899057e+02  2.37899057e+02  3.56203021e+02
  1.34964188e+03  5.83607399e+03  3.50986211e+04]
E1 = -182.59321508435931  E_coul = 54.05549983524061
cycle= 5 E= -128.537715249119  delta_E= -4.8e-10  |g|= 2.89e-06  |ddm|= 1.72e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59321508435931  E_coul = 54.05549983524061
  HOMO = -0.848082632050673  LUMO = 0.801894200986742
  mo_energy =
[-3.27695431e+01 -1.92731670e+00 -8.48082632e-01 -8.48082632e-01
 -8.48082632e-01  8.01894201e-01  8.01894201e-01  8.01894201e-01
  2.00869909e+00  3.85962495e+00  3.85962495e+00  3.85962495e+00
  1.40801180e+01  1.40801180e+01  1.40801180e+01  1.93415670e+01
  5.22338490e+01  5.22338490e+01  5.22338490e+01  9.38345355e+01
  2.37899059e+02  2.37899059e+02  2.37899059e+02  3.56203023e+02
  1.34964188e+03  5.83607400e+03  3.50986211e+04]
E1 = -182.59320857289956  E_coul = 54.05549332378021
Extra cycle  E= -128.537715249119  delta_E= -6.25e-13  |g|= 9.43e-07  |ddm|= 1.57e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 240.6291899007103
E1 = -182.59320857289956  E_coul = 54.05549332378021
init E= -128.537715249119
    CPU time for initialize scf      0.24 sec, wall time      0.24 sec
  HOMO = -0.848083102563323  LUMO = 0.801894094820459
  mo_energy =
[-3.27695446e+01 -1.92731710e+00 -8.48083103e-01 -8.48083103e-01
 -8.48083103e-01  8.01894095e-01  8.01894095e-01  8.01894095e-01
  2.00869884e+00  3.85962455e+00  3.85962455e+00  3.85962455e+00
  1.40801172e+01  1.40801172e+01  1.40801172e+01  1.93415661e+01
  5.22338477e+01  5.22338477e+01  5.22338477e+01  9.38345341e+01
  2.37899058e+02  2.37899058e+02  2.37899058e+02  3.56203022e+02
  1.34964188e+03  5.83607399e+03  3.50986211e+04]
E1 = -182.59321219368678  E_coul = 54.05549694456732
cycle= 1 E= -128.537715249119  delta_E= -1.14e-13  |g|= 5.01e-07  |ddm|= 3.37e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59321219368678  E_coul = 54.05549694456732
  HOMO = -0.848082849264702  LUMO = 0.801894157970258
  mo_energy =
[-3.27695438e+01 -1.92731681e+00 -8.48082849e-01 -8.48082849e-01
 -8.48082849e-01  8.01894158e-01  8.01894158e-01  8.01894158e-01
  2.00869904e+00  3.85962478e+00  3.85962478e+00  3.85962478e+00
  1.40801176e+01  1.40801176e+01  1.40801176e+01  1.93415666e+01
  5.22338484e+01  5.22338484e+01  5.22338484e+01  9.38345348e+01
  2.37899058e+02  2.37899058e+02  2.37899058e+02  3.56203022e+02
  1.34964188e+03  5.83607399e+03  3.50986211e+04]
E1 = -182.59321040006796  E_coul = 54.05549515094818
Extra cycle  E= -128.53771524912  delta_E= -3.13e-13  |g|= 2.43e-07  |ddm|= 2.03e-07
    CPU time for scf_cycle      0.30 sec, wall time      0.29 sec
exp = [1.80764787e+04 2.71209748e+03 6.17487343e+02 1.74984092e+02
 2.05301669e+01 5.69269594e+01 4.87136572e-01 7.85032039e+00
 1.65441056e+00 7.03451236e+00 2.29635742e+01 9.87527036e+01
 2.65206801e-01 2.41963088e+00 8.27418891e-01]
grad_E = [-1.13953540e-09  5.86126792e-08 -1.05886611e-06  9.54046425e-06
  7.68254057e-05 -4.37286127e-05 -1.06664602e-03 -2.44257973e-05
  2.46712924e-04 -3.47984275e-04  5.46268958e-05 -2.69703028e-06
  8.05295979e-04  7.77979414e-04 -1.04174747e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.478717         1
[INPUT] 0    0    [1    /1   ]  2712.09744122        1
[INPUT] 0    0    [1    /1   ]  617.488062131        1
[INPUT] 0    0    [1    /1   ]  174.977120346        1
[INPUT] 0    0    [1    /1   ]  20.4871671572        1
[INPUT] 0    0    [1    /1   ]  56.960869948         1
[INPUT] 0    0    [1    /1   ]  0.487158129686       1
[INPUT] 0    0    [1    /1   ]  7.81813368466        1
[INPUT] 0    0    [1    /1   ]  1.65429044651        1
[INPUT] 1    0    [1    /1   ]  7.06702654576        1
[INPUT] 1    0    [1    /1   ]  23.0618150734        1
[INPUT] 1    0    [1    /1   ]  99.2621107157        1
[INPUT] 1    0    [1    /1   ]  0.26574582147        1
[INPUT] 1    0    [1    /1   ]  2.42797985428        1
[INPUT] 1    0    [1    /1   ]  0.829735726792       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478716987447, 1.0]], [0, [2712.097441221899, 1.0]], [0, [617.4880621314106, 1.0]], [0, [174.97712034560718, 1.0]], [0, [20.487167157165533, 1.0]], [0, [56.960869948046636, 1.0]], [0, [0.4871581296857586, 1.0]], [0, [7.818133684658084, 1.0]], [0, [1.6542904465062414, 1.0]], [1, [7.067026545758675, 1.0]], [1, [23.06181507343799, 1.0]], [1, [99.26211071569013, 1.0]], [1, [0.26574582147024217, 1.0]], [1, [2.427979854280201, 1.0]], [1, [0.8297357267918334, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871699]
bas 1, expnt(s) = [2712.09744122]
bas 2, expnt(s) = [617.48806213]
bas 3, expnt(s) = [174.97712035]
bas 4, expnt(s) = [20.48716716]
bas 5, expnt(s) = [56.96086995]
bas 6, expnt(s) = [0.48715813]
bas 7, expnt(s) = [7.81813368]
bas 8, expnt(s) = [1.65429045]
bas 9, expnt(s) = [7.06702655]
bas 10, expnt(s) = [23.06181507]
bas 11, expnt(s) = [99.26211072]
bas 12, expnt(s) = [0.26574582]
bas 13, expnt(s) = [2.42797985]
bas 14, expnt(s) = [0.82973573]
CPU time:       272.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209744e+03 9.49497862e+02
 6.17488062e+02 3.12958282e+02 1.74977120e+02 1.21548883e+02
 2.04871672e+01 2.43291232e+01 5.69608699e+01 5.23838585e+01
 4.87158130e-01 1.47321961e+00 7.81813368e+00 1.18125142e+01
 1.65429045e+00 3.68530847e+00 7.06702655e+00 3.36147817e+01
 2.30618151e+01 1.47435222e+02 9.92621107e+01 9.14036997e+02
 2.65745821e-01 5.56631075e-01 2.42797985e+00 8.84180110e+00
 8.29735727e-01 2.31025081e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999182063088817
cond(S) = 239.22748436830668
E1 = -183.58678329021387  E_coul = 55.08142170921322
init E= -128.505361581001
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775335917890408  LUMO = 0.821638020052235
  mo_energy =
[-3.25542605e+01 -1.85119512e+00 -7.75335918e-01 -7.75335918e-01
 -7.75335918e-01  8.21638020e-01  8.21638020e-01  8.21638020e-01
  2.06002923e+00  3.93706972e+00  3.93706972e+00  3.93706972e+00
  1.42665024e+01  1.42665024e+01  1.42665024e+01  1.94263831e+01
  5.26744218e+01  5.26744218e+01  5.26744218e+01  9.38513400e+01
  2.39423344e+02  2.39423344e+02  2.39423344e+02  3.56242266e+02
  1.34974043e+03  5.83622298e+03  3.50988167e+04]
E1 = -182.09034177496855  E_coul = 53.55612415339325
cycle= 1 E= -128.534217621575  delta_E= -0.0289  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503081
diis-c [-0.25309096  1.        ]
  HOMO = -0.883372453735753  LUMO = 0.79549764452784
  mo_energy =
[-3.28769333e+01 -1.96464443e+00 -8.83372454e-01 -8.83372454e-01
 -8.83372454e-01  7.95497645e-01  7.95497645e-01  7.95497645e-01
  1.98296112e+00  3.84081260e+00  3.84081260e+00  3.84081260e+00
  1.40771547e+01  1.40771547e+01  1.40771547e+01  1.92047553e+01
  5.23944061e+01  5.23944061e+01  5.23944061e+01  9.35473497e+01
  2.39077771e+02  2.39077771e+02  2.39077771e+02  3.55890801e+02
  1.34935077e+03  5.83580145e+03  3.50983736e+04]
E1 = -182.84934982116965  E_coul = 54.31254005319757
cycle= 2 E= -128.536809767972  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.254004
diis-c [-6.05150845e-04  3.34718884e-01  6.65281116e-01]
  HOMO = -0.847804465716969  LUMO = 0.804151661007809
  mo_energy =
[-3.27689730e+01 -1.92709802e+00 -8.47804466e-01 -8.47804466e-01
 -8.47804466e-01  8.04151661e-01  8.04151661e-01  8.04151661e-01
  2.00823861e+00  3.87225653e+00  3.87225653e+00  3.87225653e+00
  1.41400584e+01  1.41400584e+01  1.41400584e+01  1.92789695e+01
  5.24882103e+01  5.24882103e+01  5.24882103e+01  9.36492827e+01
  2.39191240e+02  2.39191240e+02  2.39191240e+02  3.56005576e+02
  1.34947180e+03  5.83592543e+03  3.50984987e+04]
E1 = -182.592712962392  E_coul = 54.05499305357316
cycle= 3 E= -128.537719908819  delta_E= -0.00091  |g|= 0.00047  |ddm|= 0.0254
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00120733
diis-c [-1.09610438e-07 -2.16026352e-03  3.03855335e-04  1.00185641e+00]
  HOMO = -0.848027574415857  LUMO = 0.804126300118651
  mo_energy =
[-3.27694339e+01 -1.92726761e+00 -8.48027574e-01 -8.48027574e-01
 -8.48027574e-01  8.04126300e-01  8.04126300e-01  8.04126300e-01
  2.00815046e+00  3.87210957e+00  3.87210957e+00  3.87210957e+00
  1.41397801e+01  1.41397801e+01  1.41397801e+01  1.92786771e+01
  5.24878158e+01  5.24878158e+01  5.24878158e+01  9.36488523e+01
  2.39190702e+02  2.39190702e+02  2.39190702e+02  3.56005011e+02
  1.34947109e+03  5.83592459e+03  3.50984978e+04]
E1 = -182.5933227451583  E_coul = 54.05560281887921
cycle= 4 E= -128.537719926279  delta_E= -1.75e-08  |g|= 7.28e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00018974
diis-c [-4.81805796e-10  1.36543910e-04  4.98214529e-04 -1.30120598e-01
  1.12948584e+00]
  HOMO = -0.848062462364468  LUMO = 0.804116137557999
  mo_energy =
[-3.27695050e+01 -1.92729672e+00 -8.48062462e-01 -8.48062462e-01
 -8.48062462e-01  8.04116138e-01  8.04116138e-01  8.04116138e-01
  2.00812789e+00  3.87207683e+00  3.87207683e+00  3.87207683e+00
  1.41397279e+01  1.41397279e+01  1.41397279e+01  1.92786228e+01
  5.24877507e+01  5.24877507e+01  5.24877507e+01  9.36487837e+01
  2.39190626e+02  2.39190626e+02  2.39190626e+02  3.56004933e+02
  1.34947100e+03  5.83592450e+03  3.50984977e+04]
E1 = -182.5934776204756  E_coul = 54.055757693719045
cycle= 5 E= -128.537719926757  delta_E= -4.77e-10  |g|= 2.87e-06  |ddm|= 1.71e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5934776204756  E_coul = 54.055757693719045
  HOMO = -0.848061262766274  LUMO = 0.804116488127298
  mo_energy =
[-3.27695023e+01 -1.92729498e+00 -8.48061263e-01 -8.48061263e-01
 -8.48061263e-01  8.04116488e-01  8.04116488e-01  8.04116488e-01
  2.00812919e+00  3.87207798e+00  3.87207798e+00  3.87207798e+00
  1.41397299e+01  1.41397299e+01  1.41397299e+01  1.92786252e+01
  5.24877532e+01  5.24877532e+01  5.24877532e+01  9.36487863e+01
  2.39190628e+02  2.39190628e+02  2.39190628e+02  3.56004935e+02
  1.34947100e+03  5.83592450e+03  3.50984977e+04]
E1 = -182.5934711354087  E_coul = 54.05575120865125
Extra cycle  E= -128.537719926757  delta_E= -8.81e-13  |g|= 9.38e-07  |ddm|= 1.56e-06
    CPU time for scf_cycle      0.15 sec, wall time      0.15 sec
exp = [1.80764787e+04 2.71209744e+03 6.17488062e+02 1.74977120e+02
 2.04871672e+01 5.69608699e+01 4.87158130e-01 7.81813368e+00
 1.65429045e+00 7.06702655e+00 2.30618151e+01 9.92621107e+01
 2.65745821e-01 2.42797985e+00 8.29735727e-01]
E = -128.53771992675743
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.478717         1
[INPUT] 0    0    [1    /1   ]  2712.09744122        1
[INPUT] 0    0    [1    /1   ]  617.488062131        1
[INPUT] 0    0    [1    /1   ]  174.977120346        1
[INPUT] 0    0    [1    /1   ]  20.4871671572        1
[INPUT] 0    0    [1    /1   ]  56.960869948         1
[INPUT] 0    0    [1    /1   ]  0.487158129686       1
[INPUT] 0    0    [1    /1   ]  7.81813368466        1
[INPUT] 0    0    [1    /1   ]  1.65429044651        1
[INPUT] 1    0    [1    /1   ]  7.06702654576        1
[INPUT] 1    0    [1    /1   ]  23.0618150734        1
[INPUT] 1    0    [1    /1   ]  99.2621107157        1
[INPUT] 1    0    [1    /1   ]  0.26574582147        1
[INPUT] 1    0    [1    /1   ]  2.42797985428        1
[INPUT] 1    0    [1    /1   ]  0.829735726792       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478716987447, 1.0]], [0, [2712.097441221899, 1.0]], [0, [617.4880621314106, 1.0]], [0, [174.97712034560718, 1.0]], [0, [20.487167157165533, 1.0]], [0, [56.960869948046636, 1.0]], [0, [0.4871581296857586, 1.0]], [0, [7.818133684658084, 1.0]], [0, [1.6542904465062414, 1.0]], [1, [7.067026545758675, 1.0]], [1, [23.06181507343799, 1.0]], [1, [99.26211071569013, 1.0]], [1, [0.26574582147024217, 1.0]], [1, [2.427979854280201, 1.0]], [1, [0.8297357267918334, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871699]
bas 1, expnt(s) = [2712.09744122]
bas 2, expnt(s) = [617.48806213]
bas 3, expnt(s) = [174.97712035]
bas 4, expnt(s) = [20.48716716]
bas 5, expnt(s) = [56.96086995]
bas 6, expnt(s) = [0.48715813]
bas 7, expnt(s) = [7.81813368]
bas 8, expnt(s) = [1.65429045]
bas 9, expnt(s) = [7.06702655]
bas 10, expnt(s) = [23.06181507]
bas 11, expnt(s) = [99.26211072]
bas 12, expnt(s) = [0.26574582]
bas 13, expnt(s) = [2.42797985]
bas 14, expnt(s) = [0.82973573]
CPU time:       273.12
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209744e+03 9.49497862e+02
 6.17488062e+02 3.12958282e+02 1.74977120e+02 1.21548883e+02
 2.04871672e+01 2.43291232e+01 5.69608699e+01 5.23838585e+01
 4.87158130e-01 1.47321961e+00 7.81813368e+00 1.18125142e+01
 1.65429045e+00 3.68530847e+00 7.06702655e+00 3.36147817e+01
 2.30618151e+01 1.47435222e+02 9.92621107e+01 9.14036997e+02
 2.65745821e-01 5.56631075e-01 2.42797985e+00 8.84180110e+00
 8.29735727e-01 2.31025081e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999182063088817
cond(S) = 239.22748436830668
E1 = -183.58678329021387  E_coul = 55.08142170921322
init E= -128.505361581001
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775335917890408  LUMO = 0.821638020052235
  mo_energy =
[-3.25542605e+01 -1.85119512e+00 -7.75335918e-01 -7.75335918e-01
 -7.75335918e-01  8.21638020e-01  8.21638020e-01  8.21638020e-01
  2.06002923e+00  3.93706972e+00  3.93706972e+00  3.93706972e+00
  1.42665024e+01  1.42665024e+01  1.42665024e+01  1.94263831e+01
  5.26744218e+01  5.26744218e+01  5.26744218e+01  9.38513400e+01
  2.39423344e+02  2.39423344e+02  2.39423344e+02  3.56242266e+02
  1.34974043e+03  5.83622298e+03  3.50988167e+04]
E1 = -182.09034177496855  E_coul = 53.55612415339325
cycle= 1 E= -128.534217621575  delta_E= -0.0289  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.503081
diis-c [-0.25309096  1.        ]
  HOMO = -0.883372453735753  LUMO = 0.79549764452784
  mo_energy =
[-3.28769333e+01 -1.96464443e+00 -8.83372454e-01 -8.83372454e-01
 -8.83372454e-01  7.95497645e-01  7.95497645e-01  7.95497645e-01
  1.98296112e+00  3.84081260e+00  3.84081260e+00  3.84081260e+00
  1.40771547e+01  1.40771547e+01  1.40771547e+01  1.92047553e+01
  5.23944061e+01  5.23944061e+01  5.23944061e+01  9.35473497e+01
  2.39077771e+02  2.39077771e+02  2.39077771e+02  3.55890801e+02
  1.34935077e+03  5.83580145e+03  3.50983736e+04]
E1 = -182.84934982116965  E_coul = 54.31254005319757
cycle= 2 E= -128.536809767972  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.254004
diis-c [-6.05150845e-04  3.34718884e-01  6.65281116e-01]
  HOMO = -0.847804465716969  LUMO = 0.804151661007809
  mo_energy =
[-3.27689730e+01 -1.92709802e+00 -8.47804466e-01 -8.47804466e-01
 -8.47804466e-01  8.04151661e-01  8.04151661e-01  8.04151661e-01
  2.00823861e+00  3.87225653e+00  3.87225653e+00  3.87225653e+00
  1.41400584e+01  1.41400584e+01  1.41400584e+01  1.92789695e+01
  5.24882103e+01  5.24882103e+01  5.24882103e+01  9.36492827e+01
  2.39191240e+02  2.39191240e+02  2.39191240e+02  3.56005576e+02
  1.34947180e+03  5.83592543e+03  3.50984987e+04]
E1 = -182.592712962392  E_coul = 54.05499305357316
cycle= 3 E= -128.537719908819  delta_E= -0.00091  |g|= 0.00047  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120733
diis-c [-1.09610438e-07 -2.16026352e-03  3.03855335e-04  1.00185641e+00]
  HOMO = -0.848027574415857  LUMO = 0.804126300118651
  mo_energy =
[-3.27694339e+01 -1.92726761e+00 -8.48027574e-01 -8.48027574e-01
 -8.48027574e-01  8.04126300e-01  8.04126300e-01  8.04126300e-01
  2.00815046e+00  3.87210957e+00  3.87210957e+00  3.87210957e+00
  1.41397801e+01  1.41397801e+01  1.41397801e+01  1.92786771e+01
  5.24878158e+01  5.24878158e+01  5.24878158e+01  9.36488523e+01
  2.39190702e+02  2.39190702e+02  2.39190702e+02  3.56005011e+02
  1.34947109e+03  5.83592459e+03  3.50984978e+04]
E1 = -182.5933227451583  E_coul = 54.05560281887921
cycle= 4 E= -128.537719926279  delta_E= -1.75e-08  |g|= 7.28e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018974
diis-c [-4.81805796e-10  1.36543910e-04  4.98214529e-04 -1.30120598e-01
  1.12948584e+00]
  HOMO = -0.848062462364468  LUMO = 0.804116137557999
  mo_energy =
[-3.27695050e+01 -1.92729672e+00 -8.48062462e-01 -8.48062462e-01
 -8.48062462e-01  8.04116138e-01  8.04116138e-01  8.04116138e-01
  2.00812789e+00  3.87207683e+00  3.87207683e+00  3.87207683e+00
  1.41397279e+01  1.41397279e+01  1.41397279e+01  1.92786228e+01
  5.24877507e+01  5.24877507e+01  5.24877507e+01  9.36487837e+01
  2.39190626e+02  2.39190626e+02  2.39190626e+02  3.56004933e+02
  1.34947100e+03  5.83592450e+03  3.50984977e+04]
E1 = -182.5934776204756  E_coul = 54.055757693719045
cycle= 5 E= -128.537719926757  delta_E= -4.77e-10  |g|= 2.87e-06  |ddm|= 1.71e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5934776204756  E_coul = 54.055757693719045
  HOMO = -0.848061262766274  LUMO = 0.804116488127298
  mo_energy =
[-3.27695023e+01 -1.92729498e+00 -8.48061263e-01 -8.48061263e-01
 -8.48061263e-01  8.04116488e-01  8.04116488e-01  8.04116488e-01
  2.00812919e+00  3.87207798e+00  3.87207798e+00  3.87207798e+00
  1.41397299e+01  1.41397299e+01  1.41397299e+01  1.92786252e+01
  5.24877532e+01  5.24877532e+01  5.24877532e+01  9.36487863e+01
  2.39190628e+02  2.39190628e+02  2.39190628e+02  3.56004935e+02
  1.34947100e+03  5.83592450e+03  3.50984977e+04]
E1 = -182.5934711354087  E_coul = 54.05575120865125
Extra cycle  E= -128.537719926757  delta_E= -8.81e-13  |g|= 9.38e-07  |ddm|= 1.56e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.22748436830668
E1 = -182.5934711354087  E_coul = 54.05575120865125
init E= -128.537719926757
    CPU time for initialize scf      0.25 sec, wall time      0.24 sec
  HOMO = -0.84806173144266  LUMO = 0.80411638185641
  mo_energy =
[-3.27695038e+01 -1.92729538e+00 -8.48061731e-01 -8.48061731e-01
 -8.48061731e-01  8.04116382e-01  8.04116382e-01  8.04116382e-01
  2.00812894e+00  3.87207758e+00  3.87207758e+00  3.87207758e+00
  1.41397291e+01  1.41397291e+01  1.41397291e+01  1.92786243e+01
  5.24877520e+01  5.24877520e+01  5.24877520e+01  9.36487850e+01
  2.39190627e+02  2.39190627e+02  2.39190627e+02  3.56004934e+02
  1.34947100e+03  5.83592450e+03  3.50984977e+04]
E1 = -182.593474737244  E_coul = 54.05575481048664
cycle= 1 E= -128.537719926757  delta_E= 5.68e-14  |g|= 4.98e-07  |ddm|= 3.35e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.593474737244  E_coul = 54.05575481048664
  HOMO = -0.848061479484589  LUMO = 0.804116444887712
  mo_energy =
[-3.27695030e+01 -1.92729510e+00 -8.48061479e-01 -8.48061479e-01
 -8.48061479e-01  8.04116445e-01  8.04116445e-01  8.04116445e-01
  2.00812914e+00  3.87207781e+00  3.87207781e+00  3.87207781e+00
  1.41397296e+01  1.41397296e+01  1.41397296e+01  1.92786248e+01
  5.24877527e+01  5.24877527e+01  5.24877527e+01  9.36487857e+01
  2.39190627e+02  2.39190627e+02  2.39190627e+02  3.56004935e+02
  1.34947100e+03  5.83592450e+03  3.50984977e+04]
E1 = -182.5934729525861  E_coul = 54.05575302582865
Extra cycle  E= -128.537719926757  delta_E= -8.53e-14  |g|= 2.42e-07  |ddm|= 2.02e-07
    CPU time for scf_cycle      0.31 sec, wall time      0.30 sec
exp = [1.80764787e+04 2.71209744e+03 6.17488062e+02 1.74977120e+02
 2.04871672e+01 5.69608699e+01 4.87158130e-01 7.81813368e+00
 1.65429045e+00 7.06702655e+00 2.30618151e+01 9.92621107e+01
 2.65745821e-01 2.42797985e+00 8.29735727e-01]
grad_E = [-4.64016892e-10  2.35233740e-08 -3.96864427e-07  3.06443498e-06
  3.23337372e-05 -1.36205922e-05 -8.20578969e-04 -3.98677629e-05
  1.95416947e-04 -2.37660528e-04  3.77347862e-05 -1.69315126e-06
  6.14719109e-04  5.33217663e-04 -7.29635705e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787171        1
[INPUT] 0    0    [1    /1   ]  2712.09743259        1
[INPUT] 0    0    [1    /1   ]  617.488228465        1
[INPUT] 0    0    [1    /1   ]  174.975340447        1
[INPUT] 0    0    [1    /1   ]  20.4728573451        1
[INPUT] 0    0    [1    /1   ]  56.9714218755        1
[INPUT] 0    0    [1    /1   ]  0.487410678586       1
[INPUT] 0    0    [1    /1   ]  7.81060796492        1
[INPUT] 0    0    [1    /1   ]  1.65432686826        1
[INPUT] 1    0    [1    /1   ]  7.09997087651        1
[INPUT] 1    0    [1    /1   ]  23.1408322439        1
[INPUT] 1    0    [1    /1   ]  99.6453868379        1
[INPUT] 1    0    [1    /1   ]  0.266248367767       1
[INPUT] 1    0    [1    /1   ]  2.43622569211        1
[INPUT] 1    0    [1    /1   ]  0.832006910222       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47871714545, 1.0]], [0, [2712.097432593214, 1.0]], [0, [617.4882284646309, 1.0]], [0, [174.97534044711458, 1.0]], [0, [20.472857345105545, 1.0]], [0, [56.97142187551018, 1.0]], [0, [0.4874106785857836, 1.0]], [0, [7.810607964924548, 1.0]], [0, [1.6543268682628292, 1.0]], [1, [7.099970876505757, 1.0]], [1, [23.140832243881356, 1.0]], [1, [99.64538683785035, 1.0]], [1, [0.26624836776650146, 1.0]], [1, [2.4362256921071834, 1.0]], [1, [0.8320069102219975, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871715]
bas 1, expnt(s) = [2712.09743259]
bas 2, expnt(s) = [617.48822846]
bas 3, expnt(s) = [174.97534045]
bas 4, expnt(s) = [20.47285735]
bas 5, expnt(s) = [56.97142188]
bas 6, expnt(s) = [0.48741068]
bas 7, expnt(s) = [7.81060796]
bas 8, expnt(s) = [1.65432687]
bas 9, expnt(s) = [7.09997088]
bas 10, expnt(s) = [23.14083224]
bas 11, expnt(s) = [99.64538684]
bas 12, expnt(s) = [0.26624837]
bas 13, expnt(s) = [2.43622569]
bas 14, expnt(s) = [0.83200691]
CPU time:       276.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209743e+03 9.49497859e+02
 6.17488228e+02 3.12958345e+02 1.74975340e+02 1.21547956e+02
 2.04728573e+01 2.43163771e+01 5.69714219e+01 5.23911363e+01
 4.87410679e-01 1.47379237e+00 7.81060796e+00 1.18039851e+01
 1.65432687e+00 3.68536932e+00 7.09997088e+00 3.38107731e+01
 2.31408322e+01 1.48066943e+02 9.96453868e+01 9.18450784e+02
 2.66248368e-01 5.57947178e-01 2.43622569e+00 8.87935237e+00
 8.32006910e-01 2.31815814e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99917740149925
cond(S) = 238.8936411965133
E1 = -183.5867307721296  E_coul = 55.08139803700778
init E= -128.505332735122
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.775336944972313  LUMO = 0.823817104359378
  mo_energy =
[-3.25542650e+01 -1.85119785e+00 -7.75336945e-01 -7.75336945e-01
 -7.75336945e-01  8.23817104e-01  8.23817104e-01  8.23817104e-01
  2.06079360e+00  3.94929571e+00  3.94929571e+00  3.94929571e+00
  1.43260992e+01  1.43260992e+01  1.43260992e+01  1.94116800e+01
  5.29053657e+01  5.29053657e+01  5.29053657e+01  9.38014895e+01
  2.40443721e+02  2.40443721e+02  2.40443721e+02  3.56188290e+02
  1.34969473e+03  5.83618331e+03  3.50987840e+04]
E1 = -182.0909523849496  E_coul = 53.5567300226355
cycle= 1 E= -128.534222362314  delta_E= -0.0289  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502739
diis-c [-0.25274656  1.        ]
  HOMO = -0.883321931153285  LUMO = 0.797591581670093
  mo_energy =
[-3.28768247e+01 -1.96460180e+00 -8.83321931e-01 -8.83321931e-01
 -8.83321931e-01  7.97591582e-01  7.97591582e-01  7.97591582e-01
  1.98375181e+00  3.85281916e+00  3.85281916e+00  3.85281916e+00
  1.41364316e+01  1.41364316e+01  1.41364316e+01  1.91902198e+01
  5.26252228e+01  5.26252228e+01  5.26252228e+01  9.34976197e+01
  2.40098142e+02  2.40098142e+02  2.40098142e+02  3.55836941e+02
  1.34930519e+03  5.83576189e+03  3.50983410e+04]
E1 = -182.8495557947426  E_coul = 54.31274322075852
cycle= 2 E= -128.536812573984  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253802
diis-c [-6.04971450e-04  3.34692409e-01  6.65307591e-01]
  HOMO = -0.847772297502307  LUMO = 0.806272015968474
  mo_energy =
[-3.27689138e+01 -1.92707529e+00 -8.47772298e-01 -8.47772298e-01
 -8.47772298e-01  8.06272016e-01  8.06272016e-01  8.06272016e-01
  2.00901669e+00  3.88433423e+00  3.88433423e+00  3.88433423e+00
  1.41994390e+01  1.41994390e+01  1.41994390e+01  1.92643715e+01
  5.27190594e+01  5.27190594e+01  5.27190594e+01  9.35994999e+01
  2.40211590e+02  2.40211590e+02  2.40211590e+02  3.55951665e+02
  1.34942617e+03  5.83588582e+03  3.50984660e+04]
E1 = -182.5930644439647  E_coul = 54.05534269157718
cycle= 3 E= -128.537721752388  delta_E= -0.000909  |g|= 0.000471  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120576
diis-c [-1.08453689e-07 -2.16293313e-03  2.97222823e-04  1.00186571e+00]
  HOMO = -0.847996029211658  LUMO = 0.806246135761406
  mo_energy =
[-3.27693762e+01 -1.92724658e+00 -8.47996029e-01 -8.47996029e-01
 -8.47996029e-01  8.06246136e-01  8.06246136e-01  8.06246136e-01
  2.00892705e+00  3.88418600e+00  3.88418600e+00  3.88418600e+00
  1.41991590e+01  1.41991590e+01  1.41991590e+01  1.92640778e+01
  5.27186632e+01  5.27186632e+01  5.27186632e+01  9.35990681e+01
  2.40211050e+02  2.40211050e+02  2.40211050e+02  3.55951098e+02
  1.34942545e+03  5.83588498e+03  3.50984651e+04]
E1 = -182.59367458337817  E_coul = 54.0559528135578
cycle= 4 E= -128.53772176982  delta_E= -1.74e-08  |g|= 7.24e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000188276
diis-c [-4.69256690e-10  1.33595202e-04  4.93990893e-04 -1.28362713e-01
  1.12773513e+00]
  HOMO = -0.848030843773527  LUMO = 0.806235932030674
  mo_energy =
[-3.27694470e+01 -1.92727586e+00 -8.48030844e-01 -8.48030844e-01
 -8.48030844e-01  8.06235932e-01  8.06235932e-01  8.06235932e-01
  2.00890431e+00  3.88415321e+00  3.88415321e+00  3.88415321e+00
  1.41991068e+01  1.41991068e+01  1.41991068e+01  1.92640236e+01
  5.27185982e+01  5.27185982e+01  5.27185982e+01  9.35989998e+01
  2.40210974e+02  2.40210974e+02  2.40210974e+02  3.55951021e+02
  1.34942536e+03  5.83588489e+03  3.50984650e+04]
E1 = -182.5938282526297  E_coul = 54.05610648233934
cycle= 5 E= -128.53772177029  delta_E= -4.7e-10  |g|= 2.79e-06  |ddm|= 1.69e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5938282526297  E_coul = 54.05610648233934
  HOMO = -0.848029687617581  LUMO = 0.806236269278882
  mo_energy =
[-3.27694444e+01 -1.92727418e+00 -8.48029688e-01 -8.48029688e-01
 -8.48029688e-01  8.06236269e-01  8.06236269e-01  8.06236269e-01
  2.00890557e+00  3.88415432e+00  3.88415432e+00  3.88415432e+00
  1.41991087e+01  1.41991087e+01  1.41991087e+01  1.92640260e+01
  5.27186007e+01  5.27186007e+01  5.27186007e+01  9.35990023e+01
  2.40210976e+02  2.40210976e+02  2.40210976e+02  3.55951023e+02
  1.34942537e+03  5.83588489e+03  3.50984650e+04]
E1 = -182.59382190620036  E_coul = 54.05610013590957
Extra cycle  E= -128.537721770291  delta_E= -4.55e-13  |g|= 9.16e-07  |ddm|= 1.52e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [1.80764787e+04 2.71209743e+03 6.17488228e+02 1.74975340e+02
 2.04728573e+01 5.69714219e+01 4.87410679e-01 7.81060796e+00
 1.65432687e+00 7.09997088e+00 2.31408322e+01 9.96453868e+01
 2.66248368e-01 2.43622569e+00 8.32006910e-01]
E = -128.5377217702908
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.4787171        1
[INPUT] 0    0    [1    /1   ]  2712.09743259        1
[INPUT] 0    0    [1    /1   ]  617.488228465        1
[INPUT] 0    0    [1    /1   ]  174.975340447        1
[INPUT] 0    0    [1    /1   ]  20.4728573451        1
[INPUT] 0    0    [1    /1   ]  56.9714218755        1
[INPUT] 0    0    [1    /1   ]  0.487410678586       1
[INPUT] 0    0    [1    /1   ]  7.81060796492        1
[INPUT] 0    0    [1    /1   ]  1.65432686826        1
[INPUT] 1    0    [1    /1   ]  7.09997087651        1
[INPUT] 1    0    [1    /1   ]  23.1408322439        1
[INPUT] 1    0    [1    /1   ]  99.6453868379        1
[INPUT] 1    0    [1    /1   ]  0.266248367767       1
[INPUT] 1    0    [1    /1   ]  2.43622569211        1
[INPUT] 1    0    [1    /1   ]  0.832006910222       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.47871714545, 1.0]], [0, [2712.097432593214, 1.0]], [0, [617.4882284646309, 1.0]], [0, [174.97534044711458, 1.0]], [0, [20.472857345105545, 1.0]], [0, [56.97142187551018, 1.0]], [0, [0.4874106785857836, 1.0]], [0, [7.810607964924548, 1.0]], [0, [1.6543268682628292, 1.0]], [1, [7.099970876505757, 1.0]], [1, [23.140832243881356, 1.0]], [1, [99.64538683785035, 1.0]], [1, [0.26624836776650146, 1.0]], [1, [2.4362256921071834, 1.0]], [1, [0.8320069102219975, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871715]
bas 1, expnt(s) = [2712.09743259]
bas 2, expnt(s) = [617.48822846]
bas 3, expnt(s) = [174.97534045]
bas 4, expnt(s) = [20.47285735]
bas 5, expnt(s) = [56.97142188]
bas 6, expnt(s) = [0.48741068]
bas 7, expnt(s) = [7.81060796]
bas 8, expnt(s) = [1.65432687]
bas 9, expnt(s) = [7.09997088]
bas 10, expnt(s) = [23.14083224]
bas 11, expnt(s) = [99.64538684]
bas 12, expnt(s) = [0.26624837]
bas 13, expnt(s) = [2.43622569]
bas 14, expnt(s) = [0.83200691]
CPU time:       277.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209743e+03 9.49497859e+02
 6.17488228e+02 3.12958345e+02 1.74975340e+02 1.21547956e+02
 2.04728573e+01 2.43163771e+01 5.69714219e+01 5.23911363e+01
 4.87410679e-01 1.47379237e+00 7.81060796e+00 1.18039851e+01
 1.65432687e+00 3.68536932e+00 7.09997088e+00 3.38107731e+01
 2.31408322e+01 1.48066943e+02 9.96453868e+01 9.18450784e+02
 2.66248368e-01 5.57947178e-01 2.43622569e+00 8.87935237e+00
 8.32006910e-01 2.31815814e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99917740149925
cond(S) = 238.8936411965133
E1 = -183.5867307721296  E_coul = 55.08139803700778
init E= -128.505332735122
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775336944972313  LUMO = 0.823817104359378
  mo_energy =
[-3.25542650e+01 -1.85119785e+00 -7.75336945e-01 -7.75336945e-01
 -7.75336945e-01  8.23817104e-01  8.23817104e-01  8.23817104e-01
  2.06079360e+00  3.94929571e+00  3.94929571e+00  3.94929571e+00
  1.43260992e+01  1.43260992e+01  1.43260992e+01  1.94116800e+01
  5.29053657e+01  5.29053657e+01  5.29053657e+01  9.38014895e+01
  2.40443721e+02  2.40443721e+02  2.40443721e+02  3.56188290e+02
  1.34969473e+03  5.83618331e+03  3.50987840e+04]
E1 = -182.0909523849496  E_coul = 53.5567300226355
cycle= 1 E= -128.534222362314  delta_E= -0.0289  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502739
diis-c [-0.25274656  1.        ]
  HOMO = -0.883321931153285  LUMO = 0.797591581670093
  mo_energy =
[-3.28768247e+01 -1.96460180e+00 -8.83321931e-01 -8.83321931e-01
 -8.83321931e-01  7.97591582e-01  7.97591582e-01  7.97591582e-01
  1.98375181e+00  3.85281916e+00  3.85281916e+00  3.85281916e+00
  1.41364316e+01  1.41364316e+01  1.41364316e+01  1.91902198e+01
  5.26252228e+01  5.26252228e+01  5.26252228e+01  9.34976197e+01
  2.40098142e+02  2.40098142e+02  2.40098142e+02  3.55836941e+02
  1.34930519e+03  5.83576189e+03  3.50983410e+04]
E1 = -182.8495557947426  E_coul = 54.31274322075852
cycle= 2 E= -128.536812573984  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.253802
diis-c [-6.04971450e-04  3.34692409e-01  6.65307591e-01]
  HOMO = -0.847772297502307  LUMO = 0.806272015968474
  mo_energy =
[-3.27689138e+01 -1.92707529e+00 -8.47772298e-01 -8.47772298e-01
 -8.47772298e-01  8.06272016e-01  8.06272016e-01  8.06272016e-01
  2.00901669e+00  3.88433423e+00  3.88433423e+00  3.88433423e+00
  1.41994390e+01  1.41994390e+01  1.41994390e+01  1.92643715e+01
  5.27190594e+01  5.27190594e+01  5.27190594e+01  9.35994999e+01
  2.40211590e+02  2.40211590e+02  2.40211590e+02  3.55951665e+02
  1.34942617e+03  5.83588582e+03  3.50984660e+04]
E1 = -182.5930644439647  E_coul = 54.05534269157718
cycle= 3 E= -128.537721752388  delta_E= -0.000909  |g|= 0.000471  |ddm|= 0.0254
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00120576
diis-c [-1.08453689e-07 -2.16293313e-03  2.97222823e-04  1.00186571e+00]
  HOMO = -0.847996029211658  LUMO = 0.806246135761406
  mo_energy =
[-3.27693762e+01 -1.92724658e+00 -8.47996029e-01 -8.47996029e-01
 -8.47996029e-01  8.06246136e-01  8.06246136e-01  8.06246136e-01
  2.00892705e+00  3.88418600e+00  3.88418600e+00  3.88418600e+00
  1.41991590e+01  1.41991590e+01  1.41991590e+01  1.92640778e+01
  5.27186632e+01  5.27186632e+01  5.27186632e+01  9.35990681e+01
  2.40211050e+02  2.40211050e+02  2.40211050e+02  3.55951098e+02
  1.34942545e+03  5.83588498e+03  3.50984651e+04]
E1 = -182.59367458337817  E_coul = 54.0559528135578
cycle= 4 E= -128.53772176982  delta_E= -1.74e-08  |g|= 7.24e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000188276
diis-c [-4.69256690e-10  1.33595202e-04  4.93990893e-04 -1.28362713e-01
  1.12773513e+00]
  HOMO = -0.848030843773527  LUMO = 0.806235932030674
  mo_energy =
[-3.27694470e+01 -1.92727586e+00 -8.48030844e-01 -8.48030844e-01
 -8.48030844e-01  8.06235932e-01  8.06235932e-01  8.06235932e-01
  2.00890431e+00  3.88415321e+00  3.88415321e+00  3.88415321e+00
  1.41991068e+01  1.41991068e+01  1.41991068e+01  1.92640236e+01
  5.27185982e+01  5.27185982e+01  5.27185982e+01  9.35989998e+01
  2.40210974e+02  2.40210974e+02  2.40210974e+02  3.55951021e+02
  1.34942536e+03  5.83588489e+03  3.50984650e+04]
E1 = -182.5938282526297  E_coul = 54.05610648233934
cycle= 5 E= -128.53772177029  delta_E= -4.7e-10  |g|= 2.79e-06  |ddm|= 1.69e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.5938282526297  E_coul = 54.05610648233934
  HOMO = -0.848029687617581  LUMO = 0.806236269278882
  mo_energy =
[-3.27694444e+01 -1.92727418e+00 -8.48029688e-01 -8.48029688e-01
 -8.48029688e-01  8.06236269e-01  8.06236269e-01  8.06236269e-01
  2.00890557e+00  3.88415432e+00  3.88415432e+00  3.88415432e+00
  1.41991087e+01  1.41991087e+01  1.41991087e+01  1.92640260e+01
  5.27186007e+01  5.27186007e+01  5.27186007e+01  9.35990023e+01
  2.40210976e+02  2.40210976e+02  2.40210976e+02  3.55951023e+02
  1.34942537e+03  5.83588489e+03  3.50984650e+04]
E1 = -182.59382190620036  E_coul = 54.05610013590957
Extra cycle  E= -128.537721770291  delta_E= -4.55e-13  |g|= 9.16e-07  |ddm|= 1.52e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 238.8936411965133
E1 = -182.59382190620036  E_coul = 54.05610013590957
init E= -128.537721770291
    CPU time for initialize scf      0.28 sec, wall time      0.28 sec
  HOMO = -0.848030146736536  LUMO = 0.806236164397534
  mo_energy =
[-3.27694458e+01 -1.92727457e+00 -8.48030147e-01 -8.48030147e-01
 -8.48030147e-01  8.06236164e-01  8.06236164e-01  8.06236164e-01
  2.00890532e+00  3.88415392e+00  3.88415392e+00  3.88415392e+00
  1.41991079e+01  1.41991079e+01  1.41991079e+01  1.92640251e+01
  5.27185995e+01  5.27185995e+01  5.27185995e+01  9.35990010e+01
  2.40210975e+02  2.40210975e+02  2.40210975e+02  3.55951021e+02
  1.34942536e+03  5.83588489e+03  3.50984650e+04]
E1 = -182.5938254174489  E_coul = 54.05610364715817
cycle= 1 E= -128.537721770291  delta_E= 8.53e-14  |g|= 4.86e-07  |ddm|= 3.26e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5938254174489  E_coul = 54.05610364715817
  HOMO = -0.848029901172737  LUMO = 0.806236225998785
  mo_energy =
[-3.27694451e+01 -1.92727429e+00 -8.48029901e-01 -8.48029901e-01
 -8.48029901e-01  8.06236226e-01  8.06236226e-01  8.06236226e-01
  2.00890551e+00  3.88415415e+00  3.88415415e+00  3.88415415e+00
  1.41991084e+01  1.41991084e+01  1.41991084e+01  1.92640256e+01
  5.27186002e+01  5.27186002e+01  5.27186002e+01  9.35990017e+01
  2.40210976e+02  2.40210976e+02  2.40210976e+02  3.55951022e+02
  1.34942536e+03  5.83588489e+03  3.50984650e+04]
E1 = -182.59382367615046  E_coul = 54.05610190585935
Extra cycle  E= -128.537721770291  delta_E= -3.98e-13  |g|= 2.36e-07  |ddm|= 1.97e-07
    CPU time for scf_cycle      0.36 sec, wall time      0.36 sec
exp = [1.80764787e+04 2.71209743e+03 6.17488228e+02 1.74975340e+02
 2.04728573e+01 5.69714219e+01 4.87410679e-01 7.81060796e+00
 1.65432687e+00 7.09997088e+00 2.31408322e+01 9.96453868e+01
 2.66248368e-01 2.43622569e+00 8.32006910e-01]
grad_E = [-2.07429094e-10  1.01803185e-08 -1.42008763e-07  4.88512887e-07
  3.71244127e-06 -2.62349592e-07 -2.99438107e-04 -2.22246562e-05
  7.43551000e-05 -7.75809105e-05  1.25748307e-05 -5.01378084e-07
  2.25877110e-04  1.71904551e-04 -2.41857493e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.478717         1
[INPUT] 0    0    [1    /1   ]  2712.09743867        1
[INPUT] 0    0    [1    /1   ]  617.488119036        1
[INPUT] 0    0    [1    /1   ]  174.976293912        1
[INPUT] 0    0    [1    /1   ]  20.4765348505        1
[INPUT] 0    0    [1    /1   ]  56.9680154486        1
[INPUT] 0    0    [1    /1   ]  0.487564492904       1
[INPUT] 0    0    [1    /1   ]  7.81557821514        1
[INPUT] 0    0    [1    /1   ]  1.65436114641        1
[INPUT] 1    0    [1    /1   ]  7.11208141601        1
[INPUT] 1    0    [1    /1   ]  23.1630864681        1
[INPUT] 1    0    [1    /1   ]  99.7393809991        1
[INPUT] 1    0    [1    /1   ]  0.266423168822       1
[INPUT] 1    0    [1    /1   ]  2.43928979719        1
[INPUT] 1    0    [1    /1   ]  0.832845375769       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478717025715, 1.0]], [0, [2712.0974386687412, 1.0]], [0, [617.4881190363204, 1.0]], [0, [174.9762939115948, 1.0]], [0, [20.47653485053224, 1.0]], [0, [56.96801544860398, 1.0]], [0, [0.48756449290402104, 1.0]], [0, [7.815578215141345, 1.0]], [0, [1.6543611464140284, 1.0]], [1, [7.112081416006997, 1.0]], [1, [23.163086468130913, 1.0]], [1, [99.73938099913173, 1.0]], [1, [0.26642316882159944, 1.0]], [1, [2.439289797185555, 1.0]], [1, [0.832845375768522, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871703]
bas 1, expnt(s) = [2712.09743867]
bas 2, expnt(s) = [617.48811904]
bas 3, expnt(s) = [174.97629391]
bas 4, expnt(s) = [20.47653485]
bas 5, expnt(s) = [56.96801545]
bas 6, expnt(s) = [0.48756449]
bas 7, expnt(s) = [7.81557822]
bas 8, expnt(s) = [1.65436115]
bas 9, expnt(s) = [7.11208142]
bas 10, expnt(s) = [23.16308647]
bas 11, expnt(s) = [99.739381]
bas 12, expnt(s) = [0.26642317]
bas 13, expnt(s) = [2.4392898]
bas 14, expnt(s) = [0.83284538]
CPU time:       281.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209744e+03 9.49497861e+02
 6.17488119e+02 3.12958303e+02 1.74976294e+02 1.21548453e+02
 2.04765349e+01 2.43196529e+01 5.69680154e+01 5.23887869e+01
 4.87564493e-01 1.47414118e+00 7.81557822e+00 1.18096183e+01
 1.65436115e+00 3.68542660e+00 7.11208142e+00 3.38828780e+01
 2.31630865e+01 1.48244957e+02 9.97393810e+01 9.19533865e+02
 2.66423169e-01 5.58405104e-01 2.43928980e+00 8.89331431e+00
 8.32845376e-01 2.32107870e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999175517193365
cond(S) = 239.10079984634908
E1 = -183.5867175003767  E_coul = 55.08139214060743
init E= -128.505325359769
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.775336816580822  LUMO = 0.824593691290489
  mo_energy =
[-3.25542661e+01 -1.85119913e+00 -7.75336817e-01 -7.75336817e-01
 -7.75336817e-01  8.24593691e-01  8.24593691e-01  8.24593691e-01
  2.06144428e+00  3.95375569e+00  3.95375569e+00  3.95375569e+00
  1.43480449e+01  1.43480449e+01  1.43480449e+01  1.94212962e+01
  5.29819121e+01  5.29819121e+01  5.29819121e+01  9.38256005e+01
  2.40718670e+02  2.40718670e+02  2.40718670e+02  3.56213411e+02
  1.34971694e+03  5.83620294e+03  3.50988003e+04]
E1 = -182.09121463277674  E_coul = 53.556990757746426
cycle= 1 E= -128.53422387503  delta_E= -0.0289  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502613
diis-c [-0.2526194  1.       ]
  HOMO = -0.883299646169961  LUMO = 0.798337897234124
  mo_energy =
[-3.28767774e+01 -1.96458531e+00 -8.83299646e-01 -8.83299646e-01
 -8.83299646e-01  7.98337897e-01  7.98337897e-01  7.98337897e-01
  1.98439803e+00  3.85720128e+00  3.85720128e+00  3.85720128e+00
  1.41582667e+01  1.41582667e+01  1.41582667e+01  1.91998356e+01
  5.27017462e+01  5.27017462e+01  5.27017462e+01  9.35217704e+01
  2.40373116e+02  2.40373116e+02  2.40373116e+02  3.55862116e+02
  1.34932746e+03  5.83578158e+03  3.50983573e+04]
E1 = -182.849648513294  E_coul = 54.312835261490875
cycle= 2 E= -128.536813251803  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.253729
diis-c [-6.05020255e-04  3.34683831e-01  6.65316169e-01]
  HOMO = -0.847757767810459  LUMO = 0.807027569827904
  mo_energy =
[-3.27688880e+01 -1.92706719e+00 -8.47757768e-01 -8.47757768e-01
 -8.47757768e-01  8.07027570e-01  8.07027570e-01  8.07027570e-01
  2.00966242e+00  3.88874154e+00  3.88874154e+00  3.88874154e+00
  1.42213094e+01  1.42213094e+01  1.42213094e+01  1.92739854e+01
  5.27955861e+01  5.27955861e+01  5.27955861e+01  9.36236322e+01
  2.40486548e+02  2.40486548e+02  2.40486548e+02  3.55976817e+02
  1.34944841e+03  5.83590548e+03  3.50984823e+04]
E1 = -182.59321765867725  E_coul = 54.055495633500485
cycle= 3 E= -128.537722025177  delta_E= -0.000909  |g|= 0.000471  |ddm|= 0.0254
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00120408
diis-c [-1.07733035e-07 -2.16370503e-03  2.91186278e-04  1.00187252e+00]
  HOMO = -0.847981710639421  LUMO = 0.807001470414321
  mo_energy =
[-3.27693508e+01 -1.92723928e+00 -8.47981711e-01 -8.47981711e-01
 -8.47981711e-01  8.07001470e-01  8.07001470e-01  8.07001470e-01
  2.00957206e+00  3.88859282e+00  3.88859282e+00  3.88859282e+00
  1.42210287e+01  1.42210287e+01  1.42210287e+01  1.92736912e+01
  5.27951893e+01  5.27951893e+01  5.27951893e+01  9.36232000e+01
  2.40486007e+02  2.40486007e+02  2.40486007e+02  3.55976250e+02
  1.34944770e+03  5.83590464e+03  3.50984814e+04]
E1 = -182.59382718534403  E_coul = 54.056105142770335
cycle= 4 E= -128.537722042574  delta_E= -1.74e-08  |g|= 7.22e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187459
diis-c [-4.62513513e-10  1.31934782e-04  4.91938370e-04 -1.27389060e-01
  1.12676519e+00]
  HOMO = -0.848016480020296  LUMO = 0.806991251289542
  mo_energy =
[-3.27694215e+01 -1.92726865e+00 -8.48016480e-01 -8.48016480e-01
 -8.48016480e-01  8.06991251e-01  8.06991251e-01  8.06991251e-01
  2.00954923e+00  3.88856002e+00  3.88856002e+00  3.88856002e+00
  1.42209766e+01  1.42209766e+01  1.42209766e+01  1.92736370e+01
  5.27951245e+01  5.27951245e+01  5.27951245e+01  9.36231319e+01
  2.40485932e+02  2.40485932e+02  2.40485932e+02  3.55976173e+02
  1.34944761e+03  5.83590455e+03  3.50984813e+04]
E1 = -182.59398016180742  E_coul = 54.05625811876863
cycle= 5 E= -128.537722043039  delta_E= -4.65e-10  |g|= 2.74e-06  |ddm|= 1.68e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59398016180742  E_coul = 54.05625811876863
  HOMO = -0.848015348960769  LUMO = 0.806991580536179
  mo_energy =
[-3.27694189e+01 -1.92726700e+00 -8.48015349e-01 -8.48015349e-01
 -8.48015349e-01  8.06991581e-01  8.06991581e-01  8.06991581e-01
  2.00955046e+00  3.88856111e+00  3.88856111e+00  3.88856111e+00
  1.42209785e+01  1.42209785e+01  1.42209785e+01  1.92736394e+01
  5.27951269e+01  5.27951269e+01  5.27951269e+01  9.36231343e+01
  2.40485934e+02  2.40485934e+02  2.40485934e+02  3.55976175e+02
  1.34944761e+03  5.83590455e+03  3.50984813e+04]
E1 = -182.5939738956511  E_coul = 54.05625185261145
Extra cycle  E= -128.53772204304  delta_E= -8.53e-13  |g|= 9.03e-07  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.14 sec, wall time      0.14 sec
exp = [1.80764787e+04 2.71209744e+03 6.17488119e+02 1.74976294e+02
 2.04765349e+01 5.69680154e+01 4.87564493e-01 7.81557822e+00
 1.65436115e+00 7.11208142e+00 2.31630865e+01 9.97393810e+01
 2.66423169e-01 2.43928980e+00 8.32845376e-01]
E = -128.53772204303965
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.478717         1
[INPUT] 0    0    [1    /1   ]  2712.09743867        1
[INPUT] 0    0    [1    /1   ]  617.488119036        1
[INPUT] 0    0    [1    /1   ]  174.976293912        1
[INPUT] 0    0    [1    /1   ]  20.4765348505        1
[INPUT] 0    0    [1    /1   ]  56.9680154486        1
[INPUT] 0    0    [1    /1   ]  0.487564492904       1
[INPUT] 0    0    [1    /1   ]  7.81557821514        1
[INPUT] 0    0    [1    /1   ]  1.65436114641        1
[INPUT] 1    0    [1    /1   ]  7.11208141601        1
[INPUT] 1    0    [1    /1   ]  23.1630864681        1
[INPUT] 1    0    [1    /1   ]  99.7393809991        1
[INPUT] 1    0    [1    /1   ]  0.266423168822       1
[INPUT] 1    0    [1    /1   ]  2.43928979719        1
[INPUT] 1    0    [1    /1   ]  0.832845375769       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478717025715, 1.0]], [0, [2712.0974386687412, 1.0]], [0, [617.4881190363204, 1.0]], [0, [174.9762939115948, 1.0]], [0, [20.47653485053224, 1.0]], [0, [56.96801544860398, 1.0]], [0, [0.48756449290402104, 1.0]], [0, [7.815578215141345, 1.0]], [0, [1.6543611464140284, 1.0]], [1, [7.112081416006997, 1.0]], [1, [23.163086468130913, 1.0]], [1, [99.73938099913173, 1.0]], [1, [0.26642316882159944, 1.0]], [1, [2.439289797185555, 1.0]], [1, [0.832845375768522, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871703]
bas 1, expnt(s) = [2712.09743867]
bas 2, expnt(s) = [617.48811904]
bas 3, expnt(s) = [174.97629391]
bas 4, expnt(s) = [20.47653485]
bas 5, expnt(s) = [56.96801545]
bas 6, expnt(s) = [0.48756449]
bas 7, expnt(s) = [7.81557822]
bas 8, expnt(s) = [1.65436115]
bas 9, expnt(s) = [7.11208142]
bas 10, expnt(s) = [23.16308647]
bas 11, expnt(s) = [99.739381]
bas 12, expnt(s) = [0.26642317]
bas 13, expnt(s) = [2.4392898]
bas 14, expnt(s) = [0.83284538]
CPU time:       282.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209744e+03 9.49497861e+02
 6.17488119e+02 3.12958303e+02 1.74976294e+02 1.21548453e+02
 2.04765349e+01 2.43196529e+01 5.69680154e+01 5.23887869e+01
 4.87564493e-01 1.47414118e+00 7.81557822e+00 1.18096183e+01
 1.65436115e+00 3.68542660e+00 7.11208142e+00 3.38828780e+01
 2.31630865e+01 1.48244957e+02 9.97393810e+01 9.19533865e+02
 2.66423169e-01 5.58405104e-01 2.43928980e+00 8.89331431e+00
 8.32845376e-01 2.32107870e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.999175517193365
cond(S) = 239.10079984634908
E1 = -183.5867175003767  E_coul = 55.08139214060743
init E= -128.505325359769
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.775336816580822  LUMO = 0.824593691290489
  mo_energy =
[-3.25542661e+01 -1.85119913e+00 -7.75336817e-01 -7.75336817e-01
 -7.75336817e-01  8.24593691e-01  8.24593691e-01  8.24593691e-01
  2.06144428e+00  3.95375569e+00  3.95375569e+00  3.95375569e+00
  1.43480449e+01  1.43480449e+01  1.43480449e+01  1.94212962e+01
  5.29819121e+01  5.29819121e+01  5.29819121e+01  9.38256005e+01
  2.40718670e+02  2.40718670e+02  2.40718670e+02  3.56213411e+02
  1.34971694e+03  5.83620294e+03  3.50988003e+04]
E1 = -182.09121463277674  E_coul = 53.556990757746426
cycle= 1 E= -128.53422387503  delta_E= -0.0289  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502613
diis-c [-0.2526194  1.       ]
  HOMO = -0.883299646169961  LUMO = 0.798337897234124
  mo_energy =
[-3.28767774e+01 -1.96458531e+00 -8.83299646e-01 -8.83299646e-01
 -8.83299646e-01  7.98337897e-01  7.98337897e-01  7.98337897e-01
  1.98439803e+00  3.85720128e+00  3.85720128e+00  3.85720128e+00
  1.41582667e+01  1.41582667e+01  1.41582667e+01  1.91998356e+01
  5.27017462e+01  5.27017462e+01  5.27017462e+01  9.35217704e+01
  2.40373116e+02  2.40373116e+02  2.40373116e+02  3.55862116e+02
  1.34932746e+03  5.83578158e+03  3.50983573e+04]
E1 = -182.849648513294  E_coul = 54.312835261490875
cycle= 2 E= -128.536813251803  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.253729
diis-c [-6.05020255e-04  3.34683831e-01  6.65316169e-01]
  HOMO = -0.847757767810459  LUMO = 0.807027569827904
  mo_energy =
[-3.27688880e+01 -1.92706719e+00 -8.47757768e-01 -8.47757768e-01
 -8.47757768e-01  8.07027570e-01  8.07027570e-01  8.07027570e-01
  2.00966242e+00  3.88874154e+00  3.88874154e+00  3.88874154e+00
  1.42213094e+01  1.42213094e+01  1.42213094e+01  1.92739854e+01
  5.27955861e+01  5.27955861e+01  5.27955861e+01  9.36236322e+01
  2.40486548e+02  2.40486548e+02  2.40486548e+02  3.55976817e+02
  1.34944841e+03  5.83590548e+03  3.50984823e+04]
E1 = -182.59321765867725  E_coul = 54.055495633500485
cycle= 3 E= -128.537722025177  delta_E= -0.000909  |g|= 0.000471  |ddm|= 0.0254
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.00120408
diis-c [-1.07733035e-07 -2.16370503e-03  2.91186278e-04  1.00187252e+00]
  HOMO = -0.847981710639421  LUMO = 0.807001470414321
  mo_energy =
[-3.27693508e+01 -1.92723928e+00 -8.47981711e-01 -8.47981711e-01
 -8.47981711e-01  8.07001470e-01  8.07001470e-01  8.07001470e-01
  2.00957206e+00  3.88859282e+00  3.88859282e+00  3.88859282e+00
  1.42210287e+01  1.42210287e+01  1.42210287e+01  1.92736912e+01
  5.27951893e+01  5.27951893e+01  5.27951893e+01  9.36232000e+01
  2.40486007e+02  2.40486007e+02  2.40486007e+02  3.55976250e+02
  1.34944770e+03  5.83590464e+03  3.50984814e+04]
E1 = -182.59382718534403  E_coul = 54.056105142770335
cycle= 4 E= -128.537722042574  delta_E= -1.74e-08  |g|= 7.22e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000187459
diis-c [-4.62513513e-10  1.31934782e-04  4.91938370e-04 -1.27389060e-01
  1.12676519e+00]
  HOMO = -0.848016480020296  LUMO = 0.806991251289542
  mo_energy =
[-3.27694215e+01 -1.92726865e+00 -8.48016480e-01 -8.48016480e-01
 -8.48016480e-01  8.06991251e-01  8.06991251e-01  8.06991251e-01
  2.00954923e+00  3.88856002e+00  3.88856002e+00  3.88856002e+00
  1.42209766e+01  1.42209766e+01  1.42209766e+01  1.92736370e+01
  5.27951245e+01  5.27951245e+01  5.27951245e+01  9.36231319e+01
  2.40485932e+02  2.40485932e+02  2.40485932e+02  3.55976173e+02
  1.34944761e+03  5.83590455e+03  3.50984813e+04]
E1 = -182.59398016180742  E_coul = 54.05625811876863
cycle= 5 E= -128.537722043039  delta_E= -4.65e-10  |g|= 2.74e-06  |ddm|= 1.68e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.02 sec
E1 = -182.59398016180742  E_coul = 54.05625811876863
  HOMO = -0.848015348960769  LUMO = 0.806991580536179
  mo_energy =
[-3.27694189e+01 -1.92726700e+00 -8.48015349e-01 -8.48015349e-01
 -8.48015349e-01  8.06991581e-01  8.06991581e-01  8.06991581e-01
  2.00955046e+00  3.88856111e+00  3.88856111e+00  3.88856111e+00
  1.42209785e+01  1.42209785e+01  1.42209785e+01  1.92736394e+01
  5.27951269e+01  5.27951269e+01  5.27951269e+01  9.36231343e+01
  2.40485934e+02  2.40485934e+02  2.40485934e+02  3.55976175e+02
  1.34944761e+03  5.83590455e+03  3.50984813e+04]
E1 = -182.5939738956511  E_coul = 54.05625185261145
Extra cycle  E= -128.53772204304  delta_E= -8.53e-13  |g|= 9.03e-07  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.10079984634908
E1 = -182.5939738956511  E_coul = 54.05625185261145
init E= -128.53772204304
    CPU time for initialize scf      0.30 sec, wall time      0.30 sec
  HOMO = -0.848015802548769  LUMO = 0.806991476548323
  mo_energy =
[-3.27694203e+01 -1.92726739e+00 -8.48015803e-01 -8.48015803e-01
 -8.48015803e-01  8.06991477e-01  8.06991477e-01  8.06991477e-01
  2.00955021e+00  3.88856072e+00  3.88856072e+00  3.88856072e+00
  1.42209777e+01  1.42209777e+01  1.42209777e+01  1.92736385e+01
  5.27951257e+01  5.27951257e+01  5.27951257e+01  9.36231330e+01
  2.40485933e+02  2.40485933e+02  2.40485933e+02  3.55976173e+02
  1.34944761e+03  5.83590455e+03  3.50984813e+04]
E1 = -182.59397735455093  E_coul = 54.05625531151132
cycle= 1 E= -128.53772204304  delta_E= 5.68e-14  |g|= 4.79e-07  |ddm|= 3.2e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59397735455093  E_coul = 54.05625531151132
  HOMO = -0.848015560678319  LUMO = 0.806991537272237
  mo_energy =
[-3.27694196e+01 -1.92726712e+00 -8.48015561e-01 -8.48015561e-01
 -8.48015561e-01  8.06991537e-01  8.06991537e-01  8.06991537e-01
  2.00955040e+00  3.88856094e+00  3.88856094e+00  3.88856094e+00
  1.42209781e+01  1.42209781e+01  1.42209781e+01  1.92736390e+01
  5.27951264e+01  5.27951264e+01  5.27951264e+01  9.36231337e+01
  2.40485934e+02  2.40485934e+02  2.40485934e+02  3.55976174e+02
  1.34944761e+03  5.83590455e+03  3.50984813e+04]
E1 = -182.59397563828657  E_coul = 54.05625359524677
Extra cycle  E= -128.53772204304  delta_E= -1.99e-13  |g|= 2.33e-07  |ddm|= 1.94e-07
    CPU time for scf_cycle      0.37 sec, wall time      0.37 sec
exp = [1.80764787e+04 2.71209744e+03 6.17488119e+02 1.74976294e+02
 2.04765349e+01 5.69680154e+01 4.87564493e-01 7.81557822e+00
 1.65436115e+00 7.11208142e+00 2.31630865e+01 9.97393810e+01
 2.66423169e-01 2.43928980e+00 8.32845376e-01]
grad_E = [-2.44783317e-10  1.21002922e-08 -1.76475862e-07  7.66087513e-07
 -1.58940806e-06 -6.70284268e-07 -3.02004744e-05 -5.34193964e-06
  8.36419662e-06 -7.02637123e-06  1.21027040e-06 -3.05069986e-08
  2.71705154e-05  1.47172664e-05 -2.26179060e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.478717         1
[INPUT] 0    0    [1    /1   ]  2712.0974411         1
[INPUT] 0    0    [1    /1   ]  617.488074296        1
[INPUT] 0    0    [1    /1   ]  174.976713202        1
[INPUT] 0    0    [1    /1   ]  20.4787640396        1
[INPUT] 0    0    [1    /1   ]  56.9661520768        1
[INPUT] 0    0    [1    /1   ]  0.487585817879       1
[INPUT] 0    0    [1    /1   ]  7.81772804554        1
[INPUT] 0    0    [1    /1   ]  1.65436183896        1
[INPUT] 1    0    [1    /1   ]  7.11284007405        1
[INPUT] 1    0    [1    /1   ]  23.1626313947        1
[INPUT] 1    0    [1    /1   ]  99.73133194          1
[INPUT] 1    0    [1    /1   ]  0.266432223038       1
[INPUT] 1    0    [1    /1   ]  2.43949709184        1
[INPUT] 1    0    [1    /1   ]  0.832901445688       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478716978905, 1.0]], [0, [2712.097441098166, 1.0]], [0, [617.488074296102, 1.0]], [0, [174.9767132023953, 1.0]], [0, [20.478764039603604, 1.0]], [0, [56.966152076801556, 1.0]], [0, [0.48758581787851274, 1.0]], [0, [7.817728045537474, 1.0]], [0, [1.6543618389607975, 1.0]], [1, [7.112840074048945, 1.0]], [1, [23.162631394705006, 1.0]], [1, [99.73133193996868, 1.0]], [1, [0.2664322230383457, 1.0]], [1, [2.439497091842513, 1.0]], [1, [0.832901445687817, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871698]
bas 1, expnt(s) = [2712.0974411]
bas 2, expnt(s) = [617.4880743]
bas 3, expnt(s) = [174.9767132]
bas 4, expnt(s) = [20.47876404]
bas 5, expnt(s) = [56.96615208]
bas 6, expnt(s) = [0.48758582]
bas 7, expnt(s) = [7.81772805]
bas 8, expnt(s) = [1.65436184]
bas 9, expnt(s) = [7.11284007]
bas 10, expnt(s) = [23.16263139]
bas 11, expnt(s) = [99.73133194]
bas 12, expnt(s) = [0.26643222]
bas 13, expnt(s) = [2.43949709]
bas 14, expnt(s) = [0.83290145]
CPU time:       286.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209744e+03 9.49497862e+02
 6.17488074e+02 3.12958286e+02 1.74976713e+02 1.21548671e+02
 2.04787640e+01 2.43216386e+01 5.69661521e+01 5.23875017e+01
 4.87585818e-01 1.47418953e+00 7.81772805e+00 1.18120545e+01
 1.65436184e+00 3.68542775e+00 7.11284007e+00 3.38873960e+01
 2.31626314e+01 1.48241316e+02 9.97313319e+01 9.19441107e+02
 2.66432223e-01 5.58428826e-01 2.43949709e+00 8.89425903e+00
 8.32901446e-01 2.32127403e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99917536867351
cond(S) = 239.19095340403362
E1 = -183.58671792730175  E_coul = 55.08139258655358
init E= -128.505325340748
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77533669662406  LUMO = 0.824638575618122
  mo_energy =
[-3.25542660e+01 -1.85119931e+00 -7.75336697e-01 -7.75336697e-01
 -7.75336697e-01  8.24638576e-01  8.24638576e-01  8.24638576e-01
  2.06155781e+00  3.95403859e+00  3.95403859e+00  3.95403859e+00
  1.43494539e+01  1.43494539e+01  1.43494539e+01  1.94253910e+01
  5.29844551e+01  5.29844551e+01  5.29844551e+01  9.38369359e+01
  2.40706665e+02  2.40706665e+02  2.40706665e+02  3.56225376e+02
  1.34972735e+03  5.83621207e+03  3.50988078e+04]
E1 = -182.09123842622495  E_coul = 53.557014428293485
cycle= 1 E= -128.534223997931  delta_E= -0.0289  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502606
diis-c [-0.25261287  1.        ]
  HOMO = -0.883297561290072  LUMO = 0.798380974646134
  mo_energy =
[-3.28767729e+01 -1.96458425e+00 -8.83297561e-01 -8.83297561e-01
 -8.83297561e-01  7.98380975e-01  7.98380975e-01  7.98380975e-01
  1.98450818e+00  3.85747958e+00  3.85747958e+00  3.85747958e+00
  1.41596703e+01  1.41596703e+01  1.41596703e+01  1.92039157e+01
  5.27042936e+01  5.27042936e+01  5.27042936e+01  9.35331071e+01
  2.40361120e+02  2.40361120e+02  2.40361120e+02  3.55874086e+02
  1.34933787e+03  5.83579072e+03  3.50983648e+04]
E1 = -182.8496575495057  E_coul = 54.312844252695356
cycle= 2 E= -128.53681329681  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253725
diis-c [-6.05052104e-04  3.34683605e-01  6.65316395e-01]
  HOMO = -0.847756370879698  LUMO = 0.807071157441688
  mo_energy =
[-3.27688855e+01 -1.92706687e+00 -8.47756371e-01 -8.47756371e-01
 -8.47756371e-01  8.07071157e-01  8.07071157e-01  8.07071157e-01
  2.00977344e+00  3.88902130e+00  3.88902130e+00  3.88902130e+00
  1.42227146e+01  1.42227146e+01  1.42227146e+01  1.92780703e+01
  5.27981317e+01  5.27981317e+01  5.27981317e+01  9.36349680e+01
  2.40474549e+02  2.40474549e+02  2.40474549e+02  3.55988785e+02
  1.34945882e+03  5.83591461e+03  3.50984899e+04]
E1 = -182.59323183019265  E_coul = 54.05550979557837
cycle= 3 E= -128.537722034614  delta_E= -0.000909  |g|= 0.000471  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120374
diis-c [-1.07624930e-07 -2.16372413e-03  2.89991746e-04  1.00187373e+00]
  HOMO = -0.847980324065186  LUMO = 0.807045037476973
  mo_energy =
[-3.27693483e+01 -1.92723905e+00 -8.47980324e-01 -8.47980324e-01
 -8.47980324e-01  8.07045037e-01  8.07045037e-01  8.07045037e-01
  2.00968299e+00  3.88887254e+00  3.88887254e+00  3.88887254e+00
  1.42224339e+01  1.42224339e+01  1.42224339e+01  1.92777760e+01
  5.27977348e+01  5.27977348e+01  5.27977348e+01  9.36345358e+01
  2.40474009e+02  2.40474009e+02  2.40474009e+02  3.55988218e+02
  1.34945810e+03  5.83591377e+03  3.50984890e+04]
E1 = -182.59384114921883  E_coul = 54.056119097215635
cycle= 4 E= -128.537722052003  delta_E= -1.74e-08  |g|= 7.21e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018735
diis-c [-4.61633987e-10  1.31708419e-04  4.91713604e-04 -1.27257963e-01
  1.12663454e+00]
  HOMO = -0.848015087183908  LUMO = 0.80703481711735
  mo_energy =
[-3.27694189e+01 -1.92726843e+00 -8.48015087e-01 -8.48015087e-01
 -8.48015087e-01  8.07034817e-01  8.07034817e-01  8.07034817e-01
  2.00966015e+00  3.88883975e+00  3.88883975e+00  3.88883975e+00
  1.42223818e+01  1.42223818e+01  1.42223818e+01  1.92777219e+01
  5.27976700e+01  5.27976700e+01  5.27976700e+01  9.36344677e+01
  2.40473933e+02  2.40473933e+02  2.40473933e+02  3.55988141e+02
  1.34945802e+03  5.83591368e+03  3.50984889e+04]
E1 = -182.59399402959033  E_coul = 54.056271977122144
cycle= 5 E= -128.537722052468  delta_E= -4.65e-10  |g|= 2.73e-06  |ddm|= 1.68e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59399402959033  E_coul = 54.056271977122144
  HOMO = -0.84801395969172  LUMO = 0.807035145196202
  mo_energy =
[-3.27694164e+01 -1.92726679e+00 -8.48013960e-01 -8.48013960e-01
 -8.48013960e-01  8.07035145e-01  8.07035145e-01  8.07035145e-01
  2.00966138e+00  3.88884083e+00  3.88884083e+00  3.88884083e+00
  1.42223837e+01  1.42223837e+01  1.42223837e+01  1.92777242e+01
  5.27976725e+01  5.27976725e+01  5.27976725e+01  9.36344701e+01
  2.40473935e+02  2.40473935e+02  2.40473935e+02  3.55988143e+02
  1.34945802e+03  5.83591368e+03  3.50984889e+04]
E1 = -182.59398777506158  E_coul = 54.05626572259256
Extra cycle  E= -128.537722052469  delta_E= -8.24e-13  |g|= 9.01e-07  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.12 sec, wall time      0.12 sec
exp = [1.80764787e+04 2.71209744e+03 6.17488074e+02 1.74976713e+02
 2.04787640e+01 5.69661521e+01 4.87585818e-01 7.81772805e+00
 1.65436184e+00 7.11284007e+00 2.31626314e+01 9.97313319e+01
 2.66432223e-01 2.43949709e+00 8.32901446e-01]
E = -128.537722052469
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.478717         1
[INPUT] 0    0    [1    /1   ]  2712.0974411         1
[INPUT] 0    0    [1    /1   ]  617.488074296        1
[INPUT] 0    0    [1    /1   ]  174.976713202        1
[INPUT] 0    0    [1    /1   ]  20.4787640396        1
[INPUT] 0    0    [1    /1   ]  56.9661520768        1
[INPUT] 0    0    [1    /1   ]  0.487585817879       1
[INPUT] 0    0    [1    /1   ]  7.81772804554        1
[INPUT] 0    0    [1    /1   ]  1.65436183896        1
[INPUT] 1    0    [1    /1   ]  7.11284007405        1
[INPUT] 1    0    [1    /1   ]  23.1626313947        1
[INPUT] 1    0    [1    /1   ]  99.73133194          1
[INPUT] 1    0    [1    /1   ]  0.266432223038       1
[INPUT] 1    0    [1    /1   ]  2.43949709184        1
[INPUT] 1    0    [1    /1   ]  0.832901445688       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478716978905, 1.0]], [0, [2712.097441098166, 1.0]], [0, [617.488074296102, 1.0]], [0, [174.9767132023953, 1.0]], [0, [20.478764039603604, 1.0]], [0, [56.966152076801556, 1.0]], [0, [0.48758581787851274, 1.0]], [0, [7.817728045537474, 1.0]], [0, [1.6543618389607975, 1.0]], [1, [7.112840074048945, 1.0]], [1, [23.162631394705006, 1.0]], [1, [99.73133193996868, 1.0]], [1, [0.2664322230383457, 1.0]], [1, [2.439497091842513, 1.0]], [1, [0.832901445687817, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871698]
bas 1, expnt(s) = [2712.0974411]
bas 2, expnt(s) = [617.4880743]
bas 3, expnt(s) = [174.9767132]
bas 4, expnt(s) = [20.47876404]
bas 5, expnt(s) = [56.96615208]
bas 6, expnt(s) = [0.48758582]
bas 7, expnt(s) = [7.81772805]
bas 8, expnt(s) = [1.65436184]
bas 9, expnt(s) = [7.11284007]
bas 10, expnt(s) = [23.16263139]
bas 11, expnt(s) = [99.73133194]
bas 12, expnt(s) = [0.26643222]
bas 13, expnt(s) = [2.43949709]
bas 14, expnt(s) = [0.83290145]
CPU time:       287.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209744e+03 9.49497862e+02
 6.17488074e+02 3.12958286e+02 1.74976713e+02 1.21548671e+02
 2.04787640e+01 2.43216386e+01 5.69661521e+01 5.23875017e+01
 4.87585818e-01 1.47418953e+00 7.81772805e+00 1.18120545e+01
 1.65436184e+00 3.68542775e+00 7.11284007e+00 3.38873960e+01
 2.31626314e+01 1.48241316e+02 9.97313319e+01 9.19441107e+02
 2.66432223e-01 5.58428826e-01 2.43949709e+00 8.89425903e+00
 8.32901446e-01 2.32127403e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99917536867351
cond(S) = 239.19095340403362
E1 = -183.58671792730175  E_coul = 55.08139258655358
init E= -128.505325340748
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.77533669662406  LUMO = 0.824638575618122
  mo_energy =
[-3.25542660e+01 -1.85119931e+00 -7.75336697e-01 -7.75336697e-01
 -7.75336697e-01  8.24638576e-01  8.24638576e-01  8.24638576e-01
  2.06155781e+00  3.95403859e+00  3.95403859e+00  3.95403859e+00
  1.43494539e+01  1.43494539e+01  1.43494539e+01  1.94253910e+01
  5.29844551e+01  5.29844551e+01  5.29844551e+01  9.38369359e+01
  2.40706665e+02  2.40706665e+02  2.40706665e+02  3.56225376e+02
  1.34972735e+03  5.83621207e+03  3.50988078e+04]
E1 = -182.09123842622495  E_coul = 53.557014428293485
cycle= 1 E= -128.534223997931  delta_E= -0.0289  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502606
diis-c [-0.25261287  1.        ]
  HOMO = -0.883297561290072  LUMO = 0.798380974646134
  mo_energy =
[-3.28767729e+01 -1.96458425e+00 -8.83297561e-01 -8.83297561e-01
 -8.83297561e-01  7.98380975e-01  7.98380975e-01  7.98380975e-01
  1.98450818e+00  3.85747958e+00  3.85747958e+00  3.85747958e+00
  1.41596703e+01  1.41596703e+01  1.41596703e+01  1.92039157e+01
  5.27042936e+01  5.27042936e+01  5.27042936e+01  9.35331071e+01
  2.40361120e+02  2.40361120e+02  2.40361120e+02  3.55874086e+02
  1.34933787e+03  5.83579072e+03  3.50983648e+04]
E1 = -182.8496575495057  E_coul = 54.312844252695356
cycle= 2 E= -128.53681329681  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253725
diis-c [-6.05052104e-04  3.34683605e-01  6.65316395e-01]
  HOMO = -0.847756370879698  LUMO = 0.807071157441688
  mo_energy =
[-3.27688855e+01 -1.92706687e+00 -8.47756371e-01 -8.47756371e-01
 -8.47756371e-01  8.07071157e-01  8.07071157e-01  8.07071157e-01
  2.00977344e+00  3.88902130e+00  3.88902130e+00  3.88902130e+00
  1.42227146e+01  1.42227146e+01  1.42227146e+01  1.92780703e+01
  5.27981317e+01  5.27981317e+01  5.27981317e+01  9.36349680e+01
  2.40474549e+02  2.40474549e+02  2.40474549e+02  3.55988785e+02
  1.34945882e+03  5.83591461e+03  3.50984899e+04]
E1 = -182.59323183019265  E_coul = 54.05550979557837
cycle= 3 E= -128.537722034614  delta_E= -0.000909  |g|= 0.000471  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120374
diis-c [-1.07624930e-07 -2.16372413e-03  2.89991746e-04  1.00187373e+00]
  HOMO = -0.847980324065186  LUMO = 0.807045037476973
  mo_energy =
[-3.27693483e+01 -1.92723905e+00 -8.47980324e-01 -8.47980324e-01
 -8.47980324e-01  8.07045037e-01  8.07045037e-01  8.07045037e-01
  2.00968299e+00  3.88887254e+00  3.88887254e+00  3.88887254e+00
  1.42224339e+01  1.42224339e+01  1.42224339e+01  1.92777760e+01
  5.27977348e+01  5.27977348e+01  5.27977348e+01  9.36345358e+01
  2.40474009e+02  2.40474009e+02  2.40474009e+02  3.55988218e+02
  1.34945810e+03  5.83591377e+03  3.50984890e+04]
E1 = -182.59384114921883  E_coul = 54.056119097215635
cycle= 4 E= -128.537722052003  delta_E= -1.74e-08  |g|= 7.21e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018735
diis-c [-4.61633987e-10  1.31708419e-04  4.91713604e-04 -1.27257963e-01
  1.12663454e+00]
  HOMO = -0.848015087183908  LUMO = 0.80703481711735
  mo_energy =
[-3.27694189e+01 -1.92726843e+00 -8.48015087e-01 -8.48015087e-01
 -8.48015087e-01  8.07034817e-01  8.07034817e-01  8.07034817e-01
  2.00966015e+00  3.88883975e+00  3.88883975e+00  3.88883975e+00
  1.42223818e+01  1.42223818e+01  1.42223818e+01  1.92777219e+01
  5.27976700e+01  5.27976700e+01  5.27976700e+01  9.36344677e+01
  2.40473933e+02  2.40473933e+02  2.40473933e+02  3.55988141e+02
  1.34945802e+03  5.83591368e+03  3.50984889e+04]
E1 = -182.59399402959033  E_coul = 54.056271977122144
cycle= 5 E= -128.537722052468  delta_E= -4.65e-10  |g|= 2.73e-06  |ddm|= 1.68e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59399402959033  E_coul = 54.056271977122144
  HOMO = -0.84801395969172  LUMO = 0.807035145196202
  mo_energy =
[-3.27694164e+01 -1.92726679e+00 -8.48013960e-01 -8.48013960e-01
 -8.48013960e-01  8.07035145e-01  8.07035145e-01  8.07035145e-01
  2.00966138e+00  3.88884083e+00  3.88884083e+00  3.88884083e+00
  1.42223837e+01  1.42223837e+01  1.42223837e+01  1.92777242e+01
  5.27976725e+01  5.27976725e+01  5.27976725e+01  9.36344701e+01
  2.40473935e+02  2.40473935e+02  2.40473935e+02  3.55988143e+02
  1.34945802e+03  5.83591368e+03  3.50984889e+04]
E1 = -182.59398777506158  E_coul = 54.05626572259256
Extra cycle  E= -128.537722052469  delta_E= -8.24e-13  |g|= 9.01e-07  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 239.19095340403362
E1 = -182.59398777506158  E_coul = 54.05626572259256
init E= -128.537722052469
    CPU time for initialize scf      0.23 sec, wall time      0.23 sec
  HOMO = -0.848014412479272  LUMO = 0.807035041350934
  mo_energy =
[-3.27694178e+01 -1.92726717e+00 -8.48014412e-01 -8.48014412e-01
 -8.48014412e-01  8.07035041e-01  8.07035041e-01  8.07035041e-01
  2.00966113e+00  3.88884044e+00  3.88884044e+00  3.88884044e+00
  1.42223829e+01  1.42223829e+01  1.42223829e+01  1.92777233e+01
  5.27976713e+01  5.27976713e+01  5.27976713e+01  9.36344688e+01
  2.40473934e+02  2.40473934e+02  2.40473934e+02  3.55988141e+02
  1.34945802e+03  5.83591368e+03  3.50984889e+04]
E1 = -182.59399122644956  E_coul = 54.05626917398085
cycle= 1 E= -128.537722052469  delta_E= 2.84e-13  |g|= 4.78e-07  |ddm|= 3.19e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.59399122644956  E_coul = 54.05626917398085
  HOMO = -0.848014171138671  LUMO = 0.807035101942727
  mo_energy =
[-3.27694170e+01 -1.92726690e+00 -8.48014171e-01 -8.48014171e-01
 -8.48014171e-01  8.07035102e-01  8.07035102e-01  8.07035102e-01
  2.00966132e+00  3.88884066e+00  3.88884066e+00  3.88884066e+00
  1.42223833e+01  1.42223833e+01  1.42223833e+01  1.92777238e+01
  5.27976719e+01  5.27976719e+01  5.27976719e+01  9.36344695e+01
  2.40473935e+02  2.40473935e+02  2.40473935e+02  3.55988142e+02
  1.34945802e+03  5.83591368e+03  3.50984889e+04]
E1 = -182.5939895137817  E_coul = 54.056267461312586
Extra cycle  E= -128.537722052469  delta_E= -3.98e-13  |g|= 2.32e-07  |ddm|= 1.94e-07
    CPU time for scf_cycle      0.29 sec, wall time      0.28 sec
exp = [1.80764787e+04 2.71209744e+03 6.17488074e+02 1.74976713e+02
 2.04787640e+01 5.69661521e+01 4.87585818e-01 7.81772805e+00
 1.65436184e+00 7.11284007e+00 2.31626314e+01 9.97313319e+01
 2.66432223e-01 2.43949709e+00 8.32901446e-01]
grad_E = [-2.75321429e-10  1.36810733e-08 -2.05976857e-07  1.04154530e-06
 -1.24949470e-06 -1.76658837e-06  1.87272241e-06 -1.09214550e-06
 -2.63154821e-07  4.96779358e-07 -5.11362970e-08  3.04191023e-09
  5.35247057e-07 -1.25941347e-06  1.26766979e-06]
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -128.537722052469
       x: [ 1.808e+04  2.712e+03 ...  2.439e+00  8.329e-01]
     nit: 74
     jac: [-2.753e-10  1.368e-08 ... -1.259e-06  1.268e-06]
    nfev: 74
    njev: 74
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.478717         1
[INPUT] 0    0    [1    /1   ]  2712.0974411         1
[INPUT] 0    0    [1    /1   ]  617.488074296        1
[INPUT] 0    0    [1    /1   ]  174.976713202        1
[INPUT] 0    0    [1    /1   ]  20.4787640396        1
[INPUT] 0    0    [1    /1   ]  56.9661520768        1
[INPUT] 0    0    [1    /1   ]  0.487585817879       1
[INPUT] 0    0    [1    /1   ]  7.81772804554        1
[INPUT] 0    0    [1    /1   ]  1.65436183896        1
[INPUT] 1    0    [1    /1   ]  7.11284007405        1
[INPUT] 1    0    [1    /1   ]  23.1626313947        1
[INPUT] 1    0    [1    /1   ]  99.73133194          1
[INPUT] 1    0    [1    /1   ]  0.266432223038       1
[INPUT] 1    0    [1    /1   ]  2.43949709184        1
[INPUT] 1    0    [1    /1   ]  0.832901445688       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478716978905, 1.0]], [0, [2712.097441098166, 1.0]], [0, [617.488074296102, 1.0]], [0, [174.9767132023953, 1.0]], [0, [20.478764039603604, 1.0]], [0, [56.966152076801556, 1.0]], [0, [0.48758581787851274, 1.0]], [0, [7.817728045537474, 1.0]], [0, [1.6543618389607975, 1.0]], [1, [7.112840074048945, 1.0]], [1, [23.162631394705006, 1.0]], [1, [99.73133193996868, 1.0]], [1, [0.2664322230383457, 1.0]], [1, [2.439497091842513, 1.0]], [1, [0.832901445687817, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871698]
bas 1, expnt(s) = [2712.0974411]
bas 2, expnt(s) = [617.4880743]
bas 3, expnt(s) = [174.9767132]
bas 4, expnt(s) = [20.47876404]
bas 5, expnt(s) = [56.96615208]
bas 6, expnt(s) = [0.48758582]
bas 7, expnt(s) = [7.81772805]
bas 8, expnt(s) = [1.65436184]
bas 9, expnt(s) = [7.11284007]
bas 10, expnt(s) = [23.16263139]
bas 11, expnt(s) = [99.73133194]
bas 12, expnt(s) = [0.26643222]
bas 13, expnt(s) = [2.43949709]
bas 14, expnt(s) = [0.83290145]
CPU time:       290.12
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209744e+03 9.49497862e+02
 6.17488074e+02 3.12958286e+02 1.74976713e+02 1.21548671e+02
 2.04787640e+01 2.43216386e+01 5.69661521e+01 5.23875017e+01
 4.87585818e-01 1.47418953e+00 7.81772805e+00 1.18120545e+01
 1.65436184e+00 3.68542775e+00 7.11284007e+00 3.38873960e+01
 2.31626314e+01 1.48241316e+02 9.97313319e+01 9.19441107e+02
 2.66432223e-01 5.58428826e-01 2.43949709e+00 8.89425903e+00
 8.32901446e-01 2.32127403e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99917536867351
cond(S) = 239.19095340403362
E1 = -183.58671792730175  E_coul = 55.08139258655358
init E= -128.505325340748
    CPU time for initialize scf      0.04 sec, wall time      0.04 sec
  HOMO = -0.77533669662406  LUMO = 0.824638575618122
  mo_energy =
[-3.25542660e+01 -1.85119931e+00 -7.75336697e-01 -7.75336697e-01
 -7.75336697e-01  8.24638576e-01  8.24638576e-01  8.24638576e-01
  2.06155781e+00  3.95403859e+00  3.95403859e+00  3.95403859e+00
  1.43494539e+01  1.43494539e+01  1.43494539e+01  1.94253910e+01
  5.29844551e+01  5.29844551e+01  5.29844551e+01  9.38369359e+01
  2.40706665e+02  2.40706665e+02  2.40706665e+02  3.56225376e+02
  1.34972735e+03  5.83621207e+03  3.50988078e+04]
E1 = -182.09123842622495  E_coul = 53.557014428293485
cycle= 1 E= -128.534223997931  delta_E= -0.0289  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502606
diis-c [-0.25261287  1.        ]
  HOMO = -0.883297561290072  LUMO = 0.798380974646134
  mo_energy =
[-3.28767729e+01 -1.96458425e+00 -8.83297561e-01 -8.83297561e-01
 -8.83297561e-01  7.98380975e-01  7.98380975e-01  7.98380975e-01
  1.98450818e+00  3.85747958e+00  3.85747958e+00  3.85747958e+00
  1.41596703e+01  1.41596703e+01  1.41596703e+01  1.92039157e+01
  5.27042936e+01  5.27042936e+01  5.27042936e+01  9.35331071e+01
  2.40361120e+02  2.40361120e+02  2.40361120e+02  3.55874086e+02
  1.34933787e+03  5.83579072e+03  3.50983648e+04]
E1 = -182.8496575495057  E_coul = 54.312844252695356
cycle= 2 E= -128.53681329681  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253725
diis-c [-6.05052104e-04  3.34683605e-01  6.65316395e-01]
  HOMO = -0.847756370879698  LUMO = 0.807071157441688
  mo_energy =
[-3.27688855e+01 -1.92706687e+00 -8.47756371e-01 -8.47756371e-01
 -8.47756371e-01  8.07071157e-01  8.07071157e-01  8.07071157e-01
  2.00977344e+00  3.88902130e+00  3.88902130e+00  3.88902130e+00
  1.42227146e+01  1.42227146e+01  1.42227146e+01  1.92780703e+01
  5.27981317e+01  5.27981317e+01  5.27981317e+01  9.36349680e+01
  2.40474549e+02  2.40474549e+02  2.40474549e+02  3.55988785e+02
  1.34945882e+03  5.83591461e+03  3.50984899e+04]
E1 = -182.59323183019265  E_coul = 54.05550979557837
cycle= 3 E= -128.537722034614  delta_E= -0.000909  |g|= 0.000471  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120374
diis-c [-1.07624930e-07 -2.16372413e-03  2.89991746e-04  1.00187373e+00]
  HOMO = -0.847980324065186  LUMO = 0.807045037476973
  mo_energy =
[-3.27693483e+01 -1.92723905e+00 -8.47980324e-01 -8.47980324e-01
 -8.47980324e-01  8.07045037e-01  8.07045037e-01  8.07045037e-01
  2.00968299e+00  3.88887254e+00  3.88887254e+00  3.88887254e+00
  1.42224339e+01  1.42224339e+01  1.42224339e+01  1.92777760e+01
  5.27977348e+01  5.27977348e+01  5.27977348e+01  9.36345358e+01
  2.40474009e+02  2.40474009e+02  2.40474009e+02  3.55988218e+02
  1.34945810e+03  5.83591377e+03  3.50984890e+04]
E1 = -182.59384114921883  E_coul = 54.056119097215635
cycle= 4 E= -128.537722052003  delta_E= -1.74e-08  |g|= 7.21e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018735
diis-c [-4.61633987e-10  1.31708419e-04  4.91713604e-04 -1.27257963e-01
  1.12663454e+00]
  HOMO = -0.848015087183908  LUMO = 0.80703481711735
  mo_energy =
[-3.27694189e+01 -1.92726843e+00 -8.48015087e-01 -8.48015087e-01
 -8.48015087e-01  8.07034817e-01  8.07034817e-01  8.07034817e-01
  2.00966015e+00  3.88883975e+00  3.88883975e+00  3.88883975e+00
  1.42223818e+01  1.42223818e+01  1.42223818e+01  1.92777219e+01
  5.27976700e+01  5.27976700e+01  5.27976700e+01  9.36344677e+01
  2.40473933e+02  2.40473933e+02  2.40473933e+02  3.55988141e+02
  1.34945802e+03  5.83591368e+03  3.50984889e+04]
E1 = -182.59399402959033  E_coul = 54.056271977122144
cycle= 5 E= -128.537722052468  delta_E= -4.65e-10  |g|= 2.73e-06  |ddm|= 1.68e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59399402959033  E_coul = 54.056271977122144
  HOMO = -0.84801395969172  LUMO = 0.807035145196202
  mo_energy =
[-3.27694164e+01 -1.92726679e+00 -8.48013960e-01 -8.48013960e-01
 -8.48013960e-01  8.07035145e-01  8.07035145e-01  8.07035145e-01
  2.00966138e+00  3.88884083e+00  3.88884083e+00  3.88884083e+00
  1.42223837e+01  1.42223837e+01  1.42223837e+01  1.92777242e+01
  5.27976725e+01  5.27976725e+01  5.27976725e+01  9.36344701e+01
  2.40473935e+02  2.40473935e+02  2.40473935e+02  3.55988143e+02
  1.34945802e+03  5.83591368e+03  3.50984889e+04]
E1 = -182.59398777506158  E_coul = 54.05626572259256
Extra cycle  E= -128.537722052469  delta_E= -8.24e-13  |g|= 9.01e-07  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [1.80764787e+04 2.71209744e+03 6.17488074e+02 1.74976713e+02
 2.04787640e+01 5.69661521e+01 4.87585818e-01 7.81772805e+00
 1.65436184e+00 7.11284007e+00 2.31626314e+01 9.97313319e+01
 2.66432223e-01 2.43949709e+00 8.32901446e-01]
E = -128.537722052469
E = -128.537722052469
exponents = [
S
1.8076478716978905e+04
2.7120974410981662e+03
6.1748807429610201e+02
1.7497671320239530e+02
2.0478764039603604e+01
5.6966152076801556e+01
4.8758581787851274e-01
7.8177280455374740e+00
1.6543618389607975e+00

P
7.1128400740489450e+00
2.3162631394705006e+01
9.9731331939968683e+01
2.6643222303834568e-01
2.4394970918425130e+00
8.3290144568781699e-01

]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="SLSQP",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print("exponents = [")
    
    nums_orbs = parse_basis_str(basis_str)

    k = 0

    for [n, orb] in nums_orbs:
        print(orb)
        for _ in range(n):
            print('{:.16e}'.format(res.x[k]))
            k += 1
        print()

    print("]")

    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]
basis_sets["7s3p"] = [2.4390075690552967e+03,1.0580926109938895e+02,4.2192711437368337e+02,5.1593409210835128e-01,3.1504016232054564e+01,1.0240220273421087e+01,1.7551847895972341e+00,2.7751256722172064e+00,1.3322964844588586e+01,5.9994551740093038e-01]
basis_sets["6s4p"] = [1.4265551466920454e+03,4.8354520741444922e+01,2.1502105830468099e+02,5.6310825054641589e-01,1.3001796699822732e+01,1.8805966219616030e+00,1.6946730178259242e+00,6.2670807934445865e+00,2.8381020603901739e+01,4.3221085695400646e-01]
basis_sets["7s4p"] = [3.6960567336246650e+03,5.5593547531152421e+02,3.5190838533247671e+01,1.2627839415830076e+02,5.1718539630970484e-01,1.0895522848314705e+01,1.7511034518186483e+00,1.6952321169622300e+00,6.2691557502516853e+00,2.8383344593008118e+01,4.3196178418460596e-01]
basis_sets["8s4p"] = [8.7816323801215149e+03,1.3188006358122966e+03,3.0019278390801526e+02,2.7249628715451394e+01,8.4732333465656069e+01,5.0164876156559568e-01,9.3958875826207979e+00,1.7096846240610308e+00,1.6953866814256713e+00,6.2703246151612344e+00,2.8386448001619996e+01,4.3186669700512720e-01]
basis_sets["9s4p"] = [1.8076478730025585e+04,2.7120968240743605e+03,6.1749848237795163e+02,1.7490701952603408e+02,2.0481696404333736e+01,5.6955105687907377e+01,4.8708315011319209e-01,7.8199534667255826e+00,1.6542785764618793e+00,1.6952104139604154e+00,6.2709982871620742e+00,2.8391647309720582e+01,4.3173241803281515e-01]
basis_sets["9s5p"] = [1.8076478730068942e+04,2.7120968187016751e+03,6.1749859992301219e+02,1.7490601681032561e+02,2.0494878252052462e+01,5.6961756758431633e+01,4.8743060588868348e-01,7.8275019685132898e+00,1.6542257239856788e+00,3.6819386296497383e+00,1.2440106269745918e+01,5.4752648300984625e+01,3.3084531034933168e-01,1.1443772691236038e+00]
basis_sets["10s4p"] = [2.4413794131411723e+04,3.6614543980684439e+03,8.3327243429084604e+02,2.3572174295291873e+02,7.6480966412919344e+01,1.0122066847702175e+01,2.7146549393661314e+01,3.9207517955511839e-01,3.0080524478046877e+00,1.1598582744527119e+00,1.6905346253349034e+00,6.2556786183736550e+00,2.8330140507915555e+01,4.3062835422989021e-01]

basis = "9s6p"

exps = np.zeros((15, 2))
exps[:-1, 0] = basis_sets["9s5p"][:]
exps[-1, 0] = 0.5

# exps[1:, 0] = basis_sets["9s5p"][:]
# exps[0, 0] = 0.5

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 18:57:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  18076.478717         1
[INPUT] 0    0    [1    /1   ]  2712.0974411         1
[INPUT] 0    0    [1    /1   ]  617.488074296        1
[INPUT] 0    0    [1    /1   ]  174.976713202        1
[INPUT] 0    0    [1    /1   ]  20.4787640396        1
[INPUT] 0    0    [1    /1   ]  56.9661520768        1
[INPUT] 0    0    [1    /1   ]  0.487585817879       1
[INPUT] 0    0    [1    /1   ]  7.81772804554        1
[INPUT] 0    0    [1    /1   ]  1.65436183896        1
[INPUT] 1    0    [1    /1   ]  7.11284007405        1
[INPUT] 1    0    [1    /1   ]  23.1626313947        1
[INPUT] 1    0    [1    /1   ]  99.73133194          1
[INPUT] 1    0    [1    /1   ]  0.266432223038       1
[INPUT] 1    0    [1    /1   ]  2.43949709184        1
[INPUT] 1    0    [1    /1   ]  0.832901445688       1

nuclear repulsion = 0
number of shells = 15
number of NR pGTOs = 27
number of NR cGTOs = 27
basis = {'Ne': [[0, [18076.478716978905, 1.0]], [0, [2712.097441098166, 1.0]], [0, [617.488074296102, 1.0]], [0, [174.9767132023953, 1.0]], [0, [20.478764039603604, 1.0]], [0, [56.966152076801556, 1.0]], [0, [0.48758581787851274, 1.0]], [0, [7.817728045537474, 1.0]], [0, [1.6543618389607975, 1.0]], [1, [7.112840074048945, 1.0]], [1, [23.162631394705006, 1.0]], [1, [99.73133193996868, 1.0]], [1, [0.2664322230383457, 1.0]], [1, [2.439497091842513, 1.0]], [1, [0.832901445687817, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [18076.47871698]
bas 1, expnt(s) = [2712.0974411]
bas 2, expnt(s) = [617.4880743]
bas 3, expnt(s) = [174.9767132]
bas 4, expnt(s) = [20.47876404]
bas 5, expnt(s) = [56.96615208]
bas 6, expnt(s) = [0.48758582]
bas 7, expnt(s) = [7.81772805]
bas 8, expnt(s) = [1.65436184]
bas 9, expnt(s) = [7.11284007]
bas 10, expnt(s) = [23.16263139]
bas 11, expnt(s) = [99.73133194]
bas 12, expnt(s) = [0.26643222]
bas 13, expnt(s) = [2.43949709]
bas 14, expnt(s) = [0.83290145]
CPU time:       291.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  0  1  1  0 38 39  0]
 [ 0  0  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]
 [ 0  1  1  1  0 44 45  0]
 [ 0  1  1  1  0 46 47  0]
 [ 0  1  1  1  0 48 49  0]
 [ 0  1  1  1  0 50 51  0]
 [ 0  1  1  1  0 52 53  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 1.80764787e+04 3.93867730e+03 2.71209744e+03 9.49497862e+02
 6.17488074e+02 3.12958286e+02 1.74976713e+02 1.21548671e+02
 2.04787640e+01 2.43216386e+01 5.69661521e+01 5.23875017e+01
 4.87585818e-01 1.47418953e+00 7.81772805e+00 1.18120545e+01
 1.65436184e+00 3.68542775e+00 7.11284007e+00 3.38873960e+01
 2.31626314e+01 1.48241316e+02 9.97313319e+01 9.19441107e+02
 2.66432223e-01 5.58428826e-01 2.43949709e+00 8.89425903e+00
 8.32901446e-01 2.32127403e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.99917536867351
cond(S) = 239.19095340403362
E1 = -183.58671792730175  E_coul = 55.08139258655358
init E= -128.505325340748
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.77533669662406  LUMO = 0.824638575618122
  mo_energy =
[-3.25542660e+01 -1.85119931e+00 -7.75336697e-01 -7.75336697e-01
 -7.75336697e-01  8.24638576e-01  8.24638576e-01  8.24638576e-01
  2.06155781e+00  3.95403859e+00  3.95403859e+00  3.95403859e+00
  1.43494539e+01  1.43494539e+01  1.43494539e+01  1.94253910e+01
  5.29844551e+01  5.29844551e+01  5.29844551e+01  9.38369359e+01
  2.40706665e+02  2.40706665e+02  2.40706665e+02  3.56225376e+02
  1.34972735e+03  5.83621207e+03  3.50988078e+04]
E1 = -182.09123842622495  E_coul = 53.557014428293485
cycle= 1 E= -128.534223997931  delta_E= -0.0289  |g|= 0.204  |ddm|= 0.167
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.502606
diis-c [-0.25261287  1.        ]
  HOMO = -0.883297561290072  LUMO = 0.798380974646134
  mo_energy =
[-3.28767729e+01 -1.96458425e+00 -8.83297561e-01 -8.83297561e-01
 -8.83297561e-01  7.98380975e-01  7.98380975e-01  7.98380975e-01
  1.98450818e+00  3.85747958e+00  3.85747958e+00  3.85747958e+00
  1.41596703e+01  1.41596703e+01  1.41596703e+01  1.92039157e+01
  5.27042936e+01  5.27042936e+01  5.27042936e+01  9.35331071e+01
  2.40361120e+02  2.40361120e+02  2.40361120e+02  3.55874086e+02
  1.34933787e+03  5.83579072e+03  3.50983648e+04]
E1 = -182.8496575495057  E_coul = 54.312844252695356
cycle= 2 E= -128.53681329681  delta_E= -0.00259  |g|= 0.103  |ddm|= 0.0734
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.253725
diis-c [-6.05052104e-04  3.34683605e-01  6.65316395e-01]
  HOMO = -0.847756370879698  LUMO = 0.807071157441688
  mo_energy =
[-3.27688855e+01 -1.92706687e+00 -8.47756371e-01 -8.47756371e-01
 -8.47756371e-01  8.07071157e-01  8.07071157e-01  8.07071157e-01
  2.00977344e+00  3.88902130e+00  3.88902130e+00  3.88902130e+00
  1.42227146e+01  1.42227146e+01  1.42227146e+01  1.92780703e+01
  5.27981317e+01  5.27981317e+01  5.27981317e+01  9.36349680e+01
  2.40474549e+02  2.40474549e+02  2.40474549e+02  3.55988785e+02
  1.34945882e+03  5.83591461e+03  3.50984899e+04]
E1 = -182.59323183019265  E_coul = 54.05550979557837
cycle= 3 E= -128.537722034614  delta_E= -0.000909  |g|= 0.000471  |ddm|= 0.0254
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00120374
diis-c [-1.07624930e-07 -2.16372413e-03  2.89991746e-04  1.00187373e+00]
  HOMO = -0.847980324065186  LUMO = 0.807045037476973
  mo_energy =
[-3.27693483e+01 -1.92723905e+00 -8.47980324e-01 -8.47980324e-01
 -8.47980324e-01  8.07045037e-01  8.07045037e-01  8.07045037e-01
  2.00968299e+00  3.88887254e+00  3.88887254e+00  3.88887254e+00
  1.42224339e+01  1.42224339e+01  1.42224339e+01  1.92777760e+01
  5.27977348e+01  5.27977348e+01  5.27977348e+01  9.36345358e+01
  2.40474009e+02  2.40474009e+02  2.40474009e+02  3.55988218e+02
  1.34945810e+03  5.83591377e+03  3.50984890e+04]
E1 = -182.59384114921883  E_coul = 54.056119097215635
cycle= 4 E= -128.537722052003  delta_E= -1.74e-08  |g|= 7.21e-05  |ddm|= 0.000116
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00018735
diis-c [-4.61633987e-10  1.31708419e-04  4.91713604e-04 -1.27257963e-01
  1.12663454e+00]
  HOMO = -0.848015087183908  LUMO = 0.80703481711735
  mo_energy =
[-3.27694189e+01 -1.92726843e+00 -8.48015087e-01 -8.48015087e-01
 -8.48015087e-01  8.07034817e-01  8.07034817e-01  8.07034817e-01
  2.00966015e+00  3.88883975e+00  3.88883975e+00  3.88883975e+00
  1.42223818e+01  1.42223818e+01  1.42223818e+01  1.92777219e+01
  5.27976700e+01  5.27976700e+01  5.27976700e+01  9.36344677e+01
  2.40473933e+02  2.40473933e+02  2.40473933e+02  3.55988141e+02
  1.34945802e+03  5.83591368e+03  3.50984889e+04]
E1 = -182.59399402959033  E_coul = 54.056271977122144
cycle= 5 E= -128.537722052468  delta_E= -4.65e-10  |g|= 2.73e-06  |ddm|= 1.68e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.59399402959033  E_coul = 54.056271977122144
  HOMO = -0.84801395969172  LUMO = 0.807035145196202
  mo_energy =
[-3.27694164e+01 -1.92726679e+00 -8.48013960e-01 -8.48013960e-01
 -8.48013960e-01  8.07035145e-01  8.07035145e-01  8.07035145e-01
  2.00966138e+00  3.88884083e+00  3.88884083e+00  3.88884083e+00
  1.42223837e+01  1.42223837e+01  1.42223837e+01  1.92777242e+01
  5.27976725e+01  5.27976725e+01  5.27976725e+01  9.36344701e+01
  2.40473935e+02  2.40473935e+02  2.40473935e+02  3.55988143e+02
  1.34945802e+03  5.83591368e+03  3.50984889e+04]
E1 = -182.59398777506158  E_coul = 54.05626572259256
Extra cycle  E= -128.537722052469  delta_E= -8.24e-13  |g|= 9.01e-07  |ddm|= 1.49e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [1.80764787e+04 2.71209744e+03 6.17488074e+02 1.74976713e+02
 2.04787640e+01 5.69661521e+01 4.87585818e-01 7.81772805e+00
 1.65436184e+00 7.11284007e+00 2.31626314e+01 9.97313319e+01
 2.66432223e-01 2.43949709e+00 8.32901446e-01]
E = -128.537722052469
E = -128.537722052469
exp = [1.8076478716978905e+04,2.7120974410981662e+03,6.1748807429610201e+02,1.7497671320239530e+02,2.0478764039603604e+01,5.6966152076801556e+01,4.8758581787851274e-01,7.8177280455374740e+00,1.6543618389607975e+00,7.1128400740489450e+00,2.3162631394705006e+01,9.9731331939968683e+01,2.6643222303834568e-01,2.4394970918425130e+00,8.3290144568781699e-01]
