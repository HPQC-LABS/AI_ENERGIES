#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:44:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19154206        1
[INPUT] 0    0    [1    /1   ]  215.458444554        1
[INPUT] 0    0    [1    /1   ]  1429.46102804        1
[INPUT] 0    0    [1    /1   ]  0.567717378905       1
[INPUT] 0    0    [1    /1   ]  48.4585973054        1
[INPUT] 0    0    [1    /1   ]  13.0328336133        1
[INPUT] 0    0    [1    /1   ]  1.90224065621        1
[INPUT] 1    0    [1    /1   ]  2.77760426799        1
[INPUT] 1    0    [1    /1   ]  13.3319133077        1
[INPUT] 1    0    [1    /1   ]  0.600574707452       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1915420579808, 1.0]], [0, [215.45844455359133, 1.0]], [0, [1429.4610280386537, 1.0]], [0, [0.5677173789049907, 1.0]], [0, [48.45859730536646, 1.0]], [0, [13.032833613337074, 1.0]], [0, [1.9022406562127316, 1.0]], [1, [2.7776042679910673, 1.0]], [1, [13.33191330773249, 1.0]], [1, [0.6005747074522553, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19154206]
bas 1, expnt(s) = [215.45844455]
bas 2, expnt(s) = [1429.46102804]
bas 3, expnt(s) = [0.56771738]
bas 4, expnt(s) = [48.45859731]
bas 5, expnt(s) = [13.03283361]
bas 6, expnt(s) = [1.90224066]
bas 7, expnt(s) = [2.77760427]
bas 8, expnt(s) = [13.33191331]
bas 9, expnt(s) = [0.60057471]
CPU time:         1.10
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419154e+03 7.96090989e+02 2.15458445e+02 1.42081543e+02
 1.42946103e+03 5.87346336e+02 5.67717379e-01 1.65239612e+00
 4.84585973e+01 4.64026895e+01 1.30328336e+01 1.73298244e+01
 1.90224066e+00 4.09226848e+00 2.77760427e+00 1.04609796e+01
 1.33319133e+01 7.43190233e+01 6.00574707e-01 1.54238641e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965780864283118
cond(S) = 156.3037736824839
E1 = -183.1357068001988  E_coul = 55.011225952726235
init E= -128.124480847473
    CPU time for initialize scf      0.11 sec, wall time      0.11 sec
  HOMO = -0.742894181662367  LUMO = 2.6579662999474
  mo_energy =
[-3.25128659e+01 -1.85388050e+00 -7.42894182e-01 -7.42894182e-01
 -7.42894182e-01  2.65796630e+00  2.65796630e+00  2.65796630e+00
  2.70227650e+00  1.99606947e+01  1.99606947e+01  1.99606947e+01
  4.40511986e+01  3.19573371e+02  1.98496529e+03  7.27407799e+03]
E1 = -182.12816712336294  E_coul = 53.93308227017969
cycle= 1 E= -128.195084853183  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.26 sec, wall time      0.26 sec
diis-norm(errvec)=0.26244
diis-c [-0.06887479  1.        ]
  HOMO = -0.808034514213963  LUMO = 2.60365535373203
  mo_energy =
[-3.27871554e+01 -1.92110048e+00 -8.08034514e-01 -8.08034514e-01
 -8.08034514e-01  2.60365535e+00  2.60365535e+00  2.60365535e+00
  2.64961491e+00  1.97693873e+01  1.97693873e+01  1.97693873e+01
  4.38169092e+01  3.19262897e+02  1.98460413e+03  7.27369136e+03]
E1 = -182.59167552671238  E_coul = 54.39495188039686
cycle= 2 E= -128.196723646316  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.08 sec, wall time      0.08 sec
diis-norm(errvec)=0.10211
diis-c [-4.49390632e-04  2.76332839e-01  7.23667161e-01]
  HOMO = -0.785165543497528  LUMO = 2.6243675889914
  mo_energy =
[-3.27120876e+01 -1.89737750e+00 -7.85165543e-01 -7.85165543e-01
 -7.85165543e-01  2.62436759e+00  2.62436759e+00  2.62436759e+00
  2.66952697e+00  1.98257771e+01  1.98257771e+01  1.98257771e+01
  4.38829171e+01  3.19344753e+02  1.98469161e+03  7.27378034e+03]
E1 = -182.45885221330172  E_coul = 54.261822137763474
cycle= 3 E= -128.197030075538  delta_E= -0.000306  |g|= 0.00079  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107387
diis-c [-6.10159379e-08 -3.47101164e-03  1.38525613e-03  1.00208576e+00]
  HOMO = -0.785443076283742  LUMO = 2.62415083719174
  mo_energy =
[-3.27128938e+01 -1.89771729e+00 -7.85443076e-01 -7.85443076e-01
 -7.85443076e-01  2.62415084e+00  2.62415084e+00  2.62415084e+00
  2.66926204e+00  1.98251504e+01  1.98251504e+01  1.98251504e+01
  4.38821717e+01  3.19344079e+02  1.98469105e+03  7.27377982e+03]
E1 = -182.46038268213164  E_coul = 54.263352562795326
cycle= 4 E= -128.197030119336  delta_E= -4.38e-08  |g|= 4.44e-05  |ddm|= 0.000277
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.0912e-05
diis-c [-1.98141129e-10  4.44343193e-04 -1.19884980e-03 -1.62638936e-01
  1.16339344e+00]
  HOMO = -0.78543029751615  LUMO = 2.62416195405862
  mo_energy =
[-3.27128609e+01 -1.89771482e+00 -7.85430298e-01 -7.85430298e-01
 -7.85430298e-01  2.62416195e+00  2.62416195e+00  2.62416195e+00
  2.66926345e+00  1.98251759e+01  1.98251759e+01  1.98251759e+01
  4.38821983e+01  3.19344125e+02  1.98469111e+03  7.27377988e+03]
E1 = -182.46032776344822  E_coul = 54.263297643887064
cycle= 5 E= -128.197030119561  delta_E= -2.25e-10  |g|= 1.59e-06  |ddm|= 2.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46032776344822  E_coul = 54.263297643887064
  HOMO = -0.785430161661336  LUMO = 2.62416208200367
  mo_energy =
[-3.27128607e+01 -1.89771508e+00 -7.85430162e-01 -7.85430162e-01
 -7.85430162e-01  2.62416208e+00  2.62416208e+00  2.62416208e+00
  2.66926323e+00  1.98251761e+01  1.98251761e+01  1.98251761e+01
  4.38821984e+01  3.19344125e+02  1.98469111e+03  7.27377988e+03]
E1 = -182.46032742465485  E_coul = 54.263297305093474
Extra cycle  E= -128.197030119561  delta_E= -1.99e-13  |g|= 3.02e-07  |ddm|= 9.17e-07
    CPU time for scf_cycle      0.49 sec, wall time      0.49 sec
exp = [2.14419154e+03 2.15458445e+02 1.42946103e+03 5.67717379e-01
 4.84585973e+01 1.30328336e+01 1.90224066e+00 2.77760427e+00
 1.33319133e+01 6.00574707e-01]
E = -128.19703011956136
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:44:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19154206        1
[INPUT] 0    0    [1    /1   ]  215.458444554        1
[INPUT] 0    0    [1    /1   ]  1429.46102804        1
[INPUT] 0    0    [1    /1   ]  0.567717378905       1
[INPUT] 0    0    [1    /1   ]  48.4585973054        1
[INPUT] 0    0    [1    /1   ]  13.0328336133        1
[INPUT] 0    0    [1    /1   ]  1.90224065621        1
[INPUT] 1    0    [1    /1   ]  2.77760426799        1
[INPUT] 1    0    [1    /1   ]  13.3319133077        1
[INPUT] 1    0    [1    /1   ]  0.600574707452       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1915420579808, 1.0]], [0, [215.45844455359133, 1.0]], [0, [1429.4610280386537, 1.0]], [0, [0.5677173789049907, 1.0]], [0, [48.45859730536646, 1.0]], [0, [13.032833613337074, 1.0]], [0, [1.9022406562127316, 1.0]], [1, [2.7776042679910673, 1.0]], [1, [13.33191330773249, 1.0]], [1, [0.6005747074522553, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19154206]
bas 1, expnt(s) = [215.45844455]
bas 2, expnt(s) = [1429.46102804]
bas 3, expnt(s) = [0.56771738]
bas 4, expnt(s) = [48.45859731]
bas 5, expnt(s) = [13.03283361]
bas 6, expnt(s) = [1.90224066]
bas 7, expnt(s) = [2.77760427]
bas 8, expnt(s) = [13.33191331]
bas 9, expnt(s) = [0.60057471]
CPU time:         1.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419154e+03 7.96090989e+02 2.15458445e+02 1.42081543e+02
 1.42946103e+03 5.87346336e+02 5.67717379e-01 1.65239612e+00
 4.84585973e+01 4.64026895e+01 1.30328336e+01 1.73298244e+01
 1.90224066e+00 4.09226848e+00 2.77760427e+00 1.04609796e+01
 1.33319133e+01 7.43190233e+01 6.00574707e-01 1.54238641e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965780864283118
cond(S) = 156.3037736824839
E1 = -183.1357068001988  E_coul = 55.011225952726235
init E= -128.124480847473
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742894181662367  LUMO = 2.6579662999474
  mo_energy =
[-3.25128659e+01 -1.85388050e+00 -7.42894182e-01 -7.42894182e-01
 -7.42894182e-01  2.65796630e+00  2.65796630e+00  2.65796630e+00
  2.70227650e+00  1.99606947e+01  1.99606947e+01  1.99606947e+01
  4.40511986e+01  3.19573371e+02  1.98496529e+03  7.27407799e+03]
E1 = -182.12816712336294  E_coul = 53.93308227017969
cycle= 1 E= -128.195084853183  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26244
diis-c [-0.06887479  1.        ]
  HOMO = -0.808034514213963  LUMO = 2.60365535373203
  mo_energy =
[-3.27871554e+01 -1.92110048e+00 -8.08034514e-01 -8.08034514e-01
 -8.08034514e-01  2.60365535e+00  2.60365535e+00  2.60365535e+00
  2.64961491e+00  1.97693873e+01  1.97693873e+01  1.97693873e+01
  4.38169092e+01  3.19262897e+02  1.98460413e+03  7.27369136e+03]
E1 = -182.59167552671238  E_coul = 54.39495188039686
cycle= 2 E= -128.196723646316  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10211
diis-c [-4.49390632e-04  2.76332839e-01  7.23667161e-01]
  HOMO = -0.785165543497528  LUMO = 2.6243675889914
  mo_energy =
[-3.27120876e+01 -1.89737750e+00 -7.85165543e-01 -7.85165543e-01
 -7.85165543e-01  2.62436759e+00  2.62436759e+00  2.62436759e+00
  2.66952697e+00  1.98257771e+01  1.98257771e+01  1.98257771e+01
  4.38829171e+01  3.19344753e+02  1.98469161e+03  7.27378034e+03]
E1 = -182.45885221330172  E_coul = 54.261822137763474
cycle= 3 E= -128.197030075538  delta_E= -0.000306  |g|= 0.00079  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107387
diis-c [-6.10159379e-08 -3.47101164e-03  1.38525613e-03  1.00208576e+00]
  HOMO = -0.785443076283742  LUMO = 2.62415083719174
  mo_energy =
[-3.27128938e+01 -1.89771729e+00 -7.85443076e-01 -7.85443076e-01
 -7.85443076e-01  2.62415084e+00  2.62415084e+00  2.62415084e+00
  2.66926204e+00  1.98251504e+01  1.98251504e+01  1.98251504e+01
  4.38821717e+01  3.19344079e+02  1.98469105e+03  7.27377982e+03]
E1 = -182.46038268213164  E_coul = 54.263352562795326
cycle= 4 E= -128.197030119336  delta_E= -4.38e-08  |g|= 4.44e-05  |ddm|= 0.000277
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.0912e-05
diis-c [-1.98141129e-10  4.44343193e-04 -1.19884980e-03 -1.62638936e-01
  1.16339344e+00]
  HOMO = -0.78543029751615  LUMO = 2.62416195405862
  mo_energy =
[-3.27128609e+01 -1.89771482e+00 -7.85430298e-01 -7.85430298e-01
 -7.85430298e-01  2.62416195e+00  2.62416195e+00  2.62416195e+00
  2.66926345e+00  1.98251759e+01  1.98251759e+01  1.98251759e+01
  4.38821983e+01  3.19344125e+02  1.98469111e+03  7.27377988e+03]
E1 = -182.46032776344822  E_coul = 54.263297643887064
cycle= 5 E= -128.197030119561  delta_E= -2.25e-10  |g|= 1.59e-06  |ddm|= 2.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46032776344822  E_coul = 54.263297643887064
  HOMO = -0.785430161661336  LUMO = 2.62416208200367
  mo_energy =
[-3.27128607e+01 -1.89771508e+00 -7.85430162e-01 -7.85430162e-01
 -7.85430162e-01  2.62416208e+00  2.62416208e+00  2.62416208e+00
  2.66926323e+00  1.98251761e+01  1.98251761e+01  1.98251761e+01
  4.38821984e+01  3.19344125e+02  1.98469111e+03  7.27377988e+03]
E1 = -182.46032742465485  E_coul = 54.263297305093474
Extra cycle  E= -128.197030119561  delta_E= -1.99e-13  |g|= 3.02e-07  |ddm|= 9.17e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.3037736824839
E1 = -182.46032742465485  E_coul = 54.263297305093474
init E= -128.197030119561
    CPU time for initialize scf      0.28 sec, wall time      0.28 sec
  HOMO = -0.785430168491077  LUMO = 2.62416207416457
  mo_energy =
[-3.27128607e+01 -1.89771516e+00 -7.85430168e-01 -7.85430168e-01
 -7.85430168e-01  2.62416207e+00  2.62416207e+00  2.62416207e+00
  2.66926315e+00  1.98251760e+01  1.98251760e+01  1.98251760e+01
  4.38821983e+01  3.19344125e+02  1.98469111e+03  7.27377988e+03]
E1 = -182.46032757183687  E_coul = 54.26329745227544
cycle= 1 E= -128.197030119561  delta_E= -5.68e-14  |g|= 5.59e-08  |ddm|= 1.77e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46032757183687  E_coul = 54.26329745227544
  HOMO = -0.785430155340098  LUMO = 2.62416208578757
  mo_energy =
[-3.27128607e+01 -1.89771516e+00 -7.85430155e-01 -7.85430155e-01
 -7.85430155e-01  2.62416209e+00  2.62416209e+00  2.62416209e+00
  2.66926315e+00  1.98251761e+01  1.98251761e+01  1.98251761e+01
  4.38821983e+01  3.19344125e+02  1.98469111e+03  7.27377988e+03]
E1 = -182.4603275162329  E_coul = 54.26329739667139
Extra cycle  E= -128.197030119562  delta_E= -8.53e-14  |g|= 1.29e-08  |ddm|= 2.86e-08
    CPU time for scf_cycle      0.98 sec, wall time      0.99 sec
exp = [2.14419154e+03 2.15458445e+02 1.42946103e+03 5.67717379e-01
 4.84585973e+01 1.30328336e+01 1.90224066e+00 2.77760427e+00
 1.33319133e+01 6.00574707e-01]
grad_E = [-7.42834696e-06 -3.47415849e-04  4.62779589e-05  3.93388885e-04
  8.93554498e-04 -1.29823923e-03  1.38084586e-04 -9.07373379e-06
  5.67611089e-07  3.12027359e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:44:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19154949        1
[INPUT] 0    0    [1    /1   ]  215.458791969        1
[INPUT] 0    0    [1    /1   ]  1429.46098176        1
[INPUT] 0    0    [1    /1   ]  0.56732399002        1
[INPUT] 0    0    [1    /1   ]  48.4577037509        1
[INPUT] 0    0    [1    /1   ]  13.0341318526        1
[INPUT] 0    0    [1    /1   ]  1.90210257163        1
[INPUT] 1    0    [1    /1   ]  2.77761334172        1
[INPUT] 1    0    [1    /1   ]  13.3319127401        1
[INPUT] 1    0    [1    /1   ]  0.600543504716       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191549486328, 1.0]], [0, [215.45879196944054, 1.0]], [0, [1429.4609817606947, 1.0]], [0, [0.5673239900198472, 1.0]], [0, [48.45770375086883, 1.0]], [0, [13.034131852569432, 1.0]], [0, [1.9021025716267643, 1.0]], [1, [2.7776133417248565, 1.0]], [1, [13.331912740121401, 1.0]], [1, [0.600543504716358, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19154949]
bas 1, expnt(s) = [215.45879197]
bas 2, expnt(s) = [1429.46098176]
bas 3, expnt(s) = [0.56732399]
bas 4, expnt(s) = [48.45770375]
bas 5, expnt(s) = [13.03413185]
bas 6, expnt(s) = [1.90210257]
bas 7, expnt(s) = [2.77761334]
bas 8, expnt(s) = [13.33191274]
bas 9, expnt(s) = [0.6005435]
CPU time:         6.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419155e+03 7.96090991e+02 2.15458792e+02 1.42081715e+02
 1.42946098e+03 5.87346322e+02 5.67323990e-01 1.65153730e+00
 4.84577038e+01 4.64020478e+01 1.30341319e+01 1.73311191e+01
 1.90210257e+00 4.09204569e+00 2.77761334e+00 1.04610223e+01
 1.33319127e+01 7.43190194e+01 6.00543505e-01 1.54228624e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965790800493671
cond(S) = 156.30083931844777
E1 = -183.13574885493927  E_coul = 55.01128366282014
init E= -128.124465192119
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742894853371492  LUMO = 2.65786325270874
  mo_energy =
[-3.25128324e+01 -1.85388767e+00 -7.42894853e-01 -7.42894853e-01
 -7.42894853e-01  2.65786325e+00  2.65786325e+00  2.65786325e+00
  2.70070528e+00  1.99606564e+01  1.99606564e+01  1.99606564e+01
  4.40516362e+01  3.19574186e+02  1.98496612e+03  7.27407886e+03]
E1 = -182.12721160706758  E_coul = 53.93212747675877
cycle= 1 E= -128.195084130309  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262671
diis-c [-0.0689959  1.       ]
  HOMO = -0.808123760587482  LUMO = 2.6034746921383
  mo_energy =
[-3.27872898e+01 -1.92117770e+00 -8.08123761e-01 -8.08123761e-01
 -8.08123761e-01  2.60347469e+00  2.60347469e+00  2.60347469e+00
  2.64800099e+00  1.97691970e+01  1.97691970e+01  1.97691970e+01
  4.38171702e+01  3.19263577e+02  1.98460484e+03  7.27369210e+03]
E1 = -182.59114681481452  E_coul = 54.39442123173953
cycle= 2 E= -128.196725583075  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102203
diis-c [-4.49720516e-04  2.76343648e-01  7.23656352e-01]
  HOMO = -0.78523408815856  LUMO = 2.6242055280746
  mo_energy =
[-3.27121552e+01 -1.89743216e+00 -7.85234088e-01 -7.85234088e-01
 -7.85234088e-01  2.62420553e+00  2.62420553e+00  2.62420553e+00
  2.66792731e+00  1.98256375e+01  1.98256375e+01  1.98256375e+01
  4.38832385e+01  3.19345504e+02  1.98469239e+03  7.27378116e+03]
E1 = -182.45818655341503  E_coul = 54.26115394583734
cycle= 3 E= -128.197032607578  delta_E= -0.000307  |g|= 0.00079  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107782
diis-c [-5.88377829e-08 -3.46038777e-03  1.45468825e-03  1.00200570e+00]
  HOMO = -0.785512500870565  LUMO = 2.62398807276753
  mo_energy =
[-3.27129633e+01 -1.89777147e+00 -7.85512501e-01 -7.85512501e-01
 -7.85512501e-01  2.62398807e+00  2.62398807e+00  2.62398807e+00
  2.66766292e+00  1.98250095e+01  1.98250095e+01  1.98250095e+01
  4.38824917e+01  3.19344828e+02  1.98469183e+03  7.27378063e+03]
E1 = -182.4597201810633  E_coul = 54.262687529738386
cycle= 4 E= -128.197032651325  delta_E= -4.37e-08  |g|= 4.34e-05  |ddm|= 0.000276
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.94104e-05
diis-c [-1.94993187e-10  4.39926337e-04 -1.18512924e-03 -1.60976782e-01
  1.16172199e+00]
  HOMO = -0.785499981034718  LUMO = 2.6239989627251
  mo_energy =
[-3.27129310e+01 -1.89776898e+00 -7.85499981e-01 -7.85499981e-01
 -7.85499981e-01  2.62399896e+00  2.62399896e+00  2.62399896e+00
  2.66766436e+00  1.98250345e+01  1.98250345e+01  1.98250345e+01
  4.38825177e+01  3.19344872e+02  1.98469188e+03  7.27378069e+03]
E1 = -182.45966632927622  E_coul = 54.26263367773677
cycle= 5 E= -128.197032651539  delta_E= -2.15e-10  |g|= 1.6e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45966632927622  E_coul = 54.26263367773677
  HOMO = -0.785499835818219  LUMO = 2.62399909904962
  mo_energy =
[-3.27129307e+01 -1.89776923e+00 -7.85499836e-01 -7.85499836e-01
 -7.85499836e-01  2.62399910e+00  2.62399910e+00  2.62399910e+00
  2.66766414e+00  1.98250347e+01  1.98250347e+01  1.98250347e+01
  4.38825179e+01  3.19344872e+02  1.98469188e+03  7.27378069e+03]
E1 = -182.4596659433308  E_coul = 54.26263329179128
Extra cycle  E= -128.19703265154  delta_E= -8.53e-14  |g|= 3.05e-07  |ddm|= 9.21e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.08 sec
exp = [2.14419155e+03 2.15458792e+02 1.42946098e+03 5.67323990e-01
 4.84577038e+01 1.30341319e+01 1.90210257e+00 2.77761334e+00
 1.33319127e+01 6.00543505e-01]
E = -128.19703265153953
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:44:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19154949        1
[INPUT] 0    0    [1    /1   ]  215.458791969        1
[INPUT] 0    0    [1    /1   ]  1429.46098176        1
[INPUT] 0    0    [1    /1   ]  0.56732399002        1
[INPUT] 0    0    [1    /1   ]  48.4577037509        1
[INPUT] 0    0    [1    /1   ]  13.0341318526        1
[INPUT] 0    0    [1    /1   ]  1.90210257163        1
[INPUT] 1    0    [1    /1   ]  2.77761334172        1
[INPUT] 1    0    [1    /1   ]  13.3319127401        1
[INPUT] 1    0    [1    /1   ]  0.600543504716       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191549486328, 1.0]], [0, [215.45879196944054, 1.0]], [0, [1429.4609817606947, 1.0]], [0, [0.5673239900198472, 1.0]], [0, [48.45770375086883, 1.0]], [0, [13.034131852569432, 1.0]], [0, [1.9021025716267643, 1.0]], [1, [2.7776133417248565, 1.0]], [1, [13.331912740121401, 1.0]], [1, [0.600543504716358, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19154949]
bas 1, expnt(s) = [215.45879197]
bas 2, expnt(s) = [1429.46098176]
bas 3, expnt(s) = [0.56732399]
bas 4, expnt(s) = [48.45770375]
bas 5, expnt(s) = [13.03413185]
bas 6, expnt(s) = [1.90210257]
bas 7, expnt(s) = [2.77761334]
bas 8, expnt(s) = [13.33191274]
bas 9, expnt(s) = [0.6005435]
CPU time:         6.56
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419155e+03 7.96090991e+02 2.15458792e+02 1.42081715e+02
 1.42946098e+03 5.87346322e+02 5.67323990e-01 1.65153730e+00
 4.84577038e+01 4.64020478e+01 1.30341319e+01 1.73311191e+01
 1.90210257e+00 4.09204569e+00 2.77761334e+00 1.04610223e+01
 1.33319127e+01 7.43190194e+01 6.00543505e-01 1.54228624e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965790800493671
cond(S) = 156.30083931844777
E1 = -183.13574885493927  E_coul = 55.01128366282014
init E= -128.124465192119
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742894853371492  LUMO = 2.65786325270874
  mo_energy =
[-3.25128324e+01 -1.85388767e+00 -7.42894853e-01 -7.42894853e-01
 -7.42894853e-01  2.65786325e+00  2.65786325e+00  2.65786325e+00
  2.70070528e+00  1.99606564e+01  1.99606564e+01  1.99606564e+01
  4.40516362e+01  3.19574186e+02  1.98496612e+03  7.27407886e+03]
E1 = -182.12721160706758  E_coul = 53.93212747675877
cycle= 1 E= -128.195084130309  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262671
diis-c [-0.0689959  1.       ]
  HOMO = -0.808123760587482  LUMO = 2.6034746921383
  mo_energy =
[-3.27872898e+01 -1.92117770e+00 -8.08123761e-01 -8.08123761e-01
 -8.08123761e-01  2.60347469e+00  2.60347469e+00  2.60347469e+00
  2.64800099e+00  1.97691970e+01  1.97691970e+01  1.97691970e+01
  4.38171702e+01  3.19263577e+02  1.98460484e+03  7.27369210e+03]
E1 = -182.59114681481452  E_coul = 54.39442123173953
cycle= 2 E= -128.196725583075  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102203
diis-c [-4.49720516e-04  2.76343648e-01  7.23656352e-01]
  HOMO = -0.78523408815856  LUMO = 2.6242055280746
  mo_energy =
[-3.27121552e+01 -1.89743216e+00 -7.85234088e-01 -7.85234088e-01
 -7.85234088e-01  2.62420553e+00  2.62420553e+00  2.62420553e+00
  2.66792731e+00  1.98256375e+01  1.98256375e+01  1.98256375e+01
  4.38832385e+01  3.19345504e+02  1.98469239e+03  7.27378116e+03]
E1 = -182.45818655341503  E_coul = 54.26115394583734
cycle= 3 E= -128.197032607578  delta_E= -0.000307  |g|= 0.00079  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107782
diis-c [-5.88377829e-08 -3.46038777e-03  1.45468825e-03  1.00200570e+00]
  HOMO = -0.785512500870565  LUMO = 2.62398807276753
  mo_energy =
[-3.27129633e+01 -1.89777147e+00 -7.85512501e-01 -7.85512501e-01
 -7.85512501e-01  2.62398807e+00  2.62398807e+00  2.62398807e+00
  2.66766292e+00  1.98250095e+01  1.98250095e+01  1.98250095e+01
  4.38824917e+01  3.19344828e+02  1.98469183e+03  7.27378063e+03]
E1 = -182.4597201810633  E_coul = 54.262687529738386
cycle= 4 E= -128.197032651325  delta_E= -4.37e-08  |g|= 4.34e-05  |ddm|= 0.000276
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.94104e-05
diis-c [-1.94993187e-10  4.39926337e-04 -1.18512924e-03 -1.60976782e-01
  1.16172199e+00]
  HOMO = -0.785499981034718  LUMO = 2.6239989627251
  mo_energy =
[-3.27129310e+01 -1.89776898e+00 -7.85499981e-01 -7.85499981e-01
 -7.85499981e-01  2.62399896e+00  2.62399896e+00  2.62399896e+00
  2.66766436e+00  1.98250345e+01  1.98250345e+01  1.98250345e+01
  4.38825177e+01  3.19344872e+02  1.98469188e+03  7.27378069e+03]
E1 = -182.45966632927622  E_coul = 54.26263367773677
cycle= 5 E= -128.197032651539  delta_E= -2.15e-10  |g|= 1.6e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45966632927622  E_coul = 54.26263367773677
  HOMO = -0.785499835818219  LUMO = 2.62399909904962
  mo_energy =
[-3.27129307e+01 -1.89776923e+00 -7.85499836e-01 -7.85499836e-01
 -7.85499836e-01  2.62399910e+00  2.62399910e+00  2.62399910e+00
  2.66766414e+00  1.98250347e+01  1.98250347e+01  1.98250347e+01
  4.38825179e+01  3.19344872e+02  1.98469188e+03  7.27378069e+03]
E1 = -182.4596659433308  E_coul = 54.26263329179128
Extra cycle  E= -128.19703265154  delta_E= -8.53e-14  |g|= 3.05e-07  |ddm|= 9.21e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.30083931844777
E1 = -182.4596659433308  E_coul = 54.26263329179128
init E= -128.19703265154
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785499845730159  LUMO = 2.62399908841453
  mo_energy =
[-3.27129308e+01 -1.89776932e+00 -7.85499846e-01 -7.85499846e-01
 -7.85499846e-01  2.62399909e+00  2.62399909e+00  2.62399909e+00
  2.66766406e+00  1.98250346e+01  1.98250346e+01  1.98250346e+01
  4.38825178e+01  3.19344872e+02  1.98469188e+03  7.27378069e+03]
E1 = -182.45966610952172  E_coul = 54.26263345798185
cycle= 1 E= -128.19703265154  delta_E= -3.41e-13  |g|= 5.7e-08  |ddm|= 1.79e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45966610952172  E_coul = 54.26263345798185
  HOMO = -0.785499831255129  LUMO = 2.62399910123454
  mo_energy =
[-3.27129308e+01 -1.89776932e+00 -7.85499831e-01 -7.85499831e-01
 -7.85499831e-01  2.62399910e+00  2.62399910e+00  2.62399910e+00
  2.66766406e+00  1.98250347e+01  1.98250347e+01  1.98250347e+01
  4.38825178e+01  3.19344872e+02  1.98469188e+03  7.27378069e+03]
E1 = -182.45966604639798  E_coul = 54.262633394858184
Extra cycle  E= -128.19703265154  delta_E= 5.68e-14  |g|= 1.37e-08  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419155e+03 2.15458792e+02 1.42946098e+03 5.67323990e-01
 4.84577038e+01 1.30341319e+01 1.90210257e+00 2.77761334e+00
 1.33319127e+01 6.00543505e-01]
grad_E = [-7.43085278e-06 -3.45938620e-04  4.62640663e-05 -5.40856046e-04
  8.72084494e-04 -1.20401098e-03  3.08519383e-04  7.77121462e-05
 -3.47393724e-06 -3.72761909e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:44:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19156482        1
[INPUT] 0    0    [1    /1   ]  215.459508231        1
[INPUT] 0    0    [1    /1   ]  1429.46088622        1
[INPUT] 0    0    [1    /1   ]  0.567157566432       1
[INPUT] 0    0    [1    /1   ]  48.455873739         1
[INPUT] 0    0    [1    /1   ]  13.036747093         1
[INPUT] 0    0    [1    /1   ]  1.90169966988        1
[INPUT] 1    0    [1    /1   ]  2.77757208676        1
[INPUT] 1    0    [1    /1   ]  13.3319143618        1
[INPUT] 1    0    [1    /1   ]  0.600758314359       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1915648247905, 1.0]], [0, [215.45950823084118, 1.0]], [0, [1429.4608862237926, 1.0]], [0, [0.567157566432159, 1.0]], [0, [48.45587373900562, 1.0]], [0, [13.036747093044935, 1.0]], [0, [1.9016996698807942, 1.0]], [1, [2.777572086763424, 1.0]], [1, [13.331914361848595, 1.0]], [1, [0.6007583143588368, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19156482]
bas 1, expnt(s) = [215.45950823]
bas 2, expnt(s) = [1429.46088622]
bas 3, expnt(s) = [0.56715757]
bas 4, expnt(s) = [48.45587374]
bas 5, expnt(s) = [13.03674709]
bas 6, expnt(s) = [1.90169967]
bas 7, expnt(s) = [2.77757209]
bas 8, expnt(s) = [13.33191436]
bas 9, expnt(s) = [0.60075831]
CPU time:         8.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419156e+03 7.96090995e+02 2.15459508e+02 1.42082069e+02
 1.42946089e+03 5.87346292e+02 5.67157566e-01 1.65117393e+00
 4.84558737e+01 4.64007335e+01 1.30367471e+01 1.73337271e+01
 1.90169967e+00 4.09139559e+00 2.77757209e+00 1.04608281e+01
 1.33319144e+01 7.43190307e+01 6.00758314e-01 1.54297585e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965755220745969
cond(S) = 156.30018925657092
E1 = -183.1359077161427  E_coul = 55.01146256747405
init E= -128.124445148669
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742875602680753  LUMO = 2.65859251473072
  mo_energy =
[-3.25128068e+01 -1.85387611e+00 -7.42875603e-01 -7.42875603e-01
 -7.42875603e-01  2.65859251e+00  2.65859251e+00  2.65859251e+00
  2.69971927e+00  1.99611777e+01  1.99611777e+01  1.99611777e+01
  4.40545693e+01  3.19577326e+02  1.98496900e+03  7.27408172e+03]
E1 = -182.12954010537348  E_coul = 53.93444455218466
cycle= 1 E= -128.195095553189  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262234
diis-c [-0.06876646  1.        ]
  HOMO = -0.80794277123309  LUMO = 2.60434993202557
  mo_energy =
[-3.27868770e+01 -1.92097576e+00 -8.07942771e-01 -8.07942771e-01
 -8.07942771e-01  2.60434993e+00  2.60434993e+00  2.60434993e+00
  2.64719395e+00  1.97700679e+01  1.97700679e+01  1.97700679e+01
  4.38204592e+01  3.19267149e+02  1.98460815e+03  7.27369541e+03]
E1 = -182.59258228814247  E_coul = 54.3958508959432
cycle= 2 E= -128.196731392199  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101996
diis-c [-4.49479974e-04  2.76256286e-01  7.23743714e-01]
  HOMO = -0.785094531237533  LUMO = 2.6250441873886
  mo_energy =
[-3.27118763e+01 -1.89727394e+00 -7.85094531e-01 -7.85094531e-01
 -7.85094531e-01  2.62504419e+00  2.62504419e+00  2.62504419e+00
  2.66707971e+00  1.98264061e+01  1.98264061e+01  1.98264061e+01
  4.38864107e+01  3.19348934e+02  1.98469555e+03  7.27378432e+03]
E1 = -182.45990204501211  E_coul = 54.26286489949615
cycle= 3 E= -128.197037145516  delta_E= -0.000306  |g|= 0.00079  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107949
diis-c [-5.72883601e-08 -3.46010026e-03  1.49827506e-03  1.00196183e+00]
  HOMO = -0.785373262376442  LUMO = 2.62482635623997
  mo_energy =
[-3.27126852e+01 -1.89761245e+00 -7.85373262e-01 -7.85373262e-01
 -7.85373262e-01  2.62482636e+00  2.62482636e+00  2.62482636e+00
  2.66681601e+00  1.98257776e+01  1.98257776e+01  1.98257776e+01
  4.38856634e+01  3.19348257e+02  1.98469499e+03  7.27378378e+03]
E1 = -182.46143656527028  E_coul = 54.264399376135216
cycle= 4 E= -128.197037189135  delta_E= -4.36e-08  |g|= 4.27e-05  |ddm|= 0.000274
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.83217e-05
diis-c [-1.95109080e-10  4.35010457e-04 -1.17451070e-03 -1.58901391e-01
  1.15964089e+00]
  HOMO = -0.785360911299311  LUMO = 2.62483710087361
  mo_energy =
[-3.27126534e+01 -1.89760990e+00 -7.85360911e-01 -7.85360911e-01
 -7.85360911e-01  2.62483710e+00  2.62483710e+00  2.62483710e+00
  2.66681752e+00  1.98258023e+01  1.98258023e+01  1.98258023e+01
  4.38856891e+01  3.19348301e+02  1.98469505e+03  7.27378385e+03]
E1 = -182.46138339222085  E_coul = 54.2643462028795
cycle= 5 E= -128.197037189341  delta_E= -2.06e-10  |g|= 1.62e-06  |ddm|= 2.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46138339222085  E_coul = 54.2643462028795
  HOMO = -0.785360757918237  LUMO = 2.62483724429876
  mo_energy =
[-3.27126531e+01 -1.89761015e+00 -7.85360758e-01 -7.85360758e-01
 -7.85360758e-01  2.62483724e+00  2.62483724e+00  2.62483724e+00
  2.66681730e+00  1.98258025e+01  1.98258025e+01  1.98258025e+01
  4.38856893e+01  3.19348301e+02  1.98469505e+03  7.27378385e+03]
E1 = -182.4613829686823  E_coul = 54.26434577934079
Extra cycle  E= -128.197037189342  delta_E= -1.42e-13  |g|= 3.11e-07  |ddm|= 9.34e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419156e+03 2.15459508e+02 1.42946089e+03 5.67157566e-01
 4.84558737e+01 1.30367471e+01 1.90169967e+00 2.77757209e+00
 1.33319144e+01 6.00758314e-01]
E = -128.1970371893415
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:44:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19156482        1
[INPUT] 0    0    [1    /1   ]  215.459508231        1
[INPUT] 0    0    [1    /1   ]  1429.46088622        1
[INPUT] 0    0    [1    /1   ]  0.567157566432       1
[INPUT] 0    0    [1    /1   ]  48.455873739         1
[INPUT] 0    0    [1    /1   ]  13.036747093         1
[INPUT] 0    0    [1    /1   ]  1.90169966988        1
[INPUT] 1    0    [1    /1   ]  2.77757208676        1
[INPUT] 1    0    [1    /1   ]  13.3319143618        1
[INPUT] 1    0    [1    /1   ]  0.600758314359       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1915648247905, 1.0]], [0, [215.45950823084118, 1.0]], [0, [1429.4608862237926, 1.0]], [0, [0.567157566432159, 1.0]], [0, [48.45587373900562, 1.0]], [0, [13.036747093044935, 1.0]], [0, [1.9016996698807942, 1.0]], [1, [2.777572086763424, 1.0]], [1, [13.331914361848595, 1.0]], [1, [0.6007583143588368, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19156482]
bas 1, expnt(s) = [215.45950823]
bas 2, expnt(s) = [1429.46088622]
bas 3, expnt(s) = [0.56715757]
bas 4, expnt(s) = [48.45587374]
bas 5, expnt(s) = [13.03674709]
bas 6, expnt(s) = [1.90169967]
bas 7, expnt(s) = [2.77757209]
bas 8, expnt(s) = [13.33191436]
bas 9, expnt(s) = [0.60075831]
CPU time:         8.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419156e+03 7.96090995e+02 2.15459508e+02 1.42082069e+02
 1.42946089e+03 5.87346292e+02 5.67157566e-01 1.65117393e+00
 4.84558737e+01 4.64007335e+01 1.30367471e+01 1.73337271e+01
 1.90169967e+00 4.09139559e+00 2.77757209e+00 1.04608281e+01
 1.33319144e+01 7.43190307e+01 6.00758314e-01 1.54297585e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965755220745969
cond(S) = 156.30018925657092
E1 = -183.1359077161427  E_coul = 55.01146256747405
init E= -128.124445148669
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742875602680753  LUMO = 2.65859251473072
  mo_energy =
[-3.25128068e+01 -1.85387611e+00 -7.42875603e-01 -7.42875603e-01
 -7.42875603e-01  2.65859251e+00  2.65859251e+00  2.65859251e+00
  2.69971927e+00  1.99611777e+01  1.99611777e+01  1.99611777e+01
  4.40545693e+01  3.19577326e+02  1.98496900e+03  7.27408172e+03]
E1 = -182.12954010537348  E_coul = 53.93444455218466
cycle= 1 E= -128.195095553189  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262234
diis-c [-0.06876646  1.        ]
  HOMO = -0.80794277123309  LUMO = 2.60434993202557
  mo_energy =
[-3.27868770e+01 -1.92097576e+00 -8.07942771e-01 -8.07942771e-01
 -8.07942771e-01  2.60434993e+00  2.60434993e+00  2.60434993e+00
  2.64719395e+00  1.97700679e+01  1.97700679e+01  1.97700679e+01
  4.38204592e+01  3.19267149e+02  1.98460815e+03  7.27369541e+03]
E1 = -182.59258228814247  E_coul = 54.3958508959432
cycle= 2 E= -128.196731392199  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101996
diis-c [-4.49479974e-04  2.76256286e-01  7.23743714e-01]
  HOMO = -0.785094531237533  LUMO = 2.6250441873886
  mo_energy =
[-3.27118763e+01 -1.89727394e+00 -7.85094531e-01 -7.85094531e-01
 -7.85094531e-01  2.62504419e+00  2.62504419e+00  2.62504419e+00
  2.66707971e+00  1.98264061e+01  1.98264061e+01  1.98264061e+01
  4.38864107e+01  3.19348934e+02  1.98469555e+03  7.27378432e+03]
E1 = -182.45990204501211  E_coul = 54.26286489949615
cycle= 3 E= -128.197037145516  delta_E= -0.000306  |g|= 0.00079  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107949
diis-c [-5.72883601e-08 -3.46010026e-03  1.49827506e-03  1.00196183e+00]
  HOMO = -0.785373262376442  LUMO = 2.62482635623997
  mo_energy =
[-3.27126852e+01 -1.89761245e+00 -7.85373262e-01 -7.85373262e-01
 -7.85373262e-01  2.62482636e+00  2.62482636e+00  2.62482636e+00
  2.66681601e+00  1.98257776e+01  1.98257776e+01  1.98257776e+01
  4.38856634e+01  3.19348257e+02  1.98469499e+03  7.27378378e+03]
E1 = -182.46143656527028  E_coul = 54.264399376135216
cycle= 4 E= -128.197037189135  delta_E= -4.36e-08  |g|= 4.27e-05  |ddm|= 0.000274
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.83217e-05
diis-c [-1.95109080e-10  4.35010457e-04 -1.17451070e-03 -1.58901391e-01
  1.15964089e+00]
  HOMO = -0.785360911299311  LUMO = 2.62483710087361
  mo_energy =
[-3.27126534e+01 -1.89760990e+00 -7.85360911e-01 -7.85360911e-01
 -7.85360911e-01  2.62483710e+00  2.62483710e+00  2.62483710e+00
  2.66681752e+00  1.98258023e+01  1.98258023e+01  1.98258023e+01
  4.38856891e+01  3.19348301e+02  1.98469505e+03  7.27378385e+03]
E1 = -182.46138339222085  E_coul = 54.2643462028795
cycle= 5 E= -128.197037189341  delta_E= -2.06e-10  |g|= 1.62e-06  |ddm|= 2.11e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46138339222085  E_coul = 54.2643462028795
  HOMO = -0.785360757918237  LUMO = 2.62483724429876
  mo_energy =
[-3.27126531e+01 -1.89761015e+00 -7.85360758e-01 -7.85360758e-01
 -7.85360758e-01  2.62483724e+00  2.62483724e+00  2.62483724e+00
  2.66681730e+00  1.98258025e+01  1.98258025e+01  1.98258025e+01
  4.38856893e+01  3.19348301e+02  1.98469505e+03  7.27378385e+03]
E1 = -182.4613829686823  E_coul = 54.26434577934079
Extra cycle  E= -128.197037189342  delta_E= -1.42e-13  |g|= 3.11e-07  |ddm|= 9.34e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.30018925657092
E1 = -182.4613829686823  E_coul = 54.26434577934079
init E= -128.197037189342
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785360770116489  LUMO = 2.62483723157516
  mo_energy =
[-3.27126532e+01 -1.89761024e+00 -7.85360770e-01 -7.85360770e-01
 -7.85360770e-01  2.62483723e+00  2.62483723e+00  2.62483723e+00
  2.66681722e+00  1.98258024e+01  1.98258024e+01  1.98258024e+01
  4.38856892e+01  3.19348301e+02  1.98469505e+03  7.27378385e+03]
E1 = -182.46138315014935  E_coul = 54.26434596080765
cycle= 1 E= -128.197037189342  delta_E= -1.99e-13  |g|= 5.84e-08  |ddm|= 1.83e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46138315014935  E_coul = 54.26434596080765
  HOMO = -0.785360754545643  LUMO = 2.62483724538405
  mo_energy =
[-3.27126531e+01 -1.89761023e+00 -7.85360755e-01 -7.85360755e-01
 -7.85360755e-01  2.62483725e+00  2.62483725e+00  2.62483725e+00
  2.66681722e+00  1.98258025e+01  1.98258025e+01  1.98258025e+01
  4.38856892e+01  3.19348301e+02  1.98469505e+03  7.27378385e+03]
E1 = -182.46138308105145  E_coul = 54.26434589170982
Extra cycle  E= -128.197037189342  delta_E= 5.68e-14  |g|= 1.44e-08  |ddm|= 2.91e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419156e+03 2.15459508e+02 1.42946089e+03 5.67157566e-01
 4.84558737e+01 1.30367471e+01 1.90169967e+00 2.77757209e+00
 1.33319144e+01 6.00758314e-01]
grad_E = [-7.43568276e-06 -3.43091492e-04  4.62370366e-05 -8.54428537e-04
  8.31706431e-04 -1.04158202e-03  3.03559216e-04 -4.94326104e-04
  2.22334936e-05  2.30366400e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:44:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19159366        1
[INPUT] 0    0    [1    /1   ]  215.460853616        1
[INPUT] 0    0    [1    /1   ]  1429.46070665        1
[INPUT] 0    0    [1    /1   ]  0.567077147161       1
[INPUT] 0    0    [1    /1   ]  48.4524480843        1
[INPUT] 0    0    [1    /1   ]  13.0416043117        1
[INPUT] 0    0    [1    /1   ]  1.90091670575        1
[INPUT] 1    0    [1    /1   ]  2.7776352908         1
[INPUT] 1    0    [1    /1   ]  13.3319111072        1
[INPUT] 1    0    [1    /1   ]  0.600503224097       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1915936588744, 1.0]], [0, [215.46085361644995, 1.0]], [0, [1429.4607066483713, 1.0]], [0, [0.5670771471606827, 1.0]], [0, [48.45244808426087, 1.0]], [0, [13.04160431169081, 1.0]], [0, [1.9009167057504865, 1.0]], [1, [2.7776352908046738, 1.0]], [1, [13.331911107199435, 1.0]], [1, [0.6005032240969057, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19159366]
bas 1, expnt(s) = [215.46085362]
bas 2, expnt(s) = [1429.46070665]
bas 3, expnt(s) = [0.56707715]
bas 4, expnt(s) = [48.45244808]
bas 5, expnt(s) = [13.04160431]
bas 6, expnt(s) = [1.90091671]
bas 7, expnt(s) = [2.77763529]
bas 8, expnt(s) = [13.33191111]
bas 9, expnt(s) = [0.60050322]
CPU time:        10.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419159e+03 7.96091003e+02 2.15460854e+02 1.42082734e+02
 1.42946071e+03 5.87346237e+02 5.67077147e-01 1.65099833e+00
 4.84524481e+01 4.63982732e+01 1.30416043e+01 1.73385705e+01
 1.90091671e+00 4.09013215e+00 2.77763529e+00 1.04611257e+01
 1.33319111e+01 7.43190080e+01 6.00503224e-01 1.54215694e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96579934194884
cond(S) = 156.30093565491214
E1 = -183.13574938554808  E_coul = 55.01128485191108
init E= -128.124464533637
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895855656466  LUMO = 2.65774012533049
  mo_energy =
[-3.25128154e+01 -1.85390751e+00 -7.42895856e-01 -7.42895856e-01
 -7.42895856e-01  2.65774013e+00  2.65774013e+00  2.65774013e+00
  2.69860116e+00  1.99606191e+01  1.99606191e+01  1.99606191e+01
  4.40607858e+01  3.19583606e+02  1.98497466e+03  7.27408731e+03]
E1 = -182.12682270572344  E_coul = 53.93172747044078
cycle= 1 E= -128.195095235283  delta_E= -0.0706  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262709
diis-c [-0.06901599  1.        ]
  HOMO = -0.808172018746878  LUMO = 2.60331284711835
  mo_energy =
[-3.27872810e+01 -1.92124828e+00 -8.08172019e-01 -8.08172019e-01
 -8.08172019e-01  2.60331285e+00  2.60331285e+00  2.60331285e+00
  2.64588766e+00  1.97691286e+01  1.97691286e+01  1.97691286e+01
  4.38262736e+01  3.19273143e+02  1.98461355e+03  7.27370076e+03]
E1 = -182.5909404132907  E_coul = 54.39420270703543
cycle= 2 E= -128.196737706255  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102244
diis-c [-4.51052209e-04  2.76385808e-01  7.23614192e-01]
  HOMO = -0.785274310601046  LUMO = 2.62405100150722
  mo_energy =
[-3.27121223e+01 -1.89749480e+00 -7.85274311e-01 -7.85274311e-01
 -7.85274311e-01  2.62405100e+00  2.62405100e+00  2.62405100e+00
  2.66581069e+00  1.98255879e+01  1.98255879e+01  1.98255879e+01
  4.38923675e+01  3.19355097e+02  1.98470114e+03  7.27378985e+03]
E1 = -182.4579236788098  E_coul = 54.26087869145959
cycle= 3 E= -128.19704498735  delta_E= -0.000307  |g|= 0.000789  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107513
diis-c [-5.92349341e-08 -3.47997602e-03  1.37223768e-03  1.00210774e+00]
  HOMO = -0.785552057262315  LUMO = 2.62383418072373
  mo_energy =
[-3.27129283e+01 -1.89783358e+00 -7.85552057e-01 -7.85552057e-01
 -7.85552057e-01  2.62383418e+00  2.62383418e+00  2.62383418e+00
  2.66554690e+00  1.98249615e+01  1.98249615e+01  1.98249615e+01
  4.38916223e+01  3.19354424e+02  1.98470058e+03  7.27378932e+03]
E1 = -182.45945433956913  E_coul = 54.26240930861561
cycle= 4 E= -128.197045030954  delta_E= -4.36e-08  |g|= 4.36e-05  |ddm|= 0.000275
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.9683e-05
diis-c [-1.97496234e-10  4.41852978e-04 -1.17425933e-03 -1.60679773e-01
  1.16141218e+00]
  HOMO = -0.785539473635085  LUMO = 2.62384512464655
  mo_energy =
[-3.27128959e+01 -1.89783105e+00 -7.85539474e-01 -7.85539474e-01
 -7.85539474e-01  2.62384512e+00  2.62384512e+00  2.62384512e+00
  2.66554837e+00  1.98249867e+01  1.98249867e+01  1.98249867e+01
  4.38916485e+01  3.19354469e+02  1.98470064e+03  7.27378938e+03]
E1 = -182.45940021654556  E_coul = 54.26235518537627
cycle= 5 E= -128.197045031169  delta_E= -2.16e-10  |g|= 1.61e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45940021654556  E_coul = 54.26235518537627
  HOMO = -0.785539328448151  LUMO = 2.62384526121428
  mo_energy =
[-3.27128956e+01 -1.89783131e+00 -7.85539328e-01 -7.85539328e-01
 -7.85539328e-01  2.62384526e+00  2.62384526e+00  2.62384526e+00
  2.66554815e+00  1.98249869e+01  1.98249869e+01  1.98249869e+01
  4.38916486e+01  3.19354469e+02  1.98470064e+03  7.27378938e+03]
E1 = -182.45939983279916  E_coul = 54.26235480162937
Extra cycle  E= -128.19704503117  delta_E= -5.12e-13  |g|= 3.08e-07  |ddm|= 9.3e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419159e+03 2.15460854e+02 1.42946071e+03 5.67077147e-01
 4.84524481e+01 1.30416043e+01 1.90091671e+00 2.77763529e+00
 1.33319111e+01 6.00503224e-01]
E = -128.1970450311698
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:44:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19159366        1
[INPUT] 0    0    [1    /1   ]  215.460853616        1
[INPUT] 0    0    [1    /1   ]  1429.46070665        1
[INPUT] 0    0    [1    /1   ]  0.567077147161       1
[INPUT] 0    0    [1    /1   ]  48.4524480843        1
[INPUT] 0    0    [1    /1   ]  13.0416043117        1
[INPUT] 0    0    [1    /1   ]  1.90091670575        1
[INPUT] 1    0    [1    /1   ]  2.7776352908         1
[INPUT] 1    0    [1    /1   ]  13.3319111072        1
[INPUT] 1    0    [1    /1   ]  0.600503224097       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1915936588744, 1.0]], [0, [215.46085361644995, 1.0]], [0, [1429.4607066483713, 1.0]], [0, [0.5670771471606827, 1.0]], [0, [48.45244808426087, 1.0]], [0, [13.04160431169081, 1.0]], [0, [1.9009167057504865, 1.0]], [1, [2.7776352908046738, 1.0]], [1, [13.331911107199435, 1.0]], [1, [0.6005032240969057, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19159366]
bas 1, expnt(s) = [215.46085362]
bas 2, expnt(s) = [1429.46070665]
bas 3, expnt(s) = [0.56707715]
bas 4, expnt(s) = [48.45244808]
bas 5, expnt(s) = [13.04160431]
bas 6, expnt(s) = [1.90091671]
bas 7, expnt(s) = [2.77763529]
bas 8, expnt(s) = [13.33191111]
bas 9, expnt(s) = [0.60050322]
CPU time:        10.90
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419159e+03 7.96091003e+02 2.15460854e+02 1.42082734e+02
 1.42946071e+03 5.87346237e+02 5.67077147e-01 1.65099833e+00
 4.84524481e+01 4.63982732e+01 1.30416043e+01 1.73385705e+01
 1.90091671e+00 4.09013215e+00 2.77763529e+00 1.04611257e+01
 1.33319111e+01 7.43190080e+01 6.00503224e-01 1.54215694e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96579934194884
cond(S) = 156.30093565491214
E1 = -183.13574938554808  E_coul = 55.01128485191108
init E= -128.124464533637
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895855656466  LUMO = 2.65774012533049
  mo_energy =
[-3.25128154e+01 -1.85390751e+00 -7.42895856e-01 -7.42895856e-01
 -7.42895856e-01  2.65774013e+00  2.65774013e+00  2.65774013e+00
  2.69860116e+00  1.99606191e+01  1.99606191e+01  1.99606191e+01
  4.40607858e+01  3.19583606e+02  1.98497466e+03  7.27408731e+03]
E1 = -182.12682270572344  E_coul = 53.93172747044078
cycle= 1 E= -128.195095235283  delta_E= -0.0706  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262709
diis-c [-0.06901599  1.        ]
  HOMO = -0.808172018746878  LUMO = 2.60331284711835
  mo_energy =
[-3.27872810e+01 -1.92124828e+00 -8.08172019e-01 -8.08172019e-01
 -8.08172019e-01  2.60331285e+00  2.60331285e+00  2.60331285e+00
  2.64588766e+00  1.97691286e+01  1.97691286e+01  1.97691286e+01
  4.38262736e+01  3.19273143e+02  1.98461355e+03  7.27370076e+03]
E1 = -182.5909404132907  E_coul = 54.39420270703543
cycle= 2 E= -128.196737706255  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102244
diis-c [-4.51052209e-04  2.76385808e-01  7.23614192e-01]
  HOMO = -0.785274310601046  LUMO = 2.62405100150722
  mo_energy =
[-3.27121223e+01 -1.89749480e+00 -7.85274311e-01 -7.85274311e-01
 -7.85274311e-01  2.62405100e+00  2.62405100e+00  2.62405100e+00
  2.66581069e+00  1.98255879e+01  1.98255879e+01  1.98255879e+01
  4.38923675e+01  3.19355097e+02  1.98470114e+03  7.27378985e+03]
E1 = -182.4579236788098  E_coul = 54.26087869145959
cycle= 3 E= -128.19704498735  delta_E= -0.000307  |g|= 0.000789  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107513
diis-c [-5.92349341e-08 -3.47997602e-03  1.37223768e-03  1.00210774e+00]
  HOMO = -0.785552057262315  LUMO = 2.62383418072373
  mo_energy =
[-3.27129283e+01 -1.89783358e+00 -7.85552057e-01 -7.85552057e-01
 -7.85552057e-01  2.62383418e+00  2.62383418e+00  2.62383418e+00
  2.66554690e+00  1.98249615e+01  1.98249615e+01  1.98249615e+01
  4.38916223e+01  3.19354424e+02  1.98470058e+03  7.27378932e+03]
E1 = -182.45945433956913  E_coul = 54.26240930861561
cycle= 4 E= -128.197045030954  delta_E= -4.36e-08  |g|= 4.36e-05  |ddm|= 0.000275
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.9683e-05
diis-c [-1.97496234e-10  4.41852978e-04 -1.17425933e-03 -1.60679773e-01
  1.16141218e+00]
  HOMO = -0.785539473635085  LUMO = 2.62384512464655
  mo_energy =
[-3.27128959e+01 -1.89783105e+00 -7.85539474e-01 -7.85539474e-01
 -7.85539474e-01  2.62384512e+00  2.62384512e+00  2.62384512e+00
  2.66554837e+00  1.98249867e+01  1.98249867e+01  1.98249867e+01
  4.38916485e+01  3.19354469e+02  1.98470064e+03  7.27378938e+03]
E1 = -182.45940021654556  E_coul = 54.26235518537627
cycle= 5 E= -128.197045031169  delta_E= -2.16e-10  |g|= 1.61e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45940021654556  E_coul = 54.26235518537627
  HOMO = -0.785539328448151  LUMO = 2.62384526121428
  mo_energy =
[-3.27128956e+01 -1.89783131e+00 -7.85539328e-01 -7.85539328e-01
 -7.85539328e-01  2.62384526e+00  2.62384526e+00  2.62384526e+00
  2.66554815e+00  1.98249869e+01  1.98249869e+01  1.98249869e+01
  4.38916486e+01  3.19354469e+02  1.98470064e+03  7.27378938e+03]
E1 = -182.45939983279916  E_coul = 54.26235480162937
Extra cycle  E= -128.19704503117  delta_E= -5.12e-13  |g|= 3.08e-07  |ddm|= 9.3e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.30093565491214
E1 = -182.45939983279916  E_coul = 54.26235480162937
init E= -128.19704503117
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785539338056682  LUMO = 2.62384525084109
  mo_energy =
[-3.27128957e+01 -1.89783139e+00 -7.85539338e-01 -7.85539338e-01
 -7.85539338e-01  2.62384525e+00  2.62384525e+00  2.62384525e+00
  2.66554807e+00  1.98249868e+01  1.98249868e+01  1.98249868e+01
  4.38916485e+01  3.19354469e+02  1.98470064e+03  7.27378938e+03]
E1 = -182.4593999983312  E_coul = 54.26235496716155
cycle= 1 E= -128.19704503117  delta_E= 1.42e-13  |g|= 5.74e-08  |ddm|= 1.8e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4593999983312  E_coul = 54.26235496716155
  HOMO = -0.785539323596523  LUMO = 2.62384526364517
  mo_energy =
[-3.27128957e+01 -1.89783139e+00 -7.85539324e-01 -7.85539324e-01
 -7.85539324e-01  2.62384526e+00  2.62384526e+00  2.62384526e+00
  2.66554807e+00  1.98249868e+01  1.98249868e+01  1.98249868e+01
  4.38916486e+01  3.19354469e+02  1.98470064e+03  7.27378938e+03]
E1 = -182.45939993550988  E_coul = 54.26235490434026
Extra cycle  E= -128.19704503117  delta_E= 5.68e-14  |g|= 1.37e-08  |ddm|= 2.9e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
exp = [2.14419159e+03 2.15460854e+02 1.42946071e+03 5.67077147e-01
 4.84524481e+01 1.30416043e+01 1.90091671e+00 2.77763529e+00
 1.33319111e+01 6.00503224e-01]
grad_E = [-7.44463376e-06 -3.37841476e-04  4.61873999e-05 -8.81334116e-04
  7.57646392e-04 -7.48848473e-04  1.76465074e-04  2.05869198e-04
 -9.84518968e-06 -9.12409769e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:44:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19166388        1
[INPUT] 0    0    [1    /1   ]  215.464113373        1
[INPUT] 0    0    [1    /1   ]  1429.46026961        1
[INPUT] 0    0    [1    /1   ]  0.5670998202         1
[INPUT] 0    0    [1    /1   ]  48.4443288163        1
[INPUT] 0    0    [1    /1   ]  13.0525564048        1
[INPUT] 0    0    [1    /1   ]  1.89936344265        1
[INPUT] 1    0    [1    /1   ]  2.7776152423         1
[INPUT] 1    0    [1    /1   ]  13.3319121512        1
[INPUT] 1    0    [1    /1   ]  0.600576979138       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191663883026, 1.0]], [0, [215.4641133729759, 1.0]], [0, [1429.4602696140093, 1.0]], [0, [0.5670998202003471, 1.0]], [0, [48.44432881626777, 1.0]], [0, [13.052556404756867, 1.0]], [0, [1.8993634426506183, 1.0]], [1, [2.7776152423008473, 1.0]], [1, [13.33191215118074, 1.0]], [1, [0.6005769791382127, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19166388]
bas 1, expnt(s) = [215.46411337]
bas 2, expnt(s) = [1429.46026961]
bas 3, expnt(s) = [0.56709982]
bas 4, expnt(s) = [48.44432882]
bas 5, expnt(s) = [13.0525564]
bas 6, expnt(s) = [1.89936344]
bas 7, expnt(s) = [2.77761524]
bas 8, expnt(s) = [13.33191215]
bas 9, expnt(s) = [0.60057698]
CPU time:        12.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419166e+03 7.96091023e+02 2.15464113e+02 1.42084347e+02
 1.42946027e+03 5.87346102e+02 5.67099820e-01 1.65104784e+00
 4.84443288e+01 4.63924418e+01 1.30525564e+01 1.73494898e+01
 1.89936344e+00 4.08762532e+00 2.77761524e+00 1.04610313e+01
 1.33319122e+01 7.43190153e+01 6.00576979e-01 1.54239370e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965784192154995
cond(S) = 156.30505704232587
E1 = -183.13576755820515  E_coul = 55.01131386598568
init E= -128.124453692219
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742887378957883  LUMO = 2.65799542225513
  mo_energy =
[-3.25128113e+01 -1.85392121e+00 -7.42887379e-01 -7.42887379e-01
 -7.42887379e-01  2.65799542e+00  2.65799542e+00  2.65799542e+00
  2.69716184e+00  1.99607771e+01  1.99607771e+01  1.99607771e+01
  4.40763520e+01  3.19598288e+02  1.98498795e+03  7.27410048e+03]
E1 = -182.12837751263746  E_coul = 53.93326616548061
cycle= 1 E= -128.195111347157  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262311
diis-c [-0.06880713  1.        ]
  HOMO = -0.808061307810142  LUMO = 2.60366430129426
  mo_energy =
[-3.27869249e+01 -1.92117169e+00 -8.08061308e-01 -8.08061308e-01
 -8.08061308e-01  2.60366430e+00  2.60366430e+00  2.60366430e+00
  2.64455638e+00  1.97695702e+01  1.97695702e+01  1.97695702e+01
  4.38421293e+01  3.19288391e+02  1.98462745e+03  7.27371457e+03]
E1 = -182.59188283180302  E_coul = 54.39513301732789
cycle= 2 E= -128.196749814475  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102106
diis-c [-4.52585301e-04  2.76394750e-01  7.23605250e-01]
  HOMO = -0.785193669111733  LUMO = 2.62437573805631
  mo_energy =
[-3.27118658e+01 -1.89745140e+00 -7.85193669e-01 -7.85193669e-01
 -7.85193669e-01  2.62437574e+00  2.62437574e+00  2.62437574e+00
  2.66444256e+00  1.98259542e+01  1.98259542e+01  1.98259542e+01
  4.39081407e+01  3.19370243e+02  1.98471493e+03  7.27380355e+03]
E1 = -182.45906272721413  E_coul = 54.26200649478802
cycle= 3 E= -128.197056232426  delta_E= -0.000306  |g|= 0.000788  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106777
diis-c [-6.14123820e-08 -3.52059765e-03  1.19568252e-03  1.00232492e+00]
  HOMO = -0.785469642683733  LUMO = 2.62416043036719
  mo_energy =
[-3.27126673e+01 -1.89778953e+00 -7.85469643e-01 -7.85469643e-01
 -7.85469643e-01  2.62416043e+00  2.62416043e+00  2.62416043e+00
  2.66417938e+00  1.98253315e+01  1.98253315e+01  1.98253315e+01
  4.39073993e+01  3.19369578e+02  1.98471438e+03  7.27380303e+03]
E1 = -182.4605860456799  E_coul = 54.263529769871084
cycle= 4 E= -128.197056275809  delta_E= -4.34e-08  |g|= 4.45e-05  |ddm|= 0.000276
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.11678e-05
diis-c [-2.04915690e-10  4.47191230e-04 -1.16765181e-03 -1.61039155e-01
  1.16175962e+00]
  HOMO = -0.785456769671099  LUMO = 2.62417162615861
  mo_energy =
[-3.27126341e+01 -1.89778692e+00 -7.85456770e-01 -7.85456770e-01
 -7.85456770e-01  2.62417163e+00  2.62417163e+00  2.62417163e+00
  2.66418090e+00  1.98253572e+01  1.98253572e+01  1.98253572e+01
  4.39074261e+01  3.19369623e+02  1.98471444e+03  7.27380310e+03]
E1 = -182.46053070645365  E_coul = 54.26347443041971
cycle= 5 E= -128.197056276034  delta_E= -2.25e-10  |g|= 1.64e-06  |ddm|= 2.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46053070645365  E_coul = 54.26347443041971
  HOMO = -0.785456630495499  LUMO = 2.62417175764935
  mo_energy =
[-3.27126338e+01 -1.89778719e+00 -7.85456630e-01 -7.85456630e-01
 -7.85456630e-01  2.62417176e+00  2.62417176e+00  2.62417176e+00
  2.66418067e+00  1.98253574e+01  1.98253574e+01  1.98253574e+01
  4.39074262e+01  3.19369623e+02  1.98471444e+03  7.27380310e+03]
E1 = -182.4605303576268  E_coul = 54.263474081592314
Extra cycle  E= -128.197056276034  delta_E= -5.4e-13  |g|= 3.11e-07  |ddm|= 9.45e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419166e+03 2.15464113e+02 1.42946027e+03 5.67099820e-01
 4.84443288e+01 1.30525564e+01 1.89936344e+00 2.77761524e+00
 1.33319122e+01 6.00576979e-01]
E = -128.1970562760345
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:44:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19166388        1
[INPUT] 0    0    [1    /1   ]  215.464113373        1
[INPUT] 0    0    [1    /1   ]  1429.46026961        1
[INPUT] 0    0    [1    /1   ]  0.5670998202         1
[INPUT] 0    0    [1    /1   ]  48.4443288163        1
[INPUT] 0    0    [1    /1   ]  13.0525564048        1
[INPUT] 0    0    [1    /1   ]  1.89936344265        1
[INPUT] 1    0    [1    /1   ]  2.7776152423         1
[INPUT] 1    0    [1    /1   ]  13.3319121512        1
[INPUT] 1    0    [1    /1   ]  0.600576979138       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191663883026, 1.0]], [0, [215.4641133729759, 1.0]], [0, [1429.4602696140093, 1.0]], [0, [0.5670998202003471, 1.0]], [0, [48.44432881626777, 1.0]], [0, [13.052556404756867, 1.0]], [0, [1.8993634426506183, 1.0]], [1, [2.7776152423008473, 1.0]], [1, [13.33191215118074, 1.0]], [1, [0.6005769791382127, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19166388]
bas 1, expnt(s) = [215.46411337]
bas 2, expnt(s) = [1429.46026961]
bas 3, expnt(s) = [0.56709982]
bas 4, expnt(s) = [48.44432882]
bas 5, expnt(s) = [13.0525564]
bas 6, expnt(s) = [1.89936344]
bas 7, expnt(s) = [2.77761524]
bas 8, expnt(s) = [13.33191215]
bas 9, expnt(s) = [0.60057698]
CPU time:        13.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419166e+03 7.96091023e+02 2.15464113e+02 1.42084347e+02
 1.42946027e+03 5.87346102e+02 5.67099820e-01 1.65104784e+00
 4.84443288e+01 4.63924418e+01 1.30525564e+01 1.73494898e+01
 1.89936344e+00 4.08762532e+00 2.77761524e+00 1.04610313e+01
 1.33319122e+01 7.43190153e+01 6.00576979e-01 1.54239370e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965784192154995
cond(S) = 156.30505704232587
E1 = -183.13576755820515  E_coul = 55.01131386598568
init E= -128.124453692219
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742887378957883  LUMO = 2.65799542225513
  mo_energy =
[-3.25128113e+01 -1.85392121e+00 -7.42887379e-01 -7.42887379e-01
 -7.42887379e-01  2.65799542e+00  2.65799542e+00  2.65799542e+00
  2.69716184e+00  1.99607771e+01  1.99607771e+01  1.99607771e+01
  4.40763520e+01  3.19598288e+02  1.98498795e+03  7.27410048e+03]
E1 = -182.12837751263746  E_coul = 53.93326616548061
cycle= 1 E= -128.195111347157  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262311
diis-c [-0.06880713  1.        ]
  HOMO = -0.808061307810142  LUMO = 2.60366430129426
  mo_energy =
[-3.27869249e+01 -1.92117169e+00 -8.08061308e-01 -8.08061308e-01
 -8.08061308e-01  2.60366430e+00  2.60366430e+00  2.60366430e+00
  2.64455638e+00  1.97695702e+01  1.97695702e+01  1.97695702e+01
  4.38421293e+01  3.19288391e+02  1.98462745e+03  7.27371457e+03]
E1 = -182.59188283180302  E_coul = 54.39513301732789
cycle= 2 E= -128.196749814475  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102106
diis-c [-4.52585301e-04  2.76394750e-01  7.23605250e-01]
  HOMO = -0.785193669111733  LUMO = 2.62437573805631
  mo_energy =
[-3.27118658e+01 -1.89745140e+00 -7.85193669e-01 -7.85193669e-01
 -7.85193669e-01  2.62437574e+00  2.62437574e+00  2.62437574e+00
  2.66444256e+00  1.98259542e+01  1.98259542e+01  1.98259542e+01
  4.39081407e+01  3.19370243e+02  1.98471493e+03  7.27380355e+03]
E1 = -182.45906272721413  E_coul = 54.26200649478802
cycle= 3 E= -128.197056232426  delta_E= -0.000306  |g|= 0.000788  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106777
diis-c [-6.14123820e-08 -3.52059765e-03  1.19568252e-03  1.00232492e+00]
  HOMO = -0.785469642683733  LUMO = 2.62416043036719
  mo_energy =
[-3.27126673e+01 -1.89778953e+00 -7.85469643e-01 -7.85469643e-01
 -7.85469643e-01  2.62416043e+00  2.62416043e+00  2.62416043e+00
  2.66417938e+00  1.98253315e+01  1.98253315e+01  1.98253315e+01
  4.39073993e+01  3.19369578e+02  1.98471438e+03  7.27380303e+03]
E1 = -182.4605860456799  E_coul = 54.263529769871084
cycle= 4 E= -128.197056275809  delta_E= -4.34e-08  |g|= 4.45e-05  |ddm|= 0.000276
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.11678e-05
diis-c [-2.04915690e-10  4.47191230e-04 -1.16765181e-03 -1.61039155e-01
  1.16175962e+00]
  HOMO = -0.785456769671099  LUMO = 2.62417162615861
  mo_energy =
[-3.27126341e+01 -1.89778692e+00 -7.85456770e-01 -7.85456770e-01
 -7.85456770e-01  2.62417163e+00  2.62417163e+00  2.62417163e+00
  2.66418090e+00  1.98253572e+01  1.98253572e+01  1.98253572e+01
  4.39074261e+01  3.19369623e+02  1.98471444e+03  7.27380310e+03]
E1 = -182.46053070645365  E_coul = 54.26347443041971
cycle= 5 E= -128.197056276034  delta_E= -2.25e-10  |g|= 1.64e-06  |ddm|= 2.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46053070645365  E_coul = 54.26347443041971
  HOMO = -0.785456630495499  LUMO = 2.62417175764935
  mo_energy =
[-3.27126338e+01 -1.89778719e+00 -7.85456630e-01 -7.85456630e-01
 -7.85456630e-01  2.62417176e+00  2.62417176e+00  2.62417176e+00
  2.66418067e+00  1.98253574e+01  1.98253574e+01  1.98253574e+01
  4.39074262e+01  3.19369623e+02  1.98471444e+03  7.27380310e+03]
E1 = -182.4605303576268  E_coul = 54.263474081592314
Extra cycle  E= -128.197056276034  delta_E= -5.4e-13  |g|= 3.11e-07  |ddm|= 9.45e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.30505704232587
E1 = -182.4605303576268  E_coul = 54.263474081592314
init E= -128.197056276034
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785456637495989  LUMO = 2.62417174961462
  mo_energy =
[-3.27126339e+01 -1.89778728e+00 -7.85456637e-01 -7.85456637e-01
 -7.85456637e-01  2.62417175e+00  2.62417175e+00  2.62417175e+00
  2.66418059e+00  1.98253574e+01  1.98253574e+01  1.98253574e+01
  4.39074261e+01  3.19369623e+02  1.98471444e+03  7.27380310e+03]
E1 = -182.46053050945156  E_coul = 54.263474233417135
cycle= 1 E= -128.197056276034  delta_E= 5.68e-14  |g|= 5.76e-08  |ddm|= 1.82e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46053050945156  E_coul = 54.263474233417135
  HOMO = -0.785456623928325  LUMO = 2.62417176160698
  mo_energy =
[-3.27126339e+01 -1.89778728e+00 -7.85456624e-01 -7.85456624e-01
 -7.85456624e-01  2.62417176e+00  2.62417176e+00  2.62417176e+00
  2.66418059e+00  1.98253574e+01  1.98253574e+01  1.98253574e+01
  4.39074261e+01  3.19369623e+02  1.98471444e+03  7.27380310e+03]
E1 = -182.46053045214262  E_coul = 54.26347417610815
Extra cycle  E= -128.197056276034  delta_E= -2.84e-14  |g|= 1.33e-08  |ddm|= 2.95e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419166e+03 2.15464113e+02 1.42946027e+03 5.67099820e-01
 4.84443288e+01 1.30525564e+01 1.89936344e+00 2.77761524e+00
 1.33319122e+01 6.00576979e-01]
grad_E = [-7.46501192e-06 -3.25879224e-04  4.60737972e-05 -5.55095848e-04
  5.90441050e-04 -9.65183807e-05 -1.89030792e-04  1.27699801e-05
 -8.95554904e-07  2.42637133e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:44:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19172465        1
[INPUT] 0    0    [1    /1   ]  215.466904924        1
[INPUT] 0    0    [1    /1   ]  1429.45989196        1
[INPUT] 0    0    [1    /1   ]  0.567270717259       1
[INPUT] 0    0    [1    /1   ]  48.437689703         1
[INPUT] 0    0    [1    /1   ]  13.0605259107        1
[INPUT] 0    0    [1    /1   ]  1.89866006472        1
[INPUT] 1    0    [1    /1   ]  2.77759042493        1
[INPUT] 1    0    [1    /1   ]  13.3319135068        1
[INPUT] 1    0    [1    /1   ]  0.600567899148       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191724653448, 1.0]], [0, [215.46690492434746, 1.0]], [0, [1429.4598919608866, 1.0]], [0, [0.5672707172592608, 1.0]], [0, [48.43768970297432, 1.0]], [0, [13.060525910727058, 1.0]], [0, [1.898660064716331, 1.0]], [1, [2.7775904249333787, 1.0]], [1, [13.331913506809464, 1.0]], [1, [0.6005678991480302, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19172465]
bas 1, expnt(s) = [215.46690492]
bas 2, expnt(s) = [1429.45989196]
bas 3, expnt(s) = [0.56727072]
bas 4, expnt(s) = [48.4376897]
bas 5, expnt(s) = [13.06052591]
bas 6, expnt(s) = [1.89866006]
bas 7, expnt(s) = [2.77759042]
bas 8, expnt(s) = [13.33191351]
bas 9, expnt(s) = [0.6005679]
CPU time:        14.95
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419172e+03 7.96091040e+02 2.15466905e+02 1.42085727e+02
 1.42945989e+03 5.87345986e+02 5.67270717e-01 1.65142098e+00
 4.84376897e+01 4.63876733e+01 1.30605259e+01 1.73574340e+01
 1.89866006e+00 4.08648996e+00 2.77759042e+00 1.04609145e+01
 1.33319135e+01 7.43190247e+01 6.00567899e-01 1.54236456e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965781843636444
cond(S) = 156.31065156163214
E1 = -183.13572497625822  E_coul = 55.01128394552479
init E= -128.124441030733
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742886403779033  LUMO = 2.65795724050433
  mo_energy =
[-3.25128172e+01 -1.85393136e+00 -7.42886404e-01 -7.42886404e-01
 -7.42886404e-01  2.65795724e+00  2.65795724e+00  2.65795724e+00
  2.69718002e+00  1.99606717e+01  1.99606717e+01  1.99606717e+01
  4.40897474e+01  3.19609193e+02  1.98499790e+03  7.27411044e+03]
E1 = -182.1289498818439  E_coul = 53.93383350013878
cycle= 1 E= -128.195116381705  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262118
diis-c [-0.0687059  1.       ]
  HOMO = -0.808023936655376  LUMO = 2.60366258631762
  mo_energy =
[-3.27867601e+01 -1.92116611e+00 -8.08023937e-01 -8.08023937e-01
 -8.08023937e-01  2.60366259e+00  2.60366259e+00  2.60366259e+00
  2.64459172e+00  1.97695916e+01  1.97695916e+01  1.97695916e+01
  4.38556542e+01  3.19299623e+02  1.98463776e+03  7.27372491e+03]
E1 = -182.5922209958115  E_coul = 54.39546771566301
cycle= 2 E= -128.196753280148  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102055
diis-c [-4.53908527e-04  2.76428574e-01  7.23571426e-01]
  HOMO = -0.785168664207557  LUMO = 2.62436281826022
  mo_energy =
[-3.27117421e+01 -1.89745991e+00 -7.85168664e-01 -7.85168664e-01
 -7.85168664e-01  2.62436282e+00  2.62436282e+00  2.62436282e+00
  2.66446462e+00  1.98259448e+01  1.98259448e+01  1.98259448e+01
  4.39216329e+01  3.19381434e+02  1.98472520e+03  7.27381385e+03]
E1 = -182.4594782926667  E_coul = 54.26241891710216
cycle= 3 E= -128.197059375565  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106122
diis-c [-6.38326209e-08 -3.55473239e-03  1.03427709e-03  1.00252046e+00]
  HOMO = -0.785443070210123  LUMO = 2.62414888104456
  mo_energy =
[-3.27125395e+01 -1.89779780e+00 -7.85443070e-01 -7.85443070e-01
 -7.85443070e-01  2.62414888e+00  2.62414888e+00  2.62414888e+00
  2.66420162e+00  1.98253253e+01  1.98253253e+01  1.98253253e+01
  4.39208947e+01  3.19380775e+02  1.98472466e+03  7.27381334e+03]
E1 = -182.46099524385997  E_coul = 54.26393582503691
cycle= 4 E= -128.197059418823  delta_E= -4.33e-08  |g|= 4.55e-05  |ddm|= 0.000278
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.27773e-05
diis-c [-2.11022190e-10  4.53129143e-04 -1.16555618e-03 -1.61978018e-01
  1.16269045e+00]
  HOMO = -0.785429900036198  LUMO = 2.6241603348819
  mo_energy =
[-3.27125056e+01 -1.89779515e+00 -7.85429900e-01 -7.85429900e-01
 -7.85429900e-01  2.62416033e+00  2.62416033e+00  2.62416033e+00
  2.66420316e+00  1.98253516e+01  1.98253516e+01  1.98253516e+01
  4.39209221e+01  3.19380821e+02  1.98472472e+03  7.27381341e+03]
E1 = -182.4609386581223  E_coul = 54.26387923906359
cycle= 5 E= -128.197059419059  delta_E= -2.36e-10  |g|= 1.65e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4609386581223  E_coul = 54.26387923906359
  HOMO = -0.785429768684222  LUMO = 2.62416045968459
  mo_energy =
[-3.27125054e+01 -1.89779543e+00 -7.85429769e-01 -7.85429769e-01
 -7.85429769e-01  2.62416046e+00  2.62416046e+00  2.62416046e+00
  2.66420292e+00  1.98253517e+01  1.98253517e+01  1.98253517e+01
  4.39209222e+01  3.19380822e+02  1.98472472e+03  7.27381341e+03]
E1 = -182.46093835083406  E_coul = 54.26387893177488
Extra cycle  E= -128.197059419059  delta_E= -4.55e-13  |g|= 3.11e-07  |ddm|= 9.52e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419172e+03 2.15466905e+02 1.42945989e+03 5.67270717e-01
 4.84376897e+01 1.30605259e+01 1.89866006e+00 2.77759042e+00
 1.33319135e+01 6.00567899e-01]
E = -128.19705941905917
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:44:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19172465        1
[INPUT] 0    0    [1    /1   ]  215.466904924        1
[INPUT] 0    0    [1    /1   ]  1429.45989196        1
[INPUT] 0    0    [1    /1   ]  0.567270717259       1
[INPUT] 0    0    [1    /1   ]  48.437689703         1
[INPUT] 0    0    [1    /1   ]  13.0605259107        1
[INPUT] 0    0    [1    /1   ]  1.89866006472        1
[INPUT] 1    0    [1    /1   ]  2.77759042493        1
[INPUT] 1    0    [1    /1   ]  13.3319135068        1
[INPUT] 1    0    [1    /1   ]  0.600567899148       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191724653448, 1.0]], [0, [215.46690492434746, 1.0]], [0, [1429.4598919608866, 1.0]], [0, [0.5672707172592608, 1.0]], [0, [48.43768970297432, 1.0]], [0, [13.060525910727058, 1.0]], [0, [1.898660064716331, 1.0]], [1, [2.7775904249333787, 1.0]], [1, [13.331913506809464, 1.0]], [1, [0.6005678991480302, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19172465]
bas 1, expnt(s) = [215.46690492]
bas 2, expnt(s) = [1429.45989196]
bas 3, expnt(s) = [0.56727072]
bas 4, expnt(s) = [48.4376897]
bas 5, expnt(s) = [13.06052591]
bas 6, expnt(s) = [1.89866006]
bas 7, expnt(s) = [2.77759042]
bas 8, expnt(s) = [13.33191351]
bas 9, expnt(s) = [0.6005679]
CPU time:        15.13
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419172e+03 7.96091040e+02 2.15466905e+02 1.42085727e+02
 1.42945989e+03 5.87345986e+02 5.67270717e-01 1.65142098e+00
 4.84376897e+01 4.63876733e+01 1.30605259e+01 1.73574340e+01
 1.89866006e+00 4.08648996e+00 2.77759042e+00 1.04609145e+01
 1.33319135e+01 7.43190247e+01 6.00567899e-01 1.54236456e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965781843636444
cond(S) = 156.31065156163214
E1 = -183.13572497625822  E_coul = 55.01128394552479
init E= -128.124441030733
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742886403779033  LUMO = 2.65795724050433
  mo_energy =
[-3.25128172e+01 -1.85393136e+00 -7.42886404e-01 -7.42886404e-01
 -7.42886404e-01  2.65795724e+00  2.65795724e+00  2.65795724e+00
  2.69718002e+00  1.99606717e+01  1.99606717e+01  1.99606717e+01
  4.40897474e+01  3.19609193e+02  1.98499790e+03  7.27411044e+03]
E1 = -182.1289498818439  E_coul = 53.93383350013878
cycle= 1 E= -128.195116381705  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262118
diis-c [-0.0687059  1.       ]
  HOMO = -0.808023936655376  LUMO = 2.60366258631762
  mo_energy =
[-3.27867601e+01 -1.92116611e+00 -8.08023937e-01 -8.08023937e-01
 -8.08023937e-01  2.60366259e+00  2.60366259e+00  2.60366259e+00
  2.64459172e+00  1.97695916e+01  1.97695916e+01  1.97695916e+01
  4.38556542e+01  3.19299623e+02  1.98463776e+03  7.27372491e+03]
E1 = -182.5922209958115  E_coul = 54.39546771566301
cycle= 2 E= -128.196753280148  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102055
diis-c [-4.53908527e-04  2.76428574e-01  7.23571426e-01]
  HOMO = -0.785168664207557  LUMO = 2.62436281826022
  mo_energy =
[-3.27117421e+01 -1.89745991e+00 -7.85168664e-01 -7.85168664e-01
 -7.85168664e-01  2.62436282e+00  2.62436282e+00  2.62436282e+00
  2.66446462e+00  1.98259448e+01  1.98259448e+01  1.98259448e+01
  4.39216329e+01  3.19381434e+02  1.98472520e+03  7.27381385e+03]
E1 = -182.4594782926667  E_coul = 54.26241891710216
cycle= 3 E= -128.197059375565  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106122
diis-c [-6.38326209e-08 -3.55473239e-03  1.03427709e-03  1.00252046e+00]
  HOMO = -0.785443070210123  LUMO = 2.62414888104456
  mo_energy =
[-3.27125395e+01 -1.89779780e+00 -7.85443070e-01 -7.85443070e-01
 -7.85443070e-01  2.62414888e+00  2.62414888e+00  2.62414888e+00
  2.66420162e+00  1.98253253e+01  1.98253253e+01  1.98253253e+01
  4.39208947e+01  3.19380775e+02  1.98472466e+03  7.27381334e+03]
E1 = -182.46099524385997  E_coul = 54.26393582503691
cycle= 4 E= -128.197059418823  delta_E= -4.33e-08  |g|= 4.55e-05  |ddm|= 0.000278
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.27773e-05
diis-c [-2.11022190e-10  4.53129143e-04 -1.16555618e-03 -1.61978018e-01
  1.16269045e+00]
  HOMO = -0.785429900036198  LUMO = 2.6241603348819
  mo_energy =
[-3.27125056e+01 -1.89779515e+00 -7.85429900e-01 -7.85429900e-01
 -7.85429900e-01  2.62416033e+00  2.62416033e+00  2.62416033e+00
  2.66420316e+00  1.98253516e+01  1.98253516e+01  1.98253516e+01
  4.39209221e+01  3.19380821e+02  1.98472472e+03  7.27381341e+03]
E1 = -182.4609386581223  E_coul = 54.26387923906359
cycle= 5 E= -128.197059419059  delta_E= -2.36e-10  |g|= 1.65e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4609386581223  E_coul = 54.26387923906359
  HOMO = -0.785429768684222  LUMO = 2.62416045968459
  mo_energy =
[-3.27125054e+01 -1.89779543e+00 -7.85429769e-01 -7.85429769e-01
 -7.85429769e-01  2.62416046e+00  2.62416046e+00  2.62416046e+00
  2.66420292e+00  1.98253517e+01  1.98253517e+01  1.98253517e+01
  4.39209222e+01  3.19380822e+02  1.98472472e+03  7.27381341e+03]
E1 = -182.46093835083406  E_coul = 54.26387893177488
Extra cycle  E= -128.197059419059  delta_E= -4.55e-13  |g|= 3.11e-07  |ddm|= 9.52e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.31065156163214
E1 = -182.46093835083406  E_coul = 54.26387893177488
init E= -128.197059419059
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785429772767472  LUMO = 2.62416045427928
  mo_energy =
[-3.27125054e+01 -1.89779551e+00 -7.85429773e-01 -7.85429773e-01
 -7.85429773e-01  2.62416045e+00  2.62416045e+00  2.62416045e+00
  2.66420284e+00  1.98253517e+01  1.98253517e+01  1.98253517e+01
  4.39209221e+01  3.19380822e+02  1.98472472e+03  7.27381341e+03]
E1 = -182.46093848611284  E_coul = 54.26387906705368
cycle= 1 E= -128.197059419059  delta_E= 2.84e-14  |g|= 5.73e-08  |ddm|= 1.82e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46093848611284  E_coul = 54.26387906705368
  HOMO = -0.785429760313473  LUMO = 2.62416046526154
  mo_energy =
[-3.27125054e+01 -1.89779551e+00 -7.85429760e-01 -7.85429760e-01
 -7.85429760e-01  2.62416047e+00  2.62416047e+00  2.62416047e+00
  2.66420284e+00  1.98253517e+01  1.98253517e+01  1.98253517e+01
  4.39209221e+01  3.19380822e+02  1.98472472e+03  7.27381341e+03]
E1 = -182.46093843539023  E_coul = 54.26387901633102
Extra cycle  E= -128.197059419059  delta_E= -5.68e-14  |g|= 1.28e-08  |ddm|= 2.98e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419172e+03 2.15466905e+02 1.42945989e+03 5.67270717e-01
 4.84376897e+01 1.30605259e+01 1.89866006e+00 2.77759042e+00
 1.33319135e+01 6.00567899e-01]
grad_E = [-7.48041471e-06 -3.16893432e-04  4.59879153e-05 -1.75681443e-04
  4.66937818e-04  3.76267825e-04 -4.63484383e-04  1.77096003e-05
  6.17877203e-08 -2.37926351e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19174438        1
[INPUT] 0    0    [1    /1   ]  215.467782425        1
[INPUT] 0    0    [1    /1   ]  1429.45976989        1
[INPUT] 0    0    [1    /1   ]  0.567409592295       1
[INPUT] 0    0    [1    /1   ]  48.435911696         1
[INPUT] 0    0    [1    /1   ]  13.0616522173        1
[INPUT] 0    0    [1    /1   ]  1.89904095614        1
[INPUT] 1    0    [1    /1   ]  2.77757274923        1
[INPUT] 1    0    [1    /1   ]  13.3319133182        1
[INPUT] 1    0    [1    /1   ]  0.600567500241       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191744383522, 1.0]], [0, [215.46778242542308, 1.0]], [0, [1429.4597698875389, 1.0]], [0, [0.5674095922951343, 1.0]], [0, [48.43591169604234, 1.0]], [0, [13.061652217346666, 1.0]], [0, [1.899040956138748, 1.0]], [1, [2.7775727492349507, 1.0]], [1, [13.33191331816852, 1.0]], [1, [0.6005675002413969, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19174438]
bas 1, expnt(s) = [215.46778243]
bas 2, expnt(s) = [1429.45976989]
bas 3, expnt(s) = [0.56740959]
bas 4, expnt(s) = [48.4359117]
bas 5, expnt(s) = [13.06165222]
bas 6, expnt(s) = [1.89904096]
bas 7, expnt(s) = [2.77757275]
bas 8, expnt(s) = [13.33191332]
bas 9, expnt(s) = [0.6005675]
CPU time:        17.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419174e+03 7.96091045e+02 2.15467782e+02 1.42086161e+02
 1.42945977e+03 5.87345948e+02 5.67409592e-01 1.65172419e+00
 4.84359117e+01 4.63863962e+01 1.30616522e+01 1.73585567e+01
 1.89904096e+00 4.08710479e+00 2.77757275e+00 1.04608312e+01
 1.33319133e+01 7.43190234e+01 6.00567500e-01 1.54236328e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965779684029965
cond(S) = 156.3138186280469
E1 = -183.13572673089888  E_coul = 55.01128509643674
init E= -128.124441634462
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742885838818645  LUMO = 2.65794778653258
  mo_energy =
[-3.25128217e+01 -1.85392773e+00 -7.42885839e-01 -7.42885839e-01
 -7.42885839e-01  2.65794779e+00  2.65794779e+00  2.65794779e+00
  2.69817535e+00  1.99606161e+01  1.99606161e+01  1.99606161e+01
  4.40937238e+01  3.19610766e+02  1.98499946e+03  7.27411213e+03]
E1 = -182.12910822463735  E_coul = 53.93399054872303
cycle= 1 E= -128.195117675914  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262077
diis-c [-0.06868439  1.        ]
  HOMO = -0.808012039004591  LUMO = 2.60366423086257
  mo_energy =
[-3.27867274e+01 -1.92115629e+00 -8.08012039e-01 -8.08012039e-01
 -8.08012039e-01  2.60366423e+00  2.60366423e+00  2.60366423e+00
  2.64557452e+00  1.97695652e+01  1.97695652e+01  1.97695652e+01
  4.38596604e+01  3.19301255e+02  1.98463938e+03  7.27372666e+03]
E1 = -182.59231680234421  E_coul = 54.395562606595156
cycle= 2 E= -128.196754195749  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102042
diis-c [-4.54095431e-04  2.76432295e-01  7.23567705e-01]
  HOMO = -0.785160086643543  LUMO = 2.62436139822443
  mo_energy =
[-3.27117193e+01 -1.89745357e+00 -7.85160087e-01 -7.85160087e-01
 -7.85160087e-01  2.62436140e+00  2.62436140e+00  2.62436140e+00
  2.66544952e+00  1.98259107e+01  1.98259107e+01  1.98259107e+01
  4.39256305e+01  3.19383055e+02  1.98472681e+03  7.27381559e+03]
E1 = -182.4595945736262  E_coul = 54.26253436568462
cycle= 3 E= -128.197060207942  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106007
diis-c [-6.43217497e-08 -3.56111592e-03  1.00490738e-03  1.00255621e+00]
  HOMO = -0.785434220872527  LUMO = 2.62414769659275
  mo_energy =
[-3.27125161e+01 -1.89779146e+00 -7.85434221e-01 -7.85434221e-01
 -7.85434221e-01  2.62414770e+00  2.62414770e+00  2.62414770e+00
  2.66518644e+00  1.98252917e+01  1.98252917e+01  1.98252917e+01
  4.39248929e+01  3.19382397e+02  1.98472627e+03  7.27381508e+03]
E1 = -182.46111038687727  E_coul = 54.26405013569286
cycle= 4 E= -128.197060251184  delta_E= -4.32e-08  |g|= 4.57e-05  |ddm|= 0.000278
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.30864e-05
diis-c [-2.11986348e-10  4.54203459e-04 -1.16555428e-03 -1.62163903e-01
  1.16287525e+00]
  HOMO = -0.785420996020237  LUMO = 2.62415919787928
  mo_energy =
[-3.27124820e+01 -1.89778881e+00 -7.85420996e-01 -7.85420996e-01
 -7.85420996e-01  2.62415920e+00  2.62415920e+00  2.62415920e+00
  2.66518798e+00  1.98253181e+01  1.98253181e+01  1.98253181e+01
  4.39249203e+01  3.19382444e+02  1.98472633e+03  7.27381515e+03]
E1 = -182.46105356297403  E_coul = 54.26399331155175
cycle= 5 E= -128.197060251422  delta_E= -2.38e-10  |g|= 1.65e-06  |ddm|= 2.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46105356297403  E_coul = 54.26399331155175
  HOMO = -0.785420866306754  LUMO = 2.62415932126753
  mo_energy =
[-3.27124818e+01 -1.89778909e+00 -7.85420866e-01 -7.85420866e-01
 -7.85420866e-01  2.62415932e+00  2.62415932e+00  2.62415932e+00
  2.66518774e+00  1.98253183e+01  1.98253183e+01  1.98253183e+01
  4.39249204e+01  3.19382444e+02  1.98472633e+03  7.27381515e+03]
E1 = -182.46105326375866  E_coul = 54.26399301233604
Extra cycle  E= -128.197060251423  delta_E= -3.41e-13  |g|= 3.11e-07  |ddm|= 9.53e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419174e+03 2.15467782e+02 1.42945977e+03 5.67409592e-01
 4.84359117e+01 1.30616522e+01 1.89904096e+00 2.77757275e+00
 1.33319133e+01 6.00567500e-01]
E = -128.1970602514226
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19174438        1
[INPUT] 0    0    [1    /1   ]  215.467782425        1
[INPUT] 0    0    [1    /1   ]  1429.45976989        1
[INPUT] 0    0    [1    /1   ]  0.567409592295       1
[INPUT] 0    0    [1    /1   ]  48.435911696         1
[INPUT] 0    0    [1    /1   ]  13.0616522173        1
[INPUT] 0    0    [1    /1   ]  1.89904095614        1
[INPUT] 1    0    [1    /1   ]  2.77757274923        1
[INPUT] 1    0    [1    /1   ]  13.3319133182        1
[INPUT] 1    0    [1    /1   ]  0.600567500241       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.191744383522, 1.0]], [0, [215.46778242542308, 1.0]], [0, [1429.4597698875389, 1.0]], [0, [0.5674095922951343, 1.0]], [0, [48.43591169604234, 1.0]], [0, [13.061652217346666, 1.0]], [0, [1.899040956138748, 1.0]], [1, [2.7775727492349507, 1.0]], [1, [13.33191331816852, 1.0]], [1, [0.6005675002413969, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19174438]
bas 1, expnt(s) = [215.46778243]
bas 2, expnt(s) = [1429.45976989]
bas 3, expnt(s) = [0.56740959]
bas 4, expnt(s) = [48.4359117]
bas 5, expnt(s) = [13.06165222]
bas 6, expnt(s) = [1.89904096]
bas 7, expnt(s) = [2.77757275]
bas 8, expnt(s) = [13.33191332]
bas 9, expnt(s) = [0.6005675]
CPU time:        17.23
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419174e+03 7.96091045e+02 2.15467782e+02 1.42086161e+02
 1.42945977e+03 5.87345948e+02 5.67409592e-01 1.65172419e+00
 4.84359117e+01 4.63863962e+01 1.30616522e+01 1.73585567e+01
 1.89904096e+00 4.08710479e+00 2.77757275e+00 1.04608312e+01
 1.33319133e+01 7.43190234e+01 6.00567500e-01 1.54236328e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965779684029965
cond(S) = 156.3138186280469
E1 = -183.13572673089888  E_coul = 55.01128509643674
init E= -128.124441634462
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742885838818645  LUMO = 2.65794778653258
  mo_energy =
[-3.25128217e+01 -1.85392773e+00 -7.42885839e-01 -7.42885839e-01
 -7.42885839e-01  2.65794779e+00  2.65794779e+00  2.65794779e+00
  2.69817535e+00  1.99606161e+01  1.99606161e+01  1.99606161e+01
  4.40937238e+01  3.19610766e+02  1.98499946e+03  7.27411213e+03]
E1 = -182.12910822463735  E_coul = 53.93399054872303
cycle= 1 E= -128.195117675914  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262077
diis-c [-0.06868439  1.        ]
  HOMO = -0.808012039004591  LUMO = 2.60366423086257
  mo_energy =
[-3.27867274e+01 -1.92115629e+00 -8.08012039e-01 -8.08012039e-01
 -8.08012039e-01  2.60366423e+00  2.60366423e+00  2.60366423e+00
  2.64557452e+00  1.97695652e+01  1.97695652e+01  1.97695652e+01
  4.38596604e+01  3.19301255e+02  1.98463938e+03  7.27372666e+03]
E1 = -182.59231680234421  E_coul = 54.395562606595156
cycle= 2 E= -128.196754195749  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102042
diis-c [-4.54095431e-04  2.76432295e-01  7.23567705e-01]
  HOMO = -0.785160086643543  LUMO = 2.62436139822443
  mo_energy =
[-3.27117193e+01 -1.89745357e+00 -7.85160087e-01 -7.85160087e-01
 -7.85160087e-01  2.62436140e+00  2.62436140e+00  2.62436140e+00
  2.66544952e+00  1.98259107e+01  1.98259107e+01  1.98259107e+01
  4.39256305e+01  3.19383055e+02  1.98472681e+03  7.27381559e+03]
E1 = -182.4595945736262  E_coul = 54.26253436568462
cycle= 3 E= -128.197060207942  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106007
diis-c [-6.43217497e-08 -3.56111592e-03  1.00490738e-03  1.00255621e+00]
  HOMO = -0.785434220872527  LUMO = 2.62414769659275
  mo_energy =
[-3.27125161e+01 -1.89779146e+00 -7.85434221e-01 -7.85434221e-01
 -7.85434221e-01  2.62414770e+00  2.62414770e+00  2.62414770e+00
  2.66518644e+00  1.98252917e+01  1.98252917e+01  1.98252917e+01
  4.39248929e+01  3.19382397e+02  1.98472627e+03  7.27381508e+03]
E1 = -182.46111038687727  E_coul = 54.26405013569286
cycle= 4 E= -128.197060251184  delta_E= -4.32e-08  |g|= 4.57e-05  |ddm|= 0.000278
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.30864e-05
diis-c [-2.11986348e-10  4.54203459e-04 -1.16555428e-03 -1.62163903e-01
  1.16287525e+00]
  HOMO = -0.785420996020237  LUMO = 2.62415919787928
  mo_energy =
[-3.27124820e+01 -1.89778881e+00 -7.85420996e-01 -7.85420996e-01
 -7.85420996e-01  2.62415920e+00  2.62415920e+00  2.62415920e+00
  2.66518798e+00  1.98253181e+01  1.98253181e+01  1.98253181e+01
  4.39249203e+01  3.19382444e+02  1.98472633e+03  7.27381515e+03]
E1 = -182.46105356297403  E_coul = 54.26399331155175
cycle= 5 E= -128.197060251422  delta_E= -2.38e-10  |g|= 1.65e-06  |ddm|= 2.29e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46105356297403  E_coul = 54.26399331155175
  HOMO = -0.785420866306754  LUMO = 2.62415932126753
  mo_energy =
[-3.27124818e+01 -1.89778909e+00 -7.85420866e-01 -7.85420866e-01
 -7.85420866e-01  2.62415932e+00  2.62415932e+00  2.62415932e+00
  2.66518774e+00  1.98253183e+01  1.98253183e+01  1.98253183e+01
  4.39249204e+01  3.19382444e+02  1.98472633e+03  7.27381515e+03]
E1 = -182.46105326375866  E_coul = 54.26399301233604
Extra cycle  E= -128.197060251423  delta_E= -3.41e-13  |g|= 3.11e-07  |ddm|= 9.53e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.3138186280469
E1 = -182.46105326375866  E_coul = 54.26399301233604
init E= -128.197060251423
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785420869838447  LUMO = 2.62415931636059
  mo_energy =
[-3.27124818e+01 -1.89778917e+00 -7.85420870e-01 -7.85420870e-01
 -7.85420870e-01  2.62415932e+00  2.62415932e+00  2.62415932e+00
  2.66518767e+00  1.98253182e+01  1.98253182e+01  1.98253182e+01
  4.39249204e+01  3.19382444e+02  1.98472633e+03  7.27381515e+03]
E1 = -182.46105339574834  E_coul = 54.26399314432575
cycle= 1 E= -128.197060251423  delta_E= 2.84e-14  |g|= 5.72e-08  |ddm|= 1.82e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46105339574834  E_coul = 54.26399314432575
  HOMO = -0.78542085760913  LUMO = 2.62415932713928
  mo_energy =
[-3.27124818e+01 -1.89778917e+00 -7.85420858e-01 -7.85420858e-01
 -7.85420858e-01  2.62415933e+00  2.62415933e+00  2.62415933e+00
  2.66518766e+00  1.98253183e+01  1.98253183e+01  1.98253183e+01
  4.39249204e+01  3.19382444e+02  1.98472633e+03  7.27381515e+03]
E1 = -182.46105334632136  E_coul = 54.263993094898815
Extra cycle  E= -128.197060251423  delta_E= 2.84e-14  |g|= 1.27e-08  |ddm|= 2.98e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419174e+03 2.15467782e+02 1.42945977e+03 5.67409592e-01
 4.84359117e+01 1.30616522e+01 1.89904096e+00 2.77757275e+00
 1.33319133e+01 6.00567500e-01]
grad_E = [-7.48331545e-06 -3.15287282e-04  4.59717888e-05 -1.01086455e-04
  4.46848256e-04  4.44579885e-04 -4.80377775e-04  1.76571274e-06
  1.56513255e-06  1.16919792e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19177659        1
[INPUT] 0    0    [1    /1   ]  215.469197964        1
[INPUT] 0    0    [1    /1   ]  1429.45957095        1
[INPUT] 0    0    [1    /1   ]  0.567670257385       1
[INPUT] 0    0    [1    /1   ]  48.4332259853        1
[INPUT] 0    0    [1    /1   ]  13.0626642061        1
[INPUT] 0    0    [1    /1   ]  1.89997579079        1
[INPUT] 1    0    [1    /1   ]  2.77754854303        1
[INPUT] 1    0    [1    /1   ]  13.3319114301        1
[INPUT] 1    0    [1    /1   ]  0.600565615765       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1917765870076, 1.0]], [0, [215.469197963768, 1.0]], [0, [1429.459570953023, 1.0]], [0, [0.56767025738528, 1.0]], [0, [48.43322598525894, 1.0]], [0, [13.062664206137116, 1.0]], [0, [1.899975790787885, 1.0]], [1, [2.777548543025536, 1.0]], [1, [13.331911430119856, 1.0]], [1, [0.6005656157652266, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19177659]
bas 1, expnt(s) = [215.46919796]
bas 2, expnt(s) = [1429.45957095]
bas 3, expnt(s) = [0.56767026]
bas 4, expnt(s) = [48.43322599]
bas 5, expnt(s) = [13.06266421]
bas 6, expnt(s) = [1.89997579]
bas 7, expnt(s) = [2.77754854]
bas 8, expnt(s) = [13.33191143]
bas 9, expnt(s) = [0.60056562]
CPU time:        19.15
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419178e+03 7.96091054e+02 2.15469198e+02 1.42086861e+02
 1.42945957e+03 5.87345887e+02 5.67670257e-01 1.65229325e+00
 4.84332260e+01 4.63844672e+01 1.30626642e+01 1.73595653e+01
 1.89997579e+00 4.08861365e+00 2.77754854e+00 1.04607173e+01
 1.33319114e+01 7.43190103e+01 6.00565616e-01 1.54235723e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965775966126206
cond(S) = 156.31952957331774
E1 = -183.13573733913645  E_coul = 55.011291191333584
init E= -128.124446147803
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742885076557585  LUMO = 2.65792993240225
  mo_energy =
[-3.25128301e+01 -1.85391857e+00 -7.42885077e-01 -7.42885077e-01
 -7.42885077e-01  2.65792993e+00  2.65792993e+00  2.65792993e+00
  2.70027386e+00  1.99605359e+01  1.99605359e+01  1.99605359e+01
  4.40998167e+01  3.19612078e+02  1.98500095e+03  7.27411389e+03]
E1 = -182.12929851948587  E_coul = 53.934178735592255
cycle= 1 E= -128.195119783894  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262033
diis-c [-0.06866149  1.        ]
  HOMO = -0.807997321286902  LUMO = 2.60366009145542
  mo_energy =
[-3.27866939e+01 -1.92114057e+00 -8.07997321e-01 -8.07997321e-01
 -8.07997321e-01  2.60366009e+00  2.60366009e+00  2.60366009e+00
  2.64764022e+00  1.97695178e+01  1.97695178e+01  1.97695178e+01
  4.38657869e+01  3.19302625e+02  1.98464093e+03  7.27372848e+03]
E1 = -182.592433832154  E_coul = 54.39567794149547
cycle= 2 E= -128.196755890659  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102028
diis-c [-4.54274521e-04  2.76435570e-01  7.23564430e-01]
  HOMO = -0.785149385261531  LUMO = 2.62435354555491
  mo_energy =
[-3.27116969e+01 -1.89744186e+00 -7.85149385e-01 -7.85149385e-01
 -7.85149385e-01  2.62435355e+00  2.62435355e+00  2.62435355e+00
  2.66752274e+00  1.98258547e+01  1.98258547e+01  1.98258547e+01
  4.39317468e+01  3.19384415e+02  1.98472834e+03  7.27381740e+03]
E1 = -182.45973560524237  E_coul = 54.2626737961302
cycle= 3 E= -128.197061809112  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00105884
diis-c [-6.49186437e-08 -3.56860315e-03  9.71326196e-04  1.00259728e+00]
  HOMO = -0.785423231018468  LUMO = 2.62414009345419
  mo_energy =
[-3.27124929e+01 -1.89777978e+00 -7.85423231e-01 -7.85423231e-01
 -7.85423231e-01  2.62414009e+00  2.62414009e+00  2.62414009e+00
  2.66725948e+00  1.98252364e+01  1.98252364e+01  1.98252364e+01
  4.39310098e+01  3.19383758e+02  1.98472781e+03  7.27381690e+03]
E1 = -182.46125017572015  E_coul = 54.26418832337533
cycle= 4 E= -128.197061852345  delta_E= -4.32e-08  |g|= 4.6e-05  |ddm|= 0.000278
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.34512e-05
diis-c [-2.12889749e-10  4.55460711e-04 -1.16584250e-03 -1.62397822e-01
  1.16310820e+00]
  HOMO = -0.785409944036116  LUMO = 2.62415164859902
  mo_energy =
[-3.27124587e+01 -1.89777713e+00 -7.85409944e-01 -7.85409944e-01
 -7.85409944e-01  2.62415165e+00  2.62415165e+00  2.62415165e+00
  2.66726102e+00  1.98252629e+01  1.98252629e+01  1.98252629e+01
  4.39310374e+01  3.19383805e+02  1.98472787e+03  7.27381697e+03]
E1 = -182.46119307242034  E_coul = 54.264131219835086
cycle= 5 E= -128.197061852585  delta_E= -2.4e-10  |g|= 1.65e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46119307242034  E_coul = 54.264131219835086
  HOMO = -0.785409816413232  LUMO = 2.62415177017677
  mo_energy =
[-3.27124585e+01 -1.89777741e+00 -7.85409816e-01 -7.85409816e-01
 -7.85409816e-01  2.62415177e+00  2.62415177e+00  2.62415177e+00
  2.66726077e+00  1.98252630e+01  1.98252630e+01  1.98252630e+01
  4.39310375e+01  3.19383806e+02  1.98472787e+03  7.27381697e+03]
E1 = -182.46119278292778  E_coul = 54.264130930342326
Extra cycle  E= -128.197061852585  delta_E= -1.99e-13  |g|= 3.11e-07  |ddm|= 9.54e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419178e+03 2.15469198e+02 1.42945957e+03 5.67670257e-01
 4.84332260e+01 1.30626642e+01 1.89997579e+00 2.77754854e+00
 1.33319114e+01 6.00565616e-01]
E = -128.19706185258545
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19177659        1
[INPUT] 0    0    [1    /1   ]  215.469197964        1
[INPUT] 0    0    [1    /1   ]  1429.45957095        1
[INPUT] 0    0    [1    /1   ]  0.567670257385       1
[INPUT] 0    0    [1    /1   ]  48.4332259853        1
[INPUT] 0    0    [1    /1   ]  13.0626642061        1
[INPUT] 0    0    [1    /1   ]  1.89997579079        1
[INPUT] 1    0    [1    /1   ]  2.77754854303        1
[INPUT] 1    0    [1    /1   ]  13.3319114301        1
[INPUT] 1    0    [1    /1   ]  0.600565615765       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1917765870076, 1.0]], [0, [215.469197963768, 1.0]], [0, [1429.459570953023, 1.0]], [0, [0.56767025738528, 1.0]], [0, [48.43322598525894, 1.0]], [0, [13.062664206137116, 1.0]], [0, [1.899975790787885, 1.0]], [1, [2.777548543025536, 1.0]], [1, [13.331911430119856, 1.0]], [1, [0.6005656157652266, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19177659]
bas 1, expnt(s) = [215.46919796]
bas 2, expnt(s) = [1429.45957095]
bas 3, expnt(s) = [0.56767026]
bas 4, expnt(s) = [48.43322599]
bas 5, expnt(s) = [13.06266421]
bas 6, expnt(s) = [1.89997579]
bas 7, expnt(s) = [2.77754854]
bas 8, expnt(s) = [13.33191143]
bas 9, expnt(s) = [0.60056562]
CPU time:        19.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419178e+03 7.96091054e+02 2.15469198e+02 1.42086861e+02
 1.42945957e+03 5.87345887e+02 5.67670257e-01 1.65229325e+00
 4.84332260e+01 4.63844672e+01 1.30626642e+01 1.73595653e+01
 1.89997579e+00 4.08861365e+00 2.77754854e+00 1.04607173e+01
 1.33319114e+01 7.43190103e+01 6.00565616e-01 1.54235723e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965775966126206
cond(S) = 156.31952957331774
E1 = -183.13573733913645  E_coul = 55.011291191333584
init E= -128.124446147803
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742885076557585  LUMO = 2.65792993240225
  mo_energy =
[-3.25128301e+01 -1.85391857e+00 -7.42885077e-01 -7.42885077e-01
 -7.42885077e-01  2.65792993e+00  2.65792993e+00  2.65792993e+00
  2.70027386e+00  1.99605359e+01  1.99605359e+01  1.99605359e+01
  4.40998167e+01  3.19612078e+02  1.98500095e+03  7.27411389e+03]
E1 = -182.12929851948587  E_coul = 53.934178735592255
cycle= 1 E= -128.195119783894  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262033
diis-c [-0.06866149  1.        ]
  HOMO = -0.807997321286902  LUMO = 2.60366009145542
  mo_energy =
[-3.27866939e+01 -1.92114057e+00 -8.07997321e-01 -8.07997321e-01
 -8.07997321e-01  2.60366009e+00  2.60366009e+00  2.60366009e+00
  2.64764022e+00  1.97695178e+01  1.97695178e+01  1.97695178e+01
  4.38657869e+01  3.19302625e+02  1.98464093e+03  7.27372848e+03]
E1 = -182.592433832154  E_coul = 54.39567794149547
cycle= 2 E= -128.196755890659  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102028
diis-c [-4.54274521e-04  2.76435570e-01  7.23564430e-01]
  HOMO = -0.785149385261531  LUMO = 2.62435354555491
  mo_energy =
[-3.27116969e+01 -1.89744186e+00 -7.85149385e-01 -7.85149385e-01
 -7.85149385e-01  2.62435355e+00  2.62435355e+00  2.62435355e+00
  2.66752274e+00  1.98258547e+01  1.98258547e+01  1.98258547e+01
  4.39317468e+01  3.19384415e+02  1.98472834e+03  7.27381740e+03]
E1 = -182.45973560524237  E_coul = 54.2626737961302
cycle= 3 E= -128.197061809112  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00105884
diis-c [-6.49186437e-08 -3.56860315e-03  9.71326196e-04  1.00259728e+00]
  HOMO = -0.785423231018468  LUMO = 2.62414009345419
  mo_energy =
[-3.27124929e+01 -1.89777978e+00 -7.85423231e-01 -7.85423231e-01
 -7.85423231e-01  2.62414009e+00  2.62414009e+00  2.62414009e+00
  2.66725948e+00  1.98252364e+01  1.98252364e+01  1.98252364e+01
  4.39310098e+01  3.19383758e+02  1.98472781e+03  7.27381690e+03]
E1 = -182.46125017572015  E_coul = 54.26418832337533
cycle= 4 E= -128.197061852345  delta_E= -4.32e-08  |g|= 4.6e-05  |ddm|= 0.000278
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.34512e-05
diis-c [-2.12889749e-10  4.55460711e-04 -1.16584250e-03 -1.62397822e-01
  1.16310820e+00]
  HOMO = -0.785409944036116  LUMO = 2.62415164859902
  mo_energy =
[-3.27124587e+01 -1.89777713e+00 -7.85409944e-01 -7.85409944e-01
 -7.85409944e-01  2.62415165e+00  2.62415165e+00  2.62415165e+00
  2.66726102e+00  1.98252629e+01  1.98252629e+01  1.98252629e+01
  4.39310374e+01  3.19383805e+02  1.98472787e+03  7.27381697e+03]
E1 = -182.46119307242034  E_coul = 54.264131219835086
cycle= 5 E= -128.197061852585  delta_E= -2.4e-10  |g|= 1.65e-06  |ddm|= 2.3e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46119307242034  E_coul = 54.264131219835086
  HOMO = -0.785409816413232  LUMO = 2.62415177017677
  mo_energy =
[-3.27124585e+01 -1.89777741e+00 -7.85409816e-01 -7.85409816e-01
 -7.85409816e-01  2.62415177e+00  2.62415177e+00  2.62415177e+00
  2.66726077e+00  1.98252630e+01  1.98252630e+01  1.98252630e+01
  4.39310375e+01  3.19383806e+02  1.98472787e+03  7.27381697e+03]
E1 = -182.46119278292778  E_coul = 54.264130930342326
Extra cycle  E= -128.197061852585  delta_E= -1.99e-13  |g|= 3.11e-07  |ddm|= 9.54e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.31952957331774
E1 = -182.46119278292778  E_coul = 54.264130930342326
init E= -128.197061852585
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785409819296625  LUMO = 2.62415176585691
  mo_energy =
[-3.27124585e+01 -1.89777749e+00 -7.85409819e-01 -7.85409819e-01
 -7.85409819e-01  2.62415177e+00  2.62415177e+00  2.62415177e+00
  2.66726070e+00  1.98252630e+01  1.98252630e+01  1.98252630e+01
  4.39310374e+01  3.19383806e+02  1.98472787e+03  7.27381697e+03]
E1 = -182.46119291088786  E_coul = 54.2641310583023
cycle= 1 E= -128.197061852586  delta_E= -1.14e-13  |g|= 5.71e-08  |ddm|= 1.81e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46119291088786  E_coul = 54.2641310583023
  HOMO = -0.785409807345892  LUMO = 2.6241517763835
  mo_energy =
[-3.27124585e+01 -1.89777749e+00 -7.85409807e-01 -7.85409807e-01
 -7.85409807e-01  2.62415178e+00  2.62415178e+00  2.62415178e+00
  2.66726070e+00  1.98252630e+01  1.98252630e+01  1.98252630e+01
  4.39310374e+01  3.19383806e+02  1.98472787e+03  7.27381697e+03]
E1 = -182.4611928630357  E_coul = 54.26413101045004
Extra cycle  E= -128.197061852586  delta_E= -8.53e-14  |g|= 1.26e-08  |ddm|= 2.98e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419178e+03 2.15469198e+02 1.42945957e+03 5.67670257e-01
 4.84332260e+01 1.30626642e+01 1.89997579e+00 2.77754854e+00
 1.33319114e+01 6.00565616e-01]
grad_E = [-7.48687083e-06 -3.13403072e-04  4.59520767e-05 -2.15102678e-05
  4.25266086e-04  5.08732990e-04 -4.65735272e-04 -1.75440482e-05
  3.53007239e-06  4.13571789e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.1919054         1
[INPUT] 0    0    [1    /1   ]  215.474860117        1
[INPUT] 0    0    [1    /1   ]  1429.45877521        1
[INPUT] 0    0    [1    /1   ]  0.568712917746       1
[INPUT] 0    0    [1    /1   ]  48.4224831421        1
[INPUT] 0    0    [1    /1   ]  13.0667121613        1
[INPUT] 0    0    [1    /1   ]  1.90371512938        1
[INPUT] 1    0    [1    /1   ]  2.77745171819        1
[INPUT] 1    0    [1    /1   ]  13.3319038779        1
[INPUT] 1    0    [1    /1   ]  0.600558077861       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1919054009504, 1.0]], [0, [215.47486011714776, 1.0]], [0, [1429.45877521496, 1.0]], [0, [0.5687129177458625, 1.0]], [0, [48.42248314212537, 1.0]], [0, [13.06671216129892, 1.0]], [0, [1.9037151293844325, 1.0]], [1, [2.7774517181878764, 1.0]], [1, [13.331903877925201, 1.0]], [1, [0.6005580778605454, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.1919054]
bas 1, expnt(s) = [215.47486012]
bas 2, expnt(s) = [1429.45877521]
bas 3, expnt(s) = [0.56871292]
bas 4, expnt(s) = [48.42248314]
bas 5, expnt(s) = [13.06671216]
bas 6, expnt(s) = [1.90371513]
bas 7, expnt(s) = [2.77745172]
bas 8, expnt(s) = [13.33190388]
bas 9, expnt(s) = [0.60055808]
CPU time:        21.33
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419191e+03 7.96091090e+02 2.15474860e+02 1.42089662e+02
 1.42945878e+03 5.87345642e+02 5.68712918e-01 1.65456885e+00
 4.84224831e+01 4.63767506e+01 1.30667122e+01 1.73635998e+01
 1.90371513e+00 4.09464727e+00 2.77745172e+00 1.04602615e+01
 1.33319039e+01 7.43189576e+01 6.00558078e-01 1.54233303e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965760986324508
cond(S) = 156.34238099420097
E1 = -183.13577521516424  E_coul = 55.011314753824124
init E= -128.12446046134
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742882051032127  LUMO = 2.65785848928864
  mo_energy =
[-3.25128636e+01 -1.85388166e+00 -7.42882051e-01 -7.42882051e-01
 -7.42882051e-01  2.65785849e+00  2.65785849e+00  2.65785849e+00
  2.70867344e+00  1.99602149e+01  1.99602149e+01  1.99602149e+01
  4.41241845e+01  3.19617327e+02  1.98500689e+03  7.27412097e+03]
E1 = -182.13006126841356  E_coul = 53.93493464169178
cycle= 1 E= -128.195126626722  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261858
diis-c [-0.06856947  1.        ]
  HOMO = -0.807938087997784  LUMO = 2.60364384099923
  mo_energy =
[-3.27865591e+01 -1.92107708e+00 -8.07938088e-01 -8.07938088e-01
 -8.07938088e-01  2.60364384e+00  2.60364384e+00  2.60364384e+00
  2.65590907e+00  1.97693289e+01  1.97693289e+01  1.97693289e+01
  4.38902900e+01  3.19308110e+02  1.98464711e+03  7.27373580e+03]
E1 = -182.592901606641  E_coul = 54.39614053522229
cycle= 2 E= -128.196761071419  delta_E= -0.00163  |g|= 0.0626  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101972
diis-c [-4.54991962e-04  2.76448407e-01  7.23551593e-01]
  HOMO = -0.785106302395109  LUMO = 2.62432236539323
  mo_energy =
[-3.27116069e+01 -1.89739453e+00 -7.85106302e-01 -7.85106302e-01
 -7.85106302e-01  2.62432237e+00  2.62432237e+00  2.62432237e+00
  2.67582153e+00  1.98256309e+01  1.98256309e+01  1.98256309e+01
  4.39562090e+01  3.19389854e+02  1.98473448e+03  7.27382467e+03]
E1 = -182.4602999964008  E_coul = 54.263233384165005
cycle= 3 E= -128.197066612236  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00105396
diis-c [-6.73411265e-08 -3.59866436e-03  8.36713863e-04  1.00276195e+00]
  HOMO = -0.785378996798953  LUMO = 2.62410990874797
  mo_energy =
[-3.27123998e+01 -1.89773259e+00 -7.85378997e-01 -7.85378997e-01
 -7.85378997e-01  2.62410991e+00  2.62410991e+00  2.62410991e+00
  2.67555750e+00  1.98250149e+01  1.98250149e+01  1.98250149e+01
  4.39554742e+01  3.19389203e+02  1.98473395e+03  7.27382418e+03]
E1 = -182.46180960036  E_coul = 54.26474294492672
cycle= 4 E= -128.197066655433  delta_E= -4.32e-08  |g|= 4.69e-05  |ddm|= 0.00028
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.49123e-05
diis-c [-2.16476025e-10  4.60431122e-04 -1.16685352e-03 -1.63308445e-01
  1.16401487e+00]
  HOMO = -0.78536546136707  LUMO = 2.62412167924809
  mo_energy =
[-3.27123649e+01 -1.89772993e+00 -7.85365461e-01 -7.85365461e-01
 -7.85365461e-01  2.62412168e+00  2.62412168e+00  2.62412168e+00
  2.67555904e+00  1.98250419e+01  1.98250419e+01  1.98250419e+01
  4.39555023e+01  3.19389251e+02  1.98473401e+03  7.27382425e+03]
E1 = -182.46175137744228  E_coul = 54.26468472175852
cycle= 5 E= -128.197066655684  delta_E= -2.5e-10  |g|= 1.65e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46175137744228  E_coul = 54.26468472175852
  HOMO = -0.785365342104668  LUMO = 2.62412179358446
  mo_energy =
[-3.27123647e+01 -1.89773022e+00 -7.85365342e-01 -7.85365342e-01
 -7.85365342e-01  2.62412179e+00  2.62412179e+00  2.62412179e+00
  2.67555879e+00  1.98250420e+01  1.98250420e+01  1.98250420e+01
  4.39555024e+01  3.19389251e+02  1.98473401e+03  7.27382425e+03]
E1 = -182.4617511267802  E_coul = 54.26468447109599
Extra cycle  E= -128.197066655684  delta_E= -4.55e-13  |g|= 3.1e-07  |ddm|= 9.55e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419191e+03 2.15474860e+02 1.42945878e+03 5.68712918e-01
 4.84224831e+01 1.30667122e+01 1.90371513e+00 2.77745172e+00
 1.33319039e+01 6.00558078e-01]
E = -128.1970666556842
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.1919054         1
[INPUT] 0    0    [1    /1   ]  215.474860117        1
[INPUT] 0    0    [1    /1   ]  1429.45877521        1
[INPUT] 0    0    [1    /1   ]  0.568712917746       1
[INPUT] 0    0    [1    /1   ]  48.4224831421        1
[INPUT] 0    0    [1    /1   ]  13.0667121613        1
[INPUT] 0    0    [1    /1   ]  1.90371512938        1
[INPUT] 1    0    [1    /1   ]  2.77745171819        1
[INPUT] 1    0    [1    /1   ]  13.3319038779        1
[INPUT] 1    0    [1    /1   ]  0.600558077861       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1919054009504, 1.0]], [0, [215.47486011714776, 1.0]], [0, [1429.45877521496, 1.0]], [0, [0.5687129177458625, 1.0]], [0, [48.42248314212537, 1.0]], [0, [13.06671216129892, 1.0]], [0, [1.9037151293844325, 1.0]], [1, [2.7774517181878764, 1.0]], [1, [13.331903877925201, 1.0]], [1, [0.6005580778605454, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.1919054]
bas 1, expnt(s) = [215.47486012]
bas 2, expnt(s) = [1429.45877521]
bas 3, expnt(s) = [0.56871292]
bas 4, expnt(s) = [48.42248314]
bas 5, expnt(s) = [13.06671216]
bas 6, expnt(s) = [1.90371513]
bas 7, expnt(s) = [2.77745172]
bas 8, expnt(s) = [13.33190388]
bas 9, expnt(s) = [0.60055808]
CPU time:        21.55
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419191e+03 7.96091090e+02 2.15474860e+02 1.42089662e+02
 1.42945878e+03 5.87345642e+02 5.68712918e-01 1.65456885e+00
 4.84224831e+01 4.63767506e+01 1.30667122e+01 1.73635998e+01
 1.90371513e+00 4.09464727e+00 2.77745172e+00 1.04602615e+01
 1.33319039e+01 7.43189576e+01 6.00558078e-01 1.54233303e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965760986324508
cond(S) = 156.34238099420097
E1 = -183.13577521516424  E_coul = 55.011314753824124
init E= -128.12446046134
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742882051032127  LUMO = 2.65785848928864
  mo_energy =
[-3.25128636e+01 -1.85388166e+00 -7.42882051e-01 -7.42882051e-01
 -7.42882051e-01  2.65785849e+00  2.65785849e+00  2.65785849e+00
  2.70867344e+00  1.99602149e+01  1.99602149e+01  1.99602149e+01
  4.41241845e+01  3.19617327e+02  1.98500689e+03  7.27412097e+03]
E1 = -182.13006126841356  E_coul = 53.93493464169178
cycle= 1 E= -128.195126626722  delta_E= -0.0707  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261858
diis-c [-0.06856947  1.        ]
  HOMO = -0.807938087997784  LUMO = 2.60364384099923
  mo_energy =
[-3.27865591e+01 -1.92107708e+00 -8.07938088e-01 -8.07938088e-01
 -8.07938088e-01  2.60364384e+00  2.60364384e+00  2.60364384e+00
  2.65590907e+00  1.97693289e+01  1.97693289e+01  1.97693289e+01
  4.38902900e+01  3.19308110e+02  1.98464711e+03  7.27373580e+03]
E1 = -182.592901606641  E_coul = 54.39614053522229
cycle= 2 E= -128.196761071419  delta_E= -0.00163  |g|= 0.0626  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101972
diis-c [-4.54991962e-04  2.76448407e-01  7.23551593e-01]
  HOMO = -0.785106302395109  LUMO = 2.62432236539323
  mo_energy =
[-3.27116069e+01 -1.89739453e+00 -7.85106302e-01 -7.85106302e-01
 -7.85106302e-01  2.62432237e+00  2.62432237e+00  2.62432237e+00
  2.67582153e+00  1.98256309e+01  1.98256309e+01  1.98256309e+01
  4.39562090e+01  3.19389854e+02  1.98473448e+03  7.27382467e+03]
E1 = -182.4602999964008  E_coul = 54.263233384165005
cycle= 3 E= -128.197066612236  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00105396
diis-c [-6.73411265e-08 -3.59866436e-03  8.36713863e-04  1.00276195e+00]
  HOMO = -0.785378996798953  LUMO = 2.62410990874797
  mo_energy =
[-3.27123998e+01 -1.89773259e+00 -7.85378997e-01 -7.85378997e-01
 -7.85378997e-01  2.62410991e+00  2.62410991e+00  2.62410991e+00
  2.67555750e+00  1.98250149e+01  1.98250149e+01  1.98250149e+01
  4.39554742e+01  3.19389203e+02  1.98473395e+03  7.27382418e+03]
E1 = -182.46180960036  E_coul = 54.26474294492672
cycle= 4 E= -128.197066655433  delta_E= -4.32e-08  |g|= 4.69e-05  |ddm|= 0.00028
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.49123e-05
diis-c [-2.16476025e-10  4.60431122e-04 -1.16685352e-03 -1.63308445e-01
  1.16401487e+00]
  HOMO = -0.78536546136707  LUMO = 2.62412167924809
  mo_energy =
[-3.27123649e+01 -1.89772993e+00 -7.85365461e-01 -7.85365461e-01
 -7.85365461e-01  2.62412168e+00  2.62412168e+00  2.62412168e+00
  2.67555904e+00  1.98250419e+01  1.98250419e+01  1.98250419e+01
  4.39555023e+01  3.19389251e+02  1.98473401e+03  7.27382425e+03]
E1 = -182.46175137744228  E_coul = 54.26468472175852
cycle= 5 E= -128.197066655684  delta_E= -2.5e-10  |g|= 1.65e-06  |ddm|= 2.35e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46175137744228  E_coul = 54.26468472175852
  HOMO = -0.785365342104668  LUMO = 2.62412179358446
  mo_energy =
[-3.27123647e+01 -1.89773022e+00 -7.85365342e-01 -7.85365342e-01
 -7.85365342e-01  2.62412179e+00  2.62412179e+00  2.62412179e+00
  2.67555879e+00  1.98250420e+01  1.98250420e+01  1.98250420e+01
  4.39555024e+01  3.19389251e+02  1.98473401e+03  7.27382425e+03]
E1 = -182.4617511267802  E_coul = 54.26468447109599
Extra cycle  E= -128.197066655684  delta_E= -4.55e-13  |g|= 3.1e-07  |ddm|= 9.55e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.34238099420097
E1 = -182.4617511267802  E_coul = 54.26468447109599
init E= -128.197066655684
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785365342401251  LUMO = 2.62412179160735
  mo_energy =
[-3.27123648e+01 -1.89773030e+00 -7.85365342e-01 -7.85365342e-01
 -7.85365342e-01  2.62412179e+00  2.62412179e+00  2.62412179e+00
  2.67555872e+00  1.98250420e+01  1.98250420e+01  1.98250420e+01
  4.39555023e+01  3.19389251e+02  1.98473401e+03  7.27382425e+03]
E1 = -182.46175123864765  E_coul = 54.26468458296336
cycle= 1 E= -128.197066655684  delta_E= -8.53e-14  |g|= 5.66e-08  |ddm|= 1.8e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46175123864765  E_coul = 54.26468458296336
  HOMO = -0.78536533156337  LUMO = 2.62412180112694
  mo_energy =
[-3.27123647e+01 -1.89773030e+00 -7.85365332e-01 -7.85365332e-01
 -7.85365332e-01  2.62412180e+00  2.62412180e+00  2.62412180e+00
  2.67555871e+00  1.98250420e+01  1.98250420e+01  1.98250420e+01
  4.39555024e+01  3.19389251e+02  1.98473401e+03  7.27382425e+03]
E1 = -182.46175119708343  E_coul = 54.26468454139908
Extra cycle  E= -128.197066655684  delta_E= -5.68e-14  |g|= 1.21e-08  |ddm|= 2.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419191e+03 2.15474860e+02 1.42945878e+03 5.68712918e-01
 4.84224831e+01 1.30667122e+01 1.90371513e+00 2.77745172e+00
 1.33319039e+01 6.00558078e-01]
grad_E = [-7.50106877e-06 -3.05866888e-04  4.58733002e-05  3.01551874e-04
  3.39011728e-04  7.64719858e-04 -4.09309235e-04 -9.47358493e-05
  1.13882954e-05  1.59949973e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19214811        1
[INPUT] 0    0    [1    /1   ]  215.485420982        1
[INPUT] 0    0    [1    /1   ]  1429.45727792        1
[INPUT] 0    0    [1    /1   ]  0.570804645315       1
[INPUT] 0    0    [1    /1   ]  48.4036100468        1
[INPUT] 0    0    [1    /1   ]  13.0692229952        1
[INPUT] 0    0    [1    /1   ]  1.91237904026        1
[INPUT] 1    0    [1    /1   ]  2.77734868186        1
[INPUT] 1    0    [1    /1   ]  13.3318738485        1
[INPUT] 1    0    [1    /1   ]  0.60054950623        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1921481142626, 1.0]], [0, [215.48542098153914, 1.0]], [0, [1429.4572779177165, 1.0]], [0, [0.5708046453153425, 1.0]], [0, [48.403610046782724, 1.0]], [0, [13.06922299520262, 1.0]], [0, [1.9123790402613965, 1.0]], [1, [2.7773486818601762, 1.0]], [1, [13.331873848515562, 1.0]], [1, [0.6005495062298117, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19214811]
bas 1, expnt(s) = [215.48542098]
bas 2, expnt(s) = [1429.45727792]
bas 3, expnt(s) = [0.57080465]
bas 4, expnt(s) = [48.40361005]
bas 5, expnt(s) = [13.069223]
bas 6, expnt(s) = [1.91237904]
bas 7, expnt(s) = [2.77734868]
bas 8, expnt(s) = [13.33187385]
bas 9, expnt(s) = [0.60054951]
CPU time:        23.50
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419215e+03 7.96091158e+02 2.15485421e+02 1.42094885e+02
 1.42945728e+03 5.87345180e+02 5.70804645e-01 1.65913089e+00
 4.84036100e+01 4.63631932e+01 1.30692230e+01 1.73661021e+01
 1.91237904e+00 4.10861555e+00 2.77734868e+00 1.04597764e+01
 1.33318738e+01 7.43187484e+01 6.00549506e-01 1.54230551e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96572983731603
cond(S) = 156.38702678193155
E1 = -183.13588546137683  E_coul = 55.01138264311293
init E= -128.124502818264
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742877048194366  LUMO = 2.65778119144944
  mo_energy =
[-3.25129324e+01 -1.85379424e+00 -7.42877048e-01 -7.42877048e-01
 -7.42877048e-01  2.65778119e+00  2.65778119e+00  2.65778119e+00
  2.72677606e+00  1.99598660e+01  1.99598660e+01  1.99598660e+01
  4.41659349e+01  3.19618134e+02  1.98501051e+03  7.27412727e+03]
E1 = -182.13114301729263  E_coul = 53.93600616135678
cycle= 1 E= -128.195136855936  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261657
diis-c [-0.06846429  1.        ]
  HOMO = -0.807850548793826  LUMO = 2.60364648265094
  mo_energy =
[-3.27864121e+01 -1.92095412e+00 -8.07850549e-01 -8.07850549e-01
 -8.07850549e-01  2.60364648e+00  2.60364648e+00  2.60364648e+00
  2.67370881e+00  1.97691490e+01  1.97691490e+01  1.97691490e+01
  4.39322160e+01  3.19309162e+02  1.98465093e+03  7.27374231e+03]
E1 = -182.59357334511537  E_coul = 54.3968041205713
cycle= 2 E= -128.196769224544  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.1019
diis-c [-4.55536637e-04  2.76450126e-01  7.23549874e-01]
  HOMO = -0.785041884973804  LUMO = 2.62430400294315
  mo_energy =
[-3.27115174e+01 -1.89729317e+00 -7.85041885e-01 -7.85041885e-01
 -7.85041885e-01  2.62430400e+00  2.62430400e+00  2.62430400e+00
  2.69369791e+00  1.98254053e+01  1.98254053e+01  1.98254053e+01
  4.39980782e+01  3.19390849e+02  1.98473825e+03  7.27383114e+03]
E1 = -182.4611053696756  E_coul = 54.26403110317114
cycle= 3 E= -128.197074266504  delta_E= -0.000305  |g|= 0.000788  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104906
diis-c [-7.05407135e-08 -3.63631689e-03  6.78724634e-04  1.00295759e+00]
  HOMO = -0.785313448079395  LUMO = 2.62409250901049
  mo_energy =
[-3.27123071e+01 -1.89763176e+00 -7.85313448e-01 -7.85313448e-01
 -7.85313448e-01  2.62409251e+00  2.62409251e+00  2.62409251e+00
  2.69343205e+00  1.98247915e+01  1.98247915e+01  1.98247915e+01
  4.39973457e+01  3.19390203e+02  1.98473773e+03  7.27383065e+03]
E1 = -182.46260973922395  E_coul = 54.26553542948674
cycle= 4 E= -128.197074309737  delta_E= -4.32e-08  |g|= 4.81e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.67091e-05
diis-c [-2.18877876e-10  4.66374215e-04 -1.17015109e-03 -1.64470848e-01
  1.16517463e+00]
  HOMO = -0.785299627769068  LUMO = 2.62410452614153
  mo_energy =
[-3.27122715e+01 -1.89762911e+00 -7.85299628e-01 -7.85299628e-01
 -7.85299628e-01  2.62410453e+00  2.62410453e+00  2.62410453e+00
  2.69343357e+00  1.98248191e+01  1.98248191e+01  1.98248191e+01
  4.39973744e+01  3.19390252e+02  1.98473780e+03  7.27383072e+03]
E1 = -182.4625501476129  E_coul = 54.26547583761246
cycle= 5 E= -128.19707431  delta_E= -2.63e-10  |g|= 1.64e-06  |ddm|= 2.41e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4625501476129  E_coul = 54.26547583761246
  HOMO = -0.785299520021486  LUMO = 2.62410463046476
  mo_energy =
[-3.27122713e+01 -1.89762941e+00 -7.85299520e-01 -7.85299520e-01
 -7.85299520e-01  2.62410463e+00  2.62410463e+00  2.62410463e+00
  2.69343331e+00  1.98248192e+01  1.98248192e+01  1.98248192e+01
  4.39973745e+01  3.19390252e+02  1.98473780e+03  7.27383072e+03]
E1 = -182.46254994604016  E_coul = 54.265475636039355
Extra cycle  E= -128.197074310001  delta_E= -3.69e-13  |g|= 3.06e-07  |ddm|= 9.51e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419215e+03 2.15485421e+02 1.42945728e+03 5.70804645e-01
 4.84036100e+01 1.30692230e+01 1.91237904e+00 2.77734868e+00
 1.33318738e+01 6.00549506e-01]
E = -128.1970743100008
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19214811        1
[INPUT] 0    0    [1    /1   ]  215.485420982        1
[INPUT] 0    0    [1    /1   ]  1429.45727792        1
[INPUT] 0    0    [1    /1   ]  0.570804645315       1
[INPUT] 0    0    [1    /1   ]  48.4036100468        1
[INPUT] 0    0    [1    /1   ]  13.0692229952        1
[INPUT] 0    0    [1    /1   ]  1.91237904026        1
[INPUT] 1    0    [1    /1   ]  2.77734868186        1
[INPUT] 1    0    [1    /1   ]  13.3318738485        1
[INPUT] 1    0    [1    /1   ]  0.60054950623        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1921481142626, 1.0]], [0, [215.48542098153914, 1.0]], [0, [1429.4572779177165, 1.0]], [0, [0.5708046453153425, 1.0]], [0, [48.403610046782724, 1.0]], [0, [13.06922299520262, 1.0]], [0, [1.9123790402613965, 1.0]], [1, [2.7773486818601762, 1.0]], [1, [13.331873848515562, 1.0]], [1, [0.6005495062298117, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19214811]
bas 1, expnt(s) = [215.48542098]
bas 2, expnt(s) = [1429.45727792]
bas 3, expnt(s) = [0.57080465]
bas 4, expnt(s) = [48.40361005]
bas 5, expnt(s) = [13.069223]
bas 6, expnt(s) = [1.91237904]
bas 7, expnt(s) = [2.77734868]
bas 8, expnt(s) = [13.33187385]
bas 9, expnt(s) = [0.60054951]
CPU time:        23.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419215e+03 7.96091158e+02 2.15485421e+02 1.42094885e+02
 1.42945728e+03 5.87345180e+02 5.70804645e-01 1.65913089e+00
 4.84036100e+01 4.63631932e+01 1.30692230e+01 1.73661021e+01
 1.91237904e+00 4.10861555e+00 2.77734868e+00 1.04597764e+01
 1.33318738e+01 7.43187484e+01 6.00549506e-01 1.54230551e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96572983731603
cond(S) = 156.38702678193155
E1 = -183.13588546137683  E_coul = 55.01138264311293
init E= -128.124502818264
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742877048194366  LUMO = 2.65778119144944
  mo_energy =
[-3.25129324e+01 -1.85379424e+00 -7.42877048e-01 -7.42877048e-01
 -7.42877048e-01  2.65778119e+00  2.65778119e+00  2.65778119e+00
  2.72677606e+00  1.99598660e+01  1.99598660e+01  1.99598660e+01
  4.41659349e+01  3.19618134e+02  1.98501051e+03  7.27412727e+03]
E1 = -182.13114301729263  E_coul = 53.93600616135678
cycle= 1 E= -128.195136855936  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261657
diis-c [-0.06846429  1.        ]
  HOMO = -0.807850548793826  LUMO = 2.60364648265094
  mo_energy =
[-3.27864121e+01 -1.92095412e+00 -8.07850549e-01 -8.07850549e-01
 -8.07850549e-01  2.60364648e+00  2.60364648e+00  2.60364648e+00
  2.67370881e+00  1.97691490e+01  1.97691490e+01  1.97691490e+01
  4.39322160e+01  3.19309162e+02  1.98465093e+03  7.27374231e+03]
E1 = -182.59357334511537  E_coul = 54.3968041205713
cycle= 2 E= -128.196769224544  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.1019
diis-c [-4.55536637e-04  2.76450126e-01  7.23549874e-01]
  HOMO = -0.785041884973804  LUMO = 2.62430400294315
  mo_energy =
[-3.27115174e+01 -1.89729317e+00 -7.85041885e-01 -7.85041885e-01
 -7.85041885e-01  2.62430400e+00  2.62430400e+00  2.62430400e+00
  2.69369791e+00  1.98254053e+01  1.98254053e+01  1.98254053e+01
  4.39980782e+01  3.19390849e+02  1.98473825e+03  7.27383114e+03]
E1 = -182.4611053696756  E_coul = 54.26403110317114
cycle= 3 E= -128.197074266504  delta_E= -0.000305  |g|= 0.000788  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104906
diis-c [-7.05407135e-08 -3.63631689e-03  6.78724634e-04  1.00295759e+00]
  HOMO = -0.785313448079395  LUMO = 2.62409250901049
  mo_energy =
[-3.27123071e+01 -1.89763176e+00 -7.85313448e-01 -7.85313448e-01
 -7.85313448e-01  2.62409251e+00  2.62409251e+00  2.62409251e+00
  2.69343205e+00  1.98247915e+01  1.98247915e+01  1.98247915e+01
  4.39973457e+01  3.19390203e+02  1.98473773e+03  7.27383065e+03]
E1 = -182.46260973922395  E_coul = 54.26553542948674
cycle= 4 E= -128.197074309737  delta_E= -4.32e-08  |g|= 4.81e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.67091e-05
diis-c [-2.18877876e-10  4.66374215e-04 -1.17015109e-03 -1.64470848e-01
  1.16517463e+00]
  HOMO = -0.785299627769068  LUMO = 2.62410452614153
  mo_energy =
[-3.27122715e+01 -1.89762911e+00 -7.85299628e-01 -7.85299628e-01
 -7.85299628e-01  2.62410453e+00  2.62410453e+00  2.62410453e+00
  2.69343357e+00  1.98248191e+01  1.98248191e+01  1.98248191e+01
  4.39973744e+01  3.19390252e+02  1.98473780e+03  7.27383072e+03]
E1 = -182.4625501476129  E_coul = 54.26547583761246
cycle= 5 E= -128.19707431  delta_E= -2.63e-10  |g|= 1.64e-06  |ddm|= 2.41e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4625501476129  E_coul = 54.26547583761246
  HOMO = -0.785299520021486  LUMO = 2.62410463046476
  mo_energy =
[-3.27122713e+01 -1.89762941e+00 -7.85299520e-01 -7.85299520e-01
 -7.85299520e-01  2.62410463e+00  2.62410463e+00  2.62410463e+00
  2.69343331e+00  1.98248192e+01  1.98248192e+01  1.98248192e+01
  4.39973745e+01  3.19390252e+02  1.98473780e+03  7.27383072e+03]
E1 = -182.46254994604016  E_coul = 54.265475636039355
Extra cycle  E= -128.197074310001  delta_E= -3.69e-13  |g|= 3.06e-07  |ddm|= 9.51e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.38702678193155
E1 = -182.46254994604016  E_coul = 54.265475636039355
init E= -128.197074310001
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785299517175813  LUMO = 2.62410463134442
  mo_energy =
[-3.27122713e+01 -1.89762948e+00 -7.85299517e-01 -7.85299517e-01
 -7.85299517e-01  2.62410463e+00  2.62410463e+00  2.62410463e+00
  2.69343324e+00  1.98248192e+01  1.98248192e+01  1.98248192e+01
  4.39973744e+01  3.19390252e+02  1.98473780e+03  7.27383072e+03]
E1 = -182.46255003702692  E_coul = 54.26547572702589
cycle= 1 E= -128.197074310001  delta_E= -2.27e-13  |g|= 5.58e-08  |ddm|= 1.78e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46255003702692  E_coul = 54.26547572702589
  HOMO = -0.785299507807527  LUMO = 2.62410463953653
  mo_energy =
[-3.27122713e+01 -1.89762949e+00 -7.85299508e-01 -7.85299508e-01
 -7.85299508e-01  2.62410464e+00  2.62410464e+00  2.62410464e+00
  2.69343324e+00  1.98248192e+01  1.98248192e+01  1.98248192e+01
  4.39973745e+01  3.19390252e+02  1.98473780e+03  7.27383072e+03]
E1 = -182.4625500035207  E_coul = 54.26547569351977
Extra cycle  E= -128.197074310001  delta_E= 8.53e-14  |g|= 1.14e-08  |ddm|= 2.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419215e+03 2.15485421e+02 1.42945728e+03 5.70804645e-01
 4.84036100e+01 1.30692230e+01 1.91237904e+00 2.77734868e+00
 1.33318738e+01 6.00549506e-01]
grad_E = [-7.52053210e-06 -2.96198409e-04  4.57656175e-05  6.46518009e-04
  2.45189589e-04  9.59029787e-04 -6.77936189e-05 -1.80841431e-04
  2.00590054e-05  2.42614993e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.1923648         1
[INPUT] 0    0    [1    /1   ]  215.494734069        1
[INPUT] 0    0    [1    /1   ]  1429.45594343        1
[INPUT] 0    0    [1    /1   ]  0.572667490721       1
[INPUT] 0    0    [1    /1   ]  48.3881770892        1
[INPUT] 0    0    [1    /1   ]  13.0663571368        1
[INPUT] 0    0    [1    /1   ]  1.9212095953         1
[INPUT] 1    0    [1    /1   ]  2.77738196117        1
[INPUT] 1    0    [1    /1   ]  13.3318268522        1
[INPUT] 1    0    [1    /1   ]  0.600557504007       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.192364795132, 1.0]], [0, [215.4947340689371, 1.0]], [0, [1429.4559434296168, 1.0]], [0, [0.5726674907213362, 1.0]], [0, [48.388177089242525, 1.0]], [0, [13.066357136844047, 1.0]], [0, [1.9212095952991102, 1.0]], [1, [2.7773819611677033, 1.0]], [1, [13.331826852199553, 1.0]], [1, [0.6005575040073876, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.1923648]
bas 1, expnt(s) = [215.49473407]
bas 2, expnt(s) = [1429.45594343]
bas 3, expnt(s) = [0.57266749]
bas 4, expnt(s) = [48.38817709]
bas 5, expnt(s) = [13.06635714]
bas 6, expnt(s) = [1.9212096]
bas 7, expnt(s) = [2.77738196]
bas 8, expnt(s) = [13.33182685]
bas 9, expnt(s) = [0.6005575]
CPU time:        25.67
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419236e+03 7.96091218e+02 2.15494734e+02 1.42099490e+02
 1.42945594e+03 5.87344769e+02 5.72667491e-01 1.66319022e+00
 4.83881771e+01 4.63521059e+01 1.30663571e+01 1.73632460e+01
 1.92120960e+00 4.12283624e+00 2.77738196e+00 1.04599331e+01
 1.33318269e+01 7.43184209e+01 6.00557504e-01 1.54233119e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965699093180662
cond(S) = 156.42559475914243
E1 = -183.13601954033103  E_coul = 55.011462291623765
init E= -128.124557248707
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742873340675946  LUMO = 2.65782794268201
  mo_energy =
[-3.25129960e+01 -1.85370390e+00 -7.42873341e-01 -7.42873341e-01
 -7.42873341e-01  2.65782794e+00  2.65782794e+00  2.65782794e+00
  2.74411589e+00  1.99599777e+01  1.99599777e+01  1.99599777e+01
  4.41963242e+01  3.19607693e+02  1.98500450e+03  7.27412436e+03]
E1 = -182.13176063418524  E_coul = 53.93661648007528
cycle= 1 E= -128.19514415411  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261604
diis-c [-0.06843686  1.        ]
  HOMO = -0.80779706295827  LUMO = 2.60373914050227
  mo_energy =
[-3.27863808e+01 -1.92084360e+00 -8.07797063e-01 -8.07797063e-01
 -8.07797063e-01  2.60373914e+00  2.60373914e+00  2.60373914e+00
  2.69074477e+00  1.97693346e+01  1.97693346e+01  1.97693346e+01
  4.39626877e+01  3.19298748e+02  1.98464490e+03  7.27373937e+03]
E1 = -182.59396456500485  E_coul = 54.39718890839578
cycle= 2 E= -128.196775656609  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101867
diis-c [-4.55203929e-04  2.76426847e-01  7.23573153e-01]
  HOMO = -0.785001819969456  LUMO = 2.62438528474129
  mo_energy =
[-3.27115115e+01 -1.89719336e+00 -7.85001820e-01 -7.85001820e-01
 -7.85001820e-01  2.62438528e+00  2.62438528e+00  2.62438528e+00
  2.71081651e+00  1.98255691e+01  1.98255691e+01  1.98255691e+01
  4.40285191e+01  3.19380410e+02  1.98473220e+03  7.27382817e+03]
E1 = -182.4615691158623  E_coul = 54.264488662764656
cycle= 3 E= -128.197080453098  delta_E= -0.000305  |g|= 0.000789  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104916
diis-c [-7.17412687e-08 -3.64937295e-03  6.41600996e-04  1.00300777e+00]
  HOMO = -0.785273470043971  LUMO = 2.62417368180842
  mo_energy =
[-3.27123011e+01 -1.89753263e+00 -7.85273470e-01 -7.85273470e-01
 -7.85273470e-01  2.62417368e+00  2.62417368e+00  2.62417368e+00
  2.71054874e+00  1.98249552e+01  1.98249552e+01  1.98249552e+01
  4.40277863e+01  3.19379764e+02  1.98473168e+03  7.27382769e+03]
E1 = -182.46307321467324  E_coul = 54.265992718230684
cycle= 4 E= -128.197080496443  delta_E= -4.33e-08  |g|= 4.84e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.72415e-05
diis-c [-2.16751385e-10  4.68109966e-04 -1.17430706e-03 -1.64914794e-01
  1.16562099e+00]
  HOMO = -0.785259595245917  LUMO = 2.62418574584038
  mo_energy =
[-3.27122653e+01 -1.89753003e+00 -7.85259595e-01 -7.85259595e-01
 -7.85259595e-01  2.62418575e+00  2.62418575e+00  2.62418575e+00
  2.71055024e+00  1.98249829e+01  1.98249829e+01  1.98249829e+01
  4.40278151e+01  3.19379813e+02  1.98473174e+03  7.27382776e+03]
E1 = -182.46301322707427  E_coul = 54.265932730364774
cycle= 5 E= -128.19708049671  delta_E= -2.67e-10  |g|= 1.63e-06  |ddm|= 2.43e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46301322707427  E_coul = 54.265932730364774
  HOMO = -0.78525949271587  LUMO = 2.62418584558809
  mo_energy =
[-3.27122651e+01 -1.89753033e+00 -7.85259493e-01 -7.85259493e-01
 -7.85259493e-01  2.62418585e+00  2.62418585e+00  2.62418585e+00
  2.71054998e+00  1.98249830e+01  1.98249830e+01  1.98249830e+01
  4.40278152e+01  3.19379813e+02  1.98473174e+03  7.27382776e+03]
E1 = -182.46301304202964  E_coul = 54.26593254531975
Extra cycle  E= -128.19708049671  delta_E= -3.98e-13  |g|= 3.03e-07  |ddm|= 9.43e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419236e+03 2.15494734e+02 1.42945594e+03 5.72667491e-01
 4.83881771e+01 1.30663571e+01 1.92120960e+00 2.77738196e+00
 1.33318269e+01 6.00557504e-01]
E = -128.1970804967099
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.1923648         1
[INPUT] 0    0    [1    /1   ]  215.494734069        1
[INPUT] 0    0    [1    /1   ]  1429.45594343        1
[INPUT] 0    0    [1    /1   ]  0.572667490721       1
[INPUT] 0    0    [1    /1   ]  48.3881770892        1
[INPUT] 0    0    [1    /1   ]  13.0663571368        1
[INPUT] 0    0    [1    /1   ]  1.9212095953         1
[INPUT] 1    0    [1    /1   ]  2.77738196117        1
[INPUT] 1    0    [1    /1   ]  13.3318268522        1
[INPUT] 1    0    [1    /1   ]  0.600557504007       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.192364795132, 1.0]], [0, [215.4947340689371, 1.0]], [0, [1429.4559434296168, 1.0]], [0, [0.5726674907213362, 1.0]], [0, [48.388177089242525, 1.0]], [0, [13.066357136844047, 1.0]], [0, [1.9212095952991102, 1.0]], [1, [2.7773819611677033, 1.0]], [1, [13.331826852199553, 1.0]], [1, [0.6005575040073876, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.1923648]
bas 1, expnt(s) = [215.49473407]
bas 2, expnt(s) = [1429.45594343]
bas 3, expnt(s) = [0.57266749]
bas 4, expnt(s) = [48.38817709]
bas 5, expnt(s) = [13.06635714]
bas 6, expnt(s) = [1.9212096]
bas 7, expnt(s) = [2.77738196]
bas 8, expnt(s) = [13.33182685]
bas 9, expnt(s) = [0.6005575]
CPU time:        25.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419236e+03 7.96091218e+02 2.15494734e+02 1.42099490e+02
 1.42945594e+03 5.87344769e+02 5.72667491e-01 1.66319022e+00
 4.83881771e+01 4.63521059e+01 1.30663571e+01 1.73632460e+01
 1.92120960e+00 4.12283624e+00 2.77738196e+00 1.04599331e+01
 1.33318269e+01 7.43184209e+01 6.00557504e-01 1.54233119e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965699093180662
cond(S) = 156.42559475914243
E1 = -183.13601954033103  E_coul = 55.011462291623765
init E= -128.124557248707
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742873340675946  LUMO = 2.65782794268201
  mo_energy =
[-3.25129960e+01 -1.85370390e+00 -7.42873341e-01 -7.42873341e-01
 -7.42873341e-01  2.65782794e+00  2.65782794e+00  2.65782794e+00
  2.74411589e+00  1.99599777e+01  1.99599777e+01  1.99599777e+01
  4.41963242e+01  3.19607693e+02  1.98500450e+03  7.27412436e+03]
E1 = -182.13176063418524  E_coul = 53.93661648007528
cycle= 1 E= -128.19514415411  delta_E= -0.0706  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261604
diis-c [-0.06843686  1.        ]
  HOMO = -0.80779706295827  LUMO = 2.60373914050227
  mo_energy =
[-3.27863808e+01 -1.92084360e+00 -8.07797063e-01 -8.07797063e-01
 -8.07797063e-01  2.60373914e+00  2.60373914e+00  2.60373914e+00
  2.69074477e+00  1.97693346e+01  1.97693346e+01  1.97693346e+01
  4.39626877e+01  3.19298748e+02  1.98464490e+03  7.27373937e+03]
E1 = -182.59396456500485  E_coul = 54.39718890839578
cycle= 2 E= -128.196775656609  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101867
diis-c [-4.55203929e-04  2.76426847e-01  7.23573153e-01]
  HOMO = -0.785001819969456  LUMO = 2.62438528474129
  mo_energy =
[-3.27115115e+01 -1.89719336e+00 -7.85001820e-01 -7.85001820e-01
 -7.85001820e-01  2.62438528e+00  2.62438528e+00  2.62438528e+00
  2.71081651e+00  1.98255691e+01  1.98255691e+01  1.98255691e+01
  4.40285191e+01  3.19380410e+02  1.98473220e+03  7.27382817e+03]
E1 = -182.4615691158623  E_coul = 54.264488662764656
cycle= 3 E= -128.197080453098  delta_E= -0.000305  |g|= 0.000789  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104916
diis-c [-7.17412687e-08 -3.64937295e-03  6.41600996e-04  1.00300777e+00]
  HOMO = -0.785273470043971  LUMO = 2.62417368180842
  mo_energy =
[-3.27123011e+01 -1.89753263e+00 -7.85273470e-01 -7.85273470e-01
 -7.85273470e-01  2.62417368e+00  2.62417368e+00  2.62417368e+00
  2.71054874e+00  1.98249552e+01  1.98249552e+01  1.98249552e+01
  4.40277863e+01  3.19379764e+02  1.98473168e+03  7.27382769e+03]
E1 = -182.46307321467324  E_coul = 54.265992718230684
cycle= 4 E= -128.197080496443  delta_E= -4.33e-08  |g|= 4.84e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.72415e-05
diis-c [-2.16751385e-10  4.68109966e-04 -1.17430706e-03 -1.64914794e-01
  1.16562099e+00]
  HOMO = -0.785259595245917  LUMO = 2.62418574584038
  mo_energy =
[-3.27122653e+01 -1.89753003e+00 -7.85259595e-01 -7.85259595e-01
 -7.85259595e-01  2.62418575e+00  2.62418575e+00  2.62418575e+00
  2.71055024e+00  1.98249829e+01  1.98249829e+01  1.98249829e+01
  4.40278151e+01  3.19379813e+02  1.98473174e+03  7.27382776e+03]
E1 = -182.46301322707427  E_coul = 54.265932730364774
cycle= 5 E= -128.19708049671  delta_E= -2.67e-10  |g|= 1.63e-06  |ddm|= 2.43e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46301322707427  E_coul = 54.265932730364774
  HOMO = -0.78525949271587  LUMO = 2.62418584558809
  mo_energy =
[-3.27122651e+01 -1.89753033e+00 -7.85259493e-01 -7.85259493e-01
 -7.85259493e-01  2.62418585e+00  2.62418585e+00  2.62418585e+00
  2.71054998e+00  1.98249830e+01  1.98249830e+01  1.98249830e+01
  4.40278152e+01  3.19379813e+02  1.98473174e+03  7.27382776e+03]
E1 = -182.46301304202964  E_coul = 54.26593254531975
Extra cycle  E= -128.19708049671  delta_E= -3.98e-13  |g|= 3.03e-07  |ddm|= 9.43e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.42559475914243
E1 = -182.46301304202964  E_coul = 54.26593254531975
init E= -128.19708049671
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785259488987331  LUMO = 2.62418584728636
  mo_energy =
[-3.27122651e+01 -1.89753040e+00 -7.85259489e-01 -7.85259489e-01
 -7.85259489e-01  2.62418585e+00  2.62418585e+00  2.62418585e+00
  2.71054991e+00  1.98249830e+01  1.98249830e+01  1.98249830e+01
  4.40278151e+01  3.19379813e+02  1.98473174e+03  7.27382776e+03]
E1 = -182.46301312520666  E_coul = 54.265932628496756
cycle= 1 E= -128.19708049671  delta_E=    0  |g|= 5.51e-08  |ddm|= 1.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46301312520666  E_coul = 54.265932628496756
  HOMO = -0.78525948020325  LUMO = 2.62418585495395
  mo_energy =
[-3.27122651e+01 -1.89753041e+00 -7.85259480e-01 -7.85259480e-01
 -7.85259480e-01  2.62418585e+00  2.62418585e+00  2.62418585e+00
  2.71054991e+00  1.98249830e+01  1.98249830e+01  1.98249830e+01
  4.40278152e+01  3.19379813e+02  1.98473174e+03  7.27382776e+03]
E1 = -182.46301309457675  E_coul = 54.265932597866815
Extra cycle  E= -128.19708049671  delta_E= -2.84e-14  |g|= 1.11e-08  |ddm|= 2.96e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419236e+03 2.15494734e+02 1.42945594e+03 5.72667491e-01
 4.83881771e+01 1.30663571e+01 1.92120960e+00 2.77738196e+00
 1.33318269e+01 6.00557504e-01]
grad_E = [-7.53076293e-06 -2.92030512e-04  4.57095524e-05  6.60188463e-04
  2.28611846e-04  8.56315314e-04  4.41750401e-04 -1.77176930e-04
  1.86273212e-05  1.84251011e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19249833        1
[INPUT] 0    0    [1    /1   ]  215.500362556        1
[INPUT] 0    0    [1    /1   ]  1429.45512319        1
[INPUT] 0    0    [1    /1   ]  0.573625823976       1
[INPUT] 0    0    [1    /1   ]  48.3799641291        1
[INPUT] 0    0    [1    /1   ]  13.0601977876        1
[INPUT] 0    0    [1    /1   ]  1.92677263644        1
[INPUT] 1    0    [1    /1   ]  2.77754714278        1
[INPUT] 1    0    [1    /1   ]  13.3317787553        1
[INPUT] 1    0    [1    /1   ]  0.600584234621       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.192498333455, 1.0]], [0, [215.5003625560488, 1.0]], [0, [1429.4551231886583, 1.0]], [0, [0.5736258239763891, 1.0]], [0, [48.3799641291362, 1.0]], [0, [13.06019778762145, 1.0]], [0, [1.9267726364380238, 1.0]], [1, [2.7775471427825056, 1.0]], [1, [13.33177875534472, 1.0]], [1, [0.6005842346212045, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19249833]
bas 1, expnt(s) = [215.50036256]
bas 2, expnt(s) = [1429.45512319]
bas 3, expnt(s) = [0.57362582]
bas 4, expnt(s) = [48.37996413]
bas 5, expnt(s) = [13.06019779]
bas 6, expnt(s) = [1.92677264]
bas 7, expnt(s) = [2.77754714]
bas 8, expnt(s) = [13.33177876]
bas 9, expnt(s) = [0.60058423]
CPU time:        27.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419250e+03 7.96091255e+02 2.15500363e+02 1.42102274e+02
 1.42945512e+03 5.87344516e+02 5.73625824e-01 1.66527724e+00
 4.83799641e+01 4.63462053e+01 1.30601978e+01 1.73571070e+01
 1.92677264e+00 4.13178654e+00 2.77754714e+00 1.04607107e+01
 1.33317788e+01 7.43180858e+01 6.00584235e-01 1.54241700e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965679165524033
cond(S) = 156.44385132312885
E1 = -183.13612722231144  E_coul = 55.01152372245733
init E= -128.124603499854
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742871771838814  LUMO = 2.65800432055775
  mo_energy =
[-3.25130301e+01 -1.85364683e+00 -7.42871772e-01 -7.42871772e-01
 -7.42871772e-01  2.65800432e+00  2.65800432e+00  2.65800432e+00
  2.75413654e+00  1.99605475e+01  1.99605475e+01  1.99605475e+01
  4.42049106e+01  3.19588397e+02  1.98499026e+03  7.27411285e+03]
E1 = -182.13181687764708  E_coul = 53.93666912425744
cycle= 1 E= -128.19514775339  delta_E= -0.0705  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261683
diis-c [-0.06847784  1.        ]
  HOMO = -0.80778874688644  LUMO = 2.60391807874918
  mo_energy =
[-3.27864421e+01 -1.92078294e+00 -8.07788747e-01 -8.07788747e-01
 -8.07788747e-01  2.60391808e+00  2.60391808e+00  2.60391808e+00
  2.70058048e+00  1.97698815e+01  1.97698815e+01  1.97698815e+01
  4.39712609e+01  3.19279311e+02  1.98463048e+03  7.27372766e+03]
E1 = -182.594010493612  E_coul = 54.39723091640617
cycle= 2 E= -128.196779577206  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101875
diis-c [-4.54301587e-04  2.76391172e-01  7.23608828e-01]
  HOMO = -0.784994871617799  LUMO = 2.62456442549916
  mo_energy =
[-3.27115655e+01 -1.89713151e+00 -7.84994872e-01 -7.84994872e-01
 -7.84994872e-01  2.62456443e+00  2.62456443e+00  2.62456443e+00
  2.72070721e+00  1.98261199e+01  1.98261199e+01  1.98261199e+01
  4.40370912e+01  3.19360981e+02  1.98471778e+03  7.27381647e+03]
E1 = -182.46161615872782  E_coul = 54.26453175711367
cycle= 3 E= -128.197084401614  delta_E= -0.000305  |g|= 0.00079  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00105325
diis-c [-7.07665650e-08 -3.63790098e-03  7.16427424e-04  1.00292147e+00]
  HOMO = -0.78526755995485  LUMO = 2.62435188521227
  mo_energy =
[-3.27123575e+01 -1.89747130e+00 -7.85267560e-01 -7.85267560e-01
 -7.85267560e-01  2.62435189e+00  2.62435189e+00  2.62435189e+00
  2.72043824e+00  1.98255039e+01  1.98255039e+01  1.98255039e+01
  4.40363563e+01  3.19360331e+02  1.98471725e+03  7.27381598e+03]
E1 = -182.46312411596395  E_coul = 54.266039670884176
cycle= 4 E= -128.19708444508  delta_E= -4.35e-08  |g|= 4.8e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.6521e-05
diis-c [-2.12017075e-10  4.65914580e-04 -1.17724817e-03 -1.64609277e-01
  1.16532061e+00]
  HOMO = -0.785253840081022  LUMO = 2.62436381486116
  mo_energy =
[-3.27123220e+01 -1.89746874e+00 -7.85253840e-01 -7.85253840e-01
 -7.85253840e-01  2.62436381e+00  2.62436381e+00  2.62436381e+00
  2.72043972e+00  1.98255314e+01  1.98255314e+01  1.98255314e+01
  4.40363849e+01  3.19360379e+02  1.98471732e+03  7.27381605e+03]
E1 = -182.46306468840126  E_coul = 54.2659802430596
cycle= 5 E= -128.197084445342  delta_E= -2.62e-10  |g|= 1.62e-06  |ddm|= 2.41e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46306468840126  E_coul = 54.2659802430596
  HOMO = -0.785253735584227  LUMO = 2.62436391628022
  mo_energy =
[-3.27123219e+01 -1.89746904e+00 -7.85253736e-01 -7.85253736e-01
 -7.85253736e-01  2.62436392e+00  2.62436392e+00  2.62436392e+00
  2.72043946e+00  1.98255315e+01  1.98255315e+01  1.98255315e+01
  4.40363849e+01  3.19360379e+02  1.98471732e+03  7.27381605e+03]
E1 = -182.46306448694017  E_coul = 54.265980041598226
Extra cycle  E= -128.197084445342  delta_E= -2.84e-13  |g|= 3.01e-07  |ddm|= 9.34e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419250e+03 2.15500363e+02 1.42945512e+03 5.73625824e-01
 4.83799641e+01 1.30601978e+01 1.92677264e+00 2.77754714e+00
 1.33317788e+01 6.00584235e-01]
E = -128.19708444534194
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19249833        1
[INPUT] 0    0    [1    /1   ]  215.500362556        1
[INPUT] 0    0    [1    /1   ]  1429.45512319        1
[INPUT] 0    0    [1    /1   ]  0.573625823976       1
[INPUT] 0    0    [1    /1   ]  48.3799641291        1
[INPUT] 0    0    [1    /1   ]  13.0601977876        1
[INPUT] 0    0    [1    /1   ]  1.92677263644        1
[INPUT] 1    0    [1    /1   ]  2.77754714278        1
[INPUT] 1    0    [1    /1   ]  13.3317787553        1
[INPUT] 1    0    [1    /1   ]  0.600584234621       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.192498333455, 1.0]], [0, [215.5003625560488, 1.0]], [0, [1429.4551231886583, 1.0]], [0, [0.5736258239763891, 1.0]], [0, [48.3799641291362, 1.0]], [0, [13.06019778762145, 1.0]], [0, [1.9267726364380238, 1.0]], [1, [2.7775471427825056, 1.0]], [1, [13.33177875534472, 1.0]], [1, [0.6005842346212045, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19249833]
bas 1, expnt(s) = [215.50036256]
bas 2, expnt(s) = [1429.45512319]
bas 3, expnt(s) = [0.57362582]
bas 4, expnt(s) = [48.37996413]
bas 5, expnt(s) = [13.06019779]
bas 6, expnt(s) = [1.92677264]
bas 7, expnt(s) = [2.77754714]
bas 8, expnt(s) = [13.33177876]
bas 9, expnt(s) = [0.60058423]
CPU time:        28.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419250e+03 7.96091255e+02 2.15500363e+02 1.42102274e+02
 1.42945512e+03 5.87344516e+02 5.73625824e-01 1.66527724e+00
 4.83799641e+01 4.63462053e+01 1.30601978e+01 1.73571070e+01
 1.92677264e+00 4.13178654e+00 2.77754714e+00 1.04607107e+01
 1.33317788e+01 7.43180858e+01 6.00584235e-01 1.54241700e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965679165524033
cond(S) = 156.44385132312885
E1 = -183.13612722231144  E_coul = 55.01152372245733
init E= -128.124603499854
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742871771838814  LUMO = 2.65800432055775
  mo_energy =
[-3.25130301e+01 -1.85364683e+00 -7.42871772e-01 -7.42871772e-01
 -7.42871772e-01  2.65800432e+00  2.65800432e+00  2.65800432e+00
  2.75413654e+00  1.99605475e+01  1.99605475e+01  1.99605475e+01
  4.42049106e+01  3.19588397e+02  1.98499026e+03  7.27411285e+03]
E1 = -182.13181687764708  E_coul = 53.93666912425744
cycle= 1 E= -128.19514775339  delta_E= -0.0705  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261683
diis-c [-0.06847784  1.        ]
  HOMO = -0.80778874688644  LUMO = 2.60391807874918
  mo_energy =
[-3.27864421e+01 -1.92078294e+00 -8.07788747e-01 -8.07788747e-01
 -8.07788747e-01  2.60391808e+00  2.60391808e+00  2.60391808e+00
  2.70058048e+00  1.97698815e+01  1.97698815e+01  1.97698815e+01
  4.39712609e+01  3.19279311e+02  1.98463048e+03  7.27372766e+03]
E1 = -182.594010493612  E_coul = 54.39723091640617
cycle= 2 E= -128.196779577206  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101875
diis-c [-4.54301587e-04  2.76391172e-01  7.23608828e-01]
  HOMO = -0.784994871617799  LUMO = 2.62456442549916
  mo_energy =
[-3.27115655e+01 -1.89713151e+00 -7.84994872e-01 -7.84994872e-01
 -7.84994872e-01  2.62456443e+00  2.62456443e+00  2.62456443e+00
  2.72070721e+00  1.98261199e+01  1.98261199e+01  1.98261199e+01
  4.40370912e+01  3.19360981e+02  1.98471778e+03  7.27381647e+03]
E1 = -182.46161615872782  E_coul = 54.26453175711367
cycle= 3 E= -128.197084401614  delta_E= -0.000305  |g|= 0.00079  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00105325
diis-c [-7.07665650e-08 -3.63790098e-03  7.16427424e-04  1.00292147e+00]
  HOMO = -0.78526755995485  LUMO = 2.62435188521227
  mo_energy =
[-3.27123575e+01 -1.89747130e+00 -7.85267560e-01 -7.85267560e-01
 -7.85267560e-01  2.62435189e+00  2.62435189e+00  2.62435189e+00
  2.72043824e+00  1.98255039e+01  1.98255039e+01  1.98255039e+01
  4.40363563e+01  3.19360331e+02  1.98471725e+03  7.27381598e+03]
E1 = -182.46312411596395  E_coul = 54.266039670884176
cycle= 4 E= -128.19708444508  delta_E= -4.35e-08  |g|= 4.8e-05  |ddm|= 0.000282
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.6521e-05
diis-c [-2.12017075e-10  4.65914580e-04 -1.17724817e-03 -1.64609277e-01
  1.16532061e+00]
  HOMO = -0.785253840081022  LUMO = 2.62436381486116
  mo_energy =
[-3.27123220e+01 -1.89746874e+00 -7.85253840e-01 -7.85253840e-01
 -7.85253840e-01  2.62436381e+00  2.62436381e+00  2.62436381e+00
  2.72043972e+00  1.98255314e+01  1.98255314e+01  1.98255314e+01
  4.40363849e+01  3.19360379e+02  1.98471732e+03  7.27381605e+03]
E1 = -182.46306468840126  E_coul = 54.2659802430596
cycle= 5 E= -128.197084445342  delta_E= -2.62e-10  |g|= 1.62e-06  |ddm|= 2.41e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46306468840126  E_coul = 54.2659802430596
  HOMO = -0.785253735584227  LUMO = 2.62436391628022
  mo_energy =
[-3.27123219e+01 -1.89746904e+00 -7.85253736e-01 -7.85253736e-01
 -7.85253736e-01  2.62436392e+00  2.62436392e+00  2.62436392e+00
  2.72043946e+00  1.98255315e+01  1.98255315e+01  1.98255315e+01
  4.40363849e+01  3.19360379e+02  1.98471732e+03  7.27381605e+03]
E1 = -182.46306448694017  E_coul = 54.265980041598226
Extra cycle  E= -128.197084445342  delta_E= -2.84e-13  |g|= 3.01e-07  |ddm|= 9.34e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.44385132312885
E1 = -182.46306448694017  E_coul = 54.265980041598226
init E= -128.197084445342
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785253733145219  LUMO = 2.6243639168279
  mo_energy =
[-3.27123219e+01 -1.89746911e+00 -7.85253733e-01 -7.85253733e-01
 -7.85253733e-01  2.62436392e+00  2.62436392e+00  2.62436392e+00
  2.72043940e+00  1.98255315e+01  1.98255315e+01  1.98255315e+01
  4.40363849e+01  3.19360379e+02  1.98471732e+03  7.27381605e+03]
E1 = -182.4630645759906  E_coul = 54.26598013064875
cycle= 1 E= -128.197084445342  delta_E= 1.14e-13  |g|= 5.47e-08  |ddm|= 1.74e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4630645759906  E_coul = 54.26598013064875
  HOMO = -0.785253723995511  LUMO = 2.62436392483031
  mo_energy =
[-3.27123219e+01 -1.89746911e+00 -7.85253724e-01 -7.85253724e-01
 -7.85253724e-01  2.62436392e+00  2.62436392e+00  2.62436392e+00
  2.72043939e+00  1.98255315e+01  1.98255315e+01  1.98255315e+01
  4.40363849e+01  3.19360379e+02  1.98471732e+03  7.27381605e+03]
E1 = -182.46306454289933  E_coul = 54.26598009755762
Extra cycle  E= -128.197084445342  delta_E= 1.14e-13  |g|= 1.12e-08  |ddm|= 2.92e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419250e+03 2.15500363e+02 1.42945512e+03 5.73625824e-01
 4.83799641e+01 1.30601978e+01 1.92677264e+00 2.77754714e+00
 1.33317788e+01 6.00584235e-01]
grad_E = [-7.53106516e-06 -2.93220817e-04  4.57087673e-05  3.77300636e-04
  2.74412129e-04  5.70382125e-04  8.93908693e-04 -8.91256286e-05
  7.41597961e-06  4.88315536e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19256631        1
[INPUT] 0    0    [1    /1   ]  215.503148744        1
[INPUT] 0    0    [1    /1   ]  1429.45470726        1
[INPUT] 0    0    [1    /1   ]  0.573752091073       1
[INPUT] 0    0    [1    /1   ]  48.3766105454        1
[INPUT] 0    0    [1    /1   ]  13.0546874259        1
[INPUT] 0    0    [1    /1   ]  1.92840802137        1
[INPUT] 1    0    [1    /1   ]  2.77773532971        1
[INPUT] 1    0    [1    /1   ]  13.3317456786        1
[INPUT] 1    0    [1    /1   ]  0.600615321219       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.192566314992, 1.0]], [0, [215.5031487437229, 1.0]], [0, [1429.454707258504, 1.0]], [0, [0.5737520910726313, 1.0]], [0, [48.37661054540937, 1.0]], [0, [13.05468742587466, 1.0]], [0, [1.9284080213722827, 1.0]], [1, [2.777735329714587, 1.0]], [1, [13.331745678584241, 1.0]], [1, [0.6006153212193671, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19256631]
bas 1, expnt(s) = [215.50314874]
bas 2, expnt(s) = [1429.45470726]
bas 3, expnt(s) = [0.57375209]
bas 4, expnt(s) = [48.37661055]
bas 5, expnt(s) = [13.05468743]
bas 6, expnt(s) = [1.92840802]
bas 7, expnt(s) = [2.77773533]
bas 8, expnt(s) = [13.33174568]
bas 9, expnt(s) = [0.60061532]
CPU time:        30.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419257e+03 7.96091274e+02 2.15503149e+02 1.42103652e+02
 1.42945471e+03 5.87344388e+02 5.73752091e-01 1.66555215e+00
 4.83766105e+01 4.63437958e+01 1.30546874e+01 1.73516142e+01
 1.92840802e+00 4.13441646e+00 2.77773533e+00 1.04615966e+01
 1.33317457e+01 7.43178553e+01 6.00615321e-01 1.54251679e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96567169406632
cond(S) = 156.44364881722367
E1 = -183.13618321280558  E_coul = 55.01155093521197
init E= -128.124632277594
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742871583447794  LUMO = 2.6582069535589
  mo_energy =
[-3.25130366e+01 -1.85363015e+00 -7.42871583e-01 -7.42871583e-01
 -7.42871583e-01  2.65820695e+00  2.65820695e+00  2.65820695e+00
  2.75640716e+00  1.99612037e+01  1.99612037e+01  1.99612037e+01
  4.41974193e+01  3.19566705e+02  1.98497343e+03  7.27409817e+03]
E1 = -182.13163328787152  E_coul = 53.936483638772444
cycle= 1 E= -128.195149649099  delta_E= -0.0705  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261779
diis-c [-0.06852846  1.        ]
  HOMO = -0.807801687945262  LUMO = 2.60410408763717
  mo_energy =
[-3.27865120e+01 -1.92076837e+00 -8.07801688e-01 -8.07801688e-01
 -8.07801688e-01  2.60410409e+00  2.60410409e+00  2.60410409e+00
  2.70280464e+00  1.97704869e+01  1.97704869e+01  1.97704869e+01
  4.39637291e+01  3.19257468e+02  1.98461346e+03  7.27371278e+03]
E1 = -182.59390282804034  E_coul = 54.397120735252344
cycle= 2 E= -128.196782092788  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101895
diis-c [-4.53475395e-04  2.76364329e-01  7.23635671e-01]
  HOMO = -0.785003906072165  LUMO = 2.62475535933768
  mo_energy =
[-3.27116188e+01 -1.89711172e+00 -7.85003906e-01 -7.85003906e-01
 -7.85003906e-01  2.62475536e+00  2.62475536e+00  2.62475536e+00
  2.72294890e+00  1.98267371e+01  1.98267371e+01  1.98267371e+01
  4.40295694e+01  3.19339154e+02  1.98470078e+03  7.27380161e+03]
E1 = -182.46148163467734  E_coul = 54.26439459908692
cycle= 3 E= -128.19708703559  delta_E= -0.000305  |g|= 0.00079  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00105742
diis-c [-6.91962110e-08 -3.62029097e-03  8.10213687e-04  1.00281008e+00]
  HOMO = -0.785277618927269  LUMO = 2.6245419036806
  mo_energy =
[-3.27124134e+01 -1.89745171e+00 -7.85277619e-01 -7.85277619e-01
 -7.85277619e-01  2.62454190e+00  2.62454190e+00  2.62454190e+00
  2.72267960e+00  1.98261191e+01  1.98261191e+01  1.98261191e+01
  4.40288324e+01  3.19338499e+02  1.98470025e+03  7.27380111e+03]
E1 = -182.4629936391384  E_coul = 54.265906560010954
cycle= 4 E= -128.197087079127  delta_E= -4.35e-08  |g|= 4.73e-05  |ddm|= 0.000281
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.55217e-05
diis-c [-2.08124986e-10  4.62904133e-04 -1.17806628e-03 -1.64082515e-01
  1.16479768e+00]
  HOMO = -0.78526408519762  LUMO = 2.62455367211915
  mo_energy =
[-3.27123784e+01 -1.89744917e+00 -7.85264085e-01 -7.85264085e-01
 -7.85264085e-01  2.62455367e+00  2.62455367e+00  2.62455367e+00
  2.72268107e+00  1.98261462e+01  1.98261462e+01  1.98261462e+01
  4.40288606e+01  3.19338547e+02  1.98470032e+03  7.27380118e+03]
E1 = -182.46293497987992  E_coul = 54.26584790049801
cycle= 5 E= -128.197087079382  delta_E= -2.54e-10  |g|= 1.61e-06  |ddm|= 2.37e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46293497987992  E_coul = 54.26584790049801
  HOMO = -0.785263976369892  LUMO = 2.62455377728871
  mo_energy =
[-3.27123782e+01 -1.89744947e+00 -7.85263976e-01 -7.85263976e-01
 -7.85263976e-01  2.62455378e+00  2.62455378e+00  2.62455378e+00
  2.72268081e+00  1.98261463e+01  1.98261463e+01  1.98261463e+01
  4.40288607e+01  3.19338548e+02  1.98470032e+03  7.27380118e+03]
E1 = -182.46293475435957  E_coul = 54.265847674977266
Extra cycle  E= -128.197087079382  delta_E= -3.98e-13  |g|= 3.01e-07  |ddm|= 9.29e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419257e+03 2.15503149e+02 1.42945471e+03 5.73752091e-01
 4.83766105e+01 1.30546874e+01 1.92840802e+00 2.77773533e+00
 1.33317457e+01 6.00615321e-01]
E = -128.1970870793823
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19256631        1
[INPUT] 0    0    [1    /1   ]  215.503148744        1
[INPUT] 0    0    [1    /1   ]  1429.45470726        1
[INPUT] 0    0    [1    /1   ]  0.573752091073       1
[INPUT] 0    0    [1    /1   ]  48.3766105454        1
[INPUT] 0    0    [1    /1   ]  13.0546874259        1
[INPUT] 0    0    [1    /1   ]  1.92840802137        1
[INPUT] 1    0    [1    /1   ]  2.77773532971        1
[INPUT] 1    0    [1    /1   ]  13.3317456786        1
[INPUT] 1    0    [1    /1   ]  0.600615321219       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.192566314992, 1.0]], [0, [215.5031487437229, 1.0]], [0, [1429.454707258504, 1.0]], [0, [0.5737520910726313, 1.0]], [0, [48.37661054540937, 1.0]], [0, [13.05468742587466, 1.0]], [0, [1.9284080213722827, 1.0]], [1, [2.777735329714587, 1.0]], [1, [13.331745678584241, 1.0]], [1, [0.6006153212193671, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19256631]
bas 1, expnt(s) = [215.50314874]
bas 2, expnt(s) = [1429.45470726]
bas 3, expnt(s) = [0.57375209]
bas 4, expnt(s) = [48.37661055]
bas 5, expnt(s) = [13.05468743]
bas 6, expnt(s) = [1.92840802]
bas 7, expnt(s) = [2.77773533]
bas 8, expnt(s) = [13.33174568]
bas 9, expnt(s) = [0.60061532]
CPU time:        30.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419257e+03 7.96091274e+02 2.15503149e+02 1.42103652e+02
 1.42945471e+03 5.87344388e+02 5.73752091e-01 1.66555215e+00
 4.83766105e+01 4.63437958e+01 1.30546874e+01 1.73516142e+01
 1.92840802e+00 4.13441646e+00 2.77773533e+00 1.04615966e+01
 1.33317457e+01 7.43178553e+01 6.00615321e-01 1.54251679e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96567169406632
cond(S) = 156.44364881722367
E1 = -183.13618321280558  E_coul = 55.01155093521197
init E= -128.124632277594
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742871583447794  LUMO = 2.6582069535589
  mo_energy =
[-3.25130366e+01 -1.85363015e+00 -7.42871583e-01 -7.42871583e-01
 -7.42871583e-01  2.65820695e+00  2.65820695e+00  2.65820695e+00
  2.75640716e+00  1.99612037e+01  1.99612037e+01  1.99612037e+01
  4.41974193e+01  3.19566705e+02  1.98497343e+03  7.27409817e+03]
E1 = -182.13163328787152  E_coul = 53.936483638772444
cycle= 1 E= -128.195149649099  delta_E= -0.0705  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261779
diis-c [-0.06852846  1.        ]
  HOMO = -0.807801687945262  LUMO = 2.60410408763717
  mo_energy =
[-3.27865120e+01 -1.92076837e+00 -8.07801688e-01 -8.07801688e-01
 -8.07801688e-01  2.60410409e+00  2.60410409e+00  2.60410409e+00
  2.70280464e+00  1.97704869e+01  1.97704869e+01  1.97704869e+01
  4.39637291e+01  3.19257468e+02  1.98461346e+03  7.27371278e+03]
E1 = -182.59390282804034  E_coul = 54.397120735252344
cycle= 2 E= -128.196782092788  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101895
diis-c [-4.53475395e-04  2.76364329e-01  7.23635671e-01]
  HOMO = -0.785003906072165  LUMO = 2.62475535933768
  mo_energy =
[-3.27116188e+01 -1.89711172e+00 -7.85003906e-01 -7.85003906e-01
 -7.85003906e-01  2.62475536e+00  2.62475536e+00  2.62475536e+00
  2.72294890e+00  1.98267371e+01  1.98267371e+01  1.98267371e+01
  4.40295694e+01  3.19339154e+02  1.98470078e+03  7.27380161e+03]
E1 = -182.46148163467734  E_coul = 54.26439459908692
cycle= 3 E= -128.19708703559  delta_E= -0.000305  |g|= 0.00079  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00105742
diis-c [-6.91962110e-08 -3.62029097e-03  8.10213687e-04  1.00281008e+00]
  HOMO = -0.785277618927269  LUMO = 2.6245419036806
  mo_energy =
[-3.27124134e+01 -1.89745171e+00 -7.85277619e-01 -7.85277619e-01
 -7.85277619e-01  2.62454190e+00  2.62454190e+00  2.62454190e+00
  2.72267960e+00  1.98261191e+01  1.98261191e+01  1.98261191e+01
  4.40288324e+01  3.19338499e+02  1.98470025e+03  7.27380111e+03]
E1 = -182.4629936391384  E_coul = 54.265906560010954
cycle= 4 E= -128.197087079127  delta_E= -4.35e-08  |g|= 4.73e-05  |ddm|= 0.000281
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.55217e-05
diis-c [-2.08124986e-10  4.62904133e-04 -1.17806628e-03 -1.64082515e-01
  1.16479768e+00]
  HOMO = -0.78526408519762  LUMO = 2.62455367211915
  mo_energy =
[-3.27123784e+01 -1.89744917e+00 -7.85264085e-01 -7.85264085e-01
 -7.85264085e-01  2.62455367e+00  2.62455367e+00  2.62455367e+00
  2.72268107e+00  1.98261462e+01  1.98261462e+01  1.98261462e+01
  4.40288606e+01  3.19338547e+02  1.98470032e+03  7.27380118e+03]
E1 = -182.46293497987992  E_coul = 54.26584790049801
cycle= 5 E= -128.197087079382  delta_E= -2.54e-10  |g|= 1.61e-06  |ddm|= 2.37e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46293497987992  E_coul = 54.26584790049801
  HOMO = -0.785263976369892  LUMO = 2.62455377728871
  mo_energy =
[-3.27123782e+01 -1.89744947e+00 -7.85263976e-01 -7.85263976e-01
 -7.85263976e-01  2.62455378e+00  2.62455378e+00  2.62455378e+00
  2.72268081e+00  1.98261463e+01  1.98261463e+01  1.98261463e+01
  4.40288607e+01  3.19338548e+02  1.98470032e+03  7.27380118e+03]
E1 = -182.46293475435957  E_coul = 54.265847674977266
Extra cycle  E= -128.197087079382  delta_E= -3.98e-13  |g|= 3.01e-07  |ddm|= 9.29e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.44364881722367
E1 = -182.46293475435957  E_coul = 54.265847674977266
init E= -128.197087079382
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785263975636881  LUMO = 2.62455377630045
  mo_energy =
[-3.27123782e+01 -1.89744954e+00 -7.85263976e-01 -7.85263976e-01
 -7.85263976e-01  2.62455378e+00  2.62455378e+00  2.62455378e+00
  2.72268075e+00  1.98261463e+01  1.98261463e+01  1.98261463e+01
  4.40288606e+01  3.19338548e+02  1.98470032e+03  7.27380118e+03]
E1 = -182.46293485287  E_coul = 54.26584777348759
cycle= 1 E= -128.197087079382  delta_E= -1.14e-13  |g|= 5.47e-08  |ddm|= 1.74e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46293485287  E_coul = 54.26584777348759
  HOMO = -0.785263965854844  LUMO = 2.62455378487742
  mo_energy =
[-3.27123782e+01 -1.89744954e+00 -7.85263966e-01 -7.85263966e-01
 -7.85263966e-01  2.62455378e+00  2.62455378e+00  2.62455378e+00
  2.72268074e+00  1.98261463e+01  1.98261463e+01  1.98261463e+01
  4.40288606e+01  3.19338548e+02  1.98470032e+03  7.27380118e+03]
E1 = -182.46293481599335  E_coul = 54.265847736611086
Extra cycle  E= -128.197087079382  delta_E= 1.42e-13  |g|= 1.14e-08  |ddm|= 2.89e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419257e+03 2.15503149e+02 1.42945471e+03 5.73752091e-01
 4.83766105e+01 1.30546874e+01 1.92840802e+00 2.77773533e+00
 1.33317457e+01 6.00615321e-01]
grad_E = [-7.52810993e-06 -2.95751522e-04  4.57258607e-05  8.56627769e-05
  3.25647939e-04  3.23802785e-04  1.12835911e-03  1.47333565e-05
 -5.65674017e-06 -5.93908641e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19267879        1
[INPUT] 0    0    [1    /1   ]  215.507764685        1
[INPUT] 0    0    [1    /1   ]  1429.45401914        1
[INPUT] 0    0    [1    /1   ]  0.57355864683        1
[INPUT] 0    0    [1    /1   ]  48.3708018378        1
[INPUT] 0    0    [1    /1   ]  13.0472521749        1
[INPUT] 0    0    [1    /1   ]  1.92875453329        1
[INPUT] 1    0    [1    /1   ]  2.77800581633        1
[INPUT] 1    0    [1    /1   ]  13.3317062408        1
[INPUT] 1    0    [1    /1   ]  0.600661738568       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.192678788568, 1.0]], [0, [215.50776468471395, 1.0]], [0, [1429.4540191352771, 1.0]], [0, [0.5735586468304832, 1.0]], [0, [48.37080183782716, 1.0]], [0, [13.047252174933993, 1.0]], [0, [1.9287545332920635, 1.0]], [1, [2.7780058163297188, 1.0]], [1, [13.331706240782776, 1.0]], [1, [0.600661738568335, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19267879]
bas 1, expnt(s) = [215.50776468]
bas 2, expnt(s) = [1429.45401914]
bas 3, expnt(s) = [0.57355865]
bas 4, expnt(s) = [48.37080184]
bas 5, expnt(s) = [13.04725217]
bas 6, expnt(s) = [1.92875453]
bas 7, expnt(s) = [2.77800582]
bas 8, expnt(s) = [13.33170624]
bas 9, expnt(s) = [0.60066174]
CPU time:        32.52
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419268e+03 7.96091306e+02 2.15507765e+02 1.42105935e+02
 1.42945402e+03 5.87344176e+02 5.73558647e-01 1.66513097e+00
 4.83708018e+01 4.63396223e+01 1.30472522e+01 1.73442017e+01
 1.92875453e+00 4.13497363e+00 2.77800582e+00 1.04628700e+01
 1.33317062e+01 7.43175805e+01 6.00661739e-01 1.54266581e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965666733783769
cond(S) = 156.43350773132195
E1 = -183.1362388525588  E_coul = 55.01156735668785
init E= -128.124671495871
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742871736680359  LUMO = 2.65850442058861
  mo_energy =
[-3.25130354e+01 -1.85362670e+00 -7.42871737e-01 -7.42871737e-01
 -7.42871737e-01  2.65850442e+00  2.65850442e+00  2.65850442e+00
  2.75590668e+00  1.99621517e+01  1.99621517e+01  1.99621517e+01
  4.41772131e+01  3.19526749e+02  1.98494252e+03  7.27407108e+03]
E1 = -182.13135286399245  E_coul = 53.936199782220946
cycle= 1 E= -128.195153081772  delta_E= -0.0705  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261895
diis-c [-0.06858889  1.        ]
  HOMO = -0.807822600719664  LUMO = 2.604375765173
  mo_energy =
[-3.27865960e+01 -1.92076600e+00 -8.07822601e-01 -8.07822601e-01
 -8.07822601e-01  2.60437577e+00  2.60437577e+00  2.60437577e+00
  2.70230987e+00  1.97713682e+01  1.97713682e+01  1.97713682e+01
  4.39434765e+01  3.19217327e+02  1.98458232e+03  7.27368545e+03]
E1 = -182.59373060591295  E_coul = 54.39694432284305
cycle= 2 E= -128.19678628307  delta_E= -0.00163  |g|= 0.0626  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10192
diis-c [-4.52393107e-04  2.76335498e-01  7.23664502e-01]
  HOMO = -0.785018884133167  LUMO = 2.62503432372602
  mo_energy =
[-3.27116818e+01 -1.89710242e+00 -7.85018884e-01 -7.85018884e-01
 -7.85018884e-01  2.62503432e+00  2.62503432e+00  2.62503432e+00
  2.72245860e+00  1.98276337e+01  1.98276337e+01  1.98276337e+01
  4.40093293e+01  3.19299032e+02  1.98466966e+03  7.27377430e+03]
E1 = -182.46127157049216  E_coul = 54.264180189912196
cycle= 3 E= -128.19709138058  delta_E= -0.000305  |g|= 0.000791  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106233
diis-c [-6.70603697e-08 -3.59693991e-03  9.28670895e-04  1.00266827e+00]
  HOMO = -0.785293790070422  LUMO = 2.62481980214844
  mo_energy =
[-3.27124793e+01 -1.89744249e+00 -7.85293790e-01 -7.85293790e-01
 -7.85293790e-01  2.62481980e+00  2.62481980e+00  2.62481980e+00
  2.72218928e+00  1.98270134e+01  1.98270134e+01  1.98270134e+01
  4.40085901e+01  3.19298373e+02  1.98466912e+03  7.27377379e+03]
E1 = -182.46278826445607  E_coul = 54.26569684028366
cycle= 4 E= -128.197091424172  delta_E= -4.36e-08  |g|= 4.65e-05  |ddm|= 0.00028
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.4191e-05
diis-c [-2.03723666e-10  4.58990492e-04 -1.17757148e-03 -1.63345492e-01
  1.16406407e+00]
  HOMO = -0.785280495611974  LUMO = 2.62483136346366
  mo_energy =
[-3.27124449e+01 -1.89743997e+00 -7.85280496e-01 -7.85280496e-01
 -7.85280496e-01  2.62483136e+00  2.62483136e+00  2.62483136e+00
  2.72219074e+00  1.98270400e+01  1.98270400e+01  1.98270400e+01
  4.40086178e+01  3.19298420e+02  1.98466919e+03  7.27377386e+03]
E1 = -182.4627306265937  E_coul = 54.26563920217623
cycle= 5 E= -128.197091424417  delta_E= -2.45e-10  |g|= 1.6e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4627306265937  E_coul = 54.26563920217623
  HOMO = -0.785280380705711  LUMO = 2.62483147392093
  mo_energy =
[-3.27124447e+01 -1.89744026e+00 -7.85280381e-01 -7.85280381e-01
 -7.85280381e-01  2.62483147e+00  2.62483147e+00  2.62483147e+00
  2.72219049e+00  1.98270402e+01  1.98270402e+01  1.98270402e+01
  4.40086179e+01  3.19298421e+02  1.98466919e+03  7.27377386e+03]
E1 = -182.46273036944984  E_coul = 54.26563894503191
Extra cycle  E= -128.197091424418  delta_E= -4.55e-13  |g|= 3.01e-07  |ddm|= 9.24e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419268e+03 2.15507765e+02 1.42945402e+03 5.73558647e-01
 4.83708018e+01 1.30472522e+01 1.92875453e+00 2.77800582e+00
 1.33317062e+01 6.00661739e-01]
E = -128.19709142441792
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19267879        1
[INPUT] 0    0    [1    /1   ]  215.507764685        1
[INPUT] 0    0    [1    /1   ]  1429.45401914        1
[INPUT] 0    0    [1    /1   ]  0.57355864683        1
[INPUT] 0    0    [1    /1   ]  48.3708018378        1
[INPUT] 0    0    [1    /1   ]  13.0472521749        1
[INPUT] 0    0    [1    /1   ]  1.92875453329        1
[INPUT] 1    0    [1    /1   ]  2.77800581633        1
[INPUT] 1    0    [1    /1   ]  13.3317062408        1
[INPUT] 1    0    [1    /1   ]  0.600661738568       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.192678788568, 1.0]], [0, [215.50776468471395, 1.0]], [0, [1429.4540191352771, 1.0]], [0, [0.5735586468304832, 1.0]], [0, [48.37080183782716, 1.0]], [0, [13.047252174933993, 1.0]], [0, [1.9287545332920635, 1.0]], [1, [2.7780058163297188, 1.0]], [1, [13.331706240782776, 1.0]], [1, [0.600661738568335, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19267879]
bas 1, expnt(s) = [215.50776468]
bas 2, expnt(s) = [1429.45401914]
bas 3, expnt(s) = [0.57355865]
bas 4, expnt(s) = [48.37080184]
bas 5, expnt(s) = [13.04725217]
bas 6, expnt(s) = [1.92875453]
bas 7, expnt(s) = [2.77800582]
bas 8, expnt(s) = [13.33170624]
bas 9, expnt(s) = [0.60066174]
CPU time:        32.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419268e+03 7.96091306e+02 2.15507765e+02 1.42105935e+02
 1.42945402e+03 5.87344176e+02 5.73558647e-01 1.66513097e+00
 4.83708018e+01 4.63396223e+01 1.30472522e+01 1.73442017e+01
 1.92875453e+00 4.13497363e+00 2.77800582e+00 1.04628700e+01
 1.33317062e+01 7.43175805e+01 6.00661739e-01 1.54266581e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965666733783769
cond(S) = 156.43350773132195
E1 = -183.1362388525588  E_coul = 55.01156735668785
init E= -128.124671495871
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742871736680359  LUMO = 2.65850442058861
  mo_energy =
[-3.25130354e+01 -1.85362670e+00 -7.42871737e-01 -7.42871737e-01
 -7.42871737e-01  2.65850442e+00  2.65850442e+00  2.65850442e+00
  2.75590668e+00  1.99621517e+01  1.99621517e+01  1.99621517e+01
  4.41772131e+01  3.19526749e+02  1.98494252e+03  7.27407108e+03]
E1 = -182.13135286399245  E_coul = 53.936199782220946
cycle= 1 E= -128.195153081772  delta_E= -0.0705  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261895
diis-c [-0.06858889  1.        ]
  HOMO = -0.807822600719664  LUMO = 2.604375765173
  mo_energy =
[-3.27865960e+01 -1.92076600e+00 -8.07822601e-01 -8.07822601e-01
 -8.07822601e-01  2.60437577e+00  2.60437577e+00  2.60437577e+00
  2.70230987e+00  1.97713682e+01  1.97713682e+01  1.97713682e+01
  4.39434765e+01  3.19217327e+02  1.98458232e+03  7.27368545e+03]
E1 = -182.59373060591295  E_coul = 54.39694432284305
cycle= 2 E= -128.19678628307  delta_E= -0.00163  |g|= 0.0626  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10192
diis-c [-4.52393107e-04  2.76335498e-01  7.23664502e-01]
  HOMO = -0.785018884133167  LUMO = 2.62503432372602
  mo_energy =
[-3.27116818e+01 -1.89710242e+00 -7.85018884e-01 -7.85018884e-01
 -7.85018884e-01  2.62503432e+00  2.62503432e+00  2.62503432e+00
  2.72245860e+00  1.98276337e+01  1.98276337e+01  1.98276337e+01
  4.40093293e+01  3.19299032e+02  1.98466966e+03  7.27377430e+03]
E1 = -182.46127157049216  E_coul = 54.264180189912196
cycle= 3 E= -128.19709138058  delta_E= -0.000305  |g|= 0.000791  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00106233
diis-c [-6.70603697e-08 -3.59693991e-03  9.28670895e-04  1.00266827e+00]
  HOMO = -0.785293790070422  LUMO = 2.62481980214844
  mo_energy =
[-3.27124793e+01 -1.89744249e+00 -7.85293790e-01 -7.85293790e-01
 -7.85293790e-01  2.62481980e+00  2.62481980e+00  2.62481980e+00
  2.72218928e+00  1.98270134e+01  1.98270134e+01  1.98270134e+01
  4.40085901e+01  3.19298373e+02  1.98466912e+03  7.27377379e+03]
E1 = -182.46278826445607  E_coul = 54.26569684028366
cycle= 4 E= -128.197091424172  delta_E= -4.36e-08  |g|= 4.65e-05  |ddm|= 0.00028
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.4191e-05
diis-c [-2.03723666e-10  4.58990492e-04 -1.17757148e-03 -1.63345492e-01
  1.16406407e+00]
  HOMO = -0.785280495611974  LUMO = 2.62483136346366
  mo_energy =
[-3.27124449e+01 -1.89743997e+00 -7.85280496e-01 -7.85280496e-01
 -7.85280496e-01  2.62483136e+00  2.62483136e+00  2.62483136e+00
  2.72219074e+00  1.98270400e+01  1.98270400e+01  1.98270400e+01
  4.40086178e+01  3.19298420e+02  1.98466919e+03  7.27377386e+03]
E1 = -182.4627306265937  E_coul = 54.26563920217623
cycle= 5 E= -128.197091424417  delta_E= -2.45e-10  |g|= 1.6e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4627306265937  E_coul = 54.26563920217623
  HOMO = -0.785280380705711  LUMO = 2.62483147392093
  mo_energy =
[-3.27124447e+01 -1.89744026e+00 -7.85280381e-01 -7.85280381e-01
 -7.85280381e-01  2.62483147e+00  2.62483147e+00  2.62483147e+00
  2.72219049e+00  1.98270402e+01  1.98270402e+01  1.98270402e+01
  4.40086179e+01  3.19298421e+02  1.98466919e+03  7.27377386e+03]
E1 = -182.46273036944984  E_coul = 54.26563894503191
Extra cycle  E= -128.197091424418  delta_E= -4.55e-13  |g|= 3.01e-07  |ddm|= 9.24e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.43350773132195
E1 = -182.46273036944984  E_coul = 54.26563894503191
init E= -128.197091424418
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785280382170826  LUMO = 2.62483147094981
  mo_energy =
[-3.27124448e+01 -1.89744033e+00 -7.85280382e-01 -7.85280382e-01
 -7.85280382e-01  2.62483147e+00  2.62483147e+00  2.62483147e+00
  2.72219043e+00  1.98270401e+01  1.98270401e+01  1.98270401e+01
  4.40086178e+01  3.19298421e+02  1.98466919e+03  7.27377386e+03]
E1 = -182.46273048063287  E_coul = 54.265639056214845
cycle= 1 E= -128.197091424418  delta_E= -1.14e-13  |g|= 5.48e-08  |ddm|= 1.74e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46273048063287  E_coul = 54.265639056214845
  HOMO = -0.785280371532067  LUMO = 2.62483148030456
  mo_energy =
[-3.27124447e+01 -1.89744033e+00 -7.85280372e-01 -7.85280372e-01
 -7.85280372e-01  2.62483148e+00  2.62483148e+00  2.62483148e+00
  2.72219042e+00  1.98270401e+01  1.98270401e+01  1.98270401e+01
  4.40086178e+01  3.19298421e+02  1.98466919e+03  7.27377386e+03]
E1 = -182.4627304387297  E_coul = 54.26563901431151
Extra cycle  E= -128.197091424418  delta_E= -1.42e-13  |g|= 1.18e-08  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14419268e+03 2.15507765e+02 1.42945402e+03 5.73558647e-01
 4.83708018e+01 1.30472522e+01 1.92875453e+00 2.77800582e+00
 1.33317062e+01 6.00661739e-01]
grad_E = [-7.52575626e-06 -2.98305009e-04  4.57398602e-05 -2.48613020e-04
  3.84657731e-04  3.62554625e-05  1.32597155e-03  1.62202959e-04
 -2.44477305e-05 -1.77061932e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.1928953         1
[INPUT] 0    0    [1    /1   ]  215.516739757        1
[INPUT] 0    0    [1    /1   ]  1429.45269283        1
[INPUT] 0    0    [1    /1   ]  0.573087132622       1
[INPUT] 0    0    [1    /1   ]  48.3584463163        1
[INPUT] 0    0    [1    /1   ]  13.0374351045        1
[INPUT] 0    0    [1    /1   ]  1.9279320396         1
[INPUT] 1    0    [1    /1   ]  2.77833785006        1
[INPUT] 1    0    [1    /1   ]  13.3316617035        1
[INPUT] 1    0    [1    /1   ]  0.600720285784       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.192895300617, 1.0]], [0, [215.51673975672153, 1.0]], [0, [1429.4526928339835, 1.0]], [0, [0.5730871326222066, 1.0]], [0, [48.35844631629429, 1.0]], [0, [13.037435104470374, 1.0]], [0, [1.9279320396035937, 1.0]], [1, [2.778337850058144, 1.0]], [1, [13.331661703483476, 1.0]], [1, [0.6007202857835392, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.1928953]
bas 1, expnt(s) = [215.51673976]
bas 2, expnt(s) = [1429.45269283]
bas 3, expnt(s) = [0.57308713]
bas 4, expnt(s) = [48.35844632]
bas 5, expnt(s) = [13.0374351]
bas 6, expnt(s) = [1.92793204]
bas 7, expnt(s) = [2.77833785]
bas 8, expnt(s) = [13.3316617]
bas 9, expnt(s) = [0.60072029]
CPU time:        34.87
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419290e+03 7.96091366e+02 2.15516740e+02 1.42110373e+02
 1.42945269e+03 5.87343767e+02 5.73087133e-01 1.66410420e+00
 4.83584463e+01 4.63307445e+01 1.30374351e+01 1.73344132e+01
 1.92793204e+00 4.13365108e+00 2.77833785e+00 1.04644332e+01
 1.33316617e+01 7.43172701e+01 6.00720286e-01 1.54285377e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965664370941631
cond(S) = 156.4125023553803
E1 = -183.13630173342335  E_coul = 55.011570285868316
init E= -128.124731447555
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742872135994925  LUMO = 2.65887501345531
  mo_energy =
[-3.25130300e+01 -1.85363522e+00 -7.42872136e-01 -7.42872136e-01
 -7.42872136e-01  2.65887501e+00  2.65887501e+00  2.65887501e+00
  2.75292737e+00  1.99633180e+01  1.99633180e+01  1.99633180e+01
  4.41417433e+01  3.19457693e+02  1.98488960e+03  7.27402504e+03]
E1 = -182.1310082412572  E_coul = 53.9358485652926
cycle= 1 E= -128.195159675965  delta_E= -0.0704  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262015
diis-c [-0.06865207  1.        ]
  HOMO = -0.807848534259576  LUMO = 2.60471453571884
  mo_energy =
[-3.27866900e+01 -1.92077377e+00 -8.07848534e-01 -8.07848534e-01
 -8.07848534e-01  2.60471454e+00  2.60471454e+00  2.60471454e+00
  2.69938438e+00  1.97724588e+01  1.97724588e+01  1.97724588e+01
  4.39079670e+01  3.19148060e+02  1.98452914e+03  7.27363913e+03]
E1 = -182.59351209807417  E_coul = 54.39671841007825
cycle= 2 E= -128.196793687996  delta_E= -0.00163  |g|= 0.0626  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101947
diis-c [-4.51037483e-04  2.76309497e-01  7.23690503e-01]
  HOMO = -0.785037738878638  LUMO = 2.62538180439589
  mo_energy =
[-3.27117533e+01 -1.89710249e+00 -7.85037739e-01 -7.85037739e-01
 -7.85037739e-01  2.62538180e+00  2.62538180e+00  2.62538180e+00
  2.71952502e+00  1.98287412e+01  1.98287412e+01  1.98287412e+01
  4.39738313e+01  3.19229786e+02  1.98461650e+03  7.27372799e+03]
E1 = -182.46100968105284  E_coul = 54.263910723860405
cycle= 3 E= -128.197098957192  delta_E= -0.000305  |g|= 0.000791  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010672
diis-c [-6.45781047e-08 -3.57103193e-03  1.05455094e-03  1.00251648e+00]
  HOMO = -0.785313816407522  LUMO = 2.62516623770404
  mo_energy =
[-3.27125536e+01 -1.89744241e+00 -7.85313816e-01 -7.85313816e-01
 -7.85313816e-01  2.62516624e+00  2.62516624e+00  2.62516624e+00
  2.71925607e+00  1.98281187e+01  1.98281187e+01  1.98281187e+01
  4.39730900e+01  3.19229122e+02  1.98461596e+03  7.27372748e+03]
E1 = -182.46253074863907  E_coul = 54.265431747842676
cycle= 4 E= -128.197099000796  delta_E= -4.36e-08  |g|= 4.55e-05  |ddm|= 0.000278
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.26471e-05
diis-c [-1.99169294e-10  4.54597965e-04 -1.17469864e-03 -1.62442057e-01
  1.16316216e+00]
  HOMO = -0.785300793687818  LUMO = 2.62517756365431
  mo_energy =
[-3.27125199e+01 -1.89743991e+00 -7.85300794e-01 -7.85300794e-01
 -7.85300794e-01  2.62517756e+00  2.62517756e+00  2.62517756e+00
  2.71925752e+00  1.98281448e+01  1.98281448e+01  1.98281448e+01
  4.39731171e+01  3.19229169e+02  1.98461602e+03  7.27372755e+03]
E1 = -182.46247429324185  E_coul = 54.26537529221089
cycle= 5 E= -128.197099001031  delta_E= -2.35e-10  |g|= 1.6e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46247429324185  E_coul = 54.26537529221089
  HOMO = -0.785300671593308  LUMO = 2.62517768040069
  mo_energy =
[-3.27125197e+01 -1.89744019e+00 -7.85300672e-01 -7.85300672e-01
 -7.85300672e-01  2.62517768e+00  2.62517768e+00  2.62517768e+00
  2.71925728e+00  1.98281449e+01  1.98281449e+01  1.98281449e+01
  4.39731172e+01  3.19229169e+02  1.98461602e+03  7.27372755e+03]
E1 = -182.46247400001852  E_coul = 54.265374998987305
Extra cycle  E= -128.197099001031  delta_E= -2.56e-13  |g|= 3.01e-07  |ddm|= 9.19e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419290e+03 2.15516740e+02 1.42945269e+03 5.73087133e-01
 4.83584463e+01 1.30374351e+01 1.92793204e+00 2.77833785e+00
 1.33316617e+01 6.00720286e-01]
E = -128.1970990010312
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.1928953         1
[INPUT] 0    0    [1    /1   ]  215.516739757        1
[INPUT] 0    0    [1    /1   ]  1429.45269283        1
[INPUT] 0    0    [1    /1   ]  0.573087132622       1
[INPUT] 0    0    [1    /1   ]  48.3584463163        1
[INPUT] 0    0    [1    /1   ]  13.0374351045        1
[INPUT] 0    0    [1    /1   ]  1.9279320396         1
[INPUT] 1    0    [1    /1   ]  2.77833785006        1
[INPUT] 1    0    [1    /1   ]  13.3316617035        1
[INPUT] 1    0    [1    /1   ]  0.600720285784       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.192895300617, 1.0]], [0, [215.51673975672153, 1.0]], [0, [1429.4526928339835, 1.0]], [0, [0.5730871326222066, 1.0]], [0, [48.35844631629429, 1.0]], [0, [13.037435104470374, 1.0]], [0, [1.9279320396035937, 1.0]], [1, [2.778337850058144, 1.0]], [1, [13.331661703483476, 1.0]], [1, [0.6007202857835392, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.1928953]
bas 1, expnt(s) = [215.51673976]
bas 2, expnt(s) = [1429.45269283]
bas 3, expnt(s) = [0.57308713]
bas 4, expnt(s) = [48.35844632]
bas 5, expnt(s) = [13.0374351]
bas 6, expnt(s) = [1.92793204]
bas 7, expnt(s) = [2.77833785]
bas 8, expnt(s) = [13.3316617]
bas 9, expnt(s) = [0.60072029]
CPU time:        35.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419290e+03 7.96091366e+02 2.15516740e+02 1.42110373e+02
 1.42945269e+03 5.87343767e+02 5.73087133e-01 1.66410420e+00
 4.83584463e+01 4.63307445e+01 1.30374351e+01 1.73344132e+01
 1.92793204e+00 4.13365108e+00 2.77833785e+00 1.04644332e+01
 1.33316617e+01 7.43172701e+01 6.00720286e-01 1.54285377e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965664370941631
cond(S) = 156.4125023553803
E1 = -183.13630173342335  E_coul = 55.011570285868316
init E= -128.124731447555
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742872135994925  LUMO = 2.65887501345531
  mo_energy =
[-3.25130300e+01 -1.85363522e+00 -7.42872136e-01 -7.42872136e-01
 -7.42872136e-01  2.65887501e+00  2.65887501e+00  2.65887501e+00
  2.75292737e+00  1.99633180e+01  1.99633180e+01  1.99633180e+01
  4.41417433e+01  3.19457693e+02  1.98488960e+03  7.27402504e+03]
E1 = -182.1310082412572  E_coul = 53.9358485652926
cycle= 1 E= -128.195159675965  delta_E= -0.0704  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262015
diis-c [-0.06865207  1.        ]
  HOMO = -0.807848534259576  LUMO = 2.60471453571884
  mo_energy =
[-3.27866900e+01 -1.92077377e+00 -8.07848534e-01 -8.07848534e-01
 -8.07848534e-01  2.60471454e+00  2.60471454e+00  2.60471454e+00
  2.69938438e+00  1.97724588e+01  1.97724588e+01  1.97724588e+01
  4.39079670e+01  3.19148060e+02  1.98452914e+03  7.27363913e+03]
E1 = -182.59351209807417  E_coul = 54.39671841007825
cycle= 2 E= -128.196793687996  delta_E= -0.00163  |g|= 0.0626  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101947
diis-c [-4.51037483e-04  2.76309497e-01  7.23690503e-01]
  HOMO = -0.785037738878638  LUMO = 2.62538180439589
  mo_energy =
[-3.27117533e+01 -1.89710249e+00 -7.85037739e-01 -7.85037739e-01
 -7.85037739e-01  2.62538180e+00  2.62538180e+00  2.62538180e+00
  2.71952502e+00  1.98287412e+01  1.98287412e+01  1.98287412e+01
  4.39738313e+01  3.19229786e+02  1.98461650e+03  7.27372799e+03]
E1 = -182.46100968105284  E_coul = 54.263910723860405
cycle= 3 E= -128.197098957192  delta_E= -0.000305  |g|= 0.000791  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010672
diis-c [-6.45781047e-08 -3.57103193e-03  1.05455094e-03  1.00251648e+00]
  HOMO = -0.785313816407522  LUMO = 2.62516623770404
  mo_energy =
[-3.27125536e+01 -1.89744241e+00 -7.85313816e-01 -7.85313816e-01
 -7.85313816e-01  2.62516624e+00  2.62516624e+00  2.62516624e+00
  2.71925607e+00  1.98281187e+01  1.98281187e+01  1.98281187e+01
  4.39730900e+01  3.19229122e+02  1.98461596e+03  7.27372748e+03]
E1 = -182.46253074863907  E_coul = 54.265431747842676
cycle= 4 E= -128.197099000796  delta_E= -4.36e-08  |g|= 4.55e-05  |ddm|= 0.000278
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.26471e-05
diis-c [-1.99169294e-10  4.54597965e-04 -1.17469864e-03 -1.62442057e-01
  1.16316216e+00]
  HOMO = -0.785300793687818  LUMO = 2.62517756365431
  mo_energy =
[-3.27125199e+01 -1.89743991e+00 -7.85300794e-01 -7.85300794e-01
 -7.85300794e-01  2.62517756e+00  2.62517756e+00  2.62517756e+00
  2.71925752e+00  1.98281448e+01  1.98281448e+01  1.98281448e+01
  4.39731171e+01  3.19229169e+02  1.98461602e+03  7.27372755e+03]
E1 = -182.46247429324185  E_coul = 54.26537529221089
cycle= 5 E= -128.197099001031  delta_E= -2.35e-10  |g|= 1.6e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46247429324185  E_coul = 54.26537529221089
  HOMO = -0.785300671593308  LUMO = 2.62517768040069
  mo_energy =
[-3.27125197e+01 -1.89744019e+00 -7.85300672e-01 -7.85300672e-01
 -7.85300672e-01  2.62517768e+00  2.62517768e+00  2.62517768e+00
  2.71925728e+00  1.98281449e+01  1.98281449e+01  1.98281449e+01
  4.39731172e+01  3.19229169e+02  1.98461602e+03  7.27372755e+03]
E1 = -182.46247400001852  E_coul = 54.265374998987305
Extra cycle  E= -128.197099001031  delta_E= -2.56e-13  |g|= 3.01e-07  |ddm|= 9.19e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.4125023553803
E1 = -182.46247400001852  E_coul = 54.265374998987305
init E= -128.197099001031
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785300675537399  LUMO = 2.62517767519058
  mo_energy =
[-3.27125197e+01 -1.89744027e+00 -7.85300676e-01 -7.85300676e-01
 -7.85300676e-01  2.62517768e+00  2.62517768e+00  2.62517768e+00
  2.71925721e+00  1.98281449e+01  1.98281449e+01  1.98281449e+01
  4.39731171e+01  3.19229169e+02  1.98461602e+03  7.27372755e+03]
E1 = -182.46247412582275  E_coul = 54.2653751247915
cycle= 1 E= -128.197099001031  delta_E= -5.68e-14  |g|= 5.5e-08  |ddm|= 1.74e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46247412582275  E_coul = 54.2653751247915
  HOMO = -0.785300663903855  LUMO = 2.62517768544813
  mo_energy =
[-3.27125197e+01 -1.89744027e+00 -7.85300664e-01 -7.85300664e-01
 -7.85300664e-01  2.62517769e+00  2.62517769e+00  2.62517769e+00
  2.71925721e+00  1.98281449e+01  1.98281449e+01  1.98281449e+01
  4.39731171e+01  3.19229169e+02  1.98461602e+03  7.27372755e+03]
E1 = -182.46247407815065  E_coul = 54.26537507711946
Extra cycle  E= -128.197099001031  delta_E= 8.53e-14  |g|= 1.22e-08  |ddm|= 2.85e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419290e+03 2.15516740e+02 1.42945269e+03 5.73087133e-01
 4.83584463e+01 1.30374351e+01 1.92793204e+00 2.77833785e+00
 1.33316617e+01 6.00720286e-01]
grad_E = [-7.52750722e-06 -2.99259428e-04  4.57314622e-05 -5.87222914e-04
  4.38351688e-04 -2.68262118e-04  1.48319868e-03  3.40817123e-04
 -4.74812808e-05 -2.91223568e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19330892        1
[INPUT] 0    0    [1    /1   ]  215.533987351        1
[INPUT] 0    0    [1    /1   ]  1429.45015717        1
[INPUT] 0    0    [1    /1   ]  0.57223480395        1
[INPUT] 0    0    [1    /1   ]  48.3335531643        1
[INPUT] 0    0    [1    /1   ]  13.0233965132        1
[INPUT] 0    0    [1    /1   ]  1.92557513619        1
[INPUT] 1    0    [1    /1   ]  2.77873478791        1
[INPUT] 1    0    [1    /1   ]  13.331611848         1
[INPUT] 1    0    [1    /1   ]  0.600791190012       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.193308919304, 1.0]], [0, [215.5339873511343, 1.0]], [0, [1429.4501571740052, 1.0]], [0, [0.5722348039497142, 1.0]], [0, [48.333553164309286, 1.0]], [0, [13.023396513218328, 1.0]], [0, [1.9255751361889597, 1.0]], [1, [2.7787347879130055, 1.0]], [1, [13.331611847994772, 1.0]], [1, [0.6007911900116423, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19330892]
bas 1, expnt(s) = [215.53398735]
bas 2, expnt(s) = [1429.45015717]
bas 3, expnt(s) = [0.5722348]
bas 4, expnt(s) = [48.33355316]
bas 5, expnt(s) = [13.02339651]
bas 6, expnt(s) = [1.92557514]
bas 7, expnt(s) = [2.77873479]
bas 8, expnt(s) = [13.33161185]
bas 9, expnt(s) = [0.60079119]
CPU time:        37.23
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419331e+03 7.96091481e+02 2.15533987e+02 1.42118903e+02
 1.42945016e+03 5.87342986e+02 5.72234804e-01 1.66224764e+00
 4.83335532e+01 4.63128563e+01 1.30233965e+01 1.73204121e+01
 1.92557514e+00 4.12986045e+00 2.77873479e+00 1.04663021e+01
 1.33316118e+01 7.43169227e+01 6.00791190e-01 1.54308140e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965666527539542
cond(S) = 156.37476893173397
E1 = -183.13638465539586  E_coul = 55.011553126371325
init E= -128.124831529025
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742873019832134  LUMO = 2.65932061032356
  mo_energy =
[-3.25130208e+01 -1.85365940e+00 -7.42873020e-01 -7.42873020e-01
 -7.42873020e-01  2.65932061e+00  2.65932061e+00  2.65932061e+00
  2.74661661e+00  1.99647112e+01  1.99647112e+01  1.99647112e+01
  4.40814896e+01  3.19337060e+02  1.98479787e+03  7.27394573e+03]
E1 = -182.13053206362818  E_coul = 53.935360187660415
cycle= 1 E= -128.195171875968  delta_E= -0.0703  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26215
diis-c [-0.06872254  1.        ]
  HOMO = -0.807884238853148  LUMO = 2.60511793066058
  mo_energy =
[-3.27868104e+01 -1.92079740e+00 -8.07884239e-01 -8.07884239e-01
 -8.07884239e-01  2.60511793e+00  2.60511793e+00  2.60511793e+00
  2.69318999e+00  1.97737573e+01  1.97737573e+01  1.97737573e+01
  4.38476804e+01  3.19027165e+02  1.98443707e+03  7.27355945e+03]
E1 = -182.59320334618505  E_coul = 54.3963964642694
cycle= 2 E= -128.196806881916  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10198
diis-c [-4.49208547e-04  2.76290811e-01  7.23709189e-01]
  HOMO = -0.78506408541248  LUMO = 2.62579634818244
  mo_energy =
[-3.27118466e+01 -1.89711661e+00 -7.85064085e-01 -7.85064085e-01
 -7.85064085e-01  2.62579635e+00  2.62579635e+00  2.62579635e+00
  2.71330627e+00  1.98300604e+01  1.98300604e+01  1.98300604e+01
  4.39135552e+01  3.19108916e+02  1.98452445e+03  7.27364834e+03]
E1 = -182.46064534994045  E_coul = 54.26353298100636
cycle= 3 E= -128.197112368934  delta_E= -0.000305  |g|= 0.00079  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107169
diis-c [-6.16034319e-08 -3.54209539e-03  1.18591848e-03  1.00235618e+00]
  HOMO = -0.785341233025328  LUMO = 2.6255798356455
  mo_energy =
[-3.27126491e+01 -1.89745597e+00 -7.85341233e-01 -7.85341233e-01
 -7.85341233e-01  2.62557984e+00  2.62557984e+00  2.62557984e+00
  2.71303828e+00  1.98294360e+01  1.98294360e+01  1.98294360e+01
  4.39128123e+01  3.19108248e+02  1.98452390e+03  7.27364782e+03]
E1 = -182.4621698724029  E_coul = 54.26505745994104
cycle= 4 E= -128.197112412462  delta_E= -4.35e-08  |g|= 4.43e-05  |ddm|= 0.000276
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.07868e-05
diis-c [-1.94305044e-10  4.49496476e-04 -1.16742578e-03 -1.61268484e-01
  1.16198641e+00]
  HOMO = -0.785328531391117  LUMO = 2.62559088301808
  mo_energy =
[-3.27126163e+01 -1.89745349e+00 -7.85328531e-01 -7.85328531e-01
 -7.85328531e-01  2.62559088e+00  2.62559088e+00  2.62559088e+00
  2.71303974e+00  1.98294614e+01  1.98294614e+01  1.98294614e+01
  4.39128388e+01  3.19108293e+02  1.98452396e+03  7.27364788e+03]
E1 = -182.46211483723758  E_coul = 54.26500242455333
cycle= 5 E= -128.197112412684  delta_E= -2.22e-10  |g|= 1.59e-06  |ddm|= 2.2e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46211483723758  E_coul = 54.26500242455333
  HOMO = -0.785328400451916  LUMO = 2.62559100756087
  mo_energy =
[-3.27126160e+01 -1.89745376e+00 -7.85328400e-01 -7.85328400e-01
 -7.85328400e-01  2.62559101e+00  2.62559101e+00  2.62559101e+00
  2.71303951e+00  1.98294616e+01  1.98294616e+01  1.98294616e+01
  4.39128389e+01  3.19108293e+02  1.98452396e+03  7.27364788e+03]
E1 = -182.4621145010356  E_coul = 54.265002088351274
Extra cycle  E= -128.197112412684  delta_E= -5.68e-14  |g|= 3.02e-07  |ddm|= 9.15e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419331e+03 2.15533987e+02 1.42945016e+03 5.72234804e-01
 4.83335532e+01 1.30233965e+01 1.92557514e+00 2.77873479e+00
 1.33316118e+01 6.00791190e-01]
E = -128.1971124126843
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19330892        1
[INPUT] 0    0    [1    /1   ]  215.533987351        1
[INPUT] 0    0    [1    /1   ]  1429.45015717        1
[INPUT] 0    0    [1    /1   ]  0.57223480395        1
[INPUT] 0    0    [1    /1   ]  48.3335531643        1
[INPUT] 0    0    [1    /1   ]  13.0233965132        1
[INPUT] 0    0    [1    /1   ]  1.92557513619        1
[INPUT] 1    0    [1    /1   ]  2.77873478791        1
[INPUT] 1    0    [1    /1   ]  13.331611848         1
[INPUT] 1    0    [1    /1   ]  0.600791190012       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.193308919304, 1.0]], [0, [215.5339873511343, 1.0]], [0, [1429.4501571740052, 1.0]], [0, [0.5722348039497142, 1.0]], [0, [48.333553164309286, 1.0]], [0, [13.023396513218328, 1.0]], [0, [1.9255751361889597, 1.0]], [1, [2.7787347879130055, 1.0]], [1, [13.331611847994772, 1.0]], [1, [0.6007911900116423, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19330892]
bas 1, expnt(s) = [215.53398735]
bas 2, expnt(s) = [1429.45015717]
bas 3, expnt(s) = [0.5722348]
bas 4, expnt(s) = [48.33355316]
bas 5, expnt(s) = [13.02339651]
bas 6, expnt(s) = [1.92557514]
bas 7, expnt(s) = [2.77873479]
bas 8, expnt(s) = [13.33161185]
bas 9, expnt(s) = [0.60079119]
CPU time:        37.55
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419331e+03 7.96091481e+02 2.15533987e+02 1.42118903e+02
 1.42945016e+03 5.87342986e+02 5.72234804e-01 1.66224764e+00
 4.83335532e+01 4.63128563e+01 1.30233965e+01 1.73204121e+01
 1.92557514e+00 4.12986045e+00 2.77873479e+00 1.04663021e+01
 1.33316118e+01 7.43169227e+01 6.00791190e-01 1.54308140e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965666527539542
cond(S) = 156.37476893173397
E1 = -183.13638465539586  E_coul = 55.011553126371325
init E= -128.124831529025
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742873019832134  LUMO = 2.65932061032356
  mo_energy =
[-3.25130208e+01 -1.85365940e+00 -7.42873020e-01 -7.42873020e-01
 -7.42873020e-01  2.65932061e+00  2.65932061e+00  2.65932061e+00
  2.74661661e+00  1.99647112e+01  1.99647112e+01  1.99647112e+01
  4.40814896e+01  3.19337060e+02  1.98479787e+03  7.27394573e+03]
E1 = -182.13053206362818  E_coul = 53.935360187660415
cycle= 1 E= -128.195171875968  delta_E= -0.0703  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26215
diis-c [-0.06872254  1.        ]
  HOMO = -0.807884238853148  LUMO = 2.60511793066058
  mo_energy =
[-3.27868104e+01 -1.92079740e+00 -8.07884239e-01 -8.07884239e-01
 -8.07884239e-01  2.60511793e+00  2.60511793e+00  2.60511793e+00
  2.69318999e+00  1.97737573e+01  1.97737573e+01  1.97737573e+01
  4.38476804e+01  3.19027165e+02  1.98443707e+03  7.27355945e+03]
E1 = -182.59320334618505  E_coul = 54.3963964642694
cycle= 2 E= -128.196806881916  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10198
diis-c [-4.49208547e-04  2.76290811e-01  7.23709189e-01]
  HOMO = -0.78506408541248  LUMO = 2.62579634818244
  mo_energy =
[-3.27118466e+01 -1.89711661e+00 -7.85064085e-01 -7.85064085e-01
 -7.85064085e-01  2.62579635e+00  2.62579635e+00  2.62579635e+00
  2.71330627e+00  1.98300604e+01  1.98300604e+01  1.98300604e+01
  4.39135552e+01  3.19108916e+02  1.98452445e+03  7.27364834e+03]
E1 = -182.46064534994045  E_coul = 54.26353298100636
cycle= 3 E= -128.197112368934  delta_E= -0.000305  |g|= 0.00079  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107169
diis-c [-6.16034319e-08 -3.54209539e-03  1.18591848e-03  1.00235618e+00]
  HOMO = -0.785341233025328  LUMO = 2.6255798356455
  mo_energy =
[-3.27126491e+01 -1.89745597e+00 -7.85341233e-01 -7.85341233e-01
 -7.85341233e-01  2.62557984e+00  2.62557984e+00  2.62557984e+00
  2.71303828e+00  1.98294360e+01  1.98294360e+01  1.98294360e+01
  4.39128123e+01  3.19108248e+02  1.98452390e+03  7.27364782e+03]
E1 = -182.4621698724029  E_coul = 54.26505745994104
cycle= 4 E= -128.197112412462  delta_E= -4.35e-08  |g|= 4.43e-05  |ddm|= 0.000276
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.07868e-05
diis-c [-1.94305044e-10  4.49496476e-04 -1.16742578e-03 -1.61268484e-01
  1.16198641e+00]
  HOMO = -0.785328531391117  LUMO = 2.62559088301808
  mo_energy =
[-3.27126163e+01 -1.89745349e+00 -7.85328531e-01 -7.85328531e-01
 -7.85328531e-01  2.62559088e+00  2.62559088e+00  2.62559088e+00
  2.71303974e+00  1.98294614e+01  1.98294614e+01  1.98294614e+01
  4.39128388e+01  3.19108293e+02  1.98452396e+03  7.27364788e+03]
E1 = -182.46211483723758  E_coul = 54.26500242455333
cycle= 5 E= -128.197112412684  delta_E= -2.22e-10  |g|= 1.59e-06  |ddm|= 2.2e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46211483723758  E_coul = 54.26500242455333
  HOMO = -0.785328400451916  LUMO = 2.62559100756087
  mo_energy =
[-3.27126160e+01 -1.89745376e+00 -7.85328400e-01 -7.85328400e-01
 -7.85328400e-01  2.62559101e+00  2.62559101e+00  2.62559101e+00
  2.71303951e+00  1.98294616e+01  1.98294616e+01  1.98294616e+01
  4.39128389e+01  3.19108293e+02  1.98452396e+03  7.27364788e+03]
E1 = -182.4621145010356  E_coul = 54.265002088351274
Extra cycle  E= -128.197112412684  delta_E= -5.68e-14  |g|= 3.02e-07  |ddm|= 9.15e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.37476893173397
E1 = -182.4621145010356  E_coul = 54.265002088351274
init E= -128.197112412684
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785328407314442  LUMO = 2.62559099971138
  mo_energy =
[-3.27126161e+01 -1.89745384e+00 -7.85328407e-01 -7.85328407e-01
 -7.85328407e-01  2.62559100e+00  2.62559100e+00  2.62559100e+00
  2.71303943e+00  1.98294616e+01  1.98294616e+01  1.98294616e+01
  4.39128388e+01  3.19108293e+02  1.98452396e+03  7.27364788e+03]
E1 = -182.46211464444409  E_coul = 54.26500223175971
cycle= 1 E= -128.197112412684  delta_E= -5.68e-14  |g|= 5.55e-08  |ddm|= 1.75e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46211464444409  E_coul = 54.26500223175971
  HOMO = -0.785328394475611  LUMO = 2.6255910110623
  mo_energy =
[-3.27126161e+01 -1.89745384e+00 -7.85328394e-01 -7.85328394e-01
 -7.85328394e-01  2.62559101e+00  2.62559101e+00  2.62559101e+00
  2.71303943e+00  1.98294616e+01  1.98294616e+01  1.98294616e+01
  4.39128389e+01  3.19108293e+02  1.98452396e+03  7.27364788e+03]
E1 = -182.4621145898595  E_coul = 54.26500217717512
Extra cycle  E= -128.197112412684  delta_E= -2.84e-14  |g|= 1.28e-08  |ddm|= 2.83e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419331e+03 2.15533987e+02 1.42945016e+03 5.72234804e-01
 4.83335532e+01 1.30233965e+01 1.92557514e+00 2.77873479e+00
 1.33316118e+01 6.00791190e-01]
grad_E = [-7.53735175e-06 -2.96992973e-04  4.56788269e-05 -9.38478394e-04
  4.79557219e-04 -6.00636220e-04  1.59704482e-03  5.53289536e-04
 -7.50703249e-05 -4.03164449e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19409904        1
[INPUT] 0    0    [1    /1   ]  215.567045821        1
[INPUT] 0    0    [1    /1   ]  1429.4453113         1
[INPUT] 0    0    [1    /1   ]  0.570715731608       1
[INPUT] 0    0    [1    /1   ]  48.2845654016        1
[INPUT] 0    0    [1    /1   ]  13.001869962         1
[INPUT] 0    0    [1    /1   ]  1.92048457524        1
[INPUT] 1    0    [1    /1   ]  2.77918594434        1
[INPUT] 1    0    [1    /1   ]  13.3315607021        1
[INPUT] 1    0    [1    /1   ]  0.600871826966       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1940990434987, 1.0]], [0, [215.56704582137408, 1.0]], [0, [1429.4453112994124, 1.0]], [0, [0.5707157316083592, 1.0]], [0, [48.28456540162158, 1.0]], [0, [13.001869961995807, 1.0]], [0, [1.9204845752383828, 1.0]], [1, [2.779185944335637, 1.0]], [1, [13.331560702117166, 1.0]], [1, [0.6008718269655312, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19409904]
bas 1, expnt(s) = [215.56704582]
bas 2, expnt(s) = [1429.4453113]
bas 3, expnt(s) = [0.57071573]
bas 4, expnt(s) = [48.2845654]
bas 5, expnt(s) = [13.00186996]
bas 6, expnt(s) = [1.92048458]
bas 7, expnt(s) = [2.77918594]
bas 8, expnt(s) = [13.3315607]
bas 9, expnt(s) = [0.60087183]
CPU time:        39.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419410e+03 7.96091701e+02 2.15567046e+02 1.42135251e+02
 1.42944531e+03 5.87341493e+02 5.70715732e-01 1.65893705e+00
 4.82845654e+01 4.62776470e+01 1.30018700e+01 1.72989358e+01
 1.92048458e+00 4.12166928e+00 2.77918594e+00 1.04684263e+01
 1.33315607e+01 7.43165663e+01 6.00871827e-01 1.54334029e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965678823540703
cond(S) = 156.30685786265806
E1 = -183.13650280982858  E_coul = 55.01149594783616
init E= -128.125006861992
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742875083536106  LUMO = 2.65982533308907
  mo_energy =
[-3.25130062e+01 -1.85371107e+00 -7.42875084e-01 -7.42875084e-01
 -7.42875084e-01  2.65982533e+00  2.65982533e+00  2.65982533e+00
  2.73443157e+00  1.99662874e+01  1.99662874e+01  1.99662874e+01
  4.39763024e+01  3.19120497e+02  1.98463416e+03  7.27380487e+03]
E1 = -182.12978109029422  E_coul = 53.93458787248792
cycle= 1 E= -128.195193217806  delta_E= -0.0702  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262309
diis-c [-0.06880584  1.        ]
  HOMO = -0.807939866674401  LUMO = 2.60556132069609
  mo_energy =
[-3.27869858e+01 -1.92085322e+00 -8.07939867e-01 -8.07939867e-01
 -8.07939867e-01  2.60556132e+00  2.60556132e+00  2.60556132e+00
  2.68122848e+00  1.97752008e+01  1.97752008e+01  1.97752008e+01
  4.37424687e+01  3.18810246e+02  1.98427287e+03  7.27341807e+03]
E1 = -182.59270887484251  E_coul = 54.39587923932121
cycle= 2 E= -128.196829635521  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102029
diis-c [-4.46566138e-04  2.76291683e-01  7.23708317e-01]
  HOMO = -0.785105691054347  LUMO = 2.62625531029967
  mo_energy =
[-3.27119850e+01 -1.89715907e+00 -7.85105691e-01 -7.85105691e-01
 -7.85105691e-01  2.62625531e+00  2.62625531e+00  2.62625531e+00
  2.70129199e+00  1.98315326e+01  1.98315326e+01  1.98315326e+01
  4.38083535e+01  3.18892031e+02  1.98436028e+03  7.27350699e+03]
E1 = -182.4600697923699  E_coul = 54.262934350065045
cycle= 3 E= -128.197135442305  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107473
diis-c [-5.79380040e-08 -3.51022022e-03  1.31172915e-03  1.00219849e+00]
  HOMO = -0.785383546968077  LUMO = 2.62603819901189
  mo_energy =
[-3.27127885e+01 -1.89749707e+00 -7.85383547e-01 -7.85383547e-01
 -7.85383547e-01  2.62603820e+00  2.62603820e+00  2.62603820e+00
  2.70102611e+00  1.98309075e+01  1.98309075e+01  1.98309075e+01
  4.38076107e+01  3.18891359e+02  1.98435972e+03  7.27350646e+03]
E1 = -182.4615952448723  E_coul = 54.26445975930477
cycle= 4 E= -128.197135485568  delta_E= -4.33e-08  |g|= 4.28e-05  |ddm|= 0.000273
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.84724e-05
diis-c [-1.89175610e-10  4.43414691e-04 -1.15153345e-03 -1.59648805e-01
  1.16035692e+00]
  HOMO = -0.785371235290893  LUMO = 2.62604890701251
  mo_energy =
[-3.27127567e+01 -1.89749459e+00 -7.85371235e-01 -7.85371235e-01
 -7.85371235e-01  2.62604891e+00  2.62604891e+00  2.62604891e+00
  2.70102757e+00  1.98309321e+01  1.98309321e+01  1.98309321e+01
  4.38076363e+01  3.18891403e+02  1.98435978e+03  7.27350652e+03]
E1 = -182.46154196752633  E_coul = 54.264406481751635
cycle= 5 E= -128.197135485775  delta_E= -2.07e-10  |g|= 1.59e-06  |ddm|= 2.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46154196752633  E_coul = 54.264406481751635
  HOMO = -0.785371092957468  LUMO = 2.62604904169768
  mo_energy =
[-3.27127564e+01 -1.89749485e+00 -7.85371093e-01 -7.85371093e-01
 -7.85371093e-01  2.62604904e+00  2.62604904e+00  2.62604904e+00
  2.70102735e+00  1.98309323e+01  1.98309323e+01  1.98309323e+01
  4.38076364e+01  3.18891403e+02  1.98435978e+03  7.27350652e+03]
E1 = -182.46154157811225  E_coul = 54.26440609233724
Extra cycle  E= -128.197135485775  delta_E= -2.84e-13  |g|= 3.03e-07  |ddm|= 9.13e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419410e+03 2.15567046e+02 1.42944531e+03 5.70715732e-01
 4.82845654e+01 1.30018700e+01 1.92048458e+00 2.77918594e+00
 1.33315607e+01 6.00871827e-01]
E = -128.197135485775
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19409904        1
[INPUT] 0    0    [1    /1   ]  215.567045821        1
[INPUT] 0    0    [1    /1   ]  1429.4453113         1
[INPUT] 0    0    [1    /1   ]  0.570715731608       1
[INPUT] 0    0    [1    /1   ]  48.2845654016        1
[INPUT] 0    0    [1    /1   ]  13.001869962         1
[INPUT] 0    0    [1    /1   ]  1.92048457524        1
[INPUT] 1    0    [1    /1   ]  2.77918594434        1
[INPUT] 1    0    [1    /1   ]  13.3315607021        1
[INPUT] 1    0    [1    /1   ]  0.600871826966       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1940990434987, 1.0]], [0, [215.56704582137408, 1.0]], [0, [1429.4453112994124, 1.0]], [0, [0.5707157316083592, 1.0]], [0, [48.28456540162158, 1.0]], [0, [13.001869961995807, 1.0]], [0, [1.9204845752383828, 1.0]], [1, [2.779185944335637, 1.0]], [1, [13.331560702117166, 1.0]], [1, [0.6008718269655312, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19409904]
bas 1, expnt(s) = [215.56704582]
bas 2, expnt(s) = [1429.4453113]
bas 3, expnt(s) = [0.57071573]
bas 4, expnt(s) = [48.2845654]
bas 5, expnt(s) = [13.00186996]
bas 6, expnt(s) = [1.92048458]
bas 7, expnt(s) = [2.77918594]
bas 8, expnt(s) = [13.3315607]
bas 9, expnt(s) = [0.60087183]
CPU time:        39.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419410e+03 7.96091701e+02 2.15567046e+02 1.42135251e+02
 1.42944531e+03 5.87341493e+02 5.70715732e-01 1.65893705e+00
 4.82845654e+01 4.62776470e+01 1.30018700e+01 1.72989358e+01
 1.92048458e+00 4.12166928e+00 2.77918594e+00 1.04684263e+01
 1.33315607e+01 7.43165663e+01 6.00871827e-01 1.54334029e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965678823540703
cond(S) = 156.30685786265806
E1 = -183.13650280982858  E_coul = 55.01149594783616
init E= -128.125006861992
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742875083536106  LUMO = 2.65982533308907
  mo_energy =
[-3.25130062e+01 -1.85371107e+00 -7.42875084e-01 -7.42875084e-01
 -7.42875084e-01  2.65982533e+00  2.65982533e+00  2.65982533e+00
  2.73443157e+00  1.99662874e+01  1.99662874e+01  1.99662874e+01
  4.39763024e+01  3.19120497e+02  1.98463416e+03  7.27380487e+03]
E1 = -182.12978109029422  E_coul = 53.93458787248792
cycle= 1 E= -128.195193217806  delta_E= -0.0702  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262309
diis-c [-0.06880584  1.        ]
  HOMO = -0.807939866674401  LUMO = 2.60556132069609
  mo_energy =
[-3.27869858e+01 -1.92085322e+00 -8.07939867e-01 -8.07939867e-01
 -8.07939867e-01  2.60556132e+00  2.60556132e+00  2.60556132e+00
  2.68122848e+00  1.97752008e+01  1.97752008e+01  1.97752008e+01
  4.37424687e+01  3.18810246e+02  1.98427287e+03  7.27341807e+03]
E1 = -182.59270887484251  E_coul = 54.39587923932121
cycle= 2 E= -128.196829635521  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102029
diis-c [-4.46566138e-04  2.76291683e-01  7.23708317e-01]
  HOMO = -0.785105691054347  LUMO = 2.62625531029967
  mo_energy =
[-3.27119850e+01 -1.89715907e+00 -7.85105691e-01 -7.85105691e-01
 -7.85105691e-01  2.62625531e+00  2.62625531e+00  2.62625531e+00
  2.70129199e+00  1.98315326e+01  1.98315326e+01  1.98315326e+01
  4.38083535e+01  3.18892031e+02  1.98436028e+03  7.27350699e+03]
E1 = -182.4600697923699  E_coul = 54.262934350065045
cycle= 3 E= -128.197135442305  delta_E= -0.000306  |g|= 0.000787  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107473
diis-c [-5.79380040e-08 -3.51022022e-03  1.31172915e-03  1.00219849e+00]
  HOMO = -0.785383546968077  LUMO = 2.62603819901189
  mo_energy =
[-3.27127885e+01 -1.89749707e+00 -7.85383547e-01 -7.85383547e-01
 -7.85383547e-01  2.62603820e+00  2.62603820e+00  2.62603820e+00
  2.70102611e+00  1.98309075e+01  1.98309075e+01  1.98309075e+01
  4.38076107e+01  3.18891359e+02  1.98435972e+03  7.27350646e+03]
E1 = -182.4615952448723  E_coul = 54.26445975930477
cycle= 4 E= -128.197135485568  delta_E= -4.33e-08  |g|= 4.28e-05  |ddm|= 0.000273
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.84724e-05
diis-c [-1.89175610e-10  4.43414691e-04 -1.15153345e-03 -1.59648805e-01
  1.16035692e+00]
  HOMO = -0.785371235290893  LUMO = 2.62604890701251
  mo_energy =
[-3.27127567e+01 -1.89749459e+00 -7.85371235e-01 -7.85371235e-01
 -7.85371235e-01  2.62604891e+00  2.62604891e+00  2.62604891e+00
  2.70102757e+00  1.98309321e+01  1.98309321e+01  1.98309321e+01
  4.38076363e+01  3.18891403e+02  1.98435978e+03  7.27350652e+03]
E1 = -182.46154196752633  E_coul = 54.264406481751635
cycle= 5 E= -128.197135485775  delta_E= -2.07e-10  |g|= 1.59e-06  |ddm|= 2.12e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46154196752633  E_coul = 54.264406481751635
  HOMO = -0.785371092957468  LUMO = 2.62604904169768
  mo_energy =
[-3.27127564e+01 -1.89749485e+00 -7.85371093e-01 -7.85371093e-01
 -7.85371093e-01  2.62604904e+00  2.62604904e+00  2.62604904e+00
  2.70102735e+00  1.98309323e+01  1.98309323e+01  1.98309323e+01
  4.38076364e+01  3.18891403e+02  1.98435978e+03  7.27350652e+03]
E1 = -182.46154157811225  E_coul = 54.26440609233724
Extra cycle  E= -128.197135485775  delta_E= -2.84e-13  |g|= 3.03e-07  |ddm|= 9.13e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.30685786265806
E1 = -182.46154157811225  E_coul = 54.26440609233724
init E= -128.197135485775
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785371103376501  LUMO = 2.62604903062614
  mo_energy =
[-3.27127565e+01 -1.89749493e+00 -7.85371103e-01 -7.85371103e-01
 -7.85371103e-01  2.62604903e+00  2.62604903e+00  2.62604903e+00
  2.70102727e+00  1.98309322e+01  1.98309322e+01  1.98309322e+01
  4.38076363e+01  3.18891403e+02  1.98435978e+03  7.27350652e+03]
E1 = -182.4615417436127  E_coul = 54.264406257837734
cycle= 1 E= -128.197135485775  delta_E=    0  |g|= 5.64e-08  |ddm|= 1.77e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4615417436127  E_coul = 54.264406257837734
  HOMO = -0.785371089012726  LUMO = 2.6260490433594
  mo_energy =
[-3.27127564e+01 -1.89749493e+00 -7.85371089e-01 -7.85371089e-01
 -7.85371089e-01  2.62604904e+00  2.62604904e+00  2.62604904e+00
  2.70102727e+00  1.98309323e+01  1.98309323e+01  1.98309323e+01
  4.38076364e+01  3.18891403e+02  1.98435978e+03  7.27350652e+03]
E1 = -182.4615416804053  E_coul = 54.26440619463037
Extra cycle  E= -128.197135485775  delta_E= 5.68e-14  |g|= 1.36e-08  |ddm|= 2.82e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14419410e+03 2.15567046e+02 1.42944531e+03 5.70715732e-01
 4.82845654e+01 1.30018700e+01 1.92048458e+00 2.77918594e+00
 1.33315607e+01 6.00871827e-01]
grad_E = [-7.56336992e-06 -2.88083832e-04  4.55374716e-05 -1.28596626e-03
  4.89855915e-04 -9.60610105e-04  1.62133688e-03  7.96347835e-04
 -1.06684254e-04 -5.05410663e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19562462        1
[INPUT] 0    0    [1    /1   ]  215.631017087        1
[INPUT] 0    0    [1    /1   ]  1429.43595232        1
[INPUT] 0    0    [1    /1   ]  0.567967841849       1
[INPUT] 0    0    [1    /1   ]  48.1880200832        1
[INPUT] 0    0    [1    /1   ]  12.9678137999        1
[INPUT] 0    0    [1    /1   ]  1.91001721624        1
[INPUT] 1    0    [1    /1   ]  2.7795699639         1
[INPUT] 1    0    [1    /1   ]  13.3315309394        1
[INPUT] 1    0    [1    /1   ]  0.600938699365       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1956246169093, 1.0]], [0, [215.63101708656922, 1.0]], [0, [1429.4359523196076, 1.0]], [0, [0.5679678418486296, 1.0]], [0, [48.18802008319218, 1.0]], [0, [12.96781379992993, 1.0]], [0, [1.910017216241178, 1.0]], [1, [2.7795699639027958, 1.0]], [1, [13.331530939438947, 1.0]], [1, [0.6009386993651673, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19562462]
bas 1, expnt(s) = [215.63101709]
bas 2, expnt(s) = [1429.43595232]
bas 3, expnt(s) = [0.56796784]
bas 4, expnt(s) = [48.18802008]
bas 5, expnt(s) = [12.9678138]
bas 6, expnt(s) = [1.91001722]
bas 7, expnt(s) = [2.77956996]
bas 8, expnt(s) = [13.33153094]
bas 9, expnt(s) = [0.6009387]
CPU time:        42.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419562e+03 7.96092126e+02 2.15631017e+02 1.42166885e+02
 1.42943595e+03 5.87338609e+02 5.67967842e-01 1.65294284e+00
 4.81880201e+01 4.62082303e+01 1.29678138e+01 1.72649410e+01
 1.91001722e+00 4.10480930e+00 2.77956996e+00 1.04702344e+01
 1.33315309e+01 7.43163589e+01 6.00938699e-01 1.54355500e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96571544841244
cond(S) = 156.18262152926843
E1 = -183.13666342615574  E_coul = 55.011346939617084
init E= -128.125316486539
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74288017441436  LUMO = 2.66024280011006
  mo_energy =
[-3.25129830e+01 -1.85381542e+00 -7.42880174e-01 -7.42880174e-01
 -7.42880174e-01  2.66024280e+00  2.66024280e+00  2.66024280e+00
  2.71110454e+00  1.99676035e+01  1.99676035e+01  1.99676035e+01
  4.37883005e+01  3.18722952e+02  1.98433531e+03  7.27354886e+03]
E1 = -182.1284898810458  E_coul = 53.933263985291106
cycle= 1 E= -128.195225895755  delta_E= -0.0699  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262487
diis-c [-0.06889931  1.        ]
  HOMO = -0.808033310162701  LUMO = 2.60588578758581
  mo_energy =
[-3.27872614e+01 -1.92097761e+00 -8.08033310e-01 -8.08033310e-01
 -8.08033310e-01  2.60588579e+00  2.60588579e+00  2.60588579e+00
  2.65832458e+00  1.97763193e+01  1.97763193e+01  1.97763193e+01
  4.35544625e+01  3.18412201e+02  1.98397329e+03  7.27316128e+03]
E1 = -182.59184607531455  E_coul = 54.394981571479384
cycle= 2 E= -128.196864503835  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102107
diis-c [-4.42661339e-04  2.76347494e-01  7.23652506e-01]
  HOMO = -0.785176492421358  LUMO = 2.62660226224757
  mo_energy =
[-3.27122069e+01 -1.89726330e+00 -7.85176492e-01 -7.85176492e-01
 -7.85176492e-01  2.62660226e+00  2.62660226e+00  2.62660226e+00
  2.67828003e+00  1.98326942e+01  1.98326942e+01  1.98326942e+01
  4.36203555e+01  3.18494036e+02  1.98406075e+03  7.27325024e+03]
E1 = -182.45907962858234  E_coul = 54.26190880665156
cycle= 3 E= -128.197170821931  delta_E= -0.000306  |g|= 0.000781  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107238
diis-c [-5.37047538e-08 -3.48213061e-03  1.37357151e-03  1.00210856e+00]
  HOMO = -0.785453771637226  LUMO = 2.62638576133204
  mo_energy =
[-3.27130070e+01 -1.89759822e+00 -7.85453772e-01 -7.85453772e-01
 -7.85453772e-01  2.62638576e+00  2.62638576e+00  2.62638576e+00
  2.67801857e+00  1.98320715e+01  1.98320715e+01  1.98320715e+01
  4.36196166e+01  3.18493366e+02  1.98406019e+03  7.27324971e+03]
E1 = -182.46059854470718  E_coul = 54.26342768021723
cycle= 4 E= -128.19717086449  delta_E= -4.26e-08  |g|= 4.1e-05  |ddm|= 0.000269
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.57866e-05
diis-c [-1.85060443e-10  4.36926580e-04 -1.11837889e-03 -1.57447745e-01
  1.15812920e+00]
  HOMO = -0.78544189325363  LUMO = 2.62639608983213
  mo_energy =
[-3.27129764e+01 -1.89759573e+00 -7.85441893e-01 -7.85441893e-01
 -7.85441893e-01  2.62639609e+00  2.62639609e+00  2.62639609e+00
  2.67802005e+00  1.98320953e+01  1.98320953e+01  1.98320953e+01
  4.36196413e+01  3.18493408e+02  1.98406024e+03  7.27324977e+03]
E1 = -182.4605472875957  E_coul = 54.26337642291555
cycle= 5 E= -128.19717086468  delta_E= -1.9e-10  |g|= 1.59e-06  |ddm|= 2.02e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4605472875957  E_coul = 54.26337642291555
  HOMO = -0.78544173663508  LUMO = 2.62639623743504
  mo_energy =
[-3.27129760e+01 -1.89759597e+00 -7.85441737e-01 -7.85441737e-01
 -7.85441737e-01  2.62639624e+00  2.62639624e+00  2.62639624e+00
  2.67801984e+00  1.98320955e+01  1.98320955e+01  1.98320955e+01
  4.36196415e+01  3.18493408e+02  1.98406024e+03  7.27324977e+03]
E1 = -182.46054683593147  E_coul = 54.263375971250944
Extra cycle  E= -128.197170864681  delta_E= -3.69e-13  |g|= 3.07e-07  |ddm|= 9.15e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419562e+03 2.15631017e+02 1.42943595e+03 5.67967842e-01
 4.81880201e+01 1.29678138e+01 1.91001722e+00 2.77956996e+00
 1.33315309e+01 6.00938699e-01]
E = -128.19717086468052
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19562462        1
[INPUT] 0    0    [1    /1   ]  215.631017087        1
[INPUT] 0    0    [1    /1   ]  1429.43595232        1
[INPUT] 0    0    [1    /1   ]  0.567967841849       1
[INPUT] 0    0    [1    /1   ]  48.1880200832        1
[INPUT] 0    0    [1    /1   ]  12.9678137999        1
[INPUT] 0    0    [1    /1   ]  1.91001721624        1
[INPUT] 1    0    [1    /1   ]  2.7795699639         1
[INPUT] 1    0    [1    /1   ]  13.3315309394        1
[INPUT] 1    0    [1    /1   ]  0.600938699365       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1956246169093, 1.0]], [0, [215.63101708656922, 1.0]], [0, [1429.4359523196076, 1.0]], [0, [0.5679678418486296, 1.0]], [0, [48.18802008319218, 1.0]], [0, [12.96781379992993, 1.0]], [0, [1.910017216241178, 1.0]], [1, [2.7795699639027958, 1.0]], [1, [13.331530939438947, 1.0]], [1, [0.6009386993651673, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19562462]
bas 1, expnt(s) = [215.63101709]
bas 2, expnt(s) = [1429.43595232]
bas 3, expnt(s) = [0.56796784]
bas 4, expnt(s) = [48.18802008]
bas 5, expnt(s) = [12.9678138]
bas 6, expnt(s) = [1.91001722]
bas 7, expnt(s) = [2.77956996]
bas 8, expnt(s) = [13.33153094]
bas 9, expnt(s) = [0.6009387]
CPU time:        42.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419562e+03 7.96092126e+02 2.15631017e+02 1.42166885e+02
 1.42943595e+03 5.87338609e+02 5.67967842e-01 1.65294284e+00
 4.81880201e+01 4.62082303e+01 1.29678138e+01 1.72649410e+01
 1.91001722e+00 4.10480930e+00 2.77956996e+00 1.04702344e+01
 1.33315309e+01 7.43163589e+01 6.00938699e-01 1.54355500e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96571544841244
cond(S) = 156.18262152926843
E1 = -183.13666342615574  E_coul = 55.011346939617084
init E= -128.125316486539
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74288017441436  LUMO = 2.66024280011006
  mo_energy =
[-3.25129830e+01 -1.85381542e+00 -7.42880174e-01 -7.42880174e-01
 -7.42880174e-01  2.66024280e+00  2.66024280e+00  2.66024280e+00
  2.71110454e+00  1.99676035e+01  1.99676035e+01  1.99676035e+01
  4.37883005e+01  3.18722952e+02  1.98433531e+03  7.27354886e+03]
E1 = -182.1284898810458  E_coul = 53.933263985291106
cycle= 1 E= -128.195225895755  delta_E= -0.0699  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262487
diis-c [-0.06889931  1.        ]
  HOMO = -0.808033310162701  LUMO = 2.60588578758581
  mo_energy =
[-3.27872614e+01 -1.92097761e+00 -8.08033310e-01 -8.08033310e-01
 -8.08033310e-01  2.60588579e+00  2.60588579e+00  2.60588579e+00
  2.65832458e+00  1.97763193e+01  1.97763193e+01  1.97763193e+01
  4.35544625e+01  3.18412201e+02  1.98397329e+03  7.27316128e+03]
E1 = -182.59184607531455  E_coul = 54.394981571479384
cycle= 2 E= -128.196864503835  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102107
diis-c [-4.42661339e-04  2.76347494e-01  7.23652506e-01]
  HOMO = -0.785176492421358  LUMO = 2.62660226224757
  mo_energy =
[-3.27122069e+01 -1.89726330e+00 -7.85176492e-01 -7.85176492e-01
 -7.85176492e-01  2.62660226e+00  2.62660226e+00  2.62660226e+00
  2.67828003e+00  1.98326942e+01  1.98326942e+01  1.98326942e+01
  4.36203555e+01  3.18494036e+02  1.98406075e+03  7.27325024e+03]
E1 = -182.45907962858234  E_coul = 54.26190880665156
cycle= 3 E= -128.197170821931  delta_E= -0.000306  |g|= 0.000781  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00107238
diis-c [-5.37047538e-08 -3.48213061e-03  1.37357151e-03  1.00210856e+00]
  HOMO = -0.785453771637226  LUMO = 2.62638576133204
  mo_energy =
[-3.27130070e+01 -1.89759822e+00 -7.85453772e-01 -7.85453772e-01
 -7.85453772e-01  2.62638576e+00  2.62638576e+00  2.62638576e+00
  2.67801857e+00  1.98320715e+01  1.98320715e+01  1.98320715e+01
  4.36196166e+01  3.18493366e+02  1.98406019e+03  7.27324971e+03]
E1 = -182.46059854470718  E_coul = 54.26342768021723
cycle= 4 E= -128.19717086449  delta_E= -4.26e-08  |g|= 4.1e-05  |ddm|= 0.000269
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.57866e-05
diis-c [-1.85060443e-10  4.36926580e-04 -1.11837889e-03 -1.57447745e-01
  1.15812920e+00]
  HOMO = -0.78544189325363  LUMO = 2.62639608983213
  mo_energy =
[-3.27129764e+01 -1.89759573e+00 -7.85441893e-01 -7.85441893e-01
 -7.85441893e-01  2.62639609e+00  2.62639609e+00  2.62639609e+00
  2.67802005e+00  1.98320953e+01  1.98320953e+01  1.98320953e+01
  4.36196413e+01  3.18493408e+02  1.98406024e+03  7.27324977e+03]
E1 = -182.4605472875957  E_coul = 54.26337642291555
cycle= 5 E= -128.19717086468  delta_E= -1.9e-10  |g|= 1.59e-06  |ddm|= 2.02e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4605472875957  E_coul = 54.26337642291555
  HOMO = -0.78544173663508  LUMO = 2.62639623743504
  mo_energy =
[-3.27129760e+01 -1.89759597e+00 -7.85441737e-01 -7.85441737e-01
 -7.85441737e-01  2.62639624e+00  2.62639624e+00  2.62639624e+00
  2.67801984e+00  1.98320955e+01  1.98320955e+01  1.98320955e+01
  4.36196415e+01  3.18493408e+02  1.98406024e+03  7.27324977e+03]
E1 = -182.46054683593147  E_coul = 54.263375971250944
Extra cycle  E= -128.197170864681  delta_E= -3.69e-13  |g|= 3.07e-07  |ddm|= 9.15e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.18262152926843
E1 = -182.46054683593147  E_coul = 54.263375971250944
init E= -128.197170864681
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.78544175108936  LUMO = 2.62639622269646
  mo_energy =
[-3.27129761e+01 -1.89759606e+00 -7.85441751e-01 -7.85441751e-01
 -7.85441751e-01  2.62639622e+00  2.62639622e+00  2.62639622e+00
  2.67801976e+00  1.98320954e+01  1.98320954e+01  1.98320954e+01
  4.36196414e+01  3.18493408e+02  1.98406024e+03  7.27324977e+03]
E1 = -182.46054702790872  E_coul = 54.263376163228266
cycle= 1 E= -128.19717086468  delta_E= 5.68e-14  |g|= 5.8e-08  |ddm|= 1.8e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46054702790872  E_coul = 54.263376163228266
  HOMO = -0.785441734870839  LUMO = 2.62639623710825
  mo_energy =
[-3.27129761e+01 -1.89759606e+00 -7.85441735e-01 -7.85441735e-01
 -7.85441735e-01  2.62639624e+00  2.62639624e+00  2.62639624e+00
  2.67801977e+00  1.98320955e+01  1.98320955e+01  1.98320955e+01
  4.36196414e+01  3.18493408e+02  1.98406024e+03  7.27324977e+03]
E1 = -182.46054695447697  E_coul = 54.26337608979645
Extra cycle  E= -128.197170864681  delta_E= -5.68e-14  |g|= 1.46e-08  |ddm|= 2.84e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14419562e+03 2.15631017e+02 1.42943595e+03 5.67967842e-01
 4.81880201e+01 1.29678138e+01 1.91001722e+00 2.77956996e+00
 1.33315309e+01 6.00938699e-01]
grad_E = [-7.62359106e-06 -2.64313808e-04  4.52070424e-05 -1.49411572e-03
  4.12070912e-04 -1.26856794e-03  1.39662162e-03  1.01182282e-03
 -1.34463634e-04 -5.52289192e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19745792        1
[INPUT] 0    0    [1    /1   ]  215.70804837         1
[INPUT] 0    0    [1    /1   ]  1429.42470295        1
[INPUT] 0    0    [1    /1   ]  0.564941242897       1
[INPUT] 0    0    [1    /1   ]  48.0695409509        1
[INPUT] 0    0    [1    /1   ]  12.9369910406        1
[INPUT] 0    0    [1    /1   ]  1.89683232681        1
[INPUT] 1    0    [1    /1   ]  2.77931802391        1
[INPUT] 1    0    [1    /1   ]  13.3315950078        1
[INPUT] 1    0    [1    /1   ]  0.600887450046       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1974579164134, 1.0]], [0, [215.70804837017474, 1.0]], [0, [1429.424702947138, 1.0]], [0, [0.5649412428966818, 1.0]], [0, [48.06954095087079, 1.0]], [0, [12.936991040646166, 1.0]], [0, [1.8968323268142375, 1.0]], [1, [2.7793180239116495, 1.0]], [1, [13.331595007800077, 1.0]], [1, [0.6008874500456073, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19745792]
bas 1, expnt(s) = [215.70804837]
bas 2, expnt(s) = [1429.42470295]
bas 3, expnt(s) = [0.56494124]
bas 4, expnt(s) = [48.06954095]
bas 5, expnt(s) = [12.93699104]
bas 6, expnt(s) = [1.89683233]
bas 7, expnt(s) = [2.77931802]
bas 8, expnt(s) = [13.33159501]
bas 9, expnt(s) = [0.60088745]
CPU time:        44.69
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419746e+03 7.96092636e+02 2.15708048e+02 1.42204974e+02
 1.42942470e+03 5.87335142e+02 5.64941243e-01 1.64633225e+00
 4.80695410e+01 4.61229955e+01 1.29369910e+01 1.72341545e+01
 1.89683233e+00 4.08353922e+00 2.77931802e+00 1.04690482e+01
 1.33315950e+01 7.43168054e+01 6.00887450e-01 1.54339045e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965778871019651
cond(S) = 156.0437393549043
E1 = -183.1367498281939  E_coul = 55.01111315153928
init E= -128.125636676655
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742888514070066  LUMO = 2.65992230869573
  mo_energy =
[-3.25129627e+01 -1.85394506e+00 -7.42888514e-01 -7.42888514e-01
 -7.42888514e-01  2.65992231e+00  2.65992231e+00  2.65992231e+00
  2.68375623e+00  1.99666505e+01  1.99666505e+01  1.99666505e+01
  4.35839733e+01  3.18274330e+02  1.98400070e+03  7.27326391e+03]
E1 = -182.1270526958257  E_coul = 53.931800811327264
cycle= 1 E= -128.195251884498  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262547
diis-c [-0.06893091  1.        ]
  HOMO = -0.808134081233358  LUMO = 2.60548315728488
  mo_energy =
[-3.27875286e+01 -1.92115457e+00 -8.08134081e-01 -8.08134081e-01
 -8.08134081e-01  2.60548316e+00  2.60548316e+00  2.60548316e+00
  2.63145933e+00  1.97751929e+01  1.97751929e+01  1.97751929e+01
  4.33501689e+01  3.17963207e+02  1.98363805e+03  7.27287566e+03]
E1 = -182.59087312263293  E_coul = 54.39398046445294
cycle= 2 E= -128.19689265818  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102186
diis-c [-4.39585421e-04  2.76490049e-01  7.23509951e-01]
  HOMO = -0.785254194278232  LUMO = 2.6262176458939
  mo_energy =
[-3.27124273e+01 -1.89742160e+00 -7.85254194e-01 -7.85254194e-01
 -7.85254194e-01  2.62621765e+00  2.62621765e+00  2.62621765e+00
  2.65128064e+00  1.98316072e+01  1.98316072e+01  1.98316072e+01
  4.34160619e+01  3.18045088e+02  1.98372556e+03  7.27296467e+03]
E1 = -182.4579815756003  E_coul = 54.26078207483757
cycle= 3 E= -128.197199500763  delta_E= -0.000307  |g|= 0.000771  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00105819
diis-c [-5.21320319e-08 -3.49286004e-03  1.20393533e-03  1.00228892e+00]
  HOMO = -0.785528121420991  LUMO = 2.62600430561627
  mo_energy =
[-3.27132166e+01 -1.89775211e+00 -7.85528121e-01 -7.85528121e-01
 -7.85528121e-01  2.62600431e+00  2.62600431e+00  2.62600431e+00
  2.65102500e+00  1.98309930e+01  1.98309930e+01  1.98309930e+01
  4.34153335e+01  3.18044430e+02  1.98372501e+03  7.27296415e+03]
E1 = -182.45948124388133  E_coul = 54.26228170170709
cycle= 4 E= -128.197199542174  delta_E= -4.14e-08  |g|= 4.05e-05  |ddm|= 0.000265
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.494e-05
diis-c [-1.88265795e-10  4.36874208e-04 -1.07624982e-03 -1.56306855e-01
  1.15694623e+00]
  HOMO = -0.785516334342506  LUMO = 2.62601454856591
  mo_energy =
[-3.27131863e+01 -1.89774956e+00 -7.85516334e-01 -7.85516334e-01
 -7.85516334e-01  2.62601455e+00  2.62601455e+00  2.62601455e+00
  2.65102652e+00  1.98310166e+01  1.98310166e+01  1.98310166e+01
  4.34153580e+01  3.18044471e+02  1.98372507e+03  7.27296421e+03]
E1 = -182.4594305848268  E_coul = 54.26223104246757
cycle= 5 E= -128.197199542359  delta_E= -1.85e-10  |g|= 1.61e-06  |ddm|= 1.99e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4594305848268  E_coul = 54.26223104246757
  HOMO = -0.785516170565978  LUMO = 2.62601470307057
  mo_energy =
[-3.27131859e+01 -1.89774980e+00 -7.85516171e-01 -7.85516171e-01
 -7.85516171e-01  2.62601470e+00  2.62601470e+00  2.62601470e+00
  2.65102631e+00  1.98310168e+01  1.98310168e+01  1.98310168e+01
  4.34153582e+01  3.18044472e+02  1.98372507e+03  7.27296421e+03]
E1 = -182.45943011156837  E_coul = 54.26223056920889
Extra cycle  E= -128.197199542359  delta_E= -2.27e-13  |g|= 3.12e-07  |ddm|= 9.28e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419746e+03 2.15708048e+02 1.42942470e+03 5.64941243e-01
 4.80695410e+01 1.29369910e+01 1.89683233e+00 2.77931802e+00
 1.33315950e+01 6.00887450e-01]
E = -128.19719954235947
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19745792        1
[INPUT] 0    0    [1    /1   ]  215.70804837         1
[INPUT] 0    0    [1    /1   ]  1429.42470295        1
[INPUT] 0    0    [1    /1   ]  0.564941242897       1
[INPUT] 0    0    [1    /1   ]  48.0695409509        1
[INPUT] 0    0    [1    /1   ]  12.9369910406        1
[INPUT] 0    0    [1    /1   ]  1.89683232681        1
[INPUT] 1    0    [1    /1   ]  2.77931802391        1
[INPUT] 1    0    [1    /1   ]  13.3315950078        1
[INPUT] 1    0    [1    /1   ]  0.600887450046       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1974579164134, 1.0]], [0, [215.70804837017474, 1.0]], [0, [1429.424702947138, 1.0]], [0, [0.5649412428966818, 1.0]], [0, [48.06954095087079, 1.0]], [0, [12.936991040646166, 1.0]], [0, [1.8968323268142375, 1.0]], [1, [2.7793180239116495, 1.0]], [1, [13.331595007800077, 1.0]], [1, [0.6008874500456073, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19745792]
bas 1, expnt(s) = [215.70804837]
bas 2, expnt(s) = [1429.42470295]
bas 3, expnt(s) = [0.56494124]
bas 4, expnt(s) = [48.06954095]
bas 5, expnt(s) = [12.93699104]
bas 6, expnt(s) = [1.89683233]
bas 7, expnt(s) = [2.77931802]
bas 8, expnt(s) = [13.33159501]
bas 9, expnt(s) = [0.60088745]
CPU time:        45.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419746e+03 7.96092636e+02 2.15708048e+02 1.42204974e+02
 1.42942470e+03 5.87335142e+02 5.64941243e-01 1.64633225e+00
 4.80695410e+01 4.61229955e+01 1.29369910e+01 1.72341545e+01
 1.89683233e+00 4.08353922e+00 2.77931802e+00 1.04690482e+01
 1.33315950e+01 7.43168054e+01 6.00887450e-01 1.54339045e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965778871019651
cond(S) = 156.0437393549043
E1 = -183.1367498281939  E_coul = 55.01111315153928
init E= -128.125636676655
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742888514070066  LUMO = 2.65992230869573
  mo_energy =
[-3.25129627e+01 -1.85394506e+00 -7.42888514e-01 -7.42888514e-01
 -7.42888514e-01  2.65992231e+00  2.65992231e+00  2.65992231e+00
  2.68375623e+00  1.99666505e+01  1.99666505e+01  1.99666505e+01
  4.35839733e+01  3.18274330e+02  1.98400070e+03  7.27326391e+03]
E1 = -182.1270526958257  E_coul = 53.931800811327264
cycle= 1 E= -128.195251884498  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262547
diis-c [-0.06893091  1.        ]
  HOMO = -0.808134081233358  LUMO = 2.60548315728488
  mo_energy =
[-3.27875286e+01 -1.92115457e+00 -8.08134081e-01 -8.08134081e-01
 -8.08134081e-01  2.60548316e+00  2.60548316e+00  2.60548316e+00
  2.63145933e+00  1.97751929e+01  1.97751929e+01  1.97751929e+01
  4.33501689e+01  3.17963207e+02  1.98363805e+03  7.27287566e+03]
E1 = -182.59087312263293  E_coul = 54.39398046445294
cycle= 2 E= -128.19689265818  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102186
diis-c [-4.39585421e-04  2.76490049e-01  7.23509951e-01]
  HOMO = -0.785254194278232  LUMO = 2.6262176458939
  mo_energy =
[-3.27124273e+01 -1.89742160e+00 -7.85254194e-01 -7.85254194e-01
 -7.85254194e-01  2.62621765e+00  2.62621765e+00  2.62621765e+00
  2.65128064e+00  1.98316072e+01  1.98316072e+01  1.98316072e+01
  4.34160619e+01  3.18045088e+02  1.98372556e+03  7.27296467e+03]
E1 = -182.4579815756003  E_coul = 54.26078207483757
cycle= 3 E= -128.197199500763  delta_E= -0.000307  |g|= 0.000771  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00105819
diis-c [-5.21320319e-08 -3.49286004e-03  1.20393533e-03  1.00228892e+00]
  HOMO = -0.785528121420991  LUMO = 2.62600430561627
  mo_energy =
[-3.27132166e+01 -1.89775211e+00 -7.85528121e-01 -7.85528121e-01
 -7.85528121e-01  2.62600431e+00  2.62600431e+00  2.62600431e+00
  2.65102500e+00  1.98309930e+01  1.98309930e+01  1.98309930e+01
  4.34153335e+01  3.18044430e+02  1.98372501e+03  7.27296415e+03]
E1 = -182.45948124388133  E_coul = 54.26228170170709
cycle= 4 E= -128.197199542174  delta_E= -4.14e-08  |g|= 4.05e-05  |ddm|= 0.000265
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.494e-05
diis-c [-1.88265795e-10  4.36874208e-04 -1.07624982e-03 -1.56306855e-01
  1.15694623e+00]
  HOMO = -0.785516334342506  LUMO = 2.62601454856591
  mo_energy =
[-3.27131863e+01 -1.89774956e+00 -7.85516334e-01 -7.85516334e-01
 -7.85516334e-01  2.62601455e+00  2.62601455e+00  2.62601455e+00
  2.65102652e+00  1.98310166e+01  1.98310166e+01  1.98310166e+01
  4.34153580e+01  3.18044471e+02  1.98372507e+03  7.27296421e+03]
E1 = -182.4594305848268  E_coul = 54.26223104246757
cycle= 5 E= -128.197199542359  delta_E= -1.85e-10  |g|= 1.61e-06  |ddm|= 1.99e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4594305848268  E_coul = 54.26223104246757
  HOMO = -0.785516170565978  LUMO = 2.62601470307057
  mo_energy =
[-3.27131859e+01 -1.89774980e+00 -7.85516171e-01 -7.85516171e-01
 -7.85516171e-01  2.62601470e+00  2.62601470e+00  2.62601470e+00
  2.65102631e+00  1.98310168e+01  1.98310168e+01  1.98310168e+01
  4.34153582e+01  3.18044472e+02  1.98372507e+03  7.27296421e+03]
E1 = -182.45943011156837  E_coul = 54.26223056920889
Extra cycle  E= -128.197199542359  delta_E= -2.27e-13  |g|= 3.12e-07  |ddm|= 9.28e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.0437393549043
E1 = -182.45943011156837  E_coul = 54.26223056920889
init E= -128.197199542359
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785516186116391  LUMO = 2.62601468731035
  mo_energy =
[-3.27131860e+01 -1.89774989e+00 -7.85516186e-01 -7.85516186e-01
 -7.85516186e-01  2.62601469e+00  2.62601469e+00  2.62601469e+00
  2.65102623e+00  1.98310167e+01  1.98310167e+01  1.98310167e+01
  4.34153581e+01  3.18044472e+02  1.98372507e+03  7.27296421e+03]
E1 = -182.45943031412455  E_coul = 54.262230771764976
cycle= 1 E= -128.19719954236  delta_E= -8.53e-14  |g|= 5.93e-08  |ddm|= 1.83e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45943031412455  E_coul = 54.262230771764976
  HOMO = -0.78551616909413  LUMO = 2.62601470244163
  mo_energy =
[-3.27131860e+01 -1.89774988e+00 -7.85516169e-01 -7.85516169e-01
 -7.85516169e-01  2.62601470e+00  2.62601470e+00  2.62601470e+00
  2.65102623e+00  1.98310168e+01  1.98310168e+01  1.98310168e+01
  4.34153581e+01  3.18044472e+02  1.98372507e+03  7.27296421e+03]
E1 = -182.45943023684544  E_coul = 54.262230694485936
Extra cycle  E= -128.197199542359  delta_E= 5.68e-14  |g|= 1.52e-08  |ddm|= 2.9e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419746e+03 2.15708048e+02 1.42942470e+03 5.64941243e-01
 4.80695410e+01 1.29369910e+01 1.89683233e+00 2.77931802e+00
 1.33315950e+01 6.00887450e-01]
grad_E = [-7.70883045e-06 -2.26870294e-04  4.47341599e-05 -1.15899526e-03
  1.85606511e-04 -1.11738221e-03  7.76114174e-04  9.02400211e-04
 -1.19281136e-04 -4.11075672e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19804366        1
[INPUT] 0    0    [1    /1   ]  215.732746293        1
[INPUT] 0    0    [1    /1   ]  1429.42110776        1
[INPUT] 0    0    [1    /1   ]  0.564232069297       1
[INPUT] 0    0    [1    /1   ]  48.0297791786        1
[INPUT] 0    0    [1    /1   ]  12.9361044492        1
[INPUT] 0    0    [1    /1   ]  1.89222648066        1
[INPUT] 1    0    [1    /1   ]  2.77855556292        1
[INPUT] 1    0    [1    /1   ]  13.3317101191        1
[INPUT] 1    0    [1    /1   ]  0.600744162353       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1980436581835, 1.0]], [0, [215.73274629254652, 1.0]], [0, [1429.4211077599264, 1.0]], [0, [0.5642320692974178, 1.0]], [0, [48.029779178576156, 1.0]], [0, [12.93610444919649, 1.0]], [0, [1.8922264806554596, 1.0]], [1, [2.7785555629185876, 1.0]], [1, [13.33171011909694, 1.0]], [1, [0.6007441623534979, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19804366]
bas 1, expnt(s) = [215.73274629]
bas 2, expnt(s) = [1429.42110776]
bas 3, expnt(s) = [0.56423207]
bas 4, expnt(s) = [48.02977918]
bas 5, expnt(s) = [12.93610445]
bas 6, expnt(s) = [1.89222648]
bas 7, expnt(s) = [2.77855556]
bas 8, expnt(s) = [13.33171012]
bas 9, expnt(s) = [0.60074416]
CPU time:        47.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419804e+03 7.96092799e+02 2.15732746e+02 1.42217185e+02
 1.42942111e+03 5.87334034e+02 5.64232069e-01 1.64478202e+00
 4.80297792e+01 4.60943788e+01 1.29361044e+01 1.72332687e+01
 1.89222648e+00 4.07610029e+00 2.77855556e+00 1.04654583e+01
 1.33317101e+01 7.43176075e+01 6.00744162e-01 1.54293042e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965819172665126
cond(S) = 156.00928136711167
E1 = -183.136702923231  E_coul = 55.011001522475986
init E= -128.125701400755
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742892998122361  LUMO = 2.65903009261556
  mo_energy =
[-3.25129624e+01 -1.85399276e+00 -7.42892998e-01 -7.42892998e-01
 -7.42892998e-01  2.65903009e+00  2.65903009e+00  2.65903009e+00
  2.67576881e+00  1.99639234e+01  1.99639234e+01  1.99639234e+01
  4.35386020e+01  3.18158286e+02  1.98391671e+03  7.27319403e+03]
E1 = -182.12659696330195  E_coul = 53.931335072952066
cycle= 1 E= -128.19526189035  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262456
diis-c [-0.06888303  1.        ]
  HOMO = -0.808165755478246  LUMO = 2.60458327044572
  mo_energy =
[-3.27875794e+01 -1.92124722e+00 -8.08165755e-01 -8.08165755e-01
 -8.08165755e-01  2.60458327e+00  2.60458327e+00  2.60458327e+00
  2.62358964e+00  1.97724481e+01  1.97724481e+01  1.97724481e+01
  4.33048173e+01  3.17847224e+02  1.98355407e+03  7.27280580e+03]
E1 = -182.59057569876703  E_coul = 54.39367242109554
cycle= 2 E= -128.196903277671  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102211
diis-c [-4.40082968e-04  2.76607203e-01  7.23392797e-01]
  HOMO = -0.785279614605877  LUMO = 2.62531745235536
  mo_energy =
[-3.27124706e+01 -1.89751042e+00 -7.85279615e-01 -7.85279615e-01
 -7.85279615e-01  2.62531745e+00  2.62531745e+00  2.62531745e+00
  2.64336849e+00  1.98288705e+01  1.98288705e+01  1.98288705e+01
  4.33707091e+01  3.17929115e+02  1.98364159e+03  7.27289482e+03]
E1 = -182.45765173173837  E_coul = 54.26044144631368
cycle= 3 E= -128.197210285425  delta_E= -0.000307  |g|= 0.000766  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104368
diis-c [-5.45336543e-08 -3.53492045e-03  9.35829547e-04  1.00259909e+00]
  HOMO = -0.785550111477664  LUMO = 2.62510728669913
  mo_energy =
[-3.27132503e+01 -1.89783886e+00 -7.85550111e-01 -7.85550111e-01
 -7.85550111e-01  2.62510729e+00  2.62510729e+00  2.62510729e+00
  2.64311520e+00  1.98282640e+01  1.98282640e+01  1.98282640e+01
  4.33699891e+01  3.17928470e+02  1.98364106e+03  7.27289432e+03]
E1 = -182.45913520155406  E_coul = 54.26192487536298
cycle= 4 E= -128.197210326191  delta_E= -4.08e-08  |g|= 4.16e-05  |ddm|= 0.000265
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.67148e-05
diis-c [-1.97009974e-10  4.44038194e-04 -1.05986179e-03 -1.57366100e-01
  1.15798192e+00]
  HOMO = -0.785537980569363  LUMO = 2.6251178237102
  mo_energy =
[-3.27132191e+01 -1.89783624e+00 -7.85537981e-01 -7.85537981e-01
 -7.85537981e-01  2.62511782e+00  2.62511782e+00  2.62511782e+00
  2.64311675e+00  1.98282882e+01  1.98282882e+01  1.98282882e+01
  4.33700142e+01  3.17928513e+02  1.98364111e+03  7.27289438e+03]
E1 = -182.4590831650456  E_coul = 54.2618728386588
cycle= 5 E= -128.197210326387  delta_E= -1.96e-10  |g|= 1.64e-06  |ddm|= 2.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4590831650456  E_coul = 54.2618728386588
  HOMO = -0.785537823118159  LUMO = 2.62511797303612
  mo_energy =
[-3.27132188e+01 -1.89783649e+00 -7.85537823e-01 -7.85537823e-01
 -7.85537823e-01  2.62511797e+00  2.62511797e+00  2.62511797e+00
  2.64311654e+00  1.98282884e+01  1.98282884e+01  1.98282884e+01
  4.33700144e+01  3.17928513e+02  1.98364111e+03  7.27289438e+03]
E1 = -182.45908273089384  E_coul = 54.261872404506406
Extra cycle  E= -128.197210326387  delta_E= -6.54e-13  |g|= 3.15e-07  |ddm|= 9.43e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419804e+03 2.15732746e+02 1.42942111e+03 5.64232069e-01
 4.80297792e+01 1.29361044e+01 1.89222648e+00 2.77855556e+00
 1.33317101e+01 6.00744162e-01]
E = -128.19721032638745
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19804366        1
[INPUT] 0    0    [1    /1   ]  215.732746293        1
[INPUT] 0    0    [1    /1   ]  1429.42110776        1
[INPUT] 0    0    [1    /1   ]  0.564232069297       1
[INPUT] 0    0    [1    /1   ]  48.0297791786        1
[INPUT] 0    0    [1    /1   ]  12.9361044492        1
[INPUT] 0    0    [1    /1   ]  1.89222648066        1
[INPUT] 1    0    [1    /1   ]  2.77855556292        1
[INPUT] 1    0    [1    /1   ]  13.3317101191        1
[INPUT] 1    0    [1    /1   ]  0.600744162353       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1980436581835, 1.0]], [0, [215.73274629254652, 1.0]], [0, [1429.4211077599264, 1.0]], [0, [0.5642320692974178, 1.0]], [0, [48.029779178576156, 1.0]], [0, [12.93610444919649, 1.0]], [0, [1.8922264806554596, 1.0]], [1, [2.7785555629185876, 1.0]], [1, [13.33171011909694, 1.0]], [1, [0.6007441623534979, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19804366]
bas 1, expnt(s) = [215.73274629]
bas 2, expnt(s) = [1429.42110776]
bas 3, expnt(s) = [0.56423207]
bas 4, expnt(s) = [48.02977918]
bas 5, expnt(s) = [12.93610445]
bas 6, expnt(s) = [1.89222648]
bas 7, expnt(s) = [2.77855556]
bas 8, expnt(s) = [13.33171012]
bas 9, expnt(s) = [0.60074416]
CPU time:        47.60
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419804e+03 7.96092799e+02 2.15732746e+02 1.42217185e+02
 1.42942111e+03 5.87334034e+02 5.64232069e-01 1.64478202e+00
 4.80297792e+01 4.60943788e+01 1.29361044e+01 1.72332687e+01
 1.89222648e+00 4.07610029e+00 2.77855556e+00 1.04654583e+01
 1.33317101e+01 7.43176075e+01 6.00744162e-01 1.54293042e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965819172665126
cond(S) = 156.00928136711167
E1 = -183.136702923231  E_coul = 55.011001522475986
init E= -128.125701400755
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742892998122361  LUMO = 2.65903009261556
  mo_energy =
[-3.25129624e+01 -1.85399276e+00 -7.42892998e-01 -7.42892998e-01
 -7.42892998e-01  2.65903009e+00  2.65903009e+00  2.65903009e+00
  2.67576881e+00  1.99639234e+01  1.99639234e+01  1.99639234e+01
  4.35386020e+01  3.18158286e+02  1.98391671e+03  7.27319403e+03]
E1 = -182.12659696330195  E_coul = 53.931335072952066
cycle= 1 E= -128.19526189035  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262456
diis-c [-0.06888303  1.        ]
  HOMO = -0.808165755478246  LUMO = 2.60458327044572
  mo_energy =
[-3.27875794e+01 -1.92124722e+00 -8.08165755e-01 -8.08165755e-01
 -8.08165755e-01  2.60458327e+00  2.60458327e+00  2.60458327e+00
  2.62358964e+00  1.97724481e+01  1.97724481e+01  1.97724481e+01
  4.33048173e+01  3.17847224e+02  1.98355407e+03  7.27280580e+03]
E1 = -182.59057569876703  E_coul = 54.39367242109554
cycle= 2 E= -128.196903277671  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102211
diis-c [-4.40082968e-04  2.76607203e-01  7.23392797e-01]
  HOMO = -0.785279614605877  LUMO = 2.62531745235536
  mo_energy =
[-3.27124706e+01 -1.89751042e+00 -7.85279615e-01 -7.85279615e-01
 -7.85279615e-01  2.62531745e+00  2.62531745e+00  2.62531745e+00
  2.64336849e+00  1.98288705e+01  1.98288705e+01  1.98288705e+01
  4.33707091e+01  3.17929115e+02  1.98364159e+03  7.27289482e+03]
E1 = -182.45765173173837  E_coul = 54.26044144631368
cycle= 3 E= -128.197210285425  delta_E= -0.000307  |g|= 0.000766  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00104368
diis-c [-5.45336543e-08 -3.53492045e-03  9.35829547e-04  1.00259909e+00]
  HOMO = -0.785550111477664  LUMO = 2.62510728669913
  mo_energy =
[-3.27132503e+01 -1.89783886e+00 -7.85550111e-01 -7.85550111e-01
 -7.85550111e-01  2.62510729e+00  2.62510729e+00  2.62510729e+00
  2.64311520e+00  1.98282640e+01  1.98282640e+01  1.98282640e+01
  4.33699891e+01  3.17928470e+02  1.98364106e+03  7.27289432e+03]
E1 = -182.45913520155406  E_coul = 54.26192487536298
cycle= 4 E= -128.197210326191  delta_E= -4.08e-08  |g|= 4.16e-05  |ddm|= 0.000265
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.67148e-05
diis-c [-1.97009974e-10  4.44038194e-04 -1.05986179e-03 -1.57366100e-01
  1.15798192e+00]
  HOMO = -0.785537980569363  LUMO = 2.6251178237102
  mo_energy =
[-3.27132191e+01 -1.89783624e+00 -7.85537981e-01 -7.85537981e-01
 -7.85537981e-01  2.62511782e+00  2.62511782e+00  2.62511782e+00
  2.64311675e+00  1.98282882e+01  1.98282882e+01  1.98282882e+01
  4.33700142e+01  3.17928513e+02  1.98364111e+03  7.27289438e+03]
E1 = -182.4590831650456  E_coul = 54.2618728386588
cycle= 5 E= -128.197210326387  delta_E= -1.96e-10  |g|= 1.64e-06  |ddm|= 2.05e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4590831650456  E_coul = 54.2618728386588
  HOMO = -0.785537823118159  LUMO = 2.62511797303612
  mo_energy =
[-3.27132188e+01 -1.89783649e+00 -7.85537823e-01 -7.85537823e-01
 -7.85537823e-01  2.62511797e+00  2.62511797e+00  2.62511797e+00
  2.64311654e+00  1.98282884e+01  1.98282884e+01  1.98282884e+01
  4.33700144e+01  3.17928513e+02  1.98364111e+03  7.27289438e+03]
E1 = -182.45908273089384  E_coul = 54.261872404506406
Extra cycle  E= -128.197210326387  delta_E= -6.54e-13  |g|= 3.15e-07  |ddm|= 9.43e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.00928136711167
E1 = -182.45908273089384  E_coul = 54.261872404506406
init E= -128.197210326387
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785537835751204  LUMO = 2.62511795989417
  mo_energy =
[-3.27132189e+01 -1.89783658e+00 -7.85537836e-01 -7.85537836e-01
 -7.85537836e-01  2.62511796e+00  2.62511796e+00  2.62511796e+00
  2.64311646e+00  1.98282883e+01  1.98282883e+01  1.98282883e+01
  4.33700143e+01  3.17928513e+02  1.98364111e+03  7.27289438e+03]
E1 = -182.4590829184484  E_coul = 54.261872592061124
cycle= 1 E= -128.197210326387  delta_E= 1.71e-13  |g|= 5.93e-08  |ddm|= 1.85e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4590829184484  E_coul = 54.261872592061124
  HOMO = -0.785537819702339  LUMO = 2.62511797413461
  mo_energy =
[-3.27132188e+01 -1.89783658e+00 -7.85537820e-01 -7.85537820e-01
 -7.85537820e-01  2.62511797e+00  2.62511797e+00  2.62511797e+00
  2.64311646e+00  1.98282883e+01  1.98282883e+01  1.98282883e+01
  4.33700144e+01  3.17928513e+02  1.98364111e+03  7.27289438e+03]
E1 = -182.45908284724445  E_coul = 54.26187252085718
Extra cycle  E= -128.197210326387  delta_E=    0  |g|= 1.47e-08  |ddm|= 2.95e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419804e+03 2.15732746e+02 1.42942111e+03 5.64232069e-01
 4.80297792e+01 1.29361044e+01 1.89222648e+00 2.77855556e+00
 1.33317101e+01 6.00744162e-01]
grad_E = [-7.74728296e-06 -2.07355424e-04  4.45180455e-05 -6.21916628e-04
 -2.44321264e-06 -6.08185173e-04  3.08939581e-04  5.16254259e-04
 -6.80422259e-05 -1.89150563e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.198025          1
[INPUT] 0    0    [1    /1   ]  215.731964283        1
[INPUT] 0    0    [1    /1   ]  1429.42122348        1
[INPUT] 0    0    [1    /1   ]  0.56454080111        1
[INPUT] 0    0    [1    /1   ]  48.0293519805        1
[INPUT] 0    0    [1    /1   ]  12.9464519269        1
[INPUT] 0    0    [1    /1   ]  1.89175511655        1
[INPUT] 1    0    [1    /1   ]  2.77774220317        1
[INPUT] 1    0    [1    /1   ]  13.3318230011        1
[INPUT] 1    0    [1    /1   ]  0.600590401198       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.198024997799, 1.0]], [0, [215.7319642827279, 1.0]], [0, [1429.421223480062, 1.0]], [0, [0.5645408011104912, 1.0]], [0, [48.02935198045614, 1.0]], [0, [12.946451926945414, 1.0]], [0, [1.8917551165534228, 1.0]], [1, [2.7777422031654346, 1.0]], [1, [13.331823001059556, 1.0]], [1, [0.6005904011982792, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.198025]
bas 1, expnt(s) = [215.73196428]
bas 2, expnt(s) = [1429.42122348]
bas 3, expnt(s) = [0.5645408]
bas 4, expnt(s) = [48.02935198]
bas 5, expnt(s) = [12.94645193]
bas 6, expnt(s) = [1.89175512]
bas 7, expnt(s) = [2.7777422]
bas 8, expnt(s) = [13.331823]
bas 9, expnt(s) = [0.6005904]
CPU time:        49.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419802e+03 7.96092794e+02 2.15731964e+02 1.42216798e+02
 1.42942122e+03 5.87334070e+02 5.64540801e-01 1.64545695e+00
 4.80293520e+01 4.60940713e+01 1.29464519e+01 1.72436062e+01
 1.89175512e+00 4.07533873e+00 2.77774220e+00 1.04616290e+01
 1.33318230e+01 7.43183941e+01 6.00590401e-01 1.54243679e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96584379116124
cond(S) = 156.02133517784316
E1 = -183.13661517080448  E_coul = 55.01095734681145
init E= -128.125657823993
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895393903115  LUMO = 2.65807951760743
  mo_energy =
[-3.25129696e+01 -1.85400099e+00 -7.42895394e-01 -7.42895394e-01
 -7.42895394e-01  2.65807952e+00  2.65807952e+00  2.65807952e+00
  2.67662423e+00  1.99610264e+01  1.99610264e+01  1.99610264e+01
  4.35624649e+01  3.18194241e+02  1.98394672e+03  7.27322150e+03]
E1 = -182.1265559584472  E_coul = 53.93129023367641
cycle= 1 E= -128.195265724771  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262338
diis-c [-0.06882137  1.        ]
  HOMO = -0.808168165211542  LUMO = 2.60365201507028
  mo_energy =
[-3.27875502e+01 -1.92129351e+00 -8.08168165e-01 -8.08168165e-01
 -8.08168165e-01  2.60365202e+00  2.60365202e+00  2.60365202e+00
  2.62439928e+00  1.97695862e+01  1.97695862e+01  1.97695862e+01
  4.33286793e+01  3.17883372e+02  1.98358431e+03  7.27283352e+03]
E1 = -182.59056667439842  E_coul = 54.393659527836455
cycle= 2 E= -128.196907146562  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102216
diis-c [-4.41797907e-04  2.76691458e-01  7.23308542e-01]
  HOMO = -0.785282322087885  LUMO = 2.62437987476818
  mo_energy =
[-3.27124471e+01 -1.89755817e+00 -7.85282322e-01 -7.85282322e-01
 -7.85282322e-01  2.62437987e+00  2.62437987e+00  2.62437987e+00
  2.64417956e+00  1.98260057e+01  1.98260057e+01  1.98260057e+01
  4.33945729e+01  3.17965262e+02  1.98367183e+03  7.27292254e+03]
E1 = -182.45764482124812  E_coul = 54.26043064101365
cycle= 3 E= -128.197214180234  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103233
diis-c [-5.80441708e-08 -3.57888362e-03  6.90098153e-04  1.00288879e+00]
  HOMO = -0.785550101584501  LUMO = 2.62417220373337
  mo_energy =
[-3.27132197e+01 -1.89788588e+00 -7.85550102e-01 -7.85550102e-01
 -7.85550102e-01  2.62417220e+00  2.62417220e+00  2.62417220e+00
  2.64392682e+00  1.98254047e+01  1.98254047e+01  1.98254047e+01
  4.33938585e+01  3.17964627e+02  1.98367132e+03  7.27292206e+03]
E1 = -182.45911679725876  E_coul = 54.261902576549765
cycle= 4 E= -128.197214220709  delta_E= -4.05e-08  |g|= 4.31e-05  |ddm|= 0.000267
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.91185e-05
diis-c [-2.06072932e-10  4.52195151e-04 -1.05653163e-03 -1.59000555e-01
  1.15960489e+00]
  HOMO = -0.785537533425299  LUMO = 2.62418311726787
  mo_energy =
[-3.27131874e+01 -1.89788321e+00 -7.85537533e-01 -7.85537533e-01
 -7.85537533e-01  2.62418312e+00  2.62418312e+00  2.62418312e+00
  2.64392838e+00  1.98254298e+01  1.98254298e+01  1.98254298e+01
  4.33938845e+01  3.17964672e+02  1.98367137e+03  7.27292212e+03]
E1 = -182.45906292434844  E_coul = 54.26184870342809
cycle= 5 E= -128.19721422092  delta_E= -2.11e-10  |g|= 1.65e-06  |ddm|= 2.14e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45906292434844  E_coul = 54.26184870342809
  HOMO = -0.785537386270825  LUMO = 2.62418325774531
  mo_energy =
[-3.27131871e+01 -1.89788348e+00 -7.85537386e-01 -7.85537386e-01
 -7.85537386e-01  2.62418326e+00  2.62418326e+00  2.62418326e+00
  2.64392815e+00  1.98254300e+01  1.98254300e+01  1.98254300e+01
  4.33938847e+01  3.17964672e+02  1.98367137e+03  7.27292212e+03]
E1 = -182.45906254474045  E_coul = 54.26184832382009
Extra cycle  E= -128.19721422092  delta_E=    0  |g|= 3.16e-07  |ddm|= 9.55e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419802e+03 2.15731964e+02 1.42942122e+03 5.64540801e-01
 4.80293520e+01 1.29464519e+01 1.89175512e+00 2.77774220e+00
 1.33318230e+01 6.00590401e-01]
E = -128.19721422092036
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.198025          1
[INPUT] 0    0    [1    /1   ]  215.731964283        1
[INPUT] 0    0    [1    /1   ]  1429.42122348        1
[INPUT] 0    0    [1    /1   ]  0.56454080111        1
[INPUT] 0    0    [1    /1   ]  48.0293519805        1
[INPUT] 0    0    [1    /1   ]  12.9464519269        1
[INPUT] 0    0    [1    /1   ]  1.89175511655        1
[INPUT] 1    0    [1    /1   ]  2.77774220317        1
[INPUT] 1    0    [1    /1   ]  13.3318230011        1
[INPUT] 1    0    [1    /1   ]  0.600590401198       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.198024997799, 1.0]], [0, [215.7319642827279, 1.0]], [0, [1429.421223480062, 1.0]], [0, [0.5645408011104912, 1.0]], [0, [48.02935198045614, 1.0]], [0, [12.946451926945414, 1.0]], [0, [1.8917551165534228, 1.0]], [1, [2.7777422031654346, 1.0]], [1, [13.331823001059556, 1.0]], [1, [0.6005904011982792, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.198025]
bas 1, expnt(s) = [215.73196428]
bas 2, expnt(s) = [1429.42122348]
bas 3, expnt(s) = [0.5645408]
bas 4, expnt(s) = [48.02935198]
bas 5, expnt(s) = [12.94645193]
bas 6, expnt(s) = [1.89175512]
bas 7, expnt(s) = [2.7777422]
bas 8, expnt(s) = [13.331823]
bas 9, expnt(s) = [0.6005904]
CPU time:        50.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419802e+03 7.96092794e+02 2.15731964e+02 1.42216798e+02
 1.42942122e+03 5.87334070e+02 5.64540801e-01 1.64545695e+00
 4.80293520e+01 4.60940713e+01 1.29464519e+01 1.72436062e+01
 1.89175512e+00 4.07533873e+00 2.77774220e+00 1.04616290e+01
 1.33318230e+01 7.43183941e+01 6.00590401e-01 1.54243679e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96584379116124
cond(S) = 156.02133517784316
E1 = -183.13661517080448  E_coul = 55.01095734681145
init E= -128.125657823993
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895393903115  LUMO = 2.65807951760743
  mo_energy =
[-3.25129696e+01 -1.85400099e+00 -7.42895394e-01 -7.42895394e-01
 -7.42895394e-01  2.65807952e+00  2.65807952e+00  2.65807952e+00
  2.67662423e+00  1.99610264e+01  1.99610264e+01  1.99610264e+01
  4.35624649e+01  3.18194241e+02  1.98394672e+03  7.27322150e+03]
E1 = -182.1265559584472  E_coul = 53.93129023367641
cycle= 1 E= -128.195265724771  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262338
diis-c [-0.06882137  1.        ]
  HOMO = -0.808168165211542  LUMO = 2.60365201507028
  mo_energy =
[-3.27875502e+01 -1.92129351e+00 -8.08168165e-01 -8.08168165e-01
 -8.08168165e-01  2.60365202e+00  2.60365202e+00  2.60365202e+00
  2.62439928e+00  1.97695862e+01  1.97695862e+01  1.97695862e+01
  4.33286793e+01  3.17883372e+02  1.98358431e+03  7.27283352e+03]
E1 = -182.59056667439842  E_coul = 54.393659527836455
cycle= 2 E= -128.196907146562  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102216
diis-c [-4.41797907e-04  2.76691458e-01  7.23308542e-01]
  HOMO = -0.785282322087885  LUMO = 2.62437987476818
  mo_energy =
[-3.27124471e+01 -1.89755817e+00 -7.85282322e-01 -7.85282322e-01
 -7.85282322e-01  2.62437987e+00  2.62437987e+00  2.62437987e+00
  2.64417956e+00  1.98260057e+01  1.98260057e+01  1.98260057e+01
  4.33945729e+01  3.17965262e+02  1.98367183e+03  7.27292254e+03]
E1 = -182.45764482124812  E_coul = 54.26043064101365
cycle= 3 E= -128.197214180234  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103233
diis-c [-5.80441708e-08 -3.57888362e-03  6.90098153e-04  1.00288879e+00]
  HOMO = -0.785550101584501  LUMO = 2.62417220373337
  mo_energy =
[-3.27132197e+01 -1.89788588e+00 -7.85550102e-01 -7.85550102e-01
 -7.85550102e-01  2.62417220e+00  2.62417220e+00  2.62417220e+00
  2.64392682e+00  1.98254047e+01  1.98254047e+01  1.98254047e+01
  4.33938585e+01  3.17964627e+02  1.98367132e+03  7.27292206e+03]
E1 = -182.45911679725876  E_coul = 54.261902576549765
cycle= 4 E= -128.197214220709  delta_E= -4.05e-08  |g|= 4.31e-05  |ddm|= 0.000267
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.91185e-05
diis-c [-2.06072932e-10  4.52195151e-04 -1.05653163e-03 -1.59000555e-01
  1.15960489e+00]
  HOMO = -0.785537533425299  LUMO = 2.62418311726787
  mo_energy =
[-3.27131874e+01 -1.89788321e+00 -7.85537533e-01 -7.85537533e-01
 -7.85537533e-01  2.62418312e+00  2.62418312e+00  2.62418312e+00
  2.64392838e+00  1.98254298e+01  1.98254298e+01  1.98254298e+01
  4.33938845e+01  3.17964672e+02  1.98367137e+03  7.27292212e+03]
E1 = -182.45906292434844  E_coul = 54.26184870342809
cycle= 5 E= -128.19721422092  delta_E= -2.11e-10  |g|= 1.65e-06  |ddm|= 2.14e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45906292434844  E_coul = 54.26184870342809
  HOMO = -0.785537386270825  LUMO = 2.62418325774531
  mo_energy =
[-3.27131871e+01 -1.89788348e+00 -7.85537386e-01 -7.85537386e-01
 -7.85537386e-01  2.62418326e+00  2.62418326e+00  2.62418326e+00
  2.64392815e+00  1.98254300e+01  1.98254300e+01  1.98254300e+01
  4.33938847e+01  3.17964672e+02  1.98367137e+03  7.27292212e+03]
E1 = -182.45906254474045  E_coul = 54.26184832382009
Extra cycle  E= -128.19721422092  delta_E=    0  |g|= 3.16e-07  |ddm|= 9.55e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.02133517784316
E1 = -182.45906254474045  E_coul = 54.26184832382009
init E= -128.19721422092
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785537395050602  LUMO = 2.62418324807557
  mo_energy =
[-3.27131872e+01 -1.89788356e+00 -7.85537395e-01 -7.85537395e-01
 -7.85537395e-01  2.62418325e+00  2.62418325e+00  2.62418325e+00
  2.64392808e+00  1.98254299e+01  1.98254299e+01  1.98254299e+01
  4.33938846e+01  3.17964672e+02  1.98367137e+03  7.27292212e+03]
E1 = -182.45906271046675  E_coul = 54.261848489546196
cycle= 1 E= -128.197214220921  delta_E= -1.99e-13  |g|= 5.88e-08  |ddm|= 1.85e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45906271046675  E_coul = 54.261848489546196
  HOMO = -0.785537380466745  LUMO = 2.62418326098241
  mo_energy =
[-3.27131872e+01 -1.89788356e+00 -7.85537380e-01 -7.85537380e-01
 -7.85537380e-01  2.62418326e+00  2.62418326e+00  2.62418326e+00
  2.64392808e+00  1.98254300e+01  1.98254300e+01  1.98254300e+01
  4.33938846e+01  3.17964672e+02  1.98367137e+03  7.27292212e+03]
E1 = -182.45906264792953  E_coul = 54.26184842700913
Extra cycle  E= -128.19721422092  delta_E= 1.71e-13  |g|= 1.39e-08  |ddm|= 2.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419802e+03 2.15731964e+02 1.42942122e+03 5.64540801e-01
 4.80293520e+01 1.29464519e+01 1.89175512e+00 2.77774220e+00
 1.33318230e+01 6.00590401e-01]
grad_E = [-7.75870393e-06 -1.99599961e-04  4.44524347e-05 -1.04111134e-04
 -1.26394272e-04 -9.93691044e-05  2.67121468e-06  1.02183200e-04
 -1.29015463e-05 -4.70388722e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19790092        1
[INPUT] 0    0    [1    /1   ]  215.726627782        1
[INPUT] 0    0    [1    /1   ]  1429.42198811        1
[INPUT] 0    0    [1    /1   ]  0.564798517744       1
[INPUT] 0    0    [1    /1   ]  48.0377136785        1
[INPUT] 0    0    [1    /1   ]  12.9504393695        1
[INPUT] 0    0    [1    /1   ]  1.89247523858        1
[INPUT] 1    0    [1    /1   ]  2.77757009926        1
[INPUT] 1    0    [1    /1   ]  13.3318444544        1
[INPUT] 1    0    [1    /1   ]  0.600556527596       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1979009222096, 1.0]], [0, [215.72662778160856, 1.0]], [0, [1429.4219881082215, 1.0]], [0, [0.5647985177444145, 1.0]], [0, [48.03771367848807, 1.0]], [0, [12.950439369548931, 1.0]], [0, [1.8924752385846269, 1.0]], [1, [2.777570099259845, 1.0]], [1, [13.331844454387493, 1.0]], [1, [0.6005565275955116, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19790092]
bas 1, expnt(s) = [215.72662778]
bas 2, expnt(s) = [1429.42198811]
bas 3, expnt(s) = [0.56479852]
bas 4, expnt(s) = [48.03771368]
bas 5, expnt(s) = [12.95043937]
bas 6, expnt(s) = [1.89247524]
bas 7, expnt(s) = [2.7775701]
bas 8, expnt(s) = [13.33184445]
bas 9, expnt(s) = [0.60055653]
CPU time:        52.34
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419790e+03 7.96092760e+02 2.15726628e+02 1.42214160e+02
 1.42942199e+03 5.87334305e+02 5.64798518e-01 1.64602029e+00
 4.80377137e+01 4.61000898e+01 1.29504394e+01 1.72475893e+01
 1.89247524e+00 4.07650218e+00 2.77757010e+00 1.04608188e+01
 1.33318445e+01 7.43185436e+01 6.00556528e-01 1.54232805e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965845942083
cond(S) = 156.03281210222428
E1 = -183.13659263204218  E_coul = 55.01096058225842
init E= -128.125632049784
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895654752679  LUMO = 2.65787425191979
  mo_energy =
[-3.25129733e+01 -1.85399470e+00 -7.42895655e-01 -7.42895655e-01
 -7.42895655e-01  2.65787425e+00  2.65787425e+00  2.65787425e+00
  2.67851110e+00  1.99604110e+01  1.99604110e+01  1.99604110e+01
  4.35805129e+01  3.18232154e+02  1.98397615e+03  7.27324705e+03]
E1 = -182.12660321006763  E_coul = 53.93133719105446
cycle= 1 E= -128.195266019013  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262317
diis-c [-0.06881035  1.        ]
  HOMO = -0.808164483638975  LUMO = 2.60345446426291
  mo_energy =
[-3.27875368e+01 -1.92129456e+00 -8.08164484e-01 -8.08164484e-01
 -8.08164484e-01  2.60345446e+00  2.60345446e+00  2.60345446e+00
  2.62624440e+00  1.97689825e+01  1.97689825e+01  1.97689825e+01
  4.33467171e+01  3.17921335e+02  1.98361382e+03  7.27285916e+03]
E1 = -182.59060570379887  E_coul = 54.39369830364713
cycle= 2 E= -128.196907400152  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102215
diis-c [-4.42323523e-04  2.76701003e-01  7.23298997e-01]
  HOMO = -0.785279455674081  LUMO = 2.62418034773353
  mo_energy =
[-3.27124357e+01 -1.89755997e+00 -7.85279456e-01 -7.85279456e-01
 -7.85279456e-01  2.62418035e+00  2.62418035e+00  2.62418035e+00
  2.64603395e+00  1.98254006e+01  1.98254006e+01  1.98254006e+01
  4.34126131e+01  3.18003223e+02  1.98370134e+03  7.27294818e+03]
E1 = -182.4576877019717  E_coul = 54.26047327620177
cycle= 3 E= -128.19721442577  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103087
diis-c [-5.89244248e-08 -3.58671044e-03  6.50825485e-04  1.00293588e+00]
  HOMO = -0.785546881542919  LUMO = 2.62397299812316
  mo_energy =
[-3.27132076e+01 -1.89788783e+00 -7.85546882e-01 -7.85546882e-01
 -7.85546882e-01  2.62397300e+00  2.62397300e+00  2.62397300e+00
  2.64578094e+00  1.98248002e+01  1.98248002e+01  1.98248002e+01
  4.34118993e+01  3.18002590e+02  1.98370082e+03  7.27294770e+03]
E1 = -182.45915852216552  E_coul = 54.26194405590301
cycle= 4 E= -128.197214466263  delta_E= -4.05e-08  |g|= 4.35e-05  |ddm|= 0.000268
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.96932e-05
diis-c [-2.07704280e-10  4.53858727e-04 -1.05892055e-03 -1.59442752e-01
  1.16004781e+00]
  HOMO = -0.785534213778113  LUMO = 2.62398399782991
  mo_energy =
[-3.27131750e+01 -1.89788516e+00 -7.85534214e-01 -7.85534214e-01
 -7.85534214e-01  2.62398400e+00  2.62398400e+00  2.62398400e+00
  2.64578250e+00  1.98248255e+01  1.98248255e+01  1.98248255e+01
  4.34119255e+01  3.18002635e+02  1.98370088e+03  7.27294776e+03]
E1 = -182.4591042174146  E_coul = 54.26188975093725
cycle= 5 E= -128.197214466477  delta_E= -2.15e-10  |g|= 1.65e-06  |ddm|= 2.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4591042174146  E_coul = 54.26188975093725
  HOMO = -0.785534069399818  LUMO = 2.62398413585889
  mo_energy =
[-3.27131747e+01 -1.89788543e+00 -7.85534069e-01 -7.85534069e-01
 -7.85534069e-01  2.62398414e+00  2.62398414e+00  2.62398414e+00
  2.64578227e+00  1.98248257e+01  1.98248257e+01  1.98248257e+01
  4.34119257e+01  3.18002635e+02  1.98370088e+03  7.27294776e+03]
E1 = -182.45910385129645  E_coul = 54.26188938481879
Extra cycle  E= -128.197214466478  delta_E= -3.13e-13  |g|= 3.15e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419790e+03 2.15726628e+02 1.42942199e+03 5.64798518e-01
 4.80377137e+01 1.29504394e+01 1.89247524e+00 2.77757010e+00
 1.33318445e+01 6.00556528e-01]
E = -128.19721446647765
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19790092        1
[INPUT] 0    0    [1    /1   ]  215.726627782        1
[INPUT] 0    0    [1    /1   ]  1429.42198811        1
[INPUT] 0    0    [1    /1   ]  0.564798517744       1
[INPUT] 0    0    [1    /1   ]  48.0377136785        1
[INPUT] 0    0    [1    /1   ]  12.9504393695        1
[INPUT] 0    0    [1    /1   ]  1.89247523858        1
[INPUT] 1    0    [1    /1   ]  2.77757009926        1
[INPUT] 1    0    [1    /1   ]  13.3318444544        1
[INPUT] 1    0    [1    /1   ]  0.600556527596       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1979009222096, 1.0]], [0, [215.72662778160856, 1.0]], [0, [1429.4219881082215, 1.0]], [0, [0.5647985177444145, 1.0]], [0, [48.03771367848807, 1.0]], [0, [12.950439369548931, 1.0]], [0, [1.8924752385846269, 1.0]], [1, [2.777570099259845, 1.0]], [1, [13.331844454387493, 1.0]], [1, [0.6005565275955116, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19790092]
bas 1, expnt(s) = [215.72662778]
bas 2, expnt(s) = [1429.42198811]
bas 3, expnt(s) = [0.56479852]
bas 4, expnt(s) = [48.03771368]
bas 5, expnt(s) = [12.95043937]
bas 6, expnt(s) = [1.89247524]
bas 7, expnt(s) = [2.7775701]
bas 8, expnt(s) = [13.33184445]
bas 9, expnt(s) = [0.60055653]
CPU time:        52.78
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419790e+03 7.96092760e+02 2.15726628e+02 1.42214160e+02
 1.42942199e+03 5.87334305e+02 5.64798518e-01 1.64602029e+00
 4.80377137e+01 4.61000898e+01 1.29504394e+01 1.72475893e+01
 1.89247524e+00 4.07650218e+00 2.77757010e+00 1.04608188e+01
 1.33318445e+01 7.43185436e+01 6.00556528e-01 1.54232805e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965845942083
cond(S) = 156.03281210222428
E1 = -183.13659263204218  E_coul = 55.01096058225842
init E= -128.125632049784
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895654752679  LUMO = 2.65787425191979
  mo_energy =
[-3.25129733e+01 -1.85399470e+00 -7.42895655e-01 -7.42895655e-01
 -7.42895655e-01  2.65787425e+00  2.65787425e+00  2.65787425e+00
  2.67851110e+00  1.99604110e+01  1.99604110e+01  1.99604110e+01
  4.35805129e+01  3.18232154e+02  1.98397615e+03  7.27324705e+03]
E1 = -182.12660321006763  E_coul = 53.93133719105446
cycle= 1 E= -128.195266019013  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262317
diis-c [-0.06881035  1.        ]
  HOMO = -0.808164483638975  LUMO = 2.60345446426291
  mo_energy =
[-3.27875368e+01 -1.92129456e+00 -8.08164484e-01 -8.08164484e-01
 -8.08164484e-01  2.60345446e+00  2.60345446e+00  2.60345446e+00
  2.62624440e+00  1.97689825e+01  1.97689825e+01  1.97689825e+01
  4.33467171e+01  3.17921335e+02  1.98361382e+03  7.27285916e+03]
E1 = -182.59060570379887  E_coul = 54.39369830364713
cycle= 2 E= -128.196907400152  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102215
diis-c [-4.42323523e-04  2.76701003e-01  7.23298997e-01]
  HOMO = -0.785279455674081  LUMO = 2.62418034773353
  mo_energy =
[-3.27124357e+01 -1.89755997e+00 -7.85279456e-01 -7.85279456e-01
 -7.85279456e-01  2.62418035e+00  2.62418035e+00  2.62418035e+00
  2.64603395e+00  1.98254006e+01  1.98254006e+01  1.98254006e+01
  4.34126131e+01  3.18003223e+02  1.98370134e+03  7.27294818e+03]
E1 = -182.4576877019717  E_coul = 54.26047327620177
cycle= 3 E= -128.19721442577  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103087
diis-c [-5.89244248e-08 -3.58671044e-03  6.50825485e-04  1.00293588e+00]
  HOMO = -0.785546881542919  LUMO = 2.62397299812316
  mo_energy =
[-3.27132076e+01 -1.89788783e+00 -7.85546882e-01 -7.85546882e-01
 -7.85546882e-01  2.62397300e+00  2.62397300e+00  2.62397300e+00
  2.64578094e+00  1.98248002e+01  1.98248002e+01  1.98248002e+01
  4.34118993e+01  3.18002590e+02  1.98370082e+03  7.27294770e+03]
E1 = -182.45915852216552  E_coul = 54.26194405590301
cycle= 4 E= -128.197214466263  delta_E= -4.05e-08  |g|= 4.35e-05  |ddm|= 0.000268
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.96932e-05
diis-c [-2.07704280e-10  4.53858727e-04 -1.05892055e-03 -1.59442752e-01
  1.16004781e+00]
  HOMO = -0.785534213778113  LUMO = 2.62398399782991
  mo_energy =
[-3.27131750e+01 -1.89788516e+00 -7.85534214e-01 -7.85534214e-01
 -7.85534214e-01  2.62398400e+00  2.62398400e+00  2.62398400e+00
  2.64578250e+00  1.98248255e+01  1.98248255e+01  1.98248255e+01
  4.34119255e+01  3.18002635e+02  1.98370088e+03  7.27294776e+03]
E1 = -182.4591042174146  E_coul = 54.26188975093725
cycle= 5 E= -128.197214466477  delta_E= -2.15e-10  |g|= 1.65e-06  |ddm|= 2.16e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4591042174146  E_coul = 54.26188975093725
  HOMO = -0.785534069399818  LUMO = 2.62398413585889
  mo_energy =
[-3.27131747e+01 -1.89788543e+00 -7.85534069e-01 -7.85534069e-01
 -7.85534069e-01  2.62398414e+00  2.62398414e+00  2.62398414e+00
  2.64578227e+00  1.98248257e+01  1.98248257e+01  1.98248257e+01
  4.34119257e+01  3.18002635e+02  1.98370088e+03  7.27294776e+03]
E1 = -182.45910385129645  E_coul = 54.26188938481879
Extra cycle  E= -128.197214466478  delta_E= -3.13e-13  |g|= 3.15e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.03281210222428
E1 = -182.45910385129645  E_coul = 54.26188938481879
init E= -128.197214466478
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785534077265631  LUMO = 2.62398412701554
  mo_energy =
[-3.27131748e+01 -1.89788551e+00 -7.85534077e-01 -7.85534077e-01
 -7.85534077e-01  2.62398413e+00  2.62398413e+00  2.62398413e+00
  2.64578219e+00  1.98248256e+01  1.98248256e+01  1.98248256e+01
  4.34119256e+01  3.18002635e+02  1.98370088e+03  7.27294776e+03]
E1 = -182.4591040114887  E_coul = 54.26188954501115
cycle= 1 E= -128.197214466478  delta_E= 8.53e-14  |g|= 5.86e-08  |ddm|= 1.85e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4591040114887  E_coul = 54.26188954501115
  HOMO = -0.785534063061315  LUMO = 2.62398413957793
  mo_energy =
[-3.27131748e+01 -1.89788551e+00 -7.85534063e-01 -7.85534063e-01
 -7.85534063e-01  2.62398414e+00  2.62398414e+00  2.62398414e+00
  2.64578219e+00  1.98248257e+01  1.98248257e+01  1.98248257e+01
  4.34119256e+01  3.18002635e+02  1.98370088e+03  7.27294776e+03]
E1 = -182.4591039511232  E_coul = 54.26188948464545
Extra cycle  E= -128.197214466478  delta_E= -1.99e-13  |g|= 1.37e-08  |ddm|= 2.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419790e+03 2.15726628e+02 1.42942199e+03 5.64798518e-01
 4.80377137e+01 1.29504394e+01 1.89247524e+00 2.77757010e+00
 1.33318445e+01 6.00556528e-01]
grad_E = [-7.75477827e-06 -2.00914185e-04  4.44741322e-05  6.78746062e-07
 -1.31737315e-04 -2.07834891e-05 -2.10484417e-05  1.69226515e-05
 -1.26985178e-06  1.10238249e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19785776        1
[INPUT] 0    0    [1    /1   ]  215.724623914        1
[INPUT] 0    0    [1    /1   ]  1429.42225775        1
[INPUT] 0    0    [1    /1   ]  0.564895154694       1
[INPUT] 0    0    [1    /1   ]  48.0414085751        1
[INPUT] 0    0    [1    /1   ]  12.9517664632        1
[INPUT] 0    0    [1    /1   ]  1.89278408362        1
[INPUT] 1    0    [1    /1   ]  2.77750306023        1
[INPUT] 1    0    [1    /1   ]  13.3318515616        1
[INPUT] 1    0    [1    /1   ]  0.600542674047       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1978577582126, 1.0]], [0, [215.72462391445015, 1.0]], [0, [1429.4222577496087, 1.0]], [0, [0.5648951546939703, 1.0]], [0, [48.04140857505091, 1.0]], [0, [12.951766463152335, 1.0]], [0, [1.892784083624604, 1.0]], [1, [2.777503060232151, 1.0]], [1, [13.331851561644651, 1.0]], [1, [0.6005426740465124, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19785776]
bas 1, expnt(s) = [215.72462391]
bas 2, expnt(s) = [1429.42225775]
bas 3, expnt(s) = [0.56489515]
bas 4, expnt(s) = [48.04140858]
bas 5, expnt(s) = [12.95176646]
bas 6, expnt(s) = [1.89278408]
bas 7, expnt(s) = [2.77750306]
bas 8, expnt(s) = [13.33185156]
bas 9, expnt(s) = [0.60054267]
CPU time:        54.95
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419786e+03 7.96092748e+02 2.15724624e+02 1.42213169e+02
 1.42942226e+03 5.87334388e+02 5.64895155e-01 1.64623152e+00
 4.80414086e+01 4.61027492e+01 1.29517665e+01 1.72489148e+01
 1.89278408e+00 4.07700112e+00 2.77750306e+00 1.04605032e+01
 1.33318516e+01 7.43185931e+01 6.00542674e-01 1.54228358e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965846981189696
cond(S) = 156.03730179654536
E1 = -183.13658520751622  E_coul = 55.01096225084369
init E= -128.125622956673
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895866799086  LUMO = 2.65779180382472
  mo_energy =
[-3.25129746e+01 -1.85399191e+00 -7.42895867e-01 -7.42895867e-01
 -7.42895867e-01  2.65779180e+00  2.65779180e+00  2.65779180e+00
  2.67925906e+00  1.99601681e+01  1.99601681e+01  1.99601681e+01
  4.35873326e+01  3.18247501e+02  1.98398868e+03  7.27325806e+03]
E1 = -182.12659461390396  E_coul = 53.93132857417358
cycle= 1 E= -128.19526603973  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262317
diis-c [-0.06881025  1.        ]
  HOMO = -0.808164936770837  LUMO = 2.60337331834045
  mo_energy =
[-3.27875385e+01 -1.92129587e+00 -8.08164937e-01 -8.08164937e-01
 -8.08164937e-01  2.60337332e+00  2.60337332e+00  2.60337332e+00
  2.62697466e+00  1.97687387e+01  1.97687387e+01  1.97687387e+01
  4.33535270e+01  3.17936689e+02  1.98362636e+03  7.27287018e+03]
E1 = -182.59060492111982  E_coul = 54.39369744353781
cycle= 2 E= -128.196907477582  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102217
diis-c [-4.42487494e-04  2.76703889e-01  7.23296111e-01]
  HOMO = -0.785279665295829  LUMO = 2.62409892990038
  mo_energy =
[-3.27124363e+01 -1.89756094e+00 -7.85279665e-01 -7.85279665e-01
 -7.85279665e-01  2.62409893e+00  2.62409893e+00  2.62409893e+00
  2.64676846e+00  1.98251576e+01  1.98251576e+01  1.98251576e+01
  4.34194255e+01  3.18018579e+02  1.98371388e+03  7.27295921e+03]
E1 = -182.45768482232563  E_coul = 54.26047030689468
cycle= 3 E= -128.197214515431  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103052
diis-c [-5.91998885e-08 -3.58861128e-03  6.40793842e-04  1.00294782e+00]
  HOMO = -0.785547005122923  LUMO = 2.62389166057834
  mo_energy =
[-3.27132080e+01 -1.89788888e+00 -7.85547005e-01 -7.85547005e-01
 -7.85547005e-01  2.62389166e+00  2.62389166e+00  2.62389166e+00
  2.64651533e+00  1.98245574e+01  1.98245574e+01  1.98245574e+01
  4.34187118e+01  3.18017947e+02  1.98371337e+03  7.27295873e+03]
E1 = -182.45915540723104  E_coul = 54.261940851295066
cycle= 4 E= -128.197214555936  delta_E= -4.05e-08  |g|= 4.36e-05  |ddm|= 0.000268
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.98695e-05
diis-c [-2.08133069e-10  4.54311104e-04 -1.05998742e-03 -1.59587959e-01
  1.16019363e+00]
  HOMO = -0.785534307550868  LUMO = 2.62390268603953
  mo_energy =
[-3.27131754e+01 -1.89788621e+00 -7.85534308e-01 -7.85534308e-01
 -7.85534308e-01  2.62390269e+00  2.62390269e+00  2.62390269e+00
  2.64651690e+00  1.98245827e+01  1.98245827e+01  1.98245827e+01
  4.34187381e+01  3.18017992e+02  1.98371343e+03  7.27295879e+03]
E1 = -182.45910097170923  E_coul = 54.26188641555712
cycle= 5 E= -128.197214556152  delta_E= -2.16e-10  |g|= 1.65e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45910097170923  E_coul = 54.26188641555712
  HOMO = -0.785534164027001  LUMO = 2.62390282330691
  mo_energy =
[-3.27131751e+01 -1.89788648e+00 -7.85534164e-01 -7.85534164e-01
 -7.85534164e-01  2.62390282e+00  2.62390282e+00  2.62390282e+00
  2.64651666e+00  1.98245829e+01  1.98245829e+01  1.98245829e+01
  4.34187382e+01  3.18017992e+02  1.98371343e+03  7.27295879e+03]
E1 = -182.45910060960554  E_coul = 54.261886053452955
Extra cycle  E= -128.197214556153  delta_E= -4.55e-13  |g|= 3.15e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419786e+03 2.15724624e+02 1.42942226e+03 5.64895155e-01
 4.80414086e+01 1.29517665e+01 1.89278408e+00 2.77750306e+00
 1.33318516e+01 6.00542674e-01]
E = -128.19721455615257
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19785776        1
[INPUT] 0    0    [1    /1   ]  215.724623914        1
[INPUT] 0    0    [1    /1   ]  1429.42225775        1
[INPUT] 0    0    [1    /1   ]  0.564895154694       1
[INPUT] 0    0    [1    /1   ]  48.0414085751        1
[INPUT] 0    0    [1    /1   ]  12.9517664632        1
[INPUT] 0    0    [1    /1   ]  1.89278408362        1
[INPUT] 1    0    [1    /1   ]  2.77750306023        1
[INPUT] 1    0    [1    /1   ]  13.3318515616        1
[INPUT] 1    0    [1    /1   ]  0.600542674047       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1978577582126, 1.0]], [0, [215.72462391445015, 1.0]], [0, [1429.4222577496087, 1.0]], [0, [0.5648951546939703, 1.0]], [0, [48.04140857505091, 1.0]], [0, [12.951766463152335, 1.0]], [0, [1.892784083624604, 1.0]], [1, [2.777503060232151, 1.0]], [1, [13.331851561644651, 1.0]], [1, [0.6005426740465124, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19785776]
bas 1, expnt(s) = [215.72462391]
bas 2, expnt(s) = [1429.42225775]
bas 3, expnt(s) = [0.56489515]
bas 4, expnt(s) = [48.04140858]
bas 5, expnt(s) = [12.95176646]
bas 6, expnt(s) = [1.89278408]
bas 7, expnt(s) = [2.77750306]
bas 8, expnt(s) = [13.33185156]
bas 9, expnt(s) = [0.60054267]
CPU time:        55.39
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419786e+03 7.96092748e+02 2.15724624e+02 1.42213169e+02
 1.42942226e+03 5.87334388e+02 5.64895155e-01 1.64623152e+00
 4.80414086e+01 4.61027492e+01 1.29517665e+01 1.72489148e+01
 1.89278408e+00 4.07700112e+00 2.77750306e+00 1.04605032e+01
 1.33318516e+01 7.43185931e+01 6.00542674e-01 1.54228358e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965846981189696
cond(S) = 156.03730179654536
E1 = -183.13658520751622  E_coul = 55.01096225084369
init E= -128.125622956673
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895866799086  LUMO = 2.65779180382472
  mo_energy =
[-3.25129746e+01 -1.85399191e+00 -7.42895867e-01 -7.42895867e-01
 -7.42895867e-01  2.65779180e+00  2.65779180e+00  2.65779180e+00
  2.67925906e+00  1.99601681e+01  1.99601681e+01  1.99601681e+01
  4.35873326e+01  3.18247501e+02  1.98398868e+03  7.27325806e+03]
E1 = -182.12659461390396  E_coul = 53.93132857417358
cycle= 1 E= -128.19526603973  delta_E= -0.0696  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262317
diis-c [-0.06881025  1.        ]
  HOMO = -0.808164936770837  LUMO = 2.60337331834045
  mo_energy =
[-3.27875385e+01 -1.92129587e+00 -8.08164937e-01 -8.08164937e-01
 -8.08164937e-01  2.60337332e+00  2.60337332e+00  2.60337332e+00
  2.62697466e+00  1.97687387e+01  1.97687387e+01  1.97687387e+01
  4.33535270e+01  3.17936689e+02  1.98362636e+03  7.27287018e+03]
E1 = -182.59060492111982  E_coul = 54.39369744353781
cycle= 2 E= -128.196907477582  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102217
diis-c [-4.42487494e-04  2.76703889e-01  7.23296111e-01]
  HOMO = -0.785279665295829  LUMO = 2.62409892990038
  mo_energy =
[-3.27124363e+01 -1.89756094e+00 -7.85279665e-01 -7.85279665e-01
 -7.85279665e-01  2.62409893e+00  2.62409893e+00  2.62409893e+00
  2.64676846e+00  1.98251576e+01  1.98251576e+01  1.98251576e+01
  4.34194255e+01  3.18018579e+02  1.98371388e+03  7.27295921e+03]
E1 = -182.45768482232563  E_coul = 54.26047030689468
cycle= 3 E= -128.197214515431  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103052
diis-c [-5.91998885e-08 -3.58861128e-03  6.40793842e-04  1.00294782e+00]
  HOMO = -0.785547005122923  LUMO = 2.62389166057834
  mo_energy =
[-3.27132080e+01 -1.89788888e+00 -7.85547005e-01 -7.85547005e-01
 -7.85547005e-01  2.62389166e+00  2.62389166e+00  2.62389166e+00
  2.64651533e+00  1.98245574e+01  1.98245574e+01  1.98245574e+01
  4.34187118e+01  3.18017947e+02  1.98371337e+03  7.27295873e+03]
E1 = -182.45915540723104  E_coul = 54.261940851295066
cycle= 4 E= -128.197214555936  delta_E= -4.05e-08  |g|= 4.36e-05  |ddm|= 0.000268
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.98695e-05
diis-c [-2.08133069e-10  4.54311104e-04 -1.05998742e-03 -1.59587959e-01
  1.16019363e+00]
  HOMO = -0.785534307550868  LUMO = 2.62390268603953
  mo_energy =
[-3.27131754e+01 -1.89788621e+00 -7.85534308e-01 -7.85534308e-01
 -7.85534308e-01  2.62390269e+00  2.62390269e+00  2.62390269e+00
  2.64651690e+00  1.98245827e+01  1.98245827e+01  1.98245827e+01
  4.34187381e+01  3.18017992e+02  1.98371343e+03  7.27295879e+03]
E1 = -182.45910097170923  E_coul = 54.26188641555712
cycle= 5 E= -128.197214556152  delta_E= -2.16e-10  |g|= 1.65e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45910097170923  E_coul = 54.26188641555712
  HOMO = -0.785534164027001  LUMO = 2.62390282330691
  mo_energy =
[-3.27131751e+01 -1.89788648e+00 -7.85534164e-01 -7.85534164e-01
 -7.85534164e-01  2.62390282e+00  2.62390282e+00  2.62390282e+00
  2.64651666e+00  1.98245829e+01  1.98245829e+01  1.98245829e+01
  4.34187382e+01  3.18017992e+02  1.98371343e+03  7.27295879e+03]
E1 = -182.45910060960554  E_coul = 54.261886053452955
Extra cycle  E= -128.197214556153  delta_E= -4.55e-13  |g|= 3.15e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.03730179654536
E1 = -182.45910060960554  E_coul = 54.261886053452955
init E= -128.197214556153
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785534171625655  LUMO = 2.62390281470552
  mo_energy =
[-3.27131752e+01 -1.89788656e+00 -7.85534172e-01 -7.85534172e-01
 -7.85534172e-01  2.62390281e+00  2.62390281e+00  2.62390281e+00
  2.64651659e+00  1.98245829e+01  1.98245829e+01  1.98245829e+01
  4.34187381e+01  3.18017992e+02  1.98371343e+03  7.27295879e+03]
E1 = -182.45910076813342  E_coul = 54.26188621198106
cycle= 1 E= -128.197214556152  delta_E= 1.99e-13  |g|= 5.85e-08  |ddm|= 1.85e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45910076813342  E_coul = 54.26188621198106
  HOMO = -0.785534157536439  LUMO = 2.62390282716345
  mo_energy =
[-3.27131751e+01 -1.89788656e+00 -7.85534158e-01 -7.85534158e-01
 -7.85534158e-01  2.62390283e+00  2.62390283e+00  2.62390283e+00
  2.64651659e+00  1.98245829e+01  1.98245829e+01  1.98245829e+01
  4.34187381e+01  3.18017992e+02  1.98371343e+03  7.27295879e+03]
E1 = -182.4591007084173  E_coul = 54.26188615226478
Extra cycle  E= -128.197214556153  delta_E= -1.42e-13  |g|= 1.37e-08  |ddm|= 2.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419786e+03 2.15724624e+02 1.42942226e+03 5.64895155e-01
 4.80414086e+01 1.29517665e+01 1.89278408e+00 2.77750306e+00
 1.33318516e+01 6.00542674e-01]
grad_E = [-7.75268635e-06 -2.01783988e-04  4.44858482e-05  3.00845699e-05
 -1.29178823e-04 -6.59943719e-06 -2.14593690e-05 -1.47785665e-05
  3.18553329e-06  9.11375366e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19782922        1
[INPUT] 0    0    [1    /1   ]  215.723007877        1
[INPUT] 0    0    [1    /1   ]  1429.42244327        1
[INPUT] 0    0    [1    /1   ]  0.56499250998        1
[INPUT] 0    0    [1    /1   ]  48.0453120114        1
[INPUT] 0    0    [1    /1   ]  12.9530949854        1
[INPUT] 0    0    [1    /1   ]  1.89309987526        1
[INPUT] 1    0    [1    /1   ]  2.7774157416         1
[INPUT] 1    0    [1    /1   ]  13.3318593381        1
[INPUT] 1    0    [1    /1   ]  0.600524370204       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.197829223186, 1.0]], [0, [215.72300787670756, 1.0]], [0, [1429.4224432712347, 1.0]], [0, [0.5649925099800419, 1.0]], [0, [48.04531201135093, 1.0]], [0, [12.95309498540486, 1.0]], [0, [1.8930998752640467, 1.0]], [1, [2.777415741602492, 1.0]], [1, [13.3318593381383, 1.0]], [1, [0.6005243702041795, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19782922]
bas 1, expnt(s) = [215.72300788]
bas 2, expnt(s) = [1429.42244327]
bas 3, expnt(s) = [0.56499251]
bas 4, expnt(s) = [48.04531201]
bas 5, expnt(s) = [12.95309499]
bas 6, expnt(s) = [1.89309988]
bas 7, expnt(s) = [2.77741574]
bas 8, expnt(s) = [13.33185934]
bas 9, expnt(s) = [0.60052437]
CPU time:        57.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419783e+03 7.96092740e+02 2.15723008e+02 1.42212370e+02
 1.42942244e+03 5.87334445e+02 5.64992510e-01 1.64644430e+00
 4.80453120e+01 4.61055586e+01 1.29530950e+01 1.72502418e+01
 1.89309988e+00 4.07751126e+00 2.77741574e+00 1.04600921e+01
 1.33318593e+01 7.43186473e+01 6.00524370e-01 1.54222482e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965848878648483
cond(S) = 156.0419945920732
E1 = -183.1365771662676  E_coul = 55.010963259046505
init E= -128.125613907221
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74289624021604  LUMO = 2.65768332591709
  mo_energy =
[-3.25129760e+01 -1.85398910e+00 -7.42896240e-01 -7.42896240e-01
 -7.42896240e-01  2.65768333e+00  2.65768333e+00  2.65768333e+00
  2.68001763e+00  1.99598490e+01  1.99598490e+01  1.99598490e+01
  4.35942946e+01  3.18263815e+02  1.98400309e+03  7.27327101e+03]
E1 = -182.12655628553063  E_coul = 53.9312902459994
cycle= 1 E= -128.195266039531  delta_E= -0.0697  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262322
diis-c [-0.06881285  1.        ]
  HOMO = -0.808167511381311  LUMO = 2.6032647685733
  mo_energy =
[-3.27875465e+01 -1.92129945e+00 -8.08167511e-01 -8.08167511e-01
 -8.08167511e-01  2.60326477e+00  2.60326477e+00  2.60326477e+00
  2.62771331e+00  1.97684140e+01  1.97684140e+01  1.97684140e+01
  4.33604735e+01  3.17953004e+02  1.98364078e+03  7.27288315e+03]
E1 = -182.59058688520452  E_coul = 54.39367927409085
cycle= 2 E= -128.196907611114  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102221
diis-c [-4.42651114e-04  2.76708272e-01  7.23291728e-01]
  HOMO = -0.785281414301569  LUMO = 2.62399047421891
  mo_energy =
[-3.27124414e+01 -1.89756357e+00 -7.85281414e-01 -7.85281414e-01
 -7.85281414e-01  2.62399047e+00  2.62399047e+00  2.62399047e+00
  2.64751194e+00  1.98248351e+01  1.98248351e+01  1.98248351e+01
  4.34263761e+01  3.18034897e+02  1.98372831e+03  7.27297218e+03]
E1 = -182.457660965685  E_coul = 54.26044628762763
cycle= 3 E= -128.197214678057  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103008
diis-c [-5.94905885e-08 -3.59053192e-03  6.29532216e-04  1.00296100e+00]
  HOMO = -0.785548647103292  LUMO = 2.62378330720694
  mo_energy =
[-3.27132129e+01 -1.89789156e+00 -7.85548647e-01 -7.85548647e-01
 -7.85548647e-01  2.62378331e+00  2.62378331e+00  2.62378331e+00
  2.64725870e+00  1.98242351e+01  1.98242351e+01  1.98242351e+01
  4.34256626e+01  3.18034265e+02  1.98372780e+03  7.27297170e+03]
E1 = -182.45913121122223  E_coul = 54.26191649265145
cycle= 4 E= -128.197214718571  delta_E= -4.05e-08  |g|= 4.37e-05  |ddm|= 0.000268
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.0054e-05
diis-c [-2.08585096e-10  4.54763471e-04 -1.06097147e-03 -1.59738644e-01
  1.16034485e+00]
  HOMO = -0.78553591843024  LUMO = 2.62379435944216
  mo_energy =
[-3.27131802e+01 -1.89788889e+00 -7.85535918e-01 -7.85535918e-01
 -7.85535918e-01  2.62379436e+00  2.62379436e+00  2.62379436e+00
  2.64726027e+00  1.98242605e+01  1.98242605e+01  1.98242605e+01
  4.34256889e+01  3.18034310e+02  1.98372785e+03  7.27297176e+03]
E1 = -182.45907663921906  E_coul = 54.26186192043084
cycle= 5 E= -128.197214718788  delta_E= -2.17e-10  |g|= 1.65e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45907663921906  E_coul = 54.26186192043084
  HOMO = -0.785535775758314  LUMO = 2.62379449594995
  mo_energy =
[-3.27131799e+01 -1.89788916e+00 -7.85535776e-01 -7.85535776e-01
 -7.85535776e-01  2.62379450e+00  2.62379450e+00  2.62379450e+00
  2.64726003e+00  1.98242606e+01  1.98242606e+01  1.98242606e+01
  4.34256890e+01  3.18034310e+02  1.98372785e+03  7.27297176e+03]
E1 = -182.45907628110015  E_coul = 54.26186156231167
Extra cycle  E= -128.197214718788  delta_E= -2.56e-13  |g|= 3.15e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [2.14419783e+03 2.15723008e+02 1.42942244e+03 5.64992510e-01
 4.80453120e+01 1.29530950e+01 1.89309988e+00 2.77741574e+00
 1.33318593e+01 6.00524370e-01]
E = -128.19721471878847
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19782922        1
[INPUT] 0    0    [1    /1   ]  215.723007877        1
[INPUT] 0    0    [1    /1   ]  1429.42244327        1
[INPUT] 0    0    [1    /1   ]  0.56499250998        1
[INPUT] 0    0    [1    /1   ]  48.0453120114        1
[INPUT] 0    0    [1    /1   ]  12.9530949854        1
[INPUT] 0    0    [1    /1   ]  1.89309987526        1
[INPUT] 1    0    [1    /1   ]  2.7774157416         1
[INPUT] 1    0    [1    /1   ]  13.3318593381        1
[INPUT] 1    0    [1    /1   ]  0.600524370204       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.197829223186, 1.0]], [0, [215.72300787670756, 1.0]], [0, [1429.4224432712347, 1.0]], [0, [0.5649925099800419, 1.0]], [0, [48.04531201135093, 1.0]], [0, [12.95309498540486, 1.0]], [0, [1.8930998752640467, 1.0]], [1, [2.777415741602492, 1.0]], [1, [13.3318593381383, 1.0]], [1, [0.6005243702041795, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19782922]
bas 1, expnt(s) = [215.72300788]
bas 2, expnt(s) = [1429.42244327]
bas 3, expnt(s) = [0.56499251]
bas 4, expnt(s) = [48.04531201]
bas 5, expnt(s) = [12.95309499]
bas 6, expnt(s) = [1.89309988]
bas 7, expnt(s) = [2.77741574]
bas 8, expnt(s) = [13.33185934]
bas 9, expnt(s) = [0.60052437]
CPU time:        57.93
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419783e+03 7.96092740e+02 2.15723008e+02 1.42212370e+02
 1.42942244e+03 5.87334445e+02 5.64992510e-01 1.64644430e+00
 4.80453120e+01 4.61055586e+01 1.29530950e+01 1.72502418e+01
 1.89309988e+00 4.07751126e+00 2.77741574e+00 1.04600921e+01
 1.33318593e+01 7.43186473e+01 6.00524370e-01 1.54222482e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965848878648483
cond(S) = 156.0419945920732
E1 = -183.1365771662676  E_coul = 55.010963259046505
init E= -128.125613907221
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74289624021604  LUMO = 2.65768332591709
  mo_energy =
[-3.25129760e+01 -1.85398910e+00 -7.42896240e-01 -7.42896240e-01
 -7.42896240e-01  2.65768333e+00  2.65768333e+00  2.65768333e+00
  2.68001763e+00  1.99598490e+01  1.99598490e+01  1.99598490e+01
  4.35942946e+01  3.18263815e+02  1.98400309e+03  7.27327101e+03]
E1 = -182.12655628553063  E_coul = 53.9312902459994
cycle= 1 E= -128.195266039531  delta_E= -0.0697  |g|= 0.165  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262322
diis-c [-0.06881285  1.        ]
  HOMO = -0.808167511381311  LUMO = 2.6032647685733
  mo_energy =
[-3.27875465e+01 -1.92129945e+00 -8.08167511e-01 -8.08167511e-01
 -8.08167511e-01  2.60326477e+00  2.60326477e+00  2.60326477e+00
  2.62771331e+00  1.97684140e+01  1.97684140e+01  1.97684140e+01
  4.33604735e+01  3.17953004e+02  1.98364078e+03  7.27288315e+03]
E1 = -182.59058688520452  E_coul = 54.39367927409085
cycle= 2 E= -128.196907611114  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102221
diis-c [-4.42651114e-04  2.76708272e-01  7.23291728e-01]
  HOMO = -0.785281414301569  LUMO = 2.62399047421891
  mo_energy =
[-3.27124414e+01 -1.89756357e+00 -7.85281414e-01 -7.85281414e-01
 -7.85281414e-01  2.62399047e+00  2.62399047e+00  2.62399047e+00
  2.64751194e+00  1.98248351e+01  1.98248351e+01  1.98248351e+01
  4.34263761e+01  3.18034897e+02  1.98372831e+03  7.27297218e+03]
E1 = -182.457660965685  E_coul = 54.26044628762763
cycle= 3 E= -128.197214678057  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00103008
diis-c [-5.94905885e-08 -3.59053192e-03  6.29532216e-04  1.00296100e+00]
  HOMO = -0.785548647103292  LUMO = 2.62378330720694
  mo_energy =
[-3.27132129e+01 -1.89789156e+00 -7.85548647e-01 -7.85548647e-01
 -7.85548647e-01  2.62378331e+00  2.62378331e+00  2.62378331e+00
  2.64725870e+00  1.98242351e+01  1.98242351e+01  1.98242351e+01
  4.34256626e+01  3.18034265e+02  1.98372780e+03  7.27297170e+03]
E1 = -182.45913121122223  E_coul = 54.26191649265145
cycle= 4 E= -128.197214718571  delta_E= -4.05e-08  |g|= 4.37e-05  |ddm|= 0.000268
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.0054e-05
diis-c [-2.08585096e-10  4.54763471e-04 -1.06097147e-03 -1.59738644e-01
  1.16034485e+00]
  HOMO = -0.78553591843024  LUMO = 2.62379435944216
  mo_energy =
[-3.27131802e+01 -1.89788889e+00 -7.85535918e-01 -7.85535918e-01
 -7.85535918e-01  2.62379436e+00  2.62379436e+00  2.62379436e+00
  2.64726027e+00  1.98242605e+01  1.98242605e+01  1.98242605e+01
  4.34256889e+01  3.18034310e+02  1.98372785e+03  7.27297176e+03]
E1 = -182.45907663921906  E_coul = 54.26186192043084
cycle= 5 E= -128.197214718788  delta_E= -2.17e-10  |g|= 1.65e-06  |ddm|= 2.17e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45907663921906  E_coul = 54.26186192043084
  HOMO = -0.785535775758314  LUMO = 2.62379449594995
  mo_energy =
[-3.27131799e+01 -1.89788916e+00 -7.85535776e-01 -7.85535776e-01
 -7.85535776e-01  2.62379450e+00  2.62379450e+00  2.62379450e+00
  2.64726003e+00  1.98242606e+01  1.98242606e+01  1.98242606e+01
  4.34256890e+01  3.18034310e+02  1.98372785e+03  7.27297176e+03]
E1 = -182.45907628110015  E_coul = 54.26186156231167
Extra cycle  E= -128.197214718788  delta_E= -2.56e-13  |g|= 3.15e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.0419945920732
E1 = -182.45907628110015  E_coul = 54.26186156231167
init E= -128.197214718788
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785535783091623  LUMO = 2.62379448758882
  mo_energy =
[-3.27131800e+01 -1.89788925e+00 -7.85535783e-01 -7.85535783e-01
 -7.85535783e-01  2.62379449e+00  2.62379449e+00  2.62379449e+00
  2.64725996e+00  1.98242606e+01  1.98242606e+01  1.98242606e+01
  4.34256889e+01  3.18034310e+02  1.98372785e+03  7.27297176e+03]
E1 = -182.45907643797318  E_coul = 54.26186171918454
cycle= 1 E= -128.197214718789  delta_E= -1.71e-13  |g|= 5.85e-08  |ddm|= 1.85e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45907643797318  E_coul = 54.26186171918454
  HOMO = -0.785535769116838  LUMO = 2.6237944999428
  mo_energy =
[-3.27131799e+01 -1.89788925e+00 -7.85535769e-01 -7.85535769e-01
 -7.85535769e-01  2.62379450e+00  2.62379450e+00  2.62379450e+00
  2.64725996e+00  1.98242606e+01  1.98242606e+01  1.98242606e+01
  4.34256890e+01  3.18034310e+02  1.98372785e+03  7.27297176e+03]
E1 = -182.45907637890252  E_coul = 54.26186166011387
Extra cycle  E= -128.197214718789  delta_E=    0  |g|= 1.36e-08  |ddm|= 2.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419783e+03 2.15723008e+02 1.42942244e+03 5.64992510e-01
 4.80453120e+01 1.29530950e+01 1.89309988e+00 2.77741574e+00
 1.33318593e+01 6.00524370e-01]
grad_E = [-7.75056062e-06 -2.02715853e-04  4.44978599e-05  5.84159578e-05
 -1.25863575e-04  5.37683721e-06 -2.07608358e-05 -5.53140187e-05
  8.93113517e-06  4.25510603e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19781998        1
[INPUT] 0    0    [1    /1   ]  215.721797414        1
[INPUT] 0    0    [1    /1   ]  1429.42252052        1
[INPUT] 0    0    [1    /1   ]  0.565106426202       1
[INPUT] 0    0    [1    /1   ]  48.0500102259        1
[INPUT] 0    0    [1    /1   ]  12.9546539062        1
[INPUT] 0    0    [1    /1   ]  1.89347133271        1
[INPUT] 1    0    [1    /1   ]  2.77729590153        1
[INPUT] 1    0    [1    /1   ]  13.3318676273        1
[INPUT] 1    0    [1    /1   ]  0.600499125673       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1978199773644, 1.0]], [0, [215.7217974136531, 1.0]], [0, [1429.4225205241069, 1.0]], [0, [0.5651064262018242, 1.0]], [0, [48.05001022594187, 1.0]], [0, [12.95465390622596, 1.0]], [0, [1.8934713327105008, 1.0]], [1, [2.777295901528648, 1.0]], [1, [13.331867627299077, 1.0]], [1, [0.600499125673286, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19781998]
bas 1, expnt(s) = [215.72179741]
bas 2, expnt(s) = [1429.42252052]
bas 3, expnt(s) = [0.56510643]
bas 4, expnt(s) = [48.05001023]
bas 5, expnt(s) = [12.95465391]
bas 6, expnt(s) = [1.89347133]
bas 7, expnt(s) = [2.7772959]
bas 8, expnt(s) = [13.33186763]
bas 9, expnt(s) = [0.60049913]
CPU time:        60.17
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419782e+03 7.96092737e+02 2.15721797e+02 1.42211772e+02
 1.42942252e+03 5.87334469e+02 5.65106426e-01 1.64669326e+00
 4.80500102e+01 4.61089399e+01 1.29546539e+01 1.72517988e+01
 1.89347133e+00 4.07811131e+00 2.77729590e+00 1.04595279e+01
 1.33318676e+01 7.43187050e+01 6.00499126e-01 1.54214378e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965851845642558
cond(S) = 156.04769816787444
E1 = -183.13656728450732  E_coul = 55.01096381244785
init E= -128.125603472059
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742896810451159  LUMO = 2.65753392039111
  mo_energy =
[-3.25129777e+01 -1.85398583e+00 -7.42896810e-01 -7.42896810e-01
 -7.42896810e-01  2.65753392e+00  2.65753392e+00  2.65753392e+00
  2.68090761e+00  1.99594078e+01  1.99594078e+01  1.99594078e+01
  4.36025248e+01  3.18283886e+02  1.98402242e+03  7.27328878e+03]
E1 = -182.12648659438932  E_coul = 53.93122052099288
cycle= 1 E= -128.195266073396  delta_E= -0.0697  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262332
diis-c [-0.068818  1.      ]
  HOMO = -0.808172308027442  LUMO = 2.60311413994687
  mo_energy =
[-3.27875610e+01 -1.92130562e+00 -8.08172308e-01 -8.08172308e-01
 -8.08172308e-01  2.60311414e+00  2.60311414e+00  2.60311414e+00
  2.62857819e+00  1.97679625e+01  1.97679625e+01  1.97679625e+01
  4.33686808e+01  3.17973069e+02  1.98366012e+03  7.27290092e+03]
E1 = -182.59055136324923  E_coul = 54.3936434978063
cycle= 2 E= -128.196907865443  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102229
diis-c [-4.42841773e-04  2.76714834e-01  7.23285166e-01]
  HOMO = -0.785284762725185  LUMO = 2.62384025253312
  mo_energy =
[-3.27124511e+01 -1.89756810e+00 -7.85284763e-01 -7.85284763e-01
 -7.85284763e-01  2.62384025e+00  2.62384025e+00  2.62384025e+00
  2.64838291e+00  1.98243873e+01  1.98243873e+01  1.98243873e+01
  4.34345896e+01  3.18054968e+02  1.98374765e+03  7.27298995e+03]
E1 = -182.45761554937204  E_coul = 54.260400568889686
cycle= 3 E= -128.197214980482  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102947
diis-c [-5.98465539e-08 -3.59287566e-03  6.14866472e-04  1.00297801e+00]
  HOMO = -0.785551847030831  LUMO = 2.62363322888782
  mo_energy =
[-3.27132223e+01 -1.89789614e+00 -7.85551847e-01 -7.85551847e-01
 -7.85551847e-01  2.62363323e+00  2.62363323e+00  2.62363323e+00
  2.64812957e+00  1.98237876e+01  1.98237876e+01  1.98237876e+01
  4.34338763e+01  3.18054337e+02  1.98374714e+03  7.27298947e+03]
E1 = -182.45908528140063  E_coul = 54.26187026039926
cycle= 4 E= -128.197215021001  delta_E= -4.05e-08  |g|= 4.39e-05  |ddm|= 0.000268
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.02785e-05
diis-c [-2.09144293e-10  4.55300494e-04 -1.06200444e-03 -1.59919173e-01
  1.16052588e+00]
  HOMO = -0.785539080524666  LUMO = 2.62364431360586
  mo_energy =
[-3.27131895e+01 -1.89789348e+00 -7.85539081e-01 -7.85539081e-01
 -7.85539081e-01  2.62364431e+00  2.62364431e+00  2.62364431e+00
  2.64813113e+00  1.98238130e+01  1.98238130e+01  1.98238130e+01
  4.34339027e+01  3.18054382e+02  1.98374719e+03  7.27298954e+03]
E1 = -182.4590305434151  E_coul = 54.261815522195036
cycle= 5 E= -128.19721502122  delta_E= -2.19e-10  |g|= 1.65e-06  |ddm|= 2.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4590305434151  E_coul = 54.261815522195036
  HOMO = -0.785538938851932  LUMO = 2.6236444492236
  mo_energy =
[-3.27131892e+01 -1.89789375e+00 -7.85538939e-01 -7.85538939e-01
 -7.85538939e-01  2.62364445e+00  2.62364445e+00  2.62364445e+00
  2.64813089e+00  1.98238132e+01  1.98238132e+01  1.98238132e+01
  4.34339028e+01  3.18054382e+02  1.98374720e+03  7.27298954e+03]
E1 = -182.4590301899626  E_coul = 54.2618151687421
Extra cycle  E= -128.19721502122  delta_E= -3.98e-13  |g|= 3.15e-07  |ddm|= 9.57e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419782e+03 2.15721797e+02 1.42942252e+03 5.65106426e-01
 4.80500102e+01 1.29546539e+01 1.89347133e+00 2.77729590e+00
 1.33318676e+01 6.00499126e-01]
E = -128.19721502122047
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19781998        1
[INPUT] 0    0    [1    /1   ]  215.721797414        1
[INPUT] 0    0    [1    /1   ]  1429.42252052        1
[INPUT] 0    0    [1    /1   ]  0.565106426202       1
[INPUT] 0    0    [1    /1   ]  48.0500102259        1
[INPUT] 0    0    [1    /1   ]  12.9546539062        1
[INPUT] 0    0    [1    /1   ]  1.89347133271        1
[INPUT] 1    0    [1    /1   ]  2.77729590153        1
[INPUT] 1    0    [1    /1   ]  13.3318676273        1
[INPUT] 1    0    [1    /1   ]  0.600499125673       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1978199773644, 1.0]], [0, [215.7217974136531, 1.0]], [0, [1429.4225205241069, 1.0]], [0, [0.5651064262018242, 1.0]], [0, [48.05001022594187, 1.0]], [0, [12.95465390622596, 1.0]], [0, [1.8934713327105008, 1.0]], [1, [2.777295901528648, 1.0]], [1, [13.331867627299077, 1.0]], [1, [0.600499125673286, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19781998]
bas 1, expnt(s) = [215.72179741]
bas 2, expnt(s) = [1429.42252052]
bas 3, expnt(s) = [0.56510643]
bas 4, expnt(s) = [48.05001023]
bas 5, expnt(s) = [12.95465391]
bas 6, expnt(s) = [1.89347133]
bas 7, expnt(s) = [2.7772959]
bas 8, expnt(s) = [13.33186763]
bas 9, expnt(s) = [0.60049913]
CPU time:        60.66
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419782e+03 7.96092737e+02 2.15721797e+02 1.42211772e+02
 1.42942252e+03 5.87334469e+02 5.65106426e-01 1.64669326e+00
 4.80500102e+01 4.61089399e+01 1.29546539e+01 1.72517988e+01
 1.89347133e+00 4.07811131e+00 2.77729590e+00 1.04595279e+01
 1.33318676e+01 7.43187050e+01 6.00499126e-01 1.54214378e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965851845642558
cond(S) = 156.04769816787444
E1 = -183.13656728450732  E_coul = 55.01096381244785
init E= -128.125603472059
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742896810451159  LUMO = 2.65753392039111
  mo_energy =
[-3.25129777e+01 -1.85398583e+00 -7.42896810e-01 -7.42896810e-01
 -7.42896810e-01  2.65753392e+00  2.65753392e+00  2.65753392e+00
  2.68090761e+00  1.99594078e+01  1.99594078e+01  1.99594078e+01
  4.36025248e+01  3.18283886e+02  1.98402242e+03  7.27328878e+03]
E1 = -182.12648659438932  E_coul = 53.93122052099288
cycle= 1 E= -128.195266073396  delta_E= -0.0697  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262332
diis-c [-0.068818  1.      ]
  HOMO = -0.808172308027442  LUMO = 2.60311413994687
  mo_energy =
[-3.27875610e+01 -1.92130562e+00 -8.08172308e-01 -8.08172308e-01
 -8.08172308e-01  2.60311414e+00  2.60311414e+00  2.60311414e+00
  2.62857819e+00  1.97679625e+01  1.97679625e+01  1.97679625e+01
  4.33686808e+01  3.17973069e+02  1.98366012e+03  7.27290092e+03]
E1 = -182.59055136324923  E_coul = 54.3936434978063
cycle= 2 E= -128.196907865443  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102229
diis-c [-4.42841773e-04  2.76714834e-01  7.23285166e-01]
  HOMO = -0.785284762725185  LUMO = 2.62384025253312
  mo_energy =
[-3.27124511e+01 -1.89756810e+00 -7.85284763e-01 -7.85284763e-01
 -7.85284763e-01  2.62384025e+00  2.62384025e+00  2.62384025e+00
  2.64838291e+00  1.98243873e+01  1.98243873e+01  1.98243873e+01
  4.34345896e+01  3.18054968e+02  1.98374765e+03  7.27298995e+03]
E1 = -182.45761554937204  E_coul = 54.260400568889686
cycle= 3 E= -128.197214980482  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102947
diis-c [-5.98465539e-08 -3.59287566e-03  6.14866472e-04  1.00297801e+00]
  HOMO = -0.785551847030831  LUMO = 2.62363322888782
  mo_energy =
[-3.27132223e+01 -1.89789614e+00 -7.85551847e-01 -7.85551847e-01
 -7.85551847e-01  2.62363323e+00  2.62363323e+00  2.62363323e+00
  2.64812957e+00  1.98237876e+01  1.98237876e+01  1.98237876e+01
  4.34338763e+01  3.18054337e+02  1.98374714e+03  7.27298947e+03]
E1 = -182.45908528140063  E_coul = 54.26187026039926
cycle= 4 E= -128.197215021001  delta_E= -4.05e-08  |g|= 4.39e-05  |ddm|= 0.000268
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.02785e-05
diis-c [-2.09144293e-10  4.55300494e-04 -1.06200444e-03 -1.59919173e-01
  1.16052588e+00]
  HOMO = -0.785539080524666  LUMO = 2.62364431360586
  mo_energy =
[-3.27131895e+01 -1.89789348e+00 -7.85539081e-01 -7.85539081e-01
 -7.85539081e-01  2.62364431e+00  2.62364431e+00  2.62364431e+00
  2.64813113e+00  1.98238130e+01  1.98238130e+01  1.98238130e+01
  4.34339027e+01  3.18054382e+02  1.98374719e+03  7.27298954e+03]
E1 = -182.4590305434151  E_coul = 54.261815522195036
cycle= 5 E= -128.19721502122  delta_E= -2.19e-10  |g|= 1.65e-06  |ddm|= 2.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4590305434151  E_coul = 54.261815522195036
  HOMO = -0.785538938851932  LUMO = 2.6236444492236
  mo_energy =
[-3.27131892e+01 -1.89789375e+00 -7.85538939e-01 -7.85538939e-01
 -7.85538939e-01  2.62364445e+00  2.62364445e+00  2.62364445e+00
  2.64813089e+00  1.98238132e+01  1.98238132e+01  1.98238132e+01
  4.34339028e+01  3.18054382e+02  1.98374720e+03  7.27298954e+03]
E1 = -182.4590301899626  E_coul = 54.2618151687421
Extra cycle  E= -128.19721502122  delta_E= -3.98e-13  |g|= 3.15e-07  |ddm|= 9.57e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.04769816787444
E1 = -182.4590301899626  E_coul = 54.2618151687421
init E= -128.19721502122
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.78553894587397  LUMO = 2.62364444114422
  mo_energy =
[-3.27131893e+01 -1.89789383e+00 -7.85538946e-01 -7.85538946e-01
 -7.85538946e-01  2.62364444e+00  2.62364444e+00  2.62364444e+00
  2.64813082e+00  1.98238131e+01  1.98238131e+01  1.98238131e+01
  4.34339027e+01  3.18054382e+02  1.98374720e+03  7.27298954e+03]
E1 = -182.45903034489572  E_coul = 54.26181532367534
cycle= 1 E= -128.19721502122  delta_E= 8.53e-14  |g|= 5.84e-08  |ddm|= 1.84e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45903034489572  E_coul = 54.26181532367534
  HOMO = -0.785538932033158  LUMO = 2.62364445337644
  mo_energy =
[-3.27131892e+01 -1.89789383e+00 -7.85538932e-01 -7.85538932e-01
 -7.85538932e-01  2.62364445e+00  2.62364445e+00  2.62364445e+00
  2.64813082e+00  1.98238132e+01  1.98238132e+01  1.98238132e+01
  4.34339028e+01  3.18054382e+02  1.98374720e+03  7.27298954e+03]
E1 = -182.45903028658114  E_coul = 54.26181526536067
Extra cycle  E= -128.19721502122  delta_E= -8.53e-14  |g|= 1.35e-08  |ddm|= 2.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419782e+03 2.15721797e+02 1.42942252e+03 5.65106426e-01
 4.80500102e+01 1.29546539e+01 1.89347133e+00 2.77729590e+00
 1.33318676e+01 6.00499126e-01]
grad_E = [-7.74819830e-06 -2.03807751e-04  4.45113644e-05  9.08129555e-05
 -1.21754181e-04  1.85389401e-05 -1.94829271e-05 -1.10437501e-04
  1.67636235e-05 -3.51585560e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19784583        1
[INPUT] 0    0    [1    /1   ]  215.721286969        1
[INPUT] 0    0    [1    /1   ]  1429.42240171        1
[INPUT] 0    0    [1    /1   ]  0.565256007589       1
[INPUT] 0    0    [1    /1   ]  48.0563418858        1
[INPUT] 0    0    [1    /1   ]  12.9567106131        1
[INPUT] 0    0    [1    /1   ]  1.89396080878        1
[INPUT] 1    0    [1    /1   ]  2.77712372894        1
[INPUT] 1    0    [1    /1   ]  13.3318754425        1
[INPUT] 1    0    [1    /1   ]  0.600462793953       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1978458322474, 1.0]], [0, [215.7212869692861, 1.0]], [0, [1429.4224017119047, 1.0]], [0, [0.5652560075885564, 1.0]], [0, [48.05634188578905, 1.0]], [0, [12.956710613114659, 1.0]], [0, [1.8939608087761857, 1.0]], [1, [2.7771237289426196, 1.0]], [1, [13.331875442483042, 1.0]], [1, [0.6004627939526616, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19784583]
bas 1, expnt(s) = [215.72128697]
bas 2, expnt(s) = [1429.42240171]
bas 3, expnt(s) = [0.56525601]
bas 4, expnt(s) = [48.05634189]
bas 5, expnt(s) = [12.95671061]
bas 6, expnt(s) = [1.89396081]
bas 7, expnt(s) = [2.77712373]
bas 8, expnt(s) = [13.33187544]
bas 9, expnt(s) = [0.60046279]
CPU time:        62.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419785e+03 7.96092744e+02 2.15721287e+02 1.42211519e+02
 1.42942240e+03 5.87334433e+02 5.65256008e-01 1.64702016e+00
 4.80563419e+01 4.61134968e+01 1.29567106e+01 1.72538530e+01
 1.89396081e+00 4.07890195e+00 2.77712373e+00 1.04587174e+01
 1.33318754e+01 7.43187595e+01 6.00462794e-01 1.54202715e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965856359060803
cond(S) = 156.05550365497132
E1 = -183.136554002151  E_coul = 55.01096401189439
init E= -128.125589990257
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897667920321  LUMO = 2.65731901713311
  mo_energy =
[-3.25129799e+01 -1.85398156e+00 -7.42897668e-01 -7.42897668e-01
 -7.42897668e-01  2.65731902e+00  2.65731902e+00  2.65731902e+00
  2.68207852e+00  1.99587694e+01  1.99587694e+01  1.99587694e+01
  4.36134423e+01  3.18311673e+02  1.98405156e+03  7.27331609e+03]
E1 = -182.1263745434353  E_coul = 53.9311083220888
cycle= 1 E= -128.195266221347  delta_E= -0.0697  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262348
diis-c [-0.06882649  1.        ]
  HOMO = -0.808180086898815  LUMO = 2.60289668775513
  mo_energy =
[-3.27875844e+01 -1.92131534e+00 -8.08180087e-01 -8.08180087e-01
 -8.08180087e-01  2.60289669e+00  2.60289669e+00  2.60289669e+00
  2.62971465e+00  1.97673073e+01  1.97673073e+01  1.97673073e+01
  4.33795643e+01  3.18000843e+02  1.98368925e+03  7.27292823e+03]
E1 = -182.5904928212158  E_coul = 54.393584465278934
cycle= 2 E= -128.196908355937  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102241
diis-c [-4.43088865e-04  2.76724713e-01  7.23275287e-01]
  HOMO = -0.785290242587894  LUMO = 2.62362357768776
  mo_energy =
[-3.27124670e+01 -1.89757527e+00 -7.85290243e-01 -7.85290243e-01
 -7.85290243e-01  2.62362358e+00  2.62362358e+00  2.62362358e+00
  2.64952775e+00  1.98237379e+01  1.98237379e+01  1.98237379e+01
  4.34454824e+01  3.18082751e+02  1.98377680e+03  7.27301728e+03]
E1 = -182.45754147019565  E_coul = 54.26032592440432
cycle= 3 E= -128.197215545791  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102858
diis-c [-6.03278681e-08 -3.59605034e-03  5.94237250e-04  1.00300181e+00]
  HOMO = -0.785557110417521  LUMO = 2.6234167639016
  mo_energy =
[-3.27132376e+01 -1.89790336e+00 -7.85557110e-01 -7.85557110e-01
 -7.85557110e-01  2.62341676e+00  2.62341676e+00  2.62341676e+00
  2.64927428e+00  1.98231385e+01  1.98231385e+01  1.98231385e+01
  4.34447694e+01  3.18082121e+02  1.98377628e+03  7.27301680e+03]
E1 = -182.45901041818905  E_coul = 54.26179483187598
cycle= 4 E= -128.197215586313  delta_E= -4.05e-08  |g|= 4.41e-05  |ddm|= 0.000269
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.05805e-05
diis-c [-2.09902160e-10  4.56009846e-04 -1.06323509e-03 -1.60158389e-01
  1.16076561e+00]
  HOMO = -0.785544293070803  LUMO = 2.62342789219317
  mo_energy =
[-3.27132047e+01 -1.89790070e+00 -7.85544293e-01 -7.85544293e-01
 -7.85544293e-01  2.62342789e+00  2.62342789e+00  2.62342789e+00
  2.64927583e+00  1.98231641e+01  1.98231641e+01  1.98231641e+01
  4.34447959e+01  3.18082166e+02  1.98377634e+03  7.27301686e+03]
E1 = -182.45895545710457  E_coul = 54.26173987057052
cycle= 5 E= -128.197215586534  delta_E= -2.21e-10  |g|= 1.65e-06  |ddm|= 2.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45895545710457  E_coul = 54.26173987057052
  HOMO = -0.785544152709885  LUMO = 2.62342802664344
  mo_energy =
[-3.27132044e+01 -1.89790097e+00 -7.85544153e-01 -7.85544153e-01
 -7.85544153e-01  2.62342803e+00  2.62342803e+00  2.62342803e+00
  2.64927560e+00  1.98231643e+01  1.98231643e+01  1.98231643e+01
  4.34447960e+01  3.18082166e+02  1.98377634e+03  7.27301686e+03]
E1 = -182.45895510976882  E_coul = 54.26173952323449
Extra cycle  E= -128.197215586534  delta_E= -2.84e-13  |g|= 3.15e-07  |ddm|= 9.57e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419785e+03 2.15721287e+02 1.42942240e+03 5.65256008e-01
 4.80563419e+01 1.29567106e+01 1.89396081e+00 2.77712373e+00
 1.33318754e+01 6.00462794e-01]
E = -128.19721558653433
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19784583        1
[INPUT] 0    0    [1    /1   ]  215.721286969        1
[INPUT] 0    0    [1    /1   ]  1429.42240171        1
[INPUT] 0    0    [1    /1   ]  0.565256007589       1
[INPUT] 0    0    [1    /1   ]  48.0563418858        1
[INPUT] 0    0    [1    /1   ]  12.9567106131        1
[INPUT] 0    0    [1    /1   ]  1.89396080878        1
[INPUT] 1    0    [1    /1   ]  2.77712372894        1
[INPUT] 1    0    [1    /1   ]  13.3318754425        1
[INPUT] 1    0    [1    /1   ]  0.600462793953       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1978458322474, 1.0]], [0, [215.7212869692861, 1.0]], [0, [1429.4224017119047, 1.0]], [0, [0.5652560075885564, 1.0]], [0, [48.05634188578905, 1.0]], [0, [12.956710613114659, 1.0]], [0, [1.8939608087761857, 1.0]], [1, [2.7771237289426196, 1.0]], [1, [13.331875442483042, 1.0]], [1, [0.6004627939526616, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19784583]
bas 1, expnt(s) = [215.72128697]
bas 2, expnt(s) = [1429.42240171]
bas 3, expnt(s) = [0.56525601]
bas 4, expnt(s) = [48.05634189]
bas 5, expnt(s) = [12.95671061]
bas 6, expnt(s) = [1.89396081]
bas 7, expnt(s) = [2.77712373]
bas 8, expnt(s) = [13.33187544]
bas 9, expnt(s) = [0.60046279]
CPU time:        63.37
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419785e+03 7.96092744e+02 2.15721287e+02 1.42211519e+02
 1.42942240e+03 5.87334433e+02 5.65256008e-01 1.64702016e+00
 4.80563419e+01 4.61134968e+01 1.29567106e+01 1.72538530e+01
 1.89396081e+00 4.07890195e+00 2.77712373e+00 1.04587174e+01
 1.33318754e+01 7.43187595e+01 6.00462794e-01 1.54202715e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965856359060803
cond(S) = 156.05550365497132
E1 = -183.136554002151  E_coul = 55.01096401189439
init E= -128.125589990257
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897667920321  LUMO = 2.65731901713311
  mo_energy =
[-3.25129799e+01 -1.85398156e+00 -7.42897668e-01 -7.42897668e-01
 -7.42897668e-01  2.65731902e+00  2.65731902e+00  2.65731902e+00
  2.68207852e+00  1.99587694e+01  1.99587694e+01  1.99587694e+01
  4.36134423e+01  3.18311673e+02  1.98405156e+03  7.27331609e+03]
E1 = -182.1263745434353  E_coul = 53.9311083220888
cycle= 1 E= -128.195266221347  delta_E= -0.0697  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262348
diis-c [-0.06882649  1.        ]
  HOMO = -0.808180086898815  LUMO = 2.60289668775513
  mo_energy =
[-3.27875844e+01 -1.92131534e+00 -8.08180087e-01 -8.08180087e-01
 -8.08180087e-01  2.60289669e+00  2.60289669e+00  2.60289669e+00
  2.62971465e+00  1.97673073e+01  1.97673073e+01  1.97673073e+01
  4.33795643e+01  3.18000843e+02  1.98368925e+03  7.27292823e+03]
E1 = -182.5904928212158  E_coul = 54.393584465278934
cycle= 2 E= -128.196908355937  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102241
diis-c [-4.43088865e-04  2.76724713e-01  7.23275287e-01]
  HOMO = -0.785290242587894  LUMO = 2.62362357768776
  mo_energy =
[-3.27124670e+01 -1.89757527e+00 -7.85290243e-01 -7.85290243e-01
 -7.85290243e-01  2.62362358e+00  2.62362358e+00  2.62362358e+00
  2.64952775e+00  1.98237379e+01  1.98237379e+01  1.98237379e+01
  4.34454824e+01  3.18082751e+02  1.98377680e+03  7.27301728e+03]
E1 = -182.45754147019565  E_coul = 54.26032592440432
cycle= 3 E= -128.197215545791  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102858
diis-c [-6.03278681e-08 -3.59605034e-03  5.94237250e-04  1.00300181e+00]
  HOMO = -0.785557110417521  LUMO = 2.6234167639016
  mo_energy =
[-3.27132376e+01 -1.89790336e+00 -7.85557110e-01 -7.85557110e-01
 -7.85557110e-01  2.62341676e+00  2.62341676e+00  2.62341676e+00
  2.64927428e+00  1.98231385e+01  1.98231385e+01  1.98231385e+01
  4.34447694e+01  3.18082121e+02  1.98377628e+03  7.27301680e+03]
E1 = -182.45901041818905  E_coul = 54.26179483187598
cycle= 4 E= -128.197215586313  delta_E= -4.05e-08  |g|= 4.41e-05  |ddm|= 0.000269
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.05805e-05
diis-c [-2.09902160e-10  4.56009846e-04 -1.06323509e-03 -1.60158389e-01
  1.16076561e+00]
  HOMO = -0.785544293070803  LUMO = 2.62342789219317
  mo_energy =
[-3.27132047e+01 -1.89790070e+00 -7.85544293e-01 -7.85544293e-01
 -7.85544293e-01  2.62342789e+00  2.62342789e+00  2.62342789e+00
  2.64927583e+00  1.98231641e+01  1.98231641e+01  1.98231641e+01
  4.34447959e+01  3.18082166e+02  1.98377634e+03  7.27301686e+03]
E1 = -182.45895545710457  E_coul = 54.26173987057052
cycle= 5 E= -128.197215586534  delta_E= -2.21e-10  |g|= 1.65e-06  |ddm|= 2.19e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45895545710457  E_coul = 54.26173987057052
  HOMO = -0.785544152709885  LUMO = 2.62342802664344
  mo_energy =
[-3.27132044e+01 -1.89790097e+00 -7.85544153e-01 -7.85544153e-01
 -7.85544153e-01  2.62342803e+00  2.62342803e+00  2.62342803e+00
  2.64927560e+00  1.98231643e+01  1.98231643e+01  1.98231643e+01
  4.34447960e+01  3.18082166e+02  1.98377634e+03  7.27301686e+03]
E1 = -182.45895510976882  E_coul = 54.26173952323449
Extra cycle  E= -128.197215586534  delta_E= -2.84e-13  |g|= 3.15e-07  |ddm|= 9.57e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.05550365497132
E1 = -182.45895510976882  E_coul = 54.26173952323449
init E= -128.197215586534
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785544159323502  LUMO = 2.62342801893372
  mo_energy =
[-3.27132045e+01 -1.89790105e+00 -7.85544159e-01 -7.85544159e-01
 -7.85544159e-01  2.62342802e+00  2.62342802e+00  2.62342802e+00
  2.64927552e+00  1.98231642e+01  1.98231642e+01  1.98231642e+01
  4.34447959e+01  3.18082166e+02  1.98377634e+03  7.27301686e+03]
E1 = -182.45895526215813  E_coul = 54.26173967562365
cycle= 1 E= -128.197215586534  delta_E= -1.42e-13  |g|= 5.83e-08  |ddm|= 1.84e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45895526215813  E_coul = 54.26173967562365
  HOMO = -0.785544145658313  LUMO = 2.6234280310062
  mo_energy =
[-3.27132045e+01 -1.89790105e+00 -7.85544146e-01 -7.85544146e-01
 -7.85544146e-01  2.62342803e+00  2.62342803e+00  2.62342803e+00
  2.64927552e+00  1.98231642e+01  1.98231642e+01  1.98231642e+01
  4.34447960e+01  3.18082166e+02  1.98377634e+03  7.27301686e+03]
E1 = -182.458955204834  E_coul = 54.261739618299714
Extra cycle  E= -128.197215586534  delta_E= 1.71e-13  |g|= 1.35e-08  |ddm|= 2.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419785e+03 2.15721287e+02 1.42942240e+03 5.65256008e-01
 4.80563419e+01 1.29567106e+01 1.89396081e+00 2.77712373e+00
 1.33318754e+01 6.00462794e-01]
grad_E = [-7.74533237e-06 -2.05221635e-04  4.45280043e-05  1.32592948e-04
 -1.16230089e-04  3.51545013e-05 -1.74433638e-05 -1.89138023e-04
  2.79491382e-05 -1.54123192e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19794485        1
[INPUT] 0    0    [1    /1   ]  215.722343056        1
[INPUT] 0    0    [1    /1   ]  1429.42187157        1
[INPUT] 0    0    [1    /1   ]  0.565467372872       1
[INPUT] 0    0    [1    /1   ]  48.0655390852        1
[INPUT] 0    0    [1    /1   ]  12.9596368583        1
[INPUT] 0    0    [1    /1   ]  1.89465426476        1
[INPUT] 1    0    [1    /1   ]  2.77686778937        1
[INPUT] 1    0    [1    /1   ]  13.3318798035        1
[INPUT] 1    0    [1    /1   ]  0.60040877227        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.197944846953, 1.0]], [0, [215.72234305607444, 1.0]], [0, [1429.42187156582, 1.0]], [0, [0.5654673728718359, 1.0]], [0, [48.065539085165554, 1.0]], [0, [12.95963685827754, 1.0]], [0, [1.8946542647573446, 1.0]], [1, [2.7768677893691933, 1.0]], [1, [13.331879803500325, 1.0]], [1, [0.6004087722702816, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19794485]
bas 1, expnt(s) = [215.72234306]
bas 2, expnt(s) = [1429.42187157]
bas 3, expnt(s) = [0.56546737]
bas 4, expnt(s) = [48.06553909]
bas 5, expnt(s) = [12.95963686]
bas 6, expnt(s) = [1.89465426]
bas 7, expnt(s) = [2.77686779]
bas 8, expnt(s) = [13.3318798]
bas 9, expnt(s) = [0.60040877]
CPU time:        65.66
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419794e+03 7.96092772e+02 2.15722343e+02 1.42212041e+02
 1.42942187e+03 5.87334269e+02 5.65467373e-01 1.64748204e+00
 4.80655391e+01 4.61201156e+01 1.29596369e+01 1.72567755e+01
 1.89465426e+00 4.08002198e+00 2.77686779e+00 1.04575126e+01
 1.33318798e+01 7.43187899e+01 6.00408772e-01 1.54185374e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96586324911734
cond(S) = 156.0670475628572
E1 = -183.1365350733081  E_coul = 55.01096383830616
init E= -128.125571235002
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742898968406359  LUMO = 2.65699954094694
  mo_energy =
[-3.25129833e+01 -1.85397552e+00 -7.42898968e-01 -7.42898968e-01
 -7.42898968e-01  2.65699954e+00  2.65699954e+00  2.65699954e+00
  2.68373582e+00  1.99578125e+01  1.99578125e+01  1.99578125e+01
  4.36290479e+01  3.18353256e+02  1.98409887e+03  7.27336121e+03]
E1 = -182.12619896600629  E_coul = 53.93093233841188
cycle= 1 E= -128.195266627594  delta_E= -0.0697  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262374
diis-c [-0.06883989  1.        ]
  HOMO = -0.808192327648119  LUMO = 2.60257281566142
  mo_energy =
[-3.27876213e+01 -1.92133045e+00 -8.08192328e-01 -8.08192328e-01
 -8.08192328e-01  2.60257282e+00  2.60257282e+00  2.60257282e+00
  2.63132201e+00  1.97663240e+01  1.97663240e+01  1.97663240e+01
  4.33951185e+01  3.18042404e+02  1.98373656e+03  7.27297335e+03]
E1 = -182.5904001392088  E_coul = 54.39349084818259
cycle= 2 E= -128.196909291026  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102259
diis-c [-4.43430757e-04  2.76739832e-01  7.23260168e-01]
  HOMO = -0.785298902969429  LUMO = 2.62330100507072
  mo_energy =
[-3.27124921e+01 -1.89758641e+00 -7.85298903e-01 -7.85298903e-01
 -7.85298903e-01  2.62330101e+00  2.62330101e+00  2.62330101e+00
  2.65114726e+00  1.98227637e+01  1.98227637e+01  1.98227637e+01
  4.34610505e+01  3.18124326e+02  1.98382412e+03  7.27306241e+03]
E1 = -182.45742470250042  E_coul = 54.26020810604628
cycle= 3 E= -128.197216596454  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102724
diis-c [-6.10209533e-08 -3.60063417e-03  5.63773202e-04  1.00303686e+00]
  HOMO = -0.785565443985177  LUMO = 2.62309450857148
  mo_energy =
[-3.27132620e+01 -1.89791456e+00 -7.85565444e-01 -7.85565444e-01
 -7.85565444e-01  2.62309451e+00  2.62309451e+00  2.62309451e+00
  2.65089362e+00  1.98221649e+01  1.98221649e+01  1.98221649e+01
  4.34603380e+01  3.18123696e+02  1.98382361e+03  7.27306194e+03]
E1 = -182.45889243209868  E_coul = 54.26167579512309
cycle= 4 E= -128.197216636976  delta_E= -4.05e-08  |g|= 4.44e-05  |ddm|= 0.000269
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.10124e-05
diis-c [-2.10987748e-10  4.57008898e-04 -1.06482534e-03 -1.60495415e-01
  1.16110323e+00]
  HOMO = -0.785552553954523  LUMO = 2.62310569907905
  mo_energy =
[-3.27132289e+01 -1.89791190e+00 -7.85552554e-01 -7.85552554e-01
 -7.85552554e-01  2.62310570e+00  2.62310570e+00  2.62310570e+00
  2.65089517e+00  1.98221906e+01  1.98221906e+01  1.98221906e+01
  4.34603647e+01  3.18123742e+02  1.98382367e+03  7.27306200e+03]
E1 = -182.45883715182936  E_coul = 54.26162051463005
cycle= 5 E= -128.197216637199  delta_E= -2.24e-10  |g|= 1.65e-06  |ddm|= 2.21e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45883715182936  E_coul = 54.26162051463005
  HOMO = -0.785552415441887  LUMO = 2.62310583188579
  mo_energy =
[-3.27132286e+01 -1.89791217e+00 -7.85552415e-01 -7.85552415e-01
 -7.85552415e-01  2.62310583e+00  2.62310583e+00  2.62310583e+00
  2.65089493e+00  1.98221908e+01  1.98221908e+01  1.98221908e+01
  4.34603648e+01  3.18123742e+02  1.98382367e+03  7.27306200e+03]
E1 = -182.4588368130951  E_coul = 54.26162017589548
Extra cycle  E= -128.1972166372  delta_E= -3.41e-13  |g|= 3.14e-07  |ddm|= 9.57e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419794e+03 2.15722343e+02 1.42942187e+03 5.65467373e-01
 4.80655391e+01 1.29596369e+01 1.89465426e+00 2.77686779e+00
 1.33318798e+01 6.00408772e-01]
E = -128.19721663719963
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19794485        1
[INPUT] 0    0    [1    /1   ]  215.722343056        1
[INPUT] 0    0    [1    /1   ]  1429.42187157        1
[INPUT] 0    0    [1    /1   ]  0.565467372872       1
[INPUT] 0    0    [1    /1   ]  48.0655390852        1
[INPUT] 0    0    [1    /1   ]  12.9596368583        1
[INPUT] 0    0    [1    /1   ]  1.89465426476        1
[INPUT] 1    0    [1    /1   ]  2.77686778937        1
[INPUT] 1    0    [1    /1   ]  13.3318798035        1
[INPUT] 1    0    [1    /1   ]  0.60040877227        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.197944846953, 1.0]], [0, [215.72234305607444, 1.0]], [0, [1429.42187156582, 1.0]], [0, [0.5654673728718359, 1.0]], [0, [48.065539085165554, 1.0]], [0, [12.95963685827754, 1.0]], [0, [1.8946542647573446, 1.0]], [1, [2.7768677893691933, 1.0]], [1, [13.331879803500325, 1.0]], [1, [0.6004087722702816, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19794485]
bas 1, expnt(s) = [215.72234306]
bas 2, expnt(s) = [1429.42187157]
bas 3, expnt(s) = [0.56546737]
bas 4, expnt(s) = [48.06553909]
bas 5, expnt(s) = [12.95963686]
bas 6, expnt(s) = [1.89465426]
bas 7, expnt(s) = [2.77686779]
bas 8, expnt(s) = [13.3318798]
bas 9, expnt(s) = [0.60040877]
CPU time:        66.18
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419794e+03 7.96092772e+02 2.15722343e+02 1.42212041e+02
 1.42942187e+03 5.87334269e+02 5.65467373e-01 1.64748204e+00
 4.80655391e+01 4.61201156e+01 1.29596369e+01 1.72567755e+01
 1.89465426e+00 4.08002198e+00 2.77686779e+00 1.04575126e+01
 1.33318798e+01 7.43187899e+01 6.00408772e-01 1.54185374e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96586324911734
cond(S) = 156.0670475628572
E1 = -183.1365350733081  E_coul = 55.01096383830616
init E= -128.125571235002
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742898968406359  LUMO = 2.65699954094694
  mo_energy =
[-3.25129833e+01 -1.85397552e+00 -7.42898968e-01 -7.42898968e-01
 -7.42898968e-01  2.65699954e+00  2.65699954e+00  2.65699954e+00
  2.68373582e+00  1.99578125e+01  1.99578125e+01  1.99578125e+01
  4.36290479e+01  3.18353256e+02  1.98409887e+03  7.27336121e+03]
E1 = -182.12619896600629  E_coul = 53.93093233841188
cycle= 1 E= -128.195266627594  delta_E= -0.0697  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262374
diis-c [-0.06883989  1.        ]
  HOMO = -0.808192327648119  LUMO = 2.60257281566142
  mo_energy =
[-3.27876213e+01 -1.92133045e+00 -8.08192328e-01 -8.08192328e-01
 -8.08192328e-01  2.60257282e+00  2.60257282e+00  2.60257282e+00
  2.63132201e+00  1.97663240e+01  1.97663240e+01  1.97663240e+01
  4.33951185e+01  3.18042404e+02  1.98373656e+03  7.27297335e+03]
E1 = -182.5904001392088  E_coul = 54.39349084818259
cycle= 2 E= -128.196909291026  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102259
diis-c [-4.43430757e-04  2.76739832e-01  7.23260168e-01]
  HOMO = -0.785298902969429  LUMO = 2.62330100507072
  mo_energy =
[-3.27124921e+01 -1.89758641e+00 -7.85298903e-01 -7.85298903e-01
 -7.85298903e-01  2.62330101e+00  2.62330101e+00  2.62330101e+00
  2.65114726e+00  1.98227637e+01  1.98227637e+01  1.98227637e+01
  4.34610505e+01  3.18124326e+02  1.98382412e+03  7.27306241e+03]
E1 = -182.45742470250042  E_coul = 54.26020810604628
cycle= 3 E= -128.197216596454  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102724
diis-c [-6.10209533e-08 -3.60063417e-03  5.63773202e-04  1.00303686e+00]
  HOMO = -0.785565443985177  LUMO = 2.62309450857148
  mo_energy =
[-3.27132620e+01 -1.89791456e+00 -7.85565444e-01 -7.85565444e-01
 -7.85565444e-01  2.62309451e+00  2.62309451e+00  2.62309451e+00
  2.65089362e+00  1.98221649e+01  1.98221649e+01  1.98221649e+01
  4.34603380e+01  3.18123696e+02  1.98382361e+03  7.27306194e+03]
E1 = -182.45889243209868  E_coul = 54.26167579512309
cycle= 4 E= -128.197216636976  delta_E= -4.05e-08  |g|= 4.44e-05  |ddm|= 0.000269
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.10124e-05
diis-c [-2.10987748e-10  4.57008898e-04 -1.06482534e-03 -1.60495415e-01
  1.16110323e+00]
  HOMO = -0.785552553954523  LUMO = 2.62310569907905
  mo_energy =
[-3.27132289e+01 -1.89791190e+00 -7.85552554e-01 -7.85552554e-01
 -7.85552554e-01  2.62310570e+00  2.62310570e+00  2.62310570e+00
  2.65089517e+00  1.98221906e+01  1.98221906e+01  1.98221906e+01
  4.34603647e+01  3.18123742e+02  1.98382367e+03  7.27306200e+03]
E1 = -182.45883715182936  E_coul = 54.26162051463005
cycle= 5 E= -128.197216637199  delta_E= -2.24e-10  |g|= 1.65e-06  |ddm|= 2.21e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45883715182936  E_coul = 54.26162051463005
  HOMO = -0.785552415441887  LUMO = 2.62310583188579
  mo_energy =
[-3.27132286e+01 -1.89791217e+00 -7.85552415e-01 -7.85552415e-01
 -7.85552415e-01  2.62310583e+00  2.62310583e+00  2.62310583e+00
  2.65089493e+00  1.98221908e+01  1.98221908e+01  1.98221908e+01
  4.34603648e+01  3.18123742e+02  1.98382367e+03  7.27306200e+03]
E1 = -182.4588368130951  E_coul = 54.26162017589548
Extra cycle  E= -128.1972166372  delta_E= -3.41e-13  |g|= 3.14e-07  |ddm|= 9.57e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.0670475628572
E1 = -182.4588368130951  E_coul = 54.26162017589548
init E= -128.1972166372
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.78555242148106  LUMO = 2.62310582469587
  mo_energy =
[-3.27132287e+01 -1.89791226e+00 -7.85552421e-01 -7.85552421e-01
 -7.85552421e-01  2.62310582e+00  2.62310582e+00  2.62310582e+00
  2.65089486e+00  1.98221907e+01  1.98221907e+01  1.98221907e+01
  4.34603647e+01  3.18123742e+02  1.98382367e+03  7.27306200e+03]
E1 = -182.45883696190458  E_coul = 54.26162032470485
cycle= 1 E= -128.1972166372  delta_E= -1.14e-13  |g|= 5.82e-08  |ddm|= 1.84e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45883696190458  E_coul = 54.26162032470485
  HOMO = -0.785552408062951  LUMO = 2.62310583654361
  mo_energy =
[-3.27132287e+01 -1.89791226e+00 -7.85552408e-01 -7.85552408e-01
 -7.85552408e-01  2.62310584e+00  2.62310584e+00  2.62310584e+00
  2.65089486e+00  1.98221908e+01  1.98221908e+01  1.98221908e+01
  4.34603648e+01  3.18123742e+02  1.98382367e+03  7.27306200e+03]
E1 = -182.45883690597458  E_coul = 54.26162026877482
Extra cycle  E= -128.1972166372  delta_E=    0  |g|= 1.33e-08  |ddm|= 3e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14419794e+03 2.15722343e+02 1.42942187e+03 5.65467373e-01
 4.80655391e+01 1.29596369e+01 1.89465426e+00 2.77686779e+00
 1.33318798e+01 6.00408772e-01]
grad_E = [-7.74168967e-06 -2.07175559e-04  4.45496106e-05  1.90735703e-04
 -1.08343741e-04  5.79522503e-05 -1.42597847e-05 -3.05511266e-04
  4.44741741e-05 -3.36507700e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19819897        1
[INPUT] 0    0    [1    /1   ]  215.726974821        1
[INPUT] 0    0    [1    /1   ]  1429.42046299        1
[INPUT] 0    0    [1    /1   ]  0.565779387302       1
[INPUT] 0    0    [1    /1   ]  48.0795381088        1
[INPUT] 0    0    [1    /1   ]  12.9639959027        1
[INPUT] 0    0    [1    /1   ]  1.89568017453        1
[INPUT] 1    0    [1    /1   ]  2.77647923468        1
[INPUT] 1    0    [1    /1   ]  13.3318731615        1
[INPUT] 1    0    [1    /1   ]  0.600326812329       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1981989702367, 1.0]], [0, [215.72697482140438, 1.0]], [0, [1429.420462993767, 1.0]], [0, [0.5657793873015301, 1.0]], [0, [48.079538108765355, 1.0]], [0, [12.96399590268959, 1.0]], [0, [1.8956801745320107, 1.0]], [1, [2.776479234678058, 1.0]], [1, [13.331873161522342, 1.0]], [1, [0.6003268123289983, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19819897]
bas 1, expnt(s) = [215.72697482]
bas 2, expnt(s) = [1429.42046299]
bas 3, expnt(s) = [0.56577939]
bas 4, expnt(s) = [48.07953811]
bas 5, expnt(s) = [12.9639959]
bas 6, expnt(s) = [1.89568017]
bas 7, expnt(s) = [2.77647923]
bas 8, expnt(s) = [13.33187316]
bas 9, expnt(s) = [0.60032681]
CPU time:        68.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419820e+03 7.96092843e+02 2.15726975e+02 1.42214332e+02
 1.42942046e+03 5.87333835e+02 5.65779387e-01 1.64816378e+00
 4.80795381e+01 4.61301896e+01 1.29639959e+01 1.72611286e+01
 1.89568017e+00 4.08167880e+00 2.77647923e+00 1.04556835e+01
 1.33318732e+01 7.43187436e+01 6.00326812e-01 1.54159065e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96587382491127
cond(S) = 156.08497570670275
E1 = -183.13650711079893  E_coul = 55.01096317727086
init E= -128.125543933528
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742900956125496  LUMO = 2.65651484519709
  mo_energy =
[-3.25129884e+01 -1.85396659e+00 -7.42900956e-01 -7.42900956e-01
 -7.42900956e-01  2.65651485e+00  2.65651485e+00  2.65651485e+00
  2.68618634e+00  1.99563460e+01  1.99563460e+01  1.99563460e+01
  4.36523960e+01  3.18418632e+02  1.98417929e+03  7.27343906e+03]
E1 = -182.12592563318594  E_coul = 53.93065807767193
cycle= 1 E= -128.195267555514  delta_E= -0.0697  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262413
diis-c [-0.06886077  1.        ]
  HOMO = -0.808211428299801  LUMO = 2.60208097784764
  mo_energy =
[-3.27876788e+01 -1.92135386e+00 -8.08211428e-01 -8.08211428e-01
 -8.08211428e-01  2.60208098e+00  2.60208098e+00  2.60208098e+00
  2.63369772e+00  1.97648165e+01  1.97648165e+01  1.97648165e+01
  4.34183875e+01  3.18107744e+02  1.98381698e+03  7.27305121e+03]
E1 = -182.59025518550752  E_coul = 54.393344148696045
cycle= 2 E= -128.196911036811  delta_E= -0.00164  |g|= 0.0628  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102288
diis-c [-4.43921179e-04  2.76763269e-01  7.23236731e-01]
  HOMO = -0.785312450439658  LUMO = 2.62281124432123
  mo_energy =
[-3.27125316e+01 -1.89760368e+00 -7.85312450e-01 -7.85312450e-01
 -7.85312450e-01  2.62281124e+00  2.62281124e+00  2.62281124e+00
  2.65354116e+00  1.98212700e+01  1.98212700e+01  1.98212700e+01
  4.34843410e+01  3.18189687e+02  1.98390456e+03  7.27314029e+03]
E1 = -182.45724246156942  E_coul = 54.26002394053519
cycle= 3 E= -128.197218521034  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102518
diis-c [-6.20579241e-08 -3.60751180e-03  5.17436127e-04  1.00309008e+00]
  HOMO = -0.785578486787138  LUMO = 2.62260523777455
  mo_energy =
[-3.27133004e+01 -1.89793190e+00 -7.85578487e-01 -7.85578487e-01
 -7.85578487e-01  2.62260524e+00  2.62260524e+00  2.62260524e+00
  2.65328729e+00  1.98206722e+01  1.98206722e+01  1.98206722e+01
  4.34836294e+01  3.18189059e+02  1.98390405e+03  7.27313982e+03]
E1 = -182.45870826886102  E_coul = 54.2614897073102
cycle= 4 E= -128.197218561551  delta_E= -4.05e-08  |g|= 4.48e-05  |ddm|= 0.00027
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.16532e-05
diis-c [-2.12591169e-10  4.58463823e-04 -1.06696778e-03 -1.60985672e-01
  1.16159418e+00]
  HOMO = -0.785565489056087  LUMO = 2.62261652037527
  mo_energy =
[-3.27132670e+01 -1.89792923e+00 -7.85565489e-01 -7.85565489e-01
 -7.85565489e-01  2.62261652e+00  2.62261652e+00  2.62261652e+00
  2.65328883e+00  1.98206981e+01  1.98206981e+01  1.98206981e+01
  4.34836563e+01  3.18189105e+02  1.98390411e+03  7.27313988e+03]
E1 = -182.45865251500754  E_coul = 54.26143395322842
cycle= 5 E= -128.197218561779  delta_E= -2.28e-10  |g|= 1.66e-06  |ddm|= 2.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45865251500754  E_coul = 54.26143395322842
  HOMO = -0.785565353253067  LUMO = 2.62261665077447
  mo_energy =
[-3.27132667e+01 -1.89792951e+00 -7.85565353e-01 -7.85565353e-01
 -7.85565353e-01  2.62261665e+00  2.62261665e+00  2.62261665e+00
  2.65328859e+00  1.98206983e+01  1.98206983e+01  1.98206983e+01
  4.34836564e+01  3.18189105e+02  1.98390411e+03  7.27313988e+03]
E1 = -182.45865218884867  E_coul = 54.261433627069316
Extra cycle  E= -128.197218561779  delta_E= -2.27e-13  |g|= 3.14e-07  |ddm|= 9.58e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14419820e+03 2.15726975e+02 1.42942046e+03 5.65779387e-01
 4.80795381e+01 1.29639959e+01 1.89568017e+00 2.77647923e+00
 1.33318732e+01 6.00326812e-01]
E = -128.19721856177935
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19819897        1
[INPUT] 0    0    [1    /1   ]  215.726974821        1
[INPUT] 0    0    [1    /1   ]  1429.42046299        1
[INPUT] 0    0    [1    /1   ]  0.565779387302       1
[INPUT] 0    0    [1    /1   ]  48.0795381088        1
[INPUT] 0    0    [1    /1   ]  12.9639959027        1
[INPUT] 0    0    [1    /1   ]  1.89568017453        1
[INPUT] 1    0    [1    /1   ]  2.77647923468        1
[INPUT] 1    0    [1    /1   ]  13.3318731615        1
[INPUT] 1    0    [1    /1   ]  0.600326812329       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1981989702367, 1.0]], [0, [215.72697482140438, 1.0]], [0, [1429.420462993767, 1.0]], [0, [0.5657793873015301, 1.0]], [0, [48.079538108765355, 1.0]], [0, [12.96399590268959, 1.0]], [0, [1.8956801745320107, 1.0]], [1, [2.776479234678058, 1.0]], [1, [13.331873161522342, 1.0]], [1, [0.6003268123289983, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19819897]
bas 1, expnt(s) = [215.72697482]
bas 2, expnt(s) = [1429.42046299]
bas 3, expnt(s) = [0.56577939]
bas 4, expnt(s) = [48.07953811]
bas 5, expnt(s) = [12.9639959]
bas 6, expnt(s) = [1.89568017]
bas 7, expnt(s) = [2.77647923]
bas 8, expnt(s) = [13.33187316]
bas 9, expnt(s) = [0.60032681]
CPU time:        68.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419820e+03 7.96092843e+02 2.15726975e+02 1.42214332e+02
 1.42942046e+03 5.87333835e+02 5.65779387e-01 1.64816378e+00
 4.80795381e+01 4.61301896e+01 1.29639959e+01 1.72611286e+01
 1.89568017e+00 4.08167880e+00 2.77647923e+00 1.04556835e+01
 1.33318732e+01 7.43187436e+01 6.00326812e-01 1.54159065e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96587382491127
cond(S) = 156.08497570670275
E1 = -183.13650711079893  E_coul = 55.01096317727086
init E= -128.125543933528
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742900956125496  LUMO = 2.65651484519709
  mo_energy =
[-3.25129884e+01 -1.85396659e+00 -7.42900956e-01 -7.42900956e-01
 -7.42900956e-01  2.65651485e+00  2.65651485e+00  2.65651485e+00
  2.68618634e+00  1.99563460e+01  1.99563460e+01  1.99563460e+01
  4.36523960e+01  3.18418632e+02  1.98417929e+03  7.27343906e+03]
E1 = -182.12592563318594  E_coul = 53.93065807767193
cycle= 1 E= -128.195267555514  delta_E= -0.0697  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262413
diis-c [-0.06886077  1.        ]
  HOMO = -0.808211428299801  LUMO = 2.60208097784764
  mo_energy =
[-3.27876788e+01 -1.92135386e+00 -8.08211428e-01 -8.08211428e-01
 -8.08211428e-01  2.60208098e+00  2.60208098e+00  2.60208098e+00
  2.63369772e+00  1.97648165e+01  1.97648165e+01  1.97648165e+01
  4.34183875e+01  3.18107744e+02  1.98381698e+03  7.27305121e+03]
E1 = -182.59025518550752  E_coul = 54.393344148696045
cycle= 2 E= -128.196911036811  delta_E= -0.00164  |g|= 0.0628  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102288
diis-c [-4.43921179e-04  2.76763269e-01  7.23236731e-01]
  HOMO = -0.785312450439658  LUMO = 2.62281124432123
  mo_energy =
[-3.27125316e+01 -1.89760368e+00 -7.85312450e-01 -7.85312450e-01
 -7.85312450e-01  2.62281124e+00  2.62281124e+00  2.62281124e+00
  2.65354116e+00  1.98212700e+01  1.98212700e+01  1.98212700e+01
  4.34843410e+01  3.18189687e+02  1.98390456e+03  7.27314029e+03]
E1 = -182.45724246156942  E_coul = 54.26002394053519
cycle= 3 E= -128.197218521034  delta_E= -0.000307  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102518
diis-c [-6.20579241e-08 -3.60751180e-03  5.17436127e-04  1.00309008e+00]
  HOMO = -0.785578486787138  LUMO = 2.62260523777455
  mo_energy =
[-3.27133004e+01 -1.89793190e+00 -7.85578487e-01 -7.85578487e-01
 -7.85578487e-01  2.62260524e+00  2.62260524e+00  2.62260524e+00
  2.65328729e+00  1.98206722e+01  1.98206722e+01  1.98206722e+01
  4.34836294e+01  3.18189059e+02  1.98390405e+03  7.27313982e+03]
E1 = -182.45870826886102  E_coul = 54.2614897073102
cycle= 4 E= -128.197218561551  delta_E= -4.05e-08  |g|= 4.48e-05  |ddm|= 0.00027
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.16532e-05
diis-c [-2.12591169e-10  4.58463823e-04 -1.06696778e-03 -1.60985672e-01
  1.16159418e+00]
  HOMO = -0.785565489056087  LUMO = 2.62261652037527
  mo_energy =
[-3.27132670e+01 -1.89792923e+00 -7.85565489e-01 -7.85565489e-01
 -7.85565489e-01  2.62261652e+00  2.62261652e+00  2.62261652e+00
  2.65328883e+00  1.98206981e+01  1.98206981e+01  1.98206981e+01
  4.34836563e+01  3.18189105e+02  1.98390411e+03  7.27313988e+03]
E1 = -182.45865251500754  E_coul = 54.26143395322842
cycle= 5 E= -128.197218561779  delta_E= -2.28e-10  |g|= 1.66e-06  |ddm|= 2.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45865251500754  E_coul = 54.26143395322842
  HOMO = -0.785565353253067  LUMO = 2.62261665077447
  mo_energy =
[-3.27132667e+01 -1.89792951e+00 -7.85565353e-01 -7.85565353e-01
 -7.85565353e-01  2.62261665e+00  2.62261665e+00  2.62261665e+00
  2.65328859e+00  1.98206983e+01  1.98206983e+01  1.98206983e+01
  4.34836564e+01  3.18189105e+02  1.98390411e+03  7.27313988e+03]
E1 = -182.45865218884867  E_coul = 54.261433627069316
Extra cycle  E= -128.197218561779  delta_E= -2.27e-13  |g|= 3.14e-07  |ddm|= 9.58e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.08497570670275
E1 = -182.45865218884867  E_coul = 54.261433627069316
init E= -128.197218561779
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785565358452756  LUMO = 2.62261664434403
  mo_energy =
[-3.27132668e+01 -1.89792960e+00 -7.85565358e-01 -7.85565358e-01
 -7.85565358e-01  2.62261664e+00  2.62261664e+00  2.62261664e+00
  2.65328852e+00  1.98206982e+01  1.98206982e+01  1.98206982e+01
  4.34836563e+01  3.18189105e+02  1.98390411e+03  7.27313988e+03]
E1 = -182.45865233242012  E_coul = 54.261433770640764
cycle= 1 E= -128.197218561779  delta_E=    0  |g|= 5.8e-08  |ddm|= 1.84e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45865233242012  E_coul = 54.261433770640764
  HOMO = -0.785565345396215  LUMO = 2.62261665586291
  mo_energy =
[-3.27132668e+01 -1.89792960e+00 -7.85565345e-01 -7.85565345e-01
 -7.85565345e-01  2.62261666e+00  2.62261666e+00  2.62261666e+00
  2.65328852e+00  1.98206982e+01  1.98206982e+01  1.98206982e+01
  4.34836564e+01  3.18189105e+02  1.98390411e+03  7.27313988e+03]
E1 = -182.4586522785296  E_coul = 54.261433716750176
Extra cycle  E= -128.197218561779  delta_E= -8.53e-14  |g|= 1.32e-08  |ddm|= 3e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419820e+03 2.15726975e+02 1.42942046e+03 5.65779387e-01
 4.80795381e+01 1.29639959e+01 1.89568017e+00 2.77647923e+00
 1.33318732e+01 6.00326812e-01]
grad_E = [-7.73703030e-06 -2.09974705e-04  4.45781258e-05  2.75342135e-04
 -9.66741262e-05  9.08010529e-05 -9.32931946e-06 -4.81272702e-04
  6.93887714e-05 -6.17658101e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19877753        1
[INPUT] 0    0    [1    /1   ]  215.739524682        1
[INPUT] 0    0    [1    /1   ]  1429.41720608        1
[INPUT] 0    0    [1    /1   ]  0.566249469442       1
[INPUT] 0    0    [1    /1   ]  48.1013848271        1
[INPUT] 0    0    [1    /1   ]  12.970639075         1
[INPUT] 0    0    [1    /1   ]  1.89722928189        1
[INPUT] 1    0    [1    /1   ]  2.77588558222        1
[INPUT] 1    0    [1    /1   ]  13.3318379516        1
[INPUT] 1    0    [1    /1   ]  0.600201758502       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1987775328225, 1.0]], [0, [215.73952468214512, 1.0]], [0, [1429.4172060845412, 1.0]], [0, [0.5662494694420299, 1.0]], [0, [48.10138482714767, 1.0]], [0, [12.970639074972864, 1.0]], [0, [1.8972292818916123, 1.0]], [1, [2.775885582215498, 1.0]], [1, [13.331837951638201, 1.0]], [1, [0.6002017585016539, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19877753]
bas 1, expnt(s) = [215.73952468]
bas 2, expnt(s) = [1429.41720608]
bas 3, expnt(s) = [0.56624947]
bas 4, expnt(s) = [48.10138483]
bas 5, expnt(s) = [12.97063907]
bas 6, expnt(s) = [1.89722928]
bas 7, expnt(s) = [2.77588558]
bas 8, expnt(s) = [13.33183795]
bas 9, expnt(s) = [0.60020176]
CPU time:        71.33
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419878e+03 7.96093004e+02 2.15739525e+02 1.42220536e+02
 1.42941721e+03 5.87332832e+02 5.66249469e-01 1.64919071e+00
 4.81013848e+01 4.61459094e+01 1.29706391e+01 1.72677620e+01
 1.89722928e+00 4.08418013e+00 2.77588558e+00 1.04528891e+01
 1.33318380e+01 7.43184982e+01 6.00201759e-01 1.54118925e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965890002785674
cond(S) = 156.11359403531895
E1 = -183.13646509349962  E_coul = 55.01096181450342
init E= -128.125503278996
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742903987394066  LUMO = 2.65577521309541
  mo_energy =
[-3.25129967e+01 -1.85395305e+00 -7.42903987e-01 -7.42903987e-01
 -7.42903987e-01  2.65577521e+00  2.65577521e+00  2.65577521e+00
  2.68988543e+00  1.99540796e+01  1.99540796e+01  1.99540796e+01
  4.36881409e+01  3.18524351e+02  1.98431963e+03  7.27357675e+03]
E1 = -182.12550384331135  E_coul = 53.93023437808137
cycle= 1 E= -128.19526946523  delta_E= -0.0698  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262474
diis-c [-0.06889286  1.        ]
  HOMO = -0.808240937884774  LUMO = 2.60133012825136
  mo_energy =
[-3.27877682e+01 -1.92138986e+00 -8.08240938e-01 -8.08240938e-01
 -8.08240938e-01  2.60133013e+00  2.60133013e+00  2.60133013e+00
  2.63728318e+00  1.97624867e+01  1.97624867e+01  1.97624867e+01
  4.34540105e+01  3.18213407e+02  1.98395731e+03  7.27318889e+03]
E1 = -182.59003107933307  E_coul = 54.39311687357863
cycle= 2 E= -128.196914205754  delta_E= -0.00164  |g|= 0.0628  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102332
diis-c [-4.44632428e-04  2.76799715e-01  7.23200285e-01]
  HOMO = -0.785333415648074  LUMO = 2.6220636215688
  mo_energy =
[-3.27125933e+01 -1.89763023e+00 -7.85333416e-01 -7.85333416e-01
 -7.85333416e-01  2.62206362e+00  2.62206362e+00  2.62206362e+00
  2.65715425e+00  1.98189616e+01  1.98189616e+01  1.98189616e+01
  4.35199971e+01  3.18295382e+02  1.98404493e+03  7.27327802e+03]
E1 = -182.45696100258635  E_coul = 54.25973903729632
cycle= 3 E= -128.19722196529  delta_E= -0.000308  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102197
diis-c [-6.36382229e-08 -3.61802099e-03  4.46058832e-04  1.00317196e+00]
  HOMO = -0.785598665635428  LUMO = 2.62185837767753
  mo_energy =
[-3.27133602e+01 -1.89795851e+00 -7.85598666e-01 -7.85598666e-01
 -7.85598666e-01  2.62185838e+00  2.62185838e+00  2.62185838e+00
  2.65690006e+00  1.98183653e+01  1.98183653e+01  1.98183653e+01
  4.35192869e+01  3.18294757e+02  1.98404442e+03  7.27327754e+03]
E1 = -182.45842375740358  E_coul = 54.261201751609526
cycle= 4 E= -128.197222005794  delta_E= -4.05e-08  |g|= 4.54e-05  |ddm|= 0.000271
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.26178e-05
diis-c [-2.14981252e-10  4.60600014e-04 -1.06986443e-03 -1.61703611e-01
  1.16231288e+00]
  HOMO = -0.785585506041317  LUMO = 2.62186979854019
  mo_energy =
[-3.27133264e+01 -1.89795585e+00 -7.85585506e-01 -7.85585506e-01
 -7.85585506e-01  2.62186980e+00  2.62186980e+00  2.62186980e+00
  2.65690160e+00  1.98183915e+01  1.98183915e+01  1.98183915e+01
  4.35193141e+01  3.18294803e+02  1.98404449e+03  7.27327761e+03]
E1 = -182.45836729026027  E_coul = 54.26114528423128
cycle= 5 E= -128.197222006029  delta_E= -2.35e-10  |g|= 1.66e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45836729026027  E_coul = 54.26114528423128
  HOMO = -0.785585374273078  LUMO = 2.62186992535744
  mo_energy =
[-3.27133261e+01 -1.89795614e+00 -7.85585374e-01 -7.85585374e-01
 -7.85585374e-01  2.62186993e+00  2.62186993e+00  2.62186993e+00
  2.65690135e+00  1.98183917e+01  1.98183917e+01  1.98183917e+01
  4.35193142e+01  3.18294803e+02  1.98404449e+03  7.27327761e+03]
E1 = -182.45836698275568  E_coul = 54.26114497672632
Extra cycle  E= -128.197222006029  delta_E= -3.69e-13  |g|= 3.13e-07  |ddm|= 9.59e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
exp = [2.14419878e+03 2.15739525e+02 1.42941721e+03 5.66249469e-01
 4.81013848e+01 1.29706391e+01 1.89722928e+00 2.77588558e+00
 1.33318380e+01 6.00201759e-01]
E = -128.19722200602936
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.19877753        1
[INPUT] 0    0    [1    /1   ]  215.739524682        1
[INPUT] 0    0    [1    /1   ]  1429.41720608        1
[INPUT] 0    0    [1    /1   ]  0.566249469442       1
[INPUT] 0    0    [1    /1   ]  48.1013848271        1
[INPUT] 0    0    [1    /1   ]  12.970639075         1
[INPUT] 0    0    [1    /1   ]  1.89722928189        1
[INPUT] 1    0    [1    /1   ]  2.77588558222        1
[INPUT] 1    0    [1    /1   ]  13.3318379516        1
[INPUT] 1    0    [1    /1   ]  0.600201758502       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.1987775328225, 1.0]], [0, [215.73952468214512, 1.0]], [0, [1429.4172060845412, 1.0]], [0, [0.5662494694420299, 1.0]], [0, [48.10138482714767, 1.0]], [0, [12.970639074972864, 1.0]], [0, [1.8972292818916123, 1.0]], [1, [2.775885582215498, 1.0]], [1, [13.331837951638201, 1.0]], [1, [0.6002017585016539, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.19877753]
bas 1, expnt(s) = [215.73952468]
bas 2, expnt(s) = [1429.41720608]
bas 3, expnt(s) = [0.56624947]
bas 4, expnt(s) = [48.10138483]
bas 5, expnt(s) = [12.97063907]
bas 6, expnt(s) = [1.89722928]
bas 7, expnt(s) = [2.77588558]
bas 8, expnt(s) = [13.33183795]
bas 9, expnt(s) = [0.60020176]
CPU time:        71.90
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14419878e+03 7.96093004e+02 2.15739525e+02 1.42220536e+02
 1.42941721e+03 5.87332832e+02 5.66249469e-01 1.64919071e+00
 4.81013848e+01 4.61459094e+01 1.29706391e+01 1.72677620e+01
 1.89722928e+00 4.08418013e+00 2.77588558e+00 1.04528891e+01
 1.33318380e+01 7.43184982e+01 6.00201759e-01 1.54118925e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965890002785674
cond(S) = 156.11359403531895
E1 = -183.13646509349962  E_coul = 55.01096181450342
init E= -128.125503278996
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742903987394066  LUMO = 2.65577521309541
  mo_energy =
[-3.25129967e+01 -1.85395305e+00 -7.42903987e-01 -7.42903987e-01
 -7.42903987e-01  2.65577521e+00  2.65577521e+00  2.65577521e+00
  2.68988543e+00  1.99540796e+01  1.99540796e+01  1.99540796e+01
  4.36881409e+01  3.18524351e+02  1.98431963e+03  7.27357675e+03]
E1 = -182.12550384331135  E_coul = 53.93023437808137
cycle= 1 E= -128.19526946523  delta_E= -0.0698  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262474
diis-c [-0.06889286  1.        ]
  HOMO = -0.808240937884774  LUMO = 2.60133012825136
  mo_energy =
[-3.27877682e+01 -1.92138986e+00 -8.08240938e-01 -8.08240938e-01
 -8.08240938e-01  2.60133013e+00  2.60133013e+00  2.60133013e+00
  2.63728318e+00  1.97624867e+01  1.97624867e+01  1.97624867e+01
  4.34540105e+01  3.18213407e+02  1.98395731e+03  7.27318889e+03]
E1 = -182.59003107933307  E_coul = 54.39311687357863
cycle= 2 E= -128.196914205754  delta_E= -0.00164  |g|= 0.0628  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102332
diis-c [-4.44632428e-04  2.76799715e-01  7.23200285e-01]
  HOMO = -0.785333415648074  LUMO = 2.6220636215688
  mo_energy =
[-3.27125933e+01 -1.89763023e+00 -7.85333416e-01 -7.85333416e-01
 -7.85333416e-01  2.62206362e+00  2.62206362e+00  2.62206362e+00
  2.65715425e+00  1.98189616e+01  1.98189616e+01  1.98189616e+01
  4.35199971e+01  3.18295382e+02  1.98404493e+03  7.27327802e+03]
E1 = -182.45696100258635  E_coul = 54.25973903729632
cycle= 3 E= -128.19722196529  delta_E= -0.000308  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00102197
diis-c [-6.36382229e-08 -3.61802099e-03  4.46058832e-04  1.00317196e+00]
  HOMO = -0.785598665635428  LUMO = 2.62185837767753
  mo_energy =
[-3.27133602e+01 -1.89795851e+00 -7.85598666e-01 -7.85598666e-01
 -7.85598666e-01  2.62185838e+00  2.62185838e+00  2.62185838e+00
  2.65690006e+00  1.98183653e+01  1.98183653e+01  1.98183653e+01
  4.35192869e+01  3.18294757e+02  1.98404442e+03  7.27327754e+03]
E1 = -182.45842375740358  E_coul = 54.261201751609526
cycle= 4 E= -128.197222005794  delta_E= -4.05e-08  |g|= 4.54e-05  |ddm|= 0.000271
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.26178e-05
diis-c [-2.14981252e-10  4.60600014e-04 -1.06986443e-03 -1.61703611e-01
  1.16231288e+00]
  HOMO = -0.785585506041317  LUMO = 2.62186979854019
  mo_energy =
[-3.27133264e+01 -1.89795585e+00 -7.85585506e-01 -7.85585506e-01
 -7.85585506e-01  2.62186980e+00  2.62186980e+00  2.62186980e+00
  2.65690160e+00  1.98183915e+01  1.98183915e+01  1.98183915e+01
  4.35193141e+01  3.18294803e+02  1.98404449e+03  7.27327761e+03]
E1 = -182.45836729026027  E_coul = 54.26114528423128
cycle= 5 E= -128.197222006029  delta_E= -2.35e-10  |g|= 1.66e-06  |ddm|= 2.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45836729026027  E_coul = 54.26114528423128
  HOMO = -0.785585374273078  LUMO = 2.62186992535744
  mo_energy =
[-3.27133261e+01 -1.89795614e+00 -7.85585374e-01 -7.85585374e-01
 -7.85585374e-01  2.62186993e+00  2.62186993e+00  2.62186993e+00
  2.65690135e+00  1.98183917e+01  1.98183917e+01  1.98183917e+01
  4.35193142e+01  3.18294803e+02  1.98404449e+03  7.27327761e+03]
E1 = -182.45836698275568  E_coul = 54.26114497672632
Extra cycle  E= -128.197222006029  delta_E= -3.69e-13  |g|= 3.13e-07  |ddm|= 9.59e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.11359403531895
E1 = -182.45836698275568  E_coul = 54.26114497672632
init E= -128.197222006029
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785585378228775  LUMO = 2.62186992005213
  mo_energy =
[-3.27133262e+01 -1.89795622e+00 -7.85585378e-01 -7.85585378e-01
 -7.85585378e-01  2.62186992e+00  2.62186992e+00  2.62186992e+00
  2.65690128e+00  1.98183916e+01  1.98183916e+01  1.98183916e+01
  4.35193141e+01  3.18294803e+02  1.98404449e+03  7.27327761e+03]
E1 = -182.45836711855037  E_coul = 54.26114511252093
cycle= 1 E= -128.197222006029  delta_E= -8.53e-14  |g|= 5.77e-08  |ddm|= 1.83e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45836711855037  E_coul = 54.26114511252093
  HOMO = -0.785585365709278  LUMO = 2.62186993108263
  mo_energy =
[-3.27133261e+01 -1.89795622e+00 -7.85585366e-01 -7.85585366e-01
 -7.85585366e-01  2.62186993e+00  2.62186993e+00  2.62186993e+00
  2.65690128e+00  1.98183916e+01  1.98183916e+01  1.98183916e+01
  4.35193141e+01  3.18294803e+02  1.98404449e+03  7.27327761e+03]
E1 = -182.45836706768583  E_coul = 54.26114506165645
Extra cycle  E= -128.197222006029  delta_E= 5.68e-14  |g|= 1.29e-08  |ddm|= 3e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14419878e+03 2.15739525e+02 1.42941721e+03 5.66249469e-01
 4.81013848e+01 1.29706391e+01 1.89722928e+00 2.77588558e+00
 1.33318380e+01 6.00201759e-01]
grad_E = [-7.73132738e-06 -2.14027442e-04  4.46148732e-05  4.00873748e-04
 -7.91555217e-05  1.39187701e-04 -1.78157418e-06 -7.48304574e-04
  1.07143080e-04 -1.05010895e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.20001669        1
[INPUT] 0    0    [1    /1   ]  215.76891869         1
[INPUT] 0    0    [1    /1   ]  1429.41016778        1
[INPUT] 0    0    [1    /1   ]  0.566955084645       1
[INPUT] 0    0    [1    /1   ]  48.135596343         1
[INPUT] 0    0    [1    /1   ]  12.9807574742        1
[INPUT] 0    0    [1    /1   ]  1.89956113177        1
[INPUT] 1    0    [1    /1   ]  2.77499091071        1
[INPUT] 1    0    [1    /1   ]  13.3317358603        1
[INPUT] 1    0    [1    /1   ]  0.600013688356       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.2000166852936, 1.0]], [0, [215.7689186898294, 1.0]], [0, [1429.4101677846354, 1.0]], [0, [0.5669550846454854, 1.0]], [0, [48.13559634303508, 1.0]], [0, [12.98075747420838, 1.0]], [0, [1.899561131773076, 1.0]], [1, [2.7749909107136514, 1.0]], [1, [13.331735860271198, 1.0]], [1, [0.6000136883558652, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.20001669]
bas 1, expnt(s) = [215.76891869]
bas 2, expnt(s) = [1429.41016778]
bas 3, expnt(s) = [0.56695508]
bas 4, expnt(s) = [48.13559634]
bas 5, expnt(s) = [12.98075747]
bas 6, expnt(s) = [1.89956113]
bas 7, expnt(s) = [2.77499091]
bas 8, expnt(s) = [13.33173586]
bas 9, expnt(s) = [0.60001369]
CPU time:        74.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14420002e+03 7.96093349e+02 2.15768919e+02 1.42235069e+02
 1.42941017e+03 5.87330663e+02 5.66955085e-01 1.65073179e+00
 4.81355963e+01 4.61705227e+01 1.29807575e+01 1.72778640e+01
 1.89956113e+00 4.08794440e+00 2.77499091e+00 1.04486781e+01
 1.33317359e+01 7.43177869e+01 6.00013688e-01 1.54058562e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965914216911502
cond(S) = 156.1595965182593
E1 = -183.13640227911202  E_coul = 55.01095945236922
init E= -128.125442826743
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742908513563446  LUMO = 2.65466262016322
  mo_energy =
[-3.25130100e+01 -1.85393251e+00 -7.42908514e-01 -7.42908514e-01
 -7.42908514e-01  2.65466262e+00  2.65466262e+00  2.65466262e+00
  2.69545222e+00  1.99506138e+01  1.99506138e+01  1.99506138e+01
  4.37428753e+01  3.18696700e+02  1.98456660e+03  7.27382201e+03]
E1 = -182.12486842273157  E_coul = 53.92959529384938
cycle= 1 E= -128.195273128882  delta_E= -0.0698  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262566
diis-c [-0.06894081  1.        ]
  HOMO = -0.808285405042526  LUMO = 2.60020060750032
  mo_energy =
[-3.27879038e+01 -1.92144386e+00 -8.08285405e-01 -8.08285405e-01
 -8.08285405e-01  2.60020061e+00  2.60020061e+00  2.60020061e+00
  2.64267888e+00  1.97589258e+01  1.97589258e+01  1.97589258e+01
  4.35085597e+01  3.18385667e+02  1.98420425e+03  7.27343416e+03]
E1 = -182.5896933866503  E_coul = 54.392773618905174
cycle= 2 E= -128.196919767745  delta_E= -0.00165  |g|= 0.0628  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102397
diis-c [-4.45645618e-04  2.76855596e-01  7.23144404e-01]
  HOMO = -0.785365049342606  LUMO = 2.62093892578637
  mo_energy =
[-3.27126872e+01 -1.89767002e+00 -7.85365049e-01 -7.85365049e-01
 -7.85365049e-01  2.62093893e+00  2.62093893e+00  2.62093893e+00
  2.66259155e+00  1.98154326e+01  1.98154326e+01  1.98154326e+01
  4.35745964e+01  3.18467691e+02  1.98429192e+03  7.27352334e+03]
E1 = -182.45653709380886  E_coul = 54.25930915152633
cycle= 3 E= -128.197227942283  delta_E= -0.000308  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101705
diis-c [-6.60381983e-08 -3.63402137e-03  3.36939262e-04  1.00329708e+00]
  HOMO = -0.785629085379076  LUMO = 2.62073485698636
  mo_energy =
[-3.27134512e+01 -1.89799837e+00 -7.85629085e-01 -7.85629085e-01
 -7.85629085e-01  2.62073486e+00  2.62073486e+00  2.62073486e+00
  2.66233691e+00  1.98148386e+01  1.98148386e+01  1.98148386e+01
  4.35738883e+01  3.18467070e+02  1.98429143e+03  7.27352287e+03]
E1 = -182.4579950439163  E_coul = 54.26076706115375
cycle= 4 E= -128.197227982763  delta_E= -4.05e-08  |g|= 4.64e-05  |ddm|= 0.000272
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.40569e-05
diis-c [-2.18487715e-10  4.63673982e-04 -1.07361746e-03 -1.62732154e-01
  1.16334210e+00]
  HOMO = -0.785615684929352  LUMO = 2.62074648332944
  mo_energy =
[-3.27134168e+01 -1.89799572e+00 -7.85615685e-01 -7.85615685e-01
 -7.85615685e-01  2.62074648e+00  2.62074648e+00  2.62074648e+00
  2.66233842e+00  1.98148653e+01  1.98148653e+01  1.98148653e+01
  4.35739160e+01  3.18467117e+02  1.98429149e+03  7.27352294e+03]
E1 = -182.45793751178337  E_coul = 54.26070952877575
cycle= 5 E= -128.197227983008  delta_E= -2.45e-10  |g|= 1.66e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45793751178337  E_coul = 54.26070952877575
  HOMO = -0.785615559103351  LUMO = 2.62074660487675
  mo_energy =
[-3.27134165e+01 -1.89799601e+00 -7.85615559e-01 -7.85615559e-01
 -7.85615559e-01  2.62074660e+00  2.62074660e+00  2.62074660e+00
  2.66233818e+00  1.98148654e+01  1.98148654e+01  1.98148654e+01
  4.35739161e+01  3.18467117e+02  1.98429149e+03  7.27352294e+03]
E1 = -182.45793723159946  E_coul = 54.26070924859139
Extra cycle  E= -128.197227983008  delta_E= -4.55e-13  |g|= 3.12e-07  |ddm|= 9.6e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14420002e+03 2.15768919e+02 1.42941017e+03 5.66955085e-01
 4.81355963e+01 1.29807575e+01 1.89956113e+00 2.77499091e+00
 1.33317359e+01 6.00013688e-01]
E = -128.19722798300808
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:45:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.20001669        1
[INPUT] 0    0    [1    /1   ]  215.76891869         1
[INPUT] 0    0    [1    /1   ]  1429.41016778        1
[INPUT] 0    0    [1    /1   ]  0.566955084645       1
[INPUT] 0    0    [1    /1   ]  48.135596343         1
[INPUT] 0    0    [1    /1   ]  12.9807574742        1
[INPUT] 0    0    [1    /1   ]  1.89956113177        1
[INPUT] 1    0    [1    /1   ]  2.77499091071        1
[INPUT] 1    0    [1    /1   ]  13.3317358603        1
[INPUT] 1    0    [1    /1   ]  0.600013688356       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.2000166852936, 1.0]], [0, [215.7689186898294, 1.0]], [0, [1429.4101677846354, 1.0]], [0, [0.5669550846454854, 1.0]], [0, [48.13559634303508, 1.0]], [0, [12.98075747420838, 1.0]], [0, [1.899561131773076, 1.0]], [1, [2.7749909107136514, 1.0]], [1, [13.331735860271198, 1.0]], [1, [0.6000136883558652, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.20001669]
bas 1, expnt(s) = [215.76891869]
bas 2, expnt(s) = [1429.41016778]
bas 3, expnt(s) = [0.56695508]
bas 4, expnt(s) = [48.13559634]
bas 5, expnt(s) = [12.98075747]
bas 6, expnt(s) = [1.89956113]
bas 7, expnt(s) = [2.77499091]
bas 8, expnt(s) = [13.33173586]
bas 9, expnt(s) = [0.60001369]
CPU time:        74.86
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14420002e+03 7.96093349e+02 2.15768919e+02 1.42235069e+02
 1.42941017e+03 5.87330663e+02 5.66955085e-01 1.65073179e+00
 4.81355963e+01 4.61705227e+01 1.29807575e+01 1.72778640e+01
 1.89956113e+00 4.08794440e+00 2.77499091e+00 1.04486781e+01
 1.33317359e+01 7.43177869e+01 6.00013688e-01 1.54058562e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965914216911502
cond(S) = 156.1595965182593
E1 = -183.13640227911202  E_coul = 55.01095945236922
init E= -128.125442826743
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742908513563446  LUMO = 2.65466262016322
  mo_energy =
[-3.25130100e+01 -1.85393251e+00 -7.42908514e-01 -7.42908514e-01
 -7.42908514e-01  2.65466262e+00  2.65466262e+00  2.65466262e+00
  2.69545222e+00  1.99506138e+01  1.99506138e+01  1.99506138e+01
  4.37428753e+01  3.18696700e+02  1.98456660e+03  7.27382201e+03]
E1 = -182.12486842273157  E_coul = 53.92959529384938
cycle= 1 E= -128.195273128882  delta_E= -0.0698  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262566
diis-c [-0.06894081  1.        ]
  HOMO = -0.808285405042526  LUMO = 2.60020060750032
  mo_energy =
[-3.27879038e+01 -1.92144386e+00 -8.08285405e-01 -8.08285405e-01
 -8.08285405e-01  2.60020061e+00  2.60020061e+00  2.60020061e+00
  2.64267888e+00  1.97589258e+01  1.97589258e+01  1.97589258e+01
  4.35085597e+01  3.18385667e+02  1.98420425e+03  7.27343416e+03]
E1 = -182.5896933866503  E_coul = 54.392773618905174
cycle= 2 E= -128.196919767745  delta_E= -0.00165  |g|= 0.0628  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102397
diis-c [-4.45645618e-04  2.76855596e-01  7.23144404e-01]
  HOMO = -0.785365049342606  LUMO = 2.62093892578637
  mo_energy =
[-3.27126872e+01 -1.89767002e+00 -7.85365049e-01 -7.85365049e-01
 -7.85365049e-01  2.62093893e+00  2.62093893e+00  2.62093893e+00
  2.66259155e+00  1.98154326e+01  1.98154326e+01  1.98154326e+01
  4.35745964e+01  3.18467691e+02  1.98429192e+03  7.27352334e+03]
E1 = -182.45653709380886  E_coul = 54.25930915152633
cycle= 3 E= -128.197227942283  delta_E= -0.000308  |g|= 0.000764  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00101705
diis-c [-6.60381983e-08 -3.63402137e-03  3.36939262e-04  1.00329708e+00]
  HOMO = -0.785629085379076  LUMO = 2.62073485698636
  mo_energy =
[-3.27134512e+01 -1.89799837e+00 -7.85629085e-01 -7.85629085e-01
 -7.85629085e-01  2.62073486e+00  2.62073486e+00  2.62073486e+00
  2.66233691e+00  1.98148386e+01  1.98148386e+01  1.98148386e+01
  4.35738883e+01  3.18467070e+02  1.98429143e+03  7.27352287e+03]
E1 = -182.4579950439163  E_coul = 54.26076706115375
cycle= 4 E= -128.197227982763  delta_E= -4.05e-08  |g|= 4.64e-05  |ddm|= 0.000272
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.40569e-05
diis-c [-2.18487715e-10  4.63673982e-04 -1.07361746e-03 -1.62732154e-01
  1.16334210e+00]
  HOMO = -0.785615684929352  LUMO = 2.62074648332944
  mo_energy =
[-3.27134168e+01 -1.89799572e+00 -7.85615685e-01 -7.85615685e-01
 -7.85615685e-01  2.62074648e+00  2.62074648e+00  2.62074648e+00
  2.66233842e+00  1.98148653e+01  1.98148653e+01  1.98148653e+01
  4.35739160e+01  3.18467117e+02  1.98429149e+03  7.27352294e+03]
E1 = -182.45793751178337  E_coul = 54.26070952877575
cycle= 5 E= -128.197227983008  delta_E= -2.45e-10  |g|= 1.66e-06  |ddm|= 2.32e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45793751178337  E_coul = 54.26070952877575
  HOMO = -0.785615559103351  LUMO = 2.62074660487675
  mo_energy =
[-3.27134165e+01 -1.89799601e+00 -7.85615559e-01 -7.85615559e-01
 -7.85615559e-01  2.62074660e+00  2.62074660e+00  2.62074660e+00
  2.66233818e+00  1.98148654e+01  1.98148654e+01  1.98148654e+01
  4.35739161e+01  3.18467117e+02  1.98429149e+03  7.27352294e+03]
E1 = -182.45793723159946  E_coul = 54.26070924859139
Extra cycle  E= -128.197227983008  delta_E= -4.55e-13  |g|= 3.12e-07  |ddm|= 9.6e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.1595965182593
E1 = -182.45793723159946  E_coul = 54.26070924859139
init E= -128.197227983008
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785615561240319  LUMO = 2.62074660121577
  mo_energy =
[-3.27134166e+01 -1.89799609e+00 -7.85615561e-01 -7.85615561e-01
 -7.85615561e-01  2.62074660e+00  2.62074660e+00  2.62074660e+00
  2.66233810e+00  1.98148654e+01  1.98148654e+01  1.98148654e+01
  4.35739160e+01  3.18467117e+02  1.98429149e+03  7.27352294e+03]
E1 = -182.45793735598778  E_coul = 54.26070937297981
cycle= 1 E= -128.197227983008  delta_E= 1.14e-13  |g|= 5.74e-08  |ddm|= 1.82e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45793735598778  E_coul = 54.26070937297981
  HOMO = -0.785615549509058  LUMO = 2.62074661152983
  mo_energy =
[-3.27134166e+01 -1.89799609e+00 -7.85615550e-01 -7.85615550e-01
 -7.85615550e-01  2.62074661e+00  2.62074661e+00  2.62074661e+00
  2.66233810e+00  1.98148654e+01  1.98148654e+01  1.98148654e+01
  4.35739161e+01  3.18467117e+02  1.98429149e+03  7.27352294e+03]
E1 = -182.45793730956015  E_coul = 54.26070932655216
Extra cycle  E= -128.197227983008  delta_E= -2.84e-14  |g|= 1.25e-08  |ddm|= 3.01e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14420002e+03 2.15768919e+02 1.42941017e+03 5.66955085e-01
 4.81355963e+01 1.29807575e+01 1.89956113e+00 2.77499091e+00
 1.33317359e+01 6.00013688e-01]
grad_E = [-7.72528179e-06 -2.19786662e-04  4.46581560e-05  5.85792452e-04
 -5.31047551e-05  2.10072033e-04  9.48160494e-06 -1.14802875e-03
  1.63449820e-04 -1.70271069e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.20253578        1
[INPUT] 0    0    [1    /1   ]  215.832117883        1
[INPUT] 0    0    [1    /1   ]  1429.39577368        1
[INPUT] 0    0    [1    /1   ]  0.567977500752       1
[INPUT] 0    0    [1    /1   ]  48.1879166831        1
[INPUT] 0    0    [1    /1   ]  12.9957051394        1
[INPUT] 0    0    [1    /1   ]  1.90295372258        1
[INPUT] 1    0    [1    /1   ]  2.77370129336        1
[INPUT] 1    0    [1    /1   ]  13.3314903274        1
[INPUT] 1    0    [1    /1   ]  0.599743450539       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.202535775131, 1.0]], [0, [215.8321178827298, 1.0]], [0, [1429.3957736786822, 1.0]], [0, [0.5679775007519908, 1.0]], [0, [48.18791668306234, 1.0]], [0, [12.995705139399792, 1.0]], [0, [1.9029537225841842, 1.0]], [1, [2.7737012933644314, 1.0]], [1, [13.33149032742107, 1.0]], [1, [0.599743450539226, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.20253578]
bas 1, expnt(s) = [215.83211788]
bas 2, expnt(s) = [1429.39577368]
bas 3, expnt(s) = [0.5679775]
bas 4, expnt(s) = [48.18791668]
bas 5, expnt(s) = [12.99570514]
bas 6, expnt(s) = [1.90295372]
bas 7, expnt(s) = [2.77370129]
bas 8, expnt(s) = [13.33149033]
bas 9, expnt(s) = [0.59974345]
CPU time:        77.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14420254e+03 7.96094050e+02 2.15832118e+02 1.42266314e+02
 1.42939577e+03 5.87326227e+02 5.67977501e-01 1.65296392e+00
 4.81879167e+01 4.62081560e+01 1.29957051e+01 1.72927838e+01
 1.90295372e+00 4.09341894e+00 2.77370129e+00 1.04426087e+01
 1.33314903e+01 7.43160760e+01 5.99743451e-01 1.53971835e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965948565729322
cond(S) = 156.23219639508758
E1 = -183.13631201327644  E_coul = 55.01095589721774
init E= -128.125356116059
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742914922194718  LUMO = 2.65306335005057
  mo_energy =
[-3.25130309e+01 -1.85390225e+00 -7.42914922e-01 -7.42914922e-01
 -7.42914922e-01  2.65306335e+00  2.65306335e+00  2.65306335e+00
  2.70354825e+00  1.99455179e+01  1.99455179e+01  1.99455179e+01
  4.38242887e+01  3.18973035e+02  1.98499522e+03  7.27425268e+03]
E1 = -182.12396187031578  E_coul = 53.92868198632548
cycle= 1 E= -128.19527988399  delta_E= -0.0699  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262694
diis-c [-0.0690083  1.       ]
  HOMO = -0.8083488266002  LUMO = 2.59857748539562
  mo_energy =
[-3.27880993e+01 -1.92152049e+00 -8.08348827e-01 -8.08348827e-01
 -8.08348827e-01  2.59857749e+00  2.59857749e+00  2.59857749e+00
  2.65052725e+00  1.97536944e+01  1.97536944e+01  1.97536944e+01
  4.35897043e+01  3.18661874e+02  1.98463286e+03  7.27386484e+03]
E1 = -182.58921228739635  E_coul = 54.39228304586006
cycle= 2 E= -128.196929241536  delta_E= -0.00165  |g|= 0.0629  |ddm|= 0.0646
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102492
diis-c [-4.47004374e-04  2.76937751e-01  7.23062249e-01]
  HOMO = -0.78541022621604  LUMO = 2.61932253491584
  mo_energy =
[-3.27128234e+01 -1.89772640e+00 -7.85410226e-01 -7.85410226e-01
 -7.85410226e-01  2.61932253e+00  2.61932253e+00  2.61932253e+00
  2.67050012e+00  1.98102466e+01  1.98102466e+01  1.98102466e+01
  4.36558133e+01  3.18743967e+02  1.98472060e+03  7.27395409e+03]
E1 = -182.4559331573702  E_coul = 54.258695147155656
cycle= 3 E= -128.197238010215  delta_E= -0.000309  |g|= 0.000763  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010098
diis-c [-6.95593147e-08 -3.65757345e-03  1.76133095e-04  1.00348144e+00]
  HOMO = -0.78567245590706  LUMO = 2.61912020940707
  mo_energy =
[-3.27135830e+01 -1.89805478e+00 -7.85672456e-01 -7.85672456e-01
 -7.85672456e-01  2.61912021e+00  2.61912021e+00  2.61912021e+00
  2.67024488e+00  1.98096561e+01  1.98096561e+01  1.98096561e+01
  4.36551085e+01  3.18743353e+02  1.98472011e+03  7.27395364e+03]
E1 = -182.457383795087  E_coul = 54.26014574443411
cycle= 4 E= -128.197238050653  delta_E= -4.04e-08  |g|= 4.77e-05  |ddm|= 0.000274
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.61154e-05
diis-c [-2.23374618e-10  4.67853766e-04 -1.07795073e-03 -1.64120257e-01
  1.16473035e+00]
  HOMO = -0.785658712248004  LUMO = 2.61913212807254
  mo_energy =
[-3.27135477e+01 -1.89805214e+00 -7.85658712e-01 -7.85658712e-01
 -7.85658712e-01  2.61913213e+00  2.61913213e+00  2.61913213e+00
  2.67024637e+00  1.98096834e+01  1.98096834e+01  1.98096834e+01
  4.36551370e+01  3.18743402e+02  1.98472018e+03  7.27395371e+03]
E1 = -182.45732473756635  E_coul = 54.26008668665344
cycle= 5 E= -128.197238050913  delta_E= -2.6e-10  |g|= 1.66e-06  |ddm|= 2.4e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45732473756635  E_coul = 54.26008668665344
  HOMO = -0.785658594785457  LUMO = 2.6191322422133
  mo_energy =
[-3.27135475e+01 -1.89805243e+00 -7.85658595e-01 -7.85658595e-01
 -7.85658595e-01  2.61913224e+00  2.61913224e+00  2.61913224e+00
  2.67024612e+00  1.98096836e+01  1.98096836e+01  1.98096836e+01
  4.36551370e+01  3.18743402e+02  1.98472018e+03  7.27395371e+03]
E1 = -182.45732449552483  E_coul = 54.26008644461167
Extra cycle  E= -128.197238050913  delta_E= -2.27e-13  |g|= 3.11e-07  |ddm|= 9.62e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14420254e+03 2.15832118e+02 1.42939577e+03 5.67977501e-01
 4.81879167e+01 1.29957051e+01 1.90295372e+00 2.77370129e+00
 1.33314903e+01 5.99743451e-01]
E = -128.19723805091314
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.20253578        1
[INPUT] 0    0    [1    /1   ]  215.832117883        1
[INPUT] 0    0    [1    /1   ]  1429.39577368        1
[INPUT] 0    0    [1    /1   ]  0.567977500752       1
[INPUT] 0    0    [1    /1   ]  48.1879166831        1
[INPUT] 0    0    [1    /1   ]  12.9957051394        1
[INPUT] 0    0    [1    /1   ]  1.90295372258        1
[INPUT] 1    0    [1    /1   ]  2.77370129336        1
[INPUT] 1    0    [1    /1   ]  13.3314903274        1
[INPUT] 1    0    [1    /1   ]  0.599743450539       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.202535775131, 1.0]], [0, [215.8321178827298, 1.0]], [0, [1429.3957736786822, 1.0]], [0, [0.5679775007519908, 1.0]], [0, [48.18791668306234, 1.0]], [0, [12.995705139399792, 1.0]], [0, [1.9029537225841842, 1.0]], [1, [2.7737012933644314, 1.0]], [1, [13.33149032742107, 1.0]], [1, [0.599743450539226, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.20253578]
bas 1, expnt(s) = [215.83211788]
bas 2, expnt(s) = [1429.39577368]
bas 3, expnt(s) = [0.5679775]
bas 4, expnt(s) = [48.18791668]
bas 5, expnt(s) = [12.99570514]
bas 6, expnt(s) = [1.90295372]
bas 7, expnt(s) = [2.77370129]
bas 8, expnt(s) = [13.33149033]
bas 9, expnt(s) = [0.59974345]
CPU time:        77.74
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14420254e+03 7.96094050e+02 2.15832118e+02 1.42266314e+02
 1.42939577e+03 5.87326227e+02 5.67977501e-01 1.65296392e+00
 4.81879167e+01 4.62081560e+01 1.29957051e+01 1.72927838e+01
 1.90295372e+00 4.09341894e+00 2.77370129e+00 1.04426087e+01
 1.33314903e+01 7.43160760e+01 5.99743451e-01 1.53971835e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965948565729322
cond(S) = 156.23219639508758
E1 = -183.13631201327644  E_coul = 55.01095589721774
init E= -128.125356116059
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742914922194718  LUMO = 2.65306335005057
  mo_energy =
[-3.25130309e+01 -1.85390225e+00 -7.42914922e-01 -7.42914922e-01
 -7.42914922e-01  2.65306335e+00  2.65306335e+00  2.65306335e+00
  2.70354825e+00  1.99455179e+01  1.99455179e+01  1.99455179e+01
  4.38242887e+01  3.18973035e+02  1.98499522e+03  7.27425268e+03]
E1 = -182.12396187031578  E_coul = 53.92868198632548
cycle= 1 E= -128.19527988399  delta_E= -0.0699  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262694
diis-c [-0.0690083  1.       ]
  HOMO = -0.8083488266002  LUMO = 2.59857748539562
  mo_energy =
[-3.27880993e+01 -1.92152049e+00 -8.08348827e-01 -8.08348827e-01
 -8.08348827e-01  2.59857749e+00  2.59857749e+00  2.59857749e+00
  2.65052725e+00  1.97536944e+01  1.97536944e+01  1.97536944e+01
  4.35897043e+01  3.18661874e+02  1.98463286e+03  7.27386484e+03]
E1 = -182.58921228739635  E_coul = 54.39228304586006
cycle= 2 E= -128.196929241536  delta_E= -0.00165  |g|= 0.0629  |ddm|= 0.0646
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102492
diis-c [-4.47004374e-04  2.76937751e-01  7.23062249e-01]
  HOMO = -0.78541022621604  LUMO = 2.61932253491584
  mo_energy =
[-3.27128234e+01 -1.89772640e+00 -7.85410226e-01 -7.85410226e-01
 -7.85410226e-01  2.61932253e+00  2.61932253e+00  2.61932253e+00
  2.67050012e+00  1.98102466e+01  1.98102466e+01  1.98102466e+01
  4.36558133e+01  3.18743967e+02  1.98472060e+03  7.27395409e+03]
E1 = -182.4559331573702  E_coul = 54.258695147155656
cycle= 3 E= -128.197238010215  delta_E= -0.000309  |g|= 0.000763  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0010098
diis-c [-6.95593147e-08 -3.65757345e-03  1.76133095e-04  1.00348144e+00]
  HOMO = -0.78567245590706  LUMO = 2.61912020940707
  mo_energy =
[-3.27135830e+01 -1.89805478e+00 -7.85672456e-01 -7.85672456e-01
 -7.85672456e-01  2.61912021e+00  2.61912021e+00  2.61912021e+00
  2.67024488e+00  1.98096561e+01  1.98096561e+01  1.98096561e+01
  4.36551085e+01  3.18743353e+02  1.98472011e+03  7.27395364e+03]
E1 = -182.457383795087  E_coul = 54.26014574443411
cycle= 4 E= -128.197238050653  delta_E= -4.04e-08  |g|= 4.77e-05  |ddm|= 0.000274
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.61154e-05
diis-c [-2.23374618e-10  4.67853766e-04 -1.07795073e-03 -1.64120257e-01
  1.16473035e+00]
  HOMO = -0.785658712248004  LUMO = 2.61913212807254
  mo_energy =
[-3.27135477e+01 -1.89805214e+00 -7.85658712e-01 -7.85658712e-01
 -7.85658712e-01  2.61913213e+00  2.61913213e+00  2.61913213e+00
  2.67024637e+00  1.98096834e+01  1.98096834e+01  1.98096834e+01
  4.36551370e+01  3.18743402e+02  1.98472018e+03  7.27395371e+03]
E1 = -182.45732473756635  E_coul = 54.26008668665344
cycle= 5 E= -128.197238050913  delta_E= -2.6e-10  |g|= 1.66e-06  |ddm|= 2.4e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45732473756635  E_coul = 54.26008668665344
  HOMO = -0.785658594785457  LUMO = 2.6191322422133
  mo_energy =
[-3.27135475e+01 -1.89805243e+00 -7.85658595e-01 -7.85658595e-01
 -7.85658595e-01  2.61913224e+00  2.61913224e+00  2.61913224e+00
  2.67024612e+00  1.98096836e+01  1.98096836e+01  1.98096836e+01
  4.36551370e+01  3.18743402e+02  1.98472018e+03  7.27395371e+03]
E1 = -182.45732449552483  E_coul = 54.26008644461167
Extra cycle  E= -128.197238050913  delta_E= -2.27e-13  |g|= 3.11e-07  |ddm|= 9.62e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.23219639508758
E1 = -182.45732449552483  E_coul = 54.26008644461167
init E= -128.197238050913
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785658594390119  LUMO = 2.61913224084049
  mo_energy =
[-3.27135475e+01 -1.89805251e+00 -7.85658594e-01 -7.85658594e-01
 -7.85658594e-01  2.61913224e+00  2.61913224e+00  2.61913224e+00
  2.67024605e+00  1.98096835e+01  1.98096835e+01  1.98096835e+01
  4.36551370e+01  3.18743402e+02  1.98472018e+03  7.27395371e+03]
E1 = -182.45732460395678  E_coul = 54.26008655304383
cycle= 1 E= -128.197238050913  delta_E= 1.99e-13  |g|= 5.69e-08  |ddm|= 1.81e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45732460395678  E_coul = 54.26008655304383
  HOMO = -0.78565858376271  LUMO = 2.61913225015198
  mo_energy =
[-3.27135475e+01 -1.89805251e+00 -7.85658584e-01 -7.85658584e-01
 -7.85658584e-01  2.61913225e+00  2.61913225e+00  2.61913225e+00
  2.67024604e+00  1.98096835e+01  1.98096835e+01  1.98096835e+01
  4.36551370e+01  3.18743402e+02  1.98472018e+03  7.27395371e+03]
E1 = -182.45732456373256  E_coul = 54.26008651281942
Extra cycle  E= -128.197238050913  delta_E= -1.99e-13  |g|= 1.21e-08  |ddm|= 3.02e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14420254e+03 2.15832118e+02 1.42939577e+03 5.67977501e-01
 4.81879167e+01 1.29957051e+01 1.90295372e+00 2.77370129e+00
 1.33314903e+01 5.99743451e-01]
grad_E = [-7.72145808e-06 -2.27483910e-04  4.46975644e-05  8.46655711e-04
 -1.59732141e-05  3.09706217e-04  2.55070217e-05 -1.71897681e-03
  2.43442549e-04 -2.64086425e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.20733347        1
[INPUT] 0    0    [1    /1   ]  215.957239438        1
[INPUT] 0    0    [1    /1   ]  1429.36824111        1
[INPUT] 0    0    [1    /1   ]  0.56935609167        1
[INPUT] 0    0    [1    /1   ]  48.2637585591        1
[INPUT] 0    0    [1    /1   ]  13.0164111282        1
[INPUT] 0    0    [1    /1   ]  1.90755634739        1
[INPUT] 1    0    [1    /1   ]  2.77199071605        1
[INPUT] 1    0    [1    /1   ]  13.3309690287        1
[INPUT] 1    0    [1    /1   ]  0.59938677247        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.2073334663737, 1.0]], [0, [215.95723943818638, 1.0]], [0, [1429.3682411104107, 1.0]], [0, [0.5693560916703809, 1.0]], [0, [48.26375855907918, 1.0]], [0, [13.016411128242277, 1.0]], [0, [1.9075563473942592, 1.0]], [1, [2.771990716054743, 1.0]], [1, [13.330969028673906, 1.0]], [1, [0.5993867724698925, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.20733347]
bas 1, expnt(s) = [215.95723944]
bas 2, expnt(s) = [1429.36824111]
bas 3, expnt(s) = [0.56935609]
bas 4, expnt(s) = [48.26375856]
bas 5, expnt(s) = [13.01641113]
bas 6, expnt(s) = [1.90755635]
bas 7, expnt(s) = [2.77199072]
bas 8, expnt(s) = [13.33096903]
bas 9, expnt(s) = [0.59938677]
CPU time:        80.04
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14420733e+03 7.96095386e+02 2.15957239e+02 1.42328165e+02
 1.42936824e+03 5.87317742e+02 5.69356092e-01 1.65597205e+00
 4.82637586e+01 4.62626897e+01 1.30164111e+01 1.73134440e+01
 1.90755635e+00 4.10084218e+00 2.77199072e+00 1.04345592e+01
 1.33309690e+01 7.43124435e+01 5.99386772e-01 1.53857381e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96599282831637
cond(S) = 156.34159930477875
E1 = -183.13619326334228  E_coul = 55.010951658058666
init E= -128.125241605284
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742923170720456  LUMO = 2.650951200591
  mo_energy =
[-3.25130624e+01 -1.85386045e+00 -7.42923171e-01 -7.42923171e-01
 -7.42923171e-01  2.65095120e+00  2.65095120e+00  2.65095120e+00
  2.71452408e+00  1.99385596e+01  1.99385596e+01  1.99385596e+01
  4.39381294e+01  3.19397075e+02  1.98571011e+03  7.27497909e+03]
E1 = -182.12278790867086  E_coul = 53.92749554564641
cycle= 1 E= -128.195292363024  delta_E= -0.0701  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262857
diis-c [-0.06909374  1.        ]
  HOMO = -0.808430975915065  LUMO = 2.59643535149177
  mo_energy =
[-3.27883568e+01 -1.92161905e+00 -8.08430976e-01 -8.08430976e-01
 -8.08430976e-01  2.59643535e+00  2.59643535e+00  2.59643535e+00
  2.66117098e+00  1.97465616e+01  1.97465616e+01  1.97465616e+01
  4.37031848e+01  3.19085745e+02  1.98534773e+03  7.27459126e+03]
E1 = -182.58859204460614  E_coul = 54.391646772478886
cycle= 2 E= -128.196945272127  delta_E= -0.00165  |g|= 0.063  |ddm|= 0.0647
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102614
diis-c [-4.48619954e-04  2.77049654e-01  7.22950346e-01]
  HOMO = -0.78546884470447  LUMO = 2.61718874425083
  mo_energy =
[-3.27130042e+01 -1.89779872e+00 -7.85468845e-01 -7.85468845e-01
 -7.85468845e-01  2.61718874e+00  2.61718874e+00  2.61718874e+00
  2.68122456e+00  1.98031721e+01  1.98031721e+01  1.98031721e+01
  4.37693900e+01  3.19167930e+02  1.98543557e+03  7.27468062e+03]
E1 = -182.45515381768567  E_coul = 54.257899001105294
cycle= 3 E= -128.19725481658  delta_E= -0.00031  |g|= 0.000762  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000999852
diis-c [-7.43589412e-08 -3.68989940e-03 -4.44776229e-05  1.00373438e+00]
  HOMO = -0.785728566857945  LUMO = 2.61698882802306
  mo_energy =
[-3.27137576e+01 -1.89812701e+00 -7.85728567e-01 -7.85728567e-01
 -7.85728567e-01  2.61698883e+00  2.61698883e+00  2.61698883e+00
  2.68096861e+00  1.98025865e+01  1.98025865e+01  1.98025865e+01
  4.37686900e+01  3.19167325e+02  1.98543510e+03  7.27468018e+03]
E1 = -182.45659401431098  E_coul = 54.25933915736045
cycle= 4 E= -128.197254856951  delta_E= -4.04e-08  |g|= 4.95e-05  |ddm|= 0.000277
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.88287e-05
diis-c [-2.29570866e-10  4.73015984e-04 -1.08184501e-03 -1.65812293e-01
  1.16642112e+00]
  HOMO = -0.785714373293738  LUMO = 2.61700112904909
  mo_energy =
[-3.27137211e+01 -1.89812438e+00 -7.85714373e-01 -7.85714373e-01
 -7.85714373e-01  2.61700113e+00  2.61700113e+00  2.61700113e+00
  2.68097008e+00  1.98026148e+01  1.98026148e+01  1.98026148e+01
  4.37687193e+01  3.19167375e+02  1.98543516e+03  7.27468025e+03]
E1 = -182.4565329422556  E_coul = 54.25927808502458
cycle= 5 E= -128.197254857231  delta_E= -2.8e-10  |g|= 1.66e-06  |ddm|= 2.5e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4565329422556  E_coul = 54.25927808502458
  HOMO = -0.78571426664384  LUMO = 2.61700123363594
  mo_energy =
[-3.27137209e+01 -1.89812469e+00 -7.85714267e-01 -7.85714267e-01
 -7.85714267e-01  2.61700123e+00  2.61700123e+00  2.61700123e+00
  2.68096981e+00  1.98026149e+01  1.98026149e+01  1.98026149e+01
  4.37687194e+01  3.19167375e+02  1.98543516e+03  7.27468025e+03]
E1 = -182.45653274895858  E_coul = 54.259277891727336
Extra cycle  E= -128.197254857231  delta_E= -2.56e-13  |g|= 3.1e-07  |ddm|= 9.64e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14420733e+03 2.15957239e+02 1.42936824e+03 5.69356092e-01
 4.82637586e+01 1.30164111e+01 1.90755635e+00 2.77199072e+00
 1.33309690e+01 5.99386772e-01]
E = -128.19725485723126
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.20733347        1
[INPUT] 0    0    [1    /1   ]  215.957239438        1
[INPUT] 0    0    [1    /1   ]  1429.36824111        1
[INPUT] 0    0    [1    /1   ]  0.56935609167        1
[INPUT] 0    0    [1    /1   ]  48.2637585591        1
[INPUT] 0    0    [1    /1   ]  13.0164111282        1
[INPUT] 0    0    [1    /1   ]  1.90755634739        1
[INPUT] 1    0    [1    /1   ]  2.77199071605        1
[INPUT] 1    0    [1    /1   ]  13.3309690287        1
[INPUT] 1    0    [1    /1   ]  0.59938677247        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.2073334663737, 1.0]], [0, [215.95723943818638, 1.0]], [0, [1429.3682411104107, 1.0]], [0, [0.5693560916703809, 1.0]], [0, [48.26375855907918, 1.0]], [0, [13.016411128242277, 1.0]], [0, [1.9075563473942592, 1.0]], [1, [2.771990716054743, 1.0]], [1, [13.330969028673906, 1.0]], [1, [0.5993867724698925, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.20733347]
bas 1, expnt(s) = [215.95723944]
bas 2, expnt(s) = [1429.36824111]
bas 3, expnt(s) = [0.56935609]
bas 4, expnt(s) = [48.26375856]
bas 5, expnt(s) = [13.01641113]
bas 6, expnt(s) = [1.90755635]
bas 7, expnt(s) = [2.77199072]
bas 8, expnt(s) = [13.33096903]
bas 9, expnt(s) = [0.59938677]
CPU time:        80.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14420733e+03 7.96095386e+02 2.15957239e+02 1.42328165e+02
 1.42936824e+03 5.87317742e+02 5.69356092e-01 1.65597205e+00
 4.82637586e+01 4.62626897e+01 1.30164111e+01 1.73134440e+01
 1.90755635e+00 4.10084218e+00 2.77199072e+00 1.04345592e+01
 1.33309690e+01 7.43124435e+01 5.99386772e-01 1.53857381e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96599282831637
cond(S) = 156.34159930477875
E1 = -183.13619326334228  E_coul = 55.010951658058666
init E= -128.125241605284
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742923170720456  LUMO = 2.650951200591
  mo_energy =
[-3.25130624e+01 -1.85386045e+00 -7.42923171e-01 -7.42923171e-01
 -7.42923171e-01  2.65095120e+00  2.65095120e+00  2.65095120e+00
  2.71452408e+00  1.99385596e+01  1.99385596e+01  1.99385596e+01
  4.39381294e+01  3.19397075e+02  1.98571011e+03  7.27497909e+03]
E1 = -182.12278790867086  E_coul = 53.92749554564641
cycle= 1 E= -128.195292363024  delta_E= -0.0701  |g|= 0.166  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262857
diis-c [-0.06909374  1.        ]
  HOMO = -0.808430975915065  LUMO = 2.59643535149177
  mo_energy =
[-3.27883568e+01 -1.92161905e+00 -8.08430976e-01 -8.08430976e-01
 -8.08430976e-01  2.59643535e+00  2.59643535e+00  2.59643535e+00
  2.66117098e+00  1.97465616e+01  1.97465616e+01  1.97465616e+01
  4.37031848e+01  3.19085745e+02  1.98534773e+03  7.27459126e+03]
E1 = -182.58859204460614  E_coul = 54.391646772478886
cycle= 2 E= -128.196945272127  delta_E= -0.00165  |g|= 0.063  |ddm|= 0.0647
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102614
diis-c [-4.48619954e-04  2.77049654e-01  7.22950346e-01]
  HOMO = -0.78546884470447  LUMO = 2.61718874425083
  mo_energy =
[-3.27130042e+01 -1.89779872e+00 -7.85468845e-01 -7.85468845e-01
 -7.85468845e-01  2.61718874e+00  2.61718874e+00  2.61718874e+00
  2.68122456e+00  1.98031721e+01  1.98031721e+01  1.98031721e+01
  4.37693900e+01  3.19167930e+02  1.98543557e+03  7.27468062e+03]
E1 = -182.45515381768567  E_coul = 54.257899001105294
cycle= 3 E= -128.19725481658  delta_E= -0.00031  |g|= 0.000762  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000999852
diis-c [-7.43589412e-08 -3.68989940e-03 -4.44776229e-05  1.00373438e+00]
  HOMO = -0.785728566857945  LUMO = 2.61698882802306
  mo_energy =
[-3.27137576e+01 -1.89812701e+00 -7.85728567e-01 -7.85728567e-01
 -7.85728567e-01  2.61698883e+00  2.61698883e+00  2.61698883e+00
  2.68096861e+00  1.98025865e+01  1.98025865e+01  1.98025865e+01
  4.37686900e+01  3.19167325e+02  1.98543510e+03  7.27468018e+03]
E1 = -182.45659401431098  E_coul = 54.25933915736045
cycle= 4 E= -128.197254856951  delta_E= -4.04e-08  |g|= 4.95e-05  |ddm|= 0.000277
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.88287e-05
diis-c [-2.29570866e-10  4.73015984e-04 -1.08184501e-03 -1.65812293e-01
  1.16642112e+00]
  HOMO = -0.785714373293738  LUMO = 2.61700112904909
  mo_energy =
[-3.27137211e+01 -1.89812438e+00 -7.85714373e-01 -7.85714373e-01
 -7.85714373e-01  2.61700113e+00  2.61700113e+00  2.61700113e+00
  2.68097008e+00  1.98026148e+01  1.98026148e+01  1.98026148e+01
  4.37687193e+01  3.19167375e+02  1.98543516e+03  7.27468025e+03]
E1 = -182.4565329422556  E_coul = 54.25927808502458
cycle= 5 E= -128.197254857231  delta_E= -2.8e-10  |g|= 1.66e-06  |ddm|= 2.5e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4565329422556  E_coul = 54.25927808502458
  HOMO = -0.78571426664384  LUMO = 2.61700123363594
  mo_energy =
[-3.27137209e+01 -1.89812469e+00 -7.85714267e-01 -7.85714267e-01
 -7.85714267e-01  2.61700123e+00  2.61700123e+00  2.61700123e+00
  2.68096981e+00  1.98026149e+01  1.98026149e+01  1.98026149e+01
  4.37687194e+01  3.19167375e+02  1.98543516e+03  7.27468025e+03]
E1 = -182.45653274895858  E_coul = 54.259277891727336
Extra cycle  E= -128.197254857231  delta_E= -2.56e-13  |g|= 3.1e-07  |ddm|= 9.64e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.34159930477875
E1 = -182.45653274895858  E_coul = 54.259277891727336
init E= -128.197254857231
    CPU time for initialize scf      0.06 sec, wall time      0.06 sec
  HOMO = -0.78571426302522  LUMO = 2.61700123517353
  mo_energy =
[-3.27137209e+01 -1.89812476e+00 -7.85714263e-01 -7.85714263e-01
 -7.85714263e-01  2.61700124e+00  2.61700124e+00  2.61700124e+00
  2.68096974e+00  1.98026149e+01  1.98026149e+01  1.98026149e+01
  4.37687193e+01  3.19167375e+02  1.98543516e+03  7.27468025e+03]
E1 = -182.45653283694003  E_coul = 54.25927797970873
cycle= 1 E= -128.197254857231  delta_E= -5.68e-14  |g|= 5.64e-08  |ddm|= 1.8e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45653283694003  E_coul = 54.25927797970873
  HOMO = -0.785714253814834  LUMO = 2.61700124319939
  mo_energy =
[-3.27137209e+01 -1.89812477e+00 -7.85714254e-01 -7.85714254e-01
 -7.85714254e-01  2.61700124e+00  2.61700124e+00  2.61700124e+00
  2.68096974e+00  1.98026149e+01  1.98026149e+01  1.98026149e+01
  4.37687193e+01  3.19167375e+02  1.98543516e+03  7.27468025e+03]
E1 = -182.4565328046593  E_coul = 54.25927794742784
Extra cycle  E= -128.197254857231  delta_E= -1.42e-13  |g|= 1.15e-08  |ddm|= 3.04e-08
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.14420733e+03 2.15957239e+02 1.42936824e+03 5.69356092e-01
 4.82637586e+01 1.30164111e+01 1.90755635e+00 2.77199072e+00
 1.33309690e+01 5.99386772e-01]
grad_E = [-7.72588102e-06 -2.36599059e-04  4.47055126e-05  1.18375294e-03
  3.27998999e-05  4.38458250e-04  4.67696750e-05 -2.46584723e-03
  3.47214296e-04 -3.87685918e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.21586465        1
[INPUT] 0    0    [1    /1   ]  216.185855177        1
[INPUT] 0    0    [1    /1   ]  1429.31913058        1
[INPUT] 0    0    [1    /1   ]  0.571075314236       1
[INPUT] 0    0    [1    /1   ]  48.3679481059        1
[INPUT] 0    0    [1    /1   ]  13.0432335564        1
[INPUT] 0    0    [1    /1   ]  1.91334573909        1
[INPUT] 1    0    [1    /1   ]  2.76992278432        1
[INPUT] 1    0    [1    /1   ]  13.3299726924        1
[INPUT] 1    0    [1    /1   ]  0.598958996937       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.215864653269, 1.0]], [0, [216.1858551765014, 1.0]], [0, [1429.3191305779264, 1.0]], [0, [0.5710753142355485, 1.0]], [0, [48.36794810585002, 1.0]], [0, [13.043233556378384, 1.0]], [0, [1.9133457390922923, 1.0]], [1, [2.7699227843243905, 1.0]], [1, [13.329972692426688, 1.0]], [1, [0.5989589969366219, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.21586465]
bas 1, expnt(s) = [216.18585518]
bas 2, expnt(s) = [1429.31913058]
bas 3, expnt(s) = [0.57107531]
bas 4, expnt(s) = [48.36794811]
bas 5, expnt(s) = [13.04323356]
bas 6, expnt(s) = [1.91334574]
bas 7, expnt(s) = [2.76992278]
bas 8, expnt(s) = [13.32997269]
bas 9, expnt(s) = [0.598959]
CPU time:        82.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14421586e+03 7.96097762e+02 2.16185855e+02 1.42441153e+02
 1.42931913e+03 5.87302608e+02 5.71075314e-01 1.65972091e+00
 4.83679481e+01 4.63375718e+01 1.30432336e+01 1.73401950e+01
 1.91334574e+00 4.11017312e+00 2.76992278e+00 1.04248297e+01
 1.33299727e+01 7.43055011e+01 5.98958997e-01 1.53720135e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966043816023214
cond(S) = 156.49899480235018
E1 = -183.13605411330903  E_coul = 55.01094855176375
init E= -128.125105561545
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742932676714465  LUMO = 2.64841519111014
  mo_energy =
[-3.25131082e+01 -1.85380662e+00 -7.42932677e-01 -7.42932677e-01
 -7.42932677e-01  2.64841519e+00  2.64841519e+00  2.64841519e+00
  2.72831536e+00  1.99297760e+01  1.99297760e+01  1.99297760e+01
  4.40874797e+01  3.20019383e+02  1.98685056e+03  7.27614989e+03]
E1 = -182.12143280613398  E_coul = 53.92611691489831
cycle= 1 E= -128.195315891236  delta_E= -0.0702  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263037
diis-c [-0.06918868  1.        ]
  HOMO = -0.808526083937024  LUMO = 2.59386663655683
  mo_energy =
[-3.27886632e+01 -1.92173197e+00 -8.08526084e-01 -8.08526084e-01
 -8.08526084e-01  2.59386664e+00  2.59386664e+00  2.59386664e+00
  2.67455287e+00  1.97375779e+01  1.97375779e+01  1.97375779e+01
  4.38520939e+01  3.19707855e+02  1.98648818e+03  7.27576213e+03]
E1 = -182.5878836319474  E_coul = 54.39091066001367
cycle= 2 E= -128.196972971934  delta_E= -0.00166  |g|= 0.063  |ddm|= 0.0648
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102758
diis-c [-4.50235561e-04  2.77190323e-01  7.22809677e-01]
  HOMO = -0.78553690245407  LUMO = 2.61462890682786
  mo_energy =
[-3.27132219e+01 -1.89788123e+00 -7.85536902e-01 -7.85536902e-01
 -7.85536902e-01  2.61462891e+00  2.61462891e+00  2.61462891e+00
  2.69470589e+00  1.97942553e+01  1.97942553e+01  1.97942553e+01
  4.39184156e+01  3.19790148e+02  1.98657614e+03  7.27585160e+03]
E1 = -182.45426111267298  E_coul = 54.25697768547306
cycle= 3 E= -128.1972834272  delta_E= -0.00031  |g|= 0.000761  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000987172
diis-c [-8.03700062e-08 -3.73101694e-03 -3.25060087e-04  1.00405608e+00]
  HOMO = -0.785793382151391  LUMO = 2.61443208647835
  mo_energy =
[-3.27139671e+01 -1.89820919e+00 -7.85793382e-01 -7.85793382e-01
 -7.85793382e-01  2.61443209e+00  2.61443209e+00  2.61443209e+00
  2.69444924e+00  1.97936762e+01  1.97936762e+01  1.97936762e+01
  4.39177218e+01  3.19789554e+02  1.98657568e+03  7.27585118e+03]
E1 = -182.4556873235054  E_coul = 54.258403856043955
cycle= 4 E= -128.197283467461  delta_E= -4.03e-08  |g|= 5.17e-05  |ddm|= 0.00028
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.20922e-05
diis-c [-2.36614850e-10  4.78793743e-04 -1.08358182e-03 -1.67662079e-01
  1.16826687e+00]
  HOMO = -0.785778651433186  LUMO = 2.61444484272307
  mo_energy =
[-3.27139291e+01 -1.89820658e+00 -7.85778651e-01 -7.85778651e-01
 -7.85778651e-01  2.61444484e+00  2.61444484e+00  2.61444484e+00
  2.69445066e+00  1.97937056e+01  1.97937056e+01  1.97937056e+01
  4.39177523e+01  3.19789606e+02  1.98657574e+03  7.27585125e+03]
E1 = -182.45562382180188  E_coul = 54.25834035403484
cycle= 5 E= -128.197283467767  delta_E= -3.06e-10  |g|= 1.66e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45562382180188  E_coul = 54.25834035403484
  HOMO = -0.785778557546588  LUMO = 2.61444493607439
  mo_energy =
[-3.27139290e+01 -1.89820690e+00 -7.85778558e-01 -7.85778558e-01
 -7.85778558e-01  2.61444494e+00  2.61444494e+00  2.61444494e+00
  2.69445038e+00  1.97937056e+01  1.97937056e+01  1.97937056e+01
  4.39177523e+01  3.19789606e+02  1.98657574e+03  7.27585125e+03]
E1 = -182.45562368514047  E_coul = 54.258340217373046
Extra cycle  E= -128.197283467767  delta_E= -3.98e-13  |g|= 3.08e-07  |ddm|= 9.65e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14421586e+03 2.16185855e+02 1.42931913e+03 5.71075314e-01
 4.83679481e+01 1.30432336e+01 1.91334574e+00 2.76992278e+00
 1.33299727e+01 5.98958997e-01]
E = -128.19728346776742
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.21586465        1
[INPUT] 0    0    [1    /1   ]  216.185855177        1
[INPUT] 0    0    [1    /1   ]  1429.31913058        1
[INPUT] 0    0    [1    /1   ]  0.571075314236       1
[INPUT] 0    0    [1    /1   ]  48.3679481059        1
[INPUT] 0    0    [1    /1   ]  13.0432335564        1
[INPUT] 0    0    [1    /1   ]  1.91334573909        1
[INPUT] 1    0    [1    /1   ]  2.76992278432        1
[INPUT] 1    0    [1    /1   ]  13.3299726924        1
[INPUT] 1    0    [1    /1   ]  0.598958996937       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.215864653269, 1.0]], [0, [216.1858551765014, 1.0]], [0, [1429.3191305779264, 1.0]], [0, [0.5710753142355485, 1.0]], [0, [48.36794810585002, 1.0]], [0, [13.043233556378384, 1.0]], [0, [1.9133457390922923, 1.0]], [1, [2.7699227843243905, 1.0]], [1, [13.329972692426688, 1.0]], [1, [0.5989589969366219, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.21586465]
bas 1, expnt(s) = [216.18585518]
bas 2, expnt(s) = [1429.31913058]
bas 3, expnt(s) = [0.57107531]
bas 4, expnt(s) = [48.36794811]
bas 5, expnt(s) = [13.04323356]
bas 6, expnt(s) = [1.91334574]
bas 7, expnt(s) = [2.76992278]
bas 8, expnt(s) = [13.32997269]
bas 9, expnt(s) = [0.598959]
CPU time:        83.57
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14421586e+03 7.96097762e+02 2.16185855e+02 1.42441153e+02
 1.42931913e+03 5.87302608e+02 5.71075314e-01 1.65972091e+00
 4.83679481e+01 4.63375718e+01 1.30432336e+01 1.73401950e+01
 1.91334574e+00 4.11017312e+00 2.76992278e+00 1.04248297e+01
 1.33299727e+01 7.43055011e+01 5.98958997e-01 1.53720135e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966043816023214
cond(S) = 156.49899480235018
E1 = -183.13605411330903  E_coul = 55.01094855176375
init E= -128.125105561545
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742932676714465  LUMO = 2.64841519111014
  mo_energy =
[-3.25131082e+01 -1.85380662e+00 -7.42932677e-01 -7.42932677e-01
 -7.42932677e-01  2.64841519e+00  2.64841519e+00  2.64841519e+00
  2.72831536e+00  1.99297760e+01  1.99297760e+01  1.99297760e+01
  4.40874797e+01  3.20019383e+02  1.98685056e+03  7.27614989e+03]
E1 = -182.12143280613398  E_coul = 53.92611691489831
cycle= 1 E= -128.195315891236  delta_E= -0.0702  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263037
diis-c [-0.06918868  1.        ]
  HOMO = -0.808526083937024  LUMO = 2.59386663655683
  mo_energy =
[-3.27886632e+01 -1.92173197e+00 -8.08526084e-01 -8.08526084e-01
 -8.08526084e-01  2.59386664e+00  2.59386664e+00  2.59386664e+00
  2.67455287e+00  1.97375779e+01  1.97375779e+01  1.97375779e+01
  4.38520939e+01  3.19707855e+02  1.98648818e+03  7.27576213e+03]
E1 = -182.5878836319474  E_coul = 54.39091066001367
cycle= 2 E= -128.196972971934  delta_E= -0.00166  |g|= 0.063  |ddm|= 0.0648
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102758
diis-c [-4.50235561e-04  2.77190323e-01  7.22809677e-01]
  HOMO = -0.78553690245407  LUMO = 2.61462890682786
  mo_energy =
[-3.27132219e+01 -1.89788123e+00 -7.85536902e-01 -7.85536902e-01
 -7.85536902e-01  2.61462891e+00  2.61462891e+00  2.61462891e+00
  2.69470589e+00  1.97942553e+01  1.97942553e+01  1.97942553e+01
  4.39184156e+01  3.19790148e+02  1.98657614e+03  7.27585160e+03]
E1 = -182.45426111267298  E_coul = 54.25697768547306
cycle= 3 E= -128.1972834272  delta_E= -0.00031  |g|= 0.000761  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000987172
diis-c [-8.03700062e-08 -3.73101694e-03 -3.25060087e-04  1.00405608e+00]
  HOMO = -0.785793382151391  LUMO = 2.61443208647835
  mo_energy =
[-3.27139671e+01 -1.89820919e+00 -7.85793382e-01 -7.85793382e-01
 -7.85793382e-01  2.61443209e+00  2.61443209e+00  2.61443209e+00
  2.69444924e+00  1.97936762e+01  1.97936762e+01  1.97936762e+01
  4.39177218e+01  3.19789554e+02  1.98657568e+03  7.27585118e+03]
E1 = -182.4556873235054  E_coul = 54.258403856043955
cycle= 4 E= -128.197283467461  delta_E= -4.03e-08  |g|= 5.17e-05  |ddm|= 0.00028
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.20922e-05
diis-c [-2.36614850e-10  4.78793743e-04 -1.08358182e-03 -1.67662079e-01
  1.16826687e+00]
  HOMO = -0.785778651433186  LUMO = 2.61444484272307
  mo_energy =
[-3.27139291e+01 -1.89820658e+00 -7.85778651e-01 -7.85778651e-01
 -7.85778651e-01  2.61444484e+00  2.61444484e+00  2.61444484e+00
  2.69445066e+00  1.97937056e+01  1.97937056e+01  1.97937056e+01
  4.39177523e+01  3.19789606e+02  1.98657574e+03  7.27585125e+03]
E1 = -182.45562382180188  E_coul = 54.25834035403484
cycle= 5 E= -128.197283467767  delta_E= -3.06e-10  |g|= 1.66e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45562382180188  E_coul = 54.25834035403484
  HOMO = -0.785778557546588  LUMO = 2.61444493607439
  mo_energy =
[-3.27139290e+01 -1.89820690e+00 -7.85778558e-01 -7.85778558e-01
 -7.85778558e-01  2.61444494e+00  2.61444494e+00  2.61444494e+00
  2.69445038e+00  1.97937056e+01  1.97937056e+01  1.97937056e+01
  4.39177523e+01  3.19789606e+02  1.98657574e+03  7.27585125e+03]
E1 = -182.45562368514047  E_coul = 54.258340217373046
Extra cycle  E= -128.197283467767  delta_E= -3.98e-13  |g|= 3.08e-07  |ddm|= 9.65e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.49899480235018
E1 = -182.45562368514047  E_coul = 54.258340217373046
init E= -128.197283467767
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785778550204106  LUMO = 2.61444494097143
  mo_energy =
[-3.27139290e+01 -1.89820697e+00 -7.85778550e-01 -7.85778550e-01
 -7.85778550e-01  2.61444494e+00  2.61444494e+00  2.61444494e+00
  2.69445032e+00  1.97937056e+01  1.97937056e+01  1.97937056e+01
  4.39177523e+01  3.19789607e+02  1.98657574e+03  7.27585125e+03]
E1 = -182.45562374926982  E_coul = 54.25834028150236
cycle= 1 E= -128.197283467767  delta_E= -2.84e-14  |g|= 5.6e-08  |ddm|= 1.78e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45562374926982  E_coul = 54.25834028150236
  HOMO = -0.785778542650154  LUMO = 2.61444494749658
  mo_energy =
[-3.27139290e+01 -1.89820698e+00 -7.85778543e-01 -7.85778543e-01
 -7.85778543e-01  2.61444495e+00  2.61444495e+00  2.61444495e+00
  2.69445031e+00  1.97937056e+01  1.97937056e+01  1.97937056e+01
  4.39177523e+01  3.19789607e+02  1.98657574e+03  7.27585125e+03]
E1 = -182.4556237262437  E_coul = 54.25834025847627
Extra cycle  E= -128.197283467767  delta_E= 2.84e-14  |g|= 1.09e-08  |ddm|= 3.06e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14421586e+03 2.16185855e+02 1.42931913e+03 5.71075314e-01
 4.83679481e+01 1.30432336e+01 1.91334574e+00 2.76992278e+00
 1.33299727e+01 5.98958997e-01]
grad_E = [-7.74876483e-06 -2.45681129e-04  4.46335161e-05  1.57679933e-03
  9.12538261e-05  5.89432550e-04  7.30575703e-05 -3.34862777e-03
  4.68245697e-04 -5.35144208e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.23053194        1
[INPUT] 0    0    [1    /1   ]  216.58617466         1
[INPUT] 0    0    [1    /1   ]  1429.23451625        1
[INPUT] 0    0    [1    /1   ]  0.573161860096       1
[INPUT] 0    0    [1    /1   ]  48.5106555722        1
[INPUT] 0    0    [1    /1   ]  13.077483161         1
[INPUT] 0    0    [1    /1   ]  1.92044723044        1
[INPUT] 1    0    [1    /1   ]  2.7675316455         1
[INPUT] 1    0    [1    /1   ]  13.3281791442        1
[INPUT] 1    0    [1    /1   ]  0.598470493951       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.230531944727, 1.0]], [0, [216.58617466025552, 1.0]], [0, [1429.2345162505926, 1.0]], [0, [0.5731618600955887, 1.0]], [0, [48.51065557224548, 1.0]], [0, [13.07748316095527, 1.0]], [0, [1.920447230444315, 1.0]], [1, [2.7675316455009735, 1.0]], [1, [13.32817914419209, 1.0]], [1, [0.5984704939513595, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.23053194]
bas 1, expnt(s) = [216.58617466]
bas 2, expnt(s) = [1429.23451625]
bas 3, expnt(s) = [0.57316186]
bas 4, expnt(s) = [48.51065557]
bas 5, expnt(s) = [13.07748316]
bas 6, expnt(s) = [1.92044723]
bas 7, expnt(s) = [2.76753165]
bas 8, expnt(s) = [13.32817914]
bas 9, expnt(s) = [0.59847049]
CPU time:        85.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14423053e+03 7.96101846e+02 2.16586175e+02 1.42638930e+02
 1.42923452e+03 5.87276532e+02 5.73161860e-01 1.66426694e+00
 4.85106556e+01 4.64400717e+01 1.30774832e+01 1.73743334e+01
 1.92044723e+00 4.12160917e+00 2.76753165e+00 1.04135819e+01
 1.33281791e+01 7.42930040e+01 5.98470494e-01 1.53563436e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966098396667535
cond(S) = 156.72559933552944
E1 = -183.1359043383004  E_coul = 55.01094956830146
init E= -128.124954769999
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742942904978607  LUMO = 2.64551354076843
  mo_energy =
[-3.25131748e+01 -1.85373869e+00 -7.42942905e-01 -7.42942905e-01
 -7.42942905e-01  2.64551354e+00  2.64551354e+00  2.64551354e+00
  2.74521460e+00  1.99189693e+01  1.99189693e+01  1.99189693e+01
  4.42812282e+01  3.20932902e+02  1.98865577e+03  7.27801929e+03]
E1 = -182.11998853364852  E_coul = 53.92462833551517
cycle= 1 E= -128.195360198133  delta_E= -0.0704  |g|= 0.167  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263217
diis-c [-0.069283  1.      ]
  HOMO = -0.808628315419164  LUMO = 2.59093371316643
  mo_energy =
[-3.27890075e+01 -1.92185140e+00 -8.08628315e-01 -8.08628315e-01
 -8.08628315e-01  2.59093371e+00  2.59093371e+00  2.59093371e+00
  2.69096451e+00  1.97265601e+01  1.97265601e+01  1.97265601e+01
  4.40453229e+01  3.20621156e+02  1.98829344e+03  7.27763167e+03]
E1 = -182.5871448484821  E_coul = 54.39012298060993
cycle= 2 E= -128.197021867872  delta_E= -0.00166  |g|= 0.0631  |ddm|= 0.065
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102916
diis-c [-4.51519586e-04  2.77362488e-01  7.22637512e-01]
  HOMO = -0.785610423680265  LUMO = 2.61170404541395
  mo_energy =
[-3.27134710e+01 -1.89796793e+00 -7.85610424e-01 -7.85610424e-01
 -7.85610424e-01  2.61170405e+00  2.61170405e+00  2.61170405e+00
  2.71123582e+00  1.97833081e+01  1.97833081e+01  1.97833081e+01
  4.41117793e+01  3.20703569e+02  1.98838152e+03  7.27772127e+03]
E1 = -182.4533240875375  E_coul = 54.25599076257019
cycle= 3 E= -128.197333324967  delta_E= -0.000311  |g|= 0.000759  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000971298
diis-c [-8.76159762e-08 -3.78205997e-03 -6.73983974e-04  1.00445604e+00]
  HOMO = -0.785862778644857  LUMO = 2.61151113121529
  mo_energy =
[-3.27142053e+01 -1.89829513e+00 -7.85862779e-01 -7.85862779e-01
 -7.85862779e-01  2.61151113e+00  2.61151113e+00  2.61151113e+00
  2.71097862e+00  1.97827375e+01  1.97827375e+01  1.97827375e+01
  4.41110940e+01  3.20702990e+02  1.98838108e+03  7.27772086e+03]
E1 = -182.45473175565263  E_coul = 54.25739839060496
cycle= 4 E= -128.197333365048  delta_E= -4.01e-08  |g|= 5.41e-05  |ddm|= 0.000283
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.58522e-05
diis-c [-2.44094194e-10  4.85014981e-04 -1.08101711e-03 -1.69574437e-01
  1.17017044e+00]
  HOMO = -0.785847434894927  LUMO = 2.61152440514153
  mo_energy =
[-3.27141658e+01 -1.89829255e+00 -7.85847435e-01 -7.85847435e-01
 -7.85847435e-01  2.61152441e+00  2.61152441e+00  2.61152441e+00
  2.71097999e+00  1.97827680e+01  1.97827680e+01  1.97827680e+01
  4.41111258e+01  3.20703044e+02  1.98838115e+03  7.27772094e+03]
E1 = -182.4546654444998  E_coul = 54.25733207911569
cycle= 5 E= -128.197333365384  delta_E= -3.36e-10  |g|= 1.66e-06  |ddm|= 2.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4546654444998  E_coul = 54.25733207911569
  HOMO = -0.785847355517349  LUMO = 2.61152448579579
  mo_energy =
[-3.27141657e+01 -1.89829289e+00 -7.85847356e-01 -7.85847356e-01
 -7.85847356e-01  2.61152449e+00  2.61152449e+00  2.61152449e+00
  2.71097970e+00  1.97827681e+01  1.97827681e+01  1.97827681e+01
  4.41111258e+01  3.20703045e+02  1.98838115e+03  7.27772094e+03]
E1 = -182.45466537091548  E_coul = 54.25733200553103
Extra cycle  E= -128.197333365384  delta_E= -3.41e-13  |g|= 3.06e-07  |ddm|= 9.65e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14423053e+03 2.16586175e+02 1.42923452e+03 5.73161860e-01
 4.85106556e+01 1.30774832e+01 1.92044723e+00 2.76753165e+00
 1.33281791e+01 5.98470494e-01]
E = -128.19733336538445
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.23053194        1
[INPUT] 0    0    [1    /1   ]  216.58617466         1
[INPUT] 0    0    [1    /1   ]  1429.23451625        1
[INPUT] 0    0    [1    /1   ]  0.573161860096       1
[INPUT] 0    0    [1    /1   ]  48.5106555722        1
[INPUT] 0    0    [1    /1   ]  13.077483161         1
[INPUT] 0    0    [1    /1   ]  1.92044723044        1
[INPUT] 1    0    [1    /1   ]  2.7675316455         1
[INPUT] 1    0    [1    /1   ]  13.3281791442        1
[INPUT] 1    0    [1    /1   ]  0.598470493951       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.230531944727, 1.0]], [0, [216.58617466025552, 1.0]], [0, [1429.2345162505926, 1.0]], [0, [0.5731618600955887, 1.0]], [0, [48.51065557224548, 1.0]], [0, [13.07748316095527, 1.0]], [0, [1.920447230444315, 1.0]], [1, [2.7675316455009735, 1.0]], [1, [13.32817914419209, 1.0]], [1, [0.5984704939513595, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.23053194]
bas 1, expnt(s) = [216.58617466]
bas 2, expnt(s) = [1429.23451625]
bas 3, expnt(s) = [0.57316186]
bas 4, expnt(s) = [48.51065557]
bas 5, expnt(s) = [13.07748316]
bas 6, expnt(s) = [1.92044723]
bas 7, expnt(s) = [2.76753165]
bas 8, expnt(s) = [13.32817914]
bas 9, expnt(s) = [0.59847049]
CPU time:        86.51
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14423053e+03 7.96101846e+02 2.16586175e+02 1.42638930e+02
 1.42923452e+03 5.87276532e+02 5.73161860e-01 1.66426694e+00
 4.85106556e+01 4.64400717e+01 1.30774832e+01 1.73743334e+01
 1.92044723e+00 4.12160917e+00 2.76753165e+00 1.04135819e+01
 1.33281791e+01 7.42930040e+01 5.98470494e-01 1.53563436e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966098396667535
cond(S) = 156.72559933552944
E1 = -183.1359043383004  E_coul = 55.01094956830146
init E= -128.124954769999
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742942904978607  LUMO = 2.64551354076843
  mo_energy =
[-3.25131748e+01 -1.85373869e+00 -7.42942905e-01 -7.42942905e-01
 -7.42942905e-01  2.64551354e+00  2.64551354e+00  2.64551354e+00
  2.74521460e+00  1.99189693e+01  1.99189693e+01  1.99189693e+01
  4.42812282e+01  3.20932902e+02  1.98865577e+03  7.27801929e+03]
E1 = -182.11998853364852  E_coul = 53.92462833551517
cycle= 1 E= -128.195360198133  delta_E= -0.0704  |g|= 0.167  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263217
diis-c [-0.069283  1.      ]
  HOMO = -0.808628315419164  LUMO = 2.59093371316643
  mo_energy =
[-3.27890075e+01 -1.92185140e+00 -8.08628315e-01 -8.08628315e-01
 -8.08628315e-01  2.59093371e+00  2.59093371e+00  2.59093371e+00
  2.69096451e+00  1.97265601e+01  1.97265601e+01  1.97265601e+01
  4.40453229e+01  3.20621156e+02  1.98829344e+03  7.27763167e+03]
E1 = -182.5871448484821  E_coul = 54.39012298060993
cycle= 2 E= -128.197021867872  delta_E= -0.00166  |g|= 0.0631  |ddm|= 0.065
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102916
diis-c [-4.51519586e-04  2.77362488e-01  7.22637512e-01]
  HOMO = -0.785610423680265  LUMO = 2.61170404541395
  mo_energy =
[-3.27134710e+01 -1.89796793e+00 -7.85610424e-01 -7.85610424e-01
 -7.85610424e-01  2.61170405e+00  2.61170405e+00  2.61170405e+00
  2.71123582e+00  1.97833081e+01  1.97833081e+01  1.97833081e+01
  4.41117793e+01  3.20703569e+02  1.98838152e+03  7.27772127e+03]
E1 = -182.4533240875375  E_coul = 54.25599076257019
cycle= 3 E= -128.197333324967  delta_E= -0.000311  |g|= 0.000759  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000971298
diis-c [-8.76159762e-08 -3.78205997e-03 -6.73983974e-04  1.00445604e+00]
  HOMO = -0.785862778644857  LUMO = 2.61151113121529
  mo_energy =
[-3.27142053e+01 -1.89829513e+00 -7.85862779e-01 -7.85862779e-01
 -7.85862779e-01  2.61151113e+00  2.61151113e+00  2.61151113e+00
  2.71097862e+00  1.97827375e+01  1.97827375e+01  1.97827375e+01
  4.41110940e+01  3.20702990e+02  1.98838108e+03  7.27772086e+03]
E1 = -182.45473175565263  E_coul = 54.25739839060496
cycle= 4 E= -128.197333365048  delta_E= -4.01e-08  |g|= 5.41e-05  |ddm|= 0.000283
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.58522e-05
diis-c [-2.44094194e-10  4.85014981e-04 -1.08101711e-03 -1.69574437e-01
  1.17017044e+00]
  HOMO = -0.785847434894927  LUMO = 2.61152440514153
  mo_energy =
[-3.27141658e+01 -1.89829255e+00 -7.85847435e-01 -7.85847435e-01
 -7.85847435e-01  2.61152441e+00  2.61152441e+00  2.61152441e+00
  2.71097999e+00  1.97827680e+01  1.97827680e+01  1.97827680e+01
  4.41111258e+01  3.20703044e+02  1.98838115e+03  7.27772094e+03]
E1 = -182.4546654444998  E_coul = 54.25733207911569
cycle= 5 E= -128.197333365384  delta_E= -3.36e-10  |g|= 1.66e-06  |ddm|= 2.76e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4546654444998  E_coul = 54.25733207911569
  HOMO = -0.785847355517349  LUMO = 2.61152448579579
  mo_energy =
[-3.27141657e+01 -1.89829289e+00 -7.85847356e-01 -7.85847356e-01
 -7.85847356e-01  2.61152449e+00  2.61152449e+00  2.61152449e+00
  2.71097970e+00  1.97827681e+01  1.97827681e+01  1.97827681e+01
  4.41111258e+01  3.20703045e+02  1.98838115e+03  7.27772094e+03]
E1 = -182.45466537091548  E_coul = 54.25733200553103
Extra cycle  E= -128.197333365384  delta_E= -3.41e-13  |g|= 3.06e-07  |ddm|= 9.65e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 156.72559933552944
E1 = -182.45466537091548  E_coul = 54.25733200553103
init E= -128.197333365384
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785847344059832  LUMO = 2.6115244944019
  mo_energy =
[-3.27141657e+01 -1.89829295e+00 -7.85847344e-01 -7.85847344e-01
 -7.85847344e-01  2.61152449e+00  2.61152449e+00  2.61152449e+00
  2.71097964e+00  1.97827681e+01  1.97827681e+01  1.97827681e+01
  4.41111257e+01  3.20703045e+02  1.98838115e+03  7.27772094e+03]
E1 = -182.45466540835739  E_coul = 54.257332042973104
cycle= 1 E= -128.197333365384  delta_E= 1.71e-13  |g|= 5.56e-08  |ddm|= 1.76e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45466540835739  E_coul = 54.257332042973104
  HOMO = -0.785847338364901  LUMO = 2.61152449924583
  mo_energy =
[-3.27141657e+01 -1.89829296e+00 -7.85847338e-01 -7.85847338e-01
 -7.85847338e-01  2.61152450e+00  2.61152450e+00  2.61152450e+00
  2.71097963e+00  1.97827681e+01  1.97827681e+01  1.97827681e+01
  4.41111257e+01  3.20703045e+02  1.98838115e+03  7.27772094e+03]
E1 = -182.4546653956707  E_coul = 54.25733203028639
Extra cycle  E= -128.197333365384  delta_E= -2.84e-14  |g|= 1.04e-08  |ddm|= 3.08e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14423053e+03 2.16586175e+02 1.42923452e+03 5.73161860e-01
 4.85106556e+01 1.30774832e+01 1.92044723e+00 2.76753165e+00
 1.33281791e+01 5.98470494e-01]
grad_E = [-7.80561688e-06 -2.52887013e-04  4.44087416e-05  2.00921655e-03
  1.58226249e-04  7.57455125e-04  1.04128220e-04 -4.33307156e-03
  6.00349100e-04 -7.01431788e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.25585668        1
[INPUT] 0    0    [1    /1   ]  217.285952481        1
[INPUT] 0    0    [1    /1   ]  1429.08820712        1
[INPUT] 0    0    [1    /1   ]  0.575738915828       1
[INPUT] 0    0    [1    /1   ]  48.7140348435        1
[INPUT] 0    0    [1    /1   ]  13.1226070549        1
[INPUT] 0    0    [1    /1   ]  1.9293307807         1
[INPUT] 1    0    [1    /1   ]  2.76477819341        1
[INPUT] 1    0    [1    /1   ]  13.324992074         1
[INPUT] 1    0    [1    /1   ]  0.597918892432       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.2558566765715, 1.0]], [0, [217.28595248102636, 1.0]], [0, [1429.0882071160795, 1.0]], [0, [0.5757389158282734, 1.0]], [0, [48.71403484351821, 1.0]], [0, [13.122607054855512, 1.0]], [0, [1.929330780697877, 1.0]], [1, [2.764778193405565, 1.0]], [1, [13.324992073983529, 1.0]], [1, [0.5979188924319132, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.25585668]
bas 1, expnt(s) = [217.28595248]
bas 2, expnt(s) = [1429.08820712]
bas 3, expnt(s) = [0.57573892]
bas 4, expnt(s) = [48.71403484]
bas 5, expnt(s) = [13.12260705]
bas 6, expnt(s) = [1.92933078]
bas 7, expnt(s) = [2.76477819]
bas 8, expnt(s) = [13.32499207]
bas 9, expnt(s) = [0.59791889]
CPU time:        88.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14425586e+03 7.96108898e+02 2.17285952e+02 1.42984434e+02
 1.42908821e+03 5.87231442e+02 5.75738916e-01 1.66987596e+00
 4.87140348e+01 4.65860192e+01 1.31226071e+01 1.74192767e+01
 1.92933078e+00 4.13590014e+00 2.76477819e+00 1.04006328e+01
 1.33249921e+01 7.42707983e+01 5.97918892e-01 1.53386535e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966153763199793
cond(S) = 157.0652561191255
E1 = -183.13575282388905  E_coul = 55.01095979434192
init E= -128.124793029547
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74295346840666  LUMO = 2.64222619936096
  mo_energy =
[-3.25132750e+01 -1.85365069e+00 -7.42953468e-01 -7.42953468e-01
 -7.42953468e-01  2.64222620e+00  2.64222620e+00  2.64222620e+00
  2.76633763e+00  1.99053890e+01  1.99053890e+01  1.99053890e+01
  4.45413598e+01  3.22325463e+02  1.99158830e+03  7.28107762e+03]
E1 = -182.1185470646049  E_coul = 53.92310506331851
cycle= 1 E= -128.195442001286  delta_E= -0.0706  |g|= 0.167  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263371
diis-c [-0.06936405  1.        ]
  HOMO = -0.808732319519539  LUMO = 2.58762197713899
  mo_energy =
[-3.27893843e+01 -1.92196932e+00 -8.08732320e-01 -8.08732320e-01
 -8.08732320e-01  2.58762198e+00  2.58762198e+00  2.58762198e+00
  2.71150171e+00  1.97127730e+01  1.97127730e+01  1.97127730e+01
  4.43048414e+01  3.22013490e+02  1.99122611e+03  7.28069026e+03]
E1 = -182.58643996940944  E_coul = 54.3893314447092
cycle= 2 E= -128.1971085247  delta_E= -0.00167  |g|= 0.0632  |ddm|= 0.0651
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.103081
diis-c [-4.51986405e-04  2.77577354e-01  7.22422646e-01]
  HOMO = -0.785685935660009  LUMO = 2.60839770491054
  mo_energy =
[-3.27137515e+01 -1.89805255e+00 -7.85685936e-01 -7.85685936e-01
 -7.85685936e-01  2.60839770e+00  2.60839770e+00  2.60839770e+00
  2.73191487e+00  1.97695904e+01  1.97695904e+01  1.97695904e+01
  4.43714529e+01  3.22096032e+02  1.99131432e+03  7.28077999e+03]
E1 = -182.45241745295579  E_coul = 54.25499641101219
cycle= 3 E= -128.197421041944  delta_E= -0.000313  |g|= 0.000755  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000950848
diis-c [-9.63573978e-08 -3.84678313e-03 -1.11829672e-03  1.00496508e+00]
  HOMO = -0.78593288414067  LUMO = 2.60820986017474
  mo_energy =
[-3.27144711e+01 -1.89837821e+00 -7.85932884e-01 -7.85932884e-01
 -7.85932884e-01  2.60820986e+00  2.60820986e+00  2.60820986e+00
  2.73165747e+00  1.97690312e+01  1.97690312e+01  1.97690312e+01
  4.43707791e+01  3.22095473e+02  1.99131390e+03  7.28077962e+03]
E1 = -182.45379968046612  E_coul = 54.256378598755916
cycle= 4 E= -128.19742108171  delta_E= -3.98e-08  |g|= 5.7e-05  |ddm|= 0.000287
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.01708e-05
diis-c [-2.51669957e-10  4.91806853e-04 -1.07084770e-03 -1.71524102e-01
  1.17210314e+00]
  HOMO = -0.785916844910873  LUMO = 2.60822371877272
  mo_energy =
[-3.27144297e+01 -1.89837568e+00 -7.85916845e-01 -7.85916845e-01
 -7.85916845e-01  2.60822372e+00  2.60822372e+00  2.60822372e+00
  2.73165878e+00  1.97690631e+01  1.97690631e+01  1.97690631e+01
  4.43708124e+01  3.22095530e+02  1.99131398e+03  7.28077970e+03]
E1 = -182.45373012684738  E_coul = 54.256309044763945
cycle= 5 E= -128.197421082083  delta_E= -3.73e-10  |g|= 1.66e-06  |ddm|= 2.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45373012684738  E_coul = 54.256309044763945
  HOMO = -0.785916782155783  LUMO = 2.60822378501168
  mo_energy =
[-3.27144296e+01 -1.89837603e+00 -7.85916782e-01 -7.85916782e-01
 -7.85916782e-01  2.60822379e+00  2.60822379e+00  2.60822379e+00
  2.73165848e+00  1.97690631e+01  1.97690631e+01  1.97690631e+01
  4.43708123e+01  3.22095530e+02  1.99131398e+03  7.28077970e+03]
E1 = -182.453730123658  E_coul = 54.25630904157424
Extra cycle  E= -128.197421082084  delta_E= -3.41e-13  |g|= 3.03e-07  |ddm|= 9.62e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14425586e+03 2.17285952e+02 1.42908821e+03 5.75738916e-01
 4.87140348e+01 1.31226071e+01 1.92933078e+00 2.76477819e+00
 1.33249921e+01 5.97918892e-01]
E = -128.19742108208376
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.25585668        1
[INPUT] 0    0    [1    /1   ]  217.285952481        1
[INPUT] 0    0    [1    /1   ]  1429.08820712        1
[INPUT] 0    0    [1    /1   ]  0.575738915828       1
[INPUT] 0    0    [1    /1   ]  48.7140348435        1
[INPUT] 0    0    [1    /1   ]  13.1226070549        1
[INPUT] 0    0    [1    /1   ]  1.9293307807         1
[INPUT] 1    0    [1    /1   ]  2.76477819341        1
[INPUT] 1    0    [1    /1   ]  13.324992074         1
[INPUT] 1    0    [1    /1   ]  0.597918892432       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.2558566765715, 1.0]], [0, [217.28595248102636, 1.0]], [0, [1429.0882071160795, 1.0]], [0, [0.5757389158282734, 1.0]], [0, [48.71403484351821, 1.0]], [0, [13.122607054855512, 1.0]], [0, [1.929330780697877, 1.0]], [1, [2.764778193405565, 1.0]], [1, [13.324992073983529, 1.0]], [1, [0.5979188924319132, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.25585668]
bas 1, expnt(s) = [217.28595248]
bas 2, expnt(s) = [1429.08820712]
bas 3, expnt(s) = [0.57573892]
bas 4, expnt(s) = [48.71403484]
bas 5, expnt(s) = [13.12260705]
bas 6, expnt(s) = [1.92933078]
bas 7, expnt(s) = [2.76477819]
bas 8, expnt(s) = [13.32499207]
bas 9, expnt(s) = [0.59791889]
CPU time:        89.44
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14425586e+03 7.96108898e+02 2.17285952e+02 1.42984434e+02
 1.42908821e+03 5.87231442e+02 5.75738916e-01 1.66987596e+00
 4.87140348e+01 4.65860192e+01 1.31226071e+01 1.74192767e+01
 1.92933078e+00 4.13590014e+00 2.76477819e+00 1.04006328e+01
 1.33249921e+01 7.42707983e+01 5.97918892e-01 1.53386535e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966153763199793
cond(S) = 157.0652561191255
E1 = -183.13575282388905  E_coul = 55.01095979434192
init E= -128.124793029547
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74295346840666  LUMO = 2.64222619936096
  mo_energy =
[-3.25132750e+01 -1.85365069e+00 -7.42953468e-01 -7.42953468e-01
 -7.42953468e-01  2.64222620e+00  2.64222620e+00  2.64222620e+00
  2.76633763e+00  1.99053890e+01  1.99053890e+01  1.99053890e+01
  4.45413598e+01  3.22325463e+02  1.99158830e+03  7.28107762e+03]
E1 = -182.1185470646049  E_coul = 53.92310506331851
cycle= 1 E= -128.195442001286  delta_E= -0.0706  |g|= 0.167  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263371
diis-c [-0.06936405  1.        ]
  HOMO = -0.808732319519539  LUMO = 2.58762197713899
  mo_energy =
[-3.27893843e+01 -1.92196932e+00 -8.08732320e-01 -8.08732320e-01
 -8.08732320e-01  2.58762198e+00  2.58762198e+00  2.58762198e+00
  2.71150171e+00  1.97127730e+01  1.97127730e+01  1.97127730e+01
  4.43048414e+01  3.22013490e+02  1.99122611e+03  7.28069026e+03]
E1 = -182.58643996940944  E_coul = 54.3893314447092
cycle= 2 E= -128.1971085247  delta_E= -0.00167  |g|= 0.0632  |ddm|= 0.0651
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.103081
diis-c [-4.51986405e-04  2.77577354e-01  7.22422646e-01]
  HOMO = -0.785685935660009  LUMO = 2.60839770491054
  mo_energy =
[-3.27137515e+01 -1.89805255e+00 -7.85685936e-01 -7.85685936e-01
 -7.85685936e-01  2.60839770e+00  2.60839770e+00  2.60839770e+00
  2.73191487e+00  1.97695904e+01  1.97695904e+01  1.97695904e+01
  4.43714529e+01  3.22096032e+02  1.99131432e+03  7.28077999e+03]
E1 = -182.45241745295579  E_coul = 54.25499641101219
cycle= 3 E= -128.197421041944  delta_E= -0.000313  |g|= 0.000755  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000950848
diis-c [-9.63573978e-08 -3.84678313e-03 -1.11829672e-03  1.00496508e+00]
  HOMO = -0.78593288414067  LUMO = 2.60820986017474
  mo_energy =
[-3.27144711e+01 -1.89837821e+00 -7.85932884e-01 -7.85932884e-01
 -7.85932884e-01  2.60820986e+00  2.60820986e+00  2.60820986e+00
  2.73165747e+00  1.97690312e+01  1.97690312e+01  1.97690312e+01
  4.43707791e+01  3.22095473e+02  1.99131390e+03  7.28077962e+03]
E1 = -182.45379968046612  E_coul = 54.256378598755916
cycle= 4 E= -128.19742108171  delta_E= -3.98e-08  |g|= 5.7e-05  |ddm|= 0.000287
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.01708e-05
diis-c [-2.51669957e-10  4.91806853e-04 -1.07084770e-03 -1.71524102e-01
  1.17210314e+00]
  HOMO = -0.785916844910873  LUMO = 2.60822371877272
  mo_energy =
[-3.27144297e+01 -1.89837568e+00 -7.85916845e-01 -7.85916845e-01
 -7.85916845e-01  2.60822372e+00  2.60822372e+00  2.60822372e+00
  2.73165878e+00  1.97690631e+01  1.97690631e+01  1.97690631e+01
  4.43708124e+01  3.22095530e+02  1.99131398e+03  7.28077970e+03]
E1 = -182.45373012684738  E_coul = 54.256309044763945
cycle= 5 E= -128.197421082083  delta_E= -3.73e-10  |g|= 1.66e-06  |ddm|= 2.92e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45373012684738  E_coul = 54.256309044763945
  HOMO = -0.785916782155783  LUMO = 2.60822378501168
  mo_energy =
[-3.27144296e+01 -1.89837603e+00 -7.85916782e-01 -7.85916782e-01
 -7.85916782e-01  2.60822379e+00  2.60822379e+00  2.60822379e+00
  2.73165848e+00  1.97690631e+01  1.97690631e+01  1.97690631e+01
  4.43708123e+01  3.22095530e+02  1.99131398e+03  7.28077970e+03]
E1 = -182.453730123658  E_coul = 54.25630904157424
Extra cycle  E= -128.197421082084  delta_E= -3.41e-13  |g|= 3.03e-07  |ddm|= 9.62e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 157.0652561191255
E1 = -182.453730123658  E_coul = 54.25630904157424
init E= -128.197421082084
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785916766155592  LUMO = 2.6082237977093
  mo_energy =
[-3.27144296e+01 -1.89837609e+00 -7.85916766e-01 -7.85916766e-01
 -7.85916766e-01  2.60822380e+00  2.60822380e+00  2.60822380e+00
  2.73165842e+00  1.97690631e+01  1.97690631e+01  1.97690631e+01
  4.43708123e+01  3.22095530e+02  1.99131398e+03  7.28077970e+03]
E1 = -182.45373013115588  E_coul = 54.25630904907196
cycle= 1 E= -128.197421082084  delta_E= -1.42e-13  |g|= 5.53e-08  |ddm|= 1.73e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45373013115588  E_coul = 54.25630904907196
  HOMO = -0.785916762555321  LUMO = 2.60822380066306
  mo_energy =
[-3.27144296e+01 -1.89837610e+00 -7.85916763e-01 -7.85916763e-01
 -7.85916763e-01  2.60822380e+00  2.60822380e+00  2.60822380e+00
  2.73165841e+00  1.97690631e+01  1.97690631e+01  1.97690631e+01
  4.43708123e+01  3.22095530e+02  1.99131398e+03  7.28077970e+03]
E1 = -182.45373013005093  E_coul = 54.25630904796711
Extra cycle  E= -128.197421082084  delta_E= 8.53e-14  |g|= 1.01e-08  |ddm|= 3.1e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14425586e+03 2.17285952e+02 1.42908821e+03 5.75738916e-01
 4.87140348e+01 1.31226071e+01 1.92933078e+00 2.76477819e+00
 1.33249921e+01 5.97918892e-01]
grad_E = [-7.92324900e-06 -2.55554580e-04  4.39056293e-05  2.47233198e-03
  2.34471855e-04  9.40846848e-04  1.39848782e-04 -5.40145423e-03
  7.38585975e-04 -8.84487208e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.3003126         1
[INPUT] 0    0    [1    /1   ]  218.525290421        1
[INPUT] 0    0    [1    /1   ]  1428.83110054        1
[INPUT] 0    0    [1    /1   ]  0.578962214936       1
[INPUT] 0    0    [1    /1   ]  49.0162255895        1
[INPUT] 0    0    [1    /1   ]  13.1839680786        1
[INPUT] 0    0    [1    /1   ]  1.94062764484        1
[INPUT] 1    0    [1    /1   ]  2.76168356891        1
[INPUT] 1    0    [1    /1   ]  13.3192928463        1
[INPUT] 1    0    [1    /1   ]  0.597319851647       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.300312598227, 1.0]], [0, [218.52529042123837, 1.0]], [0, [1428.8311005385863, 1.0]], [0, [0.5789622149357465, 1.0]], [0, [49.01622558952833, 1.0]], [0, [13.18396807857057, 1.0]], [0, [1.940627644842786, 1.0]], [1, [2.7616835689128663, 1.0]], [1, [13.319292846307896, 1.0]], [1, [0.5973198516474355, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.3003126]
bas 1, expnt(s) = [218.52529042]
bas 2, expnt(s) = [1428.83110054]
bas 3, expnt(s) = [0.57896221]
bas 4, expnt(s) = [49.01622559]
bas 5, expnt(s) = [13.18396808]
bas 6, expnt(s) = [1.94062764]
bas 7, expnt(s) = [2.76168357]
bas 8, expnt(s) = [13.31929285]
bas 9, expnt(s) = [0.59731985]
CPU time:        91.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14430031e+03 7.96121277e+02 2.18525290e+02 1.43595657e+02
 1.42883110e+03 5.87152204e+02 5.78962215e-01 1.67688272e+00
 4.90162256e+01 4.68025940e+01 1.31839681e+01 1.74803302e+01
 1.94062764e+00 4.15404966e+00 2.76168357e+00 1.03860830e+01
 1.33192928e+01 7.42310925e+01 5.97319852e-01 1.53194466e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96620231434568
cond(S) = 157.5969873136927
E1 = -183.1356170844959  E_coul = 55.010990198483256
init E= -128.124626886013
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742963287839933  LUMO = 2.638633577118
  mo_energy =
[-3.25134277e+01 -1.85353369e+00 -7.42963288e-01 -7.42963288e-01
 -7.42963288e-01  2.63863358e+00  2.63863358e+00  2.63863358e+00
  2.79317793e+00  1.98879836e+01  1.98879836e+01  1.98879836e+01
  4.49034351e+01  3.24534627e+02  1.99649927e+03  7.28623076e+03]
E1 = -182.1173427106456  E_coul = 53.92175472590685
cycle= 1 E= -128.195587984739  delta_E= -0.071  |g|= 0.167  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263446
diis-c [-0.0694037  1.       ]
  HOMO = -0.808823745611655  LUMO = 2.58402349770777
  mo_energy =
[-3.27897663e+01 -1.92206513e+00 -8.08823746e-01 -8.08823746e-01
 -8.08823746e-01  2.58402350e+00  2.58402350e+00  2.58402350e+00
  2.73763888e+00  1.96952038e+01  1.96952038e+01  1.96952038e+01
  4.46662010e+01  3.24222447e+02  1.99613740e+03  7.28584391e+03]
E1 = -182.58592110900273  E_coul = 54.38866197063672
cycle= 2 E= -128.197259138366  delta_E= -0.00167  |g|= 0.0633  |ddm|= 0.0653
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.103238
diis-c [-4.50640561e-04  2.77849528e-01  7.22150472e-01]
  HOMO = -0.785753876038472  LUMO = 2.60479808992935
  mo_energy =
[-3.27140501e+01 -1.89811911e+00 -7.85753876e-01 -7.85753876e-01
 -7.85753876e-01  2.60479809e+00  2.60479809e+00  2.60479809e+00
  2.75822175e+00  1.97520767e+01  1.97520767e+01  1.97520767e+01
  4.47329861e+01  3.24305117e+02  1.99622572e+03  7.28593376e+03]
E1 = -182.4517214796312  E_coul = 54.254148810060826
cycle= 3 E= -128.19757266957  delta_E= -0.000314  |g|= 0.000748  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000923783
diis-c [-1.06674401e-07 -3.93011871e-03 -1.69520534e-03  1.00562532e+00]
  HOMO = -0.78599353963269  LUMO = 2.60461699575479
  mo_energy =
[-3.27147491e+01 -1.89844185e+00 -7.85993540e-01 -7.85993540e-01
 -7.85993540e-01  2.60461700e+00  2.60461700e+00  2.60461700e+00
  2.75796497e+00  1.97515333e+01  1.97515333e+01  1.97515333e+01
  4.47323290e+01  3.24304585e+02  1.99622534e+03  7.28593342e+03]
E1 = -182.45306766861626  E_coul = 54.25549495984454
cycle= 4 E= -128.197572708772  delta_E= -3.92e-08  |g|= 6.02e-05  |ddm|= 0.000291
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.50102e-05
diis-c [-2.58391290e-10  4.99365495e-04 -1.04714912e-03 -1.73453201e-01
  1.17400099e+00]
  HOMO = -0.785976734402025  LUMO = 2.60463149441525
  mo_energy =
[-3.27147057e+01 -1.89843938e+00 -7.85976734e-01 -7.85976734e-01
 -7.85976734e-01  2.60463149e+00  2.60463149e+00  2.60463149e+00
  2.75796619e+00  1.97515669e+01  1.97515669e+01  1.97515669e+01
  4.47323639e+01  3.24304645e+02  1.99622542e+03  7.28593351e+03]
E1 = -182.452994456653  E_coul = 54.25542174746444
cycle= 5 E= -128.197572709189  delta_E= -4.17e-10  |g|= 1.65e-06  |ddm|= 3.1e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.452994456653  E_coul = 54.25542174746444
  HOMO = -0.78597669068948  LUMO = 2.60463154437582
  mo_energy =
[-3.27147057e+01 -1.89843974e+00 -7.85976691e-01 -7.85976691e-01
 -7.85976691e-01  2.60463154e+00  2.60463154e+00  2.60463154e+00
  2.75796588e+00  1.97515668e+01  1.97515668e+01  1.97515668e+01
  4.47323638e+01  3.24304645e+02  1.99622542e+03  7.28593351e+03]
E1 = -182.45299453132023  E_coul = 54.255421822131304
Extra cycle  E= -128.197572709189  delta_E= -3.98e-13  |g|= 2.99e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14430031e+03 2.18525290e+02 1.42883110e+03 5.78962215e-01
 4.90162256e+01 1.31839681e+01 1.94062764e+00 2.76168357e+00
 1.33192928e+01 5.97319852e-01]
E = -128.19757270918893
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.3003126         1
[INPUT] 0    0    [1    /1   ]  218.525290421        1
[INPUT] 0    0    [1    /1   ]  1428.83110054        1
[INPUT] 0    0    [1    /1   ]  0.578962214936       1
[INPUT] 0    0    [1    /1   ]  49.0162255895        1
[INPUT] 0    0    [1    /1   ]  13.1839680786        1
[INPUT] 0    0    [1    /1   ]  1.94062764484        1
[INPUT] 1    0    [1    /1   ]  2.76168356891        1
[INPUT] 1    0    [1    /1   ]  13.3192928463        1
[INPUT] 1    0    [1    /1   ]  0.597319851647       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.300312598227, 1.0]], [0, [218.52529042123837, 1.0]], [0, [1428.8311005385863, 1.0]], [0, [0.5789622149357465, 1.0]], [0, [49.01622558952833, 1.0]], [0, [13.18396807857057, 1.0]], [0, [1.940627644842786, 1.0]], [1, [2.7616835689128663, 1.0]], [1, [13.319292846307896, 1.0]], [1, [0.5973198516474355, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.3003126]
bas 1, expnt(s) = [218.52529042]
bas 2, expnt(s) = [1428.83110054]
bas 3, expnt(s) = [0.57896221]
bas 4, expnt(s) = [49.01622559]
bas 5, expnt(s) = [13.18396808]
bas 6, expnt(s) = [1.94062764]
bas 7, expnt(s) = [2.76168357]
bas 8, expnt(s) = [13.31929285]
bas 9, expnt(s) = [0.59731985]
CPU time:        92.38
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14430031e+03 7.96121277e+02 2.18525290e+02 1.43595657e+02
 1.42883110e+03 5.87152204e+02 5.78962215e-01 1.67688272e+00
 4.90162256e+01 4.68025940e+01 1.31839681e+01 1.74803302e+01
 1.94062764e+00 4.15404966e+00 2.76168357e+00 1.03860830e+01
 1.33192928e+01 7.42310925e+01 5.97319852e-01 1.53194466e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96620231434568
cond(S) = 157.5969873136927
E1 = -183.1356170844959  E_coul = 55.010990198483256
init E= -128.124626886013
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742963287839933  LUMO = 2.638633577118
  mo_energy =
[-3.25134277e+01 -1.85353369e+00 -7.42963288e-01 -7.42963288e-01
 -7.42963288e-01  2.63863358e+00  2.63863358e+00  2.63863358e+00
  2.79317793e+00  1.98879836e+01  1.98879836e+01  1.98879836e+01
  4.49034351e+01  3.24534627e+02  1.99649927e+03  7.28623076e+03]
E1 = -182.1173427106456  E_coul = 53.92175472590685
cycle= 1 E= -128.195587984739  delta_E= -0.071  |g|= 0.167  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263446
diis-c [-0.0694037  1.       ]
  HOMO = -0.808823745611655  LUMO = 2.58402349770777
  mo_energy =
[-3.27897663e+01 -1.92206513e+00 -8.08823746e-01 -8.08823746e-01
 -8.08823746e-01  2.58402350e+00  2.58402350e+00  2.58402350e+00
  2.73763888e+00  1.96952038e+01  1.96952038e+01  1.96952038e+01
  4.46662010e+01  3.24222447e+02  1.99613740e+03  7.28584391e+03]
E1 = -182.58592110900273  E_coul = 54.38866197063672
cycle= 2 E= -128.197259138366  delta_E= -0.00167  |g|= 0.0633  |ddm|= 0.0653
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.103238
diis-c [-4.50640561e-04  2.77849528e-01  7.22150472e-01]
  HOMO = -0.785753876038472  LUMO = 2.60479808992935
  mo_energy =
[-3.27140501e+01 -1.89811911e+00 -7.85753876e-01 -7.85753876e-01
 -7.85753876e-01  2.60479809e+00  2.60479809e+00  2.60479809e+00
  2.75822175e+00  1.97520767e+01  1.97520767e+01  1.97520767e+01
  4.47329861e+01  3.24305117e+02  1.99622572e+03  7.28593376e+03]
E1 = -182.4517214796312  E_coul = 54.254148810060826
cycle= 3 E= -128.19757266957  delta_E= -0.000314  |g|= 0.000748  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000923783
diis-c [-1.06674401e-07 -3.93011871e-03 -1.69520534e-03  1.00562532e+00]
  HOMO = -0.78599353963269  LUMO = 2.60461699575479
  mo_energy =
[-3.27147491e+01 -1.89844185e+00 -7.85993540e-01 -7.85993540e-01
 -7.85993540e-01  2.60461700e+00  2.60461700e+00  2.60461700e+00
  2.75796497e+00  1.97515333e+01  1.97515333e+01  1.97515333e+01
  4.47323290e+01  3.24304585e+02  1.99622534e+03  7.28593342e+03]
E1 = -182.45306766861626  E_coul = 54.25549495984454
cycle= 4 E= -128.197572708772  delta_E= -3.92e-08  |g|= 6.02e-05  |ddm|= 0.000291
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.50102e-05
diis-c [-2.58391290e-10  4.99365495e-04 -1.04714912e-03 -1.73453201e-01
  1.17400099e+00]
  HOMO = -0.785976734402025  LUMO = 2.60463149441525
  mo_energy =
[-3.27147057e+01 -1.89843938e+00 -7.85976734e-01 -7.85976734e-01
 -7.85976734e-01  2.60463149e+00  2.60463149e+00  2.60463149e+00
  2.75796619e+00  1.97515669e+01  1.97515669e+01  1.97515669e+01
  4.47323639e+01  3.24304645e+02  1.99622542e+03  7.28593351e+03]
E1 = -182.452994456653  E_coul = 54.25542174746444
cycle= 5 E= -128.197572709189  delta_E= -4.17e-10  |g|= 1.65e-06  |ddm|= 3.1e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.452994456653  E_coul = 54.25542174746444
  HOMO = -0.78597669068948  LUMO = 2.60463154437582
  mo_energy =
[-3.27147057e+01 -1.89843974e+00 -7.85976691e-01 -7.85976691e-01
 -7.85976691e-01  2.60463154e+00  2.60463154e+00  2.60463154e+00
  2.75796588e+00  1.97515668e+01  1.97515668e+01  1.97515668e+01
  4.47323638e+01  3.24304645e+02  1.99622542e+03  7.28593351e+03]
E1 = -182.45299453132023  E_coul = 54.255421822131304
Extra cycle  E= -128.197572709189  delta_E= -3.98e-13  |g|= 2.99e-07  |ddm|= 9.56e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 157.5969873136927
E1 = -182.45299453132023  E_coul = 54.255421822131304
init E= -128.197572709189
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785976669747048  LUMO = 2.6046315615241
  mo_energy =
[-3.27147056e+01 -1.89843979e+00 -7.85976670e-01 -7.85976670e-01
 -7.85976670e-01  2.60463156e+00  2.60463156e+00  2.60463156e+00
  2.75796583e+00  1.97515669e+01  1.97515669e+01  1.97515669e+01
  4.47323639e+01  3.24304645e+02  1.99622542e+03  7.28593351e+03]
E1 = -182.4529945054892  E_coul = 54.25542179630041
cycle= 1 E= -128.197572709189  delta_E= 1.71e-13  |g|= 5.51e-08  |ddm|= 1.69e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4529945054892  E_coul = 54.25542179630041
  HOMO = -0.785976668492644  LUMO = 2.60463156236675
  mo_energy =
[-3.27147056e+01 -1.89843981e+00 -7.85976668e-01 -7.85976668e-01
 -7.85976668e-01  2.60463156e+00  2.60463156e+00  2.60463156e+00
  2.75796582e+00  1.97515669e+01  1.97515669e+01  1.97515669e+01
  4.47323638e+01  3.24304645e+02  1.99622542e+03  7.28593351e+03]
E1 = -182.45299451724645  E_coul = 54.255421808057584
Extra cycle  E= -128.197572709189  delta_E= -1.14e-13  |g|= 9.87e-09  |ddm|= 3.12e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14430031e+03 2.18525290e+02 1.42883110e+03 5.78962215e-01
 4.90162256e+01 1.31839681e+01 1.94062764e+00 2.76168357e+00
 1.33192928e+01 5.97319852e-01]
grad_E = [-8.15044492e-06 -2.48306578e-04  4.28897547e-05  2.92815780e-03
  3.19149752e-04  1.12826400e-03  1.79738861e-04 -6.47567393e-03
  8.67403529e-04 -1.07337221e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.37928631        1
[INPUT] 0    0    [1    /1   ]  220.742801157        1
[INPUT] 0    0    [1    /1   ]  1428.37397168        1
[INPUT] 0    0    [1    /1   ]  0.582817651809       1
[INPUT] 0    0    [1    /1   ]  49.473162792         1
[INPUT] 0    0    [1    /1   ]  13.2670423798        1
[INPUT] 0    0    [1    /1   ]  1.95448475054        1
[INPUT] 1    0    [1    /1   ]  2.75866310296        1
[INPUT] 1    0    [1    /1   ]  13.3090411372        1
[INPUT] 1    0    [1    /1   ]  0.596782054214       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.3792863103768, 1.0]], [0, [220.74280115713157, 1.0]], [0, [1428.3739716775872, 1.0]], [0, [0.5828176518092021, 1.0]], [0, [49.47316279203622, 1.0]], [0, [13.267042379836221, 1.0]], [0, [1.9544847505397347, 1.0]], [1, [2.758663102963617, 1.0]], [1, [13.309041137225876, 1.0]], [1, [0.5967820542136604, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.37928631]
bas 1, expnt(s) = [220.74280116]
bas 2, expnt(s) = [1428.37397168]
bas 3, expnt(s) = [0.58281765]
bas 4, expnt(s) = [49.47316279]
bas 5, expnt(s) = [13.26704238]
bas 6, expnt(s) = [1.95448475]
bas 7, expnt(s) = [2.7586631]
bas 8, expnt(s) = [13.30904114]
bas 9, expnt(s) = [0.59678205]
CPU time:        94.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14437929e+03 7.96143267e+02 2.20742801e+02 1.44687141e+02
 1.42837397e+03 5.87011312e+02 5.82817652e-01 1.68525082e+00
 4.94731628e+01 4.71294402e+01 1.32670424e+01 1.75628750e+01
 1.95448475e+00 4.17627645e+00 2.75866310e+00 1.03718858e+01
 1.33090411e+01 7.41596808e+01 5.96782054e-01 1.53022075e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96622103504049
cond(S) = 158.45139978671483
E1 = -183.13553813049384  E_coul = 55.01106682531692
init E= -128.124471305177
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742968750550221  LUMO = 2.63535325966113
  mo_energy =
[-3.25136510e+01 -1.85338138e+00 -7.42968751e-01 -7.42968751e-01
 -7.42968751e-01  2.63535326e+00  2.63535326e+00  2.63535326e+00
  2.82604858e+00  1.98662554e+01  1.98662554e+01  1.98662554e+01
  4.54096688e+01  3.28116435e+02  2.00487271e+03  7.29507201e+03]
E1 = -182.1170492769081  E_coul = 53.92121720887963
cycle= 1 E= -128.195832068028  delta_E= -0.0714  |g|= 0.167  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263313
diis-c [-0.06933348  1.        ]
  HOMO = -0.808859315630802  LUMO = 2.58078267606907
  mo_energy =
[-3.27900375e+01 -1.92208031e+00 -8.08859316e-01 -8.08859316e-01
 -8.08859316e-01  2.58078268e+00  2.58078268e+00  2.58078268e+00
  2.76972743e+00  1.96734636e+01  1.96734636e+01  1.96734636e+01
  4.51716762e+01  3.27804152e+02  2.00451149e+03  7.29468611e+03]
E1 = -182.58599377701378  E_coul = 54.38848782476685
cycle= 2 E= -128.197505952247  delta_E= -0.00167  |g|= 0.0634  |ddm|= 0.0654
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.103329
diis-c [-4.45336218e-04  2.78180759e-01  7.21819241e-01]
  HOMO = -0.785784652606796  LUMO = 2.6015410349563
  mo_energy =
[-3.27142925e+01 -1.89812324e+00 -7.85784653e-01 -7.85784653e-01
 -7.85784653e-01  2.60154103e+00  2.60154103e+00  2.60154103e+00
  2.79049813e+00  1.97303426e+01  1.97303426e+01  1.97303426e+01
  4.52386309e+01  3.27886913e+02  2.00459986e+03  7.29477601e+03]
E1 = -182.45172657288384  E_coul = 54.25390647975334
cycle= 3 E= -128.197820093131  delta_E= -0.000314  |g|= 0.000737  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000888328
diis-c [-1.17160530e-07 -4.03231341e-03 -2.41841495e-03  1.00645073e+00]
  HOMO = -0.786014656937031  LUMO = 2.60136875787944
  mo_energy =
[-3.27149630e+01 -1.89844055e+00 -7.86014657e-01 -7.86014657e-01
 -7.86014657e-01  2.60136876e+00  2.60136876e+00  2.60136876e+00
  2.79024371e+00  1.97298211e+01  1.97298211e+01  1.97298211e+01
  4.52379973e+01  3.27886416e+02  2.00459952e+03  7.29477572e+03]
E1 = -182.45302208010625  E_coul = 54.25520194883763
cycle= 4 E= -128.197820131269  delta_E= -3.81e-08  |g|= 6.33e-05  |ddm|= 0.000293
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.97044e-05
diis-c [-2.61352638e-10  5.07739587e-04 -1.00002754e-03 -1.75169586e-01
  1.17566187e+00]
  HOMO = -0.785997130458559  LUMO = 2.60138385328849
  mo_energy =
[-3.27149176e+01 -1.89843816e+00 -7.85997130e-01 -7.85997130e-01
 -7.85997130e-01  2.60138385e+00  2.60138385e+00  2.60138385e+00
  2.79024485e+00  1.97298561e+01  1.97298561e+01  1.97298561e+01
  4.52380339e+01  3.27886479e+02  2.00459960e+03  7.29477581e+03]
E1 = -182.4529452801731  E_coul = 54.255125148443426
cycle= 5 E= -128.19782013173  delta_E= -4.61e-10  |g|= 1.63e-06  |ddm|= 3.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4529452801731  E_coul = 54.255125148443426
  HOMO = -0.785997107192114  LUMO = 2.60138388622407
  mo_energy =
[-3.27149176e+01 -1.89843854e+00 -7.85997107e-01 -7.85997107e-01
 -7.85997107e-01  2.60138389e+00  2.60138389e+00  2.60138389e+00
  2.79024452e+00  1.97298560e+01  1.97298560e+01  1.97298560e+01
  4.52380338e+01  3.27886479e+02  2.00459960e+03  7.29477581e+03]
E1 = -182.4529454340387  E_coul = 54.255125302308755
Extra cycle  E= -128.19782013173  delta_E= -2.56e-13  |g|= 2.93e-07  |ddm|= 9.42e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14437929e+03 2.20742801e+02 1.42837397e+03 5.82817652e-01
 4.94731628e+01 1.32670424e+01 1.95448475e+00 2.75866310e+00
 1.33090411e+01 5.96782054e-01]
E = -128.19782013172994
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.37928631        1
[INPUT] 0    0    [1    /1   ]  220.742801157        1
[INPUT] 0    0    [1    /1   ]  1428.37397168        1
[INPUT] 0    0    [1    /1   ]  0.582817651809       1
[INPUT] 0    0    [1    /1   ]  49.473162792         1
[INPUT] 0    0    [1    /1   ]  13.2670423798        1
[INPUT] 0    0    [1    /1   ]  1.95448475054        1
[INPUT] 1    0    [1    /1   ]  2.75866310296        1
[INPUT] 1    0    [1    /1   ]  13.3090411372        1
[INPUT] 1    0    [1    /1   ]  0.596782054214       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.3792863103768, 1.0]], [0, [220.74280115713157, 1.0]], [0, [1428.3739716775872, 1.0]], [0, [0.5828176518092021, 1.0]], [0, [49.47316279203622, 1.0]], [0, [13.267042379836221, 1.0]], [0, [1.9544847505397347, 1.0]], [1, [2.758663102963617, 1.0]], [1, [13.309041137225876, 1.0]], [1, [0.5967820542136604, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.37928631]
bas 1, expnt(s) = [220.74280116]
bas 2, expnt(s) = [1428.37397168]
bas 3, expnt(s) = [0.58281765]
bas 4, expnt(s) = [49.47316279]
bas 5, expnt(s) = [13.26704238]
bas 6, expnt(s) = [1.95448475]
bas 7, expnt(s) = [2.7586631]
bas 8, expnt(s) = [13.30904114]
bas 9, expnt(s) = [0.59678205]
CPU time:        95.39
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14437929e+03 7.96143267e+02 2.20742801e+02 1.44687141e+02
 1.42837397e+03 5.87011312e+02 5.82817652e-01 1.68525082e+00
 4.94731628e+01 4.71294402e+01 1.32670424e+01 1.75628750e+01
 1.95448475e+00 4.17627645e+00 2.75866310e+00 1.03718858e+01
 1.33090411e+01 7.41596808e+01 5.96782054e-01 1.53022075e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96622103504049
cond(S) = 158.45139978671483
E1 = -183.13553813049384  E_coul = 55.01106682531692
init E= -128.124471305177
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742968750550221  LUMO = 2.63535325966113
  mo_energy =
[-3.25136510e+01 -1.85338138e+00 -7.42968751e-01 -7.42968751e-01
 -7.42968751e-01  2.63535326e+00  2.63535326e+00  2.63535326e+00
  2.82604858e+00  1.98662554e+01  1.98662554e+01  1.98662554e+01
  4.54096688e+01  3.28116435e+02  2.00487271e+03  7.29507201e+03]
E1 = -182.1170492769081  E_coul = 53.92121720887963
cycle= 1 E= -128.195832068028  delta_E= -0.0714  |g|= 0.167  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263313
diis-c [-0.06933348  1.        ]
  HOMO = -0.808859315630802  LUMO = 2.58078267606907
  mo_energy =
[-3.27900375e+01 -1.92208031e+00 -8.08859316e-01 -8.08859316e-01
 -8.08859316e-01  2.58078268e+00  2.58078268e+00  2.58078268e+00
  2.76972743e+00  1.96734636e+01  1.96734636e+01  1.96734636e+01
  4.51716762e+01  3.27804152e+02  2.00451149e+03  7.29468611e+03]
E1 = -182.58599377701378  E_coul = 54.38848782476685
cycle= 2 E= -128.197505952247  delta_E= -0.00167  |g|= 0.0634  |ddm|= 0.0654
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.103329
diis-c [-4.45336218e-04  2.78180759e-01  7.21819241e-01]
  HOMO = -0.785784652606796  LUMO = 2.6015410349563
  mo_energy =
[-3.27142925e+01 -1.89812324e+00 -7.85784653e-01 -7.85784653e-01
 -7.85784653e-01  2.60154103e+00  2.60154103e+00  2.60154103e+00
  2.79049813e+00  1.97303426e+01  1.97303426e+01  1.97303426e+01
  4.52386309e+01  3.27886913e+02  2.00459986e+03  7.29477601e+03]
E1 = -182.45172657288384  E_coul = 54.25390647975334
cycle= 3 E= -128.197820093131  delta_E= -0.000314  |g|= 0.000737  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000888328
diis-c [-1.17160530e-07 -4.03231341e-03 -2.41841495e-03  1.00645073e+00]
  HOMO = -0.786014656937031  LUMO = 2.60136875787944
  mo_energy =
[-3.27149630e+01 -1.89844055e+00 -7.86014657e-01 -7.86014657e-01
 -7.86014657e-01  2.60136876e+00  2.60136876e+00  2.60136876e+00
  2.79024371e+00  1.97298211e+01  1.97298211e+01  1.97298211e+01
  4.52379973e+01  3.27886416e+02  2.00459952e+03  7.29477572e+03]
E1 = -182.45302208010625  E_coul = 54.25520194883763
cycle= 4 E= -128.197820131269  delta_E= -3.81e-08  |g|= 6.33e-05  |ddm|= 0.000293
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.97044e-05
diis-c [-2.61352638e-10  5.07739587e-04 -1.00002754e-03 -1.75169586e-01
  1.17566187e+00]
  HOMO = -0.785997130458559  LUMO = 2.60138385328849
  mo_energy =
[-3.27149176e+01 -1.89843816e+00 -7.85997130e-01 -7.85997130e-01
 -7.85997130e-01  2.60138385e+00  2.60138385e+00  2.60138385e+00
  2.79024485e+00  1.97298561e+01  1.97298561e+01  1.97298561e+01
  4.52380339e+01  3.27886479e+02  2.00459960e+03  7.29477581e+03]
E1 = -182.4529452801731  E_coul = 54.255125148443426
cycle= 5 E= -128.19782013173  delta_E= -4.61e-10  |g|= 1.63e-06  |ddm|= 3.27e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4529452801731  E_coul = 54.255125148443426
  HOMO = -0.785997107192114  LUMO = 2.60138388622407
  mo_energy =
[-3.27149176e+01 -1.89843854e+00 -7.85997107e-01 -7.85997107e-01
 -7.85997107e-01  2.60138389e+00  2.60138389e+00  2.60138389e+00
  2.79024452e+00  1.97298560e+01  1.97298560e+01  1.97298560e+01
  4.52380338e+01  3.27886479e+02  2.00459960e+03  7.29477581e+03]
E1 = -182.4529454340387  E_coul = 54.255125302308755
Extra cycle  E= -128.19782013173  delta_E= -2.56e-13  |g|= 2.93e-07  |ddm|= 9.42e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 158.45139978671483
E1 = -182.4529454340387  E_coul = 54.255125302308755
init E= -128.19782013173
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785997081372612  LUMO = 2.60138390777377
  mo_energy =
[-3.27149176e+01 -1.89843858e+00 -7.85997081e-01 -7.85997081e-01
 -7.85997081e-01  2.60138391e+00  2.60138391e+00  2.60138391e+00
  2.79024448e+00  1.97298561e+01  1.97298561e+01  1.97298561e+01
  4.52380338e+01  3.27886479e+02  2.00459960e+03  7.29477581e+03]
E1 = -182.45294537404655  E_coul = 54.25512524231655
cycle= 1 E= -128.19782013173  delta_E= -5.68e-14  |g|= 5.48e-08  |ddm|= 1.64e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45294537404655  E_coul = 54.25512524231655
  HOMO = -0.78599708254955  LUMO = 2.60138390643565
  mo_energy =
[-3.27149176e+01 -1.89843860e+00 -7.85997083e-01 -7.85997083e-01
 -7.85997083e-01  2.60138391e+00  2.60138391e+00  2.60138391e+00
  2.79024446e+00  1.97298561e+01  1.97298561e+01  1.97298561e+01
  4.52380338e+01  3.27886479e+02  2.00459960e+03  7.29477581e+03]
E1 = -182.45294539894618  E_coul = 54.25512526721631
Extra cycle  E= -128.19782013173  delta_E= 1.14e-13  |g|= 9.93e-09  |ddm|= 3.13e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14437929e+03 2.20742801e+02 1.42837397e+03 5.82817652e-01
 4.94731628e+01 1.32670424e+01 1.95448475e+00 2.75866310e+00
 1.33090411e+01 5.96782054e-01]
grad_E = [-8.57105401e-06 -2.19795102e-04  4.09349169e-05  3.21978670e-03
  4.02177655e-04  1.26566598e-03  2.25801222e-04 -7.23630768e-03
  9.33461604e-04 -1.21936076e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.51817011        1
[INPUT] 0    0    [1    /1   ]  224.670965124        1
[INPUT] 0    0    [1    /1   ]  1427.56936313        1
[INPUT] 0    0    [1    /1   ]  0.586321848543       1
[INPUT] 0    0    [1    /1   ]  50.1334034228        1
[INPUT] 0    0    [1    /1   ]  13.3672145378        1
[INPUT] 0    0    [1    /1   ]  1.96780341887        1
[INPUT] 1    0    [1    /1   ]  2.7575540701         1
[INPUT] 1    0    [1    /1   ]  13.2908587207        1
[INPUT] 1    0    [1    /1   ]  0.59673017646        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.5181701090196, 1.0]], [0, [224.6709651241036, 1.0]], [0, [1427.5693631282966, 1.0]], [0, [0.5863218485430557, 1.0]], [0, [50.133403422830355, 1.0]], [0, [13.367214537786658, 1.0]], [0, [1.9678034188691589, 1.0]], [1, [2.7575540700962855, 1.0]], [1, [13.290858720705122, 1.0]], [1, [0.5967301764599008, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.51817011]
bas 1, expnt(s) = [224.67096512]
bas 2, expnt(s) = [1427.56936313]
bas 3, expnt(s) = [0.58632185]
bas 4, expnt(s) = [50.13340342]
bas 5, expnt(s) = [13.36721454]
bas 6, expnt(s) = [1.96780342]
bas 7, expnt(s) = [2.75755407]
bas 8, expnt(s) = [13.29085872]
bas 9, expnt(s) = [0.59673018]
CPU time:        97.74
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14451817e+03 7.96181940e+02 2.24670965e+02 1.46613931e+02
 1.42756936e+03 5.86763295e+02 5.86321849e-01 1.69284456e+00
 5.01334034e+01 4.76003796e+01 1.33672145e+01 1.76622372e+01
 1.96780342e+00 4.19760248e+00 2.75755407e+00 1.03666739e+01
 1.32908587e+01 7.40330590e+01 5.96730176e-01 1.53005447e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966146278333229
cond(S) = 159.80195882915487
E1 = -183.1356107088683  E_coul = 55.011251206895906
init E= -128.124359501972
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742958245746297  LUMO = 2.63484657743954
  mo_energy =
[-3.25139166e+01 -1.85322083e+00 -7.42958246e-01 -7.42958246e-01
 -7.42958246e-01  2.63484658e+00  2.63484658e+00  2.63484658e+00
  2.85747212e+00  1.98437129e+01  1.98437129e+01  1.98437129e+01
  4.60562870e+01  3.33802224e+02  2.01895615e+03  7.31006100e+03]
E1 = -182.1194761235049  E_coul = 53.92329467739425
cycle= 1 E= -128.196181446111  delta_E= -0.0718  |g|= 0.167  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262665
diis-c [-0.06899309  1.        ]
  HOMO = -0.808718730112273  LUMO = 2.58041844772997
  mo_energy =
[-3.27898078e+01 -1.92186414e+00 -8.08718730e-01 -8.08718730e-01
 -8.08718730e-01  2.58041845e+00  2.58041845e+00  2.58041845e+00
  2.80058427e+00  1.96513498e+01  1.96513498e+01  1.96513498e+01
  4.58178158e+01  3.33490169e+02  2.01859618e+03  7.30967677e+03]
E1 = -182.58768603471088  E_coul = 54.38983491124164
cycle= 2 E= -128.197851123469  delta_E= -0.00167  |g|= 0.0633  |ddm|= 0.0653
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.103185
diis-c [-4.31572176e-04  2.78500327e-01  7.21499673e-01]
  HOMO = -0.785694486695562  LUMO = 2.60112769133035
  mo_energy =
[-3.27142041e+01 -1.89795346e+00 -7.85694487e-01 -7.85694487e-01
 -7.85694487e-01  2.60112769e+00  2.60112769e+00  2.60112769e+00
  2.82148920e+00  1.97080914e+01  1.97080914e+01  1.97080914e+01
  4.58848389e+01  3.33572865e+02  2.01868439e+03  7.30976651e+03]
E1 = -182.45369592361786  E_coul = 54.25553152192645
cycle= 3 E= -128.198164401691  delta_E= -0.000313  |g|= 0.000715  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000846454
diis-c [-1.20684538e-07 -4.12411708e-03 -3.13793354e-03  1.00726205e+00]
  HOMO = -0.785913433151514  LUMO = 2.6009652543382
  mo_energy =
[-3.27148393e+01 -1.89826116e+00 -7.85913433e-01 -7.85913433e-01
 -7.85913433e-01  2.60096525e+00  2.60096525e+00  2.60096525e+00
  2.82124089e+00  1.97075965e+01  1.97075965e+01  1.97075965e+01
  4.58842355e+01  3.33572409e+02  2.01868409e+03  7.30976626e+03]
E1 = -182.45492785039855  E_coul = 54.25676341270208
cycle= 4 E= -128.198164437696  delta_E= -3.6e-08  |g|= 6.44e-05  |ddm|= 0.000289
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000101359
diis-c [-2.52785340e-10  5.16280234e-04 -9.16433916e-04 -1.76168009e-01
  1.17656816e+00]
  HOMO = -0.785895695442843  LUMO = 2.60098051302659
  mo_energy =
[-3.27147932e+01 -1.89825885e+00 -7.85895695e-01 -7.85895695e-01
 -7.85895695e-01  2.60098051e+00  2.60098051e+00  2.60098051e+00
  2.82124197e+00  1.97076320e+01  1.97076320e+01  1.97076320e+01
  4.58842728e+01  3.33572473e+02  2.01868417e+03  7.30976635e+03]
E1 = -182.45484971660423  E_coul = 54.256685278431085
cycle= 5 E= -128.198164438173  delta_E= -4.77e-10  |g|= 1.58e-06  |ddm|= 3.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45484971660423  E_coul = 54.256685278431085
  HOMO = -0.785895687861962  LUMO = 2.60098053394557
  mo_energy =
[-3.27147933e+01 -1.89825923e+00 -7.85895688e-01 -7.85895688e-01
 -7.85895688e-01  2.60098053e+00  2.60098053e+00  2.60098053e+00
  2.82124163e+00  1.97076319e+01  1.97076319e+01  1.97076319e+01
  4.58842726e+01  3.33572472e+02  2.01868417e+03  7.30976635e+03]
E1 = -182.45484992303273  E_coul = 54.256685484859375
Extra cycle  E= -128.198164438173  delta_E= -2.27e-13  |g|= 2.83e-07  |ddm|= 9.14e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14451817e+03 2.24670965e+02 1.42756936e+03 5.86321849e-01
 5.01334034e+01 1.33672145e+01 1.96780342e+00 2.75755407e+00
 1.32908587e+01 5.96730176e-01]
E = -128.19816443817336
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.51817011        1
[INPUT] 0    0    [1    /1   ]  224.670965124        1
[INPUT] 0    0    [1    /1   ]  1427.56936313        1
[INPUT] 0    0    [1    /1   ]  0.586321848543       1
[INPUT] 0    0    [1    /1   ]  50.1334034228        1
[INPUT] 0    0    [1    /1   ]  13.3672145378        1
[INPUT] 0    0    [1    /1   ]  1.96780341887        1
[INPUT] 1    0    [1    /1   ]  2.7575540701         1
[INPUT] 1    0    [1    /1   ]  13.2908587207        1
[INPUT] 1    0    [1    /1   ]  0.59673017646        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.5181701090196, 1.0]], [0, [224.6709651241036, 1.0]], [0, [1427.5693631282966, 1.0]], [0, [0.5863218485430557, 1.0]], [0, [50.133403422830355, 1.0]], [0, [13.367214537786658, 1.0]], [0, [1.9678034188691589, 1.0]], [1, [2.7575540700962855, 1.0]], [1, [13.290858720705122, 1.0]], [1, [0.5967301764599008, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.51817011]
bas 1, expnt(s) = [224.67096512]
bas 2, expnt(s) = [1427.56936313]
bas 3, expnt(s) = [0.58632185]
bas 4, expnt(s) = [50.13340342]
bas 5, expnt(s) = [13.36721454]
bas 6, expnt(s) = [1.96780342]
bas 7, expnt(s) = [2.75755407]
bas 8, expnt(s) = [13.29085872]
bas 9, expnt(s) = [0.59673018]
CPU time:        98.38
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14451817e+03 7.96181940e+02 2.24670965e+02 1.46613931e+02
 1.42756936e+03 5.86763295e+02 5.86321849e-01 1.69284456e+00
 5.01334034e+01 4.76003796e+01 1.33672145e+01 1.76622372e+01
 1.96780342e+00 4.19760248e+00 2.75755407e+00 1.03666739e+01
 1.32908587e+01 7.40330590e+01 5.96730176e-01 1.53005447e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966146278333229
cond(S) = 159.80195882915487
E1 = -183.1356107088683  E_coul = 55.011251206895906
init E= -128.124359501972
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742958245746297  LUMO = 2.63484657743954
  mo_energy =
[-3.25139166e+01 -1.85322083e+00 -7.42958246e-01 -7.42958246e-01
 -7.42958246e-01  2.63484658e+00  2.63484658e+00  2.63484658e+00
  2.85747212e+00  1.98437129e+01  1.98437129e+01  1.98437129e+01
  4.60562870e+01  3.33802224e+02  2.01895615e+03  7.31006100e+03]
E1 = -182.1194761235049  E_coul = 53.92329467739425
cycle= 1 E= -128.196181446111  delta_E= -0.0718  |g|= 0.167  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262665
diis-c [-0.06899309  1.        ]
  HOMO = -0.808718730112273  LUMO = 2.58041844772997
  mo_energy =
[-3.27898078e+01 -1.92186414e+00 -8.08718730e-01 -8.08718730e-01
 -8.08718730e-01  2.58041845e+00  2.58041845e+00  2.58041845e+00
  2.80058427e+00  1.96513498e+01  1.96513498e+01  1.96513498e+01
  4.58178158e+01  3.33490169e+02  2.01859618e+03  7.30967677e+03]
E1 = -182.58768603471088  E_coul = 54.38983491124164
cycle= 2 E= -128.197851123469  delta_E= -0.00167  |g|= 0.0633  |ddm|= 0.0653
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.103185
diis-c [-4.31572176e-04  2.78500327e-01  7.21499673e-01]
  HOMO = -0.785694486695562  LUMO = 2.60112769133035
  mo_energy =
[-3.27142041e+01 -1.89795346e+00 -7.85694487e-01 -7.85694487e-01
 -7.85694487e-01  2.60112769e+00  2.60112769e+00  2.60112769e+00
  2.82148920e+00  1.97080914e+01  1.97080914e+01  1.97080914e+01
  4.58848389e+01  3.33572865e+02  2.01868439e+03  7.30976651e+03]
E1 = -182.45369592361786  E_coul = 54.25553152192645
cycle= 3 E= -128.198164401691  delta_E= -0.000313  |g|= 0.000715  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000846454
diis-c [-1.20684538e-07 -4.12411708e-03 -3.13793354e-03  1.00726205e+00]
  HOMO = -0.785913433151514  LUMO = 2.6009652543382
  mo_energy =
[-3.27148393e+01 -1.89826116e+00 -7.85913433e-01 -7.85913433e-01
 -7.85913433e-01  2.60096525e+00  2.60096525e+00  2.60096525e+00
  2.82124089e+00  1.97075965e+01  1.97075965e+01  1.97075965e+01
  4.58842355e+01  3.33572409e+02  2.01868409e+03  7.30976626e+03]
E1 = -182.45492785039855  E_coul = 54.25676341270208
cycle= 4 E= -128.198164437696  delta_E= -3.6e-08  |g|= 6.44e-05  |ddm|= 0.000289
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000101359
diis-c [-2.52785340e-10  5.16280234e-04 -9.16433916e-04 -1.76168009e-01
  1.17656816e+00]
  HOMO = -0.785895695442843  LUMO = 2.60098051302659
  mo_energy =
[-3.27147932e+01 -1.89825885e+00 -7.85895695e-01 -7.85895695e-01
 -7.85895695e-01  2.60098051e+00  2.60098051e+00  2.60098051e+00
  2.82124197e+00  1.97076320e+01  1.97076320e+01  1.97076320e+01
  4.58842728e+01  3.33572473e+02  2.01868417e+03  7.30976635e+03]
E1 = -182.45484971660423  E_coul = 54.256685278431085
cycle= 5 E= -128.198164438173  delta_E= -4.77e-10  |g|= 1.58e-06  |ddm|= 3.33e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45484971660423  E_coul = 54.256685278431085
  HOMO = -0.785895687861962  LUMO = 2.60098053394557
  mo_energy =
[-3.27147933e+01 -1.89825923e+00 -7.85895688e-01 -7.85895688e-01
 -7.85895688e-01  2.60098053e+00  2.60098053e+00  2.60098053e+00
  2.82124163e+00  1.97076319e+01  1.97076319e+01  1.97076319e+01
  4.58842726e+01  3.33572472e+02  2.01868417e+03  7.30976635e+03]
E1 = -182.45484992303273  E_coul = 54.256685484859375
Extra cycle  E= -128.198164438173  delta_E= -2.27e-13  |g|= 2.83e-07  |ddm|= 9.14e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 159.80195882915487
E1 = -182.45484992303273  E_coul = 54.256685484859375
init E= -128.198164438173
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785895659150316  LUMO = 2.60098055815502
  mo_energy =
[-3.27147932e+01 -1.89825927e+00 -7.85895659e-01 -7.85895659e-01
 -7.85895659e-01  2.60098056e+00  2.60098056e+00  2.60098056e+00
  2.82124159e+00  1.97076320e+01  1.97076320e+01  1.97076320e+01
  4.58842727e+01  3.33572473e+02  2.01868417e+03  7.30976635e+03]
E1 = -182.45484984008095  E_coul = 54.25668540190741
cycle= 1 E= -128.198164438174  delta_E= -1.71e-13  |g|= 5.38e-08  |ddm|= 1.57e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45484984008095  E_coul = 54.25668540190741
  HOMO = -0.785895662024921  LUMO = 2.60098055530206
  mo_energy =
[-3.27147932e+01 -1.89825929e+00 -7.85895662e-01 -7.85895662e-01
 -7.85895662e-01  2.60098056e+00  2.60098056e+00  2.60098056e+00
  2.82124158e+00  1.97076319e+01  1.97076319e+01  1.97076319e+01
  4.58842726e+01  3.33572473e+02  2.01868417e+03  7.30976635e+03]
E1 = -182.45484987374167  E_coul = 54.25668543556811
Extra cycle  E= -128.198164438174  delta_E= -2.84e-14  |g|= 9.97e-09  |ddm|= 3.07e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14451817e+03 2.24670965e+02 1.42756936e+03 5.86321849e-01
 5.01334034e+01 1.33672145e+01 1.96780342e+00 2.75755407e+00
 1.32908587e+01 5.96730176e-01]
grad_E = [-9.30478849e-06 -1.46736566e-04  3.73434208e-05  2.81315272e-03
  4.41739346e-04  1.15136754e-03  3.03270160e-04 -6.61852440e-03
  7.72158198e-04 -1.14727029e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60374191        1
[INPUT] 0    0    [1    /1   ]  227.122986144        1
[INPUT] 0    0    [1    /1   ]  1427.07283783        1
[INPUT] 0    0    [1    /1   ]  0.584903486217       1
[INPUT] 0    0    [1    /1   ]  50.3795943564        1
[INPUT] 0    0    [1    /1   ]  13.3792766884        1
[INPUT] 0    0    [1    /1   ]  1.963378431          1
[INPUT] 1    0    [1    /1   ]  2.76106169767        1
[INPUT] 1    0    [1    /1   ]  13.2796205017        1
[INPUT] 1    0    [1    /1   ]  0.597589372015       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.603741910612, 1.0]], [0, [227.12298614448224, 1.0]], [0, [1427.0728378290946, 1.0]], [0, [0.5849034862168316, 1.0]], [0, [50.37959435639569, 1.0]], [0, [13.37927668841333, 1.0]], [0, [1.9633784310014126, 1.0]], [1, [2.761061697674854, 1.0]], [1, [13.279620501661888, 1.0]], [1, [0.5975893720151026, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60374191]
bas 1, expnt(s) = [227.12298614]
bas 2, expnt(s) = [1427.07283783]
bas 3, expnt(s) = [0.58490349]
bas 4, expnt(s) = [50.37959436]
bas 5, expnt(s) = [13.37927669]
bas 6, expnt(s) = [1.96337843]
bas 7, expnt(s) = [2.7610617]
bas 8, expnt(s) = [13.2796205]
bas 9, expnt(s) = [0.59758937]
CPU time:       100.78
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460374e+03 7.96205767e+02 2.27122986e+02 1.47812391e+02
 1.42707284e+03 5.86610226e+02 5.84903486e-01 1.68977228e+00
 5.03795944e+01 4.77755861e+01 1.33792767e+01 1.76741892e+01
 1.96337843e+00 4.19052114e+00 2.76106170e+00 1.03831596e+01
 1.32796205e+01 7.39548180e+01 5.97589372e-01 1.53280876e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966004189861556
cond(S) = 160.45592891506863
E1 = -183.13602000485577  E_coul = 55.011407933413935
init E= -128.124612071442
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742929825705752  LUMO = 2.63978160574398
  mo_energy =
[-3.25139747e+01 -1.85326272e+00 -7.42929826e-01 -7.42929826e-01
 -7.42929826e-01  2.63978161e+00  2.63978161e+00  2.63978161e+00
  2.84697786e+00  1.98455606e+01  1.98455606e+01  1.98455606e+01
  4.61822998e+01  3.36624486e+02  2.02693322e+03  7.31866927e+03]
E1 = -182.12379913455507  E_coul = 53.92739161829277
cycle= 1 E= -128.196407516262  delta_E= -0.0718  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261865
diis-c [-0.06857305  1.        ]
  HOMO = -0.808442835786198  LUMO = 2.58550019306537
  mo_energy =
[-3.27890227e+01 -1.92153194e+00 -8.08442836e-01 -8.08442836e-01
 -8.08442836e-01  2.58550019e+00  2.58550019e+00  2.58550019e+00
  2.79059961e+00  1.96538835e+01  1.96538835e+01  1.96538835e+01
  4.59443684e+01  3.36312910e+02  2.02657400e+03  7.31828598e+03]
E1 = -182.59026306848622  E_coul = 54.39219705199654
cycle= 2 E= -128.19806601649  delta_E= -0.00166  |g|= 0.0631  |ddm|= 0.065
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102807
diis-c [-4.18230539e-04  2.78463052e-01  7.21536948e-01]
  HOMO = -0.785504536729466  LUMO = 2.60616178475432
  mo_energy =
[-3.27136892e+01 -1.89771244e+00 -7.85504537e-01 -7.85504537e-01
 -7.85504537e-01  2.60616178e+00  2.60616178e+00  2.60616178e+00
  2.81137757e+00  1.97103998e+01  1.97103998e+01  1.97103998e+01
  4.60112090e+01  3.36395350e+02  2.02666188e+03  7.31837538e+03]
E1 = -182.45681548756215  E_coul = 54.25843854201556
cycle= 3 E= -128.198376945547  delta_E= -0.000311  |g|= 0.000698  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000836014
diis-c [-1.07801122e-07 -4.08806402e-03 -3.04492278e-03  1.00713299e+00]
  HOMO = -0.785721922983923  LUMO = 2.60600039813243
  mo_energy =
[-3.27143156e+01 -1.89801355e+00 -7.85721923e-01 -7.85721923e-01
 -7.85721923e-01  2.60600040e+00  2.60600040e+00  2.60600040e+00
  2.81113554e+00  1.97099111e+01  1.97099111e+01  1.97099111e+01
  4.60106144e+01  3.36394899e+02  2.02666158e+03  7.31837512e+03]
E1 = -182.458030832197  E_coul = 54.25965385257558
cycle= 4 E= -128.198376979621  delta_E= -3.41e-08  |g|= 6.08e-05  |ddm|= 0.000278
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.59377e-05
diis-c [-2.36342868e-10  5.17362543e-04 -8.62206637e-04 -1.75289593e-01
  1.17563444e+00]
  HOMO = -0.785705062445597  LUMO = 2.60601491501621
  mo_energy =
[-3.27142718e+01 -1.89801121e+00 -7.85705062e-01 -7.85705062e-01
 -7.85705062e-01  2.60601492e+00  2.60601492e+00  2.60601492e+00
  2.81113667e+00  1.97099447e+01  1.97099447e+01  1.97099447e+01
  4.60106499e+01  3.36394960e+02  2.02666166e+03  7.31837521e+03]
E1 = -182.45795677302274  E_coul = 54.25957979297621
cycle= 5 E= -128.198376980047  delta_E= -4.25e-10  |g|= 1.55e-06  |ddm|= 3.13e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45795677302274  E_coul = 54.25957979297621
  HOMO = -0.785705046710676  LUMO = 2.60601494433906
  mo_energy =
[-3.27142719e+01 -1.89801157e+00 -7.85705047e-01 -7.85705047e-01
 -7.85705047e-01  2.60601494e+00  2.60601494e+00  2.60601494e+00
  2.81113636e+00  1.97099447e+01  1.97099447e+01  1.97099447e+01
  4.60106498e+01  3.36394960e+02  2.02666166e+03  7.31837521e+03]
E1 = -182.457956938037  E_coul = 54.259579957990404
Extra cycle  E= -128.198376980047  delta_E= -5.68e-14  |g|= 2.78e-07  |ddm|= 8.94e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14460374e+03 2.27122986e+02 1.42707284e+03 5.84903486e-01
 5.03795944e+01 1.33792767e+01 1.96337843e+00 2.76106170e+00
 1.32796205e+01 5.97589372e-01]
E = -128.1983769800466
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60374191        1
[INPUT] 0    0    [1    /1   ]  227.122986144        1
[INPUT] 0    0    [1    /1   ]  1427.07283783        1
[INPUT] 0    0    [1    /1   ]  0.584903486217       1
[INPUT] 0    0    [1    /1   ]  50.3795943564        1
[INPUT] 0    0    [1    /1   ]  13.3792766884        1
[INPUT] 0    0    [1    /1   ]  1.963378431          1
[INPUT] 1    0    [1    /1   ]  2.76106169767        1
[INPUT] 1    0    [1    /1   ]  13.2796205017        1
[INPUT] 1    0    [1    /1   ]  0.597589372015       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.603741910612, 1.0]], [0, [227.12298614448224, 1.0]], [0, [1427.0728378290946, 1.0]], [0, [0.5849034862168316, 1.0]], [0, [50.37959435639569, 1.0]], [0, [13.37927668841333, 1.0]], [0, [1.9633784310014126, 1.0]], [1, [2.761061697674854, 1.0]], [1, [13.279620501661888, 1.0]], [1, [0.5975893720151026, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60374191]
bas 1, expnt(s) = [227.12298614]
bas 2, expnt(s) = [1427.07283783]
bas 3, expnt(s) = [0.58490349]
bas 4, expnt(s) = [50.37959436]
bas 5, expnt(s) = [13.37927669]
bas 6, expnt(s) = [1.96337843]
bas 7, expnt(s) = [2.7610617]
bas 8, expnt(s) = [13.2796205]
bas 9, expnt(s) = [0.59758937]
CPU time:       101.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460374e+03 7.96205767e+02 2.27122986e+02 1.47812391e+02
 1.42707284e+03 5.86610226e+02 5.84903486e-01 1.68977228e+00
 5.03795944e+01 4.77755861e+01 1.33792767e+01 1.76741892e+01
 1.96337843e+00 4.19052114e+00 2.76106170e+00 1.03831596e+01
 1.32796205e+01 7.39548180e+01 5.97589372e-01 1.53280876e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966004189861556
cond(S) = 160.45592891506863
E1 = -183.13602000485577  E_coul = 55.011407933413935
init E= -128.124612071442
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742929825705752  LUMO = 2.63978160574398
  mo_energy =
[-3.25139747e+01 -1.85326272e+00 -7.42929826e-01 -7.42929826e-01
 -7.42929826e-01  2.63978161e+00  2.63978161e+00  2.63978161e+00
  2.84697786e+00  1.98455606e+01  1.98455606e+01  1.98455606e+01
  4.61822998e+01  3.36624486e+02  2.02693322e+03  7.31866927e+03]
E1 = -182.12379913455507  E_coul = 53.92739161829277
cycle= 1 E= -128.196407516262  delta_E= -0.0718  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261865
diis-c [-0.06857305  1.        ]
  HOMO = -0.808442835786198  LUMO = 2.58550019306537
  mo_energy =
[-3.27890227e+01 -1.92153194e+00 -8.08442836e-01 -8.08442836e-01
 -8.08442836e-01  2.58550019e+00  2.58550019e+00  2.58550019e+00
  2.79059961e+00  1.96538835e+01  1.96538835e+01  1.96538835e+01
  4.59443684e+01  3.36312910e+02  2.02657400e+03  7.31828598e+03]
E1 = -182.59026306848622  E_coul = 54.39219705199654
cycle= 2 E= -128.19806601649  delta_E= -0.00166  |g|= 0.0631  |ddm|= 0.065
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102807
diis-c [-4.18230539e-04  2.78463052e-01  7.21536948e-01]
  HOMO = -0.785504536729466  LUMO = 2.60616178475432
  mo_energy =
[-3.27136892e+01 -1.89771244e+00 -7.85504537e-01 -7.85504537e-01
 -7.85504537e-01  2.60616178e+00  2.60616178e+00  2.60616178e+00
  2.81137757e+00  1.97103998e+01  1.97103998e+01  1.97103998e+01
  4.60112090e+01  3.36395350e+02  2.02666188e+03  7.31837538e+03]
E1 = -182.45681548756215  E_coul = 54.25843854201556
cycle= 3 E= -128.198376945547  delta_E= -0.000311  |g|= 0.000698  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000836014
diis-c [-1.07801122e-07 -4.08806402e-03 -3.04492278e-03  1.00713299e+00]
  HOMO = -0.785721922983923  LUMO = 2.60600039813243
  mo_energy =
[-3.27143156e+01 -1.89801355e+00 -7.85721923e-01 -7.85721923e-01
 -7.85721923e-01  2.60600040e+00  2.60600040e+00  2.60600040e+00
  2.81113554e+00  1.97099111e+01  1.97099111e+01  1.97099111e+01
  4.60106144e+01  3.36394899e+02  2.02666158e+03  7.31837512e+03]
E1 = -182.458030832197  E_coul = 54.25965385257558
cycle= 4 E= -128.198376979621  delta_E= -3.41e-08  |g|= 6.08e-05  |ddm|= 0.000278
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.59377e-05
diis-c [-2.36342868e-10  5.17362543e-04 -8.62206637e-04 -1.75289593e-01
  1.17563444e+00]
  HOMO = -0.785705062445597  LUMO = 2.60601491501621
  mo_energy =
[-3.27142718e+01 -1.89801121e+00 -7.85705062e-01 -7.85705062e-01
 -7.85705062e-01  2.60601492e+00  2.60601492e+00  2.60601492e+00
  2.81113667e+00  1.97099447e+01  1.97099447e+01  1.97099447e+01
  4.60106499e+01  3.36394960e+02  2.02666166e+03  7.31837521e+03]
E1 = -182.45795677302274  E_coul = 54.25957979297621
cycle= 5 E= -128.198376980047  delta_E= -4.25e-10  |g|= 1.55e-06  |ddm|= 3.13e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45795677302274  E_coul = 54.25957979297621
  HOMO = -0.785705046710676  LUMO = 2.60601494433906
  mo_energy =
[-3.27142719e+01 -1.89801157e+00 -7.85705047e-01 -7.85705047e-01
 -7.85705047e-01  2.60601494e+00  2.60601494e+00  2.60601494e+00
  2.81113636e+00  1.97099447e+01  1.97099447e+01  1.97099447e+01
  4.60106498e+01  3.36394960e+02  2.02666166e+03  7.31837521e+03]
E1 = -182.457956938037  E_coul = 54.259579957990404
Extra cycle  E= -128.198376980047  delta_E= -5.68e-14  |g|= 2.78e-07  |ddm|= 8.94e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.45592891506863
E1 = -182.457956938037  E_coul = 54.259579957990404
init E= -128.198376980047
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785705021009629  LUMO = 2.60601496591381
  mo_energy =
[-3.27142718e+01 -1.89801161e+00 -7.85705021e-01 -7.85705021e-01
 -7.85705021e-01  2.60601497e+00  2.60601497e+00  2.60601497e+00
  2.81113632e+00  1.97099447e+01  1.97099447e+01  1.97099447e+01
  4.60106498e+01  3.36394960e+02  2.02666166e+03  7.31837521e+03]
E1 = -182.45795687285462  E_coul = 54.25957989280805
cycle= 1 E= -128.198376980047  delta_E=    0  |g|= 5.22e-08  |ddm|= 1.54e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45795687285462  E_coul = 54.25957989280805
  HOMO = -0.785705022707225  LUMO = 2.6060149641229
  mo_energy =
[-3.27142718e+01 -1.89801163e+00 -7.85705023e-01 -7.85705023e-01
 -7.85705023e-01  2.60601496e+00  2.60601496e+00  2.60601496e+00
  2.81113630e+00  1.97099447e+01  1.97099447e+01  1.97099447e+01
  4.60106498e+01  3.36394960e+02  2.02666166e+03  7.31837521e+03]
E1 = -182.4579568996195  E_coul = 54.25957991957278
Extra cycle  E= -128.198376980047  delta_E= -1.14e-13  |g|= 9.51e-09  |ddm|= 2.98e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14460374e+03 2.27122986e+02 1.42707284e+03 5.84903486e-01
 5.03795944e+01 1.33792767e+01 1.96337843e+00 2.76106170e+00
 1.32796205e+01 5.97589372e-01]
grad_E = [-9.77181196e-06 -7.42827264e-05  3.48756972e-05  1.67312321e-03
  3.41334893e-04  7.14124391e-04  3.63563987e-04 -4.30699909e-03
  3.97549916e-04 -7.40684620e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.64088649        1
[INPUT] 0    0    [1    /1   ]  228.224335431        1
[INPUT] 0    0    [1    /1   ]  1426.85641474        1
[INPUT] 0    0    [1    /1   ]  0.579843018263       1
[INPUT] 0    0    [1    /1   ]  50.2982220925        1
[INPUT] 0    0    [1    /1   ]  13.3278833609        1
[INPUT] 0    0    [1    /1   ]  1.94481086708        1
[INPUT] 1    0    [1    /1   ]  2.76708529715        1
[INPUT] 1    0    [1    /1   ]  13.2748822965        1
[INPUT] 1    0    [1    /1   ]  0.598912864747       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.64088649215, 1.0]], [0, [228.2243354309919, 1.0]], [0, [1426.8564147397417, 1.0]], [0, [0.5798430182634954, 1.0]], [0, [50.29822209253098, 1.0]], [0, [13.327883360864895, 1.0]], [0, [1.9448108670769504, 1.0]], [1, [2.7670852971528093, 1.0]], [1, [13.27488229648492, 1.0]], [1, [0.5989128647471731, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.64088649]
bas 1, expnt(s) = [228.22433543]
bas 2, expnt(s) = [1426.85641474]
bas 3, expnt(s) = [0.57984302]
bas 4, expnt(s) = [50.29822209]
bas 5, expnt(s) = [13.32788336]
bas 6, expnt(s) = [1.94481087]
bas 7, expnt(s) = [2.7670853]
bas 8, expnt(s) = [13.2748823]
bas 9, expnt(s) = [0.59891286]
CPU time:       103.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14464089e+03 7.96216110e+02 2.28224335e+02 1.48349637e+02
 1.42685641e+03 5.86543503e+02 5.79843018e-01 1.67879570e+00
 5.02982221e+01 4.77176997e+01 1.33278834e+01 1.76232463e+01
 1.94481087e+00 4.16076372e+00 2.76708530e+00 1.04114826e+01
 1.32748823e+01 7.39218354e+01 5.98912865e-01 1.53705336e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965848402856341
cond(S) = 160.5129568478378
E1 = -183.136593489059  E_coul = 55.01145528304097
init E= -128.125138206018
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742893482290241  LUMO = 2.64753931525609
  mo_energy =
[-3.25139033e+01 -1.85346471e+00 -7.42893482e-01 -7.42893482e-01
 -7.42893482e-01  2.64753932e+00  2.64753932e+00  2.64753932e+00
  2.80438027e+00  1.98634017e+01  1.98634017e+01  1.98634017e+01
  4.59109626e+01  3.37050415e+02  2.02959340e+03  7.32166698e+03]
E1 = -182.12859657184862  E_coul = 53.93204974862952
cycle= 1 E= -128.196546823219  delta_E= -0.0714  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261046
diis-c [-0.06814523  1.        ]
  HOMO = -0.808124841533941  LUMO = 2.59338046547988
  mo_energy =
[-3.27880286e+01 -1.92120870e+00 -8.08124842e-01 -8.08124842e-01
 -8.08124842e-01  2.59338047e+00  2.59338047e+00  2.59338047e+00
  2.74925535e+00  1.96724684e+01  1.96724684e+01  1.96724684e+01
  4.56741770e+01  3.36739380e+02  2.02923446e+03  7.32128397e+03]
E1 = -182.59293505897966  E_coul = 54.394743760907225
cycle= 2 E= -128.198191298072  delta_E= -0.00164  |g|= 0.0628  |ddm|= 0.0646
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102333
diis-c [-4.06640878e-04  2.78227462e-01  7.21772538e-01]
  HOMO = -0.785281805260512  LUMO = 2.61400295104001
  mo_energy =
[-3.27130119e+01 -1.89749623e+00 -7.85281805e-01 -7.85281805e-01
 -7.85281805e-01  2.61400295e+00  2.61400295e+00  2.61400295e+00
  2.76972114e+00  1.97287349e+01  1.97287349e+01  1.97287349e+01
  4.57406923e+01  3.36821476e+02  2.02932194e+03  7.32137294e+03]
E1 = -182.46011988300637  E_coul = 54.26162060978133
cycle= 3 E= -128.198499273225  delta_E= -0.000308  |g|= 0.000685  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000845683
diis-c [-8.80280862e-08 -3.98212037e-03 -2.49305580e-03  1.00647518e+00]
  HOMO = -0.785503180596552  LUMO = 2.61383750282598
  mo_energy =
[-3.27136454e+01 -1.89779292e+00 -7.85503181e-01 -7.85503181e-01
 -7.85503181e-01  2.61383750e+00  2.61383750e+00  2.61383750e+00
  2.76948554e+00  1.97282401e+01  1.97282401e+01  1.97282401e+01
  4.57400936e+01  3.36821009e+02  2.02932161e+03  7.32137266e+03]
E1 = -182.46134675032718  E_coul = 54.26284744454844
cycle= 4 E= -128.198499305779  delta_E= -3.26e-08  |g|= 5.48e-05  |ddm|= 0.000265
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.68271e-05
diis-c [-2.18909645e-10  5.12696046e-04 -8.26286117e-04 -1.72796962e-01
  1.17311055e+00]
  HOMO = -0.785487757149725  LUMO = 2.6138508076501
  mo_energy =
[-3.27136056e+01 -1.89779049e+00 -7.85487757e-01 -7.85487757e-01
 -7.85487757e-01  2.61385081e+00  2.61385081e+00  2.61385081e+00
  2.76948680e+00  1.97282708e+01  1.97282708e+01  1.97282708e+01
  4.57401260e+01  3.36821064e+02  2.02932168e+03  7.32137273e+03]
E1 = -182.46127956755709  E_coul = 54.262780261433726
cycle= 5 E= -128.198499306123  delta_E= -3.45e-10  |g|= 1.53e-06  |ddm|= 2.8e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46127956755709  E_coul = 54.262780261433726
  HOMO = -0.785487718120782  LUMO = 2.61385085828733
  mo_energy =
[-3.27136055e+01 -1.89779083e+00 -7.85487718e-01 -7.85487718e-01
 -7.85487718e-01  2.61385086e+00  2.61385086e+00  2.61385086e+00
  2.76948651e+00  1.97282708e+01  1.97282708e+01  1.97282708e+01
  4.57401259e+01  3.36821064e+02  2.02932168e+03  7.32137273e+03]
E1 = -182.46127963397637  E_coul = 54.26278032785273
Extra cycle  E= -128.198499306124  delta_E= -2.84e-13  |g|= 2.77e-07  |ddm|= 8.85e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14464089e+03 2.28224335e+02 1.42685641e+03 5.79843018e-01
 5.02982221e+01 1.33278834e+01 1.94481087e+00 2.76708530e+00
 1.32748823e+01 5.98912865e-01]
E = -128.19849930612364
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.64088649        1
[INPUT] 0    0    [1    /1   ]  228.224335431        1
[INPUT] 0    0    [1    /1   ]  1426.85641474        1
[INPUT] 0    0    [1    /1   ]  0.579843018263       1
[INPUT] 0    0    [1    /1   ]  50.2982220925        1
[INPUT] 0    0    [1    /1   ]  13.3278833609        1
[INPUT] 0    0    [1    /1   ]  1.94481086708        1
[INPUT] 1    0    [1    /1   ]  2.76708529715        1
[INPUT] 1    0    [1    /1   ]  13.2748822965        1
[INPUT] 1    0    [1    /1   ]  0.598912864747       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.64088649215, 1.0]], [0, [228.2243354309919, 1.0]], [0, [1426.8564147397417, 1.0]], [0, [0.5798430182634954, 1.0]], [0, [50.29822209253098, 1.0]], [0, [13.327883360864895, 1.0]], [0, [1.9448108670769504, 1.0]], [1, [2.7670852971528093, 1.0]], [1, [13.27488229648492, 1.0]], [1, [0.5989128647471731, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.64088649]
bas 1, expnt(s) = [228.22433543]
bas 2, expnt(s) = [1426.85641474]
bas 3, expnt(s) = [0.57984302]
bas 4, expnt(s) = [50.29822209]
bas 5, expnt(s) = [13.32788336]
bas 6, expnt(s) = [1.94481087]
bas 7, expnt(s) = [2.7670853]
bas 8, expnt(s) = [13.2748823]
bas 9, expnt(s) = [0.59891286]
CPU time:       104.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14464089e+03 7.96216110e+02 2.28224335e+02 1.48349637e+02
 1.42685641e+03 5.86543503e+02 5.79843018e-01 1.67879570e+00
 5.02982221e+01 4.77176997e+01 1.33278834e+01 1.76232463e+01
 1.94481087e+00 4.16076372e+00 2.76708530e+00 1.04114826e+01
 1.32748823e+01 7.39218354e+01 5.98912865e-01 1.53705336e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965848402856341
cond(S) = 160.5129568478378
E1 = -183.136593489059  E_coul = 55.01145528304097
init E= -128.125138206018
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742893482290241  LUMO = 2.64753931525609
  mo_energy =
[-3.25139033e+01 -1.85346471e+00 -7.42893482e-01 -7.42893482e-01
 -7.42893482e-01  2.64753932e+00  2.64753932e+00  2.64753932e+00
  2.80438027e+00  1.98634017e+01  1.98634017e+01  1.98634017e+01
  4.59109626e+01  3.37050415e+02  2.02959340e+03  7.32166698e+03]
E1 = -182.12859657184862  E_coul = 53.93204974862952
cycle= 1 E= -128.196546823219  delta_E= -0.0714  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261046
diis-c [-0.06814523  1.        ]
  HOMO = -0.808124841533941  LUMO = 2.59338046547988
  mo_energy =
[-3.27880286e+01 -1.92120870e+00 -8.08124842e-01 -8.08124842e-01
 -8.08124842e-01  2.59338047e+00  2.59338047e+00  2.59338047e+00
  2.74925535e+00  1.96724684e+01  1.96724684e+01  1.96724684e+01
  4.56741770e+01  3.36739380e+02  2.02923446e+03  7.32128397e+03]
E1 = -182.59293505897966  E_coul = 54.394743760907225
cycle= 2 E= -128.198191298072  delta_E= -0.00164  |g|= 0.0628  |ddm|= 0.0646
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102333
diis-c [-4.06640878e-04  2.78227462e-01  7.21772538e-01]
  HOMO = -0.785281805260512  LUMO = 2.61400295104001
  mo_energy =
[-3.27130119e+01 -1.89749623e+00 -7.85281805e-01 -7.85281805e-01
 -7.85281805e-01  2.61400295e+00  2.61400295e+00  2.61400295e+00
  2.76972114e+00  1.97287349e+01  1.97287349e+01  1.97287349e+01
  4.57406923e+01  3.36821476e+02  2.02932194e+03  7.32137294e+03]
E1 = -182.46011988300637  E_coul = 54.26162060978133
cycle= 3 E= -128.198499273225  delta_E= -0.000308  |g|= 0.000685  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000845683
diis-c [-8.80280862e-08 -3.98212037e-03 -2.49305580e-03  1.00647518e+00]
  HOMO = -0.785503180596552  LUMO = 2.61383750282598
  mo_energy =
[-3.27136454e+01 -1.89779292e+00 -7.85503181e-01 -7.85503181e-01
 -7.85503181e-01  2.61383750e+00  2.61383750e+00  2.61383750e+00
  2.76948554e+00  1.97282401e+01  1.97282401e+01  1.97282401e+01
  4.57400936e+01  3.36821009e+02  2.02932161e+03  7.32137266e+03]
E1 = -182.46134675032718  E_coul = 54.26284744454844
cycle= 4 E= -128.198499305779  delta_E= -3.26e-08  |g|= 5.48e-05  |ddm|= 0.000265
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.68271e-05
diis-c [-2.18909645e-10  5.12696046e-04 -8.26286117e-04 -1.72796962e-01
  1.17311055e+00]
  HOMO = -0.785487757149725  LUMO = 2.6138508076501
  mo_energy =
[-3.27136056e+01 -1.89779049e+00 -7.85487757e-01 -7.85487757e-01
 -7.85487757e-01  2.61385081e+00  2.61385081e+00  2.61385081e+00
  2.76948680e+00  1.97282708e+01  1.97282708e+01  1.97282708e+01
  4.57401260e+01  3.36821064e+02  2.02932168e+03  7.32137273e+03]
E1 = -182.46127956755709  E_coul = 54.262780261433726
cycle= 5 E= -128.198499306123  delta_E= -3.45e-10  |g|= 1.53e-06  |ddm|= 2.8e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46127956755709  E_coul = 54.262780261433726
  HOMO = -0.785487718120782  LUMO = 2.61385085828733
  mo_energy =
[-3.27136055e+01 -1.89779083e+00 -7.85487718e-01 -7.85487718e-01
 -7.85487718e-01  2.61385086e+00  2.61385086e+00  2.61385086e+00
  2.76948651e+00  1.97282708e+01  1.97282708e+01  1.97282708e+01
  4.57401259e+01  3.36821064e+02  2.02932168e+03  7.32137273e+03]
E1 = -182.46127963397637  E_coul = 54.26278032785273
Extra cycle  E= -128.198499306124  delta_E= -2.84e-13  |g|= 2.77e-07  |ddm|= 8.85e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.5129568478378
E1 = -182.46127963397637  E_coul = 54.26278032785273
init E= -128.198499306124
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785487698919295  LUMO = 2.6138508740608
  mo_energy =
[-3.27136055e+01 -1.89779088e+00 -7.85487699e-01 -7.85487699e-01
 -7.85487699e-01  2.61385087e+00  2.61385087e+00  2.61385087e+00
  2.76948646e+00  1.97282708e+01  1.97282708e+01  1.97282708e+01
  4.57401259e+01  3.36821064e+02  2.02932168e+03  7.32137273e+03]
E1 = -182.46127961155864  E_coul = 54.26278030543515
cycle= 1 E= -128.198499306123  delta_E= 1.42e-13  |g|= 5.1e-08  |ddm|= 1.56e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46127961155864  E_coul = 54.26278030543515
  HOMO = -0.785487697654871  LUMO = 2.61385087493973
  mo_energy =
[-3.27136055e+01 -1.89779089e+00 -7.85487698e-01 -7.85487698e-01
 -7.85487698e-01  2.61385087e+00  2.61385087e+00  2.61385087e+00
  2.76948645e+00  1.97282708e+01  1.97282708e+01  1.97282708e+01
  4.57401259e+01  3.36821064e+02  2.02932168e+03  7.32137273e+03]
E1 = -182.46127962188731  E_coul = 54.262780315763436
Extra cycle  E= -128.198499306124  delta_E= -3.98e-13  |g|= 9.13e-09  |ddm|= 2.89e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14464089e+03 2.28224335e+02 1.42685641e+03 5.79843018e-01
 5.02982221e+01 1.33278834e+01 1.94481087e+00 2.76708530e+00
 1.32748823e+01 5.98912865e-01]
grad_E = [-1.00275679e-05 -5.14378512e-06  3.33759367e-05  4.51648256e-04
  1.21437128e-04  1.82433710e-04  2.10964287e-04 -1.25546358e-03
 -5.65846361e-05 -1.82277643e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.6265313         1
[INPUT] 0    0    [1    /1   ]  227.838539462        1
[INPUT] 0    0    [1    /1   ]  1426.93910432        1
[INPUT] 0    0    [1    /1   ]  0.576779369139       1
[INPUT] 0    0    [1    /1   ]  50.1259397125        1
[INPUT] 0    0    [1    /1   ]  13.2860372996        1
[INPUT] 0    0    [1    /1   ]  1.93320200251        1
[INPUT] 1    0    [1    /1   ]  2.76973022707        1
[INPUT] 1    0    [1    /1   ]  13.2770097466        1
[INPUT] 1    0    [1    /1   ]  0.599446780886       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.626531299818, 1.0]], [0, [227.8385394615448, 1.0]], [0, [1426.9391043217613, 1.0]], [0, [0.5767793691392754, 1.0]], [0, [50.1259397124626, 1.0]], [0, [13.286037299614584, 1.0]], [0, [1.9332020025088807, 1.0]], [1, [2.769730227065203, 1.0]], [1, [13.277009746634018, 1.0]], [1, [0.5994467808864946, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.6265313]
bas 1, expnt(s) = [227.83853946]
bas 2, expnt(s) = [1426.93910432]
bas 3, expnt(s) = [0.57677937]
bas 4, expnt(s) = [50.12593971]
bas 5, expnt(s) = [13.2860373]
bas 6, expnt(s) = [1.933202]
bas 7, expnt(s) = [2.76973023]
bas 8, expnt(s) = [13.27700975]
bas 9, expnt(s) = [0.59944678]
CPU time:       106.94
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14462653e+03 7.96212112e+02 2.27838539e+02 1.48161517e+02
 1.42693910e+03 5.86568996e+02 5.76779369e-01 1.67213875e+00
 5.01259397e+01 4.75950645e+01 1.32860373e+01 1.75817307e+01
 1.93320200e+00 4.14212262e+00 2.76973023e+00 1.04239239e+01
 1.32770097e+01 7.39366442e+01 5.99446781e-01 1.53876636e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965805456486766
cond(S) = 160.2372655232083
E1 = -183.13683840086946  E_coul = 55.011405130840224
init E= -128.125433270029
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742882249284847  LUMO = 2.65072613353728
  mo_energy =
[-3.25138402e+01 -1.85359092e+00 -7.42882249e-01 -7.42882249e-01
 -7.42882249e-01  2.65072613e+00  2.65072613e+00  2.65072613e+00
  2.77807017e+00  1.98754624e+01  1.98754624e+01  1.98754624e+01
  4.56579260e+01  3.36016525e+02  2.02769852e+03  7.31970431e+03]
E1 = -182.1299439237659  E_coul = 53.933373146608965
cycle= 1 E= -128.196570777157  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260846
diis-c [-0.0680404  1.       ]
  HOMO = -0.808034484656718  LUMO = 2.5965810264236
  mo_energy =
[-3.27877143e+01 -1.92114043e+00 -8.08034485e-01 -8.08034485e-01
 -8.08034485e-01  2.59658103e+00  2.59658103e+00  2.59658103e+00
  2.72361285e+00  1.96847263e+01  1.96847263e+01  1.96847263e+01
  4.54216939e+01  3.35705652e+02  2.02733944e+03  7.31932106e+03]
E1 = -182.59361154104826  E_coul = 54.39540090407637
cycle= 2 E= -128.198210636972  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102177
diis-c [-4.04479851e-04  2.78081657e-01  7.21918343e-01]
  HOMO = -0.785217830739245  LUMO = 2.61719898484996
  mo_energy =
[-3.27127936e+01 -1.89746027e+00 -7.85217831e-01 -7.85217831e-01
 -7.85217831e-01  2.61719898e+00  2.61719898e+00  2.61719898e+00
  2.74391172e+00  1.97409233e+01  1.97409233e+01  1.97409233e+01
  4.54880665e+01  3.35787625e+02  2.02742679e+03  7.31940990e+03]
E1 = -182.46098589528194  E_coul = 54.2624682590049
cycle= 3 E= -128.198517636277  delta_E= -0.000307  |g|= 0.000685  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000857521
diis-c [-7.99948361e-08 -3.92468369e-03 -2.15067214e-03  1.00607536e+00]
  HOMO = -0.785442670913731  LUMO = 2.61703024570089
  mo_energy =
[-3.27134360e+01 -1.89775671e+00 -7.85442671e-01 -7.85442671e-01
 -7.85442671e-01  2.61703025e+00  2.61703025e+00  2.61703025e+00
  2.74367802e+00  1.97404216e+01  1.97404216e+01  1.97404216e+01
  4.54874612e+01  3.35787146e+02  2.02742645e+03  7.31940959e+03]
E1 = -182.462227891238  E_coul = 54.26371022259908
cycle= 4 E= -128.198517668639  delta_E= -3.24e-08  |g|= 5.22e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.27822e-05
diis-c [-2.13703490e-10  5.07943164e-04 -8.23798101e-04 -1.71141767e-01
  1.17145762e+00]
  HOMO = -0.785427879936246  LUMO = 2.61704301667535
  mo_energy =
[-3.27133978e+01 -1.89775424e+00 -7.85427880e-01 -7.85427880e-01
 -7.85427880e-01  2.61704302e+00  2.61704302e+00  2.61704302e+00
  2.74367934e+00  1.97404510e+01  1.97404510e+01  1.97404510e+01
  4.54874922e+01  3.35787199e+02  2.02742651e+03  7.31940967e+03]
E1 = -182.4621637549318  E_coul = 54.26364608598122
cycle= 5 E= -128.198517668951  delta_E= -3.12e-10  |g|= 1.53e-06  |ddm|= 2.66e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4621637549318  E_coul = 54.26364608598122
  HOMO = -0.785427826757204  LUMO = 2.61704307979021
  mo_energy =
[-3.27133978e+01 -1.89775456e+00 -7.85427827e-01 -7.85427827e-01
 -7.85427827e-01  2.61704308e+00  2.61704308e+00  2.61704308e+00
  2.74367906e+00  1.97404510e+01  1.97404510e+01  1.97404510e+01
  4.54874921e+01  3.35787199e+02  2.02742651e+03  7.31940967e+03]
E1 = -182.46216376417036  E_coul = 54.26364609521972
Extra cycle  E= -128.198517668951  delta_E= -8.53e-14  |g|= 2.79e-07  |ddm|= 8.88e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14462653e+03 2.27838539e+02 1.42693910e+03 5.76779369e-01
 5.01259397e+01 1.32860373e+01 1.93320200e+00 2.76973023e+00
 1.32770097e+01 5.99446781e-01]
E = -128.19851766895064
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.6265313         1
[INPUT] 0    0    [1    /1   ]  227.838539462        1
[INPUT] 0    0    [1    /1   ]  1426.93910432        1
[INPUT] 0    0    [1    /1   ]  0.576779369139       1
[INPUT] 0    0    [1    /1   ]  50.1259397125        1
[INPUT] 0    0    [1    /1   ]  13.2860372996        1
[INPUT] 0    0    [1    /1   ]  1.93320200251        1
[INPUT] 1    0    [1    /1   ]  2.76973022707        1
[INPUT] 1    0    [1    /1   ]  13.2770097466        1
[INPUT] 1    0    [1    /1   ]  0.599446780886       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.626531299818, 1.0]], [0, [227.8385394615448, 1.0]], [0, [1426.9391043217613, 1.0]], [0, [0.5767793691392754, 1.0]], [0, [50.1259397124626, 1.0]], [0, [13.286037299614584, 1.0]], [0, [1.9332020025088807, 1.0]], [1, [2.769730227065203, 1.0]], [1, [13.277009746634018, 1.0]], [1, [0.5994467808864946, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.6265313]
bas 1, expnt(s) = [227.83853946]
bas 2, expnt(s) = [1426.93910432]
bas 3, expnt(s) = [0.57677937]
bas 4, expnt(s) = [50.12593971]
bas 5, expnt(s) = [13.2860373]
bas 6, expnt(s) = [1.933202]
bas 7, expnt(s) = [2.76973023]
bas 8, expnt(s) = [13.27700975]
bas 9, expnt(s) = [0.59944678]
CPU time:       107.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14462653e+03 7.96212112e+02 2.27838539e+02 1.48161517e+02
 1.42693910e+03 5.86568996e+02 5.76779369e-01 1.67213875e+00
 5.01259397e+01 4.75950645e+01 1.32860373e+01 1.75817307e+01
 1.93320200e+00 4.14212262e+00 2.76973023e+00 1.04239239e+01
 1.32770097e+01 7.39366442e+01 5.99446781e-01 1.53876636e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965805456486766
cond(S) = 160.2372655232083
E1 = -183.13683840086946  E_coul = 55.011405130840224
init E= -128.125433270029
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742882249284847  LUMO = 2.65072613353728
  mo_energy =
[-3.25138402e+01 -1.85359092e+00 -7.42882249e-01 -7.42882249e-01
 -7.42882249e-01  2.65072613e+00  2.65072613e+00  2.65072613e+00
  2.77807017e+00  1.98754624e+01  1.98754624e+01  1.98754624e+01
  4.56579260e+01  3.36016525e+02  2.02769852e+03  7.31970431e+03]
E1 = -182.1299439237659  E_coul = 53.933373146608965
cycle= 1 E= -128.196570777157  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260846
diis-c [-0.0680404  1.       ]
  HOMO = -0.808034484656718  LUMO = 2.5965810264236
  mo_energy =
[-3.27877143e+01 -1.92114043e+00 -8.08034485e-01 -8.08034485e-01
 -8.08034485e-01  2.59658103e+00  2.59658103e+00  2.59658103e+00
  2.72361285e+00  1.96847263e+01  1.96847263e+01  1.96847263e+01
  4.54216939e+01  3.35705652e+02  2.02733944e+03  7.31932106e+03]
E1 = -182.59361154104826  E_coul = 54.39540090407637
cycle= 2 E= -128.198210636972  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102177
diis-c [-4.04479851e-04  2.78081657e-01  7.21918343e-01]
  HOMO = -0.785217830739245  LUMO = 2.61719898484996
  mo_energy =
[-3.27127936e+01 -1.89746027e+00 -7.85217831e-01 -7.85217831e-01
 -7.85217831e-01  2.61719898e+00  2.61719898e+00  2.61719898e+00
  2.74391172e+00  1.97409233e+01  1.97409233e+01  1.97409233e+01
  4.54880665e+01  3.35787625e+02  2.02742679e+03  7.31940990e+03]
E1 = -182.46098589528194  E_coul = 54.2624682590049
cycle= 3 E= -128.198517636277  delta_E= -0.000307  |g|= 0.000685  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000857521
diis-c [-7.99948361e-08 -3.92468369e-03 -2.15067214e-03  1.00607536e+00]
  HOMO = -0.785442670913731  LUMO = 2.61703024570089
  mo_energy =
[-3.27134360e+01 -1.89775671e+00 -7.85442671e-01 -7.85442671e-01
 -7.85442671e-01  2.61703025e+00  2.61703025e+00  2.61703025e+00
  2.74367802e+00  1.97404216e+01  1.97404216e+01  1.97404216e+01
  4.54874612e+01  3.35787146e+02  2.02742645e+03  7.31940959e+03]
E1 = -182.462227891238  E_coul = 54.26371022259908
cycle= 4 E= -128.198517668639  delta_E= -3.24e-08  |g|= 5.22e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.27822e-05
diis-c [-2.13703490e-10  5.07943164e-04 -8.23798101e-04 -1.71141767e-01
  1.17145762e+00]
  HOMO = -0.785427879936246  LUMO = 2.61704301667535
  mo_energy =
[-3.27133978e+01 -1.89775424e+00 -7.85427880e-01 -7.85427880e-01
 -7.85427880e-01  2.61704302e+00  2.61704302e+00  2.61704302e+00
  2.74367934e+00  1.97404510e+01  1.97404510e+01  1.97404510e+01
  4.54874922e+01  3.35787199e+02  2.02742651e+03  7.31940967e+03]
E1 = -182.4621637549318  E_coul = 54.26364608598122
cycle= 5 E= -128.198517668951  delta_E= -3.12e-10  |g|= 1.53e-06  |ddm|= 2.66e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4621637549318  E_coul = 54.26364608598122
  HOMO = -0.785427826757204  LUMO = 2.61704307979021
  mo_energy =
[-3.27133978e+01 -1.89775456e+00 -7.85427827e-01 -7.85427827e-01
 -7.85427827e-01  2.61704308e+00  2.61704308e+00  2.61704308e+00
  2.74367906e+00  1.97404510e+01  1.97404510e+01  1.97404510e+01
  4.54874921e+01  3.35787199e+02  2.02742651e+03  7.31940967e+03]
E1 = -182.46216376417036  E_coul = 54.26364609521972
Extra cycle  E= -128.198517668951  delta_E= -8.53e-14  |g|= 2.79e-07  |ddm|= 8.88e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.2372655232083
E1 = -182.46216376417036  E_coul = 54.26364609521972
init E= -128.198517668951
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785427811184543  LUMO = 2.61704309229093
  mo_energy =
[-3.27133977e+01 -1.89775462e+00 -7.85427811e-01 -7.85427811e-01
 -7.85427811e-01  2.61704309e+00  2.61704309e+00  2.61704309e+00
  2.74367901e+00  1.97404511e+01  1.97404511e+01  1.97404511e+01
  4.54874921e+01  3.35787199e+02  2.02742651e+03  7.31940967e+03]
E1 = -182.462163766533  E_coul = 54.2636460975823
cycle= 1 E= -128.198517668951  delta_E= -5.68e-14  |g|= 5.1e-08  |ddm|= 1.59e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.462163766533  E_coul = 54.2636460975823
  HOMO = -0.785427808175707  LUMO = 2.61704309474365
  mo_energy =
[-3.27133977e+01 -1.89775462e+00 -7.85427808e-01 -7.85427808e-01
 -7.85427808e-01  2.61704309e+00  2.61704309e+00  2.61704309e+00
  2.74367900e+00  1.97404511e+01  1.97404511e+01  1.97404511e+01
  4.54874921e+01  3.35787199e+02  2.02742651e+03  7.31940967e+03]
E1 = -182.46216376735887  E_coul = 54.263646098407946
Extra cycle  E= -128.198517668951  delta_E= -2.27e-13  |g|= 9.24e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14462653e+03 2.27838539e+02 1.42693910e+03 5.76779369e-01
 5.01259397e+01 1.32860373e+01 1.93320200e+00 2.76973023e+00
 1.32770097e+01 5.99446781e-01]
grad_E = [-1.00018531e-05  1.10462385e-05  3.34428312e-05  9.75975626e-05
  9.14195022e-06  2.85389905e-05  2.55044719e-05 -1.70369575e-04
 -2.01421833e-04 -1.63612581e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61421427        1
[INPUT] 0    0    [1    /1   ]  227.492289908        1
[INPUT] 0    0    [1    /1   ]  1427.01043071        1
[INPUT] 0    0    [1    /1   ]  0.575992677428       1
[INPUT] 0    0    [1    /1   ]  50.0548788758        1
[INPUT] 0    0    [1    /1   ]  13.272678554         1
[INPUT] 0    0    [1    /1   ]  1.93033457934        1
[INPUT] 1    0    [1    /1   ]  2.77029612229        1
[INPUT] 1    0    [1    /1   ]  13.2788763606        1
[INPUT] 1    0    [1    /1   ]  0.599546356217       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6142142728177, 1.0]], [0, [227.49228990817338, 1.0]], [0, [1427.0104307120048, 1.0]], [0, [0.5759926774281884, 1.0]], [0, [50.05487887578512, 1.0]], [0, [13.272678554031453, 1.0]], [0, [1.9303345793401578, 1.0]], [1, [2.7702961222865, 1.0]], [1, [13.278876360556426, 1.0]], [1, [0.5995463562166738, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61421427]
bas 1, expnt(s) = [227.49228991]
bas 2, expnt(s) = [1427.01043071]
bas 3, expnt(s) = [0.57599268]
bas 4, expnt(s) = [50.05487888]
bas 5, expnt(s) = [13.27267855]
bas 6, expnt(s) = [1.93033458]
bas 7, expnt(s) = [2.77029612]
bas 8, expnt(s) = [13.27887636]
bas 9, expnt(s) = [0.59954636]
CPU time:       110.02
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461421e+03 7.96208683e+02 2.27492290e+02 1.47992612e+02
 1.42701043e+03 5.86590986e+02 5.75992677e-01 1.67042794e+00
 5.00548789e+01 4.75444508e+01 1.32726786e+01 1.75684706e+01
 1.93033458e+00 4.13751391e+00 2.77029612e+00 1.04265861e+01
 1.32788764e+01 7.39496379e+01 5.99546356e-01 1.53908587e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965801883074384
cond(S) = 160.0951920028623
E1 = -183.1369086467393  E_coul = 55.011389625376054
init E= -128.125519021363
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742881315377861  LUMO = 2.65133809621568
  mo_energy =
[-3.25138195e+01 -1.85362265e+00 -7.42881315e-01 -7.42881315e-01
 -7.42881315e-01  2.65133810e+00  2.65133810e+00  2.65133810e+00
  2.77141610e+00  1.98794703e+01  1.98794703e+01  1.98794703e+01
  4.55738807e+01  3.35454156e+02  2.02639602e+03  7.31832036e+03]
E1 = -182.1300198105999  E_coul = 53.93344678889331
cycle= 1 E= -128.196573021707  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260863
diis-c [-0.06804948  1.        ]
  HOMO = -0.808030699854745  LUMO = 2.59718336640344
  mo_energy =
[-3.27876873e+01 -1.92114268e+00 -8.08030700e-01 -8.08030700e-01
 -8.08030700e-01  2.59718337e+00  2.59718337e+00  2.59718337e+00
  2.71711125e+00  1.96887334e+01  1.96887334e+01  1.96887334e+01
  4.53377669e+01  3.35143295e+02  2.02603684e+03  7.31793696e+03]
E1 = -182.59362926281207  E_coul = 54.39541683337125
cycle= 2 E= -128.198212429441  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102161
diis-c [-4.04949446e-04  2.78031814e-01  7.21968186e-01]
  HOMO = -0.785214756310687  LUMO = 2.61780446676322
  mo_energy =
[-3.27127720e+01 -1.89746439e+00 -7.85214756e-01 -7.85214756e-01
 -7.85214756e-01  2.61780447e+00  2.61780447e+00  2.61780447e+00
  2.73737296e+00  1.97449292e+01  1.97449292e+01  1.97449292e+01
  4.54041128e+01  3.35225253e+02  2.02612418e+03  7.31802579e+03]
E1 = -182.46101496062042  E_coul = 54.262495631768985
cycle= 3 E= -128.198519328851  delta_E= -0.000307  |g|= 0.000686  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000862959
diis-c [-7.82179717e-08 -3.90665549e-03 -2.03250473e-03  1.00593916e+00]
  HOMO = -0.785441044566994  LUMO = 2.61763439950262
  mo_energy =
[-3.27134185e+01 -1.89776142e+00 -7.85441045e-01 -7.85441045e-01
 -7.85441045e-01  2.61763440e+00  2.61763440e+00  2.61763440e+00
  2.73713919e+00  1.97444243e+01  1.97444243e+01  1.97444243e+01
  4.54035042e+01  3.35224768e+02  2.02612383e+03  7.31802548e+03]
E1 = -182.462264195549  E_coul = 54.26374483422264
cycle= 4 E= -128.198519361326  delta_E= -3.25e-08  |g|= 5.15e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.18259e-05
diis-c [-2.12862119e-10  5.05791800e-04 -8.28838276e-04 -1.70613184e-01
  1.17093623e+00]
  HOMO = -0.785426404737622  LUMO = 2.61764704312763
  mo_energy =
[-3.27133808e+01 -1.89775893e+00 -7.85426405e-01 -7.85426405e-01
 -7.85426405e-01  2.61764704e+00  2.61764704e+00  2.61764704e+00
  2.73714053e+00  1.97444535e+01  1.97444535e+01  1.97444535e+01
  4.54035348e+01  3.35224821e+02  2.02612389e+03  7.31802555e+03]
E1 = -182.46220077891712  E_coul = 54.26368141728646
cycle= 5 E= -128.198519361631  delta_E= -3.04e-10  |g|= 1.53e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46220077891712  E_coul = 54.26368141728646
  HOMO = -0.785426346964973  LUMO = 2.61764711015604
  mo_energy =
[-3.27133807e+01 -1.89775925e+00 -7.85426347e-01 -7.85426347e-01
 -7.85426347e-01  2.61764711e+00  2.61764711e+00  2.61764711e+00
  2.73714026e+00  1.97444535e+01  1.97444535e+01  1.97444535e+01
  4.54035348e+01  3.35224821e+02  2.02612390e+03  7.31802555e+03]
E1 = -182.46220076925553  E_coul = 54.26368140762468
Extra cycle  E= -128.198519361631  delta_E= -1.99e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14461421e+03 2.27492290e+02 1.42701043e+03 5.75992677e-01
 5.00548789e+01 1.32726786e+01 1.93033458e+00 2.77029612e+00
 1.32788764e+01 5.99546356e-01]
E = -128.19851936163084
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61421427        1
[INPUT] 0    0    [1    /1   ]  227.492289908        1
[INPUT] 0    0    [1    /1   ]  1427.01043071        1
[INPUT] 0    0    [1    /1   ]  0.575992677428       1
[INPUT] 0    0    [1    /1   ]  50.0548788758        1
[INPUT] 0    0    [1    /1   ]  13.272678554         1
[INPUT] 0    0    [1    /1   ]  1.93033457934        1
[INPUT] 1    0    [1    /1   ]  2.77029612229        1
[INPUT] 1    0    [1    /1   ]  13.2788763606        1
[INPUT] 1    0    [1    /1   ]  0.599546356217       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6142142728177, 1.0]], [0, [227.49228990817338, 1.0]], [0, [1427.0104307120048, 1.0]], [0, [0.5759926774281884, 1.0]], [0, [50.05487887578512, 1.0]], [0, [13.272678554031453, 1.0]], [0, [1.9303345793401578, 1.0]], [1, [2.7702961222865, 1.0]], [1, [13.278876360556426, 1.0]], [1, [0.5995463562166738, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61421427]
bas 1, expnt(s) = [227.49228991]
bas 2, expnt(s) = [1427.01043071]
bas 3, expnt(s) = [0.57599268]
bas 4, expnt(s) = [50.05487888]
bas 5, expnt(s) = [13.27267855]
bas 6, expnt(s) = [1.93033458]
bas 7, expnt(s) = [2.77029612]
bas 8, expnt(s) = [13.27887636]
bas 9, expnt(s) = [0.59954636]
CPU time:       110.71
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461421e+03 7.96208683e+02 2.27492290e+02 1.47992612e+02
 1.42701043e+03 5.86590986e+02 5.75992677e-01 1.67042794e+00
 5.00548789e+01 4.75444508e+01 1.32726786e+01 1.75684706e+01
 1.93033458e+00 4.13751391e+00 2.77029612e+00 1.04265861e+01
 1.32788764e+01 7.39496379e+01 5.99546356e-01 1.53908587e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965801883074384
cond(S) = 160.0951920028623
E1 = -183.1369086467393  E_coul = 55.011389625376054
init E= -128.125519021363
    CPU time for initialize scf      0.03 sec, wall time      0.04 sec
  HOMO = -0.742881315377861  LUMO = 2.65133809621568
  mo_energy =
[-3.25138195e+01 -1.85362265e+00 -7.42881315e-01 -7.42881315e-01
 -7.42881315e-01  2.65133810e+00  2.65133810e+00  2.65133810e+00
  2.77141610e+00  1.98794703e+01  1.98794703e+01  1.98794703e+01
  4.55738807e+01  3.35454156e+02  2.02639602e+03  7.31832036e+03]
E1 = -182.1300198105999  E_coul = 53.93344678889331
cycle= 1 E= -128.196573021707  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260863
diis-c [-0.06804948  1.        ]
  HOMO = -0.808030699854745  LUMO = 2.59718336640344
  mo_energy =
[-3.27876873e+01 -1.92114268e+00 -8.08030700e-01 -8.08030700e-01
 -8.08030700e-01  2.59718337e+00  2.59718337e+00  2.59718337e+00
  2.71711125e+00  1.96887334e+01  1.96887334e+01  1.96887334e+01
  4.53377669e+01  3.35143295e+02  2.02603684e+03  7.31793696e+03]
E1 = -182.59362926281207  E_coul = 54.39541683337125
cycle= 2 E= -128.198212429441  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102161
diis-c [-4.04949446e-04  2.78031814e-01  7.21968186e-01]
  HOMO = -0.785214756310687  LUMO = 2.61780446676322
  mo_energy =
[-3.27127720e+01 -1.89746439e+00 -7.85214756e-01 -7.85214756e-01
 -7.85214756e-01  2.61780447e+00  2.61780447e+00  2.61780447e+00
  2.73737296e+00  1.97449292e+01  1.97449292e+01  1.97449292e+01
  4.54041128e+01  3.35225253e+02  2.02612418e+03  7.31802579e+03]
E1 = -182.46101496062042  E_coul = 54.262495631768985
cycle= 3 E= -128.198519328851  delta_E= -0.000307  |g|= 0.000686  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000862959
diis-c [-7.82179717e-08 -3.90665549e-03 -2.03250473e-03  1.00593916e+00]
  HOMO = -0.785441044566994  LUMO = 2.61763439950262
  mo_energy =
[-3.27134185e+01 -1.89776142e+00 -7.85441045e-01 -7.85441045e-01
 -7.85441045e-01  2.61763440e+00  2.61763440e+00  2.61763440e+00
  2.73713919e+00  1.97444243e+01  1.97444243e+01  1.97444243e+01
  4.54035042e+01  3.35224768e+02  2.02612383e+03  7.31802548e+03]
E1 = -182.462264195549  E_coul = 54.26374483422264
cycle= 4 E= -128.198519361326  delta_E= -3.25e-08  |g|= 5.15e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.18259e-05
diis-c [-2.12862119e-10  5.05791800e-04 -8.28838276e-04 -1.70613184e-01
  1.17093623e+00]
  HOMO = -0.785426404737622  LUMO = 2.61764704312763
  mo_energy =
[-3.27133808e+01 -1.89775893e+00 -7.85426405e-01 -7.85426405e-01
 -7.85426405e-01  2.61764704e+00  2.61764704e+00  2.61764704e+00
  2.73714053e+00  1.97444535e+01  1.97444535e+01  1.97444535e+01
  4.54035348e+01  3.35224821e+02  2.02612389e+03  7.31802555e+03]
E1 = -182.46220077891712  E_coul = 54.26368141728646
cycle= 5 E= -128.198519361631  delta_E= -3.04e-10  |g|= 1.53e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46220077891712  E_coul = 54.26368141728646
  HOMO = -0.785426346964973  LUMO = 2.61764711015604
  mo_energy =
[-3.27133807e+01 -1.89775925e+00 -7.85426347e-01 -7.85426347e-01
 -7.85426347e-01  2.61764711e+00  2.61764711e+00  2.61764711e+00
  2.73714026e+00  1.97444535e+01  1.97444535e+01  1.97444535e+01
  4.54035348e+01  3.35224821e+02  2.02612390e+03  7.31802555e+03]
E1 = -182.46220076925553  E_coul = 54.26368140762468
Extra cycle  E= -128.198519361631  delta_E= -1.99e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.0951920028623
E1 = -182.46220076925553  E_coul = 54.26368140762468
init E= -128.198519361631
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785426332579486  LUMO = 2.61764712158054
  mo_energy =
[-3.27133807e+01 -1.89775930e+00 -7.85426333e-01 -7.85426333e-01
 -7.85426333e-01  2.61764712e+00  2.61764712e+00  2.61764712e+00
  2.73714020e+00  1.97444535e+01  1.97444535e+01  1.97444535e+01
  4.54035348e+01  3.35224821e+02  2.02612390e+03  7.31802555e+03]
E1 = -182.46220077965364  E_coul = 54.26368141802269
cycle= 1 E= -128.198519361631  delta_E= -1.14e-13  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46220077965364  E_coul = 54.26368141802269
  HOMO = -0.785426329002432  LUMO = 2.61764712454576
  mo_energy =
[-3.27133807e+01 -1.89775931e+00 -7.85426329e-01 -7.85426329e-01
 -7.85426329e-01  2.61764712e+00  2.61764712e+00  2.61764712e+00
  2.73714020e+00  1.97444535e+01  1.97444535e+01  1.97444535e+01
  4.54035348e+01  3.35224821e+02  2.02612390e+03  7.31802555e+03]
E1 = -182.46220077737505  E_coul = 54.26368141574433
Extra cycle  E= -128.198519361631  delta_E= 2.56e-13  |g|= 9.33e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14461421e+03 2.27492290e+02 1.42701043e+03 5.75992677e-01
 5.00548789e+01 1.32726786e+01 1.93033458e+00 2.77029612e+00
 1.32788764e+01 5.99546356e-01]
grad_E = [-9.95216501e-06  8.29860274e-06  3.36969770e-05  2.52526663e-06
 -4.88611163e-06  8.22508544e-07 -5.37520242e-06 -2.43886566e-05
 -2.14100645e-04 -3.66812009e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.611476          1
[INPUT] 0    0    [1    /1   ]  227.413924786        1
[INPUT] 0    0    [1    /1   ]  1427.02633725        1
[INPUT] 0    0    [1    /1   ]  0.575944646604       1
[INPUT] 0    0    [1    /1   ]  50.0447383032        1
[INPUT] 0    0    [1    /1   ]  13.2712712934        1
[INPUT] 0    0    [1    /1   ]  1.93019189852        1
[INPUT] 1    0    [1    /1   ]  2.77036193125        1
[INPUT] 1    0    [1    /1   ]  13.2794821184        1
[INPUT] 1    0    [1    /1   ]  0.59955436098        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6114759951374, 1.0]], [0, [227.41392478649743, 1.0]], [0, [1427.0263372460968, 1.0]], [0, [0.5759446466043421, 1.0]], [0, [50.04473830321843, 1.0]], [0, [13.271271293423965, 1.0]], [0, [1.9301918985217925, 1.0]], [1, [2.770361931252458, 1.0]], [1, [13.279482118447081, 1.0]], [1, [0.5995543609796743, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.611476]
bas 1, expnt(s) = [227.41392479]
bas 2, expnt(s) = [1427.02633725]
bas 3, expnt(s) = [0.57594465]
bas 4, expnt(s) = [50.0447383]
bas 5, expnt(s) = [13.27127129]
bas 6, expnt(s) = [1.9301919]
bas 7, expnt(s) = [2.77036193]
bas 8, expnt(s) = [13.27948212]
bas 9, expnt(s) = [0.59955436]
CPU time:       113.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461148e+03 7.96207920e+02 2.27413925e+02 1.47954376e+02
 1.42702634e+03 5.86595890e+02 5.75944647e-01 1.67032347e+00
 5.00447383e+01 4.75372267e+01 1.32712713e+01 1.75670736e+01
 1.93019190e+00 4.13728454e+00 2.77036193e+00 1.04268957e+01
 1.32794821e+01 7.39538547e+01 5.99554361e-01 1.53911156e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965801327740673
cond(S) = 160.07022491798563
E1 = -183.13691796265996  E_coul = 55.011390524139856
init E= -128.12552743852
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742881544508331  LUMO = 2.65139186090931
  mo_energy =
[-3.25138167e+01 -1.85362447e+00 -7.42881545e-01 -7.42881545e-01
 -7.42881545e-01  2.65139186e+00  2.65139186e+00  2.65139186e+00
  2.77103677e+00  1.98803324e+01  1.98803324e+01  1.98803324e+01
  4.55646021e+01  3.35352350e+02  2.02612904e+03  7.31803349e+03]
E1 = -182.13002214673986  E_coul = 53.93344900228062
cycle= 1 E= -128.196573144459  delta_E= -0.071  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260871
diis-c [-0.06805379  1.        ]
  HOMO = -0.808030772321852  LUMO = 2.59723599330181
  mo_energy =
[-3.27876863e+01 -1.92114242e+00 -8.08030772e-01 -8.08030772e-01
 -8.08030772e-01  2.59723599e+00  2.59723599e+00  2.59723599e+00
  2.71674119e+00  1.96895908e+01  1.96895908e+01  1.96895908e+01
  4.53284996e+01  3.35041493e+02  2.02576985e+03  7.31765008e+03]
E1 = -182.593629746526  E_coul = 54.39541720095197
cycle= 2 E= -128.198212545574  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10216
diis-c [-4.05196207e-04  2.78021834e-01  7.21978166e-01]
  HOMO = -0.785214595779703  LUMO = 2.61785767763968
  mo_energy =
[-3.27127703e+01 -1.89746394e+00 -7.85214596e-01 -7.85214596e-01
 -7.85214596e-01  2.61785768e+00  2.61785768e+00  2.61785768e+00
  2.73700099e+00  1.97457881e+01  1.97457881e+01  1.97457881e+01
  4.53948433e+01  3.35123451e+02  2.02585719e+03  7.31773891e+03]
E1 = -182.4610148537388  E_coul = 54.262495413521236
cycle= 3 E= -128.198519440218  delta_E= -0.000307  |g|= 0.000687  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000864092
diis-c [-7.80934615e-08 -3.90400665e-03 -2.01262307e-03  1.00591663e+00]
  HOMO = -0.785441172314887  LUMO = 2.61768734772471
  mo_energy =
[-3.27134176e+01 -1.89776119e+00 -7.85441172e-01 -7.85441172e-01
 -7.85441172e-01  2.61768735e+00  2.61768735e+00  2.61768735e+00
  2.73676706e+00  1.97452825e+01  1.97452825e+01  1.97452825e+01
  4.53942339e+01  3.35122965e+02  2.02585684e+03  7.31773860e+03]
E1 = -182.4622656573628  E_coul = 54.263746184619855
cycle= 4 E= -128.198519472743  delta_E= -3.25e-08  |g|= 5.15e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.17507e-05
diis-c [-2.12812323e-10  5.05397514e-04 -8.30928971e-04 -1.70553914e-01
  1.17087945e+00]
  HOMO = -0.785426545011671  LUMO = 2.61769998110757
  mo_energy =
[-3.27133799e+01 -1.89775870e+00 -7.85426545e-01 -7.85426545e-01
 -7.85426545e-01  2.61769998e+00  2.61769998e+00  2.61769998e+00
  2.73676840e+00  1.97453116e+01  1.97453116e+01  1.97453116e+01
  4.53942645e+01  3.35123017e+02  2.02585690e+03  7.31773867e+03]
E1 = -182.46220229748414  E_coul = 54.26368282443763
cycle= 5 E= -128.198519473047  delta_E= -3.04e-10  |g|= 1.54e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46220229748414  E_coul = 54.26368282443763
  HOMO = -0.785426486696043  LUMO = 2.61770004856686
  mo_energy =
[-3.27133798e+01 -1.89775902e+00 -7.85426487e-01 -7.85426487e-01
 -7.85426487e-01  2.61770005e+00  2.61770005e+00  2.61770005e+00
  2.73676812e+00  1.97453117e+01  1.97453117e+01  1.97453117e+01
  4.53942645e+01  3.35123017e+02  2.02585691e+03  7.31773867e+03]
E1 = -182.46220228551545  E_coul = 54.26368281246852
Extra cycle  E= -128.198519473047  delta_E= -4.26e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14461148e+03 2.27413925e+02 1.42702634e+03 5.75944647e-01
 5.00447383e+01 1.32712713e+01 1.93019190e+00 2.77036193e+00
 1.32794821e+01 5.99554361e-01]
E = -128.19851947304693
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.611476          1
[INPUT] 0    0    [1    /1   ]  227.413924786        1
[INPUT] 0    0    [1    /1   ]  1427.02633725        1
[INPUT] 0    0    [1    /1   ]  0.575944646604       1
[INPUT] 0    0    [1    /1   ]  50.0447383032        1
[INPUT] 0    0    [1    /1   ]  13.2712712934        1
[INPUT] 0    0    [1    /1   ]  1.93019189852        1
[INPUT] 1    0    [1    /1   ]  2.77036193125        1
[INPUT] 1    0    [1    /1   ]  13.2794821184        1
[INPUT] 1    0    [1    /1   ]  0.59955436098        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6114759951374, 1.0]], [0, [227.41392478649743, 1.0]], [0, [1427.0263372460968, 1.0]], [0, [0.5759446466043421, 1.0]], [0, [50.04473830321843, 1.0]], [0, [13.271271293423965, 1.0]], [0, [1.9301918985217925, 1.0]], [1, [2.770361931252458, 1.0]], [1, [13.279482118447081, 1.0]], [1, [0.5995543609796743, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.611476]
bas 1, expnt(s) = [227.41392479]
bas 2, expnt(s) = [1427.02633725]
bas 3, expnt(s) = [0.57594465]
bas 4, expnt(s) = [50.0447383]
bas 5, expnt(s) = [13.27127129]
bas 6, expnt(s) = [1.9301919]
bas 7, expnt(s) = [2.77036193]
bas 8, expnt(s) = [13.27948212]
bas 9, expnt(s) = [0.59955436]
CPU time:       113.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461148e+03 7.96207920e+02 2.27413925e+02 1.47954376e+02
 1.42702634e+03 5.86595890e+02 5.75944647e-01 1.67032347e+00
 5.00447383e+01 4.75372267e+01 1.32712713e+01 1.75670736e+01
 1.93019190e+00 4.13728454e+00 2.77036193e+00 1.04268957e+01
 1.32794821e+01 7.39538547e+01 5.99554361e-01 1.53911156e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965801327740673
cond(S) = 160.07022491798563
E1 = -183.13691796265996  E_coul = 55.011390524139856
init E= -128.12552743852
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742881544508331  LUMO = 2.65139186090931
  mo_energy =
[-3.25138167e+01 -1.85362447e+00 -7.42881545e-01 -7.42881545e-01
 -7.42881545e-01  2.65139186e+00  2.65139186e+00  2.65139186e+00
  2.77103677e+00  1.98803324e+01  1.98803324e+01  1.98803324e+01
  4.55646021e+01  3.35352350e+02  2.02612904e+03  7.31803349e+03]
E1 = -182.13002214673986  E_coul = 53.93344900228062
cycle= 1 E= -128.196573144459  delta_E= -0.071  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260871
diis-c [-0.06805379  1.        ]
  HOMO = -0.808030772321852  LUMO = 2.59723599330181
  mo_energy =
[-3.27876863e+01 -1.92114242e+00 -8.08030772e-01 -8.08030772e-01
 -8.08030772e-01  2.59723599e+00  2.59723599e+00  2.59723599e+00
  2.71674119e+00  1.96895908e+01  1.96895908e+01  1.96895908e+01
  4.53284996e+01  3.35041493e+02  2.02576985e+03  7.31765008e+03]
E1 = -182.593629746526  E_coul = 54.39541720095197
cycle= 2 E= -128.198212545574  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10216
diis-c [-4.05196207e-04  2.78021834e-01  7.21978166e-01]
  HOMO = -0.785214595779703  LUMO = 2.61785767763968
  mo_energy =
[-3.27127703e+01 -1.89746394e+00 -7.85214596e-01 -7.85214596e-01
 -7.85214596e-01  2.61785768e+00  2.61785768e+00  2.61785768e+00
  2.73700099e+00  1.97457881e+01  1.97457881e+01  1.97457881e+01
  4.53948433e+01  3.35123451e+02  2.02585719e+03  7.31773891e+03]
E1 = -182.4610148537388  E_coul = 54.262495413521236
cycle= 3 E= -128.198519440218  delta_E= -0.000307  |g|= 0.000687  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000864092
diis-c [-7.80934615e-08 -3.90400665e-03 -2.01262307e-03  1.00591663e+00]
  HOMO = -0.785441172314887  LUMO = 2.61768734772471
  mo_energy =
[-3.27134176e+01 -1.89776119e+00 -7.85441172e-01 -7.85441172e-01
 -7.85441172e-01  2.61768735e+00  2.61768735e+00  2.61768735e+00
  2.73676706e+00  1.97452825e+01  1.97452825e+01  1.97452825e+01
  4.53942339e+01  3.35122965e+02  2.02585684e+03  7.31773860e+03]
E1 = -182.4622656573628  E_coul = 54.263746184619855
cycle= 4 E= -128.198519472743  delta_E= -3.25e-08  |g|= 5.15e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.17507e-05
diis-c [-2.12812323e-10  5.05397514e-04 -8.30928971e-04 -1.70553914e-01
  1.17087945e+00]
  HOMO = -0.785426545011671  LUMO = 2.61769998110757
  mo_energy =
[-3.27133799e+01 -1.89775870e+00 -7.85426545e-01 -7.85426545e-01
 -7.85426545e-01  2.61769998e+00  2.61769998e+00  2.61769998e+00
  2.73676840e+00  1.97453116e+01  1.97453116e+01  1.97453116e+01
  4.53942645e+01  3.35123017e+02  2.02585690e+03  7.31773867e+03]
E1 = -182.46220229748414  E_coul = 54.26368282443763
cycle= 5 E= -128.198519473047  delta_E= -3.04e-10  |g|= 1.54e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46220229748414  E_coul = 54.26368282443763
  HOMO = -0.785426486696043  LUMO = 2.61770004856686
  mo_energy =
[-3.27133798e+01 -1.89775902e+00 -7.85426487e-01 -7.85426487e-01
 -7.85426487e-01  2.61770005e+00  2.61770005e+00  2.61770005e+00
  2.73676812e+00  1.97453117e+01  1.97453117e+01  1.97453117e+01
  4.53942645e+01  3.35123017e+02  2.02585691e+03  7.31773867e+03]
E1 = -182.46220228551545  E_coul = 54.26368281246852
Extra cycle  E= -128.198519473047  delta_E= -4.26e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.07022491798563
E1 = -182.46220228551545  E_coul = 54.26368281246852
init E= -128.198519473047
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785426472456139  LUMO = 2.61770005985923
  mo_energy =
[-3.27133798e+01 -1.89775908e+00 -7.85426472e-01 -7.85426472e-01
 -7.85426472e-01  2.61770006e+00  2.61770006e+00  2.61770006e+00
  2.73676807e+00  1.97453117e+01  1.97453117e+01  1.97453117e+01
  4.53942645e+01  3.35123017e+02  2.02585691e+03  7.31773867e+03]
E1 = -182.4622022968661  E_coul = 54.26368282381928
cycle= 1 E= -128.198519473047  delta_E= 1.14e-13  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4622022968661  E_coul = 54.26368282381928
  HOMO = -0.785426468811839  LUMO = 2.61770006288513
  mo_energy =
[-3.27133798e+01 -1.89775909e+00 -7.85426469e-01 -7.85426469e-01
 -7.85426469e-01  2.61770006e+00  2.61770006e+00  2.61770006e+00
  2.73676806e+00  1.97453117e+01  1.97453117e+01  1.97453117e+01
  4.53942645e+01  3.35123017e+02  2.02585691e+03  7.31773867e+03]
E1 = -182.4622022942151  E_coul = 54.26368282116853
Extra cycle  E= -128.198519473047  delta_E= 2.27e-13  |g|= 9.34e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14461148e+03 2.27413925e+02 1.42702634e+03 5.75944647e-01
 5.00447383e+01 1.32712713e+01 1.93019190e+00 2.77036193e+00
 1.32794821e+01 5.99554361e-01]
grad_E = [-9.93886650e-06  6.35792704e-06  3.37691460e-05 -7.72702437e-06
 -6.22645663e-07 -2.33061006e-06 -9.70257830e-07 -3.22555662e-05
 -2.10458581e-04 -6.34597940e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61031746        1
[INPUT] 0    0    [1    /1   ]  227.380191448        1
[INPUT] 0    0    [1    /1   ]  1427.03310567        1
[INPUT] 0    0    [1    /1   ]  0.575937827889       1
[INPUT] 0    0    [1    /1   ]  50.0411933339        1
[INPUT] 0    0    [1    /1   ]  13.2708858333        1
[INPUT] 0    0    [1    /1   ]  1.93017613918        1
[INPUT] 1    0    [1    /1   ]  2.77044102346        1
[INPUT] 1    0    [1    /1   ]  13.2800433172        1
[INPUT] 1    0    [1    /1   ]  0.599565894283       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6103174596083, 1.0]], [0, [227.38019144765366, 1.0]], [0, [1427.0331056711025, 1.0]], [0, [0.5759378278889709, 1.0]], [0, [50.04119333394941, 1.0]], [0, [13.270885833272702, 1.0]], [0, [1.9301761391809658, 1.0]], [1, [2.77044102346099, 1.0]], [1, [13.280043317159503, 1.0]], [1, [0.5995658942829677, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61031746]
bas 1, expnt(s) = [227.38019145]
bas 2, expnt(s) = [1427.03310567]
bas 3, expnt(s) = [0.57593783]
bas 4, expnt(s) = [50.04119333]
bas 5, expnt(s) = [13.27088583]
bas 6, expnt(s) = [1.93017614]
bas 7, expnt(s) = [2.77044102]
bas 8, expnt(s) = [13.28004332]
bas 9, expnt(s) = [0.59956589]
CPU time:       116.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461032e+03 7.96207598e+02 2.27380191e+02 1.47937916e+02
 1.42703311e+03 5.86597977e+02 5.75937828e-01 1.67030864e+00
 5.00411933e+01 4.75347011e+01 1.32708858e+01 1.75666909e+01
 1.93017614e+00 4.13725921e+00 2.77044102e+00 1.04272678e+01
 1.32800433e+01 7.39577614e+01 5.99565894e-01 1.53914857e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965799150844724
cond(S) = 160.06032592720018
E1 = -183.13692171948776  E_coul = 55.011392649701946
init E= -128.125529069786
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742881652133291  LUMO = 2.65146551651585
  mo_energy =
[-3.25138148e+01 -1.85362480e+00 -7.42881652e-01 -7.42881652e-01
 -7.42881652e-01  2.65146552e+00  2.65146552e+00  2.65146552e+00
  2.77098442e+00  1.98812006e+01  1.98812006e+01  1.98812006e+01
  4.55618265e+01  3.35311935e+02  2.02601784e+03  7.31791348e+03]
E1 = -182.13008081046075  E_coul = 53.93350740907049
cycle= 1 E= -128.19657340139  delta_E= -0.071  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260865
diis-c [-0.06805051  1.        ]
  HOMO = -0.808026686198995  LUMO = 2.59731195788827
  mo_energy =
[-3.27876743e+01 -1.92113752e+00 -8.08026686e-01 -8.08026686e-01
 -8.08026686e-01  2.59731196e+00  2.59731196e+00  2.59731196e+00
  2.71669468e+00  1.96904637e+01  1.96904637e+01  1.96904637e+01
  4.53257371e+01  3.35001092e+02  2.02565866e+03  7.31753008e+03]
E1 = -182.5936636809725  E_coul = 54.39545102177831
cycle= 2 E= -128.198212659194  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102155
diis-c [-4.05309003e-04  2.78014282e-01  7.21985718e-01]
  HOMO = -0.785211530605831  LUMO = 2.61793322200382
  mo_energy =
[-3.27127612e+01 -1.89746012e+00 -7.85211531e-01 -7.85211531e-01
 -7.85211531e-01  2.61793322e+00  2.61793322e+00  2.61793322e+00
  2.73695323e+00  1.97466595e+01  1.97466595e+01  1.97466595e+01
  4.53920772e+01  3.35083046e+02  2.02574600e+03  7.31761891e+03]
E1 = -182.46105588028965  E_coul = 54.26253636113263
cycle= 3 E= -128.198519519157  delta_E= -0.000307  |g|= 0.000687  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000864729
diis-c [-7.80378481e-08 -3.90276164e-03 -2.00185068e-03  1.00590461e+00]
  HOMO = -0.78543827004112  LUMO = 2.61776273792777
  mo_energy =
[-3.27134091e+01 -1.89775751e+00 -7.85438270e-01 -7.85438270e-01
 -7.85438270e-01  2.61776274e+00  2.61776274e+00  2.61776274e+00
  2.73671918e+00  1.97461535e+01  1.97461535e+01  1.97461535e+01
  4.53914674e+01  3.35082560e+02  2.02574565e+03  7.31761859e+03]
E1 = -182.46230756912007  E_coul = 54.26378801740707
cycle= 4 E= -128.198519551713  delta_E= -3.26e-08  |g|= 5.15e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.1718e-05
diis-c [-2.12757304e-10  5.05220692e-04 -8.32232259e-04 -1.70529184e-01
  1.17085620e+00]
  HOMO = -0.785423648209606  LUMO = 2.61777536712921
  mo_energy =
[-3.27133714e+01 -1.89775502e+00 -7.85423648e-01 -7.85423648e-01
 -7.85423648e-01  2.61777537e+00  2.61777537e+00  2.61777537e+00
  2.73672052e+00  1.97461826e+01  1.97461826e+01  1.97461826e+01
  4.53914980e+01  3.35082612e+02  2.02574571e+03  7.31761866e+03]
E1 = -182.46224423328823  E_coul = 54.263724681272016
cycle= 5 E= -128.198519552016  delta_E= -3.03e-10  |g|= 1.54e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46224423328823  E_coul = 54.263724681272016
  HOMO = -0.785423589733636  LUMO = 2.61777543470298
  mo_energy =
[-3.27133713e+01 -1.89775534e+00 -7.85423590e-01 -7.85423590e-01
 -7.85423590e-01  2.61777543e+00  2.61777543e+00  2.61777543e+00
  2.73672025e+00  1.97461827e+01  1.97461827e+01  1.97461827e+01
  4.53914980e+01  3.35082612e+02  2.02574571e+03  7.31761866e+03]
E1 = -182.46224422068917  E_coul = 54.26372466867254
Extra cycle  E= -128.198519552017  delta_E= -4.26e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14461032e+03 2.27380191e+02 1.42703311e+03 5.75937828e-01
 5.00411933e+01 1.32708858e+01 1.93017614e+00 2.77044102e+00
 1.32800433e+01 5.99565894e-01]
E = -128.19851955201665
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61031746        1
[INPUT] 0    0    [1    /1   ]  227.380191448        1
[INPUT] 0    0    [1    /1   ]  1427.03310567        1
[INPUT] 0    0    [1    /1   ]  0.575937827889       1
[INPUT] 0    0    [1    /1   ]  50.0411933339        1
[INPUT] 0    0    [1    /1   ]  13.2708858333        1
[INPUT] 0    0    [1    /1   ]  1.93017613918        1
[INPUT] 1    0    [1    /1   ]  2.77044102346        1
[INPUT] 1    0    [1    /1   ]  13.2800433172        1
[INPUT] 1    0    [1    /1   ]  0.599565894283       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6103174596083, 1.0]], [0, [227.38019144765366, 1.0]], [0, [1427.0331056711025, 1.0]], [0, [0.5759378278889709, 1.0]], [0, [50.04119333394941, 1.0]], [0, [13.270885833272702, 1.0]], [0, [1.9301761391809658, 1.0]], [1, [2.77044102346099, 1.0]], [1, [13.280043317159503, 1.0]], [1, [0.5995658942829677, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61031746]
bas 1, expnt(s) = [227.38019145]
bas 2, expnt(s) = [1427.03310567]
bas 3, expnt(s) = [0.57593783]
bas 4, expnt(s) = [50.04119333]
bas 5, expnt(s) = [13.27088583]
bas 6, expnt(s) = [1.93017614]
bas 7, expnt(s) = [2.77044102]
bas 8, expnt(s) = [13.28004332]
bas 9, expnt(s) = [0.59956589]
CPU time:       117.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461032e+03 7.96207598e+02 2.27380191e+02 1.47937916e+02
 1.42703311e+03 5.86597977e+02 5.75937828e-01 1.67030864e+00
 5.00411933e+01 4.75347011e+01 1.32708858e+01 1.75666909e+01
 1.93017614e+00 4.13725921e+00 2.77044102e+00 1.04272678e+01
 1.32800433e+01 7.39577614e+01 5.99565894e-01 1.53914857e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965799150844724
cond(S) = 160.06032592720018
E1 = -183.13692171948776  E_coul = 55.011392649701946
init E= -128.125529069786
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742881652133291  LUMO = 2.65146551651585
  mo_energy =
[-3.25138148e+01 -1.85362480e+00 -7.42881652e-01 -7.42881652e-01
 -7.42881652e-01  2.65146552e+00  2.65146552e+00  2.65146552e+00
  2.77098442e+00  1.98812006e+01  1.98812006e+01  1.98812006e+01
  4.55618265e+01  3.35311935e+02  2.02601784e+03  7.31791348e+03]
E1 = -182.13008081046075  E_coul = 53.93350740907049
cycle= 1 E= -128.19657340139  delta_E= -0.071  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260865
diis-c [-0.06805051  1.        ]
  HOMO = -0.808026686198995  LUMO = 2.59731195788827
  mo_energy =
[-3.27876743e+01 -1.92113752e+00 -8.08026686e-01 -8.08026686e-01
 -8.08026686e-01  2.59731196e+00  2.59731196e+00  2.59731196e+00
  2.71669468e+00  1.96904637e+01  1.96904637e+01  1.96904637e+01
  4.53257371e+01  3.35001092e+02  2.02565866e+03  7.31753008e+03]
E1 = -182.5936636809725  E_coul = 54.39545102177831
cycle= 2 E= -128.198212659194  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102155
diis-c [-4.05309003e-04  2.78014282e-01  7.21985718e-01]
  HOMO = -0.785211530605831  LUMO = 2.61793322200382
  mo_energy =
[-3.27127612e+01 -1.89746012e+00 -7.85211531e-01 -7.85211531e-01
 -7.85211531e-01  2.61793322e+00  2.61793322e+00  2.61793322e+00
  2.73695323e+00  1.97466595e+01  1.97466595e+01  1.97466595e+01
  4.53920772e+01  3.35083046e+02  2.02574600e+03  7.31761891e+03]
E1 = -182.46105588028965  E_coul = 54.26253636113263
cycle= 3 E= -128.198519519157  delta_E= -0.000307  |g|= 0.000687  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000864729
diis-c [-7.80378481e-08 -3.90276164e-03 -2.00185068e-03  1.00590461e+00]
  HOMO = -0.78543827004112  LUMO = 2.61776273792777
  mo_energy =
[-3.27134091e+01 -1.89775751e+00 -7.85438270e-01 -7.85438270e-01
 -7.85438270e-01  2.61776274e+00  2.61776274e+00  2.61776274e+00
  2.73671918e+00  1.97461535e+01  1.97461535e+01  1.97461535e+01
  4.53914674e+01  3.35082560e+02  2.02574565e+03  7.31761859e+03]
E1 = -182.46230756912007  E_coul = 54.26378801740707
cycle= 4 E= -128.198519551713  delta_E= -3.26e-08  |g|= 5.15e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.1718e-05
diis-c [-2.12757304e-10  5.05220692e-04 -8.32232259e-04 -1.70529184e-01
  1.17085620e+00]
  HOMO = -0.785423648209606  LUMO = 2.61777536712921
  mo_energy =
[-3.27133714e+01 -1.89775502e+00 -7.85423648e-01 -7.85423648e-01
 -7.85423648e-01  2.61777537e+00  2.61777537e+00  2.61777537e+00
  2.73672052e+00  1.97461826e+01  1.97461826e+01  1.97461826e+01
  4.53914980e+01  3.35082612e+02  2.02574571e+03  7.31761866e+03]
E1 = -182.46224423328823  E_coul = 54.263724681272016
cycle= 5 E= -128.198519552016  delta_E= -3.03e-10  |g|= 1.54e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46224423328823  E_coul = 54.263724681272016
  HOMO = -0.785423589733636  LUMO = 2.61777543470298
  mo_energy =
[-3.27133713e+01 -1.89775534e+00 -7.85423590e-01 -7.85423590e-01
 -7.85423590e-01  2.61777543e+00  2.61777543e+00  2.61777543e+00
  2.73672025e+00  1.97461827e+01  1.97461827e+01  1.97461827e+01
  4.53914980e+01  3.35082612e+02  2.02574571e+03  7.31761866e+03]
E1 = -182.46224422068917  E_coul = 54.26372466867254
Extra cycle  E= -128.198519552017  delta_E= -4.26e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.06032592720018
E1 = -182.46224422068917  E_coul = 54.26372466867254
init E= -128.198519552017
    CPU time for initialize scf      0.06 sec, wall time      0.06 sec
  HOMO = -0.785423575533559  LUMO = 2.61777544595957
  mo_energy =
[-3.27133713e+01 -1.89775540e+00 -7.85423576e-01 -7.85423576e-01
 -7.85423576e-01  2.61777545e+00  2.61777545e+00  2.61777545e+00
  2.73672020e+00  1.97461827e+01  1.97461827e+01  1.97461827e+01
  4.53914979e+01  3.35082612e+02  2.02574571e+03  7.31761866e+03]
E1 = -182.4622442323026  E_coul = 54.2637246802859
cycle= 1 E= -128.198519552017  delta_E= -5.68e-14  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4622442323026  E_coul = 54.2637246802859
  HOMO = -0.785423571870788  LUMO = 2.61777544900219
  mo_energy =
[-3.27133713e+01 -1.89775541e+00 -7.85423572e-01 -7.85423572e-01
 -7.85423572e-01  2.61777545e+00  2.61777545e+00  2.61777545e+00
  2.73672019e+00  1.97461827e+01  1.97461827e+01  1.97461827e+01
  4.53914979e+01  3.35082612e+02  2.02574571e+03  7.31761866e+03]
E1 = -182.4622442295495  E_coul = 54.26372467753293
Extra cycle  E= -128.198519552017  delta_E= 1.42e-13  |g|= 9.34e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14461032e+03 2.27380191e+02 1.42703311e+03 5.75937828e-01
 5.00411933e+01 1.32708858e+01 1.93017614e+00 2.77044102e+00
 1.32800433e+01 5.99565894e-01]
grad_E = [-9.93285874e-06  5.34099060e-06  3.38022289e-05 -7.80013240e-06
  2.21836974e-06 -3.00133398e-06  5.03751593e-07 -3.19933485e-05
 -2.08203936e-04 -6.06352297e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60922128        1
[INPUT] 0    0    [1    /1   ]  227.347616184        1
[INPUT] 0    0    [1    /1   ]  1427.03956153        1
[INPUT] 0    0    [1    /1   ]  0.575934268858       1
[INPUT] 0    0    [1    /1   ]  50.0379785002        1
[INPUT] 0    0    [1    /1   ]  13.2705773909        1
[INPUT] 0    0    [1    /1   ]  1.9301686524         1
[INPUT] 1    0    [1    /1   ]  2.77059287209        1
[INPUT] 1    0    [1    /1   ]  13.2810205543        1
[INPUT] 1    0    [1    /1   ]  0.599589076318       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.609221279021, 1.0]], [0, [227.34761618432455, 1.0]], [0, [1427.0395615299308, 1.0]], [0, [0.5759342688577688, 1.0]], [0, [50.03797850020391, 1.0]], [0, [13.27057739094059, 1.0]], [0, [1.9301686524008852, 1.0]], [1, [2.7705928720913273, 1.0]], [1, [13.281020554257687, 1.0]], [1, [0.5995890763181161, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60922128]
bas 1, expnt(s) = [227.34761618]
bas 2, expnt(s) = [1427.03956153]
bas 3, expnt(s) = [0.57593427]
bas 4, expnt(s) = [50.0379785]
bas 5, expnt(s) = [13.27057739]
bas 6, expnt(s) = [1.93016865]
bas 7, expnt(s) = [2.77059287]
bas 8, expnt(s) = [13.28102055]
bas 9, expnt(s) = [0.59958908]
CPU time:       119.61
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460922e+03 7.96207293e+02 2.27347616e+02 1.47922020e+02
 1.42703956e+03 5.86599967e+02 5.75934269e-01 1.67030090e+00
 5.00379785e+01 4.75324107e+01 1.32705774e+01 1.75663847e+01
 1.93016865e+00 4.13724717e+00 2.77059287e+00 1.04279823e+01
 1.32810206e+01 7.39645643e+01 5.99589076e-01 1.53922296e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965794516065714
cond(S) = 160.05094100035436
E1 = -183.13692594265922  E_coul = 55.01139657882805
init E= -128.125529363831
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742881781571763  LUMO = 2.65161188526554
  mo_energy =
[-3.25138118e+01 -1.85362512e+00 -7.42881782e-01 -7.42881782e-01
 -7.42881782e-01  2.65161189e+00  2.65161189e+00  2.65161189e+00
  2.77095566e+00  1.98827662e+01  1.98827662e+01  1.98827662e+01
  4.55594570e+01  3.35273788e+02  2.02591139e+03  7.31779838e+03]
E1 = -182.13021045629907  E_coul = 53.93363651196997
cycle= 1 E= -128.196573944329  delta_E= -0.071  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260846
diis-c [-0.06804073  1.        ]
  HOMO = -0.808017577138881  LUMO = 2.59746384455162
  mo_energy =
[-3.27876477e+01 -1.92112682e+00 -8.08017577e-01 -8.08017577e-01
 -8.08017577e-01  2.59746384e+00  2.59746384e+00  2.59746384e+00
  2.71667652e+00  1.96920419e+01  1.96920419e+01  1.96920419e+01
  4.53233926e+01  3.34962975e+02  2.02555224e+03  7.31741500e+03]
E1 = -182.59373850024227  E_coul = 54.395525619605735
cycle= 2 E= -128.198212880637  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102142
diis-c [-4.05407705e-04  2.78002706e-01  7.21997294e-01]
  HOMO = -0.785204843582164  LUMO = 2.61808390903573
  mo_energy =
[-3.27127419e+01 -1.89745199e+00 -7.85204844e-01 -7.85204844e-01
 -7.85204844e-01  2.61808391e+00  2.61808391e+00  2.61808391e+00
  2.73693268e+00  1.97482335e+01  1.97482335e+01  1.97482335e+01
  4.53897254e+01  3.35044920e+02  2.02563957e+03  7.31750382e+03]
E1 = -182.46114707609615  E_coul = 54.26262741156006
cycle= 3 E= -128.198519664536  delta_E= -0.000307  |g|= 0.000687  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000865539
diis-c [-7.79448624e-08 -3.90128216e-03 -1.98796376e-03  1.00588925e+00]
  HOMO = -0.785431792508174  LUMO = 2.61791322114157
  mo_energy =
[-3.27133904e+01 -1.89774955e+00 -7.85431793e-01 -7.85431793e-01
 -7.85431793e-01  2.61791322e+00  2.61791322e+00  2.61791322e+00
  2.73669849e+00  1.97477271e+01  1.97477271e+01  1.97477271e+01
  4.53891150e+01  3.35044433e+02  2.02563921e+03  7.31750351e+03]
E1 = -182.4623998794108  E_coul = 54.26388018228183
cycle= 4 E= -128.198519697129  delta_E= -3.26e-08  |g|= 5.14e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.16663e-05
diis-c [-2.12644728e-10  5.05021952e-04 -8.33832677e-04 -1.70494721e-01
  1.17082353e+00]
  HOMO = -0.785417179122914  LUMO = 2.61792584396497
  mo_energy =
[-3.27133527e+01 -1.89774705e+00 -7.85417179e-01 -7.85417179e-01
 -7.85417179e-01  2.61792584e+00  2.61792584e+00  2.61792584e+00
  2.73669983e+00  1.97477562e+01  1.97477562e+01  1.97477562e+01
  4.53891456e+01  3.35044485e+02  2.02563928e+03  7.31750358e+03]
E1 = -182.4623365806818  E_coul = 54.26381688325011
cycle= 5 E= -128.198519697432  delta_E= -3.03e-10  |g|= 1.54e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4623365806818  E_coul = 54.26381688325011
  HOMO = -0.785417120507893  LUMO = 2.61792591163
  mo_energy =
[-3.27133527e+01 -1.89774738e+00 -7.85417121e-01 -7.85417121e-01
 -7.85417121e-01  2.61792591e+00  2.61792591e+00  2.61792591e+00
  2.73669955e+00  1.97477562e+01  1.97477562e+01  1.97477562e+01
  4.53891455e+01  3.35044485e+02  2.02563928e+03  7.31750358e+03]
E1 = -182.46233656760933  E_coul = 54.263816870177436
Extra cycle  E= -128.198519697432  delta_E= -1.99e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14460922e+03 2.27347616e+02 1.42703956e+03 5.75934269e-01
 5.00379785e+01 1.32705774e+01 1.93016865e+00 2.77059287e+00
 1.32810206e+01 5.99589076e-01]
E = -128.1985196974319
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60922128        1
[INPUT] 0    0    [1    /1   ]  227.347616184        1
[INPUT] 0    0    [1    /1   ]  1427.03956153        1
[INPUT] 0    0    [1    /1   ]  0.575934268858       1
[INPUT] 0    0    [1    /1   ]  50.0379785002        1
[INPUT] 0    0    [1    /1   ]  13.2705773909        1
[INPUT] 0    0    [1    /1   ]  1.9301686524         1
[INPUT] 1    0    [1    /1   ]  2.77059287209        1
[INPUT] 1    0    [1    /1   ]  13.2810205543        1
[INPUT] 1    0    [1    /1   ]  0.599589076318       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.609221279021, 1.0]], [0, [227.34761618432455, 1.0]], [0, [1427.0395615299308, 1.0]], [0, [0.5759342688577688, 1.0]], [0, [50.03797850020391, 1.0]], [0, [13.27057739094059, 1.0]], [0, [1.9301686524008852, 1.0]], [1, [2.7705928720913273, 1.0]], [1, [13.281020554257687, 1.0]], [1, [0.5995890763181161, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60922128]
bas 1, expnt(s) = [227.34761618]
bas 2, expnt(s) = [1427.03956153]
bas 3, expnt(s) = [0.57593427]
bas 4, expnt(s) = [50.0379785]
bas 5, expnt(s) = [13.27057739]
bas 6, expnt(s) = [1.93016865]
bas 7, expnt(s) = [2.77059287]
bas 8, expnt(s) = [13.28102055]
bas 9, expnt(s) = [0.59958908]
CPU time:       120.32
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460922e+03 7.96207293e+02 2.27347616e+02 1.47922020e+02
 1.42703956e+03 5.86599967e+02 5.75934269e-01 1.67030090e+00
 5.00379785e+01 4.75324107e+01 1.32705774e+01 1.75663847e+01
 1.93016865e+00 4.13724717e+00 2.77059287e+00 1.04279823e+01
 1.32810206e+01 7.39645643e+01 5.99589076e-01 1.53922296e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965794516065714
cond(S) = 160.05094100035436
E1 = -183.13692594265922  E_coul = 55.01139657882805
init E= -128.125529363831
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742881781571763  LUMO = 2.65161188526554
  mo_energy =
[-3.25138118e+01 -1.85362512e+00 -7.42881782e-01 -7.42881782e-01
 -7.42881782e-01  2.65161189e+00  2.65161189e+00  2.65161189e+00
  2.77095566e+00  1.98827662e+01  1.98827662e+01  1.98827662e+01
  4.55594570e+01  3.35273788e+02  2.02591139e+03  7.31779838e+03]
E1 = -182.13021045629907  E_coul = 53.93363651196997
cycle= 1 E= -128.196573944329  delta_E= -0.071  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260846
diis-c [-0.06804073  1.        ]
  HOMO = -0.808017577138881  LUMO = 2.59746384455162
  mo_energy =
[-3.27876477e+01 -1.92112682e+00 -8.08017577e-01 -8.08017577e-01
 -8.08017577e-01  2.59746384e+00  2.59746384e+00  2.59746384e+00
  2.71667652e+00  1.96920419e+01  1.96920419e+01  1.96920419e+01
  4.53233926e+01  3.34962975e+02  2.02555224e+03  7.31741500e+03]
E1 = -182.59373850024227  E_coul = 54.395525619605735
cycle= 2 E= -128.198212880637  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102142
diis-c [-4.05407705e-04  2.78002706e-01  7.21997294e-01]
  HOMO = -0.785204843582164  LUMO = 2.61808390903573
  mo_energy =
[-3.27127419e+01 -1.89745199e+00 -7.85204844e-01 -7.85204844e-01
 -7.85204844e-01  2.61808391e+00  2.61808391e+00  2.61808391e+00
  2.73693268e+00  1.97482335e+01  1.97482335e+01  1.97482335e+01
  4.53897254e+01  3.35044920e+02  2.02563957e+03  7.31750382e+03]
E1 = -182.46114707609615  E_coul = 54.26262741156006
cycle= 3 E= -128.198519664536  delta_E= -0.000307  |g|= 0.000687  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000865539
diis-c [-7.79448624e-08 -3.90128216e-03 -1.98796376e-03  1.00588925e+00]
  HOMO = -0.785431792508174  LUMO = 2.61791322114157
  mo_energy =
[-3.27133904e+01 -1.89774955e+00 -7.85431793e-01 -7.85431793e-01
 -7.85431793e-01  2.61791322e+00  2.61791322e+00  2.61791322e+00
  2.73669849e+00  1.97477271e+01  1.97477271e+01  1.97477271e+01
  4.53891150e+01  3.35044433e+02  2.02563921e+03  7.31750351e+03]
E1 = -182.4623998794108  E_coul = 54.26388018228183
cycle= 4 E= -128.198519697129  delta_E= -3.26e-08  |g|= 5.14e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.16663e-05
diis-c [-2.12644728e-10  5.05021952e-04 -8.33832677e-04 -1.70494721e-01
  1.17082353e+00]
  HOMO = -0.785417179122914  LUMO = 2.61792584396497
  mo_energy =
[-3.27133527e+01 -1.89774705e+00 -7.85417179e-01 -7.85417179e-01
 -7.85417179e-01  2.61792584e+00  2.61792584e+00  2.61792584e+00
  2.73669983e+00  1.97477562e+01  1.97477562e+01  1.97477562e+01
  4.53891456e+01  3.35044485e+02  2.02563928e+03  7.31750358e+03]
E1 = -182.4623365806818  E_coul = 54.26381688325011
cycle= 5 E= -128.198519697432  delta_E= -3.03e-10  |g|= 1.54e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4623365806818  E_coul = 54.26381688325011
  HOMO = -0.785417120507893  LUMO = 2.61792591163
  mo_energy =
[-3.27133527e+01 -1.89774738e+00 -7.85417121e-01 -7.85417121e-01
 -7.85417121e-01  2.61792591e+00  2.61792591e+00  2.61792591e+00
  2.73669955e+00  1.97477562e+01  1.97477562e+01  1.97477562e+01
  4.53891455e+01  3.35044485e+02  2.02563928e+03  7.31750358e+03]
E1 = -182.46233656760933  E_coul = 54.263816870177436
Extra cycle  E= -128.198519697432  delta_E= -1.99e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.05094100035436
E1 = -182.46233656760933  E_coul = 54.263816870177436
init E= -128.198519697432
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785417106337485  LUMO = 2.6179259228605
  mo_energy =
[-3.27133527e+01 -1.89774743e+00 -7.85417106e-01 -7.85417106e-01
 -7.85417106e-01  2.61792592e+00  2.61792592e+00  2.61792592e+00
  2.73669950e+00  1.97477562e+01  1.97477562e+01  1.97477562e+01
  4.53891455e+01  3.35044485e+02  2.02563928e+03  7.31750358e+03]
E1 = -182.46233657942773  E_coul = 54.26381688199574
cycle= 1 E= -128.198519697432  delta_E= -1.14e-13  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46233657942773  E_coul = 54.26381688199574
  HOMO = -0.78541710266035  LUMO = 2.61792592591627
  mo_energy =
[-3.27133527e+01 -1.89774744e+00 -7.85417103e-01 -7.85417103e-01
 -7.85417103e-01  2.61792593e+00  2.61792593e+00  2.61792593e+00
  2.73669949e+00  1.97477562e+01  1.97477562e+01  1.97477562e+01
  4.53891455e+01  3.35044485e+02  2.02563928e+03  7.31750358e+03]
E1 = -182.46233657659545  E_coul = 54.2638168791634
Extra cycle  E= -128.198519697432  delta_E= -5.68e-14  |g|= 9.35e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14460922e+03 2.27347616e+02 1.42703956e+03 5.75934269e-01
 5.00379785e+01 1.32705774e+01 1.93016865e+00 2.77059287e+00
 1.32810206e+01 5.99589076e-01]
grad_E = [-9.92698956e-06  4.31821255e-06  3.38346510e-05 -6.04184979e-06
  5.11673169e-06 -3.00732676e-06  1.19427034e-06 -2.53747079e-05
 -2.05172029e-04 -3.92840586e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60801183        1
[INPUT] 0    0    [1    /1   ]  227.310668664        1
[INPUT] 0    0    [1    /1   ]  1427.04676541        1
[INPUT] 0    0    [1    /1   ]  0.575933261015       1
[INPUT] 0    0    [1    /1   ]  50.0344857623        1
[INPUT] 0    0    [1    /1   ]  13.2702783447        1
[INPUT] 0    0    [1    /1   ]  1.93017022368        1
[INPUT] 1    0    [1    /1   ]  2.7708726225         1
[INPUT] 1    0    [1    /1   ]  13.2828029969        1
[INPUT] 1    0    [1    /1   ]  0.599631973028       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6080118271216, 1.0]], [0, [227.31066866447142, 1.0]], [0, [1427.0467654116721, 1.0]], [0, [0.5759332610149711, 1.0]], [0, [50.03448576229937, 1.0]], [0, [13.270278344687728, 1.0]], [0, [1.9301702236764704, 1.0]], [1, [2.7708726225043496, 1.0]], [1, [13.282802996928648, 1.0]], [1, [0.5996319730277032, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60801183]
bas 1, expnt(s) = [227.31066866]
bas 2, expnt(s) = [1427.04676541]
bas 3, expnt(s) = [0.57593326]
bas 4, expnt(s) = [50.03448576]
bas 5, expnt(s) = [13.27027834]
bas 6, expnt(s) = [1.93017022]
bas 7, expnt(s) = [2.77087262]
bas 8, expnt(s) = [13.282803]
bas 9, expnt(s) = [0.59963197]
CPU time:       122.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460801e+03 7.96206956e+02 2.27310669e+02 1.47903990e+02
 1.42704677e+03 5.86602188e+02 5.75933261e-01 1.67029871e+00
 5.00344858e+01 4.75299223e+01 1.32702783e+01 1.75660878e+01
 1.93017022e+00 4.13724970e+00 2.77087262e+00 1.04292984e+01
 1.32828030e+01 7.39769730e+01 5.99631973e-01 1.53936061e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96578577419228
cond(S) = 160.0404173100415
E1 = -183.13693164924467  E_coul = 55.01140359245264
init E= -128.125528056792
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742882038081882  LUMO = 2.65188243258164
  mo_energy =
[-3.25138065e+01 -1.85362554e+00 -7.42882038e-01 -7.42882038e-01
 -7.42882038e-01  2.65188243e+00  2.65188243e+00  2.65188243e+00
  2.77094728e+00  1.98856324e+01  1.98856324e+01  1.98856324e+01
  4.55570306e+01  3.35231205e+02  2.02579133e+03  7.31766835e+03]
E1 = -182.13045515139095  E_coul = 53.93388018348165
cycle= 1 E= -128.196574967909  delta_E= -0.071  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260808
diis-c [-0.06802077  1.        ]
  HOMO = -0.808000361041121  LUMO = 2.59774499216203
  mo_energy =
[-3.27875977e+01 -1.92110664e+00 -8.08000361e-01 -8.08000361e-01
 -8.08000361e-01  2.59774499e+00  2.59774499e+00  2.59774499e+00
  2.71668701e+00  1.96949326e+01  1.96949326e+01  1.96949326e+01
  4.53210107e+01  3.34920442e+02  2.02543223e+03  7.31728501e+03]
E1 = -182.59387944700813  E_coul = 54.39566615189982
cycle= 2 E= -128.198213295108  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102119
diis-c [-4.05501825e-04  2.77983730e-01  7.22016270e-01]
  HOMO = -0.785192302576502  LUMO = 2.61836265920881
  mo_energy =
[-3.27127059e+01 -1.89743677e+00 -7.85192303e-01 -7.85192303e-01
 -7.85192303e-01  2.61836266e+00  2.61836266e+00  2.61836266e+00
  2.73693884e+00  1.97511161e+01  1.97511161e+01  1.97511161e+01
  4.53873300e+01  3.35002372e+02  2.02551954e+03  7.31737382e+03]
E1 = -182.46131946011104  E_coul = 54.2627995247135
cycle= 3 E= -128.198519935398  delta_E= -0.000307  |g|= 0.000688  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000866715
diis-c [-7.77814262e-08 -3.89922324e-03 -1.96752913e-03  1.00586675e+00]
  HOMO = -0.785419558322307  LUMO = 2.61819166698899
  mo_energy =
[-3.27133553e+01 -1.89773455e+00 -7.85419558e-01 -7.85419558e-01
 -7.85419558e-01  2.61819167e+00  2.61819167e+00  2.61819167e+00
  2.73670444e+00  1.97506090e+01  1.97506090e+01  1.97506090e+01
  4.53867188e+01  3.35001883e+02  2.02551919e+03  7.31737350e+03]
E1 = -182.46257386647838  E_coul = 54.26405389843801
cycle= 4 E= -128.19851996804  delta_E= -3.26e-08  |g|= 5.14e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.15777e-05
diis-c [-2.12436918e-10  5.04750413e-04 -8.36068425e-04 -1.70437980e-01
  1.17076930e+00]
  HOMO = -0.785404959266946  LUMO = 2.61820427901334
  mo_energy =
[-3.27133176e+01 -1.89773206e+00 -7.85404959e-01 -7.85404959e-01
 -7.85404959e-01  2.61820428e+00  2.61820428e+00  2.61820428e+00
  2.73670579e+00  1.97506380e+01  1.97506380e+01  1.97506380e+01
  4.53867494e+01  3.35001935e+02  2.02551926e+03  7.31737357e+03]
E1 = -182.4625106306185  E_coul = 54.26399066227601
cycle= 5 E= -128.198519968343  delta_E= -3.02e-10  |g|= 1.54e-06  |ddm|= 2.61e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4625106306185  E_coul = 54.26399066227601
  HOMO = -0.785404900497899  LUMO = 2.61820434677182
  mo_energy =
[-3.27133176e+01 -1.89773238e+00 -7.85404900e-01 -7.85404900e-01
 -7.85404900e-01  2.61820435e+00  2.61820435e+00  2.61820435e+00
  2.73670551e+00  1.97506381e+01  1.97506381e+01  1.97506381e+01
  4.53867493e+01  3.35001935e+02  2.02551926e+03  7.31737358e+03]
E1 = -182.46251061711388  E_coul = 54.263990648771056
Extra cycle  E= -128.198519968343  delta_E= -3.13e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14460801e+03 2.27310669e+02 1.42704677e+03 5.75933261e-01
 5.00344858e+01 1.32702783e+01 1.93017022e+00 2.77087262e+00
 1.32828030e+01 5.99631973e-01]
E = -128.19851996834282
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 1.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60801183        1
[INPUT] 0    0    [1    /1   ]  227.310668664        1
[INPUT] 0    0    [1    /1   ]  1427.04676541        1
[INPUT] 0    0    [1    /1   ]  0.575933261015       1
[INPUT] 0    0    [1    /1   ]  50.0344857623        1
[INPUT] 0    0    [1    /1   ]  13.2702783447        1
[INPUT] 0    0    [1    /1   ]  1.93017022368        1
[INPUT] 1    0    [1    /1   ]  2.7708726225         1
[INPUT] 1    0    [1    /1   ]  13.2828029969        1
[INPUT] 1    0    [1    /1   ]  0.599631973028       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6080118271216, 1.0]], [0, [227.31066866447142, 1.0]], [0, [1427.0467654116721, 1.0]], [0, [0.5759332610149711, 1.0]], [0, [50.03448576229937, 1.0]], [0, [13.270278344687728, 1.0]], [0, [1.9301702236764704, 1.0]], [1, [2.7708726225043496, 1.0]], [1, [13.282802996928648, 1.0]], [1, [0.5996319730277032, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60801183]
bas 1, expnt(s) = [227.31066866]
bas 2, expnt(s) = [1427.04676541]
bas 3, expnt(s) = [0.57593326]
bas 4, expnt(s) = [50.03448576]
bas 5, expnt(s) = [13.27027834]
bas 6, expnt(s) = [1.93017022]
bas 7, expnt(s) = [2.77087262]
bas 8, expnt(s) = [13.282803]
bas 9, expnt(s) = [0.59963197]
CPU time:       123.57
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460801e+03 7.96206956e+02 2.27310669e+02 1.47903990e+02
 1.42704677e+03 5.86602188e+02 5.75933261e-01 1.67029871e+00
 5.00344858e+01 4.75299223e+01 1.32702783e+01 1.75660878e+01
 1.93017022e+00 4.13724970e+00 2.77087262e+00 1.04292984e+01
 1.32828030e+01 7.39769730e+01 5.99631973e-01 1.53936061e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96578577419228
cond(S) = 160.0404173100415
E1 = -183.13693164924467  E_coul = 55.01140359245264
init E= -128.125528056792
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742882038081882  LUMO = 2.65188243258164
  mo_energy =
[-3.25138065e+01 -1.85362554e+00 -7.42882038e-01 -7.42882038e-01
 -7.42882038e-01  2.65188243e+00  2.65188243e+00  2.65188243e+00
  2.77094728e+00  1.98856324e+01  1.98856324e+01  1.98856324e+01
  4.55570306e+01  3.35231205e+02  2.02579133e+03  7.31766835e+03]
E1 = -182.13045515139095  E_coul = 53.93388018348165
cycle= 1 E= -128.196574967909  delta_E= -0.071  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260808
diis-c [-0.06802077  1.        ]
  HOMO = -0.808000361041121  LUMO = 2.59774499216203
  mo_energy =
[-3.27875977e+01 -1.92110664e+00 -8.08000361e-01 -8.08000361e-01
 -8.08000361e-01  2.59774499e+00  2.59774499e+00  2.59774499e+00
  2.71668701e+00  1.96949326e+01  1.96949326e+01  1.96949326e+01
  4.53210107e+01  3.34920442e+02  2.02543223e+03  7.31728501e+03]
E1 = -182.59387944700813  E_coul = 54.39566615189982
cycle= 2 E= -128.198213295108  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102119
diis-c [-4.05501825e-04  2.77983730e-01  7.22016270e-01]
  HOMO = -0.785192302576502  LUMO = 2.61836265920881
  mo_energy =
[-3.27127059e+01 -1.89743677e+00 -7.85192303e-01 -7.85192303e-01
 -7.85192303e-01  2.61836266e+00  2.61836266e+00  2.61836266e+00
  2.73693884e+00  1.97511161e+01  1.97511161e+01  1.97511161e+01
  4.53873300e+01  3.35002372e+02  2.02551954e+03  7.31737382e+03]
E1 = -182.46131946011104  E_coul = 54.2627995247135
cycle= 3 E= -128.198519935398  delta_E= -0.000307  |g|= 0.000688  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000866715
diis-c [-7.77814262e-08 -3.89922324e-03 -1.96752913e-03  1.00586675e+00]
  HOMO = -0.785419558322307  LUMO = 2.61819166698899
  mo_energy =
[-3.27133553e+01 -1.89773455e+00 -7.85419558e-01 -7.85419558e-01
 -7.85419558e-01  2.61819167e+00  2.61819167e+00  2.61819167e+00
  2.73670444e+00  1.97506090e+01  1.97506090e+01  1.97506090e+01
  4.53867188e+01  3.35001883e+02  2.02551919e+03  7.31737350e+03]
E1 = -182.46257386647838  E_coul = 54.26405389843801
cycle= 4 E= -128.19851996804  delta_E= -3.26e-08  |g|= 5.14e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.15777e-05
diis-c [-2.12436918e-10  5.04750413e-04 -8.36068425e-04 -1.70437980e-01
  1.17076930e+00]
  HOMO = -0.785404959266946  LUMO = 2.61820427901334
  mo_energy =
[-3.27133176e+01 -1.89773206e+00 -7.85404959e-01 -7.85404959e-01
 -7.85404959e-01  2.61820428e+00  2.61820428e+00  2.61820428e+00
  2.73670579e+00  1.97506380e+01  1.97506380e+01  1.97506380e+01
  4.53867494e+01  3.35001935e+02  2.02551926e+03  7.31737357e+03]
E1 = -182.4625106306185  E_coul = 54.26399066227601
cycle= 5 E= -128.198519968343  delta_E= -3.02e-10  |g|= 1.54e-06  |ddm|= 2.61e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4625106306185  E_coul = 54.26399066227601
  HOMO = -0.785404900497899  LUMO = 2.61820434677182
  mo_energy =
[-3.27133176e+01 -1.89773238e+00 -7.85404900e-01 -7.85404900e-01
 -7.85404900e-01  2.61820435e+00  2.61820435e+00  2.61820435e+00
  2.73670551e+00  1.97506381e+01  1.97506381e+01  1.97506381e+01
  4.53867493e+01  3.35001935e+02  2.02551926e+03  7.31737358e+03]
E1 = -182.46251061711388  E_coul = 54.263990648771056
Extra cycle  E= -128.198519968343  delta_E= -3.13e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.0404173100415
E1 = -182.46251061711388  E_coul = 54.263990648771056
init E= -128.198519968343
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785404886354028  LUMO = 2.61820435797977
  mo_energy =
[-3.27133176e+01 -1.89773244e+00 -7.85404886e-01 -7.85404886e-01
 -7.85404886e-01  2.61820436e+00  2.61820436e+00  2.61820436e+00
  2.73670546e+00  1.97506381e+01  1.97506381e+01  1.97506381e+01
  4.53867493e+01  3.35001936e+02  2.02551926e+03  7.31737358e+03]
E1 = -182.46251062913046  E_coul = 54.26399066078763
cycle= 1 E= -128.198519968343  delta_E= -2.84e-14  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46251062913046  E_coul = 54.26399066078763
  HOMO = -0.785404882663002  LUMO = 2.61820436104846
  mo_energy =
[-3.27133176e+01 -1.89773245e+00 -7.85404883e-01 -7.85404883e-01
 -7.85404883e-01  2.61820436e+00  2.61820436e+00  2.61820436e+00
  2.73670545e+00  1.97506381e+01  1.97506381e+01  1.97506381e+01
  4.53867493e+01  3.35001936e+02  2.02551926e+03  7.31737358e+03]
E1 = -182.4625106262239  E_coul = 54.26399065788105
Extra cycle  E= -128.198519968343  delta_E=    0  |g|= 9.35e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14460801e+03 2.27310669e+02 1.42704677e+03 5.75933261e-01
 5.00344858e+01 1.32702783e+01 1.93017022e+00 2.77087262e+00
 1.32828030e+01 5.99631973e-01]
grad_E = [-9.92028377e-06  3.12997872e-06  3.38717653e-05 -2.90061957e-06
  8.48238435e-06 -2.40908580e-06  1.57281661e-06 -1.20763328e-05
 -1.99818868e-04  1.26106627e-07]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60659727        1
[INPUT] 0    0    [1    /1   ]  227.265648308        1
[INPUT] 0    0    [1    /1   ]  1427.0553371         1
[INPUT] 0    0    [1    /1   ]  0.575936372573       1
[INPUT] 0    0    [1    /1   ]  50.0304271473        1
[INPUT] 0    0    [1    /1   ]  13.2699771873        1
[INPUT] 0    0    [1    /1   ]  1.9301885128         1
[INPUT] 1    0    [1    /1   ]  2.77139313903        1
[INPUT] 1    0    [1    /1   ]  13.2861597412        1
[INPUT] 1    0    [1    /1   ]  0.599711384059       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6065972713563, 1.0]], [0, [227.26564830768228, 1.0]], [0, [1427.0553370970126, 1.0]], [0, [0.575936372573137, 1.0]], [0, [50.030427147348675, 1.0]], [0, [13.269977187314788, 1.0]], [0, [1.9301885127967342, 1.0]], [1, [2.7713931390260704, 1.0]], [1, [13.286159741177356, 1.0]], [1, [0.5997113840590053, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60659727]
bas 1, expnt(s) = [227.26564831]
bas 2, expnt(s) = [1427.0553371]
bas 3, expnt(s) = [0.57593637]
bas 4, expnt(s) = [50.03042715]
bas 5, expnt(s) = [13.26997719]
bas 6, expnt(s) = [1.93018851]
bas 7, expnt(s) = [2.77139314]
bas 8, expnt(s) = [13.28615974]
bas 9, expnt(s) = [0.59971138]
CPU time:       126.13
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460660e+03 7.96206562e+02 2.27265648e+02 1.47882019e+02
 1.42705534e+03 5.86604830e+02 5.75936373e-01 1.67030547e+00
 5.00304271e+01 4.75270307e+01 1.32699772e+01 1.75657888e+01
 1.93018851e+00 4.13727910e+00 2.77139314e+00 1.04317475e+01
 1.32861597e+01 7.40003425e+01 5.99711384e-01 1.53961544e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965769414616123
cond(S) = 160.02773228892036
E1 = -183.136940048717  E_coul = 55.011416261769966
init E= -128.125523786947
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742882611640824  LUMO = 2.65238389003943
  mo_energy =
[-3.25137966e+01 -1.85362620e+00 -7.42882612e-01 -7.42882612e-01
 -7.42882612e-01  2.65238389e+00  2.65238389e+00  2.65238389e+00
  2.77097387e+00  1.98910064e+01  1.98910064e+01  1.98910064e+01
  4.55544216e+01  3.35180202e+02  2.02564590e+03  7.31751047e+03]
E1 = -182.13091056352377  E_coul = 53.93433369409918
cycle= 1 E= -128.196576869425  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260734
diis-c [-0.06798207  1.        ]
  HOMO = -0.807968309311523  LUMO = 2.59826632358743
  mo_energy =
[-3.27875046e+01 -1.92106906e+00 -8.07968309e-01 -8.07968309e-01
 -8.07968309e-01  2.59826632e+00  2.59826632e+00  2.59826632e+00
  2.71674772e+00  1.97003524e+01  1.97003524e+01  1.97003524e+01
  4.53184818e+01  3.34869530e+02  2.02528688e+03  7.31712722e+03]
E1 = -182.5941413519219  E_coul = 54.39592729047327
cycle= 2 E= -128.198214061449  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102075
diis-c [-4.05584574e-04  2.77951074e-01  7.22048926e-01]
  HOMO = -0.785169058690666  LUMO = 2.6188794221569
  mo_energy =
[-3.27126392e+01 -1.89740850e+00 -7.85169059e-01 -7.85169059e-01
 -7.85169059e-01  2.61887942e+00  2.61887942e+00  2.61887942e+00
  2.73699166e+00  1.97565206e+01  1.97565206e+01  1.97565206e+01
  4.53847765e+01  3.34951431e+02  2.02537417e+03  7.31721599e+03]
E1 = -182.46164050423306  E_coul = 54.26312007017082
cycle= 3 E= -128.198520434062  delta_E= -0.000306  |g|= 0.000689  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000868555
diis-c [-7.74867071e-08 -3.89609717e-03 -1.93511218e-03  1.00583121e+00]
  HOMO = -0.78539679856284  LUMO = 2.61870794213268
  mo_energy =
[-3.27132900e+01 -1.89770664e+00 -7.85396799e-01 -7.85396799e-01
 -7.85396799e-01  2.61870794e+00  2.61870794e+00  2.61870794e+00
  2.73675695e+00  1.97560123e+01  1.97560123e+01  1.97560123e+01
  4.53841640e+01  3.34950941e+02  2.02537381e+03  7.31721567e+03]
E1 = -182.46289740038628  E_coul = 54.26437693360667
cycle= 4 E= -128.19852046678  delta_E= -3.27e-08  |g|= 5.13e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.14197e-05
diis-c [-2.12056858e-10  5.04337495e-04 -8.39446478e-04 -1.70337858e-01
  1.17067297e+00]
  HOMO = -0.785382224857226  LUMO = 2.61872053506436
  mo_energy =
[-3.27132525e+01 -1.89770414e+00 -7.85382225e-01 -7.85382225e-01
 -7.85382225e-01  2.61872054e+00  2.61872054e+00  2.61872054e+00
  2.73675830e+00  1.97560413e+01  1.97560413e+01  1.97560413e+01
  4.53841946e+01  3.34950993e+02  2.02537388e+03  7.31721575e+03]
E1 = -182.4628342755917  E_coul = 54.2643138085114
cycle= 5 E= -128.19852046708  delta_E= -3.01e-10  |g|= 1.54e-06  |ddm|= 2.61e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4628342755917  E_coul = 54.2643138085114
  HOMO = -0.785382165896453  LUMO = 2.61872060292921
  mo_energy =
[-3.27132524e+01 -1.89770446e+00 -7.85382166e-01 -7.85382166e-01
 -7.85382166e-01  2.61872060e+00  2.61872060e+00  2.61872060e+00
  2.73675803e+00  1.97560413e+01  1.97560413e+01  1.97560413e+01
  4.53841945e+01  3.34950993e+02  2.02537388e+03  7.31721575e+03]
E1 = -182.4628342616895  E_coul = 54.2643137946087
Extra cycle  E= -128.198520467081  delta_E= -5.12e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14460660e+03 2.27265648e+02 1.42705534e+03 5.75936373e-01
 5.00304271e+01 1.32699772e+01 1.93018851e+00 2.77139314e+00
 1.32861597e+01 5.99711384e-01]
E = -128.1985204670808
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60659727        1
[INPUT] 0    0    [1    /1   ]  227.265648308        1
[INPUT] 0    0    [1    /1   ]  1427.0553371         1
[INPUT] 0    0    [1    /1   ]  0.575936372573       1
[INPUT] 0    0    [1    /1   ]  50.0304271473        1
[INPUT] 0    0    [1    /1   ]  13.2699771873        1
[INPUT] 0    0    [1    /1   ]  1.9301885128         1
[INPUT] 1    0    [1    /1   ]  2.77139313903        1
[INPUT] 1    0    [1    /1   ]  13.2861597412        1
[INPUT] 1    0    [1    /1   ]  0.599711384059       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6065972713563, 1.0]], [0, [227.26564830768228, 1.0]], [0, [1427.0553370970126, 1.0]], [0, [0.575936372573137, 1.0]], [0, [50.030427147348675, 1.0]], [0, [13.269977187314788, 1.0]], [0, [1.9301885127967342, 1.0]], [1, [2.7713931390260704, 1.0]], [1, [13.286159741177356, 1.0]], [1, [0.5997113840590053, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60659727]
bas 1, expnt(s) = [227.26564831]
bas 2, expnt(s) = [1427.0553371]
bas 3, expnt(s) = [0.57593637]
bas 4, expnt(s) = [50.03042715]
bas 5, expnt(s) = [13.26997719]
bas 6, expnt(s) = [1.93018851]
bas 7, expnt(s) = [2.77139314]
bas 8, expnt(s) = [13.28615974]
bas 9, expnt(s) = [0.59971138]
CPU time:       126.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460660e+03 7.96206562e+02 2.27265648e+02 1.47882019e+02
 1.42705534e+03 5.86604830e+02 5.75936373e-01 1.67030547e+00
 5.00304271e+01 4.75270307e+01 1.32699772e+01 1.75657888e+01
 1.93018851e+00 4.13727910e+00 2.77139314e+00 1.04317475e+01
 1.32861597e+01 7.40003425e+01 5.99711384e-01 1.53961544e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965769414616123
cond(S) = 160.02773228892036
E1 = -183.136940048717  E_coul = 55.011416261769966
init E= -128.125523786947
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742882611640824  LUMO = 2.65238389003943
  mo_energy =
[-3.25137966e+01 -1.85362620e+00 -7.42882612e-01 -7.42882612e-01
 -7.42882612e-01  2.65238389e+00  2.65238389e+00  2.65238389e+00
  2.77097387e+00  1.98910064e+01  1.98910064e+01  1.98910064e+01
  4.55544216e+01  3.35180202e+02  2.02564590e+03  7.31751047e+03]
E1 = -182.13091056352377  E_coul = 53.93433369409918
cycle= 1 E= -128.196576869425  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260734
diis-c [-0.06798207  1.        ]
  HOMO = -0.807968309311523  LUMO = 2.59826632358743
  mo_energy =
[-3.27875046e+01 -1.92106906e+00 -8.07968309e-01 -8.07968309e-01
 -8.07968309e-01  2.59826632e+00  2.59826632e+00  2.59826632e+00
  2.71674772e+00  1.97003524e+01  1.97003524e+01  1.97003524e+01
  4.53184818e+01  3.34869530e+02  2.02528688e+03  7.31712722e+03]
E1 = -182.5941413519219  E_coul = 54.39592729047327
cycle= 2 E= -128.198214061449  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102075
diis-c [-4.05584574e-04  2.77951074e-01  7.22048926e-01]
  HOMO = -0.785169058690666  LUMO = 2.6188794221569
  mo_energy =
[-3.27126392e+01 -1.89740850e+00 -7.85169059e-01 -7.85169059e-01
 -7.85169059e-01  2.61887942e+00  2.61887942e+00  2.61887942e+00
  2.73699166e+00  1.97565206e+01  1.97565206e+01  1.97565206e+01
  4.53847765e+01  3.34951431e+02  2.02537417e+03  7.31721599e+03]
E1 = -182.46164050423306  E_coul = 54.26312007017082
cycle= 3 E= -128.198520434062  delta_E= -0.000306  |g|= 0.000689  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000868555
diis-c [-7.74867071e-08 -3.89609717e-03 -1.93511218e-03  1.00583121e+00]
  HOMO = -0.78539679856284  LUMO = 2.61870794213268
  mo_energy =
[-3.27132900e+01 -1.89770664e+00 -7.85396799e-01 -7.85396799e-01
 -7.85396799e-01  2.61870794e+00  2.61870794e+00  2.61870794e+00
  2.73675695e+00  1.97560123e+01  1.97560123e+01  1.97560123e+01
  4.53841640e+01  3.34950941e+02  2.02537381e+03  7.31721567e+03]
E1 = -182.46289740038628  E_coul = 54.26437693360667
cycle= 4 E= -128.19852046678  delta_E= -3.27e-08  |g|= 5.13e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.14197e-05
diis-c [-2.12056858e-10  5.04337495e-04 -8.39446478e-04 -1.70337858e-01
  1.17067297e+00]
  HOMO = -0.785382224857226  LUMO = 2.61872053506436
  mo_energy =
[-3.27132525e+01 -1.89770414e+00 -7.85382225e-01 -7.85382225e-01
 -7.85382225e-01  2.61872054e+00  2.61872054e+00  2.61872054e+00
  2.73675830e+00  1.97560413e+01  1.97560413e+01  1.97560413e+01
  4.53841946e+01  3.34950993e+02  2.02537388e+03  7.31721575e+03]
E1 = -182.4628342755917  E_coul = 54.2643138085114
cycle= 5 E= -128.19852046708  delta_E= -3.01e-10  |g|= 1.54e-06  |ddm|= 2.61e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4628342755917  E_coul = 54.2643138085114
  HOMO = -0.785382165896453  LUMO = 2.61872060292921
  mo_energy =
[-3.27132524e+01 -1.89770446e+00 -7.85382166e-01 -7.85382166e-01
 -7.85382166e-01  2.61872060e+00  2.61872060e+00  2.61872060e+00
  2.73675803e+00  1.97560413e+01  1.97560413e+01  1.97560413e+01
  4.53841945e+01  3.34950993e+02  2.02537388e+03  7.31721575e+03]
E1 = -182.4628342616895  E_coul = 54.2643137946087
Extra cycle  E= -128.198520467081  delta_E= -5.12e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.02773228892036
E1 = -182.4628342616895  E_coul = 54.2643137946087
init E= -128.198520467081
    CPU time for initialize scf      0.06 sec, wall time      0.06 sec
  HOMO = -0.785382151775684  LUMO = 2.61872061411914
  mo_energy =
[-3.27132524e+01 -1.89770451e+00 -7.85382152e-01 -7.85382152e-01
 -7.85382152e-01  2.61872061e+00  2.61872061e+00  2.61872061e+00
  2.73675797e+00  1.97560413e+01  1.97560413e+01  1.97560413e+01
  4.53841945e+01  3.34950993e+02  2.02537388e+03  7.31721575e+03]
E1 = -182.46283427391  E_coul = 54.26431380682923
cycle= 1 E= -128.198520467081  delta_E= 2.84e-14  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46283427391  E_coul = 54.26431380682923
  HOMO = -0.785382148070317  LUMO = 2.61872061720145
  mo_energy =
[-3.27132524e+01 -1.89770452e+00 -7.85382148e-01 -7.85382148e-01
 -7.85382148e-01  2.61872062e+00  2.61872062e+00  2.61872062e+00
  2.73675797e+00  1.97560413e+01  1.97560413e+01  1.97560413e+01
  4.53841945e+01  3.34950993e+02  2.02537388e+03  7.31721575e+03]
E1 = -182.46283427092948  E_coul = 54.26431380384874
Extra cycle  E= -128.198520467081  delta_E= 2.84e-14  |g|= 9.35e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.14460660e+03 2.27265648e+02 1.42705534e+03 5.75936373e-01
 5.00304271e+01 1.32699772e+01 1.93018851e+00 2.77139314e+00
 1.32861597e+01 5.99711384e-01]
grad_E = [-9.91204840e-06  1.64421350e-06  3.39174436e-05  2.02700052e-06
  1.27127186e-05 -1.04548966e-06  1.76388581e-06  1.02332493e-05
 -1.89344465e-04  6.76505796e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60501523        1
[INPUT] 0    0    [1    /1   ]  227.211453507        1
[INPUT] 0    0    [1    /1   ]  1427.06523519        1
[INPUT] 0    0    [1    /1   ]  0.57594769238        1
[INPUT] 0    0    [1    /1   ]  50.0258857623        1
[INPUT] 0    0    [1    /1   ]  13.269719705         1
[INPUT] 0    0    [1    /1   ]  1.93024077775        1
[INPUT] 1    0    [1    /1   ]  2.77237723488        1
[INPUT] 1    0    [1    /1   ]  13.2926213576        1
[INPUT] 1    0    [1    /1   ]  0.599860350304       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.605015234539, 1.0]], [0, [227.2114535073601, 1.0]], [0, [1427.0652351871036, 1.0]], [0, [0.5759476923795976, 1.0]], [0, [50.02588576228284, 1.0]], [0, [13.269719705007663, 1.0]], [0, [1.9302407777518173, 1.0]], [1, [2.7723772348797735, 1.0]], [1, [13.292621357553015, 1.0]], [1, [0.5998603503036408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60501523]
bas 1, expnt(s) = [227.21145351]
bas 2, expnt(s) = [1427.06523519]
bas 3, expnt(s) = [0.57594769]
bas 4, expnt(s) = [50.02588576]
bas 5, expnt(s) = [13.26971971]
bas 6, expnt(s) = [1.93024078]
bas 7, expnt(s) = [2.77237723]
bas 8, expnt(s) = [13.29262136]
bas 9, expnt(s) = [0.59986035]
CPU time:       129.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460502e+03 7.96206121e+02 2.27211454e+02 1.47855570e+02
 1.42706524e+03 5.86607882e+02 5.75947692e-01 1.67033010e+00
 5.00258858e+01 4.75237951e+01 1.32697197e+01 1.75655332e+01
 1.93024078e+00 4.13736312e+00 2.77237723e+00 1.04363779e+01
 1.32926214e+01 7.40453320e+01 5.99860350e-01 1.54009350e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965738483699294
cond(S) = 160.01266802519228
E1 = -183.13695282281063  E_coul = 55.01143948584283
init E= -128.125513336968
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742883897410856  LUMO = 2.65332641432878
  mo_energy =
[-3.25137777e+01 -1.85362737e+00 -7.42883897e-01 -7.42883897e-01
 -7.42883897e-01  2.65332641e+00  2.65332641e+00  2.65332641e+00
  2.77107180e+00  1.99012846e+01  1.99012846e+01  1.99012846e+01
  4.55518823e+01  3.35120337e+02  2.02547229e+03  7.31732129e+03]
E1 = -182.13176533305665  E_coul = 53.93518494633502
cycle= 1 E= -128.196580386722  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260591
diis-c [-0.06790743  1.        ]
  HOMO = -0.807908135461103  LUMO = 2.59924631229336
  mo_energy =
[-3.27873300e+01 -1.92099842e+00 -8.07908135e-01 -8.07908135e-01
 -8.07908135e-01  2.59924631e+00  2.59924631e+00  2.59924631e+00
  2.71690869e+00  1.97107158e+01  1.97107158e+01  1.97107158e+01
  4.53160897e+01  3.34809831e+02  2.02511343e+03  7.31693819e+03]
E1 = -182.5946322060542  E_coul = 54.39641675899073
cycle= 2 E= -128.198215447063  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101993
diis-c [-4.05618350e-04  2.77893036e-01  7.22106964e-01]
  HOMO = -0.78512556012396  LUMO = 2.6198507225318
  mo_energy =
[-3.27125146e+01 -1.89735549e+00 -7.85125560e-01 -7.85125560e-01
 -7.85125560e-01  2.61985072e+00  2.61985072e+00  2.61985072e+00
  2.73713799e+00  1.97668551e+01  1.97668551e+01  1.97668551e+01
  4.53823385e+01  3.34891678e+02  2.02520066e+03  7.31702691e+03]
E1 = -182.4622432930563  E_coul = 54.26372197656968
cycle= 3 E= -128.198521316487  delta_E= -0.000306  |g|= 0.00069  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000871563
diis-c [-7.69441817e-08 -3.89112597e-03 -1.88145000e-03  1.00577258e+00]
  HOMO = -0.785354096300916  LUMO = 2.61967842812931
  mo_energy =
[-3.27131677e+01 -1.89765417e+00 -7.85354096e-01 -7.85354096e-01
 -7.85354096e-01  2.61967843e+00  2.61967843e+00  2.61967843e+00
  2.73690277e+00  1.97663449e+01  1.97663449e+01  1.97663449e+01
  4.53817240e+01  3.34891185e+02  2.02520030e+03  7.31702659e+03]
E1 = -182.4635042213287  E_coul = 54.26498287200915
cycle= 4 E= -128.19852134932  delta_E= -3.28e-08  |g|= 5.11e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.11305e-05
diis-c [-2.11355199e-10  5.03670519e-04 -8.44762700e-04 -1.70153883e-01
  1.17049498e+00]
  HOMO = -0.785339568711751  LUMO = 2.61969098632408
  mo_energy =
[-3.27131303e+01 -1.89765167e+00 -7.85339569e-01 -7.85339569e-01
 -7.85339569e-01  2.61969099e+00  2.61969099e+00  2.61969099e+00
  2.73690413e+00  1.97663738e+01  1.97663738e+01  1.97663738e+01
  4.53817544e+01  3.34891237e+02  2.02520037e+03  7.31702666e+03]
E1 = -182.46344129832968  E_coul = 54.264919948711935
cycle= 5 E= -128.198521349618  delta_E= -2.98e-10  |g|= 1.54e-06  |ddm|= 2.59e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46344129832968  E_coul = 54.264919948711935
  HOMO = -0.785339509499901  LUMO = 2.61969105431339
  mo_energy =
[-3.27131302e+01 -1.89765199e+00 -7.85339509e-01 -7.85339509e-01
 -7.85339509e-01  2.61969105e+00  2.61969105e+00  2.61969105e+00
  2.73690386e+00  1.97663738e+01  1.97663738e+01  1.97663738e+01
  4.53817544e+01  3.34891237e+02  2.02520037e+03  7.31702667e+03]
E1 = -182.46344128414816  E_coul = 54.26491993453027
Extra cycle  E= -128.198521349618  delta_E= -1.42e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14460502e+03 2.27211454e+02 1.42706524e+03 5.75947692e-01
 5.00258858e+01 1.32697197e+01 1.93024078e+00 2.77237723e+00
 1.32926214e+01 5.99860350e-01]
E = -128.1985213496179
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60501523        1
[INPUT] 0    0    [1    /1   ]  227.211453507        1
[INPUT] 0    0    [1    /1   ]  1427.06523519        1
[INPUT] 0    0    [1    /1   ]  0.57594769238        1
[INPUT] 0    0    [1    /1   ]  50.0258857623        1
[INPUT] 0    0    [1    /1   ]  13.269719705         1
[INPUT] 0    0    [1    /1   ]  1.93024077775        1
[INPUT] 1    0    [1    /1   ]  2.77237723488        1
[INPUT] 1    0    [1    /1   ]  13.2926213576        1
[INPUT] 1    0    [1    /1   ]  0.599860350304       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.605015234539, 1.0]], [0, [227.2114535073601, 1.0]], [0, [1427.0652351871036, 1.0]], [0, [0.5759476923795976, 1.0]], [0, [50.02588576228284, 1.0]], [0, [13.269719705007663, 1.0]], [0, [1.9302407777518173, 1.0]], [1, [2.7723772348797735, 1.0]], [1, [13.292621357553015, 1.0]], [1, [0.5998603503036408, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60501523]
bas 1, expnt(s) = [227.21145351]
bas 2, expnt(s) = [1427.06523519]
bas 3, expnt(s) = [0.57594769]
bas 4, expnt(s) = [50.02588576]
bas 5, expnt(s) = [13.26971971]
bas 6, expnt(s) = [1.93024078]
bas 7, expnt(s) = [2.77237723]
bas 8, expnt(s) = [13.29262136]
bas 9, expnt(s) = [0.59986035]
CPU time:       130.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460502e+03 7.96206121e+02 2.27211454e+02 1.47855570e+02
 1.42706524e+03 5.86607882e+02 5.75947692e-01 1.67033010e+00
 5.00258858e+01 4.75237951e+01 1.32697197e+01 1.75655332e+01
 1.93024078e+00 4.13736312e+00 2.77237723e+00 1.04363779e+01
 1.32926214e+01 7.40453320e+01 5.99860350e-01 1.54009350e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965738483699294
cond(S) = 160.01266802519228
E1 = -183.13695282281063  E_coul = 55.01143948584283
init E= -128.125513336968
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742883897410856  LUMO = 2.65332641432878
  mo_energy =
[-3.25137777e+01 -1.85362737e+00 -7.42883897e-01 -7.42883897e-01
 -7.42883897e-01  2.65332641e+00  2.65332641e+00  2.65332641e+00
  2.77107180e+00  1.99012846e+01  1.99012846e+01  1.99012846e+01
  4.55518823e+01  3.35120337e+02  2.02547229e+03  7.31732129e+03]
E1 = -182.13176533305665  E_coul = 53.93518494633502
cycle= 1 E= -128.196580386722  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260591
diis-c [-0.06790743  1.        ]
  HOMO = -0.807908135461103  LUMO = 2.59924631229336
  mo_energy =
[-3.27873300e+01 -1.92099842e+00 -8.07908135e-01 -8.07908135e-01
 -8.07908135e-01  2.59924631e+00  2.59924631e+00  2.59924631e+00
  2.71690869e+00  1.97107158e+01  1.97107158e+01  1.97107158e+01
  4.53160897e+01  3.34809831e+02  2.02511343e+03  7.31693819e+03]
E1 = -182.5946322060542  E_coul = 54.39641675899073
cycle= 2 E= -128.198215447063  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101993
diis-c [-4.05618350e-04  2.77893036e-01  7.22106964e-01]
  HOMO = -0.78512556012396  LUMO = 2.6198507225318
  mo_energy =
[-3.27125146e+01 -1.89735549e+00 -7.85125560e-01 -7.85125560e-01
 -7.85125560e-01  2.61985072e+00  2.61985072e+00  2.61985072e+00
  2.73713799e+00  1.97668551e+01  1.97668551e+01  1.97668551e+01
  4.53823385e+01  3.34891678e+02  2.02520066e+03  7.31702691e+03]
E1 = -182.4622432930563  E_coul = 54.26372197656968
cycle= 3 E= -128.198521316487  delta_E= -0.000306  |g|= 0.00069  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000871563
diis-c [-7.69441817e-08 -3.89112597e-03 -1.88145000e-03  1.00577258e+00]
  HOMO = -0.785354096300916  LUMO = 2.61967842812931
  mo_energy =
[-3.27131677e+01 -1.89765417e+00 -7.85354096e-01 -7.85354096e-01
 -7.85354096e-01  2.61967843e+00  2.61967843e+00  2.61967843e+00
  2.73690277e+00  1.97663449e+01  1.97663449e+01  1.97663449e+01
  4.53817240e+01  3.34891185e+02  2.02520030e+03  7.31702659e+03]
E1 = -182.4635042213287  E_coul = 54.26498287200915
cycle= 4 E= -128.19852134932  delta_E= -3.28e-08  |g|= 5.11e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.11305e-05
diis-c [-2.11355199e-10  5.03670519e-04 -8.44762700e-04 -1.70153883e-01
  1.17049498e+00]
  HOMO = -0.785339568711751  LUMO = 2.61969098632408
  mo_energy =
[-3.27131303e+01 -1.89765167e+00 -7.85339569e-01 -7.85339569e-01
 -7.85339569e-01  2.61969099e+00  2.61969099e+00  2.61969099e+00
  2.73690413e+00  1.97663738e+01  1.97663738e+01  1.97663738e+01
  4.53817544e+01  3.34891237e+02  2.02520037e+03  7.31702666e+03]
E1 = -182.46344129832968  E_coul = 54.264919948711935
cycle= 5 E= -128.198521349618  delta_E= -2.98e-10  |g|= 1.54e-06  |ddm|= 2.59e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46344129832968  E_coul = 54.264919948711935
  HOMO = -0.785339509499901  LUMO = 2.61969105431339
  mo_energy =
[-3.27131302e+01 -1.89765199e+00 -7.85339509e-01 -7.85339509e-01
 -7.85339509e-01  2.61969105e+00  2.61969105e+00  2.61969105e+00
  2.73690386e+00  1.97663738e+01  1.97663738e+01  1.97663738e+01
  4.53817544e+01  3.34891237e+02  2.02520037e+03  7.31702667e+03]
E1 = -182.46344128414816  E_coul = 54.26491993453027
Extra cycle  E= -128.198521349618  delta_E= -1.42e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.01266802519228
E1 = -182.46344128414816  E_coul = 54.26491993453027
init E= -128.198521349618
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785339495391824  LUMO = 2.61969106549735
  mo_energy =
[-3.27131302e+01 -1.89765204e+00 -7.85339495e-01 -7.85339495e-01
 -7.85339495e-01  2.61969107e+00  2.61969107e+00  2.61969107e+00
  2.73690381e+00  1.97663738e+01  1.97663738e+01  1.97663738e+01
  4.53817544e+01  3.34891237e+02  2.02520037e+03  7.31702667e+03]
E1 = -182.46344129656197  E_coul = 54.26491994694379
cycle= 1 E= -128.198521349618  delta_E= -2.84e-13  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46344129656197  E_coul = 54.26491994694379
  HOMO = -0.785339491672736  LUMO = 2.61969106859335
  mo_energy =
[-3.27131302e+01 -1.89765205e+00 -7.85339492e-01 -7.85339492e-01
 -7.85339492e-01  2.61969107e+00  2.61969107e+00  2.61969107e+00
  2.73690380e+00  1.97663738e+01  1.97663738e+01  1.97663738e+01
  4.53817544e+01  3.34891237e+02  2.02520037e+03  7.31702667e+03]
E1 = -182.4634412935171  E_coul = 54.26491994389905
Extra cycle  E= -128.198521349618  delta_E= 1.42e-13  |g|= 9.35e-09  |ddm|= 2.86e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14460502e+03 2.27211454e+02 1.42706524e+03 5.75947692e-01
 5.00258858e+01 1.32697197e+01 1.93024078e+00 2.77237723e+00
 1.32926214e+01 5.99860350e-01]
grad_E = [-9.90202350e-06 -2.13607032e-07  3.39732429e-05  9.48164827e-06
  1.80916911e-05  1.43119352e-06  1.73545610e-06  4.54690513e-05
 -1.68087879e-04  1.70551656e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60374297        1
[INPUT] 0    0    [1    /1   ]  227.157242325        1
[INPUT] 0    0    [1    /1   ]  1427.07405726        1
[INPUT] 0    0    [1    /1   ]  0.575976680925       1
[INPUT] 0    0    [1    /1   ]  50.0221604832        1
[INPUT] 0    0    [1    /1   ]  13.2697032102        1
[INPUT] 0    0    [1    /1   ]  1.93036557465        1
[INPUT] 1    0    [1    /1   ]  2.7742674753         1
[INPUT] 1    0    [1    /1   ]  13.3052960987        1
[INPUT] 1    0    [1    /1   ]  0.60014380532        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.603742965263, 1.0]], [0, [227.1572423245251, 1.0]], [0, [1427.0740572614081, 1.0]], [0, [0.5759766809251763, 1.0]], [0, [50.02216048320313, 1.0]], [0, [13.269703210161266, 1.0]], [0, [1.9303655746502524, 1.0]], [1, [2.7742674752974024, 1.0]], [1, [13.305296098657108, 1.0]], [1, [0.6001438053204733, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60374297]
bas 1, expnt(s) = [227.15724232]
bas 2, expnt(s) = [1427.07405726]
bas 3, expnt(s) = [0.57597668]
bas 4, expnt(s) = [50.02216048]
bas 5, expnt(s) = [13.26970321]
bas 6, expnt(s) = [1.93036557]
bas 7, expnt(s) = [2.77426748]
bas 8, expnt(s) = [13.3052961]
bas 9, expnt(s) = [0.60014381]
CPU time:       132.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460374e+03 7.96205767e+02 2.27157242e+02 1.47829111e+02
 1.42707406e+03 5.86610602e+02 5.75976681e-01 1.67039315e+00
 5.00221605e+01 4.75211408e+01 1.32697032e+01 1.75655168e+01
 1.93036557e+00 4.13756374e+00 2.77426748e+00 1.04452732e+01
 1.33052961e+01 7.41335969e+01 6.00143805e-01 1.54100324e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965679203543408
cond(S) = 159.99802750706485
E1 = -183.13697181940802  E_coul = 55.01148247247022
init E= -128.125489346938
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742886758715364  LUMO = 2.65512429374436
  mo_energy =
[-3.25137410e+01 -1.85362959e+00 -7.42886759e-01 -7.42886759e-01
 -7.42886759e-01  2.65512429e+00  2.65512429e+00  2.65512429e+00
  2.77132556e+00  1.99212978e+01  1.99212978e+01  1.99212978e+01
  4.55507522e+01  3.35064063e+02  2.02530201e+03  7.31713396e+03]
E1 = -182.13338882791666  E_coul = 53.93680202756125
cycle= 1 E= -128.196586800355  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260312
diis-c [-0.06776234  1.        ]
  HOMO = -0.807793769552948  LUMO = 2.60111562102135
  mo_energy =
[-3.27869986e+01 -1.92086404e+00 -8.07793770e-01 -8.07793770e-01
 -8.07793770e-01  2.60111562e+00  2.60111562e+00  2.60111562e+00
  2.71728087e+00  1.97308890e+01  1.97308890e+01  1.97308890e+01
  4.53152334e+01  3.34753866e+02  2.02494346e+03  7.31675117e+03]
E1 = -182.59556309368196  E_coul = 54.39734528154974
cycle= 2 E= -128.198217812132  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101836
diis-c [-4.05482335e-04  2.77787811e-01  7.22212189e-01]
  HOMO = -0.785043107676106  LUMO = 2.62170336723737
  mo_energy =
[-3.27122788e+01 -1.89725483e+00 -7.85043108e-01 -7.85043108e-01
 -7.85043108e-01  2.62170337e+00  2.62170337e+00  2.62170337e+00
  2.73748257e+00  1.97869733e+01  1.97869733e+01  1.97869733e+01
  4.53813957e+01  3.34835610e+02  2.02503058e+03  7.31683978e+03]
E1 = -182.463388446566  E_coul = 54.264865721985615
cycle= 3 E= -128.19852272458  delta_E= -0.000305  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000876554
diis-c [-7.59309914e-08 -3.88312151e-03 -1.79106792e-03  1.00567419e+00]
  HOMO = -0.785272973625373  LUMO = 2.62152968977846
  mo_energy =
[-3.27129358e+01 -1.89755437e+00 -7.85272974e-01 -7.85272974e-01
 -7.85272974e-01  2.62152969e+00  2.62152969e+00  2.62152969e+00
  2.73724655e+00  1.97864599e+01  1.97864599e+01  1.97864599e+01
  4.53807779e+01  3.34835112e+02  2.02503022e+03  7.31683945e+03]
E1 = -182.4646559869783  E_coul = 54.26613322938573
cycle= 4 E= -128.198522757593  delta_E= -3.3e-08  |g|= 5.07e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.05912e-05
diis-c [-2.10045778e-10  5.02560260e-04 -8.53176653e-04 -1.69805628e-01
  1.17015624e+00]
  HOMO = -0.785258531551734  LUMO = 2.62154218350647
  mo_energy =
[-3.27128985e+01 -1.89755185e+00 -7.85258532e-01 -7.85258532e-01
 -7.85258532e-01  2.62154218e+00  2.62154218e+00  2.62154218e+00
  2.73724793e+00  1.97864887e+01  1.97864887e+01  1.97864887e+01
  4.53808081e+01  3.34835164e+02  2.02503029e+03  7.31683952e+03]
E1 = -182.46459343761478  E_coul = 54.26607067972844
cycle= 5 E= -128.198522757886  delta_E= -2.94e-10  |g|= 1.54e-06  |ddm|= 2.57e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46459343761478  E_coul = 54.26607067972844
  HOMO = -0.785258472015921  LUMO = 2.62154225163075
  mo_energy =
[-3.27128985e+01 -1.89755217e+00 -7.85258472e-01 -7.85258472e-01
 -7.85258472e-01  2.62154225e+00  2.62154225e+00  2.62154225e+00
  2.73724766e+00  1.97864887e+01  1.97864887e+01  1.97864887e+01
  4.53808081e+01  3.34835164e+02  2.02503029e+03  7.31683953e+03]
E1 = -182.46459342356297  E_coul = 54.26607066567611
Extra cycle  E= -128.198522757887  delta_E= -5.12e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14460374e+03 2.27157242e+02 1.42707406e+03 5.75976681e-01
 5.00221605e+01 1.32697032e+01 1.93036557e+00 2.77426748e+00
 1.33052961e+01 6.00143805e-01]
E = -128.19852275788685
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60374297        1
[INPUT] 0    0    [1    /1   ]  227.157242325        1
[INPUT] 0    0    [1    /1   ]  1427.07405726        1
[INPUT] 0    0    [1    /1   ]  0.575976680925       1
[INPUT] 0    0    [1    /1   ]  50.0221604832        1
[INPUT] 0    0    [1    /1   ]  13.2697032102        1
[INPUT] 0    0    [1    /1   ]  1.93036557465        1
[INPUT] 1    0    [1    /1   ]  2.7742674753         1
[INPUT] 1    0    [1    /1   ]  13.3052960987        1
[INPUT] 1    0    [1    /1   ]  0.60014380532        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.603742965263, 1.0]], [0, [227.1572423245251, 1.0]], [0, [1427.0740572614081, 1.0]], [0, [0.5759766809251763, 1.0]], [0, [50.02216048320313, 1.0]], [0, [13.269703210161266, 1.0]], [0, [1.9303655746502524, 1.0]], [1, [2.7742674752974024, 1.0]], [1, [13.305296098657108, 1.0]], [1, [0.6001438053204733, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60374297]
bas 1, expnt(s) = [227.15724232]
bas 2, expnt(s) = [1427.07405726]
bas 3, expnt(s) = [0.57597668]
bas 4, expnt(s) = [50.02216048]
bas 5, expnt(s) = [13.26970321]
bas 6, expnt(s) = [1.93036557]
bas 7, expnt(s) = [2.77426748]
bas 8, expnt(s) = [13.3052961]
bas 9, expnt(s) = [0.60014381]
CPU time:       133.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460374e+03 7.96205767e+02 2.27157242e+02 1.47829111e+02
 1.42707406e+03 5.86610602e+02 5.75976681e-01 1.67039315e+00
 5.00221605e+01 4.75211408e+01 1.32697032e+01 1.75655168e+01
 1.93036557e+00 4.13756374e+00 2.77426748e+00 1.04452732e+01
 1.33052961e+01 7.41335969e+01 6.00143805e-01 1.54100324e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965679203543408
cond(S) = 159.99802750706485
E1 = -183.13697181940802  E_coul = 55.01148247247022
init E= -128.125489346938
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742886758715364  LUMO = 2.65512429374436
  mo_energy =
[-3.25137410e+01 -1.85362959e+00 -7.42886759e-01 -7.42886759e-01
 -7.42886759e-01  2.65512429e+00  2.65512429e+00  2.65512429e+00
  2.77132556e+00  1.99212978e+01  1.99212978e+01  1.99212978e+01
  4.55507522e+01  3.35064063e+02  2.02530201e+03  7.31713396e+03]
E1 = -182.13338882791666  E_coul = 53.93680202756125
cycle= 1 E= -128.196586800355  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260312
diis-c [-0.06776234  1.        ]
  HOMO = -0.807793769552948  LUMO = 2.60111562102135
  mo_energy =
[-3.27869986e+01 -1.92086404e+00 -8.07793770e-01 -8.07793770e-01
 -8.07793770e-01  2.60111562e+00  2.60111562e+00  2.60111562e+00
  2.71728087e+00  1.97308890e+01  1.97308890e+01  1.97308890e+01
  4.53152334e+01  3.34753866e+02  2.02494346e+03  7.31675117e+03]
E1 = -182.59556309368196  E_coul = 54.39734528154974
cycle= 2 E= -128.198217812132  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101836
diis-c [-4.05482335e-04  2.77787811e-01  7.22212189e-01]
  HOMO = -0.785043107676106  LUMO = 2.62170336723737
  mo_energy =
[-3.27122788e+01 -1.89725483e+00 -7.85043108e-01 -7.85043108e-01
 -7.85043108e-01  2.62170337e+00  2.62170337e+00  2.62170337e+00
  2.73748257e+00  1.97869733e+01  1.97869733e+01  1.97869733e+01
  4.53813957e+01  3.34835610e+02  2.02503058e+03  7.31683978e+03]
E1 = -182.463388446566  E_coul = 54.264865721985615
cycle= 3 E= -128.19852272458  delta_E= -0.000305  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000876554
diis-c [-7.59309914e-08 -3.88312151e-03 -1.79106792e-03  1.00567419e+00]
  HOMO = -0.785272973625373  LUMO = 2.62152968977846
  mo_energy =
[-3.27129358e+01 -1.89755437e+00 -7.85272974e-01 -7.85272974e-01
 -7.85272974e-01  2.62152969e+00  2.62152969e+00  2.62152969e+00
  2.73724655e+00  1.97864599e+01  1.97864599e+01  1.97864599e+01
  4.53807779e+01  3.34835112e+02  2.02503022e+03  7.31683945e+03]
E1 = -182.4646559869783  E_coul = 54.26613322938573
cycle= 4 E= -128.198522757593  delta_E= -3.3e-08  |g|= 5.07e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.05912e-05
diis-c [-2.10045778e-10  5.02560260e-04 -8.53176653e-04 -1.69805628e-01
  1.17015624e+00]
  HOMO = -0.785258531551734  LUMO = 2.62154218350647
  mo_energy =
[-3.27128985e+01 -1.89755185e+00 -7.85258532e-01 -7.85258532e-01
 -7.85258532e-01  2.62154218e+00  2.62154218e+00  2.62154218e+00
  2.73724793e+00  1.97864887e+01  1.97864887e+01  1.97864887e+01
  4.53808081e+01  3.34835164e+02  2.02503029e+03  7.31683952e+03]
E1 = -182.46459343761478  E_coul = 54.26607067972844
cycle= 5 E= -128.198522757886  delta_E= -2.94e-10  |g|= 1.54e-06  |ddm|= 2.57e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46459343761478  E_coul = 54.26607067972844
  HOMO = -0.785258472015921  LUMO = 2.62154225163075
  mo_energy =
[-3.27128985e+01 -1.89755217e+00 -7.85258472e-01 -7.85258472e-01
 -7.85258472e-01  2.62154225e+00  2.62154225e+00  2.62154225e+00
  2.73724766e+00  1.97864887e+01  1.97864887e+01  1.97864887e+01
  4.53808081e+01  3.34835164e+02  2.02503029e+03  7.31683953e+03]
E1 = -182.46459342356297  E_coul = 54.26607066567611
Extra cycle  E= -128.198522757887  delta_E= -5.12e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 159.99802750706485
E1 = -182.46459342356297  E_coul = 54.26607066567611
init E= -128.198522757887
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785258457888306  LUMO = 2.621542262843
  mo_energy =
[-3.27128984e+01 -1.89755222e+00 -7.85258458e-01 -7.85258458e-01
 -7.85258458e-01  2.62154226e+00  2.62154226e+00  2.62154226e+00
  2.73724761e+00  1.97864887e+01  1.97864887e+01  1.97864887e+01
  4.53808081e+01  3.34835164e+02  2.02503029e+03  7.31683953e+03]
E1 = -182.4645934360749  E_coul = 54.266070678188214
cycle= 1 E= -128.198522757887  delta_E= 1.71e-13  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4645934360749  E_coul = 54.266070678188214
  HOMO = -0.78525845416169  LUMO = 2.62154226594833
  mo_energy =
[-3.27128984e+01 -1.89755223e+00 -7.85258454e-01 -7.85258454e-01
 -7.85258454e-01  2.62154227e+00  2.62154227e+00  2.62154227e+00
  2.73724760e+00  1.97864887e+01  1.97864887e+01  1.97864887e+01
  4.53808081e+01  3.34835164e+02  2.02503029e+03  7.31683953e+03]
E1 = -182.46459343301433  E_coul = 54.266070675127345
Extra cycle  E= -128.198522757887  delta_E= -3.13e-13  |g|= 9.35e-09  |ddm|= 2.86e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14460374e+03 2.27157242e+02 1.42707406e+03 5.75976681e-01
 5.00221605e+01 1.32697032e+01 1.93036557e+00 2.77426748e+00
 1.33052961e+01 6.00143805e-01]
grad_E = [-9.89175146e-06 -2.23903049e-06  3.40309594e-05  2.00761065e-05
  2.42386604e-05  5.50271240e-06  1.30274390e-06  9.74929692e-05
 -1.24027384e-04  3.18514048e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60491086        1
[INPUT] 0    0    [1    /1   ]  227.162434637        1
[INPUT] 0    0    [1    /1   ]  1427.06957531        1
[INPUT] 0    0    [1    /1   ]  0.576030919313       1
[INPUT] 0    0    [1    /1   ]  50.0251811362        1
[INPUT] 0    0    [1    /1   ]  13.2704785673        1
[INPUT] 0    0    [1    /1   ]  1.93059025231        1
[INPUT] 1    0    [1    /1   ]  2.77712143257        1
[INPUT] 1    0    [1    /1   ]  13.3249961445        1
[INPUT] 1    0    [1    /1   ]  0.600566049195       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6049108617626, 1.0]], [0, [227.16243463680857, 1.0]], [0, [1427.0695753063287, 1.0]], [0, [0.5760309193130503, 1.0]], [0, [50.02518113618795, 1.0]], [0, [13.270478567293624, 1.0]], [0, [1.9305902523134397, 1.0]], [1, [2.7771214325698845, 1.0]], [1, [13.324996144534913, 1.0]], [1, [0.6005660491953707, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60491086]
bas 1, expnt(s) = [227.16243464]
bas 2, expnt(s) = [1427.06957531]
bas 3, expnt(s) = [0.57603092]
bas 4, expnt(s) = [50.02518114]
bas 5, expnt(s) = [13.27047857]
bas 6, expnt(s) = [1.93059025]
bas 7, expnt(s) = [2.77712143]
bas 8, expnt(s) = [13.32499614]
bas 9, expnt(s) = [0.60056605]
CPU time:       136.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460491e+03 7.96206092e+02 2.27162435e+02 1.47831645e+02
 1.42706958e+03 5.86609220e+02 5.76030919e-01 1.67051112e+00
 5.00251811e+01 4.75232930e+01 1.32704786e+01 1.75662866e+01
 1.93059025e+00 4.13792492e+00 2.77712143e+00 1.04587066e+01
 1.33249961e+01 7.42708266e+01 6.00566049e-01 1.54235862e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965590112866723
cond(S) = 160.0007262346356
E1 = -183.13699022585254  E_coul = 55.011543872484786
init E= -128.125446353368
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742891842371862  LUMO = 2.6578122232553
  mo_energy =
[-3.25136848e+01 -1.85363306e+00 -7.42891842e-01 -7.42891842e-01
 -7.42891842e-01  2.65781222e+00  2.65781222e+00  2.65781222e+00
  2.77180669e+00  1.99520965e+01  1.99520965e+01  1.99520965e+01
  4.55554265e+01  3.35081181e+02  2.02532930e+03  7.31715788e+03]
E1 = -182.1357968469672  E_coul = 53.93920116820748
cycle= 1 E= -128.19659567876  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259887
diis-c [-0.06754123  1.        ]
  HOMO = -0.807623930894476  LUMO = 2.60390997812834
  mo_energy =
[-3.27865074e+01 -1.92066426e+00 -8.07623931e-01 -8.07623931e-01
 -8.07623931e-01  2.60390998e+00  2.60390998e+00  2.60390998e+00
  2.71793591e+00  1.97619201e+01  1.97619201e+01  1.97619201e+01
  4.53203039e+01  3.34771424e+02  2.02497120e+03  7.31677554e+03]
E1 = -182.5969409757418  E_coul = 54.39872028755133
cycle= 2 E= -128.19822068819  delta_E= -0.00163  |g|= 0.0624  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101601
diis-c [-4.04922426e-04  2.77640314e-01  7.22359686e-01]
  HOMO = -0.784921044070446  LUMO = 2.62447275229299
  mo_energy =
[-3.27119309e+01 -1.89710551e+00 -7.84921044e-01 -7.84921044e-01
 -7.84921044e-01  2.62447275e+00  2.62447275e+00  2.62447275e+00
  2.73809693e+00  1.98179232e+01  1.98179232e+01  1.98179232e+01
  4.53863388e+01  3.34853015e+02  2.02505816e+03  7.31686399e+03]
E1 = -182.46508729081626  E_coul = 54.26656311187794
cycle= 3 E= -128.198524178938  delta_E= -0.000303  |g|= 0.000694  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000882671
diis-c [-7.44585770e-08 -3.87376081e-03 -1.67736697e-03  1.00555113e+00]
  HOMO = -0.785152557546842  LUMO = 2.62429731395063
  mo_energy =
[-3.27125925e+01 -1.89740600e+00 -7.85152558e-01 -7.85152558e-01
 -7.85152558e-01  2.62429731e+00  2.62429731e+00  2.62429731e+00
  2.73786000e+00  1.98174059e+01  1.98174059e+01  1.98174059e+01
  4.53857169e+01  3.34852513e+02  2.02505779e+03  7.31686365e+03]
E1 = -182.46636277449687  E_coul = 54.26783856235162
cycle= 4 E= -128.198524212145  delta_E= -3.32e-08  |g|= 5.02e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.98068e-05
diis-c [-2.08150507e-10  5.01166413e-04 -8.62652106e-04 -1.69284976e-01
  1.16964646e+00]
  HOMO = -0.785138238950048  LUMO = 2.62430971446062
  mo_energy =
[-3.27125556e+01 -1.89740345e+00 -7.85138239e-01 -7.85138239e-01
 -7.85138239e-01  2.62430971e+00  2.62430971e+00  2.62430971e+00
  2.73786141e+00  1.98174345e+01  1.98174345e+01  1.98174345e+01
  4.53857469e+01  3.34852564e+02  2.02505786e+03  7.31686372e+03]
E1 = -182.4663007635199  E_coul = 54.26777655108751
cycle= 5 E= -128.198524212432  delta_E= -2.87e-10  |g|= 1.53e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4663007635199  E_coul = 54.26777655108751
  HOMO = -0.785138179176985  LUMO = 2.62430978262857
  mo_energy =
[-3.27125555e+01 -1.89740377e+00 -7.85138179e-01 -7.85138179e-01
 -7.85138179e-01  2.62430978e+00  2.62430978e+00  2.62430978e+00
  2.73786114e+00  1.98174345e+01  1.98174345e+01  1.98174345e+01
  4.53857469e+01  3.34852564e+02  2.02505786e+03  7.31686372e+03]
E1 = -182.46630075070914  E_coul = 54.26777653827631
Extra cycle  E= -128.198524212433  delta_E= -4.26e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14460491e+03 2.27162435e+02 1.42706958e+03 5.76030919e-01
 5.00251811e+01 1.32704786e+01 1.93059025e+00 2.77712143e+00
 1.33249961e+01 6.00566049e-01]
E = -128.19852421243283
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:46:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60491086        1
[INPUT] 0    0    [1    /1   ]  227.162434637        1
[INPUT] 0    0    [1    /1   ]  1427.06957531        1
[INPUT] 0    0    [1    /1   ]  0.576030919313       1
[INPUT] 0    0    [1    /1   ]  50.0251811362        1
[INPUT] 0    0    [1    /1   ]  13.2704785673        1
[INPUT] 0    0    [1    /1   ]  1.93059025231        1
[INPUT] 1    0    [1    /1   ]  2.77712143257        1
[INPUT] 1    0    [1    /1   ]  13.3249961445        1
[INPUT] 1    0    [1    /1   ]  0.600566049195       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6049108617626, 1.0]], [0, [227.16243463680857, 1.0]], [0, [1427.0695753063287, 1.0]], [0, [0.5760309193130503, 1.0]], [0, [50.02518113618795, 1.0]], [0, [13.270478567293624, 1.0]], [0, [1.9305902523134397, 1.0]], [1, [2.7771214325698845, 1.0]], [1, [13.324996144534913, 1.0]], [1, [0.6005660491953707, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60491086]
bas 1, expnt(s) = [227.16243464]
bas 2, expnt(s) = [1427.06957531]
bas 3, expnt(s) = [0.57603092]
bas 4, expnt(s) = [50.02518114]
bas 5, expnt(s) = [13.27047857]
bas 6, expnt(s) = [1.93059025]
bas 7, expnt(s) = [2.77712143]
bas 8, expnt(s) = [13.32499614]
bas 9, expnt(s) = [0.60056605]
CPU time:       136.83
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460491e+03 7.96206092e+02 2.27162435e+02 1.47831645e+02
 1.42706958e+03 5.86609220e+02 5.76030919e-01 1.67051112e+00
 5.00251811e+01 4.75232930e+01 1.32704786e+01 1.75662866e+01
 1.93059025e+00 4.13792492e+00 2.77712143e+00 1.04587066e+01
 1.33249961e+01 7.42708266e+01 6.00566049e-01 1.54235862e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965590112866723
cond(S) = 160.0007262346356
E1 = -183.13699022585254  E_coul = 55.011543872484786
init E= -128.125446353368
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742891842371862  LUMO = 2.6578122232553
  mo_energy =
[-3.25136848e+01 -1.85363306e+00 -7.42891842e-01 -7.42891842e-01
 -7.42891842e-01  2.65781222e+00  2.65781222e+00  2.65781222e+00
  2.77180669e+00  1.99520965e+01  1.99520965e+01  1.99520965e+01
  4.55554265e+01  3.35081181e+02  2.02532930e+03  7.31715788e+03]
E1 = -182.1357968469672  E_coul = 53.93920116820748
cycle= 1 E= -128.19659567876  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259887
diis-c [-0.06754123  1.        ]
  HOMO = -0.807623930894476  LUMO = 2.60390997812834
  mo_energy =
[-3.27865074e+01 -1.92066426e+00 -8.07623931e-01 -8.07623931e-01
 -8.07623931e-01  2.60390998e+00  2.60390998e+00  2.60390998e+00
  2.71793591e+00  1.97619201e+01  1.97619201e+01  1.97619201e+01
  4.53203039e+01  3.34771424e+02  2.02497120e+03  7.31677554e+03]
E1 = -182.5969409757418  E_coul = 54.39872028755133
cycle= 2 E= -128.19822068819  delta_E= -0.00163  |g|= 0.0624  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101601
diis-c [-4.04922426e-04  2.77640314e-01  7.22359686e-01]
  HOMO = -0.784921044070446  LUMO = 2.62447275229299
  mo_energy =
[-3.27119309e+01 -1.89710551e+00 -7.84921044e-01 -7.84921044e-01
 -7.84921044e-01  2.62447275e+00  2.62447275e+00  2.62447275e+00
  2.73809693e+00  1.98179232e+01  1.98179232e+01  1.98179232e+01
  4.53863388e+01  3.34853015e+02  2.02505816e+03  7.31686399e+03]
E1 = -182.46508729081626  E_coul = 54.26656311187794
cycle= 3 E= -128.198524178938  delta_E= -0.000303  |g|= 0.000694  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000882671
diis-c [-7.44585770e-08 -3.87376081e-03 -1.67736697e-03  1.00555113e+00]
  HOMO = -0.785152557546842  LUMO = 2.62429731395063
  mo_energy =
[-3.27125925e+01 -1.89740600e+00 -7.85152558e-01 -7.85152558e-01
 -7.85152558e-01  2.62429731e+00  2.62429731e+00  2.62429731e+00
  2.73786000e+00  1.98174059e+01  1.98174059e+01  1.98174059e+01
  4.53857169e+01  3.34852513e+02  2.02505779e+03  7.31686365e+03]
E1 = -182.46636277449687  E_coul = 54.26783856235162
cycle= 4 E= -128.198524212145  delta_E= -3.32e-08  |g|= 5.02e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.98068e-05
diis-c [-2.08150507e-10  5.01166413e-04 -8.62652106e-04 -1.69284976e-01
  1.16964646e+00]
  HOMO = -0.785138238950048  LUMO = 2.62430971446062
  mo_energy =
[-3.27125556e+01 -1.89740345e+00 -7.85138239e-01 -7.85138239e-01
 -7.85138239e-01  2.62430971e+00  2.62430971e+00  2.62430971e+00
  2.73786141e+00  1.98174345e+01  1.98174345e+01  1.98174345e+01
  4.53857469e+01  3.34852564e+02  2.02505786e+03  7.31686372e+03]
E1 = -182.4663007635199  E_coul = 54.26777655108751
cycle= 5 E= -128.198524212432  delta_E= -2.87e-10  |g|= 1.53e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4663007635199  E_coul = 54.26777655108751
  HOMO = -0.785138179176985  LUMO = 2.62430978262857
  mo_energy =
[-3.27125555e+01 -1.89740377e+00 -7.85138179e-01 -7.85138179e-01
 -7.85138179e-01  2.62430978e+00  2.62430978e+00  2.62430978e+00
  2.73786114e+00  1.98174345e+01  1.98174345e+01  1.98174345e+01
  4.53857469e+01  3.34852564e+02  2.02505786e+03  7.31686372e+03]
E1 = -182.46630075070914  E_coul = 54.26777653827631
Extra cycle  E= -128.198524212433  delta_E= -4.26e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.0007262346356
E1 = -182.46630075070914  E_coul = 54.26777653827631
init E= -128.198524212433
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785138164950184  LUMO = 2.62430979394676
  mo_energy =
[-3.27125555e+01 -1.89740383e+00 -7.85138165e-01 -7.85138165e-01
 -7.85138165e-01  2.62430979e+00  2.62430979e+00  2.62430979e+00
  2.73786109e+00  1.98174345e+01  1.98174345e+01  1.98174345e+01
  4.53857469e+01  3.34852564e+02  2.02505786e+03  7.31686372e+03]
E1 = -182.46630076294295  E_coul = 54.26777655051008
cycle= 1 E= -128.198524212433  delta_E= -2.84e-14  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46630076294295  E_coul = 54.26777655051008
  HOMO = -0.785138161241581  LUMO = 2.62430979703957
  mo_energy =
[-3.27125555e+01 -1.89740384e+00 -7.85138161e-01 -7.85138161e-01
 -7.85138161e-01  2.62430980e+00  2.62430980e+00  2.62430980e+00
  2.73786108e+00  1.98174345e+01  1.98174345e+01  1.98174345e+01
  4.53857469e+01  3.34852564e+02  2.02505786e+03  7.31686372e+03]
E1 = -182.46630076002572  E_coul = 54.26777654759285
Extra cycle  E= -128.198524212433  delta_E=    0  |g|= 9.34e-09  |ddm|= 2.86e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14460491e+03 2.27162435e+02 1.42706958e+03 5.76030919e-01
 5.00251811e+01 1.32704786e+01 1.93059025e+00 2.77712143e+00
 1.33249961e+01 6.00566049e-01]
grad_E = [-9.89200636e-06 -2.58860598e-06  3.40314690e-05  2.87074905e-05
  2.62553108e-05  9.79994627e-06  2.52279026e-07  1.42935519e-04
 -5.07277854e-05  4.35880686e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60854263        1
[INPUT] 0    0    [1    /1   ]  227.253696184        1
[INPUT] 0    0    [1    /1   ]  1427.04954431        1
[INPUT] 0    0    [1    /1   ]  0.576061077964       1
[INPUT] 0    0    [1    /1   ]  50.0351613123        1
[INPUT] 0    0    [1    /1   ]  13.2715738697        1
[INPUT] 0    0    [1    /1   ]  1.93071000827        1
[INPUT] 1    0    [1    /1   ]  2.77824322431        1
[INPUT] 1    0    [1    /1   ]  13.3334014236        1
[INPUT] 1    0    [1    /1   ]  0.600725322965       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6085426288223, 1.0]], [0, [227.25369618431745, 1.0]], [0, [1427.0495443057177, 1.0]], [0, [0.5760610779640456, 1.0]], [0, [50.035161312272834, 1.0]], [0, [13.271573869709123, 1.0]], [0, [1.9307100082686555, 1.0]], [1, [2.7782432243099193, 1.0]], [1, [13.333401423571996, 1.0]], [1, [0.6007253229645652, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60854263]
bas 1, expnt(s) = [227.25369618]
bas 2, expnt(s) = [1427.04954431]
bas 3, expnt(s) = [0.57606108]
bas 4, expnt(s) = [50.03516131]
bas 5, expnt(s) = [13.27157387]
bas 6, expnt(s) = [1.93071001]
bas 7, expnt(s) = [2.77824322]
bas 8, expnt(s) = [13.33340142]
bas 9, expnt(s) = [0.60072532]
CPU time:       139.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460854e+03 7.96207104e+02 2.27253696e+02 1.47876186e+02
 1.42704954e+03 5.86603044e+02 5.76061078e-01 1.67057672e+00
 5.00351613e+01 4.75304036e+01 1.32715739e+01 1.75673739e+01
 1.93071001e+00 4.13811742e+00 2.77824322e+00 1.04639877e+01
 1.33334014e+01 7.43293929e+01 6.00725323e-01 1.54286994e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96555579671232
cond(S) = 160.02710281696318
E1 = -183.1369882837999  E_coul = 55.01156474377763
init E= -128.125423540022
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742894859068621  LUMO = 2.65883686654953
  mo_energy =
[-3.25136613e+01 -1.85363464e+00 -7.42894859e-01 -7.42894859e-01
 -7.42894859e-01  2.65883687e+00  2.65883687e+00  2.65883687e+00
  2.77208166e+00  1.99648778e+01  1.99648778e+01  1.99648778e+01
  4.55636641e+01  3.35192208e+02  2.02563115e+03  7.31748134e+03]
E1 = -182.1366926211221  E_coul = 53.940093465795584
cycle= 1 E= -128.196599155327  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259716
diis-c [-0.06745251  1.        ]
  HOMO = -0.807560780694109  LUMO = 2.60497444890014
  mo_energy =
[-3.27863252e+01 -1.92058950e+00 -8.07560781e-01 -8.07560781e-01
 -8.07560781e-01  2.60497445e+00  2.60497445e+00  2.60497445e+00
  2.71827400e+00  1.97747817e+01  1.97747817e+01  1.97747817e+01
  4.53286782e+01  3.34882598e+02  2.02527320e+03  7.31709916e+03]
E1 = -182.5974503558683  E_coul = 54.399228425735586
cycle= 2 E= -128.198221930133  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101512
diis-c [-4.04336311e-04  2.77594594e-01  7.22405406e-01]
  HOMO = -0.784876131370916  LUMO = 2.62552773882458
  mo_energy =
[-3.27118034e+01 -1.89705000e+00 -7.84876131e-01 -7.84876131e-01
 -7.84876131e-01  2.62552774e+00  2.62552774e+00  2.62552774e+00
  2.73842012e+00  1.98307551e+01  1.98307551e+01  1.98307551e+01
  4.53946667e+01  3.34964133e+02  2.02536011e+03  7.31718754e+03]
E1 = -182.46571961031896  E_coul = 54.26719472347529
cycle= 3 E= -128.198524886844  delta_E= -0.000303  |g|= 0.000694  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000883556
diis-c [-7.39299553e-08 -3.87284345e-03 -1.65664617e-03  1.00552949e+00]
  HOMO = -0.785107914967972  LUMO = 2.62535195384727
  mo_energy =
[-3.27124657e+01 -1.89735050e+00 -7.85107915e-01 -7.85107915e-01
 -7.85107915e-01  2.62535195e+00  2.62535195e+00  2.62535195e+00
  2.73818313e+00  1.98302371e+01  1.98302371e+01  1.98302371e+01
  4.53940443e+01  3.34963629e+02  2.02535973e+03  7.31718721e+03]
E1 = -182.46699608749347  E_coul = 54.26847116745052
cycle= 4 E= -128.198524920043  delta_E= -3.32e-08  |g|= 5e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.953e-05
diis-c [-2.07499539e-10  5.00928460e-04 -8.63048167e-04 -1.69092689e-01
  1.16945481e+00]
  HOMO = -0.785093638821573  LUMO = 2.62536432234462
  mo_energy =
[-3.27124289e+01 -1.89734794e+00 -7.85093639e-01 -7.85093639e-01
 -7.85093639e-01  2.62536432e+00  2.62536432e+00  2.62536432e+00
  2.73818455e+00  1.98302656e+01  1.98302656e+01  1.98302656e+01
  4.53940742e+01  3.34963680e+02  2.02535980e+03  7.31718728e+03]
E1 = -182.46693426106106  E_coul = 54.26840934073306
cycle= 5 E= -128.198524920328  delta_E= -2.85e-10  |g|= 1.53e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46693426106106  E_coul = 54.26840934073306
  HOMO = -0.785093579238955  LUMO = 2.62536439034188
  mo_energy =
[-3.27124288e+01 -1.89734826e+00 -7.85093579e-01 -7.85093579e-01
 -7.85093579e-01  2.62536439e+00  2.62536439e+00  2.62536439e+00
  2.73818428e+00  1.98302656e+01  1.98302656e+01  1.98302656e+01
  4.53940742e+01  3.34963680e+02  2.02535980e+03  7.31718728e+03]
E1 = -182.46693424997093  E_coul = 54.268409329642644
Extra cycle  E= -128.198524920328  delta_E= -2.84e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14460854e+03 2.27253696e+02 1.42704954e+03 5.76061078e-01
 5.00351613e+01 1.32715739e+01 1.93071001e+00 2.77824322e+00
 1.33334014e+01 6.00725323e-01]
E = -128.19852492032828
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.60854263        1
[INPUT] 0    0    [1    /1   ]  227.253696184        1
[INPUT] 0    0    [1    /1   ]  1427.04954431        1
[INPUT] 0    0    [1    /1   ]  0.576061077964       1
[INPUT] 0    0    [1    /1   ]  50.0351613123        1
[INPUT] 0    0    [1    /1   ]  13.2715738697        1
[INPUT] 0    0    [1    /1   ]  1.93071000827        1
[INPUT] 1    0    [1    /1   ]  2.77824322431        1
[INPUT] 1    0    [1    /1   ]  13.3334014236        1
[INPUT] 1    0    [1    /1   ]  0.600725322965       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6085426288223, 1.0]], [0, [227.25369618431745, 1.0]], [0, [1427.0495443057177, 1.0]], [0, [0.5760610779640456, 1.0]], [0, [50.035161312272834, 1.0]], [0, [13.271573869709123, 1.0]], [0, [1.9307100082686555, 1.0]], [1, [2.7782432243099193, 1.0]], [1, [13.333401423571996, 1.0]], [1, [0.6007253229645652, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.60854263]
bas 1, expnt(s) = [227.25369618]
bas 2, expnt(s) = [1427.04954431]
bas 3, expnt(s) = [0.57606108]
bas 4, expnt(s) = [50.03516131]
bas 5, expnt(s) = [13.27157387]
bas 6, expnt(s) = [1.93071001]
bas 7, expnt(s) = [2.77824322]
bas 8, expnt(s) = [13.33340142]
bas 9, expnt(s) = [0.60072532]
CPU time:       140.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14460854e+03 7.96207104e+02 2.27253696e+02 1.47876186e+02
 1.42704954e+03 5.86603044e+02 5.76061078e-01 1.67057672e+00
 5.00351613e+01 4.75304036e+01 1.32715739e+01 1.75673739e+01
 1.93071001e+00 4.13811742e+00 2.77824322e+00 1.04639877e+01
 1.33334014e+01 7.43293929e+01 6.00725323e-01 1.54286994e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96555579671232
cond(S) = 160.02710281696318
E1 = -183.1369882837999  E_coul = 55.01156474377763
init E= -128.125423540022
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742894859068621  LUMO = 2.65883686654953
  mo_energy =
[-3.25136613e+01 -1.85363464e+00 -7.42894859e-01 -7.42894859e-01
 -7.42894859e-01  2.65883687e+00  2.65883687e+00  2.65883687e+00
  2.77208166e+00  1.99648778e+01  1.99648778e+01  1.99648778e+01
  4.55636641e+01  3.35192208e+02  2.02563115e+03  7.31748134e+03]
E1 = -182.1366926211221  E_coul = 53.940093465795584
cycle= 1 E= -128.196599155327  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259716
diis-c [-0.06745251  1.        ]
  HOMO = -0.807560780694109  LUMO = 2.60497444890014
  mo_energy =
[-3.27863252e+01 -1.92058950e+00 -8.07560781e-01 -8.07560781e-01
 -8.07560781e-01  2.60497445e+00  2.60497445e+00  2.60497445e+00
  2.71827400e+00  1.97747817e+01  1.97747817e+01  1.97747817e+01
  4.53286782e+01  3.34882598e+02  2.02527320e+03  7.31709916e+03]
E1 = -182.5974503558683  E_coul = 54.399228425735586
cycle= 2 E= -128.198221930133  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101512
diis-c [-4.04336311e-04  2.77594594e-01  7.22405406e-01]
  HOMO = -0.784876131370916  LUMO = 2.62552773882458
  mo_energy =
[-3.27118034e+01 -1.89705000e+00 -7.84876131e-01 -7.84876131e-01
 -7.84876131e-01  2.62552774e+00  2.62552774e+00  2.62552774e+00
  2.73842012e+00  1.98307551e+01  1.98307551e+01  1.98307551e+01
  4.53946667e+01  3.34964133e+02  2.02536011e+03  7.31718754e+03]
E1 = -182.46571961031896  E_coul = 54.26719472347529
cycle= 3 E= -128.198524886844  delta_E= -0.000303  |g|= 0.000694  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000883556
diis-c [-7.39299553e-08 -3.87284345e-03 -1.65664617e-03  1.00552949e+00]
  HOMO = -0.785107914967972  LUMO = 2.62535195384727
  mo_energy =
[-3.27124657e+01 -1.89735050e+00 -7.85107915e-01 -7.85107915e-01
 -7.85107915e-01  2.62535195e+00  2.62535195e+00  2.62535195e+00
  2.73818313e+00  1.98302371e+01  1.98302371e+01  1.98302371e+01
  4.53940443e+01  3.34963629e+02  2.02535973e+03  7.31718721e+03]
E1 = -182.46699608749347  E_coul = 54.26847116745052
cycle= 4 E= -128.198524920043  delta_E= -3.32e-08  |g|= 5e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.953e-05
diis-c [-2.07499539e-10  5.00928460e-04 -8.63048167e-04 -1.69092689e-01
  1.16945481e+00]
  HOMO = -0.785093638821573  LUMO = 2.62536432234462
  mo_energy =
[-3.27124289e+01 -1.89734794e+00 -7.85093639e-01 -7.85093639e-01
 -7.85093639e-01  2.62536432e+00  2.62536432e+00  2.62536432e+00
  2.73818455e+00  1.98302656e+01  1.98302656e+01  1.98302656e+01
  4.53940742e+01  3.34963680e+02  2.02535980e+03  7.31718728e+03]
E1 = -182.46693426106106  E_coul = 54.26840934073306
cycle= 5 E= -128.198524920328  delta_E= -2.85e-10  |g|= 1.53e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46693426106106  E_coul = 54.26840934073306
  HOMO = -0.785093579238955  LUMO = 2.62536439034188
  mo_energy =
[-3.27124288e+01 -1.89734826e+00 -7.85093579e-01 -7.85093579e-01
 -7.85093579e-01  2.62536439e+00  2.62536439e+00  2.62536439e+00
  2.73818428e+00  1.98302656e+01  1.98302656e+01  1.98302656e+01
  4.53940742e+01  3.34963680e+02  2.02535980e+03  7.31718728e+03]
E1 = -182.46693424997093  E_coul = 54.268409329642644
Extra cycle  E= -128.198524920328  delta_E= -2.84e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.02710281696318
E1 = -182.46693424997093  E_coul = 54.268409329642644
init E= -128.198524920328
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785093564890089  LUMO = 2.62536440177699
  mo_energy =
[-3.27124288e+01 -1.89734832e+00 -7.85093565e-01 -7.85093565e-01
 -7.85093565e-01  2.62536440e+00  2.62536440e+00  2.62536440e+00
  2.73818423e+00  1.98302656e+01  1.98302656e+01  1.98302656e+01
  4.53940742e+01  3.34963680e+02  2.02535980e+03  7.31718728e+03]
E1 = -182.46693426159428  E_coul = 54.26840934126589
cycle= 1 E= -128.198524920328  delta_E= -1.14e-13  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46693426159428  E_coul = 54.26840934126589
  HOMO = -0.785093561222897  LUMO = 2.62536440483376
  mo_energy =
[-3.27124288e+01 -1.89734833e+00 -7.85093561e-01 -7.85093561e-01
 -7.85093561e-01  2.62536440e+00  2.62536440e+00  2.62536440e+00
  2.73818422e+00  1.98302656e+01  1.98302656e+01  1.98302656e+01
  4.53940742e+01  3.34963680e+02  2.02535980e+03  7.31718728e+03]
E1 = -182.46693425893093  E_coul = 54.268409338602645
Extra cycle  E= -128.198524920328  delta_E= 1.14e-13  |g|= 9.33e-09  |ddm|= 2.86e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14460854e+03 2.27253696e+02 1.42704954e+03 5.76061078e-01
 5.00351613e+01 1.32715739e+01 1.93071001e+00 2.77824322e+00
 1.33334014e+01 6.00725323e-01]
grad_E = [-9.90826913e-06  5.65515061e-08  3.39428025e-05  2.39210947e-05
  1.96474257e-05  9.01567910e-06 -3.62560088e-07  1.21114694e-04
 -1.35841335e-05  3.57860235e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61469226        1
[INPUT] 0    0    [1    /1   ]  227.422597966        1
[INPUT] 0    0    [1    /1   ]  1427.01446131        1
[INPUT] 0    0    [1    /1   ]  0.576083094841       1
[INPUT] 0    0    [1    /1   ]  50.0520871453        1
[INPUT] 0    0    [1    /1   ]  13.2731392701        1
[INPUT] 0    0    [1    /1   ]  1.93079398474        1
[INPUT] 1    0    [1    /1   ]  2.77863234807        1
[INPUT] 1    0    [1    /1   ]  13.3374125952        1
[INPUT] 1    0    [1    /1   ]  0.600769543634       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.614692255103, 1.0]], [0, [227.42259796581132, 1.0]], [0, [1427.0144613135255, 1.0]], [0, [0.576083094841196, 1.0]], [0, [50.052087145329274, 1.0]], [0, [13.273139270129981, 1.0]], [0, [1.9307939847405806, 1.0]], [1, [2.778632348067336, 1.0]], [1, [13.3374125951533, 1.0]], [1, [0.6007695436339575, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61469226]
bas 1, expnt(s) = [227.42259797]
bas 2, expnt(s) = [1427.01446131]
bas 3, expnt(s) = [0.57608309]
bas 4, expnt(s) = [50.05208715]
bas 5, expnt(s) = [13.27313927]
bas 6, expnt(s) = [1.93079398]
bas 7, expnt(s) = [2.77863235]
bas 8, expnt(s) = [13.3374126]
bas 9, expnt(s) = [0.60076954]
CPU time:       142.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461469e+03 7.96208816e+02 2.27422598e+02 1.47958608e+02
 1.42701446e+03 5.86592229e+02 5.76083095e-01 1.67062460e+00
 5.00520871e+01 4.75424620e+01 1.32731393e+01 1.75689280e+01
 1.93079398e+00 4.13825241e+00 2.77863235e+00 1.04658198e+01
 1.33374126e+01 7.43573452e+01 6.00769544e-01 1.54301191e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965545202841973
cond(S) = 160.07511043841234
E1 = -183.13697365186698  E_coul = 55.01156715751241
init E= -128.125406494355
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897660784697  LUMO = 2.65913922457352
  mo_energy =
[-3.25136503e+01 -1.85363559e+00 -7.42897661e-01 -7.42897661e-01
 -7.42897661e-01  2.65913922e+00  2.65913922e+00  2.65913922e+00
  2.77229364e+00  1.99704242e+01  1.99704242e+01  1.99704242e+01
  4.55762284e+01  3.35390832e+02  2.02618326e+03  7.31807626e+03]
E1 = -182.13691847146546  E_coul = 53.940318061079076
cycle= 1 E= -128.196600410386  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259652
diis-c [-0.06741935  1.        ]
  HOMO = -0.807545039770563  LUMO = 2.60528706953632
  mo_energy =
[-3.27862798e+01 -1.92056987e+00 -8.07545040e-01 -8.07545040e-01
 -8.07545040e-01  2.60528707e+00  2.60528707e+00  2.60528707e+00
  2.71849973e+00  1.97803370e+01  1.97803370e+01  1.97803370e+01
  4.53412592e+01  3.35081229e+02  2.02582533e+03  7.31769411e+03]
E1 = -182.59757317670557  E_coul = 54.399350561703905
cycle= 2 E= -128.198222615002  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101486
diis-c [-4.03568846e-04  2.77597942e-01  7.22402058e-01]
  HOMO = -0.784865760571308  LUMO = 2.62583770483897
  mo_energy =
[-3.27117742e+01 -1.89703602e+00 -7.84865761e-01 -7.84865761e-01
 -7.84865761e-01  2.62583770e+00  2.62583770e+00  2.62583770e+00
  2.73864234e+00  1.98363040e+01  1.98363040e+01  1.98363040e+01
  4.54072375e+01  3.35162750e+02  2.02591222e+03  7.31778248e+03]
E1 = -182.46587947036028  E_coul = 54.26735404400138
cycle= 3 E= -128.198525426359  delta_E= -0.000303  |g|= 0.000693  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000881492
diis-c [-7.38168389e-08 -3.87674319e-03 -1.68664409e-03  1.00556339e+00]
  HOMO = -0.785097052910303  LUMO = 2.62566233657262
  mo_energy =
[-3.27124349e+01 -1.89733596e+00 -7.85097053e-01 -7.85097053e-01
 -7.85097053e-01  2.62566234e+00  2.62566234e+00  2.62566234e+00
  2.73840581e+00  1.98357872e+01  1.98357872e+01  1.98357872e+01
  4.54066165e+01  3.35162248e+02  2.02591185e+03  7.31778215e+03]
E1 = -182.46715299775025  E_coul = 54.268627538327024
cycle= 4 E= -128.198525459423  delta_E= -3.31e-08  |g|= 4.99e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.94819e-05
diis-c [-2.07425758e-10  5.01330139e-04 -8.58050235e-04 -1.69048291e-01
  1.16940501e+00]
  HOMO = -0.785082782112564  LUMO = 2.62567470118391
  mo_energy =
[-3.27123981e+01 -1.89733340e+00 -7.85082782e-01 -7.85082782e-01
 -7.85082782e-01  2.62567470e+00  2.62567470e+00  2.62567470e+00
  2.73840724e+00  1.98358156e+01  1.98358156e+01  1.98358156e+01
  4.54066465e+01  3.35162299e+02  2.02591191e+03  7.31778222e+03]
E1 = -182.46709119400325  E_coul = 54.26856573429538
cycle= 5 E= -128.198525459708  delta_E= -2.85e-10  |g|= 1.53e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46709119400325  E_coul = 54.26856573429538
  HOMO = -0.78508272303788  LUMO = 2.62567476882762
  mo_energy =
[-3.27123980e+01 -1.89733372e+00 -7.85082723e-01 -7.85082723e-01
 -7.85082723e-01  2.62567477e+00  2.62567477e+00  2.62567477e+00
  2.73840696e+00  1.98358157e+01  1.98358157e+01  1.98358157e+01
  4.54066465e+01  3.35162299e+02  2.02591191e+03  7.31778222e+03]
E1 = -182.46709118545857  E_coul = 54.26856572575042
Extra cycle  E= -128.198525459708  delta_E= -2.84e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14461469e+03 2.27422598e+02 1.42701446e+03 5.76083095e-01
 5.00520871e+01 1.32731393e+01 1.93079398e+00 2.77863235e+00
 1.33374126e+01 6.00769544e-01]
E = -128.19852545970815
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61469226        1
[INPUT] 0    0    [1    /1   ]  227.422597966        1
[INPUT] 0    0    [1    /1   ]  1427.01446131        1
[INPUT] 0    0    [1    /1   ]  0.576083094841       1
[INPUT] 0    0    [1    /1   ]  50.0520871453        1
[INPUT] 0    0    [1    /1   ]  13.2731392701        1
[INPUT] 0    0    [1    /1   ]  1.93079398474        1
[INPUT] 1    0    [1    /1   ]  2.77863234807        1
[INPUT] 1    0    [1    /1   ]  13.3374125952        1
[INPUT] 1    0    [1    /1   ]  0.600769543634       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.614692255103, 1.0]], [0, [227.42259796581132, 1.0]], [0, [1427.0144613135255, 1.0]], [0, [0.576083094841196, 1.0]], [0, [50.052087145329274, 1.0]], [0, [13.273139270129981, 1.0]], [0, [1.9307939847405806, 1.0]], [1, [2.778632348067336, 1.0]], [1, [13.3374125951533, 1.0]], [1, [0.6007695436339575, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61469226]
bas 1, expnt(s) = [227.42259797]
bas 2, expnt(s) = [1427.01446131]
bas 3, expnt(s) = [0.57608309]
bas 4, expnt(s) = [50.05208715]
bas 5, expnt(s) = [13.27313927]
bas 6, expnt(s) = [1.93079398]
bas 7, expnt(s) = [2.77863235]
bas 8, expnt(s) = [13.3374126]
bas 9, expnt(s) = [0.60076954]
CPU time:       143.36
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461469e+03 7.96208816e+02 2.27422598e+02 1.47958608e+02
 1.42701446e+03 5.86592229e+02 5.76083095e-01 1.67062460e+00
 5.00520871e+01 4.75424620e+01 1.32731393e+01 1.75689280e+01
 1.93079398e+00 4.13825241e+00 2.77863235e+00 1.04658198e+01
 1.33374126e+01 7.43573452e+01 6.00769544e-01 1.54301191e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965545202841973
cond(S) = 160.07511043841234
E1 = -183.13697365186698  E_coul = 55.01156715751241
init E= -128.125406494355
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897660784697  LUMO = 2.65913922457352
  mo_energy =
[-3.25136503e+01 -1.85363559e+00 -7.42897661e-01 -7.42897661e-01
 -7.42897661e-01  2.65913922e+00  2.65913922e+00  2.65913922e+00
  2.77229364e+00  1.99704242e+01  1.99704242e+01  1.99704242e+01
  4.55762284e+01  3.35390832e+02  2.02618326e+03  7.31807626e+03]
E1 = -182.13691847146546  E_coul = 53.940318061079076
cycle= 1 E= -128.196600410386  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259652
diis-c [-0.06741935  1.        ]
  HOMO = -0.807545039770563  LUMO = 2.60528706953632
  mo_energy =
[-3.27862798e+01 -1.92056987e+00 -8.07545040e-01 -8.07545040e-01
 -8.07545040e-01  2.60528707e+00  2.60528707e+00  2.60528707e+00
  2.71849973e+00  1.97803370e+01  1.97803370e+01  1.97803370e+01
  4.53412592e+01  3.35081229e+02  2.02582533e+03  7.31769411e+03]
E1 = -182.59757317670557  E_coul = 54.399350561703905
cycle= 2 E= -128.198222615002  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101486
diis-c [-4.03568846e-04  2.77597942e-01  7.22402058e-01]
  HOMO = -0.784865760571308  LUMO = 2.62583770483897
  mo_energy =
[-3.27117742e+01 -1.89703602e+00 -7.84865761e-01 -7.84865761e-01
 -7.84865761e-01  2.62583770e+00  2.62583770e+00  2.62583770e+00
  2.73864234e+00  1.98363040e+01  1.98363040e+01  1.98363040e+01
  4.54072375e+01  3.35162750e+02  2.02591222e+03  7.31778248e+03]
E1 = -182.46587947036028  E_coul = 54.26735404400138
cycle= 3 E= -128.198525426359  delta_E= -0.000303  |g|= 0.000693  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000881492
diis-c [-7.38168389e-08 -3.87674319e-03 -1.68664409e-03  1.00556339e+00]
  HOMO = -0.785097052910303  LUMO = 2.62566233657262
  mo_energy =
[-3.27124349e+01 -1.89733596e+00 -7.85097053e-01 -7.85097053e-01
 -7.85097053e-01  2.62566234e+00  2.62566234e+00  2.62566234e+00
  2.73840581e+00  1.98357872e+01  1.98357872e+01  1.98357872e+01
  4.54066165e+01  3.35162248e+02  2.02591185e+03  7.31778215e+03]
E1 = -182.46715299775025  E_coul = 54.268627538327024
cycle= 4 E= -128.198525459423  delta_E= -3.31e-08  |g|= 4.99e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.94819e-05
diis-c [-2.07425758e-10  5.01330139e-04 -8.58050235e-04 -1.69048291e-01
  1.16940501e+00]
  HOMO = -0.785082782112564  LUMO = 2.62567470118391
  mo_energy =
[-3.27123981e+01 -1.89733340e+00 -7.85082782e-01 -7.85082782e-01
 -7.85082782e-01  2.62567470e+00  2.62567470e+00  2.62567470e+00
  2.73840724e+00  1.98358156e+01  1.98358156e+01  1.98358156e+01
  4.54066465e+01  3.35162299e+02  2.02591191e+03  7.31778222e+03]
E1 = -182.46709119400325  E_coul = 54.26856573429538
cycle= 5 E= -128.198525459708  delta_E= -2.85e-10  |g|= 1.53e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46709119400325  E_coul = 54.26856573429538
  HOMO = -0.78508272303788  LUMO = 2.62567476882762
  mo_energy =
[-3.27123980e+01 -1.89733372e+00 -7.85082723e-01 -7.85082723e-01
 -7.85082723e-01  2.62567477e+00  2.62567477e+00  2.62567477e+00
  2.73840696e+00  1.98358157e+01  1.98358157e+01  1.98358157e+01
  4.54066465e+01  3.35162299e+02  2.02591191e+03  7.31778222e+03]
E1 = -182.46709118545857  E_coul = 54.26856572575042
Extra cycle  E= -128.198525459708  delta_E= -2.84e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.07511043841234
E1 = -182.46709118545857  E_coul = 54.26856572575042
init E= -128.198525459708
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785082708514651  LUMO = 2.62567478042283
  mo_energy =
[-3.27123980e+01 -1.89733378e+00 -7.85082709e-01 -7.85082709e-01
 -7.85082709e-01  2.62567478e+00  2.62567478e+00  2.62567478e+00
  2.73840691e+00  1.98358157e+01  1.98358157e+01  1.98358157e+01
  4.54066464e+01  3.35162299e+02  2.02591191e+03  7.31778222e+03]
E1 = -182.4670911960796  E_coul = 54.26856573637156
cycle= 1 E= -128.198525459708  delta_E= 1.14e-13  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4670911960796  E_coul = 54.26856573637156
  HOMO = -0.785082704915831  LUMO = 2.62567478341814
  mo_energy =
[-3.27123980e+01 -1.89733379e+00 -7.85082705e-01 -7.85082705e-01
 -7.85082705e-01  2.62567478e+00  2.62567478e+00  2.62567478e+00
  2.73840690e+00  1.98358157e+01  1.98358157e+01  1.98358157e+01
  4.54066464e+01  3.35162299e+02  2.02591191e+03  7.31778222e+03]
E1 = -182.46709119381583  E_coul = 54.26856573410769
Extra cycle  E= -128.198525459708  delta_E= -1.14e-13  |g|= 9.33e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14461469e+03 2.27422598e+02 1.42701446e+03 5.76083095e-01
 5.00520871e+01 1.32731393e+01 1.93079398e+00 2.77863235e+00
 1.33374126e+01 6.00769544e-01]
grad_E = [-9.93863256e-06  5.24135473e-06  3.37757413e-05  8.88457525e-06
  6.09874918e-06  4.15254672e-06 -6.15028235e-07  4.71908473e-05
  1.33417173e-05  1.31368676e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61643882        1
[INPUT] 0    0    [1    /1   ]  227.475005888        1
[INPUT] 0    0    [1    /1   ]  1427.00413801        1
[INPUT] 0    0    [1    /1   ]  0.576079102178       1
[INPUT] 0    0    [1    /1   ]  50.0568696202        1
[INPUT] 0    0    [1    /1   ]  13.2734782933        1
[INPUT] 0    0    [1    /1   ]  1.9307771294         1
[INPUT] 1    0    [1    /1   ]  2.77824840003        1
[INPUT] 1    0    [1    /1   ]  13.3352463817        1
[INPUT] 1    0    [1    /1   ]  0.600707881375       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.616438818733, 1.0]], [0, [227.47500588815703, 1.0]], [0, [1427.0041380084424, 1.0]], [0, [0.5760791021778222, 1.0]], [0, [50.05686962024833, 1.0]], [0, [13.273478293349239, 1.0]], [0, [1.9307771293957816, 1.0]], [1, [2.7782484000328647, 1.0]], [1, [13.335246381714496, 1.0]], [1, [0.6007078813752534, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61643882]
bas 1, expnt(s) = [227.47500589]
bas 2, expnt(s) = [1427.00413801]
bas 3, expnt(s) = [0.5760791]
bas 4, expnt(s) = [50.05686962]
bas 5, expnt(s) = [13.27347829]
bas 6, expnt(s) = [1.93077713]
bas 7, expnt(s) = [2.7782484]
bas 8, expnt(s) = [13.33524638]
bas 9, expnt(s) = [0.60070788]
CPU time:       145.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461644e+03 7.96209302e+02 2.27475006e+02 1.47984179e+02
 1.42700414e+03 5.86589046e+02 5.76079102e-01 1.67061592e+00
 5.00568696e+01 4.75458690e+01 1.32734783e+01 1.75692645e+01
 1.93077713e+00 4.13822532e+00 2.77824840e+00 1.04640121e+01
 1.33352464e+01 7.43422494e+01 6.00707881e-01 1.54281394e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965557841308648
cond(S) = 160.08972073053624
E1 = -183.13696595706182  E_coul = 55.01155706830043
init E= -128.125408888761
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897774274385  LUMO = 2.65875404069371
  mo_energy =
[-3.25136564e+01 -1.85363534e+00 -7.42897774e-01 -7.42897774e-01
 -7.42897774e-01  2.65875404e+00  2.65875404e+00  2.65875404e+00
  2.77226563e+00  1.99667704e+01  1.99667704e+01  1.99667704e+01
  4.55792897e+01  3.35450350e+02  2.02635254e+03  7.31825964e+03]
E1 = -182.13655641821438  E_coul = 53.939957051589644
cycle= 1 E= -128.196599366625  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259709
diis-c [-0.06744855  1.        ]
  HOMO = -0.807570719991219  LUMO = 2.60488587629334
  mo_energy =
[-3.27863539e+01 -1.92059960e+00 -8.07570720e-01 -8.07570720e-01
 -8.07570720e-01  2.60488588e+00  2.60488588e+00  2.60488588e+00
  2.71844499e+00  1.97766432e+01  1.97766432e+01  1.97766432e+01
  4.53442542e+01  3.35140668e+02  2.02599454e+03  7.31787742e+03]
E1 = -182.59736379865757  E_coul = 54.399141328157704
cycle= 2 E= -128.1982224705  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10152
diis-c [-4.03424076e-04  2.77625452e-01  7.22374548e-01]
  HOMO = -0.784884543445129  LUMO = 2.62544020522375
  mo_energy =
[-3.27118275e+01 -1.89705845e+00 -7.84884543e-01 -7.84884543e-01
 -7.84884543e-01  2.62544021e+00  2.62544021e+00  2.62544021e+00
  2.73859377e+00  1.98326230e+01  1.98326230e+01  1.98326230e+01
  4.54102523e+01  3.35222213e+02  2.02608145e+03  7.31796581e+03]
E1 = -182.46562417911724  E_coul = 54.26709868838857
cycle= 3 E= -128.198525490729  delta_E= -0.000303  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000879732
diis-c [-7.40406292e-08 -3.87963543e-03 -1.71659008e-03  1.00559623e+00]
  HOMO = -0.785115383360445  LUMO = 2.6252652862248
  mo_energy =
[-3.27124868e+01 -1.89735805e+00 -7.85115383e-01 -7.85115383e-01
 -7.85115383e-01  2.62526529e+00  2.62526529e+00  2.62526529e+00
  2.73835755e+00  1.98321072e+01  1.98321072e+01  1.98321072e+01
  4.54096324e+01  3.35221713e+02  2.02608108e+03  7.31796548e+03]
E1 = -182.46689534007976  E_coul = 54.26836981636537
cycle= 4 E= -128.198525523714  delta_E= -3.3e-08  |g|= 5e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.96061e-05
diis-c [-2.07746811e-10  5.01704316e-04 -8.54757978e-04 -1.69127285e-01
  1.16948034e+00]
  HOMO = -0.785101092266891  LUMO = 2.62527766623739
  mo_energy =
[-3.27124500e+01 -1.89735549e+00 -7.85101092e-01 -7.85101092e-01
 -7.85101092e-01  2.62527767e+00  2.62527767e+00  2.62527767e+00
  2.73835898e+00  1.98321358e+01  1.98321358e+01  1.98321358e+01
  4.54096624e+01  3.35221764e+02  2.02608114e+03  7.31796555e+03]
E1 = -182.466833447781  E_coul = 54.268307923780995
cycle= 5 E= -128.198525524  delta_E= -2.86e-10  |g|= 1.53e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.466833447781  E_coul = 54.268307923780995
  HOMO = -0.785101033391067  LUMO = 2.62527773376514
  mo_energy =
[-3.27124499e+01 -1.89735581e+00 -7.85101033e-01 -7.85101033e-01
 -7.85101033e-01  2.62527773e+00  2.62527773e+00  2.62527773e+00
  2.73835870e+00  1.98321358e+01  1.98321358e+01  1.98321358e+01
  4.54096624e+01  3.35221764e+02  2.02608114e+03  7.31796555e+03]
E1 = -182.4668334398154  E_coul = 54.26830791581497
Extra cycle  E= -128.198525524  delta_E= -4.26e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14461644e+03 2.27475006e+02 1.42700414e+03 5.76079102e-01
 5.00568696e+01 1.32734783e+01 1.93077713e+00 2.77824840e+00
 1.33352464e+01 6.00707881e-01]
E = -128.19852552400042
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61643882        1
[INPUT] 0    0    [1    /1   ]  227.475005888        1
[INPUT] 0    0    [1    /1   ]  1427.00413801        1
[INPUT] 0    0    [1    /1   ]  0.576079102178       1
[INPUT] 0    0    [1    /1   ]  50.0568696202        1
[INPUT] 0    0    [1    /1   ]  13.2734782933        1
[INPUT] 0    0    [1    /1   ]  1.9307771294         1
[INPUT] 1    0    [1    /1   ]  2.77824840003        1
[INPUT] 1    0    [1    /1   ]  13.3352463817        1
[INPUT] 1    0    [1    /1   ]  0.600707881375       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.616438818733, 1.0]], [0, [227.47500588815703, 1.0]], [0, [1427.0041380084424, 1.0]], [0, [0.5760791021778222, 1.0]], [0, [50.05686962024833, 1.0]], [0, [13.273478293349239, 1.0]], [0, [1.9307771293957816, 1.0]], [1, [2.7782484000328647, 1.0]], [1, [13.335246381714496, 1.0]], [1, [0.6007078813752534, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61643882]
bas 1, expnt(s) = [227.47500589]
bas 2, expnt(s) = [1427.00413801]
bas 3, expnt(s) = [0.5760791]
bas 4, expnt(s) = [50.05686962]
bas 5, expnt(s) = [13.27347829]
bas 6, expnt(s) = [1.93077713]
bas 7, expnt(s) = [2.7782484]
bas 8, expnt(s) = [13.33524638]
bas 9, expnt(s) = [0.60070788]
CPU time:       146.65
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461644e+03 7.96209302e+02 2.27475006e+02 1.47984179e+02
 1.42700414e+03 5.86589046e+02 5.76079102e-01 1.67061592e+00
 5.00568696e+01 4.75458690e+01 1.32734783e+01 1.75692645e+01
 1.93077713e+00 4.13822532e+00 2.77824840e+00 1.04640121e+01
 1.33352464e+01 7.43422494e+01 6.00707881e-01 1.54281394e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965557841308648
cond(S) = 160.08972073053624
E1 = -183.13696595706182  E_coul = 55.01155706830043
init E= -128.125408888761
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897774274385  LUMO = 2.65875404069371
  mo_energy =
[-3.25136564e+01 -1.85363534e+00 -7.42897774e-01 -7.42897774e-01
 -7.42897774e-01  2.65875404e+00  2.65875404e+00  2.65875404e+00
  2.77226563e+00  1.99667704e+01  1.99667704e+01  1.99667704e+01
  4.55792897e+01  3.35450350e+02  2.02635254e+03  7.31825964e+03]
E1 = -182.13655641821438  E_coul = 53.939957051589644
cycle= 1 E= -128.196599366625  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259709
diis-c [-0.06744855  1.        ]
  HOMO = -0.807570719991219  LUMO = 2.60488587629334
  mo_energy =
[-3.27863539e+01 -1.92059960e+00 -8.07570720e-01 -8.07570720e-01
 -8.07570720e-01  2.60488588e+00  2.60488588e+00  2.60488588e+00
  2.71844499e+00  1.97766432e+01  1.97766432e+01  1.97766432e+01
  4.53442542e+01  3.35140668e+02  2.02599454e+03  7.31787742e+03]
E1 = -182.59736379865757  E_coul = 54.399141328157704
cycle= 2 E= -128.1982224705  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10152
diis-c [-4.03424076e-04  2.77625452e-01  7.22374548e-01]
  HOMO = -0.784884543445129  LUMO = 2.62544020522375
  mo_energy =
[-3.27118275e+01 -1.89705845e+00 -7.84884543e-01 -7.84884543e-01
 -7.84884543e-01  2.62544021e+00  2.62544021e+00  2.62544021e+00
  2.73859377e+00  1.98326230e+01  1.98326230e+01  1.98326230e+01
  4.54102523e+01  3.35222213e+02  2.02608145e+03  7.31796581e+03]
E1 = -182.46562417911724  E_coul = 54.26709868838857
cycle= 3 E= -128.198525490729  delta_E= -0.000303  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000879732
diis-c [-7.40406292e-08 -3.87963543e-03 -1.71659008e-03  1.00559623e+00]
  HOMO = -0.785115383360445  LUMO = 2.6252652862248
  mo_energy =
[-3.27124868e+01 -1.89735805e+00 -7.85115383e-01 -7.85115383e-01
 -7.85115383e-01  2.62526529e+00  2.62526529e+00  2.62526529e+00
  2.73835755e+00  1.98321072e+01  1.98321072e+01  1.98321072e+01
  4.54096324e+01  3.35221713e+02  2.02608108e+03  7.31796548e+03]
E1 = -182.46689534007976  E_coul = 54.26836981636537
cycle= 4 E= -128.198525523714  delta_E= -3.3e-08  |g|= 5e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.96061e-05
diis-c [-2.07746811e-10  5.01704316e-04 -8.54757978e-04 -1.69127285e-01
  1.16948034e+00]
  HOMO = -0.785101092266891  LUMO = 2.62527766623739
  mo_energy =
[-3.27124500e+01 -1.89735549e+00 -7.85101092e-01 -7.85101092e-01
 -7.85101092e-01  2.62527767e+00  2.62527767e+00  2.62527767e+00
  2.73835898e+00  1.98321358e+01  1.98321358e+01  1.98321358e+01
  4.54096624e+01  3.35221764e+02  2.02608114e+03  7.31796555e+03]
E1 = -182.466833447781  E_coul = 54.268307923780995
cycle= 5 E= -128.198525524  delta_E= -2.86e-10  |g|= 1.53e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.466833447781  E_coul = 54.268307923780995
  HOMO = -0.785101033391067  LUMO = 2.62527773376514
  mo_energy =
[-3.27124499e+01 -1.89735581e+00 -7.85101033e-01 -7.85101033e-01
 -7.85101033e-01  2.62527773e+00  2.62527773e+00  2.62527773e+00
  2.73835870e+00  1.98321358e+01  1.98321358e+01  1.98321358e+01
  4.54096624e+01  3.35221764e+02  2.02608114e+03  7.31796555e+03]
E1 = -182.4668334398154  E_coul = 54.26830791581497
Extra cycle  E= -128.198525524  delta_E= -4.26e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.08972073053624
E1 = -182.4668334398154  E_coul = 54.26830791581497
init E= -128.198525524
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785101018830126  LUMO = 2.62527774539221
  mo_energy =
[-3.27124499e+01 -1.89735587e+00 -7.85101019e-01 -7.85101019e-01
 -7.85101019e-01  2.62527775e+00  2.62527775e+00  2.62527775e+00
  2.73835865e+00  1.98321358e+01  1.98321358e+01  1.98321358e+01
  4.54096624e+01  3.35221764e+02  2.02608114e+03  7.31796555e+03]
E1 = -182.4668334501718  E_coul = 54.26830792617147
cycle= 1 E= -128.198525524  delta_E= 8.53e-14  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4668334501718  E_coul = 54.26830792617147
  HOMO = -0.785101015249443  LUMO = 2.62527774837059
  mo_energy =
[-3.27124499e+01 -1.89735587e+00 -7.85101015e-01 -7.85101015e-01
 -7.85101015e-01  2.62527775e+00  2.62527775e+00  2.62527775e+00
  2.73835864e+00  1.98321358e+01  1.98321358e+01  1.98321358e+01
  4.54096624e+01  3.35221764e+02  2.02608114e+03  7.31796555e+03]
E1 = -182.46683344800746  E_coul = 54.26830792400727
Extra cycle  E= -128.198525524  delta_E= 1.42e-13  |g|= 9.33e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14461644e+03 2.27475006e+02 1.42700414e+03 5.76079102e-01
 5.00568696e+01 1.32734783e+01 1.93077713e+00 2.77824840e+00
 1.33352464e+01 6.00707881e-01]
grad_E = [-9.94813589e-06  6.93455902e-06  3.37230245e-05  1.87967735e-06
  1.56243582e-06  1.31601772e-06 -2.72548826e-07  1.14224211e-05
  9.79989512e-06  3.08355104e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61660416        1
[INPUT] 0    0    [1    /1   ]  227.481067183        1
[INPUT] 0    0    [1    /1   ]  1427.00307219        1
[INPUT] 0    0    [1    /1   ]  0.57607487657        1
[INPUT] 0    0    [1    /1   ]  50.0572712666        1
[INPUT] 0    0    [1    /1   ]  13.2734666977        1
[INPUT] 0    0    [1    /1   ]  1.93076084199        1
[INPUT] 1    0    [1    /1   ]  2.77805766913        1
[INPUT] 1    0    [1    /1   ]  13.3340316462        1
[INPUT] 1    0    [1    /1   ]  0.600678628887       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.616604155435, 1.0]], [0, [227.48106718344766, 1.0]], [0, [1427.003072194876, 1.0]], [0, [0.5760748765704172, 1.0]], [0, [50.05727126662638, 1.0]], [0, [13.273466697665933, 1.0]], [0, [1.9307608419909392, 1.0]], [1, [2.7780576691306043, 1.0]], [1, [13.33403164618147, 1.0]], [1, [0.6006786288865184, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61660416]
bas 1, expnt(s) = [227.48106718]
bas 2, expnt(s) = [1427.00307219]
bas 3, expnt(s) = [0.57607488]
bas 4, expnt(s) = [50.05727127]
bas 5, expnt(s) = [13.2734667]
bas 6, expnt(s) = [1.93076084]
bas 7, expnt(s) = [2.77805767]
bas 8, expnt(s) = [13.33403165]
bas 9, expnt(s) = [0.60067863]
CPU time:       149.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461660e+03 7.96209348e+02 2.27481067e+02 1.47987137e+02
 1.42700307e+03 5.86588717e+02 5.76074877e-01 1.67060673e+00
 5.00572713e+01 4.75461551e+01 1.32734667e+01 1.75692530e+01
 1.93076084e+00 4.13819914e+00 2.77805767e+00 1.04631142e+01
 1.33340316e+01 7.43337845e+01 6.00678629e-01 1.54272003e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9655639765975
cond(S) = 160.09127799939256
E1 = -183.13696413810578  E_coul = 55.011552664578524
init E= -128.125411473527
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897602788742  LUMO = 2.65856936760139
  mo_energy =
[-3.25136598e+01 -1.85363520e+00 -7.42897603e-01 -7.42897603e-01
 -7.42897603e-01  2.65856937e+00  2.65856937e+00  2.65856937e+00
  2.77223038e+00  1.99648145e+01  1.99648145e+01  1.99648145e+01
  4.55793621e+01  3.35456538e+02  2.02637143e+03  7.31828035e+03]
E1 = -182.1363865927775  E_coul = 53.93978774270635
cycle= 1 E= -128.196598850071  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259738
diis-c [-0.06746358  1.        ]
  HOMO = -0.807582748081608  LUMO = 2.60469364777031
  mo_energy =
[-3.27863885e+01 -1.92061363e+00 -8.07582748e-01 -8.07582748e-01
 -8.07582748e-01  2.60469365e+00  2.60469365e+00  2.60469365e+00
  2.71839759e+00  1.97746698e+01  1.97746698e+01  1.97746698e+01
  4.53442977e+01  3.35146823e+02  2.02601339e+03  7.31789809e+03]
E1 = -182.59726622914613  E_coul = 54.399043852335936
cycle= 2 E= -128.19822237681  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101536
diis-c [-4.0343330e-04  2.7763642e-01  7.2236358e-01]
  HOMO = -0.784893240781634  LUMO = 2.62524975293049
  mo_energy =
[-3.27118522e+01 -1.89706897e+00 -7.84893241e-01 -7.84893241e-01
 -7.84893241e-01  2.62524975e+00  2.62524975e+00  2.62524975e+00
  2.73854922e+00  1.98306555e+01  1.98306555e+01  1.98306555e+01
  4.54103048e+01  3.35228378e+02  2.02610031e+03  7.31798650e+03]
E1 = -182.46550435613614  E_coul = 54.26697885991261
cycle= 3 E= -128.198525496224  delta_E= -0.000303  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000879195
diis-c [-7.41421533e-08 -3.88046156e-03 -1.72616477e-03  1.00560663e+00]
  HOMO = -0.785123938971192  LUMO = 2.62507498101595
  mo_energy =
[-3.27125111e+01 -1.89736847e+00 -7.85123939e-01 -7.85123939e-01
 -7.85123939e-01  2.62507498e+00  2.62507498e+00  2.62507498e+00
  2.73831308e+00  1.98301401e+01  1.98301401e+01  1.98301401e+01
  4.54096853e+01  3.35227878e+02  2.02609994e+03  7.31798616e+03]
E1 = -182.4667748094812  E_coul = 54.26824928029237
cycle= 4 E= -128.198525529189  delta_E= -3.3e-08  |g|= 5.01e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.96609e-05
diis-c [-2.07886759e-10  5.01817842e-04 -8.53852346e-04 -1.69162855e-01
  1.16951489e+00]
  HOMO = -0.785109639127073  LUMO = 2.62508736764992
  mo_energy =
[-3.27124742e+01 -1.89736591e+00 -7.85109639e-01 -7.85109639e-01
 -7.85109639e-01  2.62508737e+00  2.62508737e+00  2.62508737e+00
  2.73831451e+00  1.98301686e+01  1.98301686e+01  1.98301686e+01
  4.54097154e+01  3.35227929e+02  2.02610001e+03  7.31798624e+03]
E1 = -182.4667128790767  E_coul = 54.26818734960147
cycle= 5 E= -128.198525529475  delta_E= -2.86e-10  |g|= 1.53e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4667128790767  E_coul = 54.26818734960147
  HOMO = -0.785109580281841  LUMO = 2.62508743516646
  mo_energy =
[-3.27124741e+01 -1.89736623e+00 -7.85109580e-01 -7.85109580e-01
 -7.85109580e-01  2.62508744e+00  2.62508744e+00  2.62508744e+00
  2.73831423e+00  1.98301686e+01  1.98301686e+01  1.98301686e+01
  4.54097153e+01  3.35227929e+02  2.02610001e+03  7.31798624e+03]
E1 = -182.4667128710985  E_coul = 54.2681873416231
Extra cycle  E= -128.198525529475  delta_E= -1.71e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14461660e+03 2.27481067e+02 1.42700307e+03 5.76074877e-01
 5.00572713e+01 1.32734667e+01 1.93076084e+00 2.77805767e+00
 1.33340316e+01 6.00678629e-01]
E = -128.1985255294754
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61660416        1
[INPUT] 0    0    [1    /1   ]  227.481067183        1
[INPUT] 0    0    [1    /1   ]  1427.00307219        1
[INPUT] 0    0    [1    /1   ]  0.57607487657        1
[INPUT] 0    0    [1    /1   ]  50.0572712666        1
[INPUT] 0    0    [1    /1   ]  13.2734666977        1
[INPUT] 0    0    [1    /1   ]  1.93076084199        1
[INPUT] 1    0    [1    /1   ]  2.77805766913        1
[INPUT] 1    0    [1    /1   ]  13.3340316462        1
[INPUT] 1    0    [1    /1   ]  0.600678628887       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.616604155435, 1.0]], [0, [227.48106718344766, 1.0]], [0, [1427.003072194876, 1.0]], [0, [0.5760748765704172, 1.0]], [0, [50.05727126662638, 1.0]], [0, [13.273466697665933, 1.0]], [0, [1.9307608419909392, 1.0]], [1, [2.7780576691306043, 1.0]], [1, [13.33403164618147, 1.0]], [1, [0.6006786288865184, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61660416]
bas 1, expnt(s) = [227.48106718]
bas 2, expnt(s) = [1427.00307219]
bas 3, expnt(s) = [0.57607488]
bas 4, expnt(s) = [50.05727127]
bas 5, expnt(s) = [13.2734667]
bas 6, expnt(s) = [1.93076084]
bas 7, expnt(s) = [2.77805767]
bas 8, expnt(s) = [13.33403165]
bas 9, expnt(s) = [0.60067863]
CPU time:       149.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461660e+03 7.96209348e+02 2.27481067e+02 1.47987137e+02
 1.42700307e+03 5.86588717e+02 5.76074877e-01 1.67060673e+00
 5.00572713e+01 4.75461551e+01 1.32734667e+01 1.75692530e+01
 1.93076084e+00 4.13819914e+00 2.77805767e+00 1.04631142e+01
 1.33340316e+01 7.43337845e+01 6.00678629e-01 1.54272003e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.9655639765975
cond(S) = 160.09127799939256
E1 = -183.13696413810578  E_coul = 55.011552664578524
init E= -128.125411473527
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897602788742  LUMO = 2.65856936760139
  mo_energy =
[-3.25136598e+01 -1.85363520e+00 -7.42897603e-01 -7.42897603e-01
 -7.42897603e-01  2.65856937e+00  2.65856937e+00  2.65856937e+00
  2.77223038e+00  1.99648145e+01  1.99648145e+01  1.99648145e+01
  4.55793621e+01  3.35456538e+02  2.02637143e+03  7.31828035e+03]
E1 = -182.1363865927775  E_coul = 53.93978774270635
cycle= 1 E= -128.196598850071  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259738
diis-c [-0.06746358  1.        ]
  HOMO = -0.807582748081608  LUMO = 2.60469364777031
  mo_energy =
[-3.27863885e+01 -1.92061363e+00 -8.07582748e-01 -8.07582748e-01
 -8.07582748e-01  2.60469365e+00  2.60469365e+00  2.60469365e+00
  2.71839759e+00  1.97746698e+01  1.97746698e+01  1.97746698e+01
  4.53442977e+01  3.35146823e+02  2.02601339e+03  7.31789809e+03]
E1 = -182.59726622914613  E_coul = 54.399043852335936
cycle= 2 E= -128.19822237681  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101536
diis-c [-4.0343330e-04  2.7763642e-01  7.2236358e-01]
  HOMO = -0.784893240781634  LUMO = 2.62524975293049
  mo_energy =
[-3.27118522e+01 -1.89706897e+00 -7.84893241e-01 -7.84893241e-01
 -7.84893241e-01  2.62524975e+00  2.62524975e+00  2.62524975e+00
  2.73854922e+00  1.98306555e+01  1.98306555e+01  1.98306555e+01
  4.54103048e+01  3.35228378e+02  2.02610031e+03  7.31798650e+03]
E1 = -182.46550435613614  E_coul = 54.26697885991261
cycle= 3 E= -128.198525496224  delta_E= -0.000303  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000879195
diis-c [-7.41421533e-08 -3.88046156e-03 -1.72616477e-03  1.00560663e+00]
  HOMO = -0.785123938971192  LUMO = 2.62507498101595
  mo_energy =
[-3.27125111e+01 -1.89736847e+00 -7.85123939e-01 -7.85123939e-01
 -7.85123939e-01  2.62507498e+00  2.62507498e+00  2.62507498e+00
  2.73831308e+00  1.98301401e+01  1.98301401e+01  1.98301401e+01
  4.54096853e+01  3.35227878e+02  2.02609994e+03  7.31798616e+03]
E1 = -182.4667748094812  E_coul = 54.26824928029237
cycle= 4 E= -128.198525529189  delta_E= -3.3e-08  |g|= 5.01e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.96609e-05
diis-c [-2.07886759e-10  5.01817842e-04 -8.53852346e-04 -1.69162855e-01
  1.16951489e+00]
  HOMO = -0.785109639127073  LUMO = 2.62508736764992
  mo_energy =
[-3.27124742e+01 -1.89736591e+00 -7.85109639e-01 -7.85109639e-01
 -7.85109639e-01  2.62508737e+00  2.62508737e+00  2.62508737e+00
  2.73831451e+00  1.98301686e+01  1.98301686e+01  1.98301686e+01
  4.54097154e+01  3.35227929e+02  2.02610001e+03  7.31798624e+03]
E1 = -182.4667128790767  E_coul = 54.26818734960147
cycle= 5 E= -128.198525529475  delta_E= -2.86e-10  |g|= 1.53e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4667128790767  E_coul = 54.26818734960147
  HOMO = -0.785109580281841  LUMO = 2.62508743516646
  mo_energy =
[-3.27124741e+01 -1.89736623e+00 -7.85109580e-01 -7.85109580e-01
 -7.85109580e-01  2.62508744e+00  2.62508744e+00  2.62508744e+00
  2.73831423e+00  1.98301686e+01  1.98301686e+01  1.98301686e+01
  4.54097153e+01  3.35227929e+02  2.02610001e+03  7.31798624e+03]
E1 = -182.4667128710985  E_coul = 54.2681873416231
Extra cycle  E= -128.198525529475  delta_E= -1.71e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.09127799939256
E1 = -182.4667128710985  E_coul = 54.2681873416231
init E= -128.198525529475
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785109565722303  LUMO = 2.6250874467911
  mo_energy =
[-3.27124741e+01 -1.89736629e+00 -7.85109566e-01 -7.85109566e-01
 -7.85109566e-01  2.62508745e+00  2.62508745e+00  2.62508745e+00
  2.73831418e+00  1.98301686e+01  1.98301686e+01  1.98301686e+01
  4.54097153e+01  3.35227929e+02  2.02610001e+03  7.31798624e+03]
E1 = -182.46671288144537  E_coul = 54.268187351969864
cycle= 1 E= -128.198525529476  delta_E= -1.14e-13  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46671288144537  E_coul = 54.268187351969864
  HOMO = -0.78510956214228  LUMO = 2.62508744976863
  mo_energy =
[-3.27124741e+01 -1.89736630e+00 -7.85109562e-01 -7.85109562e-01
 -7.85109562e-01  2.62508745e+00  2.62508745e+00  2.62508745e+00
  2.73831417e+00  1.98301686e+01  1.98301686e+01  1.98301686e+01
  4.54097153e+01  3.35227929e+02  2.02610001e+03  7.31798624e+03]
E1 = -182.46671287928257  E_coul = 54.26818734980711
Extra cycle  E= -128.198525529475  delta_E= 5.68e-14  |g|= 9.33e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14461660e+03 2.27481067e+02 1.42700307e+03 5.76074877e-01
 5.00572713e+01 1.32734667e+01 1.93076084e+00 2.77805767e+00
 1.33340316e+01 6.00678629e-01]
grad_E = [-9.94927272e-06  7.15687440e-06  3.37166261e-05  1.42709155e-07
  9.64161061e-07  4.10712563e-07 -4.84279292e-08  2.10542253e-06
  6.25469362e-06  4.58756027e-07]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61659988        1
[INPUT] 0    0    [1    /1   ]  227.481001622        1
[INPUT] 0    0    [1    /1   ]  1427.00309309        1
[INPUT] 0    0    [1    /1   ]  0.576073041798       1
[INPUT] 0    0    [1    /1   ]  50.0571955891        1
[INPUT] 0    0    [1    /1   ]  13.2734412119        1
[INPUT] 0    0    [1    /1   ]  1.93075414351        1
[INPUT] 1    0    [1    /1   ]  2.7780023393         1
[INPUT] 1    0    [1    /1   ]  13.3336825557        1
[INPUT] 1    0    [1    /1   ]  0.600670107492       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6165998845026, 1.0]], [0, [227.48100162191994, 1.0]], [0, [1427.0030930916653, 1.0]], [0, [0.5760730417977201, 1.0]], [0, [50.0571955891362, 1.0]], [0, [13.273441211941524, 1.0]], [0, [1.9307541435075222, 1.0]], [1, [2.7780023392985216, 1.0]], [1, [13.33368255569122, 1.0]], [1, [0.6006701074919072, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61659988]
bas 1, expnt(s) = [227.48100162]
bas 2, expnt(s) = [1427.00309309]
bas 3, expnt(s) = [0.57607304]
bas 4, expnt(s) = [50.05719559]
bas 5, expnt(s) = [13.27344121]
bas 6, expnt(s) = [1.93075414]
bas 7, expnt(s) = [2.77800234]
bas 8, expnt(s) = [13.33368256]
bas 9, expnt(s) = [0.60067011]
CPU time:       152.51
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461660e+03 7.96209347e+02 2.27481002e+02 1.47987105e+02
 1.42700309e+03 5.86588724e+02 5.76073042e-01 1.67060274e+00
 5.00571956e+01 4.75461012e+01 1.32734412e+01 1.75692277e+01
 1.93075414e+00 4.13818837e+00 2.77800234e+00 1.04628537e+01
 1.33336826e+01 7.43313519e+01 6.00670107e-01 1.54269267e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965565778799691
cond(S) = 160.09116677339833
E1 = -183.1369637641386  E_coul = 55.01155138770728
init E= -128.125412376431
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74289755436283  LUMO = 2.65851562926639
  mo_energy =
[-3.25136608e+01 -1.85363518e+00 -7.42897554e-01 -7.42897554e-01
 -7.42897554e-01  2.65851563e+00  2.65851563e+00  2.65851563e+00
  2.77221505e+00  1.99642505e+01  1.99642505e+01  1.99642505e+01
  4.55792238e+01  3.35456136e+02  2.02637087e+03  7.31827979e+03]
E1 = -182.13633661909333  E_coul = 53.93973792090637
cycle= 1 E= -128.196598698187  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259746
diis-c [-0.06746812  1.        ]
  HOMO = -0.807586289087387  LUMO = 2.60463767046679
  mo_energy =
[-3.27863987e+01 -1.92061777e+00 -8.07586289e-01 -8.07586289e-01
 -8.07586289e-01  2.60463767e+00  2.60463767e+00  2.60463767e+00
  2.71837882e+00  1.97741005e+01  1.97741005e+01  1.97741005e+01
  4.53441511e+01  3.35146412e+02  2.02601282e+03  7.31789753e+03]
E1 = -182.5972375271395  E_coul = 54.399015177644735
cycle= 2 E= -128.198222349495  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101541
diis-c [-4.03442751e-04  2.77639424e-01  7.22360576e-01]
  HOMO = -0.784895794096781  LUMO = 2.625194309355
  mo_energy =
[-3.27118594e+01 -1.89707206e+00 -7.84895794e-01 -7.84895794e-01
 -7.84895794e-01  2.62519431e+00  2.62519431e+00  2.62519431e+00
  2.73853125e+00  1.98300879e+01  1.98300879e+01  1.98300879e+01
  4.54101608e+01  3.35227970e+02  2.02609974e+03  7.31798594e+03]
E1 = -182.46546907138608  E_coul = 54.26694357330916
cycle= 3 E= -128.198525498077  delta_E= -0.000303  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000879063
diis-c [-7.41710105e-08 -3.88064792e-03 -1.72854069e-03  1.00560919e+00]
  HOMO = -0.78512645723584  LUMO = 2.62501957465251
  mo_energy =
[-3.27125182e+01 -1.89737154e+00 -7.85126457e-01 -7.85126457e-01
 -7.85126457e-01  2.62501957e+00  2.62501957e+00  2.62501957e+00
  2.73829514e+00  1.98295727e+01  1.98295727e+01  1.98295727e+01
  4.54095414e+01  3.35227471e+02  2.02609938e+03  7.31798561e+03]
E1 = -182.46673935401014  E_coul = 54.26821382297231
cycle= 4 E= -128.198525531038  delta_E= -3.3e-08  |g|= 5.01e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.96763e-05
diis-c [-2.07927659e-10  5.01843025e-04 -8.53644161e-04 -1.69172591e-01
  1.16952439e+00]
  HOMO = -0.785112154948828  LUMO = 2.62503196313244
  mo_energy =
[-3.27124813e+01 -1.89736898e+00 -7.85112155e-01 -7.85112155e-01
 -7.85112155e-01  2.62503196e+00  2.62503196e+00  2.62503196e+00
  2.73829657e+00  1.98296012e+01  1.98296012e+01  1.98296012e+01
  4.54095714e+01  3.35227522e+02  2.02609944e+03  7.31798568e+03]
E1 = -182.46667741298967  E_coul = 54.268151881665624
cycle= 5 E= -128.198525531324  delta_E= -2.86e-10  |g|= 1.53e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46667741298967  E_coul = 54.268151881665624
  HOMO = -0.785112096103933  LUMO = 2.6250320306521
  mo_energy =
[-3.27124812e+01 -1.89736930e+00 -7.85112096e-01 -7.85112096e-01
 -7.85112096e-01  2.62503203e+00  2.62503203e+00  2.62503203e+00
  2.73829629e+00  1.98296012e+01  1.98296012e+01  1.98296012e+01
  4.54095714e+01  3.35227522e+02  2.02609944e+03  7.31798568e+03]
E1 = -182.46667740497122  E_coul = 54.268151873646936
Extra cycle  E= -128.198525531324  delta_E= -2.56e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14461660e+03 2.27481002e+02 1.42700309e+03 5.76073042e-01
 5.00571956e+01 1.32734412e+01 1.93075414e+00 2.77800234e+00
 1.33336826e+01 6.00670107e-01]
E = -128.1985255313243
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61659988        1
[INPUT] 0    0    [1    /1   ]  227.481001622        1
[INPUT] 0    0    [1    /1   ]  1427.00309309        1
[INPUT] 0    0    [1    /1   ]  0.576073041798       1
[INPUT] 0    0    [1    /1   ]  50.0571955891        1
[INPUT] 0    0    [1    /1   ]  13.2734412119        1
[INPUT] 0    0    [1    /1   ]  1.93075414351        1
[INPUT] 1    0    [1    /1   ]  2.7780023393         1
[INPUT] 1    0    [1    /1   ]  13.3336825557        1
[INPUT] 1    0    [1    /1   ]  0.600670107492       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6165998845026, 1.0]], [0, [227.48100162191994, 1.0]], [0, [1427.0030930916653, 1.0]], [0, [0.5760730417977201, 1.0]], [0, [50.0571955891362, 1.0]], [0, [13.273441211941524, 1.0]], [0, [1.9307541435075222, 1.0]], [1, [2.7780023392985216, 1.0]], [1, [13.33368255569122, 1.0]], [1, [0.6006701074919072, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61659988]
bas 1, expnt(s) = [227.48100162]
bas 2, expnt(s) = [1427.00309309]
bas 3, expnt(s) = [0.57607304]
bas 4, expnt(s) = [50.05719559]
bas 5, expnt(s) = [13.27344121]
bas 6, expnt(s) = [1.93075414]
bas 7, expnt(s) = [2.77800234]
bas 8, expnt(s) = [13.33368256]
bas 9, expnt(s) = [0.60067011]
CPU time:       153.30
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461660e+03 7.96209347e+02 2.27481002e+02 1.47987105e+02
 1.42700309e+03 5.86588724e+02 5.76073042e-01 1.67060274e+00
 5.00571956e+01 4.75461012e+01 1.32734412e+01 1.75692277e+01
 1.93075414e+00 4.13818837e+00 2.77800234e+00 1.04628537e+01
 1.33336826e+01 7.43313519e+01 6.00670107e-01 1.54269267e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965565778799691
cond(S) = 160.09116677339833
E1 = -183.1369637641386  E_coul = 55.01155138770728
init E= -128.125412376431
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74289755436283  LUMO = 2.65851562926639
  mo_energy =
[-3.25136608e+01 -1.85363518e+00 -7.42897554e-01 -7.42897554e-01
 -7.42897554e-01  2.65851563e+00  2.65851563e+00  2.65851563e+00
  2.77221505e+00  1.99642505e+01  1.99642505e+01  1.99642505e+01
  4.55792238e+01  3.35456136e+02  2.02637087e+03  7.31827979e+03]
E1 = -182.13633661909333  E_coul = 53.93973792090637
cycle= 1 E= -128.196598698187  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259746
diis-c [-0.06746812  1.        ]
  HOMO = -0.807586289087387  LUMO = 2.60463767046679
  mo_energy =
[-3.27863987e+01 -1.92061777e+00 -8.07586289e-01 -8.07586289e-01
 -8.07586289e-01  2.60463767e+00  2.60463767e+00  2.60463767e+00
  2.71837882e+00  1.97741005e+01  1.97741005e+01  1.97741005e+01
  4.53441511e+01  3.35146412e+02  2.02601282e+03  7.31789753e+03]
E1 = -182.5972375271395  E_coul = 54.399015177644735
cycle= 2 E= -128.198222349495  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101541
diis-c [-4.03442751e-04  2.77639424e-01  7.22360576e-01]
  HOMO = -0.784895794096781  LUMO = 2.625194309355
  mo_energy =
[-3.27118594e+01 -1.89707206e+00 -7.84895794e-01 -7.84895794e-01
 -7.84895794e-01  2.62519431e+00  2.62519431e+00  2.62519431e+00
  2.73853125e+00  1.98300879e+01  1.98300879e+01  1.98300879e+01
  4.54101608e+01  3.35227970e+02  2.02609974e+03  7.31798594e+03]
E1 = -182.46546907138608  E_coul = 54.26694357330916
cycle= 3 E= -128.198525498077  delta_E= -0.000303  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000879063
diis-c [-7.41710105e-08 -3.88064792e-03 -1.72854069e-03  1.00560919e+00]
  HOMO = -0.78512645723584  LUMO = 2.62501957465251
  mo_energy =
[-3.27125182e+01 -1.89737154e+00 -7.85126457e-01 -7.85126457e-01
 -7.85126457e-01  2.62501957e+00  2.62501957e+00  2.62501957e+00
  2.73829514e+00  1.98295727e+01  1.98295727e+01  1.98295727e+01
  4.54095414e+01  3.35227471e+02  2.02609938e+03  7.31798561e+03]
E1 = -182.46673935401014  E_coul = 54.26821382297231
cycle= 4 E= -128.198525531038  delta_E= -3.3e-08  |g|= 5.01e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.96763e-05
diis-c [-2.07927659e-10  5.01843025e-04 -8.53644161e-04 -1.69172591e-01
  1.16952439e+00]
  HOMO = -0.785112154948828  LUMO = 2.62503196313244
  mo_energy =
[-3.27124813e+01 -1.89736898e+00 -7.85112155e-01 -7.85112155e-01
 -7.85112155e-01  2.62503196e+00  2.62503196e+00  2.62503196e+00
  2.73829657e+00  1.98296012e+01  1.98296012e+01  1.98296012e+01
  4.54095714e+01  3.35227522e+02  2.02609944e+03  7.31798568e+03]
E1 = -182.46667741298967  E_coul = 54.268151881665624
cycle= 5 E= -128.198525531324  delta_E= -2.86e-10  |g|= 1.53e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46667741298967  E_coul = 54.268151881665624
  HOMO = -0.785112096103933  LUMO = 2.6250320306521
  mo_energy =
[-3.27124812e+01 -1.89736930e+00 -7.85112096e-01 -7.85112096e-01
 -7.85112096e-01  2.62503203e+00  2.62503203e+00  2.62503203e+00
  2.73829629e+00  1.98296012e+01  1.98296012e+01  1.98296012e+01
  4.54095714e+01  3.35227522e+02  2.02609944e+03  7.31798568e+03]
E1 = -182.46667740497122  E_coul = 54.268151873646936
Extra cycle  E= -128.198525531324  delta_E= -2.56e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.09116677339833
E1 = -182.46667740497122  E_coul = 54.268151873646936
init E= -128.198525531324
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785112081547138  LUMO = 2.62503204227391
  mo_energy =
[-3.27124812e+01 -1.89736936e+00 -7.85112082e-01 -7.85112082e-01
 -7.85112082e-01  2.62503204e+00  2.62503204e+00  2.62503204e+00
  2.73829624e+00  1.98296012e+01  1.98296012e+01  1.98296012e+01
  4.54095714e+01  3.35227522e+02  2.02609944e+03  7.31798568e+03]
E1 = -182.46667741533037  E_coul = 54.26815188400588
cycle= 1 E= -128.198525531324  delta_E= -1.99e-13  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46667741533037  E_coul = 54.26815188400588
  HOMO = -0.785112077966237  LUMO = 2.62503204525215
  mo_energy =
[-3.27124812e+01 -1.89736937e+00 -7.85112078e-01 -7.85112078e-01
 -7.85112078e-01  2.62503205e+00  2.62503205e+00  2.62503205e+00
  2.73829623e+00  1.98296012e+01  1.98296012e+01  1.98296012e+01
  4.54095714e+01  3.35227522e+02  2.02609944e+03  7.31798568e+03]
E1 = -182.46667741316207  E_coul = 54.26815188183785
Extra cycle  E= -128.198525531324  delta_E= 2.84e-13  |g|= 9.33e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14461660e+03 2.27481002e+02 1.42700309e+03 5.76073042e-01
 5.00571956e+01 1.32734412e+01 1.93075414e+00 2.77800234e+00
 1.33336826e+01 6.00670107e-01]
grad_E = [-9.94927963e-06  7.16600320e-06  3.37165610e-05 -3.42738304e-07
  9.53992231e-07  7.22562670e-08  5.79747619e-08 -7.92383982e-07
  5.26763111e-06 -3.56309613e-07]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61660239        1
[INPUT] 0    0    [1    /1   ]  227.480653726        1
[INPUT] 0    0    [1    /1   ]  1427.00311395        1
[INPUT] 0    0    [1    /1   ]  0.576070805691       1
[INPUT] 0    0    [1    /1   ]  50.0570805041        1
[INPUT] 0    0    [1    /1   ]  13.2734079557        1
[INPUT] 0    0    [1    /1   ]  1.93074616658        1
[INPUT] 1    0    [1    /1   ]  2.77794475327        1
[INPUT] 1    0    [1    /1   ]  13.3333299882        1
[INPUT] 1    0    [1    /1   ]  0.600661130081       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6166023874252, 1.0]], [0, [227.48065372563033, 1.0]], [0, [1427.0031139546543, 1.0]], [0, [0.5760708056906997, 1.0]], [0, [50.05708050409208, 1.0]], [0, [13.27340795571009, 1.0]], [0, [1.9307461665791967, 1.0]], [1, [2.7779447532668877, 1.0]], [1, [13.333329988174944, 1.0]], [1, [0.600661130081305, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61660239]
bas 1, expnt(s) = [227.48065373]
bas 2, expnt(s) = [1427.00311395]
bas 3, expnt(s) = [0.57607081]
bas 4, expnt(s) = [50.0570805]
bas 5, expnt(s) = [13.27340796]
bas 6, expnt(s) = [1.93074617]
bas 7, expnt(s) = [2.77794475]
bas 8, expnt(s) = [13.33332999]
bas 9, expnt(s) = [0.60066113]
CPU time:       155.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461660e+03 7.96209348e+02 2.27480654e+02 1.47986935e+02
 1.42700311e+03 5.86588730e+02 5.76070806e-01 1.67059787e+00
 5.00570805e+01 4.75460192e+01 1.32734080e+01 1.75691947e+01
 1.93074617e+00 4.13817555e+00 2.77794475e+00 1.04625826e+01
 1.33333300e+01 7.43288951e+01 6.00661130e-01 1.54266385e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965567680057204
cond(S) = 160.09092457935444
E1 = -183.1369633780196  E_coul = 55.01155002525062
init E= -128.125413352769
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897518268425  LUMO = 2.65845917841965
  mo_energy =
[-3.25136618e+01 -1.85363518e+00 -7.42897518e-01 -7.42897518e-01
 -7.42897518e-01  2.65845918e+00  2.65845918e+00  2.65845918e+00
  2.77219653e+00  1.99636744e+01  1.99636744e+01  1.99636744e+01
  4.55790397e+01  3.35455346e+02  2.02636929e+03  7.31827808e+03]
E1 = -182.1362834792538  E_coul = 53.939684941043545
cycle= 1 E= -128.19659853821  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259756
diis-c [-0.06747294  1.        ]
  HOMO = -0.807590056658568  LUMO = 2.60457883007647
  mo_energy =
[-3.27864095e+01 -1.92062215e+00 -8.07590057e-01 -8.07590057e-01
 -8.07590057e-01  2.60457883e+00  2.60457883e+00  2.60457883e+00
  2.71835669e+00  1.97735187e+01  1.97735187e+01  1.97735187e+01
  4.53439582e+01  3.35145611e+02  2.02601124e+03  7.31789581e+03]
E1 = -182.59720697550392  E_coul = 54.39898465347429
cycle= 2 E= -128.19822232203  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101546
diis-c [-4.03453246e-04  2.77642567e-01  7.22357433e-01]
  HOMO = -0.784898511453409  LUMO = 2.62513604218486
  mo_energy =
[-3.27118671e+01 -1.89707534e+00 -7.84898511e-01 -7.84898511e-01
 -7.84898511e-01  2.62513604e+00  2.62513604e+00  2.62513604e+00
  2.73850997e+00  1.98295080e+01  1.98295080e+01  1.98295080e+01
  4.54099707e+01  3.35227173e+02  2.02609816e+03  7.31798422e+03]
E1 = -182.4654315374859  E_coul = 54.266906035942455
cycle= 3 E= -128.198525501543  delta_E= -0.000303  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000878926
diis-c [-7.42011854e-08 -3.88083557e-03 -1.73100551e-03  1.00561184e+00]
  HOMO = -0.785129138067502  LUMO = 2.62496134633101
  mo_energy =
[-3.27125258e+01 -1.89737480e+00 -7.85129138e-01 -7.85129138e-01
 -7.85129138e-01  2.62496135e+00  2.62496135e+00  2.62496135e+00
  2.73827388e+00  1.98289928e+01  1.98289928e+01  1.98289928e+01
  4.54093514e+01  3.35226674e+02  2.02609780e+03  7.31798389e+03]
E1 = -182.4667016424958  E_coul = 54.26817610799628
cycle= 4 E= -128.1985255345  delta_E= -3.3e-08  |g|= 5.01e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.96923e-05
diis-c [-2.07971700e-10  5.01867109e-04 -8.53428671e-04 -1.69182462e-01
  1.16953402e+00]
  HOMO = -0.785114833232769  LUMO = 2.62497373673579
  mo_energy =
[-3.27124889e+01 -1.89737224e+00 -7.85114833e-01 -7.85114833e-01
 -7.85114833e-01  2.62497374e+00  2.62497374e+00  2.62497374e+00
  2.73827531e+00  1.98290214e+01  1.98290214e+01  1.98290214e+01
  4.54093815e+01  3.35226725e+02  2.02609786e+03  7.31798396e+03]
E1 = -182.46663969041415  E_coul = 54.26811415562815
cycle= 5 E= -128.198525534786  delta_E= -2.86e-10  |g|= 1.53e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46663969041415  E_coul = 54.26811415562815
  HOMO = -0.785114774385151  LUMO = 2.62497380426126
  mo_energy =
[-3.27124888e+01 -1.89737256e+00 -7.85114774e-01 -7.85114774e-01
 -7.85114774e-01  2.62497380e+00  2.62497380e+00  2.62497380e+00
  2.73827503e+00  1.98290214e+01  1.98290214e+01  1.98290214e+01
  4.54093814e+01  3.35226725e+02  2.02609786e+03  7.31798396e+03]
E1 = -182.46663968234176  E_coul = 54.26811414755553
Extra cycle  E= -128.198525534786  delta_E= -2.27e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14461660e+03 2.27480654e+02 1.42700311e+03 5.76070806e-01
 5.00570805e+01 1.32734080e+01 1.93074617e+00 2.77794475e+00
 1.33333300e+01 6.00661130e-01]
E = -128.19852553478623
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61660239        1
[INPUT] 0    0    [1    /1   ]  227.480653726        1
[INPUT] 0    0    [1    /1   ]  1427.00311395        1
[INPUT] 0    0    [1    /1   ]  0.576070805691       1
[INPUT] 0    0    [1    /1   ]  50.0570805041        1
[INPUT] 0    0    [1    /1   ]  13.2734079557        1
[INPUT] 0    0    [1    /1   ]  1.93074616658        1
[INPUT] 1    0    [1    /1   ]  2.77794475327        1
[INPUT] 1    0    [1    /1   ]  13.3333299882        1
[INPUT] 1    0    [1    /1   ]  0.600661130081       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6166023874252, 1.0]], [0, [227.48065372563033, 1.0]], [0, [1427.0031139546543, 1.0]], [0, [0.5760708056906997, 1.0]], [0, [50.05708050409208, 1.0]], [0, [13.27340795571009, 1.0]], [0, [1.9307461665791967, 1.0]], [1, [2.7779447532668877, 1.0]], [1, [13.333329988174944, 1.0]], [1, [0.600661130081305, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61660239]
bas 1, expnt(s) = [227.48065373]
bas 2, expnt(s) = [1427.00311395]
bas 3, expnt(s) = [0.57607081]
bas 4, expnt(s) = [50.0570805]
bas 5, expnt(s) = [13.27340796]
bas 6, expnt(s) = [1.93074617]
bas 7, expnt(s) = [2.77794475]
bas 8, expnt(s) = [13.33332999]
bas 9, expnt(s) = [0.60066113]
CPU time:       156.68
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461660e+03 7.96209348e+02 2.27480654e+02 1.47986935e+02
 1.42700311e+03 5.86588730e+02 5.76070806e-01 1.67059787e+00
 5.00570805e+01 4.75460192e+01 1.32734080e+01 1.75691947e+01
 1.93074617e+00 4.13817555e+00 2.77794475e+00 1.04625826e+01
 1.33333300e+01 7.43288951e+01 6.00661130e-01 1.54266385e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965567680057204
cond(S) = 160.09092457935444
E1 = -183.1369633780196  E_coul = 55.01155002525062
init E= -128.125413352769
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897518268425  LUMO = 2.65845917841965
  mo_energy =
[-3.25136618e+01 -1.85363518e+00 -7.42897518e-01 -7.42897518e-01
 -7.42897518e-01  2.65845918e+00  2.65845918e+00  2.65845918e+00
  2.77219653e+00  1.99636744e+01  1.99636744e+01  1.99636744e+01
  4.55790397e+01  3.35455346e+02  2.02636929e+03  7.31827808e+03]
E1 = -182.1362834792538  E_coul = 53.939684941043545
cycle= 1 E= -128.19659853821  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259756
diis-c [-0.06747294  1.        ]
  HOMO = -0.807590056658568  LUMO = 2.60457883007647
  mo_energy =
[-3.27864095e+01 -1.92062215e+00 -8.07590057e-01 -8.07590057e-01
 -8.07590057e-01  2.60457883e+00  2.60457883e+00  2.60457883e+00
  2.71835669e+00  1.97735187e+01  1.97735187e+01  1.97735187e+01
  4.53439582e+01  3.35145611e+02  2.02601124e+03  7.31789581e+03]
E1 = -182.59720697550392  E_coul = 54.39898465347429
cycle= 2 E= -128.19822232203  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101546
diis-c [-4.03453246e-04  2.77642567e-01  7.22357433e-01]
  HOMO = -0.784898511453409  LUMO = 2.62513604218486
  mo_energy =
[-3.27118671e+01 -1.89707534e+00 -7.84898511e-01 -7.84898511e-01
 -7.84898511e-01  2.62513604e+00  2.62513604e+00  2.62513604e+00
  2.73850997e+00  1.98295080e+01  1.98295080e+01  1.98295080e+01
  4.54099707e+01  3.35227173e+02  2.02609816e+03  7.31798422e+03]
E1 = -182.4654315374859  E_coul = 54.266906035942455
cycle= 3 E= -128.198525501543  delta_E= -0.000303  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000878926
diis-c [-7.42011854e-08 -3.88083557e-03 -1.73100551e-03  1.00561184e+00]
  HOMO = -0.785129138067502  LUMO = 2.62496134633101
  mo_energy =
[-3.27125258e+01 -1.89737480e+00 -7.85129138e-01 -7.85129138e-01
 -7.85129138e-01  2.62496135e+00  2.62496135e+00  2.62496135e+00
  2.73827388e+00  1.98289928e+01  1.98289928e+01  1.98289928e+01
  4.54093514e+01  3.35226674e+02  2.02609780e+03  7.31798389e+03]
E1 = -182.4667016424958  E_coul = 54.26817610799628
cycle= 4 E= -128.1985255345  delta_E= -3.3e-08  |g|= 5.01e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.96923e-05
diis-c [-2.07971700e-10  5.01867109e-04 -8.53428671e-04 -1.69182462e-01
  1.16953402e+00]
  HOMO = -0.785114833232769  LUMO = 2.62497373673579
  mo_energy =
[-3.27124889e+01 -1.89737224e+00 -7.85114833e-01 -7.85114833e-01
 -7.85114833e-01  2.62497374e+00  2.62497374e+00  2.62497374e+00
  2.73827531e+00  1.98290214e+01  1.98290214e+01  1.98290214e+01
  4.54093815e+01  3.35226725e+02  2.02609786e+03  7.31798396e+03]
E1 = -182.46663969041415  E_coul = 54.26811415562815
cycle= 5 E= -128.198525534786  delta_E= -2.86e-10  |g|= 1.53e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46663969041415  E_coul = 54.26811415562815
  HOMO = -0.785114774385151  LUMO = 2.62497380426126
  mo_energy =
[-3.27124888e+01 -1.89737256e+00 -7.85114774e-01 -7.85114774e-01
 -7.85114774e-01  2.62497380e+00  2.62497380e+00  2.62497380e+00
  2.73827503e+00  1.98290214e+01  1.98290214e+01  1.98290214e+01
  4.54093814e+01  3.35226725e+02  2.02609786e+03  7.31798396e+03]
E1 = -182.46663968234176  E_coul = 54.26811414755553
Extra cycle  E= -128.198525534786  delta_E= -2.27e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.09092457935444
E1 = -182.46663968234176  E_coul = 54.26811414755553
init E= -128.198525534786
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785114759831922  LUMO = 2.62497381587947
  mo_energy =
[-3.27124888e+01 -1.89737262e+00 -7.85114760e-01 -7.85114760e-01
 -7.85114760e-01  2.62497382e+00  2.62497382e+00  2.62497382e+00
  2.73827498e+00  1.98290214e+01  1.98290214e+01  1.98290214e+01
  4.54093814e+01  3.35226725e+02  2.02609786e+03  7.31798396e+03]
E1 = -182.4666396927185  E_coul = 54.26811415793226
cycle= 1 E= -128.198525534786  delta_E= -2.84e-14  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4666396927185  E_coul = 54.26811415793226
  HOMO = -0.785114756249752  LUMO = 2.62497381885878
  mo_energy =
[-3.27124888e+01 -1.89737262e+00 -7.85114756e-01 -7.85114756e-01
 -7.85114756e-01  2.62497382e+00  2.62497382e+00  2.62497382e+00
  2.73827497e+00  1.98290214e+01  1.98290214e+01  1.98290214e+01
  4.54093814e+01  3.35226725e+02  2.02609786e+03  7.31798396e+03]
E1 = -182.46663969054288  E_coul = 54.26811415575651
Extra cycle  E= -128.198525534786  delta_E= -1.14e-13  |g|= 9.33e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14461660e+03 2.27480654e+02 1.42700311e+03 5.76070806e-01
 5.00570805e+01 1.32734080e+01 1.93074617e+00 2.77794475e+00
 1.33333300e+01 6.00661130e-01]
grad_E = [-9.94924079e-06  7.16762710e-06  3.37167603e-05 -9.33172863e-07
  9.76339218e-07 -3.65473441e-07  1.99968963e-07 -4.46123514e-06
  4.37815054e-06 -1.37989890e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.6166263         1
[INPUT] 0    0    [1    /1   ]  227.480125468        1
[INPUT] 0    0    [1    /1   ]  1427.00307613        1
[INPUT] 0    0    [1    /1   ]  0.576067782828       1
[INPUT] 0    0    [1    /1   ]  50.0569209677        1
[INPUT] 0    0    [1    /1   ]  13.273362415         1
[INPUT] 0    0    [1    /1   ]  1.93073550446        1
[INPUT] 1    0    [1    /1   ]  2.77787271659        1
[INPUT] 1    0    [1    /1   ]  13.3328978507        1
[INPUT] 1    0    [1    /1   ]  0.600649810146       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.616626295586, 1.0]], [0, [227.48012546847986, 1.0]], [0, [1427.0030761250675, 1.0]], [0, [0.5760677828278611, 1.0]], [0, [50.05692096769806, 1.0]], [0, [13.273362415039156, 1.0]], [0, [1.9307355044564851, 1.0]], [1, [2.7778727165859007, 1.0]], [1, [13.332897850746647, 1.0]], [1, [0.6006498101462046, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.6166263]
bas 1, expnt(s) = [227.48012547]
bas 2, expnt(s) = [1427.00307613]
bas 3, expnt(s) = [0.57606778]
bas 4, expnt(s) = [50.05692097]
bas 5, expnt(s) = [13.27336242]
bas 6, expnt(s) = [1.9307355]
bas 7, expnt(s) = [2.77787272]
bas 8, expnt(s) = [13.33289785]
bas 9, expnt(s) = [0.60064981]
CPU time:       159.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461663e+03 7.96209354e+02 2.27480125e+02 1.47986677e+02
 1.42700308e+03 5.86588719e+02 5.76067783e-01 1.67059130e+00
 5.00569210e+01 4.75459056e+01 1.32733624e+01 1.75691495e+01
 1.93073550e+00 4.13815841e+00 2.77787272e+00 1.04622434e+01
 1.33328979e+01 7.43258838e+01 6.00649810e-01 1.54262751e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965570078297173
cond(S) = 160.09053810246704
E1 = -183.13696288603344  E_coul = 55.01154829216021
init E= -128.125414593873
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897485145084  LUMO = 2.65838813096346
  mo_energy =
[-3.25136629e+01 -1.85363519e+00 -7.42897485e-01 -7.42897485e-01
 -7.42897485e-01  2.65838813e+00  2.65838813e+00  2.65838813e+00
  2.77217160e+00  1.99629628e+01  1.99629628e+01  1.99629628e+01
  4.55787882e+01  3.35454215e+02  2.02636694e+03  7.31827544e+03]
E1 = -182.13621610231283  E_coul = 53.93961776472804
cycle= 1 E= -128.196598337585  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259767
diis-c [-0.06747905  1.        ]
  HOMO = -0.807594835359241  LUMO = 2.60450474692573
  mo_energy =
[-3.27864233e+01 -1.92062771e+00 -8.07594835e-01 -8.07594835e-01
 -8.07594835e-01  2.60450475e+00  2.60450475e+00  2.60450475e+00
  2.71832723e+00  1.97727997e+01  1.97727997e+01  1.97727997e+01
  4.53436955e+01  3.35144467e+02  2.02600887e+03  7.31789316e+03]
E1 = -182.59716821254827  E_coul = 54.39894592309024
cycle= 2 E= -128.198222289458  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101553
diis-c [-4.03466390e-04  2.77646527e-01  7.22353473e-01]
  HOMO = -0.784901959187694  LUMO = 2.62506268967373
  mo_energy =
[-3.27118768e+01 -1.89707949e+00 -7.84901959e-01 -7.84901959e-01
 -7.84901959e-01  2.62506269e+00  2.62506269e+00  2.62506269e+00
  2.73848159e+00  1.98287915e+01  1.98287915e+01  1.98287915e+01
  4.54097115e+01  3.35226033e+02  2.02609580e+03  7.31798157e+03]
E1 = -182.46538393871003  E_coul = 54.266858430587064
cycle= 3 E= -128.198525508123  delta_E= -0.000303  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000878753
diis-c [-7.42391093e-08 -3.88106967e-03 -1.73411560e-03  1.00561519e+00]
  HOMO = -0.785132539580121  LUMO = 2.62488804296122
  mo_energy =
[-3.27125354e+01 -1.89737892e+00 -7.85132540e-01 -7.85132540e-01
 -7.85132540e-01  2.62488804e+00  2.62488804e+00  2.62488804e+00
  2.73824552e+00  1.98282764e+01  1.98282764e+01  1.98282764e+01
  4.54090923e+01  3.35225534e+02  2.02609544e+03  7.31798124e+03]
E1 = -182.46665381878717  E_coul = 54.26812827771405
cycle= 4 E= -128.198525541073  delta_E= -3.3e-08  |g|= 5.01e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.97125e-05
diis-c [-2.08027982e-10  5.01896207e-04 -8.53155368e-04 -1.69194639e-01
  1.16954590e+00]
  HOMO = -0.785118231545403  LUMO = 2.62490043578351
  mo_energy =
[-3.27124985e+01 -1.89737637e+00 -7.85118232e-01 -7.85118232e-01
 -7.85118232e-01  2.62490044e+00  2.62490044e+00  2.62490044e+00
  2.73824695e+00  1.98283049e+01  1.98283049e+01  1.98283049e+01
  4.54091224e+01  3.35225585e+02  2.02609550e+03  7.31798131e+03]
E1 = -182.46659185281857  E_coul = 54.26806631145881
cycle= 5 E= -128.19852554136  delta_E= -2.87e-10  |g|= 1.54e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46659185281857  E_coul = 54.26806631145881
  HOMO = -0.785118172692294  LUMO = 2.62490050331808
  mo_energy =
[-3.27124984e+01 -1.89737669e+00 -7.85118173e-01 -7.85118173e-01
 -7.85118173e-01  2.62490050e+00  2.62490050e+00  2.62490050e+00
  2.73824667e+00  1.98283049e+01  1.98283049e+01  1.98283049e+01
  4.54091224e+01  3.35225585e+02  2.02609550e+03  7.31798131e+03]
E1 = -182.46659184466955  E_coul = 54.2680663033095
Extra cycle  E= -128.19852554136  delta_E= -3.13e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14461663e+03 2.27480125e+02 1.42700308e+03 5.76067783e-01
 5.00569210e+01 1.32733624e+01 1.93073550e+00 2.77787272e+00
 1.33328979e+01 6.00649810e-01]
E = -128.19852554136006
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.6166263         1
[INPUT] 0    0    [1    /1   ]  227.480125468        1
[INPUT] 0    0    [1    /1   ]  1427.00307613        1
[INPUT] 0    0    [1    /1   ]  0.576067782828       1
[INPUT] 0    0    [1    /1   ]  50.0569209677        1
[INPUT] 0    0    [1    /1   ]  13.273362415         1
[INPUT] 0    0    [1    /1   ]  1.93073550446        1
[INPUT] 1    0    [1    /1   ]  2.77787271659        1
[INPUT] 1    0    [1    /1   ]  13.3328978507        1
[INPUT] 1    0    [1    /1   ]  0.600649810146       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.616626295586, 1.0]], [0, [227.48012546847986, 1.0]], [0, [1427.0030761250675, 1.0]], [0, [0.5760677828278611, 1.0]], [0, [50.05692096769806, 1.0]], [0, [13.273362415039156, 1.0]], [0, [1.9307355044564851, 1.0]], [1, [2.7778727165859007, 1.0]], [1, [13.332897850746647, 1.0]], [1, [0.6006498101462046, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.6166263]
bas 1, expnt(s) = [227.48012547]
bas 2, expnt(s) = [1427.00307613]
bas 3, expnt(s) = [0.57606778]
bas 4, expnt(s) = [50.05692097]
bas 5, expnt(s) = [13.27336242]
bas 6, expnt(s) = [1.9307355]
bas 7, expnt(s) = [2.77787272]
bas 8, expnt(s) = [13.33289785]
bas 9, expnt(s) = [0.60064981]
CPU time:       160.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461663e+03 7.96209354e+02 2.27480125e+02 1.47986677e+02
 1.42700308e+03 5.86588719e+02 5.76067783e-01 1.67059130e+00
 5.00569210e+01 4.75459056e+01 1.32733624e+01 1.75691495e+01
 1.93073550e+00 4.13815841e+00 2.77787272e+00 1.04622434e+01
 1.33328979e+01 7.43258838e+01 6.00649810e-01 1.54262751e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965570078297173
cond(S) = 160.09053810246704
E1 = -183.13696288603344  E_coul = 55.01154829216021
init E= -128.125414593873
    CPU time for initialize scf      0.02 sec, wall time      0.03 sec
  HOMO = -0.742897485145084  LUMO = 2.65838813096346
  mo_energy =
[-3.25136629e+01 -1.85363519e+00 -7.42897485e-01 -7.42897485e-01
 -7.42897485e-01  2.65838813e+00  2.65838813e+00  2.65838813e+00
  2.77217160e+00  1.99629628e+01  1.99629628e+01  1.99629628e+01
  4.55787882e+01  3.35454215e+02  2.02636694e+03  7.31827544e+03]
E1 = -182.13621610231283  E_coul = 53.93961776472804
cycle= 1 E= -128.196598337585  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259767
diis-c [-0.06747905  1.        ]
  HOMO = -0.807594835359241  LUMO = 2.60450474692573
  mo_energy =
[-3.27864233e+01 -1.92062771e+00 -8.07594835e-01 -8.07594835e-01
 -8.07594835e-01  2.60450475e+00  2.60450475e+00  2.60450475e+00
  2.71832723e+00  1.97727997e+01  1.97727997e+01  1.97727997e+01
  4.53436955e+01  3.35144467e+02  2.02600887e+03  7.31789316e+03]
E1 = -182.59716821254827  E_coul = 54.39894592309024
cycle= 2 E= -128.198222289458  delta_E= -0.00162  |g|= 0.0623  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101553
diis-c [-4.03466390e-04  2.77646527e-01  7.22353473e-01]
  HOMO = -0.784901959187694  LUMO = 2.62506268967373
  mo_energy =
[-3.27118768e+01 -1.89707949e+00 -7.84901959e-01 -7.84901959e-01
 -7.84901959e-01  2.62506269e+00  2.62506269e+00  2.62506269e+00
  2.73848159e+00  1.98287915e+01  1.98287915e+01  1.98287915e+01
  4.54097115e+01  3.35226033e+02  2.02609580e+03  7.31798157e+03]
E1 = -182.46538393871003  E_coul = 54.266858430587064
cycle= 3 E= -128.198525508123  delta_E= -0.000303  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000878753
diis-c [-7.42391093e-08 -3.88106967e-03 -1.73411560e-03  1.00561519e+00]
  HOMO = -0.785132539580121  LUMO = 2.62488804296122
  mo_energy =
[-3.27125354e+01 -1.89737892e+00 -7.85132540e-01 -7.85132540e-01
 -7.85132540e-01  2.62488804e+00  2.62488804e+00  2.62488804e+00
  2.73824552e+00  1.98282764e+01  1.98282764e+01  1.98282764e+01
  4.54090923e+01  3.35225534e+02  2.02609544e+03  7.31798124e+03]
E1 = -182.46665381878717  E_coul = 54.26812827771405
cycle= 4 E= -128.198525541073  delta_E= -3.3e-08  |g|= 5.01e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.97125e-05
diis-c [-2.08027982e-10  5.01896207e-04 -8.53155368e-04 -1.69194639e-01
  1.16954590e+00]
  HOMO = -0.785118231545403  LUMO = 2.62490043578351
  mo_energy =
[-3.27124985e+01 -1.89737637e+00 -7.85118232e-01 -7.85118232e-01
 -7.85118232e-01  2.62490044e+00  2.62490044e+00  2.62490044e+00
  2.73824695e+00  1.98283049e+01  1.98283049e+01  1.98283049e+01
  4.54091224e+01  3.35225585e+02  2.02609550e+03  7.31798131e+03]
E1 = -182.46659185281857  E_coul = 54.26806631145881
cycle= 5 E= -128.19852554136  delta_E= -2.87e-10  |g|= 1.54e-06  |ddm|= 2.53e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46659185281857  E_coul = 54.26806631145881
  HOMO = -0.785118172692294  LUMO = 2.62490050331808
  mo_energy =
[-3.27124984e+01 -1.89737669e+00 -7.85118173e-01 -7.85118173e-01
 -7.85118173e-01  2.62490050e+00  2.62490050e+00  2.62490050e+00
  2.73824667e+00  1.98283049e+01  1.98283049e+01  1.98283049e+01
  4.54091224e+01  3.35225585e+02  2.02609550e+03  7.31798131e+03]
E1 = -182.46659184466955  E_coul = 54.2680663033095
Extra cycle  E= -128.19852554136  delta_E= -3.13e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.09053810246704
E1 = -182.46659184466955  E_coul = 54.2680663033095
init E= -128.19852554136
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785118158144072  LUMO = 2.62490051493127
  mo_energy =
[-3.27124984e+01 -1.89737674e+00 -7.85118158e-01 -7.85118158e-01
 -7.85118158e-01  2.62490051e+00  2.62490051e+00  2.62490051e+00
  2.73824662e+00  1.98283050e+01  1.98283050e+01  1.98283050e+01
  4.54091223e+01  3.35225585e+02  2.02609550e+03  7.31798131e+03]
E1 = -182.46659185507147  E_coul = 54.26806631371131
cycle= 1 E= -128.19852554136  delta_E= -1.14e-13  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46659185507147  E_coul = 54.26806631371131
  HOMO = -0.785118154560081  LUMO = 2.62490051791212
  mo_energy =
[-3.27124984e+01 -1.89737675e+00 -7.85118155e-01 -7.85118155e-01
 -7.85118155e-01  2.62490052e+00  2.62490052e+00  2.62490052e+00
  2.73824661e+00  1.98283050e+01  1.98283050e+01  1.98283050e+01
  4.54091223e+01  3.35225585e+02  2.02609550e+03  7.31798131e+03]
E1 = -182.46659185288496  E_coul = 54.26806631152495
Extra cycle  E= -128.19852554136  delta_E= 1.42e-13  |g|= 9.33e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14461663e+03 2.27480125e+02 1.42700308e+03 5.76067783e-01
 5.00569210e+01 1.32733624e+01 1.93073550e+00 2.77787272e+00
 1.33328979e+01 6.00649810e-01]
grad_E = [-9.94918032e-06  7.16739393e-06  3.37170953e-05 -1.74532600e-06
  1.01914890e-06 -9.79030359e-07  4.01221542e-07 -9.59129632e-06
  3.37950950e-06 -2.80595491e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61669491        1
[INPUT] 0    0    [1    /1   ]  227.479328229        1
[INPUT] 0    0    [1    /1   ]  1427.00290676        1
[INPUT] 0    0    [1    /1   ]  0.576063400887       1
[INPUT] 0    0    [1    /1   ]  50.0566878052        1
[INPUT] 0    0    [1    /1   ]  13.2732960363        1
[INPUT] 0    0    [1    /1   ]  1.93072013986        1
[INPUT] 1    0    [1    /1   ]  2.77777257366        1
[INPUT] 1    0    [1    /1   ]  13.3323043634        1
[INPUT] 1    0    [1    /1   ]  0.600634000388       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.616694910437, 1.0]], [0, [227.4793282286873, 1.0]], [0, [1427.002906764471, 1.0]], [0, [0.5760634008871863, 1.0]], [0, [50.05668780524202, 1.0]], [0, [13.273296036324606, 1.0]], [0, [1.9307201398632334, 1.0]], [1, [2.7777725736616263, 1.0]], [1, [13.332304363386736, 1.0]], [1, [0.600634000387509, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61669491]
bas 1, expnt(s) = [227.47932823]
bas 2, expnt(s) = [1427.00290676]
bas 3, expnt(s) = [0.5760634]
bas 4, expnt(s) = [50.05668781]
bas 5, expnt(s) = [13.27329604]
bas 6, expnt(s) = [1.93072014]
bas 7, expnt(s) = [2.77777257]
bas 8, expnt(s) = [13.33230436]
bas 9, expnt(s) = [0.600634]
CPU time:       162.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461669e+03 7.96209374e+02 2.27479328e+02 1.47986288e+02
 1.42700291e+03 5.86588666e+02 5.76063401e-01 1.67058177e+00
 5.00566878e+01 4.75457395e+01 1.32732960e+01 1.75690836e+01
 1.93072014e+00 4.13813371e+00 2.77777257e+00 1.04617720e+01
 1.33323044e+01 7.43217483e+01 6.00634000e-01 1.54257676e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965573428233837
cond(S) = 160.0899016562802
E1 = -183.13696219479098  E_coul = 55.011545858830324
init E= -128.125416335961
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897448822802  LUMO = 2.65828901256286
  mo_energy =
[-3.25136645e+01 -1.85363521e+00 -7.42897449e-01 -7.42897449e-01
 -7.42897449e-01  2.65828901e+00  2.65828901e+00  2.65828901e+00
  2.77213555e+00  1.99619808e+01  1.99619808e+01  1.99619808e+01
  4.55784223e+01  3.35452542e+02  2.02636337e+03  7.31827130e+03]
E1 = -182.1361217058539  E_coul = 53.939523646076665
cycle= 1 E= -128.196598059777  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259784
diis-c [-0.06748761  1.        ]
  HOMO = -0.807601531761799  LUMO = 2.60440137091005
  mo_energy =
[-3.27864425e+01 -1.92063550e+00 -8.07601532e-01 -8.07601532e-01
 -8.07601532e-01  2.60440137e+00  2.60440137e+00  2.60440137e+00
  2.71828487e+00  1.97718074e+01  1.97718074e+01  1.97718074e+01
  4.53433139e+01  3.35142776e+02  2.02600528e+03  7.31788899e+03]
E1 = -182.59711388487722  E_coul = 54.39889163773619
cycle= 2 E= -128.198222247141  delta_E= -0.00162  |g|= 0.0624  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101562
diis-c [-4.03484609e-04  2.77652056e-01  7.22347944e-01]
  HOMO = -0.784906791402965  LUMO = 2.62496034028519
  mo_energy =
[-3.27118905e+01 -1.89708531e+00 -7.84906791e-01 -7.84906791e-01
 -7.84906791e-01  2.62496034e+00  2.62496034e+00  2.62496034e+00
  2.73844072e+00  1.98278026e+01  1.98278026e+01  1.98278026e+01
  4.54093348e+01  3.35224348e+02  2.02609222e+03  7.31797741e+03]
E1 = -182.46531724561677  E_coul = 54.26679172500946
cycle= 3 E= -128.198525520607  delta_E= -0.000303  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00087851
diis-c [-7.42919934e-08 -3.88139503e-03 -1.73846454e-03  1.00561986e+00]
  HOMO = -0.785137307044345  LUMO = 2.62478576238553
  mo_energy =
[-3.27125489e+01 -1.89738470e+00 -7.85137307e-01 -7.85137307e-01
 -7.85137307e-01  2.62478576e+00  2.62478576e+00  2.62478576e+00
  2.73820470e+00  1.98272877e+01  1.98272877e+01  1.98272877e+01
  4.54087158e+01  3.35223849e+02  2.02609185e+03  7.31797708e+03]
E1 = -182.4665868103997  E_coul = 54.26806125685054
cycle= 4 E= -128.198525553549  delta_E= -3.29e-08  |g|= 5.01e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.97405e-05
diis-c [-2.08107173e-10  5.01936065e-04 -8.52771450e-04 -1.69211448e-01
  1.16956228e+00]
  HOMO = -0.785122994549224  LUMO = 2.62479815857736
  mo_energy =
[-3.27125119e+01 -1.89738215e+00 -7.85122995e-01 -7.85122995e-01
 -7.85122995e-01  2.62479816e+00  2.62479816e+00  2.62479816e+00
  2.73820612e+00  1.98273162e+01  1.98273162e+01  1.98273162e+01
  4.54087459e+01  3.35223900e+02  2.02609192e+03  7.31797715e+03]
E1 = -182.46652482507878  E_coul = 54.26799927124295
cycle= 5 E= -128.198525553836  delta_E= -2.87e-10  |g|= 1.54e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46652482507878  E_coul = 54.26799927124295
  HOMO = -0.785122935687716  LUMO = 2.62479822612525
  mo_energy =
[-3.27125119e+01 -1.89738247e+00 -7.85122936e-01 -7.85122936e-01
 -7.85122936e-01  2.62479823e+00  2.62479823e+00  2.62479823e+00
  2.73820584e+00  1.98273162e+01  1.98273162e+01  1.98273162e+01
  4.54087458e+01  3.35223900e+02  2.02609192e+03  7.31797716e+03]
E1 = -182.46652481682054  E_coul = 54.26799926298448
Extra cycle  E= -128.198525553836  delta_E= -2.27e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14461669e+03 2.27479328e+02 1.42700291e+03 5.76063401e-01
 5.00566878e+01 1.32732960e+01 1.93072014e+00 2.77777257e+00
 1.33323044e+01 6.00634000e-01]
E = -128.19852555383605
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61669491        1
[INPUT] 0    0    [1    /1   ]  227.479328229        1
[INPUT] 0    0    [1    /1   ]  1427.00290676        1
[INPUT] 0    0    [1    /1   ]  0.576063400887       1
[INPUT] 0    0    [1    /1   ]  50.0566878052        1
[INPUT] 0    0    [1    /1   ]  13.2732960363        1
[INPUT] 0    0    [1    /1   ]  1.93072013986        1
[INPUT] 1    0    [1    /1   ]  2.77777257366        1
[INPUT] 1    0    [1    /1   ]  13.3323043634        1
[INPUT] 1    0    [1    /1   ]  0.600634000388       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.616694910437, 1.0]], [0, [227.4793282286873, 1.0]], [0, [1427.002906764471, 1.0]], [0, [0.5760634008871863, 1.0]], [0, [50.05668780524202, 1.0]], [0, [13.273296036324606, 1.0]], [0, [1.9307201398632334, 1.0]], [1, [2.7777725736616263, 1.0]], [1, [13.332304363386736, 1.0]], [1, [0.600634000387509, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61669491]
bas 1, expnt(s) = [227.47932823]
bas 2, expnt(s) = [1427.00290676]
bas 3, expnt(s) = [0.5760634]
bas 4, expnt(s) = [50.05668781]
bas 5, expnt(s) = [13.27329604]
bas 6, expnt(s) = [1.93072014]
bas 7, expnt(s) = [2.77777257]
bas 8, expnt(s) = [13.33230436]
bas 9, expnt(s) = [0.600634]
CPU time:       163.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461669e+03 7.96209374e+02 2.27479328e+02 1.47986288e+02
 1.42700291e+03 5.86588666e+02 5.76063401e-01 1.67058177e+00
 5.00566878e+01 4.75457395e+01 1.32732960e+01 1.75690836e+01
 1.93072014e+00 4.13813371e+00 2.77777257e+00 1.04617720e+01
 1.33323044e+01 7.43217483e+01 6.00634000e-01 1.54257676e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965573428233837
cond(S) = 160.0899016562802
E1 = -183.13696219479098  E_coul = 55.011545858830324
init E= -128.125416335961
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897448822802  LUMO = 2.65828901256286
  mo_energy =
[-3.25136645e+01 -1.85363521e+00 -7.42897449e-01 -7.42897449e-01
 -7.42897449e-01  2.65828901e+00  2.65828901e+00  2.65828901e+00
  2.77213555e+00  1.99619808e+01  1.99619808e+01  1.99619808e+01
  4.55784223e+01  3.35452542e+02  2.02636337e+03  7.31827130e+03]
E1 = -182.1361217058539  E_coul = 53.939523646076665
cycle= 1 E= -128.196598059777  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259784
diis-c [-0.06748761  1.        ]
  HOMO = -0.807601531761799  LUMO = 2.60440137091005
  mo_energy =
[-3.27864425e+01 -1.92063550e+00 -8.07601532e-01 -8.07601532e-01
 -8.07601532e-01  2.60440137e+00  2.60440137e+00  2.60440137e+00
  2.71828487e+00  1.97718074e+01  1.97718074e+01  1.97718074e+01
  4.53433139e+01  3.35142776e+02  2.02600528e+03  7.31788899e+03]
E1 = -182.59711388487722  E_coul = 54.39889163773619
cycle= 2 E= -128.198222247141  delta_E= -0.00162  |g|= 0.0624  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101562
diis-c [-4.03484609e-04  2.77652056e-01  7.22347944e-01]
  HOMO = -0.784906791402965  LUMO = 2.62496034028519
  mo_energy =
[-3.27118905e+01 -1.89708531e+00 -7.84906791e-01 -7.84906791e-01
 -7.84906791e-01  2.62496034e+00  2.62496034e+00  2.62496034e+00
  2.73844072e+00  1.98278026e+01  1.98278026e+01  1.98278026e+01
  4.54093348e+01  3.35224348e+02  2.02609222e+03  7.31797741e+03]
E1 = -182.46531724561677  E_coul = 54.26679172500946
cycle= 3 E= -128.198525520607  delta_E= -0.000303  |g|= 0.000692  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00087851
diis-c [-7.42919934e-08 -3.88139503e-03 -1.73846454e-03  1.00561986e+00]
  HOMO = -0.785137307044345  LUMO = 2.62478576238553
  mo_energy =
[-3.27125489e+01 -1.89738470e+00 -7.85137307e-01 -7.85137307e-01
 -7.85137307e-01  2.62478576e+00  2.62478576e+00  2.62478576e+00
  2.73820470e+00  1.98272877e+01  1.98272877e+01  1.98272877e+01
  4.54087158e+01  3.35223849e+02  2.02609185e+03  7.31797708e+03]
E1 = -182.4665868103997  E_coul = 54.26806125685054
cycle= 4 E= -128.198525553549  delta_E= -3.29e-08  |g|= 5.01e-05  |ddm|= 0.000258
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.97405e-05
diis-c [-2.08107173e-10  5.01936065e-04 -8.52771450e-04 -1.69211448e-01
  1.16956228e+00]
  HOMO = -0.785122994549224  LUMO = 2.62479815857736
  mo_energy =
[-3.27125119e+01 -1.89738215e+00 -7.85122995e-01 -7.85122995e-01
 -7.85122995e-01  2.62479816e+00  2.62479816e+00  2.62479816e+00
  2.73820612e+00  1.98273162e+01  1.98273162e+01  1.98273162e+01
  4.54087459e+01  3.35223900e+02  2.02609192e+03  7.31797715e+03]
E1 = -182.46652482507878  E_coul = 54.26799927124295
cycle= 5 E= -128.198525553836  delta_E= -2.87e-10  |g|= 1.54e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46652482507878  E_coul = 54.26799927124295
  HOMO = -0.785122935687716  LUMO = 2.62479822612525
  mo_energy =
[-3.27125119e+01 -1.89738247e+00 -7.85122936e-01 -7.85122936e-01
 -7.85122936e-01  2.62479823e+00  2.62479823e+00  2.62479823e+00
  2.73820584e+00  1.98273162e+01  1.98273162e+01  1.98273162e+01
  4.54087458e+01  3.35223900e+02  2.02609192e+03  7.31797716e+03]
E1 = -182.46652481682054  E_coul = 54.26799926298448
Extra cycle  E= -128.198525553836  delta_E= -2.27e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.0899016562802
E1 = -182.46652481682054  E_coul = 54.26799926298448
init E= -128.198525553836
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785122921146552  LUMO = 2.62479823773138
  mo_energy =
[-3.27125119e+01 -1.89738252e+00 -7.85122921e-01 -7.85122921e-01
 -7.85122921e-01  2.62479824e+00  2.62479824e+00  2.62479824e+00
  2.73820579e+00  1.98273162e+01  1.98273162e+01  1.98273162e+01
  4.54087458e+01  3.35223900e+02  2.02609192e+03  7.31797716e+03]
E1 = -182.46652482725952  E_coul = 54.26799927342331
cycle= 1 E= -128.198525553836  delta_E= -1.71e-13  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46652482725952  E_coul = 54.26799927342331
  HOMO = -0.785122917559902  LUMO = 2.62479824071449
  mo_energy =
[-3.27125119e+01 -1.89738253e+00 -7.85122918e-01 -7.85122918e-01
 -7.85122918e-01  2.62479824e+00  2.62479824e+00  2.62479824e+00
  2.73820578e+00  1.98273163e+01  1.98273163e+01  1.98273163e+01
  4.54087458e+01  3.35223900e+02  2.02609192e+03  7.31797716e+03]
E1 = -182.4665248250576  E_coul = 54.2679992712215
Extra cycle  E= -128.198525553836  delta_E= 1.14e-13  |g|= 9.33e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14461669e+03 2.27479328e+02 1.42700291e+03 5.76063401e-01
 5.00566878e+01 1.32732960e+01 1.93072014e+00 2.77777257e+00
 1.33323044e+01 6.00634000e-01]
grad_E = [-9.94909170e-06  7.16570723e-06  3.37176191e-05 -2.93451621e-06
  1.08933351e-06 -1.88507128e-06  7.00088922e-07 -1.71632838e-05
  2.08399144e-06 -4.90678021e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61685737        1
[INPUT] 0    0    [1    /1   ]  227.47809244         1
[INPUT] 0    0    [1    /1   ]  1427.0024507         1
[INPUT] 0    0    [1    /1   ]  0.57605676427        1
[INPUT] 0    0    [1    /1   ]  50.0563328321        1
[INPUT] 0    0    [1    /1   ]  13.2731951723        1
[INPUT] 0    0    [1    /1   ]  1.93069694533        1
[INPUT] 1    0    [1    /1   ]  2.77762448491        1
[INPUT] 1    0    [1    /1   ]  13.3314329774        1
[INPUT] 1    0    [1    /1   ]  0.60061055816        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.616857373873, 1.0]], [0, [227.4780924397531, 1.0]], [0, [1427.0024507036653, 1.0]], [0, [0.5760567642701692, 1.0]], [0, [50.05633283214348, 1.0]], [0, [13.27319517233924, 1.0]], [0, [1.9306969453299465, 1.0]], [1, [2.7776244849096767, 1.0]], [1, [13.331432977356748, 1.0]], [1, [0.6006105581601, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61685737]
bas 1, expnt(s) = [227.47809244]
bas 2, expnt(s) = [1427.0024507]
bas 3, expnt(s) = [0.57605676]
bas 4, expnt(s) = [50.05633283]
bas 5, expnt(s) = [13.27319517]
bas 6, expnt(s) = [1.93069695]
bas 7, expnt(s) = [2.77762448]
bas 8, expnt(s) = [13.33143298]
bas 9, expnt(s) = [0.60061056]
CPU time:       166.23
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461686e+03 7.96209419e+02 2.27478092e+02 1.47985685e+02
 1.42700245e+03 5.86588526e+02 5.76056764e-01 1.67056733e+00
 5.00563328e+01 4.75454866e+01 1.32731952e+01 1.75689835e+01
 1.93069695e+00 4.13809643e+00 2.77762448e+00 1.04610748e+01
 1.33314330e+01 7.43156763e+01 6.00610558e-01 1.54250150e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965578395619334
cond(S) = 160.08881474642297
E1 = -183.13696116774472  E_coul = 55.01154223849008
init E= -128.125418929255
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897403258469  LUMO = 2.65814213769278
  mo_energy =
[-3.25136669e+01 -1.85363526e+00 -7.42897403e-01 -7.42897403e-01
 -7.42897403e-01  2.65814214e+00  2.65814214e+00  2.65814214e+00
  2.77208103e+00  1.99605352e+01  1.99605352e+01  1.99605352e+01
  4.55778668e+01  3.35449977e+02  2.02635777e+03  7.31826457e+03]
E1 = -182.1359814843122  E_coul = 53.93938383231013
cycle= 1 E= -128.196597652002  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259808
diis-c [-0.06750031  1.        ]
  HOMO = -0.807611479929364  LUMO = 2.60424816799761
  mo_energy =
[-3.27864711e+01 -1.92064706e+00 -8.07611480e-01 -8.07611480e-01
 -8.07611480e-01  2.60424817e+00  2.60424817e+00  2.60424817e+00
  2.71822099e+00  1.97703462e+01  1.97703462e+01  1.97703462e+01
  4.53427350e+01  3.35140184e+02  2.02599965e+03  7.31788223e+03]
E1 = -182.59703316839025  E_coul = 54.39881097915292
cycle= 2 E= -128.198222189237  delta_E= -0.00162  |g|= 0.0624  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101575
diis-c [-4.03511483e-04  2.77660254e-01  7.22339746e-01]
  HOMO = -0.784913970790642  LUMO = 2.62480866486824
  mo_energy =
[-3.27119108e+01 -1.89709396e+00 -7.84913971e-01 -7.84913971e-01
 -7.84913971e-01  2.62480866e+00  2.62480866e+00  2.62480866e+00
  2.73837906e+00  1.98263466e+01  1.98263466e+01  1.98263466e+01
  4.54087633e+01  3.35221764e+02  2.02608660e+03  7.31797066e+03]
E1 = -182.46521817197657  E_coul = 54.26669262790293
cycle= 3 E= -128.198525544074  delta_E= -0.000303  |g|= 0.000691  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000878149
diis-c [-7.43703616e-08 -3.88187617e-03 -1.74491786e-03  1.00562679e+00]
  HOMO = -0.78514439023406  LUMO = 2.6246341891703
  mo_energy =
[-3.27125689e+01 -1.89739329e+00 -7.85144390e-01 -7.85144390e-01
 -7.85144390e-01  2.62463419e+00  2.62463419e+00  2.62463419e+00
  2.73814310e+00  1.98258319e+01  1.98258319e+01  1.98258319e+01
  4.54081445e+01  3.35221266e+02  2.02608623e+03  7.31797033e+03]
E1 = -182.4664872681481  E_coul = 54.26796169114528
cycle= 4 E= -128.198525577003  delta_E= -3.29e-08  |g|= 5.01e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.9782e-05
diis-c [-2.08225251e-10  5.01994153e-04 -8.52200620e-04 -1.69236160e-01
  1.16958637e+00]
  HOMO = -0.785130071133389  LUMO = 2.62464659035157
  mo_energy =
[-3.27125319e+01 -1.89739073e+00 -7.85130071e-01 -7.85130071e-01
 -7.85130071e-01  2.62464659e+00  2.62464659e+00  2.62464659e+00
  2.73814452e+00  1.98258604e+01  1.98258604e+01  1.98258604e+01
  4.54081746e+01  3.35221317e+02  2.02608630e+03  7.31797040e+03]
E1 = -182.46642525417164  E_coul = 54.26789967688173
cycle= 5 E= -128.19852557729  delta_E= -2.87e-10  |g|= 1.54e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46642525417164  E_coul = 54.26789967688173
  HOMO = -0.785130012258116  LUMO = 2.62464665792036
  mo_energy =
[-3.27125319e+01 -1.89739105e+00 -7.85130012e-01 -7.85130012e-01
 -7.85130012e-01  2.62464666e+00  2.62464666e+00  2.62464666e+00
  2.73814424e+00  1.98258604e+01  1.98258604e+01  1.98258604e+01
  4.54081745e+01  3.35221317e+02  2.02608630e+03  7.31797040e+03]
E1 = -182.46642524574676  E_coul = 54.2678996684565
Extra cycle  E= -128.19852557729  delta_E= -3.69e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14461686e+03 2.27478092e+02 1.42700245e+03 5.76056764e-01
 5.00563328e+01 1.32731952e+01 1.93069695e+00 2.77762448e+00
 1.33314330e+01 6.00610558e-01]
E = -128.19852557729027
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61685737        1
[INPUT] 0    0    [1    /1   ]  227.47809244         1
[INPUT] 0    0    [1    /1   ]  1427.0024507         1
[INPUT] 0    0    [1    /1   ]  0.57605676427        1
[INPUT] 0    0    [1    /1   ]  50.0563328321        1
[INPUT] 0    0    [1    /1   ]  13.2731951723        1
[INPUT] 0    0    [1    /1   ]  1.93069694533        1
[INPUT] 1    0    [1    /1   ]  2.77762448491        1
[INPUT] 1    0    [1    /1   ]  13.3314329774        1
[INPUT] 1    0    [1    /1   ]  0.60061055816        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.616857373873, 1.0]], [0, [227.4780924397531, 1.0]], [0, [1427.0024507036653, 1.0]], [0, [0.5760567642701692, 1.0]], [0, [50.05633283214348, 1.0]], [0, [13.27319517233924, 1.0]], [0, [1.9306969453299465, 1.0]], [1, [2.7776244849096767, 1.0]], [1, [13.331432977356748, 1.0]], [1, [0.6006105581601, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61685737]
bas 1, expnt(s) = [227.47809244]
bas 2, expnt(s) = [1427.0024507]
bas 3, expnt(s) = [0.57605676]
bas 4, expnt(s) = [50.05633283]
bas 5, expnt(s) = [13.27319517]
bas 6, expnt(s) = [1.93069695]
bas 7, expnt(s) = [2.77762448]
bas 8, expnt(s) = [13.33143298]
bas 9, expnt(s) = [0.60061056]
CPU time:       167.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461686e+03 7.96209419e+02 2.27478092e+02 1.47985685e+02
 1.42700245e+03 5.86588526e+02 5.76056764e-01 1.67056733e+00
 5.00563328e+01 4.75454866e+01 1.32731952e+01 1.75689835e+01
 1.93069695e+00 4.13809643e+00 2.77762448e+00 1.04610748e+01
 1.33314330e+01 7.43156763e+01 6.00610558e-01 1.54250150e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965578395619334
cond(S) = 160.08881474642297
E1 = -183.13696116774472  E_coul = 55.01154223849008
init E= -128.125418929255
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897403258469  LUMO = 2.65814213769278
  mo_energy =
[-3.25136669e+01 -1.85363526e+00 -7.42897403e-01 -7.42897403e-01
 -7.42897403e-01  2.65814214e+00  2.65814214e+00  2.65814214e+00
  2.77208103e+00  1.99605352e+01  1.99605352e+01  1.99605352e+01
  4.55778668e+01  3.35449977e+02  2.02635777e+03  7.31826457e+03]
E1 = -182.1359814843122  E_coul = 53.93938383231013
cycle= 1 E= -128.196597652002  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259808
diis-c [-0.06750031  1.        ]
  HOMO = -0.807611479929364  LUMO = 2.60424816799761
  mo_energy =
[-3.27864711e+01 -1.92064706e+00 -8.07611480e-01 -8.07611480e-01
 -8.07611480e-01  2.60424817e+00  2.60424817e+00  2.60424817e+00
  2.71822099e+00  1.97703462e+01  1.97703462e+01  1.97703462e+01
  4.53427350e+01  3.35140184e+02  2.02599965e+03  7.31788223e+03]
E1 = -182.59703316839025  E_coul = 54.39881097915292
cycle= 2 E= -128.198222189237  delta_E= -0.00162  |g|= 0.0624  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101575
diis-c [-4.03511483e-04  2.77660254e-01  7.22339746e-01]
  HOMO = -0.784913970790642  LUMO = 2.62480866486824
  mo_energy =
[-3.27119108e+01 -1.89709396e+00 -7.84913971e-01 -7.84913971e-01
 -7.84913971e-01  2.62480866e+00  2.62480866e+00  2.62480866e+00
  2.73837906e+00  1.98263466e+01  1.98263466e+01  1.98263466e+01
  4.54087633e+01  3.35221764e+02  2.02608660e+03  7.31797066e+03]
E1 = -182.46521817197657  E_coul = 54.26669262790293
cycle= 3 E= -128.198525544074  delta_E= -0.000303  |g|= 0.000691  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000878149
diis-c [-7.43703616e-08 -3.88187617e-03 -1.74491786e-03  1.00562679e+00]
  HOMO = -0.78514439023406  LUMO = 2.6246341891703
  mo_energy =
[-3.27125689e+01 -1.89739329e+00 -7.85144390e-01 -7.85144390e-01
 -7.85144390e-01  2.62463419e+00  2.62463419e+00  2.62463419e+00
  2.73814310e+00  1.98258319e+01  1.98258319e+01  1.98258319e+01
  4.54081445e+01  3.35221266e+02  2.02608623e+03  7.31797033e+03]
E1 = -182.4664872681481  E_coul = 54.26796169114528
cycle= 4 E= -128.198525577003  delta_E= -3.29e-08  |g|= 5.01e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.9782e-05
diis-c [-2.08225251e-10  5.01994153e-04 -8.52200620e-04 -1.69236160e-01
  1.16958637e+00]
  HOMO = -0.785130071133389  LUMO = 2.62464659035157
  mo_energy =
[-3.27125319e+01 -1.89739073e+00 -7.85130071e-01 -7.85130071e-01
 -7.85130071e-01  2.62464659e+00  2.62464659e+00  2.62464659e+00
  2.73814452e+00  1.98258604e+01  1.98258604e+01  1.98258604e+01
  4.54081746e+01  3.35221317e+02  2.02608630e+03  7.31797040e+03]
E1 = -182.46642525417164  E_coul = 54.26789967688173
cycle= 5 E= -128.19852557729  delta_E= -2.87e-10  |g|= 1.54e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46642525417164  E_coul = 54.26789967688173
  HOMO = -0.785130012258116  LUMO = 2.62464665792036
  mo_energy =
[-3.27125319e+01 -1.89739105e+00 -7.85130012e-01 -7.85130012e-01
 -7.85130012e-01  2.62464666e+00  2.62464666e+00  2.62464666e+00
  2.73814424e+00  1.98258604e+01  1.98258604e+01  1.98258604e+01
  4.54081745e+01  3.35221317e+02  2.02608630e+03  7.31797040e+03]
E1 = -182.46642524574676  E_coul = 54.2678996684565
Extra cycle  E= -128.19852557729  delta_E= -3.69e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.08881474642297
E1 = -182.46642524574676  E_coul = 54.2678996684565
init E= -128.19852557729
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785129997727691  LUMO = 2.62464666951577
  mo_energy =
[-3.27125319e+01 -1.89739111e+00 -7.85129998e-01 -7.85129998e-01
 -7.85129998e-01  2.62464667e+00  2.62464667e+00  2.62464667e+00
  2.73814419e+00  1.98258604e+01  1.98258604e+01  1.98258604e+01
  4.54081745e+01  3.35221317e+02  2.02608630e+03  7.31797040e+03]
E1 = -182.466425256242  E_coul = 54.2678996789517
cycle= 1 E= -128.19852557729  delta_E= -2.84e-14  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.466425256242  E_coul = 54.2678996789517
  HOMO = -0.785129994136975  LUMO = 2.62464667250232
  mo_energy =
[-3.27125318e+01 -1.89739112e+00 -7.85129994e-01 -7.85129994e-01
 -7.85129994e-01  2.62464667e+00  2.62464667e+00  2.62464667e+00
  2.73814418e+00  1.98258604e+01  1.98258604e+01  1.98258604e+01
  4.54081745e+01  3.35221317e+02  2.02608630e+03  7.31797040e+03]
E1 = -182.46642525401631  E_coul = 54.267899676726074
Extra cycle  E= -128.19852557729  delta_E= 5.68e-14  |g|= 9.33e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14461686e+03 2.27478092e+02 1.42700245e+03 5.76056764e-01
 5.00563328e+01 1.32731952e+01 1.93069695e+00 2.77762448e+00
 1.33314330e+01 6.00610558e-01]
grad_E = [-9.94896104e-06  7.16210847e-06  3.37184479e-05 -4.74482759e-06
  1.20209421e-06 -3.27046755e-06  1.15847501e-06 -2.87393356e-05
  2.47674013e-07 -8.11465474e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61721607        1
[INPUT] 0    0    [1    /1   ]  227.47613916         1
[INPUT] 0    0    [1    /1   ]  1427.00137839        1
[INPUT] 0    0    [1    /1   ]  0.576046449249       1
[INPUT] 0    0    [1    /1   ]  50.0557787147        1
[INPUT] 0    0    [1    /1   ]  13.2730380347        1
[INPUT] 0    0    [1    /1   ]  1.9306609632         1
[INPUT] 1    0    [1    /1   ]  2.77739762617        1
[INPUT] 1    0    [1    /1   ]  13.3301038039        1
[INPUT] 1    0    [1    /1   ]  0.600574588637       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6172160655233, 1.0]], [0, [227.47613916034712, 1.0]], [0, [1427.001378387559, 1.0]], [0, [0.5760464492492257, 1.0]], [0, [50.055778714705056, 1.0]], [0, [13.273038034700871, 1.0]], [0, [1.9306609631952234, 1.0]], [1, [2.7773976261672835, 1.0]], [1, [13.330103803873243, 1.0]], [1, [0.6005745886368292, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61721607]
bas 1, expnt(s) = [227.47613916]
bas 2, expnt(s) = [1427.00137839]
bas 3, expnt(s) = [0.57604645]
bas 4, expnt(s) = [50.05577871]
bas 5, expnt(s) = [13.27303803]
bas 6, expnt(s) = [1.93066096]
bas 7, expnt(s) = [2.77739763]
bas 8, expnt(s) = [13.3301038]
bas 9, expnt(s) = [0.60057459]
CPU time:       169.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461722e+03 7.96209519e+02 2.27476139e+02 1.47984732e+02
 1.42700138e+03 5.86588195e+02 5.76046449e-01 1.67054490e+00
 5.00557787e+01 4.75450919e+01 1.32730380e+01 1.75688275e+01
 1.93066096e+00 4.13803858e+00 2.77739763e+00 1.04600068e+01
 1.33301038e+01 7.43064147e+01 6.00574589e-01 1.54238603e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965586017218534
cond(S) = 160.08690839434624
E1 = -183.1369595909377  E_coul = 55.01153666936786
init E= -128.12542292157
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897340373858  LUMO = 2.65791686504872
  mo_energy =
[-3.25136705e+01 -1.85363535e+00 -7.42897340e-01 -7.42897340e-01
 -7.42897340e-01  2.65791687e+00  2.65791687e+00  2.65791687e+00
  2.77199635e+00  1.99583264e+01  1.99583264e+01  1.99583264e+01
  4.55770015e+01  3.35445953e+02  2.02634877e+03  7.31825335e+03]
E1 = -182.13576609652952  E_coul = 53.939169063724414
cycle= 1 E= -128.196597032805  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259846
diis-c [-0.06751981  1.        ]
  HOMO = -0.807626761157803  LUMO = 2.60401317276868
  mo_energy =
[-3.27865151e+01 -1.92066482e+00 -8.07626761e-01 -8.07626761e-01
 -8.07626761e-01  2.60401317e+00  2.60401317e+00  2.60401317e+00
  2.71812198e+00  1.97681135e+01  1.97681135e+01  1.97681135e+01
  4.53418339e+01  3.35136118e+02  2.02599061e+03  7.31787097e+03]
E1 = -182.59690917304306  E_coul = 54.398687065473744
cycle= 2 E= -128.198222107569  delta_E= -0.00163  |g|= 0.0624  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101595
diis-c [-4.03552564e-04  2.77672832e-01  7.22327168e-01]
  HOMO = -0.784924999242436  LUMO = 2.62457601807337
  mo_energy =
[-3.27119419e+01 -1.89710723e+00 -7.84924999e-01 -7.84924999e-01
 -7.84924999e-01  2.62457602e+00  2.62457602e+00  2.62457602e+00
  2.73828345e+00  1.98241218e+01  1.98241218e+01  1.98241218e+01
  4.54078734e+01  3.35217712e+02  2.02607757e+03  7.31795941e+03]
E1 = -182.46506598782233  E_coul = 54.26654040044213
cycle= 3 E= -128.19852558738  delta_E= -0.000303  |g|= 0.000691  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000877595
diis-c [-7.44906166e-08 -3.88261383e-03 -1.75482502e-03  1.00563744e+00]
  HOMO = -0.785155270888171  LUMO = 2.62440169935757
  mo_energy =
[-3.27125996e+01 -1.89740647e+00 -7.85155271e-01 -7.85155271e-01
 -7.85155271e-01  2.62440170e+00  2.62440170e+00  2.62440170e+00
  2.73804757e+00  1.98236074e+01  1.98236074e+01  1.98236074e+01
  4.54072550e+01  3.35217214e+02  2.02607720e+03  7.31795908e+03]
E1 = -182.4663343638018  E_coul = 54.26780874351158
cycle= 4 E= -128.19852562029  delta_E= -3.29e-08  |g|= 5.02e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.98455e-05
diis-c [-2.08406921e-10  5.02082272e-04 -8.51322872e-04 -1.69273843e-01
  1.16962308e+00]
  HOMO = -0.7851409416606  LUMO = 2.62441410818657
  mo_energy =
[-3.27125627e+01 -1.89740392e+00 -7.85140942e-01 -7.85140942e-01
 -7.85140942e-01  2.62441411e+00  2.62441411e+00  2.62441411e+00
  2.73804899e+00  1.98236360e+01  1.98236360e+01  1.98236360e+01
  4.54072851e+01  3.35217265e+02  2.02607727e+03  7.31795916e+03]
E1 = -182.46627230589468  E_coul = 54.2677466853167
cycle= 5 E= -128.198525620578  delta_E= -2.88e-10  |g|= 1.54e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46627230589468  E_coul = 54.2677466853167
  HOMO = -0.785140882762482  LUMO = 2.62441417578888
  mo_energy =
[-3.27125626e+01 -1.89740424e+00 -7.85140883e-01 -7.85140883e-01
 -7.85140883e-01  2.62441418e+00  2.62441418e+00  2.62441418e+00
  2.73804872e+00  1.98236360e+01  1.98236360e+01  1.98236360e+01
  4.54072851e+01  3.35217265e+02  2.02607727e+03  7.31795916e+03]
E1 = -182.4662722972055  E_coul = 54.26774667662734
Extra cycle  E= -128.198525620578  delta_E= -1.71e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14461722e+03 2.27476139e+02 1.42700138e+03 5.76046449e-01
 5.00557787e+01 1.32730380e+01 1.93066096e+00 2.77739763e+00
 1.33301038e+01 6.00574589e-01]
E = -128.19852562057815
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61721607        1
[INPUT] 0    0    [1    /1   ]  227.47613916         1
[INPUT] 0    0    [1    /1   ]  1427.00137839        1
[INPUT] 0    0    [1    /1   ]  0.576046449249       1
[INPUT] 0    0    [1    /1   ]  50.0557787147        1
[INPUT] 0    0    [1    /1   ]  13.2730380347        1
[INPUT] 0    0    [1    /1   ]  1.9306609632         1
[INPUT] 1    0    [1    /1   ]  2.77739762617        1
[INPUT] 1    0    [1    /1   ]  13.3301038039        1
[INPUT] 1    0    [1    /1   ]  0.600574588637       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6172160655233, 1.0]], [0, [227.47613916034712, 1.0]], [0, [1427.001378387559, 1.0]], [0, [0.5760464492492257, 1.0]], [0, [50.055778714705056, 1.0]], [0, [13.273038034700871, 1.0]], [0, [1.9306609631952234, 1.0]], [1, [2.7773976261672835, 1.0]], [1, [13.330103803873243, 1.0]], [1, [0.6005745886368292, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61721607]
bas 1, expnt(s) = [227.47613916]
bas 2, expnt(s) = [1427.00137839]
bas 3, expnt(s) = [0.57604645]
bas 4, expnt(s) = [50.05577871]
bas 5, expnt(s) = [13.27303803]
bas 6, expnt(s) = [1.93066096]
bas 7, expnt(s) = [2.77739763]
bas 8, expnt(s) = [13.3301038]
bas 9, expnt(s) = [0.60057459]
CPU time:       170.42
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461722e+03 7.96209519e+02 2.27476139e+02 1.47984732e+02
 1.42700138e+03 5.86588195e+02 5.76046449e-01 1.67054490e+00
 5.00557787e+01 4.75450919e+01 1.32730380e+01 1.75688275e+01
 1.93066096e+00 4.13803858e+00 2.77739763e+00 1.04600068e+01
 1.33301038e+01 7.43064147e+01 6.00574589e-01 1.54238603e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965586017218534
cond(S) = 160.08690839434624
E1 = -183.1369595909377  E_coul = 55.01153666936786
init E= -128.12542292157
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897340373858  LUMO = 2.65791686504872
  mo_energy =
[-3.25136705e+01 -1.85363535e+00 -7.42897340e-01 -7.42897340e-01
 -7.42897340e-01  2.65791687e+00  2.65791687e+00  2.65791687e+00
  2.77199635e+00  1.99583264e+01  1.99583264e+01  1.99583264e+01
  4.55770015e+01  3.35445953e+02  2.02634877e+03  7.31825335e+03]
E1 = -182.13576609652952  E_coul = 53.939169063724414
cycle= 1 E= -128.196597032805  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259846
diis-c [-0.06751981  1.        ]
  HOMO = -0.807626761157803  LUMO = 2.60401317276868
  mo_energy =
[-3.27865151e+01 -1.92066482e+00 -8.07626761e-01 -8.07626761e-01
 -8.07626761e-01  2.60401317e+00  2.60401317e+00  2.60401317e+00
  2.71812198e+00  1.97681135e+01  1.97681135e+01  1.97681135e+01
  4.53418339e+01  3.35136118e+02  2.02599061e+03  7.31787097e+03]
E1 = -182.59690917304306  E_coul = 54.398687065473744
cycle= 2 E= -128.198222107569  delta_E= -0.00163  |g|= 0.0624  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101595
diis-c [-4.03552564e-04  2.77672832e-01  7.22327168e-01]
  HOMO = -0.784924999242436  LUMO = 2.62457601807337
  mo_energy =
[-3.27119419e+01 -1.89710723e+00 -7.84924999e-01 -7.84924999e-01
 -7.84924999e-01  2.62457602e+00  2.62457602e+00  2.62457602e+00
  2.73828345e+00  1.98241218e+01  1.98241218e+01  1.98241218e+01
  4.54078734e+01  3.35217712e+02  2.02607757e+03  7.31795941e+03]
E1 = -182.46506598782233  E_coul = 54.26654040044213
cycle= 3 E= -128.19852558738  delta_E= -0.000303  |g|= 0.000691  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000877595
diis-c [-7.44906166e-08 -3.88261383e-03 -1.75482502e-03  1.00563744e+00]
  HOMO = -0.785155270888171  LUMO = 2.62440169935757
  mo_energy =
[-3.27125996e+01 -1.89740647e+00 -7.85155271e-01 -7.85155271e-01
 -7.85155271e-01  2.62440170e+00  2.62440170e+00  2.62440170e+00
  2.73804757e+00  1.98236074e+01  1.98236074e+01  1.98236074e+01
  4.54072550e+01  3.35217214e+02  2.02607720e+03  7.31795908e+03]
E1 = -182.4663343638018  E_coul = 54.26780874351158
cycle= 4 E= -128.19852562029  delta_E= -3.29e-08  |g|= 5.02e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.98455e-05
diis-c [-2.08406921e-10  5.02082272e-04 -8.51322872e-04 -1.69273843e-01
  1.16962308e+00]
  HOMO = -0.7851409416606  LUMO = 2.62441410818657
  mo_energy =
[-3.27125627e+01 -1.89740392e+00 -7.85140942e-01 -7.85140942e-01
 -7.85140942e-01  2.62441411e+00  2.62441411e+00  2.62441411e+00
  2.73804899e+00  1.98236360e+01  1.98236360e+01  1.98236360e+01
  4.54072851e+01  3.35217265e+02  2.02607727e+03  7.31795916e+03]
E1 = -182.46627230589468  E_coul = 54.2677466853167
cycle= 5 E= -128.198525620578  delta_E= -2.88e-10  |g|= 1.54e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46627230589468  E_coul = 54.2677466853167
  HOMO = -0.785140882762482  LUMO = 2.62441417578888
  mo_energy =
[-3.27125626e+01 -1.89740424e+00 -7.85140883e-01 -7.85140883e-01
 -7.85140883e-01  2.62441418e+00  2.62441418e+00  2.62441418e+00
  2.73804872e+00  1.98236360e+01  1.98236360e+01  1.98236360e+01
  4.54072851e+01  3.35217265e+02  2.02607727e+03  7.31795916e+03]
E1 = -182.4662722972055  E_coul = 54.26774667662734
Extra cycle  E= -128.198525620578  delta_E= -1.71e-13  |g|= 2.81e-07  |ddm|= 8.91e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.08690839434624
E1 = -182.4662722972055  E_coul = 54.26774667662734
init E= -128.198525620578
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785140868249042  LUMO = 2.62441418736738
  mo_energy =
[-3.27125626e+01 -1.89740429e+00 -7.85140868e-01 -7.85140868e-01
 -7.85140868e-01  2.62441419e+00  2.62441419e+00  2.62441419e+00
  2.73804867e+00  1.98236360e+01  1.98236360e+01  1.98236360e+01
  4.54072851e+01  3.35217265e+02  2.02607727e+03  7.31795916e+03]
E1 = -182.46627230779131  E_coul = 54.26774668721326
cycle= 1 E= -128.198525620578  delta_E= 1.14e-13  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46627230779131  E_coul = 54.26774668721326
  HOMO = -0.785140864651802  LUMO = 2.62441419035952
  mo_energy =
[-3.27125626e+01 -1.89740430e+00 -7.85140865e-01 -7.85140865e-01
 -7.85140865e-01  2.62441419e+00  2.62441419e+00  2.62441419e+00
  2.73804866e+00  1.98236360e+01  1.98236360e+01  1.98236360e+01
  4.54072851e+01  3.35217265e+02  2.02607727e+03  7.31795916e+03]
E1 = -182.46627230552772  E_coul = 54.267746684949394
Extra cycle  E= -128.198525620578  delta_E= -2.84e-13  |g|= 9.33e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14461722e+03 2.27476139e+02 1.42700138e+03 5.76046449e-01
 5.00557787e+01 1.32730380e+01 1.93066096e+00 2.77739763e+00
 1.33301038e+01 6.00574589e-01]
grad_E = [-9.94876826e-06  7.15560409e-06  3.37197780e-05 -7.56523552e-06
  1.38296580e-06 -5.43430678e-06  1.87562753e-06 -4.68181987e-05
 -2.49372333e-06 -1.31197676e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61798095        1
[INPUT] 0    0    [1    /1   ]  227.473030002        1
[INPUT] 0    0    [1    /1   ]  1426.99900269        1
[INPUT] 0    0    [1    /1   ]  0.576030268514       1
[INPUT] 0    0    [1    /1   ]  50.0549057489        1
[INPUT] 0    0    [1    /1   ]  13.2727910459        1
[INPUT] 0    0    [1    /1   ]  1.9306045862         1
[INPUT] 1    0    [1    /1   ]  2.77704515004        1
[INPUT] 1    0    [1    /1   ]  13.3280442045        1
[INPUT] 1    0    [1    /1   ]  0.600518644292       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.617980945965, 1.0]], [0, [227.4730300023546, 1.0]], [0, [1426.9990026913842, 1.0]], [0, [0.5760302685139309, 1.0]], [0, [50.054905748894406, 1.0]], [0, [13.27279104590655, 1.0]], [0, [1.9306045862010937, 1.0]], [1, [2.777045150043887, 1.0]], [1, [13.328044204473642, 1.0]], [1, [0.6005186442920675, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61798095]
bas 1, expnt(s) = [227.47303]
bas 2, expnt(s) = [1426.99900269]
bas 3, expnt(s) = [0.57603027]
bas 4, expnt(s) = [50.05490575]
bas 5, expnt(s) = [13.27279105]
bas 6, expnt(s) = [1.93060459]
bas 7, expnt(s) = [2.77704515]
bas 8, expnt(s) = [13.3280442]
bas 9, expnt(s) = [0.60051864]
CPU time:       173.12
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461798e+03 7.96209732e+02 2.27473030e+02 1.47983215e+02
 1.42699900e+03 5.86587463e+02 5.76030269e-01 1.67050970e+00
 5.00549057e+01 4.75444700e+01 1.32727910e+01 1.75685823e+01
 1.93060459e+00 4.13794796e+00 2.77704515e+00 1.04583475e+01
 1.33280442e+01 7.42920638e+01 6.00518644e-01 1.54220644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96559786976831
cond(S) = 160.08351010839144
E1 = -183.13695713567535  E_coul = 55.01152798702033
init E= -128.125429148655
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.742897248162651  LUMO = 2.65756659092187
  mo_energy =
[-3.25136761e+01 -1.85363549e+00 -7.42897248e-01 -7.42897248e-01
 -7.42897248e-01  2.65756659e+00  2.65756659e+00  2.65756659e+00
  2.77186358e+00  1.99549002e+01  1.99549002e+01  1.99549002e+01
  4.55756415e+01  3.35439587e+02  2.02633414e+03  7.31823437e+03]
E1 = -182.1354308635658  E_coul = 53.93883478452504
cycle= 1 E= -128.196596079041  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.259904
diis-c [-0.06755017  1.        ]
  HOMO = -0.807650543806042  LUMO = 2.60364776616148
  mo_energy =
[-3.27865835e+01 -1.92069246e+00 -8.07650544e-01 -8.07650544e-01
 -8.07650544e-01  2.60364777e+00  2.60364777e+00  2.60364777e+00
  2.71796692e+00  1.97646502e+01  1.97646502e+01  1.97646502e+01
  4.53404181e+01  3.35129686e+02  2.02597592e+03  7.31785192e+03]
E1 = -182.59671618107524  E_coul = 54.39849419043352
cycle= 2 E= -128.198221990642  delta_E= -0.00163  |g|= 0.0624  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101627
diis-c [-4.03616262e-04  2.77692391e-01  7.22307609e-01]
  HOMO = -0.784942162758504  LUMO = 2.62421426829084
  mo_energy =
[-3.27119904e+01 -1.89712789e+00 -7.84942163e-01 -7.84942163e-01
 -7.84942163e-01  2.62421427e+00  2.62421427e+00  2.62421427e+00
  2.73813368e+00  1.98206708e+01  1.98206708e+01  1.98206708e+01
  4.54064751e+01  3.35211302e+02  2.02606290e+03  7.31794039e+03]
E1 = -182.4648291280595  E_coul = 54.26630346306684
cycle= 3 E= -128.198525664993  delta_E= -0.000304  |g|= 0.000691  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=0.000876733
diis-c [-7.46777859e-08 -3.88376107e-03 -1.77023830e-03  1.00565400e+00]
  HOMO = -0.785172204303574  LUMO = 2.62404019391001
  mo_energy =
[-3.27126475e+01 -1.89742699e+00 -7.85172204e-01 -7.85172204e-01
 -7.85172204e-01  2.62404019e+00  2.62404019e+00  2.62404019e+00
  2.73789795e+00  1.98201569e+01  1.98201569e+01  1.98201569e+01
  4.54058573e+01  3.35210804e+02  2.02606253e+03  7.31794006e+03]
E1 = -182.46609638247813  E_coul = 54.26757068460535
cycle= 4 E= -128.198525697873  delta_E= -3.29e-08  |g|= 5.03e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.02 sec, wall time      0.06 sec
diis-norm(errvec)=7.99443e-05
diis-c [-2.08690092e-10  5.02218510e-04 -8.49954284e-04 -1.69332166e-01
  1.16967990e+00]
  HOMO = -0.785157859334535  LUMO = 2.62405261462315
  mo_energy =
[-3.27126105e+01 -1.89742443e+00 -7.85157859e-01 -7.85157859e-01
 -7.85157859e-01  2.62405261e+00  2.62405261e+00  2.62405261e+00
  2.73789936e+00  1.98201855e+01  1.98201855e+01  1.98201855e+01
  4.54058874e+01  3.35210855e+02  2.02606260e+03  7.31794013e+03]
E1 = -182.46603425628032  E_coul = 54.26750855811924
cycle= 5 E= -128.198525698161  delta_E= -2.88e-10  |g|= 1.54e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.02 sec, wall time      0.03 sec
E1 = -182.46603425628032  E_coul = 54.26750855811924
  HOMO = -0.785157800399827  LUMO = 2.62405268227859
  mo_energy =
[-3.27126104e+01 -1.89742476e+00 -7.85157800e-01 -7.85157800e-01
 -7.85157800e-01  2.62405268e+00  2.62405268e+00  2.62405268e+00
  2.73789908e+00  1.98201856e+01  1.98201856e+01  1.98201856e+01
  4.54058873e+01  3.35210856e+02  2.02606260e+03  7.31794013e+03]
E1 = -182.46603424717654  E_coul = 54.26750854901505
Extra cycle  E= -128.198525698161  delta_E= -3.98e-13  |g|= 2.81e-07  |ddm|= 8.92e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.19 sec
exp = [2.14461798e+03 2.27473030e+02 1.42699900e+03 5.76030269e-01
 5.00549057e+01 1.32727910e+01 1.93060459e+00 2.77704515e+00
 1.33280442e+01 6.00518644e-01]
E = -128.1985256981615
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61798095        1
[INPUT] 0    0    [1    /1   ]  227.473030002        1
[INPUT] 0    0    [1    /1   ]  1426.99900269        1
[INPUT] 0    0    [1    /1   ]  0.576030268514       1
[INPUT] 0    0    [1    /1   ]  50.0549057489        1
[INPUT] 0    0    [1    /1   ]  13.2727910459        1
[INPUT] 0    0    [1    /1   ]  1.9306045862         1
[INPUT] 1    0    [1    /1   ]  2.77704515004        1
[INPUT] 1    0    [1    /1   ]  13.3280442045        1
[INPUT] 1    0    [1    /1   ]  0.600518644292       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.617980945965, 1.0]], [0, [227.4730300023546, 1.0]], [0, [1426.9990026913842, 1.0]], [0, [0.5760302685139309, 1.0]], [0, [50.054905748894406, 1.0]], [0, [13.27279104590655, 1.0]], [0, [1.9306045862010937, 1.0]], [1, [2.777045150043887, 1.0]], [1, [13.328044204473642, 1.0]], [1, [0.6005186442920675, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61798095]
bas 1, expnt(s) = [227.47303]
bas 2, expnt(s) = [1426.99900269]
bas 3, expnt(s) = [0.57603027]
bas 4, expnt(s) = [50.05490575]
bas 5, expnt(s) = [13.27279105]
bas 6, expnt(s) = [1.93060459]
bas 7, expnt(s) = [2.77704515]
bas 8, expnt(s) = [13.3280442]
bas 9, expnt(s) = [0.60051864]
CPU time:       174.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461798e+03 7.96209732e+02 2.27473030e+02 1.47983215e+02
 1.42699900e+03 5.86587463e+02 5.76030269e-01 1.67050970e+00
 5.00549057e+01 4.75444700e+01 1.32727910e+01 1.75685823e+01
 1.93060459e+00 4.13794796e+00 2.77704515e+00 1.04583475e+01
 1.33280442e+01 7.42920638e+01 6.00518644e-01 1.54220644e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96559786976831
cond(S) = 160.08351010839144
E1 = -183.13695713567535  E_coul = 55.01152798702033
init E= -128.125429148655
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742897248162651  LUMO = 2.65756659092187
  mo_energy =
[-3.25136761e+01 -1.85363549e+00 -7.42897248e-01 -7.42897248e-01
 -7.42897248e-01  2.65756659e+00  2.65756659e+00  2.65756659e+00
  2.77186358e+00  1.99549002e+01  1.99549002e+01  1.99549002e+01
  4.55756415e+01  3.35439587e+02  2.02633414e+03  7.31823437e+03]
E1 = -182.1354308635658  E_coul = 53.93883478452504
cycle= 1 E= -128.196596079041  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259904
diis-c [-0.06755017  1.        ]
  HOMO = -0.807650543806042  LUMO = 2.60364776616148
  mo_energy =
[-3.27865835e+01 -1.92069246e+00 -8.07650544e-01 -8.07650544e-01
 -8.07650544e-01  2.60364777e+00  2.60364777e+00  2.60364777e+00
  2.71796692e+00  1.97646502e+01  1.97646502e+01  1.97646502e+01
  4.53404181e+01  3.35129686e+02  2.02597592e+03  7.31785192e+03]
E1 = -182.59671618107524  E_coul = 54.39849419043352
cycle= 2 E= -128.198221990642  delta_E= -0.00163  |g|= 0.0624  |ddm|= 0.0641
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101627
diis-c [-4.03616262e-04  2.77692391e-01  7.22307609e-01]
  HOMO = -0.784942162758504  LUMO = 2.62421426829084
  mo_energy =
[-3.27119904e+01 -1.89712789e+00 -7.84942163e-01 -7.84942163e-01
 -7.84942163e-01  2.62421427e+00  2.62421427e+00  2.62421427e+00
  2.73813368e+00  1.98206708e+01  1.98206708e+01  1.98206708e+01
  4.54064751e+01  3.35211302e+02  2.02606290e+03  7.31794039e+03]
E1 = -182.4648291280595  E_coul = 54.26630346306684
cycle= 3 E= -128.198525664993  delta_E= -0.000304  |g|= 0.000691  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000876733
diis-c [-7.46777859e-08 -3.88376107e-03 -1.77023830e-03  1.00565400e+00]
  HOMO = -0.785172204303574  LUMO = 2.62404019391001
  mo_energy =
[-3.27126475e+01 -1.89742699e+00 -7.85172204e-01 -7.85172204e-01
 -7.85172204e-01  2.62404019e+00  2.62404019e+00  2.62404019e+00
  2.73789795e+00  1.98201569e+01  1.98201569e+01  1.98201569e+01
  4.54058573e+01  3.35210804e+02  2.02606253e+03  7.31794006e+03]
E1 = -182.46609638247813  E_coul = 54.26757068460535
cycle= 4 E= -128.198525697873  delta_E= -3.29e-08  |g|= 5.03e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.99443e-05
diis-c [-2.08690092e-10  5.02218510e-04 -8.49954284e-04 -1.69332166e-01
  1.16967990e+00]
  HOMO = -0.785157859334535  LUMO = 2.62405261462315
  mo_energy =
[-3.27126105e+01 -1.89742443e+00 -7.85157859e-01 -7.85157859e-01
 -7.85157859e-01  2.62405261e+00  2.62405261e+00  2.62405261e+00
  2.73789936e+00  1.98201855e+01  1.98201855e+01  1.98201855e+01
  4.54058874e+01  3.35210855e+02  2.02606260e+03  7.31794013e+03]
E1 = -182.46603425628032  E_coul = 54.26750855811924
cycle= 5 E= -128.198525698161  delta_E= -2.88e-10  |g|= 1.54e-06  |ddm|= 2.54e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46603425628032  E_coul = 54.26750855811924
  HOMO = -0.785157800399827  LUMO = 2.62405268227859
  mo_energy =
[-3.27126104e+01 -1.89742476e+00 -7.85157800e-01 -7.85157800e-01
 -7.85157800e-01  2.62405268e+00  2.62405268e+00  2.62405268e+00
  2.73789908e+00  1.98201856e+01  1.98201856e+01  1.98201856e+01
  4.54058873e+01  3.35210856e+02  2.02606260e+03  7.31794013e+03]
E1 = -182.46603424717654  E_coul = 54.26750854901505
Extra cycle  E= -128.198525698161  delta_E= -3.98e-13  |g|= 2.81e-07  |ddm|= 8.92e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.08351010839144
E1 = -182.46603424717654  E_coul = 54.26750854901505
init E= -128.198525698161
    CPU time for initialize scf      0.06 sec, wall time      0.06 sec
  HOMO = -0.785157785913029  LUMO = 2.62405269383057
  mo_energy =
[-3.27126104e+01 -1.89742481e+00 -7.85157786e-01 -7.85157786e-01
 -7.85157786e-01  2.62405269e+00  2.62405269e+00  2.62405269e+00
  2.73789903e+00  1.98201856e+01  1.98201856e+01  1.98201856e+01
  4.54058873e+01  3.35210856e+02  2.02606260e+03  7.31794013e+03]
E1 = -182.4660342579045  E_coul = 54.2675085597429
cycle= 1 E= -128.198525698162  delta_E= -1.14e-13  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4660342579045  E_coul = 54.2675085597429
  HOMO = -0.785157782305557  LUMO = 2.62405269683146
  mo_energy =
[-3.27126104e+01 -1.89742482e+00 -7.85157782e-01 -7.85157782e-01
 -7.85157782e-01  2.62405270e+00  2.62405270e+00  2.62405270e+00
  2.73789902e+00  1.98201856e+01  1.98201856e+01  1.98201856e+01
  4.54058873e+01  3.35210856e+02  2.02606260e+03  7.31794013e+03]
E1 = -182.46603425558106  E_coul = 54.26750855741946
Extra cycle  E= -128.198525698162  delta_E=    0  |g|= 9.34e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [2.14461798e+03 2.27473030e+02 1.42699900e+03 5.76030269e-01
 5.00549057e+01 1.32727910e+01 1.93060459e+00 2.77704515e+00
 1.33280442e+01 6.00518644e-01]
grad_E = [-9.94848893e-06  7.14455296e-06  3.37219242e-05 -1.19929944e-05
  1.67181764e-06 -8.83657195e-06  3.00424678e-06 -7.52423878e-05
 -6.68548055e-06 -2.09816743e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:39 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61956932        1
[INPUT] 0    0    [1    /1   ]  227.468144817        1
[INPUT] 0    0    [1    /1   ]  1426.99393674        1
[INPUT] 0    0    [1    /1   ]  0.576005229267       1
[INPUT] 0    0    [1    /1   ]  50.0535481462        1
[INPUT] 0    0    [1    /1   ]  13.2724080499        1
[INPUT] 0    0    [1    /1   ]  1.93051741661        1
[INPUT] 1    0    [1    /1   ]  2.77650361819        1
[INPUT] 1    0    [1    /1   ]  13.3248857752        1
[INPUT] 1    0    [1    /1   ]  0.60043263051        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.619569324372, 1.0]], [0, [227.4681448169942, 1.0]], [0, [1426.9939367433724, 1.0]], [0, [0.5760052292670905, 1.0]], [0, [50.053548146227484, 1.0]], [0, [13.272408049938061, 1.0]], [0, [1.9305174166051908, 1.0]], [1, [2.7765036181887526, 1.0]], [1, [13.324885775173504, 1.0]], [1, [0.6004326305104266, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61956932]
bas 1, expnt(s) = [227.46814482]
bas 2, expnt(s) = [1426.99393674]
bas 3, expnt(s) = [0.57600523]
bas 4, expnt(s) = [50.05354815]
bas 5, expnt(s) = [13.27240805]
bas 6, expnt(s) = [1.93051742]
bas 7, expnt(s) = [2.77650362]
bas 8, expnt(s) = [13.32488578]
bas 9, expnt(s) = [0.60043263]
CPU time:       176.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461957e+03 7.96210174e+02 2.27468145e+02 1.47980832e+02
 1.42699394e+03 5.86585901e+02 5.76005229e-01 1.67045524e+00
 5.00535481e+01 4.75435028e+01 1.32724080e+01 1.75682021e+01
 1.93051742e+00 4.13780783e+00 2.77650362e+00 1.04557983e+01
 1.33248858e+01 7.42700577e+01 6.00432631e-01 1.54193033e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96561608851755
cond(S) = 160.07744032359795
E1 = -183.13695334887228  E_coul = 55.01151460129361
init E= -128.125438747579
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.7428971095257  LUMO = 2.65702817474642
  mo_energy =
[-3.25136847e+01 -1.85363572e+00 -7.42897110e-01 -7.42897110e-01
 -7.42897110e-01  2.65702817e+00  2.65702817e+00  2.65702817e+00
  2.77165817e+00  1.99496427e+01  1.99496427e+01  1.99496427e+01
  4.55735318e+01  3.35429644e+02  2.02631054e+03  7.31820230e+03]
E1 = -182.1349151800284  E_coul = 53.93832055461884
cycle= 1 E= -128.19659462541  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259994
diis-c [-0.06759689  1.        ]
  HOMO = -0.807687123117734  LUMO = 2.60308607691562
  mo_energy =
[-3.27866888e+01 -1.92073498e+00 -8.07687123e-01 -8.07687123e-01
 -8.07687123e-01  2.60308608e+00  2.60308608e+00  2.60308608e+00
  2.71772728e+00  1.97593353e+01  1.97593353e+01  1.97593353e+01
  4.53382225e+01  3.35119642e+02  2.02595221e+03  7.31781974e+03]
E1 = -182.59641931388632  E_coul = 54.39819748910791
cycle= 2 E= -128.198221824778  delta_E= -0.00163  |g|= 0.0624  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101676
diis-c [-4.03713906e-04  2.77722455e-01  7.22277545e-01]
  HOMO = -0.784968559418865  LUMO = 2.623658205184
  mo_energy =
[-3.27120651e+01 -1.89715968e+00 -7.84968559e-01 -7.84968559e-01
 -7.84968559e-01  2.62365821e+00  2.62365821e+00  2.62365821e+00
  2.73790216e+00  1.98153748e+01  1.98153748e+01  1.98153748e+01
  4.54043065e+01  3.35201290e+02  2.02603923e+03  7.31790825e+03]
E1 = -182.4644647799024  E_coul = 54.26593898139869
cycle= 3 E= -128.198525798504  delta_E= -0.000304  |g|= 0.00069  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000875407
diis-c [-7.49659764e-08 -3.88552637e-03 -1.79393961e-03  1.00567947e+00]
  HOMO = -0.785198246869679  LUMO = 2.62348450667766
  mo_energy =
[-3.27127211e+01 -1.89745855e+00 -7.85198247e-01 -7.85198247e-01
 -7.85198247e-01  2.62348451e+00  2.62348451e+00  2.62348451e+00
  2.73766665e+00  1.98148619e+01  1.98148619e+01  1.98148619e+01
  4.54036895e+01  3.35200794e+02  2.02603886e+03  7.31790792e+03]
E1 = -182.46573030783176  E_coul = 54.267204476493994
cycle= 4 E= -128.198525831338  delta_E= -3.28e-08  |g|= 5.04e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.00962e-05
diis-c [-2.09126434e-10  5.02425976e-04 -8.47846046e-04 -1.69421298e-01
  1.16976672e+00]
  HOMO = -0.785183877711853  LUMO = 2.62349694564357
  mo_energy =
[-3.27126841e+01 -1.89745600e+00 -7.85183878e-01 -7.85183878e-01
 -7.85183878e-01  2.62349695e+00  2.62349695e+00  2.62349695e+00
  2.73766806e+00  1.98148905e+01  1.98148905e+01  1.98148905e+01
  4.54037197e+01  3.35200846e+02  2.02603893e+03  7.31790799e+03]
E1 = -182.46566807668296  E_coul = 54.26714224505559
cycle= 5 E= -128.198525831627  delta_E= -2.9e-10  |g|= 1.54e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46566807668296  E_coul = 54.26714224505559
  HOMO = -0.785183818718107  LUMO = 2.62349701338316
  mo_energy =
[-3.27126840e+01 -1.89745632e+00 -7.85183819e-01 -7.85183819e-01
 -7.85183819e-01  2.62349701e+00  2.62349701e+00  2.62349701e+00
  2.73766778e+00  1.98148905e+01  1.98148905e+01  1.98148905e+01
  4.54037196e+01  3.35200846e+02  2.02603893e+03  7.31790799e+03]
E1 = -182.46566806692795  E_coul = 54.26714223530037
Extra cycle  E= -128.198525831628  delta_E= -2.27e-13  |g|= 2.81e-07  |ddm|= 8.92e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14461957e+03 2.27468145e+02 1.42699394e+03 5.76005229e-01
 5.00535481e+01 1.32724080e+01 1.93051742e+00 2.77650362e+00
 1.33248858e+01 6.00432631e-01]
E = -128.1985258316276
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.61956932        1
[INPUT] 0    0    [1    /1   ]  227.468144817        1
[INPUT] 0    0    [1    /1   ]  1426.99393674        1
[INPUT] 0    0    [1    /1   ]  0.576005229267       1
[INPUT] 0    0    [1    /1   ]  50.0535481462        1
[INPUT] 0    0    [1    /1   ]  13.2724080499        1
[INPUT] 0    0    [1    /1   ]  1.93051741661        1
[INPUT] 1    0    [1    /1   ]  2.77650361819        1
[INPUT] 1    0    [1    /1   ]  13.3248857752        1
[INPUT] 1    0    [1    /1   ]  0.60043263051        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.619569324372, 1.0]], [0, [227.4681448169942, 1.0]], [0, [1426.9939367433724, 1.0]], [0, [0.5760052292670905, 1.0]], [0, [50.053548146227484, 1.0]], [0, [13.272408049938061, 1.0]], [0, [1.9305174166051908, 1.0]], [1, [2.7765036181887526, 1.0]], [1, [13.324885775173504, 1.0]], [1, [0.6004326305104266, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.61956932]
bas 1, expnt(s) = [227.46814482]
bas 2, expnt(s) = [1426.99393674]
bas 3, expnt(s) = [0.57600523]
bas 4, expnt(s) = [50.05354815]
bas 5, expnt(s) = [13.27240805]
bas 6, expnt(s) = [1.93051742]
bas 7, expnt(s) = [2.77650362]
bas 8, expnt(s) = [13.32488578]
bas 9, expnt(s) = [0.60043263]
CPU time:       177.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14461957e+03 7.96210174e+02 2.27468145e+02 1.47980832e+02
 1.42699394e+03 5.86585901e+02 5.76005229e-01 1.67045524e+00
 5.00535481e+01 4.75435028e+01 1.32724080e+01 1.75682021e+01
 1.93051742e+00 4.13780783e+00 2.77650362e+00 1.04557983e+01
 1.33248858e+01 7.42700577e+01 6.00432631e-01 1.54193033e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96561608851755
cond(S) = 160.07744032359795
E1 = -183.13695334887228  E_coul = 55.01151460129361
init E= -128.125438747579
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.7428971095257  LUMO = 2.65702817474642
  mo_energy =
[-3.25136847e+01 -1.85363572e+00 -7.42897110e-01 -7.42897110e-01
 -7.42897110e-01  2.65702817e+00  2.65702817e+00  2.65702817e+00
  2.77165817e+00  1.99496427e+01  1.99496427e+01  1.99496427e+01
  4.55735318e+01  3.35429644e+02  2.02631054e+03  7.31820230e+03]
E1 = -182.1349151800284  E_coul = 53.93832055461884
cycle= 1 E= -128.19659462541  delta_E= -0.0712  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.259994
diis-c [-0.06759689  1.        ]
  HOMO = -0.807687123117734  LUMO = 2.60308607691562
  mo_energy =
[-3.27866888e+01 -1.92073498e+00 -8.07687123e-01 -8.07687123e-01
 -8.07687123e-01  2.60308608e+00  2.60308608e+00  2.60308608e+00
  2.71772728e+00  1.97593353e+01  1.97593353e+01  1.97593353e+01
  4.53382225e+01  3.35119642e+02  2.02595221e+03  7.31781974e+03]
E1 = -182.59641931388632  E_coul = 54.39819748910791
cycle= 2 E= -128.198221824778  delta_E= -0.00163  |g|= 0.0624  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101676
diis-c [-4.03713906e-04  2.77722455e-01  7.22277545e-01]
  HOMO = -0.784968559418865  LUMO = 2.623658205184
  mo_energy =
[-3.27120651e+01 -1.89715968e+00 -7.84968559e-01 -7.84968559e-01
 -7.84968559e-01  2.62365821e+00  2.62365821e+00  2.62365821e+00
  2.73790216e+00  1.98153748e+01  1.98153748e+01  1.98153748e+01
  4.54043065e+01  3.35201290e+02  2.02603923e+03  7.31790825e+03]
E1 = -182.4644647799024  E_coul = 54.26593898139869
cycle= 3 E= -128.198525798504  delta_E= -0.000304  |g|= 0.00069  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000875407
diis-c [-7.49659764e-08 -3.88552637e-03 -1.79393961e-03  1.00567947e+00]
  HOMO = -0.785198246869679  LUMO = 2.62348450667766
  mo_energy =
[-3.27127211e+01 -1.89745855e+00 -7.85198247e-01 -7.85198247e-01
 -7.85198247e-01  2.62348451e+00  2.62348451e+00  2.62348451e+00
  2.73766665e+00  1.98148619e+01  1.98148619e+01  1.98148619e+01
  4.54036895e+01  3.35200794e+02  2.02603886e+03  7.31790792e+03]
E1 = -182.46573030783176  E_coul = 54.267204476493994
cycle= 4 E= -128.198525831338  delta_E= -3.28e-08  |g|= 5.04e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.00962e-05
diis-c [-2.09126434e-10  5.02425976e-04 -8.47846046e-04 -1.69421298e-01
  1.16976672e+00]
  HOMO = -0.785183877711853  LUMO = 2.62349694564357
  mo_energy =
[-3.27126841e+01 -1.89745600e+00 -7.85183878e-01 -7.85183878e-01
 -7.85183878e-01  2.62349695e+00  2.62349695e+00  2.62349695e+00
  2.73766806e+00  1.98148905e+01  1.98148905e+01  1.98148905e+01
  4.54037197e+01  3.35200846e+02  2.02603893e+03  7.31790799e+03]
E1 = -182.46566807668296  E_coul = 54.26714224505559
cycle= 5 E= -128.198525831627  delta_E= -2.9e-10  |g|= 1.54e-06  |ddm|= 2.55e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46566807668296  E_coul = 54.26714224505559
  HOMO = -0.785183818718107  LUMO = 2.62349701338316
  mo_energy =
[-3.27126840e+01 -1.89745632e+00 -7.85183819e-01 -7.85183819e-01
 -7.85183819e-01  2.62349701e+00  2.62349701e+00  2.62349701e+00
  2.73766778e+00  1.98148905e+01  1.98148905e+01  1.98148905e+01
  4.54037196e+01  3.35200846e+02  2.02603893e+03  7.31790799e+03]
E1 = -182.46566806692795  E_coul = 54.26714223530037
Extra cycle  E= -128.198525831628  delta_E= -2.27e-13  |g|= 2.81e-07  |ddm|= 8.92e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.07744032359795
E1 = -182.46566806692795  E_coul = 54.26714223530037
init E= -128.198525831628
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785183804273122  LUMO = 2.62349702489361
  mo_energy =
[-3.27126840e+01 -1.89745638e+00 -7.85183804e-01 -7.85183804e-01
 -7.85183804e-01  2.62349702e+00  2.62349702e+00  2.62349702e+00
  2.73766773e+00  1.98148905e+01  1.98148905e+01  1.98148905e+01
  4.54037196e+01  3.35200846e+02  2.02603893e+03  7.31790799e+03]
E1 = -182.46566807787983  E_coul = 54.26714224625214
cycle= 1 E= -128.198525831628  delta_E= -8.53e-14  |g|= 5.12e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46566807787983  E_coul = 54.26714224625214
  HOMO = -0.785183800649518  LUMO = 2.62349702790829
  mo_energy =
[-3.27126840e+01 -1.89745639e+00 -7.85183801e-01 -7.85183801e-01
 -7.85183801e-01  2.62349703e+00  2.62349703e+00  2.62349703e+00
  2.73766772e+00  1.98148905e+01  1.98148905e+01  1.98148905e+01
  4.54037196e+01  3.35200846e+02  2.02603893e+03  7.31790799e+03]
E1 = -182.46566807546256  E_coul = 54.267142243834776
Extra cycle  E= -128.198525831628  delta_E= -1.14e-13  |g|= 9.34e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14461957e+03 2.27468145e+02 1.42699394e+03 5.76005229e-01
 5.00535481e+01 1.32724080e+01 1.93051742e+00 2.77650362e+00
 1.33248858e+01 6.00432631e-01]
grad_E = [-9.94810626e-06  7.12662660e-06  3.37253452e-05 -1.88428939e-05
  2.12359868e-06 -1.41054600e-05  4.75289910e-06 -1.19259317e-04
 -1.30594014e-05 -3.31453832e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.62273979        1
[INPUT] 0    0    [1    /1   ]  227.460847584        1
[INPUT] 0    0    [1    /1   ]  1426.98361806        1
[INPUT] 0    0    [1    /1   ]  0.57596852759        1
[INPUT] 0    0    [1    /1   ]  50.0515450271        1
[INPUT] 0    0    [1    /1   ]  13.2718452268        1
[INPUT] 0    0    [1    /1   ]  1.93038973531        1
[INPUT] 1    0    [1    /1   ]  2.77571504387        1
[INPUT] 1    0    [1    /1   ]  13.3202932296        1
[INPUT] 1    0    [1    /1   ]  0.600307300759       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6227397942644, 1.0]], [0, [227.46084758376838, 1.0]], [0, [1426.9836180558093, 1.0]], [0, [0.5759685275903929, 1.0]], [0, [50.0515450270927, 1.0]], [0, [13.271845226772435, 1.0]], [0, [1.9303897353133164, 1.0]], [1, [2.7757150438706772, 1.0]], [1, [13.320293229645706, 1.0]], [1, [0.6003073007585632, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.62273979]
bas 1, expnt(s) = [227.46084758]
bas 2, expnt(s) = [1426.98361806]
bas 3, expnt(s) = [0.57596853]
bas 4, expnt(s) = [50.05154503]
bas 5, expnt(s) = [13.27184523]
bas 6, expnt(s) = [1.93038974]
bas 7, expnt(s) = [2.77571504]
bas 8, expnt(s) = [13.32029323]
bas 9, expnt(s) = [0.6003073]
CPU time:       180.57
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14462274e+03 7.96211057e+02 2.27460848e+02 1.47977271e+02
 1.42698362e+03 5.86582720e+02 5.75968528e-01 1.67037541e+00
 5.00515450e+01 4.75420758e+01 1.32718452e+01 1.75676433e+01
 1.93038974e+00 4.13760258e+00 2.77571504e+00 1.04520864e+01
 1.33202932e+01 7.42380617e+01 6.00307301e-01 1.54152802e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965642624653945
cond(S) = 160.06686135377922
E1 = -183.13694780486466  E_coul = 55.01149502684124
init E= -128.125452778023
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742896906154957  LUMO = 2.65624384350768
  mo_energy =
[-3.25136972e+01 -1.85363607e+00 -7.42896906e-01 -7.42896906e-01
 -7.42896906e-01  2.65624384e+00  2.65624384e+00  2.65624384e+00
  2.77135717e+00  1.99419941e+01  1.99419941e+01  1.99419941e+01
  4.55704293e+01  3.35414897e+02  2.02627399e+03  7.31814972e+03]
E1 = -182.13416343891848  E_coul = 53.93757090810131
cycle= 1 E= -128.196592530817  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260125
diis-c [-0.06766501  1.        ]
  HOMO = -0.807740434348693  LUMO = 2.60226783386082
  mo_energy =
[-3.27868423e+01 -1.92079696e+00 -8.07740434e-01 -8.07740434e-01
 -8.07740434e-01  2.60226783e+00  2.60226783e+00  2.60226783e+00
  2.71737642e+00  1.97516031e+01  1.97516031e+01  1.97516031e+01
  4.53349950e+01  3.35104748e+02  2.02591551e+03  7.31776702e+03]
E1 = -182.59598658961056  E_coul = 54.397764981169075
cycle= 2 E= -128.198221608441  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101748
diis-c [-4.03855678e-04  2.77766247e-01  7.22233753e-01]
  HOMO = -0.785007025233857  LUMO = 2.62284816320029
  mo_energy =
[-3.27121740e+01 -1.89720601e+00 -7.85007025e-01 -7.85007025e-01
 -7.85007025e-01  2.62284816e+00  2.62284816e+00  2.62284816e+00
  2.73756312e+00  1.98076703e+01  1.98076703e+01  1.98076703e+01
  4.54011182e+01  3.35186444e+02  2.02600257e+03  7.31785557e+03]
E1 = -182.4639336739486  E_coul = 54.26540765507051
cycle= 3 E= -128.198526018878  delta_E= -0.000304  |g|= 0.00069  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000873476
diis-c [-7.53868913e-08 -3.88810327e-03 -1.82847774e-03  1.00571658e+00]
  HOMO = -0.785236196223679  LUMO = 2.62267501267485
  mo_energy =
[-3.27128286e+01 -1.89750455e+00 -7.85236196e-01 -7.85236196e-01
 -7.85236196e-01  2.62267501e+00  2.62267501e+00  2.62267501e+00
  2.73732794e+00  1.98071585e+01  1.98071585e+01  1.98071585e+01
  4.54005025e+01  3.35185949e+02  2.02600221e+03  7.31785525e+03]
E1 = -182.4651966826756  E_coul = 54.26667063103037
cycle= 4 E= -128.198526051645  delta_E= -3.28e-08  |g|= 5.05e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.03173e-05
diis-c [-2.09763783e-10  5.02724998e-04 -8.44766447e-04 -1.69550186e-01
  1.16989223e+00]
  HOMO = -0.785221791842403  LUMO = 2.62268747820131
  mo_energy =
[-3.27127915e+01 -1.89750201e+00 -7.85221792e-01 -7.85221792e-01
 -7.85221792e-01  2.62268748e+00  2.62268748e+00  2.62268748e+00
  2.73732934e+00  1.98071872e+01  1.98071872e+01  1.98071872e+01
  4.54005327e+01  3.35186000e+02  2.02600228e+03  7.31785532e+03]
E1 = -182.4651342986621  E_coul = 54.26660824672514
cycle= 5 E= -128.198526051937  delta_E= -2.92e-10  |g|= 1.54e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4651342986621  E_coul = 54.26660824672514
  HOMO = -0.785221732757525  LUMO = 2.62268754606804
  mo_energy =
[-3.27127914e+01 -1.89750233e+00 -7.85221733e-01 -7.85221733e-01
 -7.85221733e-01  2.62268755e+00  2.62268755e+00  2.62268755e+00
  2.73732906e+00  1.98071873e+01  1.98071873e+01  1.98071873e+01
  4.54005327e+01  3.35186000e+02  2.02600228e+03  7.31785532e+03]
E1 = -182.46513428793304  E_coul = 54.266608235995825
Extra cycle  E= -128.198526051937  delta_E= -2.84e-13  |g|= 2.81e-07  |ddm|= 8.92e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14462274e+03 2.27460848e+02 1.42698362e+03 5.75968528e-01
 5.00515450e+01 1.32718452e+01 1.93038974e+00 2.77571504e+00
 1.33202932e+01 6.00307301e-01]
E = -128.19852605193722
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.62273979        1
[INPUT] 0    0    [1    /1   ]  227.460847584        1
[INPUT] 0    0    [1    /1   ]  1426.98361806        1
[INPUT] 0    0    [1    /1   ]  0.57596852759        1
[INPUT] 0    0    [1    /1   ]  50.0515450271        1
[INPUT] 0    0    [1    /1   ]  13.2718452268        1
[INPUT] 0    0    [1    /1   ]  1.93038973531        1
[INPUT] 1    0    [1    /1   ]  2.77571504387        1
[INPUT] 1    0    [1    /1   ]  13.3202932296        1
[INPUT] 1    0    [1    /1   ]  0.600307300759       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6227397942644, 1.0]], [0, [227.46084758376838, 1.0]], [0, [1426.9836180558093, 1.0]], [0, [0.5759685275903929, 1.0]], [0, [50.0515450270927, 1.0]], [0, [13.271845226772435, 1.0]], [0, [1.9303897353133164, 1.0]], [1, [2.7757150438706772, 1.0]], [1, [13.320293229645706, 1.0]], [1, [0.6003073007585632, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.62273979]
bas 1, expnt(s) = [227.46084758]
bas 2, expnt(s) = [1426.98361806]
bas 3, expnt(s) = [0.57596853]
bas 4, expnt(s) = [50.05154503]
bas 5, expnt(s) = [13.27184523]
bas 6, expnt(s) = [1.93038974]
bas 7, expnt(s) = [2.77571504]
bas 8, expnt(s) = [13.32029323]
bas 9, expnt(s) = [0.6003073]
CPU time:       181.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14462274e+03 7.96211057e+02 2.27460848e+02 1.47977271e+02
 1.42698362e+03 5.86582720e+02 5.75968528e-01 1.67037541e+00
 5.00515450e+01 4.75420758e+01 1.32718452e+01 1.75676433e+01
 1.93038974e+00 4.13760258e+00 2.77571504e+00 1.04520864e+01
 1.33202932e+01 7.42380617e+01 6.00307301e-01 1.54152802e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965642624653945
cond(S) = 160.06686135377922
E1 = -183.13694780486466  E_coul = 55.01149502684124
init E= -128.125452778023
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742896906154957  LUMO = 2.65624384350768
  mo_energy =
[-3.25136972e+01 -1.85363607e+00 -7.42896906e-01 -7.42896906e-01
 -7.42896906e-01  2.65624384e+00  2.65624384e+00  2.65624384e+00
  2.77135717e+00  1.99419941e+01  1.99419941e+01  1.99419941e+01
  4.55704293e+01  3.35414897e+02  2.02627399e+03  7.31814972e+03]
E1 = -182.13416343891848  E_coul = 53.93757090810131
cycle= 1 E= -128.196592530817  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260125
diis-c [-0.06766501  1.        ]
  HOMO = -0.807740434348693  LUMO = 2.60226783386082
  mo_energy =
[-3.27868423e+01 -1.92079696e+00 -8.07740434e-01 -8.07740434e-01
 -8.07740434e-01  2.60226783e+00  2.60226783e+00  2.60226783e+00
  2.71737642e+00  1.97516031e+01  1.97516031e+01  1.97516031e+01
  4.53349950e+01  3.35104748e+02  2.02591551e+03  7.31776702e+03]
E1 = -182.59598658961056  E_coul = 54.397764981169075
cycle= 2 E= -128.198221608441  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101748
diis-c [-4.03855678e-04  2.77766247e-01  7.22233753e-01]
  HOMO = -0.785007025233857  LUMO = 2.62284816320029
  mo_energy =
[-3.27121740e+01 -1.89720601e+00 -7.85007025e-01 -7.85007025e-01
 -7.85007025e-01  2.62284816e+00  2.62284816e+00  2.62284816e+00
  2.73756312e+00  1.98076703e+01  1.98076703e+01  1.98076703e+01
  4.54011182e+01  3.35186444e+02  2.02600257e+03  7.31785557e+03]
E1 = -182.4639336739486  E_coul = 54.26540765507051
cycle= 3 E= -128.198526018878  delta_E= -0.000304  |g|= 0.00069  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000873476
diis-c [-7.53868913e-08 -3.88810327e-03 -1.82847774e-03  1.00571658e+00]
  HOMO = -0.785236196223679  LUMO = 2.62267501267485
  mo_energy =
[-3.27128286e+01 -1.89750455e+00 -7.85236196e-01 -7.85236196e-01
 -7.85236196e-01  2.62267501e+00  2.62267501e+00  2.62267501e+00
  2.73732794e+00  1.98071585e+01  1.98071585e+01  1.98071585e+01
  4.54005025e+01  3.35185949e+02  2.02600221e+03  7.31785525e+03]
E1 = -182.4651966826756  E_coul = 54.26667063103037
cycle= 4 E= -128.198526051645  delta_E= -3.28e-08  |g|= 5.05e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.03173e-05
diis-c [-2.09763783e-10  5.02724998e-04 -8.44766447e-04 -1.69550186e-01
  1.16989223e+00]
  HOMO = -0.785221791842403  LUMO = 2.62268747820131
  mo_energy =
[-3.27127915e+01 -1.89750201e+00 -7.85221792e-01 -7.85221792e-01
 -7.85221792e-01  2.62268748e+00  2.62268748e+00  2.62268748e+00
  2.73732934e+00  1.98071872e+01  1.98071872e+01  1.98071872e+01
  4.54005327e+01  3.35186000e+02  2.02600228e+03  7.31785532e+03]
E1 = -182.4651342986621  E_coul = 54.26660824672514
cycle= 5 E= -128.198526051937  delta_E= -2.92e-10  |g|= 1.54e-06  |ddm|= 2.56e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4651342986621  E_coul = 54.26660824672514
  HOMO = -0.785221732757525  LUMO = 2.62268754606804
  mo_energy =
[-3.27127914e+01 -1.89750233e+00 -7.85221733e-01 -7.85221733e-01
 -7.85221733e-01  2.62268755e+00  2.62268755e+00  2.62268755e+00
  2.73732906e+00  1.98071873e+01  1.98071873e+01  1.98071873e+01
  4.54005327e+01  3.35186000e+02  2.02600228e+03  7.31785532e+03]
E1 = -182.46513428793304  E_coul = 54.266608235995825
Extra cycle  E= -128.198526051937  delta_E= -2.84e-13  |g|= 2.81e-07  |ddm|= 8.92e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.06686135377922
E1 = -182.46513428793304  E_coul = 54.266608235995825
init E= -128.198526051937
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785221718375122  LUMO = 2.62268755751648
  mo_energy =
[-3.27127914e+01 -1.89750239e+00 -7.85221718e-01 -7.85221718e-01
 -7.85221718e-01  2.62268756e+00  2.62268756e+00  2.62268756e+00
  2.73732901e+00  1.98071873e+01  1.98071873e+01  1.98071873e+01
  4.54005327e+01  3.35186001e+02  2.02600228e+03  7.31785532e+03]
E1 = -182.46513429922126  E_coul = 54.26660824728426
cycle= 1 E= -128.198526051937  delta_E= 2.27e-13  |g|= 5.13e-08  |ddm|= 1.6e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46513429922126  E_coul = 54.26660824728426
  HOMO = -0.785221714727288  LUMO = 2.62268756055191
  mo_energy =
[-3.27127914e+01 -1.89750240e+00 -7.85221715e-01 -7.85221715e-01
 -7.85221715e-01  2.62268756e+00  2.62268756e+00  2.62268756e+00
  2.73732900e+00  1.98071873e+01  1.98071873e+01  1.98071873e+01
  4.54005327e+01  3.35186001e+02  2.02600228e+03  7.31785532e+03]
E1 = -182.46513429666297  E_coul = 54.26660824472575
Extra cycle  E= -128.198526051937  delta_E= -2.27e-13  |g|= 9.35e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14462274e+03 2.27460848e+02 1.42698362e+03 5.75968528e-01
 5.00515450e+01 1.32718452e+01 1.93038974e+00 2.77571504e+00
 1.33202932e+01 6.00307301e-01]
grad_E = [-9.94765206e-06  7.09953916e-06  3.37305467e-05 -2.88707522e-05
  2.79010198e-06 -2.18244517e-05  7.31558220e-06 -1.83742894e-04
 -2.22744421e-05 -5.09575217e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.62860759        1
[INPUT] 0    0    [1    /1   ]  227.451050201        1
[INPUT] 0    0    [1    /1   ]  1426.96420807        1
[INPUT] 0    0    [1    /1   ]  0.575920572663       1
[INPUT] 0    0    [1    /1   ]  50.0489014898        1
[INPUT] 0    0    [1    /1   ]  13.2711070848        1
[INPUT] 0    0    [1    /1   ]  1.93022302435        1
[INPUT] 1    0    [1    /1   ]  2.77469226794        1
[INPUT] 1    0    [1    /1   ]  13.314344864         1
[INPUT] 1    0    [1    /1   ]  0.600144646887       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.628607586287, 1.0]], [0, [227.45105020122253, 1.0]], [0, [1426.964208074455, 1.0]], [0, [0.5759205726634744, 1.0]], [0, [50.04890148979742, 1.0]], [0, [13.271107084842471, 1.0]], [0, [1.930223024346768, 1.0]], [1, [2.7746922679398756, 1.0]], [1, [13.31434486401013, 1.0]], [1, [0.6001446468872869, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.62860759]
bas 1, expnt(s) = [227.4510502]
bas 2, expnt(s) = [1426.96420807]
bas 3, expnt(s) = [0.57592057]
bas 4, expnt(s) = [50.04890149]
bas 5, expnt(s) = [13.27110708]
bas 6, expnt(s) = [1.93022302]
bas 7, expnt(s) = [2.77469227]
bas 8, expnt(s) = [13.31434486]
bas 9, expnt(s) = [0.60014465]
CPU time:       184.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14462861e+03 7.96212691e+02 2.27451050e+02 1.47972491e+02
 1.42696421e+03 5.86576736e+02 5.75920573e-01 1.67027111e+00
 5.00489015e+01 4.75401926e+01 1.32711071e+01 1.75669105e+01
 1.93022302e+00 4.13733458e+00 2.77469227e+00 1.04472725e+01
 1.33143449e+01 7.41966239e+01 6.00144647e-01 1.54100594e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965677045480847
cond(S) = 160.04959958216546
E1 = -183.1369406036345  E_coul = 55.01146950285018
init E= -128.125471100784
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742896634871719  LUMO = 2.65522622126519
  mo_energy =
[-3.25137136e+01 -1.85363656e+00 -7.42896635e-01 -7.42896635e-01
 -7.42896635e-01  2.65522622e+00  2.65522622e+00  2.65522622e+00
  2.77096396e+00  1.99320832e+01  1.99320832e+01  1.99320832e+01
  4.55663556e+01  3.35395290e+02  2.02622227e+03  7.31806969e+03]
E1 = -182.13318737161188  E_coul = 53.93659748678313
cycle= 1 E= -128.196589884829  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260295
diis-c [-0.06775351  1.        ]
  HOMO = -0.807809634019554  LUMO = 2.60120620605653
  mo_energy =
[-3.27870418e+01 -1.92087745e+00 -8.07809634e-01 -8.07809634e-01
 -8.07809634e-01  2.60120621e+00  2.60120621e+00  2.60120621e+00
  2.71691854e+00  1.97415836e+01  1.97415836e+01  1.97415836e+01
  4.53307588e+01  3.35084950e+02  2.02586359e+03  7.31768679e+03]
E1 = -182.59542482288967  E_coul = 54.39720341985782
cycle= 2 E= -128.198221403032  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10184
diis-c [-4.04038734e-04  2.77823058e-01  7.22176942e-01]
  HOMO = -0.785056945883443  LUMO = 2.62179718189259
  mo_energy =
[-3.27123155e+01 -1.89726616e+00 -7.85056946e-01 -7.85056946e-01
 -7.85056946e-01  2.62179718e+00  2.62179718e+00  2.62179718e+00
  2.73712060e+00  1.97976867e+01  1.97976867e+01  1.97976867e+01
  4.53969330e+01  3.35166707e+02  2.02595073e+03  7.31777541e+03]
E1 = -182.46324413782372  E_coul = 54.264717756754095
cycle= 3 E= -128.19852638107  delta_E= -0.000305  |g|= 0.000689  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000870972
diis-c [-7.59349574e-08 -3.89145715e-03 -1.87330884e-03  1.00576477e+00]
  HOMO = -0.785285445719329  LUMO = 2.62162474304595
  mo_energy =
[-3.27129682e+01 -1.89756429e+00 -7.85285446e-01 -7.85285446e-01
 -7.85285446e-01  2.62162474e+00  2.62162474e+00  2.62162474e+00
  2.73688582e+00  1.97971765e+01  1.97971765e+01  1.97971765e+01
  4.53963190e+01  3.35166215e+02  2.02595037e+03  7.31777509e+03]
E1 = -182.46450387093773  E_coul = 54.26597745718732
cycle= 4 E= -128.19852641375  delta_E= -3.27e-08  |g|= 5.07e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.06043e-05
diis-c [-2.10593357e-10  5.03108127e-04 -8.40755830e-04 -1.69715858e-01
  1.17005351e+00]
  HOMO = -0.78527099565951  LUMO = 2.62163724298297
  mo_energy =
[-3.27129310e+01 -1.89756176e+00 -7.85270996e-01 -7.85270996e-01
 -7.85270996e-01  2.62163724e+00  2.62163724e+00  2.62163724e+00
  2.73688721e+00  1.97972053e+01  1.97972053e+01  1.97972053e+01
  4.53963493e+01  3.35166267e+02  2.02595043e+03  7.31777516e+03]
E1 = -182.46444128862274  E_coul = 54.26591487457835
cycle= 5 E= -128.198526414044  delta_E= -2.94e-10  |g|= 1.54e-06  |ddm|= 2.57e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46444128862274  E_coul = 54.26591487457835
  HOMO = -0.785270936448697  LUMO = 2.62163731102157
  mo_energy =
[-3.27129309e+01 -1.89756208e+00 -7.85270936e-01 -7.85270936e-01
 -7.85270936e-01  2.62163731e+00  2.62163731e+00  2.62163731e+00
  2.73688694e+00  1.97972053e+01  1.97972053e+01  1.97972053e+01
  4.53963492e+01  3.35166267e+02  2.02595043e+03  7.31777516e+03]
E1 = -182.4644412765895  E_coul = 54.265914862544776
Extra cycle  E= -128.198526414045  delta_E= -3.41e-13  |g|= 2.82e-07  |ddm|= 8.93e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14462861e+03 2.27451050e+02 1.42696421e+03 5.75920573e-01
 5.00489015e+01 1.32711071e+01 1.93022302e+00 2.77469227e+00
 1.33143449e+01 6.00144647e-01]
E = -128.19852641404472
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.62860759        1
[INPUT] 0    0    [1    /1   ]  227.451050201        1
[INPUT] 0    0    [1    /1   ]  1426.96420807        1
[INPUT] 0    0    [1    /1   ]  0.575920572663       1
[INPUT] 0    0    [1    /1   ]  50.0489014898        1
[INPUT] 0    0    [1    /1   ]  13.2711070848        1
[INPUT] 0    0    [1    /1   ]  1.93022302435        1
[INPUT] 1    0    [1    /1   ]  2.77469226794        1
[INPUT] 1    0    [1    /1   ]  13.314344864         1
[INPUT] 1    0    [1    /1   ]  0.600144646887       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.628607586287, 1.0]], [0, [227.45105020122253, 1.0]], [0, [1426.964208074455, 1.0]], [0, [0.5759205726634744, 1.0]], [0, [50.04890148979742, 1.0]], [0, [13.271107084842471, 1.0]], [0, [1.930223024346768, 1.0]], [1, [2.7746922679398756, 1.0]], [1, [13.31434486401013, 1.0]], [1, [0.6001446468872869, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.62860759]
bas 1, expnt(s) = [227.4510502]
bas 2, expnt(s) = [1426.96420807]
bas 3, expnt(s) = [0.57592057]
bas 4, expnt(s) = [50.04890149]
bas 5, expnt(s) = [13.27110708]
bas 6, expnt(s) = [1.93022302]
bas 7, expnt(s) = [2.77469227]
bas 8, expnt(s) = [13.31434486]
bas 9, expnt(s) = [0.60014465]
CPU time:       185.16
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14462861e+03 7.96212691e+02 2.27451050e+02 1.47972491e+02
 1.42696421e+03 5.86576736e+02 5.75920573e-01 1.67027111e+00
 5.00489015e+01 4.75401926e+01 1.32711071e+01 1.75669105e+01
 1.93022302e+00 4.13733458e+00 2.77469227e+00 1.04472725e+01
 1.33143449e+01 7.41966239e+01 6.00144647e-01 1.54100594e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965677045480847
cond(S) = 160.04959958216546
E1 = -183.1369406036345  E_coul = 55.01146950285018
init E= -128.125471100784
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742896634871719  LUMO = 2.65522622126519
  mo_energy =
[-3.25137136e+01 -1.85363656e+00 -7.42896635e-01 -7.42896635e-01
 -7.42896635e-01  2.65522622e+00  2.65522622e+00  2.65522622e+00
  2.77096396e+00  1.99320832e+01  1.99320832e+01  1.99320832e+01
  4.55663556e+01  3.35395290e+02  2.02622227e+03  7.31806969e+03]
E1 = -182.13318737161188  E_coul = 53.93659748678313
cycle= 1 E= -128.196589884829  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260295
diis-c [-0.06775351  1.        ]
  HOMO = -0.807809634019554  LUMO = 2.60120620605653
  mo_energy =
[-3.27870418e+01 -1.92087745e+00 -8.07809634e-01 -8.07809634e-01
 -8.07809634e-01  2.60120621e+00  2.60120621e+00  2.60120621e+00
  2.71691854e+00  1.97415836e+01  1.97415836e+01  1.97415836e+01
  4.53307588e+01  3.35084950e+02  2.02586359e+03  7.31768679e+03]
E1 = -182.59542482288967  E_coul = 54.39720341985782
cycle= 2 E= -128.198221403032  delta_E= -0.00163  |g|= 0.0625  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10184
diis-c [-4.04038734e-04  2.77823058e-01  7.22176942e-01]
  HOMO = -0.785056945883443  LUMO = 2.62179718189259
  mo_energy =
[-3.27123155e+01 -1.89726616e+00 -7.85056946e-01 -7.85056946e-01
 -7.85056946e-01  2.62179718e+00  2.62179718e+00  2.62179718e+00
  2.73712060e+00  1.97976867e+01  1.97976867e+01  1.97976867e+01
  4.53969330e+01  3.35166707e+02  2.02595073e+03  7.31777541e+03]
E1 = -182.46324413782372  E_coul = 54.264717756754095
cycle= 3 E= -128.19852638107  delta_E= -0.000305  |g|= 0.000689  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000870972
diis-c [-7.59349574e-08 -3.89145715e-03 -1.87330884e-03  1.00576477e+00]
  HOMO = -0.785285445719329  LUMO = 2.62162474304595
  mo_energy =
[-3.27129682e+01 -1.89756429e+00 -7.85285446e-01 -7.85285446e-01
 -7.85285446e-01  2.62162474e+00  2.62162474e+00  2.62162474e+00
  2.73688582e+00  1.97971765e+01  1.97971765e+01  1.97971765e+01
  4.53963190e+01  3.35166215e+02  2.02595037e+03  7.31777509e+03]
E1 = -182.46450387093773  E_coul = 54.26597745718732
cycle= 4 E= -128.19852641375  delta_E= -3.27e-08  |g|= 5.07e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.06043e-05
diis-c [-2.10593357e-10  5.03108127e-04 -8.40755830e-04 -1.69715858e-01
  1.17005351e+00]
  HOMO = -0.78527099565951  LUMO = 2.62163724298297
  mo_energy =
[-3.27129310e+01 -1.89756176e+00 -7.85270996e-01 -7.85270996e-01
 -7.85270996e-01  2.62163724e+00  2.62163724e+00  2.62163724e+00
  2.73688721e+00  1.97972053e+01  1.97972053e+01  1.97972053e+01
  4.53963493e+01  3.35166267e+02  2.02595043e+03  7.31777516e+03]
E1 = -182.46444128862274  E_coul = 54.26591487457835
cycle= 5 E= -128.198526414044  delta_E= -2.94e-10  |g|= 1.54e-06  |ddm|= 2.57e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46444128862274  E_coul = 54.26591487457835
  HOMO = -0.785270936448697  LUMO = 2.62163731102157
  mo_energy =
[-3.27129309e+01 -1.89756208e+00 -7.85270936e-01 -7.85270936e-01
 -7.85270936e-01  2.62163731e+00  2.62163731e+00  2.62163731e+00
  2.73688694e+00  1.97972053e+01  1.97972053e+01  1.97972053e+01
  4.53963492e+01  3.35166267e+02  2.02595043e+03  7.31777516e+03]
E1 = -182.4644412765895  E_coul = 54.265914862544776
Extra cycle  E= -128.198526414045  delta_E= -3.41e-13  |g|= 2.82e-07  |ddm|= 8.93e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.04959958216546
E1 = -182.4644412765895  E_coul = 54.265914862544776
init E= -128.198526414045
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785270922150115  LUMO = 2.62163732238725
  mo_energy =
[-3.27129309e+01 -1.89756213e+00 -7.85270922e-01 -7.85270922e-01
 -7.85270922e-01  2.62163732e+00  2.62163732e+00  2.62163732e+00
  2.73688689e+00  1.97972053e+01  1.97972053e+01  1.97972053e+01
  4.53963492e+01  3.35166267e+02  2.02595043e+03  7.31777516e+03]
E1 = -182.46444128833105  E_coul = 54.265914874286295
cycle= 1 E= -128.198526414045  delta_E= -2.84e-14  |g|= 5.13e-08  |ddm|= 1.61e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46444128833105  E_coul = 54.265914874286295
  HOMO = -0.785270918469694  LUMO = 2.6216373254506
  mo_energy =
[-3.27129309e+01 -1.89756214e+00 -7.85270918e-01 -7.85270918e-01
 -7.85270918e-01  2.62163733e+00  2.62163733e+00  2.62163733e+00
  2.73688688e+00  1.97972053e+01  1.97972053e+01  1.97972053e+01
  4.53963492e+01  3.35166267e+02  2.02595043e+03  7.31777516e+03]
E1 = -182.46444128558326  E_coul = 54.265914871538456
Extra cycle  E= -128.198526414045  delta_E= -5.68e-14  |g|= 9.36e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14462861e+03 2.27451050e+02 1.42696421e+03 5.75920573e-01
 5.00489015e+01 1.32711071e+01 1.93022302e+00 2.77469227e+00
 1.33143449e+01 6.00144647e-01]
grad_E = [-9.94728081e-06  7.06340651e-06  3.37377059e-05 -4.19406207e-05
  3.66396080e-06 -3.18893662e-05  1.06593038e-05 -2.67824567e-04
 -3.41570090e-05 -7.42131309e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.63859018        1
[INPUT] 0    0    [1    /1   ]  227.439196863        1
[INPUT] 0    0    [1    /1   ]  1426.93078109        1
[INPUT] 0    0    [1    /1   ]  0.575864833462       1
[INPUT] 0    0    [1    /1   ]  50.0457816475        1
[INPUT] 0    0    [1    /1   ]  13.2702443188        1
[INPUT] 0    0    [1    /1   ]  1.93002940215        1
[INPUT] 1    0    [1    /1   ]  2.77351456765        1
[INPUT] 1    0    [1    /1   ]  13.3075048191        1
[INPUT] 1    0    [1    /1   ]  0.599957229102       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.638590175566, 1.0]], [0, [227.4391968631002, 1.0]], [0, [1426.9307810852795, 1.0]], [0, [0.5758648334616481, 1.0]], [0, [50.045781647532415, 1.0]], [0, [13.270244318831185, 1.0]], [0, [1.9300294021475026, 1.0]], [1, [2.77351456764997, 1.0]], [1, [13.307504819088894, 1.0]], [1, [0.5999572291023342, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.63859018]
bas 1, expnt(s) = [227.43919686]
bas 2, expnt(s) = [1426.93078109]
bas 3, expnt(s) = [0.57586483]
bas 4, expnt(s) = [50.04578165]
bas 5, expnt(s) = [13.27024432]
bas 6, expnt(s) = [1.9300294]
bas 7, expnt(s) = [2.77351457]
bas 8, expnt(s) = [13.30750482]
bas 9, expnt(s) = [0.59995723]
CPU time:       188.03
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14463859e+03 7.96215470e+02 2.27439197e+02 1.47966707e+02
 1.42693078e+03 5.86566430e+02 5.75864833e-01 1.67014987e+00
 5.00457816e+01 4.75379700e+01 1.32702443e+01 1.75660540e+01
 1.93002940e+00 4.13702331e+00 2.77351457e+00 1.04417299e+01
 1.33075048e+01 7.41489803e+01 5.99957229e-01 1.54040442e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96571668322863
cond(S) = 160.0232389908448
E1 = -183.13693242016762  E_coul = 55.01143992439908
init E= -128.125492495769
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742896309406781  LUMO = 2.65405405107584
  mo_energy =
[-3.25137327e+01 -1.85363717e+00 -7.42896309e-01 -7.42896309e-01
 -7.42896309e-01  2.65405405e+00  2.65405405e+00  2.65405405e+00
  2.77050698e+00  1.99206819e+01  1.99206819e+01  1.99206819e+01
  4.55615844e+01  3.35371898e+02  2.02615496e+03  7.31795596e+03]
E1 = -182.13206219229278  E_coul = 53.935475157254395
cycle= 1 E= -128.196587035038  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260491
diis-c [-0.06785562  1.        ]
  HOMO = -0.807889384395154  LUMO = 2.59998333877011
  mo_energy =
[-3.27872719e+01 -1.92097026e+00 -8.07889384e-01 -8.07889384e-01
 -8.07889384e-01  2.59998334e+00  2.59998334e+00  2.59998334e+00
  2.71638713e+00  1.97300570e+01  1.97300570e+01  1.97300570e+01
  4.53258005e+01  3.35061338e+02  2.02579606e+03  7.31757282e+03]
E1 = -182.5947774021549  E_coul = 54.39655603270042
cycle= 2 E= -128.198221369454  delta_E= -0.00163  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101947
diis-c [-4.04248013e-04  2.77888495e-01  7.22111505e-01]
  HOMO = -0.785114465159835  LUMO = 2.62058658541607
  mo_energy =
[-3.27124789e+01 -1.89733553e+00 -7.85114465e-01 -7.85114465e-01
 -7.85114465e-01  2.62058659e+00  2.62058659e+00  2.62058659e+00
  2.73660686e+00  1.97862015e+01  1.97862015e+01  1.97862015e+01
  4.53920333e+01  3.35143166e+02  2.02588326e+03  7.31766152e+03]
E1 = -182.46244937228414  E_coul = 54.26392236961089
cycle= 3 E= -128.198527002673  delta_E= -0.000306  |g|= 0.000687  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000868088
diis-c [-7.65689405e-08 -3.89533759e-03 -1.92499035e-03  1.00582033e+00]
  HOMO = -0.785342190216015  LUMO = 2.62041496749177
  mo_energy =
[-3.27131294e+01 -1.89763317e+00 -7.85342190e-01 -7.85342190e-01
 -7.85342190e-01  2.62041497e+00  2.62041497e+00  2.62041497e+00
  2.73637257e+00  1.97856931e+01  1.97856931e+01  1.97856931e+01
  4.53914212e+01  3.35142677e+02  2.02588291e+03  7.31766120e+03]
E1 = -182.46370532121816  E_coul = 54.265178285962655
cycle= 4 E= -128.198527035255  delta_E= -3.26e-08  |g|= 5.09e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.09346e-05
diis-c [-2.11552516e-10  5.03543257e-04 -8.36112863e-04 -1.69904591e-01
  1.17023716e+00]
  HOMO = -0.785327687574314  LUMO = 2.62042750699143
  mo_energy =
[-3.27130920e+01 -1.89763065e+00 -7.85327688e-01 -7.85327688e-01
 -7.85327688e-01  2.62042751e+00  2.62042751e+00  2.62042751e+00
  2.73637395e+00  1.97857220e+01  1.97857220e+01  1.97857220e+01
  4.53914517e+01  3.35142728e+02  2.02588297e+03  7.31766127e+03]
E1 = -182.46364251055306  E_coul = 54.265115475001096
cycle= 5 E= -128.198527035552  delta_E= -2.96e-10  |g|= 1.54e-06  |ddm|= 2.58e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46364251055306  E_coul = 54.265115475001096
  HOMO = -0.785327628208353  LUMO = 2.62042757523717
  mo_energy =
[-3.27130919e+01 -1.89763097e+00 -7.85327628e-01 -7.85327628e-01
 -7.85327628e-01  2.62042758e+00  2.62042758e+00  2.62042758e+00
  2.73637367e+00  1.97857220e+01  1.97857220e+01  1.97857220e+01
  4.53914516e+01  3.35142728e+02  2.02588297e+03  7.31766127e+03]
E1 = -182.46364249696532  E_coul = 54.265115461413096
Extra cycle  E= -128.198527035552  delta_E= -2.56e-13  |g|= 2.82e-07  |ddm|= 8.94e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14463859e+03 2.27439197e+02 1.42693078e+03 5.75864833e-01
 5.00457816e+01 1.32702443e+01 1.93002940e+00 2.77351457e+00
 1.33075048e+01 5.99957229e-01]
E = -128.19852703555222
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.63859018        1
[INPUT] 0    0    [1    /1   ]  227.439196863        1
[INPUT] 0    0    [1    /1   ]  1426.93078109        1
[INPUT] 0    0    [1    /1   ]  0.575864833462       1
[INPUT] 0    0    [1    /1   ]  50.0457816475        1
[INPUT] 0    0    [1    /1   ]  13.2702443188        1
[INPUT] 0    0    [1    /1   ]  1.93002940215        1
[INPUT] 1    0    [1    /1   ]  2.77351456765        1
[INPUT] 1    0    [1    /1   ]  13.3075048191        1
[INPUT] 1    0    [1    /1   ]  0.599957229102       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.638590175566, 1.0]], [0, [227.4391968631002, 1.0]], [0, [1426.9307810852795, 1.0]], [0, [0.5758648334616481, 1.0]], [0, [50.045781647532415, 1.0]], [0, [13.270244318831185, 1.0]], [0, [1.9300294021475026, 1.0]], [1, [2.77351456764997, 1.0]], [1, [13.307504819088894, 1.0]], [1, [0.5999572291023342, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.63859018]
bas 1, expnt(s) = [227.43919686]
bas 2, expnt(s) = [1426.93078109]
bas 3, expnt(s) = [0.57586483]
bas 4, expnt(s) = [50.04578165]
bas 5, expnt(s) = [13.27024432]
bas 6, expnt(s) = [1.9300294]
bas 7, expnt(s) = [2.77351457]
bas 8, expnt(s) = [13.30750482]
bas 9, expnt(s) = [0.59995723]
CPU time:       188.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14463859e+03 7.96215470e+02 2.27439197e+02 1.47966707e+02
 1.42693078e+03 5.86566430e+02 5.75864833e-01 1.67014987e+00
 5.00457816e+01 4.75379700e+01 1.32702443e+01 1.75660540e+01
 1.93002940e+00 4.13702331e+00 2.77351457e+00 1.04417299e+01
 1.33075048e+01 7.41489803e+01 5.99957229e-01 1.54040442e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96571668322863
cond(S) = 160.0232389908448
E1 = -183.13693242016762  E_coul = 55.01143992439908
init E= -128.125492495769
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742896309406781  LUMO = 2.65405405107584
  mo_energy =
[-3.25137327e+01 -1.85363717e+00 -7.42896309e-01 -7.42896309e-01
 -7.42896309e-01  2.65405405e+00  2.65405405e+00  2.65405405e+00
  2.77050698e+00  1.99206819e+01  1.99206819e+01  1.99206819e+01
  4.55615844e+01  3.35371898e+02  2.02615496e+03  7.31795596e+03]
E1 = -182.13206219229278  E_coul = 53.935475157254395
cycle= 1 E= -128.196587035038  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260491
diis-c [-0.06785562  1.        ]
  HOMO = -0.807889384395154  LUMO = 2.59998333877011
  mo_energy =
[-3.27872719e+01 -1.92097026e+00 -8.07889384e-01 -8.07889384e-01
 -8.07889384e-01  2.59998334e+00  2.59998334e+00  2.59998334e+00
  2.71638713e+00  1.97300570e+01  1.97300570e+01  1.97300570e+01
  4.53258005e+01  3.35061338e+02  2.02579606e+03  7.31757282e+03]
E1 = -182.5947774021549  E_coul = 54.39655603270042
cycle= 2 E= -128.198221369454  delta_E= -0.00163  |g|= 0.0626  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.101947
diis-c [-4.04248013e-04  2.77888495e-01  7.22111505e-01]
  HOMO = -0.785114465159835  LUMO = 2.62058658541607
  mo_energy =
[-3.27124789e+01 -1.89733553e+00 -7.85114465e-01 -7.85114465e-01
 -7.85114465e-01  2.62058659e+00  2.62058659e+00  2.62058659e+00
  2.73660686e+00  1.97862015e+01  1.97862015e+01  1.97862015e+01
  4.53920333e+01  3.35143166e+02  2.02588326e+03  7.31766152e+03]
E1 = -182.46244937228414  E_coul = 54.26392236961089
cycle= 3 E= -128.198527002673  delta_E= -0.000306  |g|= 0.000687  |ddm|= 0.0182
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000868088
diis-c [-7.65689405e-08 -3.89533759e-03 -1.92499035e-03  1.00582033e+00]
  HOMO = -0.785342190216015  LUMO = 2.62041496749177
  mo_energy =
[-3.27131294e+01 -1.89763317e+00 -7.85342190e-01 -7.85342190e-01
 -7.85342190e-01  2.62041497e+00  2.62041497e+00  2.62041497e+00
  2.73637257e+00  1.97856931e+01  1.97856931e+01  1.97856931e+01
  4.53914212e+01  3.35142677e+02  2.02588291e+03  7.31766120e+03]
E1 = -182.46370532121816  E_coul = 54.265178285962655
cycle= 4 E= -128.198527035255  delta_E= -3.26e-08  |g|= 5.09e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.09346e-05
diis-c [-2.11552516e-10  5.03543257e-04 -8.36112863e-04 -1.69904591e-01
  1.17023716e+00]
  HOMO = -0.785327687574314  LUMO = 2.62042750699143
  mo_energy =
[-3.27130920e+01 -1.89763065e+00 -7.85327688e-01 -7.85327688e-01
 -7.85327688e-01  2.62042751e+00  2.62042751e+00  2.62042751e+00
  2.73637395e+00  1.97857220e+01  1.97857220e+01  1.97857220e+01
  4.53914517e+01  3.35142728e+02  2.02588297e+03  7.31766127e+03]
E1 = -182.46364251055306  E_coul = 54.265115475001096
cycle= 5 E= -128.198527035552  delta_E= -2.96e-10  |g|= 1.54e-06  |ddm|= 2.58e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46364251055306  E_coul = 54.265115475001096
  HOMO = -0.785327628208353  LUMO = 2.62042757523717
  mo_energy =
[-3.27130919e+01 -1.89763097e+00 -7.85327628e-01 -7.85327628e-01
 -7.85327628e-01  2.62042758e+00  2.62042758e+00  2.62042758e+00
  2.73637367e+00  1.97857220e+01  1.97857220e+01  1.97857220e+01
  4.53914516e+01  3.35142728e+02  2.02588297e+03  7.31766127e+03]
E1 = -182.46364249696532  E_coul = 54.265115461413096
Extra cycle  E= -128.198527035552  delta_E= -2.56e-13  |g|= 2.82e-07  |ddm|= 8.94e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 160.0232389908448
E1 = -182.46364249696532  E_coul = 54.265115461413096
init E= -128.198527035552
    CPU time for initialize scf      0.06 sec, wall time      0.06 sec
  HOMO = -0.785327614009731  LUMO = 2.62042758650443
  mo_energy =
[-3.27130919e+01 -1.89763102e+00 -7.85327614e-01 -7.85327614e-01
 -7.85327614e-01  2.62042759e+00  2.62042759e+00  2.62042759e+00
  2.73637362e+00  1.97857220e+01  1.97857220e+01  1.97857220e+01
  4.53914516e+01  3.35142729e+02  2.02588297e+03  7.31766127e+03]
E1 = -182.46364250924978  E_coul = 54.26511547369744
cycle= 1 E= -128.198527035552  delta_E= -1.14e-13  |g|= 5.13e-08  |ddm|= 1.61e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46364250924978  E_coul = 54.26511547369744
  HOMO = -0.785327610290321  LUMO = 2.62042758960124
  mo_energy =
[-3.27130919e+01 -1.89763103e+00 -7.85327610e-01 -7.85327610e-01
 -7.85327610e-01  2.62042759e+00  2.62042759e+00  2.62042759e+00
  2.73637361e+00  1.97857220e+01  1.97857220e+01  1.97857220e+01
  4.53914516e+01  3.35142729e+02  2.02588297e+03  7.31766127e+03]
E1 = -182.46364250627536  E_coul = 54.265115470722975
Extra cycle  E= -128.198527035552  delta_E= -5.68e-14  |g|= 9.37e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14463859e+03 2.27439197e+02 1.42693078e+03 5.75864833e-01
 5.00457816e+01 1.32702443e+01 1.93002940e+00 2.77351457e+00
 1.33075048e+01 5.99957229e-01]
grad_E = [-9.94726001e-06  7.02087326e-06  3.37466732e-05 -5.70643277e-05
  4.67988698e-06 -4.35372393e-05  1.45335519e-05 -3.65135979e-04
 -4.77688189e-05 -1.01212826e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.65528033        1
[INPUT] 0    0    [1    /1   ]  227.424745096        1
[INPUT] 0    0    [1    /1   ]  1426.87444144        1
[INPUT] 0    0    [1    /1   ]  0.575800371667       1
[INPUT] 0    0    [1    /1   ]  50.0420979025        1
[INPUT] 0    0    [1    /1   ]  13.2692390129        1
[INPUT] 0    0    [1    /1   ]  1.92980564749        1
[INPUT] 1    0    [1    /1   ]  2.77216821405        1
[INPUT] 1    0    [1    /1   ]  13.2996951546        1
[INPUT] 1    0    [1    /1   ]  0.599742831803       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6552803262834, 1.0]], [0, [227.4247450962013, 1.0]], [0, [1426.8744414442688, 1.0]], [0, [0.5758003716672405, 1.0]], [0, [50.0420979025369, 1.0]], [0, [13.269239012861451, 1.0]], [0, [1.9298056474908096, 1.0]], [1, [2.7721682140510078, 1.0]], [1, [13.29969515457682, 1.0]], [1, [0.5997428318031663, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.65528033]
bas 1, expnt(s) = [227.4247451]
bas 2, expnt(s) = [1426.87444144]
bas 3, expnt(s) = [0.57580037]
bas 4, expnt(s) = [50.0420979]
bas 5, expnt(s) = [13.26923901]
bas 6, expnt(s) = [1.92980565]
bas 7, expnt(s) = [2.77216821]
bas 8, expnt(s) = [13.29969515]
bas 9, expnt(s) = [0.59974283]
CPU time:       191.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14465528e+03 7.96220117e+02 2.27424745e+02 1.47959656e+02
 1.42687444e+03 5.86549060e+02 5.75800372e-01 1.67000965e+00
 5.00420979e+01 4.75353456e+01 1.32692390e+01 1.75650559e+01
 1.92980565e+00 4.13666359e+00 2.77216821e+00 1.04353944e+01
 1.32996952e+01 7.40945902e+01 5.99742832e-01 1.53971636e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965761998577303
cond(S) = 159.9825182968093
E1 = -183.1369233789414  E_coul = 55.01140586851689
init E= -128.125517510425
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895916711925  LUMO = 2.65271360735189
  mo_energy =
[-3.25137549e+01 -1.85363792e+00 -7.42895917e-01 -7.42895917e-01
 -7.42895917e-01  2.65271361e+00  2.65271361e+00  2.65271361e+00
  2.76997852e+00  1.99076597e+01  1.99076597e+01  1.99076597e+01
  4.55560085e+01  3.35343881e+02  2.02606545e+03  7.31779076e+03]
E1 = -182.13077455740466  E_coul = 53.934190388317546
cycle= 1 E= -128.196584169087  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260716
diis-c [-0.06797259  1.        ]
  HOMO = -0.807980631220977  LUMO = 2.598584913334
  mo_energy =
[-3.27875357e+01 -1.92107652e+00 -8.07980631e-01 -8.07980631e-01
 -8.07980631e-01  2.59858491e+00  2.59858491e+00  2.59858491e+00
  2.71577363e+00  1.97168914e+01  1.97168914e+01  1.97168914e+01
  4.53200106e+01  3.35033069e+02  2.02570628e+03  7.31740736e+03]
E1 = -182.59403678558058  E_coul = 54.39581505528715
cycle= 2 E= -128.198221730293  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10207
diis-c [-4.04484779e-04  2.77963336e-01  7.22036664e-01]
  HOMO = -0.785180259566838  LUMO = 2.61920220012349
  mo_energy =
[-3.27126663e+01 -1.89741495e+00 -7.85180260e-01 -7.85180260e-01
 -7.85180260e-01  2.61920220e+00  2.61920220e+00  2.61920220e+00
  2.73601356e+00  1.97730833e+01  1.97730833e+01  1.97730833e+01
  4.53863106e+01  3.35114979e+02  2.02579358e+03  7.31749614e+03]
E1 = -182.46154004354793  E_coul = 54.26301192902598
cycle= 3 E= -128.198528114522  delta_E= -0.000306  |g|= 0.000686  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000864791
diis-c [-7.72973458e-08 -3.89980005e-03 -1.98416223e-03  1.00588396e+00]
  HOMO = -0.785407096123236  LUMO = 2.61903152273455
  mo_energy =
[-3.27133142e+01 -1.89771203e+00 -7.85407096e-01 -7.85407096e-01
 -7.85407096e-01  2.61903152e+00  2.61903152e+00  2.61903152e+00
  2.73577982e+00  1.97725770e+01  1.97725770e+01  1.97725770e+01
  4.53857007e+01  3.35114492e+02  2.02579322e+03  7.31749583e+03]
E1 = -182.46279164885968  E_coul = 54.26426350186797
cycle= 4 E= -128.198528146992  delta_E= -3.25e-08  |g|= 5.12e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.13123e-05
diis-c [-2.12653998e-10  5.04033263e-04 -8.30769931e-04 -1.70117701e-01
  1.17044444e+00]
  HOMO = -0.785392533405135  LUMO = 2.61904410737026
  mo_energy =
[-3.27132767e+01 -1.89770952e+00 -7.85392533e-01 -7.85392533e-01
 -7.85392533e-01  2.61904411e+00  2.61904411e+00  2.61904411e+00
  2.73578119e+00  1.97726060e+01  1.97726060e+01  1.97726060e+01
  4.53857312e+01  3.35114544e+02  2.02579329e+03  7.31749590e+03]
E1 = -182.46272857720558  E_coul = 54.264200429914254
cycle= 5 E= -128.198528147291  delta_E= -3e-10  |g|= 1.54e-06  |ddm|= 2.6e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46272857720558  E_coul = 54.264200429914254
  HOMO = -0.785392473848275  LUMO = 2.61904417586514
  mo_energy =
[-3.27132766e+01 -1.89770984e+00 -7.85392474e-01 -7.85392474e-01
 -7.85392474e-01  2.61904418e+00  2.61904418e+00  2.61904418e+00
  2.73578091e+00  1.97726060e+01  1.97726060e+01  1.97726060e+01
  4.53857312e+01  3.35114544e+02  2.02579329e+03  7.31749590e+03]
E1 = -182.4627285617693  E_coul = 54.2642004144777
Extra cycle  E= -128.198528147292  delta_E= -2.84e-13  |g|= 2.82e-07  |ddm|= 8.94e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14465528e+03 2.27424745e+02 1.42687444e+03 5.75800372e-01
 5.00420979e+01 1.32692390e+01 1.92980565e+00 2.77216821e+00
 1.32996952e+01 5.99742832e-01]
E = -128.1985281472916
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.65528033        1
[INPUT] 0    0    [1    /1   ]  227.424745096        1
[INPUT] 0    0    [1    /1   ]  1426.87444144        1
[INPUT] 0    0    [1    /1   ]  0.575800371667       1
[INPUT] 0    0    [1    /1   ]  50.0420979025        1
[INPUT] 0    0    [1    /1   ]  13.2692390129        1
[INPUT] 0    0    [1    /1   ]  1.92980564749        1
[INPUT] 1    0    [1    /1   ]  2.77216821405        1
[INPUT] 1    0    [1    /1   ]  13.2996951546        1
[INPUT] 1    0    [1    /1   ]  0.599742831803       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6552803262834, 1.0]], [0, [227.4247450962013, 1.0]], [0, [1426.8744414442688, 1.0]], [0, [0.5758003716672405, 1.0]], [0, [50.0420979025369, 1.0]], [0, [13.269239012861451, 1.0]], [0, [1.9298056474908096, 1.0]], [1, [2.7721682140510078, 1.0]], [1, [13.29969515457682, 1.0]], [1, [0.5997428318031663, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.65528033]
bas 1, expnt(s) = [227.4247451]
bas 2, expnt(s) = [1426.87444144]
bas 3, expnt(s) = [0.57580037]
bas 4, expnt(s) = [50.0420979]
bas 5, expnt(s) = [13.26923901]
bas 6, expnt(s) = [1.92980565]
bas 7, expnt(s) = [2.77216821]
bas 8, expnt(s) = [13.29969515]
bas 9, expnt(s) = [0.59974283]
CPU time:       192.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14465528e+03 7.96220117e+02 2.27424745e+02 1.47959656e+02
 1.42687444e+03 5.86549060e+02 5.75800372e-01 1.67000965e+00
 5.00420979e+01 4.75353456e+01 1.32692390e+01 1.75650559e+01
 1.92980565e+00 4.13666359e+00 2.77216821e+00 1.04353944e+01
 1.32996952e+01 7.40945902e+01 5.99742832e-01 1.53971636e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965761998577303
cond(S) = 159.9825182968093
E1 = -183.1369233789414  E_coul = 55.01140586851689
init E= -128.125517510425
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895916711925  LUMO = 2.65271360735189
  mo_energy =
[-3.25137549e+01 -1.85363792e+00 -7.42895917e-01 -7.42895917e-01
 -7.42895917e-01  2.65271361e+00  2.65271361e+00  2.65271361e+00
  2.76997852e+00  1.99076597e+01  1.99076597e+01  1.99076597e+01
  4.55560085e+01  3.35343881e+02  2.02606545e+03  7.31779076e+03]
E1 = -182.13077455740466  E_coul = 53.934190388317546
cycle= 1 E= -128.196584169087  delta_E= -0.0711  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.260716
diis-c [-0.06797259  1.        ]
  HOMO = -0.807980631220977  LUMO = 2.598584913334
  mo_energy =
[-3.27875357e+01 -1.92107652e+00 -8.07980631e-01 -8.07980631e-01
 -8.07980631e-01  2.59858491e+00  2.59858491e+00  2.59858491e+00
  2.71577363e+00  1.97168914e+01  1.97168914e+01  1.97168914e+01
  4.53200106e+01  3.35033069e+02  2.02570628e+03  7.31740736e+03]
E1 = -182.59403678558058  E_coul = 54.39581505528715
cycle= 2 E= -128.198221730293  delta_E= -0.00164  |g|= 0.0626  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.03 sec
diis-norm(errvec)=0.10207
diis-c [-4.04484779e-04  2.77963336e-01  7.22036664e-01]
  HOMO = -0.785180259566838  LUMO = 2.61920220012349
  mo_energy =
[-3.27126663e+01 -1.89741495e+00 -7.85180260e-01 -7.85180260e-01
 -7.85180260e-01  2.61920220e+00  2.61920220e+00  2.61920220e+00
  2.73601356e+00  1.97730833e+01  1.97730833e+01  1.97730833e+01
  4.53863106e+01  3.35114979e+02  2.02579358e+03  7.31749614e+03]
E1 = -182.46154004354793  E_coul = 54.26301192902598
cycle= 3 E= -128.198528114522  delta_E= -0.000306  |g|= 0.000686  |ddm|= 0.0183
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000864791
diis-c [-7.72973458e-08 -3.89980005e-03 -1.98416223e-03  1.00588396e+00]
  HOMO = -0.785407096123236  LUMO = 2.61903152273455
  mo_energy =
[-3.27133142e+01 -1.89771203e+00 -7.85407096e-01 -7.85407096e-01
 -7.85407096e-01  2.61903152e+00  2.61903152e+00  2.61903152e+00
  2.73577982e+00  1.97725770e+01  1.97725770e+01  1.97725770e+01
  4.53857007e+01  3.35114492e+02  2.02579322e+03  7.31749583e+03]
E1 = -182.46279164885968  E_coul = 54.26426350186797
cycle= 4 E= -128.198528146992  delta_E= -3.25e-08  |g|= 5.12e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.13123e-05
diis-c [-2.12653998e-10  5.04033263e-04 -8.30769931e-04 -1.70117701e-01
  1.17044444e+00]
  HOMO = -0.785392533405135  LUMO = 2.61904410737026
  mo_energy =
[-3.27132767e+01 -1.89770952e+00 -7.85392533e-01 -7.85392533e-01
 -7.85392533e-01  2.61904411e+00  2.61904411e+00  2.61904411e+00
  2.73578119e+00  1.97726060e+01  1.97726060e+01  1.97726060e+01
  4.53857312e+01  3.35114544e+02  2.02579329e+03  7.31749590e+03]
E1 = -182.46272857720558  E_coul = 54.264200429914254
cycle= 5 E= -128.198528147291  delta_E= -3e-10  |g|= 1.54e-06  |ddm|= 2.6e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46272857720558  E_coul = 54.264200429914254
  HOMO = -0.785392473848275  LUMO = 2.61904417586514
  mo_energy =
[-3.27132766e+01 -1.89770984e+00 -7.85392474e-01 -7.85392474e-01
 -7.85392474e-01  2.61904418e+00  2.61904418e+00  2.61904418e+00
  2.73578091e+00  1.97726060e+01  1.97726060e+01  1.97726060e+01
  4.53857312e+01  3.35114544e+02  2.02579329e+03  7.31749590e+03]
E1 = -182.4627285617693  E_coul = 54.2642004144777
Extra cycle  E= -128.198528147292  delta_E= -2.84e-13  |g|= 2.82e-07  |ddm|= 8.94e-07
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 159.9825182968093
E1 = -182.4627285617693  E_coul = 54.2642004144777
init E= -128.198528147292
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.7853924597686  LUMO = 2.61904418701576
  mo_energy =
[-3.27132766e+01 -1.89770990e+00 -7.85392460e-01 -7.85392460e-01
 -7.85392460e-01  2.61904419e+00  2.61904419e+00  2.61904419e+00
  2.73578086e+00  1.97726060e+01  1.97726060e+01  1.97726060e+01
  4.53857312e+01  3.35114544e+02  2.02579329e+03  7.31749590e+03]
E1 = -182.46272857470333  E_coul = 54.264200427411765
cycle= 1 E= -128.198528147292  delta_E= 2.84e-14  |g|= 5.14e-08  |ddm|= 1.61e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46272857470333  E_coul = 54.264200427411765
  HOMO = -0.785392456002595  LUMO = 2.61904419015261
  mo_energy =
[-3.27132766e+01 -1.89770990e+00 -7.85392456e-01 -7.85392456e-01
 -7.85392456e-01  2.61904419e+00  2.61904419e+00  2.61904419e+00
  2.73578085e+00  1.97726060e+01  1.97726060e+01  1.97726060e+01
  4.53857312e+01  3.35114544e+02  2.02579329e+03  7.31749590e+03]
E1 = -182.46272857145826  E_coul = 54.26420042416667
Extra cycle  E= -128.198528147292  delta_E= -2.84e-14  |g|= 9.39e-09  |ddm|= 2.87e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14465528e+03 2.27424745e+02 1.42687444e+03 5.75800372e-01
 5.00420979e+01 1.32692390e+01 1.92980565e+00 2.77216821e+00
 1.32996952e+01 5.99742832e-01]
grad_E = [-9.94790721e-06  6.97147091e-06  3.37580788e-05 -7.44315066e-05
  5.85080236e-06 -5.69131006e-05  1.89879455e-05 -4.76893428e-04
 -6.32668786e-05 -1.32305044e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.68403668        1
[INPUT] 0    0    [1    /1   ]  227.405694313        1
[INPUT] 0    0    [1    /1   ]  1426.77687804        1
[INPUT] 0    0    [1    /1   ]  0.575720551705       1
[INPUT] 0    0    [1    /1   ]  50.0374187036        1
[INPUT] 0    0    [1    /1   ]  13.2679826674        1
[INPUT] 0    0    [1    /1   ]  1.92952876931        1
[INPUT] 1    0    [1    /1   ]  2.77052353333        1
[INPUT] 1    0    [1    /1   ]  13.2901657129        1
[INPUT] 1    0    [1    /1   ]  0.599480767573       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6840366750553, 1.0]], [0, [227.40569431289902, 1.0]], [0, [1426.7768780374809, 1.0]], [0, [0.5757205517054242, 1.0]], [0, [50.037418703583185, 1.0]], [0, [13.26798266740272, 1.0]], [0, [1.9295287693092436, 1.0]], [1, [2.770523533334985, 1.0]], [1, [13.290165712892085, 1.0]], [1, [0.5994807675734417, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.68403668]
bas 1, expnt(s) = [227.40569431]
bas 2, expnt(s) = [1426.77687804]
bas 3, expnt(s) = [0.57572055]
bas 4, expnt(s) = [50.0374187]
bas 5, expnt(s) = [13.26798267]
bas 6, expnt(s) = [1.92952877]
bas 7, expnt(s) = [2.77052353]
bas 8, expnt(s) = [13.29016571]
bas 9, expnt(s) = [0.59948077]
CPU time:       195.67
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14468404e+03 7.96228124e+02 2.27405694e+02 1.47950360e+02
 1.42677688e+03 5.86518981e+02 5.75720552e-01 1.66983602e+00
 5.00374187e+01 4.75320119e+01 1.32679827e+01 1.75638086e+01
 1.92952877e+00 4.13621845e+00 2.77052353e+00 1.04276560e+01
 1.32901657e+01 7.40282338e+01 5.99480768e-01 1.53887541e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965817349724459
cond(S) = 159.91602630007816
E1 = -183.13691291421992  E_coul = 55.01136392899578
init E= -128.125548985224
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895401604212  LUMO = 2.6510757459633
  mo_energy =
[-3.25137825e+01 -1.85363894e+00 -7.42895402e-01 -7.42895402e-01
 -7.42895402e-01  2.65107575e+00  2.65107575e+00  2.65107575e+00
  2.76932412e+00  1.98917655e+01  1.98917655e+01  1.98917655e+01
  4.55490141e+01  3.35307689e+02  2.02593631e+03  7.31753331e+03]
E1 = -182.12920017406285  E_coul = 53.93261884503078
cycle= 1 E= -128.196581329032  delta_E= -0.071  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26099
diis-c [-0.06811579  1.        ]
  HOMO = -0.808092177390011  LUMO = 2.59687620741516
  mo_energy =
[-3.27878589e+01 -1.92120654e+00 -8.08092177e-01 -8.08092177e-01
 -8.08092177e-01  2.59687621e+00  2.59687621e+00  2.59687621e+00
  2.71501544e+00  1.97008218e+01  1.97008218e+01  1.97008218e+01
  4.53127545e+01  3.34996569e+02  2.02557682e+03  7.31714960e+03]
E1 = -182.5931316943664  E_coul = 54.394908852796696
cycle= 2 E= -128.19822284157  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10222
diis-c [-4.04770055e-04  2.78054801e-01  7.21945199e-01]
  HOMO = -0.785260666446359  LUMO = 2.61751065683504
  mo_energy =
[-3.27128959e+01 -1.89751213e+00 -7.85260666e-01 -7.85260666e-01
 -7.85260666e-01  2.61751066e+00  2.61751066e+00  2.61751066e+00
  2.73528003e+00  1.97570716e+01  1.97570716e+01  1.97570716e+01
  4.53791367e+01  3.35078578e+02  2.02566422e+03  7.31723849e+03]
E1 = -182.46042851573137  E_coul = 54.261898369810545
cycle= 3 E= -128.198530145921  delta_E= -0.000307  |g|= 0.000685  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000860762
diis-c [-7.81922059e-08 -3.90529094e-03 -2.05657412e-03  1.00596187e+00]
  HOMO = -0.785486413641543  LUMO = 2.61734113131071
  mo_energy =
[-3.27135408e+01 -1.89780852e+00 -7.85486414e-01 -7.85486414e-01
 -7.85486414e-01  2.61734113e+00  2.61734113e+00  2.61734113e+00
  2.73504698e+00  1.97565679e+01  1.97565679e+01  1.97565679e+01
  4.53785295e+01  3.35078095e+02  2.02566387e+03  7.31723818e+03]
E1 = -182.46167478949735  E_coul = 54.26314461124392
cycle= 4 E= -128.198530178253  delta_E= -3.23e-08  |g|= 5.15e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.17734e-05
diis-c [-2.14006517e-10  5.04621594e-04 -8.24192216e-04 -1.70374267e-01
  1.17069384e+00]
  HOMO = -0.785471777602548  LUMO = 2.61735377093675
  mo_energy =
[-3.27135031e+01 -1.89780602e+00 -7.85471778e-01 -7.85471778e-01
 -7.85471778e-01  2.61735377e+00  2.61735377e+00  2.61735377e+00
  2.73504833e+00  1.97565970e+01  1.97565970e+01  1.97565970e+01
  4.53785601e+01  3.35078147e+02  2.02566394e+03  7.31723825e+03]
E1 = -182.4616113991911  E_coul = 54.26308122063404
cycle= 5 E= -128.198530178557  delta_E= -3.04e-10  |g|= 1.54e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4616113991911  E_coul = 54.26308122063404
  HOMO = -0.785471717793803  LUMO = 2.61735383975305
  mo_energy =
[-3.27135030e+01 -1.89780634e+00 -7.85471718e-01 -7.85471718e-01
 -7.85471718e-01  2.61735384e+00  2.61735384e+00  2.61735384e+00
  2.73504805e+00  1.97565971e+01  1.97565971e+01  1.97565971e+01
  4.53785601e+01  3.35078147e+02  2.02566394e+03  7.31723825e+03]
E1 = -182.4616113813995  E_coul = 54.26308120284212
Extra cycle  E= -128.198530178557  delta_E= -3.13e-13  |g|= 2.82e-07  |ddm|= 8.95e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
exp = [2.14468404e+03 2.27405694e+02 1.42677688e+03 5.75720552e-01
 5.00374187e+01 1.32679827e+01 1.92952877e+00 2.77052353e+00
 1.32901657e+01 5.99480768e-01]
E = -128.19853017855738
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:47:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.68403668        1
[INPUT] 0    0    [1    /1   ]  227.405694313        1
[INPUT] 0    0    [1    /1   ]  1426.77687804        1
[INPUT] 0    0    [1    /1   ]  0.575720551705       1
[INPUT] 0    0    [1    /1   ]  50.0374187036        1
[INPUT] 0    0    [1    /1   ]  13.2679826674        1
[INPUT] 0    0    [1    /1   ]  1.92952876931        1
[INPUT] 1    0    [1    /1   ]  2.77052353333        1
[INPUT] 1    0    [1    /1   ]  13.2901657129        1
[INPUT] 1    0    [1    /1   ]  0.599480767573       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.6840366750553, 1.0]], [0, [227.40569431289902, 1.0]], [0, [1426.7768780374809, 1.0]], [0, [0.5757205517054242, 1.0]], [0, [50.037418703583185, 1.0]], [0, [13.26798266740272, 1.0]], [0, [1.9295287693092436, 1.0]], [1, [2.770523533334985, 1.0]], [1, [13.290165712892085, 1.0]], [1, [0.5994807675734417, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.68403668]
bas 1, expnt(s) = [227.40569431]
bas 2, expnt(s) = [1426.77687804]
bas 3, expnt(s) = [0.57572055]
bas 4, expnt(s) = [50.0374187]
bas 5, expnt(s) = [13.26798267]
bas 6, expnt(s) = [1.92952877]
bas 7, expnt(s) = [2.77052353]
bas 8, expnt(s) = [13.29016571]
bas 9, expnt(s) = [0.59948077]
CPU time:       196.60
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14468404e+03 7.96228124e+02 2.27405694e+02 1.47950360e+02
 1.42677688e+03 5.86518981e+02 5.75720552e-01 1.66983602e+00
 5.00374187e+01 4.75320119e+01 1.32679827e+01 1.75638086e+01
 1.92952877e+00 4.13621845e+00 2.77052353e+00 1.04276560e+01
 1.32901657e+01 7.40282338e+01 5.99480768e-01 1.53887541e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965817349724459
cond(S) = 159.91602630007816
E1 = -183.13691291421992  E_coul = 55.01136392899578
init E= -128.125548985224
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742895401604212  LUMO = 2.6510757459633
  mo_energy =
[-3.25137825e+01 -1.85363894e+00 -7.42895402e-01 -7.42895402e-01
 -7.42895402e-01  2.65107575e+00  2.65107575e+00  2.65107575e+00
  2.76932412e+00  1.98917655e+01  1.98917655e+01  1.98917655e+01
  4.55490141e+01  3.35307689e+02  2.02593631e+03  7.31753331e+03]
E1 = -182.12920017406285  E_coul = 53.93261884503078
cycle= 1 E= -128.196581329032  delta_E= -0.071  |g|= 0.165  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26099
diis-c [-0.06811579  1.        ]
  HOMO = -0.808092177390011  LUMO = 2.59687620741516
  mo_energy =
[-3.27878589e+01 -1.92120654e+00 -8.08092177e-01 -8.08092177e-01
 -8.08092177e-01  2.59687621e+00  2.59687621e+00  2.59687621e+00
  2.71501544e+00  1.97008218e+01  1.97008218e+01  1.97008218e+01
  4.53127545e+01  3.34996569e+02  2.02557682e+03  7.31714960e+03]
E1 = -182.5931316943664  E_coul = 54.394908852796696
cycle= 2 E= -128.19822284157  delta_E= -0.00164  |g|= 0.0627  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10222
diis-c [-4.04770055e-04  2.78054801e-01  7.21945199e-01]
  HOMO = -0.785260666446359  LUMO = 2.61751065683504
  mo_energy =
[-3.27128959e+01 -1.89751213e+00 -7.85260666e-01 -7.85260666e-01
 -7.85260666e-01  2.61751066e+00  2.61751066e+00  2.61751066e+00
  2.73528003e+00  1.97570716e+01  1.97570716e+01  1.97570716e+01
  4.53791367e+01  3.35078578e+02  2.02566422e+03  7.31723849e+03]
E1 = -182.46042851573137  E_coul = 54.261898369810545
cycle= 3 E= -128.198530145921  delta_E= -0.000307  |g|= 0.000685  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000860762
diis-c [-7.81922059e-08 -3.90529094e-03 -2.05657412e-03  1.00596187e+00]
  HOMO = -0.785486413641543  LUMO = 2.61734113131071
  mo_energy =
[-3.27135408e+01 -1.89780852e+00 -7.85486414e-01 -7.85486414e-01
 -7.85486414e-01  2.61734113e+00  2.61734113e+00  2.61734113e+00
  2.73504698e+00  1.97565679e+01  1.97565679e+01  1.97565679e+01
  4.53785295e+01  3.35078095e+02  2.02566387e+03  7.31723818e+03]
E1 = -182.46167478949735  E_coul = 54.26314461124392
cycle= 4 E= -128.198530178253  delta_E= -3.23e-08  |g|= 5.15e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.17734e-05
diis-c [-2.14006517e-10  5.04621594e-04 -8.24192216e-04 -1.70374267e-01
  1.17069384e+00]
  HOMO = -0.785471777602548  LUMO = 2.61735377093675
  mo_energy =
[-3.27135031e+01 -1.89780602e+00 -7.85471778e-01 -7.85471778e-01
 -7.85471778e-01  2.61735377e+00  2.61735377e+00  2.61735377e+00
  2.73504833e+00  1.97565970e+01  1.97565970e+01  1.97565970e+01
  4.53785601e+01  3.35078147e+02  2.02566394e+03  7.31723825e+03]
E1 = -182.4616113991911  E_coul = 54.26308122063404
cycle= 5 E= -128.198530178557  delta_E= -3.04e-10  |g|= 1.54e-06  |ddm|= 2.62e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4616113991911  E_coul = 54.26308122063404
  HOMO = -0.785471717793803  LUMO = 2.61735383975305
  mo_energy =
[-3.27135030e+01 -1.89780634e+00 -7.85471718e-01 -7.85471718e-01
 -7.85471718e-01  2.61735384e+00  2.61735384e+00  2.61735384e+00
  2.73504805e+00  1.97565971e+01  1.97565971e+01  1.97565971e+01
  4.53785601e+01  3.35078147e+02  2.02566394e+03  7.31723825e+03]
E1 = -182.4616113813995  E_coul = 54.26308120284212
Extra cycle  E= -128.198530178557  delta_E= -3.13e-13  |g|= 2.82e-07  |ddm|= 8.95e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 159.91602630007816
E1 = -182.4616113813995  E_coul = 54.26308120284212
init E= -128.198530178557
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785471703865817  LUMO = 2.61735385075548
  mo_energy =
[-3.27135030e+01 -1.89780639e+00 -7.85471704e-01 -7.85471704e-01
 -7.85471704e-01  2.61735385e+00  2.61735385e+00  2.61735385e+00
  2.73504800e+00  1.97565971e+01  1.97565971e+01  1.97565971e+01
  4.53785601e+01  3.35078147e+02  2.02566394e+03  7.31723825e+03]
E1 = -182.46161139516627  E_coul = 54.2630812166089
cycle= 1 E= -128.198530178557  delta_E=    0  |g|= 5.15e-08  |ddm|= 1.61e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46161139516627  E_coul = 54.2630812166089
  HOMO = -0.785471700040159  LUMO = 2.61735385394366
  mo_energy =
[-3.27135030e+01 -1.89780640e+00 -7.85471700e-01 -7.85471700e-01
 -7.85471700e-01  2.61735385e+00  2.61735385e+00  2.61735385e+00
  2.73504799e+00  1.97565971e+01  1.97565971e+01  1.97565971e+01
  4.53785601e+01  3.35078147e+02  2.02566394e+03  7.31723825e+03]
E1 = -182.46161139157525  E_coul = 54.26308121301772
Extra cycle  E= -128.198530178558  delta_E= -1.42e-13  |g|= 9.41e-09  |ddm|= 2.88e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14468404e+03 2.27405694e+02 1.42677688e+03 5.75720552e-01
 5.00374187e+01 1.32679827e+01 1.92952877e+00 2.77052353e+00
 1.32901657e+01 5.99480768e-01]
grad_E = [-9.94976693e-06  6.91054193e-06  3.37738157e-05 -9.57262871e-05
  7.29059953e-06 -7.33154983e-05  2.44539997e-05 -6.13947855e-04
 -8.21538053e-05 -1.70477020e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.73527024        1
[INPUT] 0    0    [1    /1   ]  227.378501824        1
[INPUT] 0    0    [1    /1   ]  1426.60248614        1
[INPUT] 0    0    [1    /1   ]  0.575614329391       1
[INPUT] 0    0    [1    /1   ]  50.0310039596        1
[INPUT] 0    0    [1    /1   ]  13.2662925419        1
[INPUT] 0    0    [1    /1   ]  1.92916054267        1
[INPUT] 1    0    [1    /1   ]  2.76836878562        1
[INPUT] 1    0    [1    /1   ]  13.2776937241        1
[INPUT] 1    0    [1    /1   ]  0.59913722037        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.7352702413996, 1.0]], [0, [227.37850182389138, 1.0]], [0, [1426.6024861432008, 1.0]], [0, [0.5756143293912841, 1.0]], [0, [50.03100395956629, 1.0]], [0, [13.266292541938295, 1.0]], [0, [1.929160542669153, 1.0]], [1, [2.768368785618545, 1.0]], [1, [13.27769372406531, 1.0]], [1, [0.5991372203703644, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.73527024]
bas 1, expnt(s) = [227.37850182]
bas 2, expnt(s) = [1426.60248614]
bas 3, expnt(s) = [0.57561433]
bas 4, expnt(s) = [50.03100396]
bas 5, expnt(s) = [13.26629254]
bas 6, expnt(s) = [1.92916054]
bas 7, expnt(s) = [2.76836879]
bas 8, expnt(s) = [13.27769372]
bas 9, expnt(s) = [0.59913722]
CPU time:       199.32
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14473527e+03 7.96242390e+02 2.27378502e+02 1.47937091e+02
 1.42660249e+03 5.86465213e+02 5.75614329e-01 1.66960494e+00
 5.00310040e+01 4.75274417e+01 1.32662925e+01 1.75621306e+01
 1.92916054e+00 4.13562643e+00 2.76836879e+00 1.04175195e+01
 1.32776937e+01 7.39414054e+01 5.99137220e-01 1.53777313e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965889845025455
cond(S) = 159.8018449280831
E1 = -183.13690012219362  E_coul = 55.01130844147302
init E= -128.125591680721
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742894660406981  LUMO = 2.64892953644848
  mo_energy =
[-3.25138195e+01 -1.85364041e+00 -7.42894660e-01 -7.42894660e-01
 -7.42894660e-01  2.64892954e+00  2.64892954e+00  2.64892954e+00
  2.76845315e+00  1.98709593e+01  1.98709593e+01  1.98709593e+01
  4.55395623e+01  3.35257134e+02  2.02573514e+03  7.31710600e+03]
E1 = -182.12713569972794  E_coul = 53.930557036235165
cycle= 1 E= -128.196578663493  delta_E= -0.071  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26135
diis-c [-0.06830387  1.        ]
  HOMO = -0.80823840675082  LUMO = 2.59463719027555
  mo_energy =
[-3.27882838e+01 -1.92137716e+00 -8.08238407e-01 -8.08238407e-01
 -8.08238407e-01  2.59463719e+00  2.59463719e+00  2.59463719e+00
  2.71400868e+00  1.96797856e+01  1.96797856e+01  1.96797856e+01
  4.53029600e+01  3.34945610e+02  2.02537524e+03  7.31672186e+03]
E1 = -182.59194561467706  E_coul = 54.39372024749569
cycle= 2 E= -128.198225367181  delta_E= -0.00165  |g|= 0.0629  |ddm|= 0.0646
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102416
diis-c [-4.05137393e-04  2.78174673e-01  7.21825327e-01]
  HOMO = -0.785366032089162  LUMO = 2.61529413494274
  mo_energy =
[-3.27131980e+01 -1.89763966e+00 -7.85366032e-01 -7.85366032e-01
 -7.85366032e-01  2.61529413e+00  2.61529413e+00  2.61529413e+00
  2.73430556e+00  1.97361114e+01  1.97361114e+01  1.97361114e+01
  4.53694498e+01  3.35027750e+02  2.02546278e+03  7.31681089e+03]
E1 = -182.45897147700762  E_coul = 54.26043759579591
cycle= 3 E= -128.198533881212  delta_E= -0.000309  |g|= 0.000683  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000855484
diis-c [-7.93728716e-08 -3.91254963e-03 -2.15162839e-03  1.00606418e+00]
  HOMO = -0.785590345932291  LUMO = 2.6151261228854
  mo_energy =
[-3.27138389e+01 -1.89793514e+00 -7.85590346e-01 -7.85590346e-01
 -7.85590346e-01  2.61512612e+00  2.61512612e+00  2.61512612e+00
  2.73407341e+00  1.97356111e+01  1.97356111e+01  1.97356111e+01
  4.53688461e+01  3.35027272e+02  2.02546243e+03  7.31681058e+03]
E1 = -182.460210726021  E_coul = 54.26167681265431
cycle= 4 E= -128.198533913367  delta_E= -3.22e-08  |g|= 5.19e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.23772e-05
diis-c [-2.15789577e-10  5.05376328e-04 -8.15494457e-04 -1.70704331e-01
  1.17101445e+00]
  HOMO = -0.785575613956061  LUMO = 2.61513883430309
  mo_energy =
[-3.27138009e+01 -1.89793265e+00 -7.85575614e-01 -7.85575614e-01
 -7.85575614e-01  2.61513883e+00  2.61513883e+00  2.61513883e+00
  2.73407473e+00  1.97356404e+01  1.97356404e+01  1.97356404e+01
  4.53688770e+01  3.35027324e+02  2.02546250e+03  7.31681066e+03]
E1 = -182.46014691856328  E_coul = 54.26161300488791
cycle= 5 E= -128.198533913675  delta_E= -3.09e-10  |g|= 1.55e-06  |ddm|= 2.64e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46014691856328  E_coul = 54.26161300488791
  HOMO = -0.785575553787175  LUMO = 2.61513890356805
  mo_energy =
[-3.27138008e+01 -1.89793298e+00 -7.85575554e-01 -7.85575554e-01
 -7.85575554e-01  2.61513890e+00  2.61513890e+00  2.61513890e+00
  2.73407446e+00  1.97356404e+01  1.97356404e+01  1.97356404e+01
  4.53688770e+01  3.35027325e+02  2.02546250e+03  7.31681066e+03]
E1 = -182.46014689752522  E_coul = 54.26161298384959
Extra cycle  E= -128.198533913676  delta_E= -2.84e-13  |g|= 2.83e-07  |ddm|= 8.97e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14473527e+03 2.27378502e+02 1.42660249e+03 5.75614329e-01
 5.00310040e+01 1.32662925e+01 1.92916054e+00 2.76836879e+00
 1.32776937e+01 5.99137220e-01]
E = -128.19853391367565
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.73527024        1
[INPUT] 0    0    [1    /1   ]  227.378501824        1
[INPUT] 0    0    [1    /1   ]  1426.60248614        1
[INPUT] 0    0    [1    /1   ]  0.575614329391       1
[INPUT] 0    0    [1    /1   ]  50.0310039596        1
[INPUT] 0    0    [1    /1   ]  13.2662925419        1
[INPUT] 0    0    [1    /1   ]  1.92916054267        1
[INPUT] 1    0    [1    /1   ]  2.76836878562        1
[INPUT] 1    0    [1    /1   ]  13.2776937241        1
[INPUT] 1    0    [1    /1   ]  0.59913722037        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.7352702413996, 1.0]], [0, [227.37850182389138, 1.0]], [0, [1426.6024861432008, 1.0]], [0, [0.5756143293912841, 1.0]], [0, [50.03100395956629, 1.0]], [0, [13.266292541938295, 1.0]], [0, [1.929160542669153, 1.0]], [1, [2.768368785618545, 1.0]], [1, [13.27769372406531, 1.0]], [1, [0.5991372203703644, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.73527024]
bas 1, expnt(s) = [227.37850182]
bas 2, expnt(s) = [1426.60248614]
bas 3, expnt(s) = [0.57561433]
bas 4, expnt(s) = [50.03100396]
bas 5, expnt(s) = [13.26629254]
bas 6, expnt(s) = [1.92916054]
bas 7, expnt(s) = [2.76836879]
bas 8, expnt(s) = [13.27769372]
bas 9, expnt(s) = [0.59913722]
CPU time:       200.24
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14473527e+03 7.96242390e+02 2.27378502e+02 1.47937091e+02
 1.42660249e+03 5.86465213e+02 5.75614329e-01 1.66960494e+00
 5.00310040e+01 4.75274417e+01 1.32662925e+01 1.75621306e+01
 1.92916054e+00 4.13562643e+00 2.76836879e+00 1.04175195e+01
 1.32776937e+01 7.39414054e+01 5.99137220e-01 1.53777313e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965889845025455
cond(S) = 159.8018449280831
E1 = -183.13690012219362  E_coul = 55.01130844147302
init E= -128.125591680721
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742894660406981  LUMO = 2.64892953644848
  mo_energy =
[-3.25138195e+01 -1.85364041e+00 -7.42894660e-01 -7.42894660e-01
 -7.42894660e-01  2.64892954e+00  2.64892954e+00  2.64892954e+00
  2.76845315e+00  1.98709593e+01  1.98709593e+01  1.98709593e+01
  4.55395623e+01  3.35257134e+02  2.02573514e+03  7.31710600e+03]
E1 = -182.12713569972794  E_coul = 53.930557036235165
cycle= 1 E= -128.196578663493  delta_E= -0.071  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26135
diis-c [-0.06830387  1.        ]
  HOMO = -0.80823840675082  LUMO = 2.59463719027555
  mo_energy =
[-3.27882838e+01 -1.92137716e+00 -8.08238407e-01 -8.08238407e-01
 -8.08238407e-01  2.59463719e+00  2.59463719e+00  2.59463719e+00
  2.71400868e+00  1.96797856e+01  1.96797856e+01  1.96797856e+01
  4.53029600e+01  3.34945610e+02  2.02537524e+03  7.31672186e+03]
E1 = -182.59194561467706  E_coul = 54.39372024749569
cycle= 2 E= -128.198225367181  delta_E= -0.00165  |g|= 0.0629  |ddm|= 0.0646
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102416
diis-c [-4.05137393e-04  2.78174673e-01  7.21825327e-01]
  HOMO = -0.785366032089162  LUMO = 2.61529413494274
  mo_energy =
[-3.27131980e+01 -1.89763966e+00 -7.85366032e-01 -7.85366032e-01
 -7.85366032e-01  2.61529413e+00  2.61529413e+00  2.61529413e+00
  2.73430556e+00  1.97361114e+01  1.97361114e+01  1.97361114e+01
  4.53694498e+01  3.35027750e+02  2.02546278e+03  7.31681089e+03]
E1 = -182.45897147700762  E_coul = 54.26043759579591
cycle= 3 E= -128.198533881212  delta_E= -0.000309  |g|= 0.000683  |ddm|= 0.0183
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000855484
diis-c [-7.93728716e-08 -3.91254963e-03 -2.15162839e-03  1.00606418e+00]
  HOMO = -0.785590345932291  LUMO = 2.6151261228854
  mo_energy =
[-3.27138389e+01 -1.89793514e+00 -7.85590346e-01 -7.85590346e-01
 -7.85590346e-01  2.61512612e+00  2.61512612e+00  2.61512612e+00
  2.73407341e+00  1.97356111e+01  1.97356111e+01  1.97356111e+01
  4.53688461e+01  3.35027272e+02  2.02546243e+03  7.31681058e+03]
E1 = -182.460210726021  E_coul = 54.26167681265431
cycle= 4 E= -128.198533913367  delta_E= -3.22e-08  |g|= 5.19e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.23772e-05
diis-c [-2.15789577e-10  5.05376328e-04 -8.15494457e-04 -1.70704331e-01
  1.17101445e+00]
  HOMO = -0.785575613956061  LUMO = 2.61513883430309
  mo_energy =
[-3.27138009e+01 -1.89793265e+00 -7.85575614e-01 -7.85575614e-01
 -7.85575614e-01  2.61513883e+00  2.61513883e+00  2.61513883e+00
  2.73407473e+00  1.97356404e+01  1.97356404e+01  1.97356404e+01
  4.53688770e+01  3.35027324e+02  2.02546250e+03  7.31681066e+03]
E1 = -182.46014691856328  E_coul = 54.26161300488791
cycle= 5 E= -128.198533913675  delta_E= -3.09e-10  |g|= 1.55e-06  |ddm|= 2.64e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.46014691856328  E_coul = 54.26161300488791
  HOMO = -0.785575553787175  LUMO = 2.61513890356805
  mo_energy =
[-3.27138008e+01 -1.89793298e+00 -7.85575554e-01 -7.85575554e-01
 -7.85575554e-01  2.61513890e+00  2.61513890e+00  2.61513890e+00
  2.73407446e+00  1.97356404e+01  1.97356404e+01  1.97356404e+01
  4.53688770e+01  3.35027325e+02  2.02546250e+03  7.31681066e+03]
E1 = -182.46014689752522  E_coul = 54.26161298384959
Extra cycle  E= -128.198533913676  delta_E= -2.84e-13  |g|= 2.83e-07  |ddm|= 8.97e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 159.8018449280831
E1 = -182.46014689752522  E_coul = 54.26161298384959
init E= -128.198533913676
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785575540068468  LUMO = 2.61513891436697
  mo_energy =
[-3.27138008e+01 -1.89793303e+00 -7.85575540e-01 -7.85575540e-01
 -7.85575540e-01  2.61513891e+00  2.61513891e+00  2.61513891e+00
  2.73407440e+00  1.97356404e+01  1.97356404e+01  1.97356404e+01
  4.53688769e+01  3.35027325e+02  2.02546250e+03  7.31681066e+03]
E1 = -182.46014691244815  E_coul = 54.26161299877253
cycle= 1 E= -128.198533913676  delta_E= 2.84e-14  |g|= 5.15e-08  |ddm|= 1.62e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46014691244815  E_coul = 54.26161299877253
  HOMO = -0.785575536160122  LUMO = 2.61513891762641
  mo_energy =
[-3.27138008e+01 -1.89793304e+00 -7.85575536e-01 -7.85575536e-01
 -7.85575536e-01  2.61513892e+00  2.61513892e+00  2.61513892e+00
  2.73407440e+00  1.97356404e+01  1.97356404e+01  1.97356404e+01
  4.53688769e+01  3.35027325e+02  2.02546250e+03  7.31681066e+03]
E1 = -182.46014690837728  E_coul = 54.26161299470164
Extra cycle  E= -128.198533913676  delta_E= -2.84e-14  |g|= 9.43e-09  |ddm|= 2.88e-08
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
exp = [2.14473527e+03 2.27378502e+02 1.42660249e+03 5.75614329e-01
 5.00310040e+01 1.32662925e+01 1.92916054e+00 2.76836879e+00
 1.32776937e+01 5.99137220e-01]
grad_E = [-9.95394130e-06  6.83042423e-06  3.37973338e-05 -1.23711052e-04
  9.18683268e-06 -9.48765150e-05  3.16387780e-05 -7.94115328e-04
 -1.06885816e-04 -2.20621717e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.82877051        1
[INPUT] 0    0    [1    /1   ]  227.337251336        1
[INPUT] 0    0    [1    /1   ]  1426.28351866        1
[INPUT] 0    0    [1    /1   ]  0.575465080745       1
[INPUT] 0    0    [1    /1   ]  50.0216795964        1
[INPUT] 0    0    [1    /1   ]  13.2638876781        1
[INPUT] 0    0    [1    /1   ]  1.92864352242        1
[INPUT] 1    0    [1    /1   ]  2.76539563879        1
[INPUT] 1    0    [1    /1   ]  13.2605026383        1
[INPUT] 1    0    [1    /1   ]  0.598662871278       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.8287705096786, 1.0]], [0, [227.33725133636463, 1.0]], [0, [1426.2835186639572, 1.0]], [0, [0.5754650807454474, 1.0]], [0, [50.02167959636862, 1.0]], [0, [13.26388767812646, 1.0]], [0, [1.9286435224204765, 1.0]], [1, [2.7653956387860066, 1.0]], [1, [13.26050263831263, 1.0]], [1, [0.5986628712784173, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.82877051]
bas 1, expnt(s) = [227.33725134]
bas 2, expnt(s) = [1426.28351866]
bas 3, expnt(s) = [0.57546508]
bas 4, expnt(s) = [50.0216796]
bas 5, expnt(s) = [13.26388768]
bas 6, expnt(s) = [1.92864352]
bas 7, expnt(s) = [2.76539564]
bas 8, expnt(s) = [13.26050264]
bas 9, expnt(s) = [0.59866287]
CPU time:       202.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14482877e+03 7.96268424e+02 2.27337251e+02 1.47916962e+02
 1.42628352e+03 5.86366867e+02 5.75465081e-01 1.66928025e+00
 5.00216796e+01 4.75207982e+01 1.32638877e+01 1.75597428e+01
 1.92864352e+00 4.13479513e+00 2.76539564e+00 1.04035362e+01
 1.32605026e+01 7.38217567e+01 5.98662871e-01 1.53625142e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965989812661487
cond(S) = 159.59895436537943
E1 = -183.13688380430554  E_coul = 55.011230900405955
init E= -128.1256529039
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742893505422463  LUMO = 2.64596775787017
  mo_energy =
[-3.25138721e+01 -1.85364267e+00 -7.42893505e-01 -7.42893505e-01
 -7.42893505e-01  2.64596776e+00  2.64596776e+00  2.64596776e+00
  2.76722920e+00  1.98422771e+01  1.98422771e+01  1.98422771e+01
  4.55260439e+01  3.35182145e+02  2.02540387e+03  7.31636501e+03]
E1 = -182.12428423151246  E_coul = 53.927707587468696
cycle= 1 E= -128.196576644044  delta_E= -0.0709  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261848
diis-c [-0.06856421  1.        ]
  HOMO = -0.808440279649897  LUMO = 2.59154741749392
  mo_energy =
[-3.27888723e+01 -1.92161305e+00 -8.08440280e-01 -8.08440280e-01
 -8.08440280e-01  2.59154742e+00  2.59154742e+00  2.59154742e+00
  2.71259770e+00  1.96507857e+01  1.96507857e+01  1.96507857e+01
  4.52889685e+01  3.34870064e+02  2.02504339e+03  7.31598029e+03]
E1 = -182.5903086992339  E_coul = 54.392078163867176
cycle= 2 E= -128.198230535367  delta_E= -0.00165  |g|= 0.063  |ddm|= 0.0648
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102688
diis-c [-4.05633486e-04  2.78340093e-01  7.21659907e-01]
  HOMO = -0.785511410463313  LUMO = 2.61223540769901
  mo_energy =
[-3.27136170e+01 -1.89781597e+00 -7.85511410e-01 -7.85511410e-01
 -7.85511410e-01  2.61223541e+00  2.61223541e+00  2.61223541e+00
  2.73293908e+00  1.97072164e+01  1.97072164e+01  1.97072164e+01
  4.53556070e+01  3.34952384e+02  2.02513112e+03  7.31606951e+03]
E1 = -182.4569598466466  E_coul = 54.25841912069758
cycle= 3 E= -128.198540725949  delta_E= -0.00031  |g|= 0.00068  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00084821
diis-c [-8.10174588e-08 -3.92268073e-03 -2.28305597e-03  1.00620574e+00]
  HOMO = -0.785733736369096  LUMO = 2.61206949085891
  mo_energy =
[-3.27142522e+01 -1.89811018e+00 -7.85733736e-01 -7.85733736e-01
 -7.85733736e-01  2.61206949e+00  2.61206949e+00  2.61206949e+00
  2.73270818e+00  1.97067208e+01  1.97067208e+01  1.97067208e+01
  4.53550083e+01  3.34951912e+02  2.02513078e+03  7.31606921e+03]
E1 = -182.4581893360439  E_coul = 54.25964857818191
cycle= 4 E= -128.198540757862  delta_E= -3.19e-08  |g|= 5.24e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.32098e-05
diis-c [-2.18270376e-10  5.06388577e-04 -8.03359774e-04 -1.71148863e-01
  1.17144583e+00]
  HOMO = -0.785718872241352  LUMO = 2.61208230087162
  mo_energy =
[-3.27142139e+01 -1.89810772e+00 -7.85718872e-01 -7.85718872e-01
 -7.85718872e-01  2.61208230e+00  2.61208230e+00  2.61208230e+00
  2.73270947e+00  1.97067503e+01  1.97067503e+01  1.97067503e+01
  4.53550394e+01  3.34951965e+02  2.02513085e+03  7.31606929e+03]
E1 = -182.45812495355662  E_coul = 54.259584195378764
cycle= 5 E= -128.198540758178  delta_E= -3.16e-10  |g|= 1.55e-06  |ddm|= 2.68e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45812495355662  E_coul = 54.259584195378764
  HOMO = -0.785718811521616  LUMO = 2.6120823708047
  mo_energy =
[-3.27142138e+01 -1.89810804e+00 -7.85718812e-01 -7.85718812e-01
 -7.85718812e-01  2.61208237e+00  2.61208237e+00  2.61208237e+00
  2.73270920e+00  1.97067504e+01  1.97067504e+01  1.97067504e+01
  4.53550394e+01  3.34951965e+02  2.02513085e+03  7.31606929e+03]
E1 = -182.4581249277528  E_coul = 54.2595841695748
Extra cycle  E= -128.198540758178  delta_E= -1.71e-13  |g|= 2.84e-07  |ddm|= 8.99e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14482877e+03 2.27337251e+02 1.42628352e+03 5.75465081e-01
 5.00216796e+01 1.32638877e+01 1.92864352e+00 2.76539564e+00
 1.32605026e+01 5.98662871e-01]
E = -128.198540758178
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2144.82877051        1
[INPUT] 0    0    [1    /1   ]  227.337251336        1
[INPUT] 0    0    [1    /1   ]  1426.28351866        1
[INPUT] 0    0    [1    /1   ]  0.575465080745       1
[INPUT] 0    0    [1    /1   ]  50.0216795964        1
[INPUT] 0    0    [1    /1   ]  13.2638876781        1
[INPUT] 0    0    [1    /1   ]  1.92864352242        1
[INPUT] 1    0    [1    /1   ]  2.76539563879        1
[INPUT] 1    0    [1    /1   ]  13.2605026383        1
[INPUT] 1    0    [1    /1   ]  0.598662871278       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2144.8287705096786, 1.0]], [0, [227.33725133636463, 1.0]], [0, [1426.2835186639572, 1.0]], [0, [0.5754650807454474, 1.0]], [0, [50.02167959636862, 1.0]], [0, [13.26388767812646, 1.0]], [0, [1.9286435224204765, 1.0]], [1, [2.7653956387860066, 1.0]], [1, [13.26050263831263, 1.0]], [1, [0.5986628712784173, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2144.82877051]
bas 1, expnt(s) = [227.33725134]
bas 2, expnt(s) = [1426.28351866]
bas 3, expnt(s) = [0.57546508]
bas 4, expnt(s) = [50.0216796]
bas 5, expnt(s) = [13.26388768]
bas 6, expnt(s) = [1.92864352]
bas 7, expnt(s) = [2.76539564]
bas 8, expnt(s) = [13.26050264]
bas 9, expnt(s) = [0.59866287]
CPU time:       203.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14482877e+03 7.96268424e+02 2.27337251e+02 1.47916962e+02
 1.42628352e+03 5.86366867e+02 5.75465081e-01 1.66928025e+00
 5.00216796e+01 4.75207982e+01 1.32638877e+01 1.75597428e+01
 1.92864352e+00 4.13479513e+00 2.76539564e+00 1.04035362e+01
 1.32605026e+01 7.38217567e+01 5.98662871e-01 1.53625142e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.965989812661487
cond(S) = 159.59895436537943
E1 = -183.13688380430554  E_coul = 55.011230900405955
init E= -128.1256529039
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742893505422463  LUMO = 2.64596775787017
  mo_energy =
[-3.25138721e+01 -1.85364267e+00 -7.42893505e-01 -7.42893505e-01
 -7.42893505e-01  2.64596776e+00  2.64596776e+00  2.64596776e+00
  2.76722920e+00  1.98422771e+01  1.98422771e+01  1.98422771e+01
  4.55260439e+01  3.35182145e+02  2.02540387e+03  7.31636501e+03]
E1 = -182.12428423151246  E_coul = 53.927707587468696
cycle= 1 E= -128.196576644044  delta_E= -0.0709  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.261848
diis-c [-0.06856421  1.        ]
  HOMO = -0.808440279649897  LUMO = 2.59154741749392
  mo_energy =
[-3.27888723e+01 -1.92161305e+00 -8.08440280e-01 -8.08440280e-01
 -8.08440280e-01  2.59154742e+00  2.59154742e+00  2.59154742e+00
  2.71259770e+00  1.96507857e+01  1.96507857e+01  1.96507857e+01
  4.52889685e+01  3.34870064e+02  2.02504339e+03  7.31598029e+03]
E1 = -182.5903086992339  E_coul = 54.392078163867176
cycle= 2 E= -128.198230535367  delta_E= -0.00165  |g|= 0.063  |ddm|= 0.0648
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.102688
diis-c [-4.05633486e-04  2.78340093e-01  7.21659907e-01]
  HOMO = -0.785511410463313  LUMO = 2.61223540769901
  mo_energy =
[-3.27136170e+01 -1.89781597e+00 -7.85511410e-01 -7.85511410e-01
 -7.85511410e-01  2.61223541e+00  2.61223541e+00  2.61223541e+00
  2.73293908e+00  1.97072164e+01  1.97072164e+01  1.97072164e+01
  4.53556070e+01  3.34952384e+02  2.02513112e+03  7.31606951e+03]
E1 = -182.4569598466466  E_coul = 54.25841912069758
cycle= 3 E= -128.198540725949  delta_E= -0.00031  |g|= 0.00068  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00084821
diis-c [-8.10174588e-08 -3.92268073e-03 -2.28305597e-03  1.00620574e+00]
  HOMO = -0.785733736369096  LUMO = 2.61206949085891
  mo_energy =
[-3.27142522e+01 -1.89811018e+00 -7.85733736e-01 -7.85733736e-01
 -7.85733736e-01  2.61206949e+00  2.61206949e+00  2.61206949e+00
  2.73270818e+00  1.97067208e+01  1.97067208e+01  1.97067208e+01
  4.53550083e+01  3.34951912e+02  2.02513078e+03  7.31606921e+03]
E1 = -182.4581893360439  E_coul = 54.25964857818191
cycle= 4 E= -128.198540757862  delta_E= -3.19e-08  |g|= 5.24e-05  |ddm|= 0.000259
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.32098e-05
diis-c [-2.18270376e-10  5.06388577e-04 -8.03359774e-04 -1.71148863e-01
  1.17144583e+00]
  HOMO = -0.785718872241352  LUMO = 2.61208230087162
  mo_energy =
[-3.27142139e+01 -1.89810772e+00 -7.85718872e-01 -7.85718872e-01
 -7.85718872e-01  2.61208230e+00  2.61208230e+00  2.61208230e+00
  2.73270947e+00  1.97067503e+01  1.97067503e+01  1.97067503e+01
  4.53550394e+01  3.34951965e+02  2.02513085e+03  7.31606929e+03]
E1 = -182.45812495355662  E_coul = 54.259584195378764
cycle= 5 E= -128.198540758178  delta_E= -3.16e-10  |g|= 1.55e-06  |ddm|= 2.68e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45812495355662  E_coul = 54.259584195378764
  HOMO = -0.785718811521616  LUMO = 2.6120823708047
  mo_energy =
[-3.27142138e+01 -1.89810804e+00 -7.85718812e-01 -7.85718812e-01
 -7.85718812e-01  2.61208237e+00  2.61208237e+00  2.61208237e+00
  2.73270920e+00  1.97067504e+01  1.97067504e+01  1.97067504e+01
  4.53550394e+01  3.34951965e+02  2.02513085e+03  7.31606929e+03]
E1 = -182.4581249277528  E_coul = 54.2595841695748
Extra cycle  E= -128.198540758178  delta_E= -1.71e-13  |g|= 2.84e-07  |ddm|= 8.99e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 159.59895436537943
E1 = -182.4581249277528  E_coul = 54.2595841695748
init E= -128.198540758178
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785718798110534  LUMO = 2.61208238130612
  mo_energy =
[-3.27142138e+01 -1.89810810e+00 -7.85718798e-01 -7.85718798e-01
 -7.85718798e-01  2.61208238e+00  2.61208238e+00  2.61208238e+00
  2.73270915e+00  1.97067504e+01  1.97067504e+01  1.97067504e+01
  4.53550393e+01  3.34951965e+02  2.02513085e+03  7.31606929e+03]
E1 = -182.45812494438684  E_coul = 54.259584186208684
cycle= 1 E= -128.198540758178  delta_E= -1.42e-13  |g|= 5.16e-08  |ddm|= 1.62e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45812494438684  E_coul = 54.259584186208684
  HOMO = -0.785718794080035  LUMO = 2.61208238467093
  mo_energy =
[-3.27142138e+01 -1.89810811e+00 -7.85718794e-01 -7.85718794e-01
 -7.85718794e-01  2.61208238e+00  2.61208238e+00  2.61208238e+00
  2.73270914e+00  1.97067504e+01  1.97067504e+01  1.97067504e+01
  4.53550393e+01  3.34951965e+02  2.02513085e+03  7.31606929e+03]
E1 = -182.45812493960764  E_coul = 54.25958418142959
Extra cycle  E= -128.198540758178  delta_E= 8.53e-14  |g|= 9.47e-09  |ddm|= 2.88e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14482877e+03 2.27337251e+02 1.42628352e+03 5.75465081e-01
 5.00216796e+01 1.32638877e+01 1.92864352e+00 2.76539564e+00
 1.32605026e+01 5.98662871e-01]
grad_E = [-9.96263119e-06  6.72007971e-06  3.38346479e-05 -1.62428377e-04
  1.18146602e-05 -1.24720725e-04  4.15745629e-05 -1.04350936e-03
 -1.41064111e-04 -2.89854893e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2145.00184328        1
[INPUT] 0    0    [1    /1   ]  227.271991486        1
[INPUT] 0    0    [1    /1   ]  1425.69216211        1
[INPUT] 0    0    [1    /1   ]  0.575247893636       1
[INPUT] 0    0    [1    /1   ]  50.0075739023        1
[INPUT] 0    0    [1    /1   ]  13.2603359385        1
[INPUT] 0    0    [1    /1   ]  1.92789181529        1
[INPUT] 1    0    [1    /1   ]  2.76116089931        1
[INPUT] 1    0    [1    /1   ]  13.2360462218        1
[INPUT] 1    0    [1    /1   ]  0.597986679466       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2145.0018432788547, 1.0]], [0, [227.27199148611925, 1.0]], [0, [1425.6921621145475, 1.0]], [0, [0.575247893635524, 1.0]], [0, [50.00757390229175, 1.0]], [0, [13.260335938527758, 1.0]], [0, [1.9278918152892595, 1.0]], [1, [2.7611608993089574, 1.0]], [1, [13.23604622179111, 1.0]], [1, [0.5979866794663035, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2145.00184328]
bas 1, expnt(s) = [227.27199149]
bas 2, expnt(s) = [1425.69216211]
bas 3, expnt(s) = [0.57524789]
bas 4, expnt(s) = [50.0075739]
bas 5, expnt(s) = [13.26033594]
bas 6, expnt(s) = [1.92789182]
bas 7, expnt(s) = [2.7611609]
bas 8, expnt(s) = [13.23604622]
bas 9, expnt(s) = [0.59798668]
CPU time:       206.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14500184e+03 7.96316614e+02 2.27271991e+02 1.47885115e+02
 1.42569216e+03 5.86184521e+02 5.75247894e-01 1.66880773e+00
 5.00075739e+01 4.75107475e+01 1.32603359e+01 1.75562162e+01
 1.92789182e+00 4.13358639e+00 2.76116090e+00 1.03836260e+01
 1.32360462e+01 7.36516086e+01 5.97986679e-01 1.53408273e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966132042959577
cond(S) = 159.23124263981353
E1 = -183.13686232132906  E_coul = 55.011118533631546
init E= -128.125743787698
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742891586199211  LUMO = 2.64174873484521
  mo_energy =
[-3.25139499e+01 -1.85364631e+00 -7.42891586e-01 -7.42891586e-01
 -7.42891586e-01  2.64174873e+00  2.64174873e+00  2.64174873e+00
  2.76544790e+00  1.98014701e+01  1.98014701e+01  1.98014701e+01
  4.55059611e+01  3.35066211e+02  2.02483809e+03  7.31504474e+03]
E1 = -182.12021735146064  E_coul = 53.923640988234695
cycle= 1 E= -128.196576363226  delta_E= -0.0708  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262558
diis-c [-0.06893658  1.        ]
  HOMO = -0.808727941056797  LUMO = 2.58714627929413
  mo_energy =
[-3.27897148e+01 -1.92194984e+00 -8.08727941e-01 -8.08727941e-01
 -8.08727941e-01  2.58714628e+00  2.58714628e+00  2.58714628e+00
  2.71055062e+00  1.96095258e+01  1.96095258e+01  1.96095258e+01
  4.52682120e+01  3.34753335e+02  2.02447679e+03  7.31465919e+03]
E1 = -182.58797640771766  E_coul = 54.38973586827343
cycle= 2 E= -128.198240539444  delta_E= -0.00166  |g|= 0.0632  |ddm|= 0.065
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.103077
diis-c [-4.06321266e-04  2.78575644e-01  7.21424356e-01]
  HOMO = -0.785718402241696  LUMO = 2.60787848599183
  mo_energy =
[-3.27142174e+01 -1.89806768e+00 -7.85718402e-01 -7.85718402e-01
 -7.85718402e-01  2.60787849e+00  2.60787849e+00  2.60787849e+00
  2.73095530e+00  1.96661063e+01  1.96661063e+01  1.96661063e+01
  4.53350624e+01  3.34835912e+02  2.02456478e+03  7.31474869e+03]
E1 = -182.4540922581352  E_coul = 54.255539125752605
cycle= 3 E= -128.198553132383  delta_E= -0.000313  |g|= 0.000676  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000837879
diis-c [-8.33913392e-08 -3.93733101e-03 -2.47065440e-03  1.00640799e+00]
  HOMO = -0.785937878704815  LUMO = 2.60771556495731
  mo_energy =
[-3.27148445e+01 -1.89836007e+00 -7.85937879e-01 -7.85937879e-01
 -7.85937879e-01  2.60771556e+00  2.60771556e+00  2.60771556e+00
  2.73072620e+00  1.96656174e+01  1.96656174e+01  1.96656174e+01
  4.53344707e+01  3.34835450e+02  2.02456446e+03  7.31474840e+03]
E1 = -182.45530772698112  E_coul = 54.256754563023826
cycle= 4 E= -128.198553163957  delta_E= -3.16e-08  |g|= 5.32e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.43946e-05
diis-c [-2.21845422e-10  5.07773342e-04 -7.85843207e-04 -1.71761193e-01
  1.17203926e+00]
  HOMO = -0.785922826765224  LUMO = 2.60772851450613
  mo_energy =
[-3.27148057e+01 -1.89835764e+00 -7.85922827e-01 -7.85922827e-01
 -7.85922827e-01  2.60772851e+00  2.60772851e+00  2.60772851e+00
  2.73072745e+00  1.96656473e+01  1.96656473e+01  1.96656473e+01
  4.53345022e+01  3.34835503e+02  2.02456453e+03  7.31474848e+03]
E1 = -182.45524252639788  E_coul = 54.25668936211422
cycle= 5 E= -128.198553164284  delta_E= -3.26e-10  |g|= 1.55e-06  |ddm|= 2.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45524252639788  E_coul = 54.25668936211422
  HOMO = -0.785922765156323  LUMO = 2.60772858548539
  mo_energy =
[-3.27148056e+01 -1.89835797e+00 -7.85922765e-01 -7.85922765e-01
 -7.85922765e-01  2.60772859e+00  2.60772859e+00  2.60772859e+00
  2.73072717e+00  1.96656473e+01  1.96656473e+01  1.96656473e+01
  4.53345022e+01  3.34835504e+02  2.02456453e+03  7.31474848e+03]
E1 = -182.45524249324487  E_coul = 54.25668932896089
Extra cycle  E= -128.198553164284  delta_E= -3.13e-13  |g|= 2.85e-07  |ddm|= 9.01e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
exp = [2.14500184e+03 2.27271991e+02 1.42569216e+03 5.75247894e-01
 5.00075739e+01 1.32603359e+01 1.92789182e+00 2.76116090e+00
 1.32360462e+01 5.97986679e-01]
E = -128.19855316428396
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2145.00184328        1
[INPUT] 0    0    [1    /1   ]  227.271991486        1
[INPUT] 0    0    [1    /1   ]  1425.69216211        1
[INPUT] 0    0    [1    /1   ]  0.575247893636       1
[INPUT] 0    0    [1    /1   ]  50.0075739023        1
[INPUT] 0    0    [1    /1   ]  13.2603359385        1
[INPUT] 0    0    [1    /1   ]  1.92789181529        1
[INPUT] 1    0    [1    /1   ]  2.76116089931        1
[INPUT] 1    0    [1    /1   ]  13.2360462218        1
[INPUT] 1    0    [1    /1   ]  0.597986679466       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2145.0018432788547, 1.0]], [0, [227.27199148611925, 1.0]], [0, [1425.6921621145475, 1.0]], [0, [0.575247893635524, 1.0]], [0, [50.00757390229175, 1.0]], [0, [13.260335938527758, 1.0]], [0, [1.9278918152892595, 1.0]], [1, [2.7611608993089574, 1.0]], [1, [13.23604622179111, 1.0]], [1, [0.5979866794663035, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2145.00184328]
bas 1, expnt(s) = [227.27199149]
bas 2, expnt(s) = [1425.69216211]
bas 3, expnt(s) = [0.57524789]
bas 4, expnt(s) = [50.0075739]
bas 5, expnt(s) = [13.26033594]
bas 6, expnt(s) = [1.92789182]
bas 7, expnt(s) = [2.7611609]
bas 8, expnt(s) = [13.23604622]
bas 9, expnt(s) = [0.59798668]
CPU time:       207.67
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14500184e+03 7.96316614e+02 2.27271991e+02 1.47885115e+02
 1.42569216e+03 5.86184521e+02 5.75247894e-01 1.66880773e+00
 5.00075739e+01 4.75107475e+01 1.32603359e+01 1.75562162e+01
 1.92789182e+00 4.13358639e+00 2.76116090e+00 1.03836260e+01
 1.32360462e+01 7.36516086e+01 5.97986679e-01 1.53408273e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966132042959577
cond(S) = 159.23124263981353
E1 = -183.13686232132906  E_coul = 55.011118533631546
init E= -128.125743787698
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742891586199211  LUMO = 2.64174873484521
  mo_energy =
[-3.25139499e+01 -1.85364631e+00 -7.42891586e-01 -7.42891586e-01
 -7.42891586e-01  2.64174873e+00  2.64174873e+00  2.64174873e+00
  2.76544790e+00  1.98014701e+01  1.98014701e+01  1.98014701e+01
  4.55059611e+01  3.35066211e+02  2.02483809e+03  7.31504474e+03]
E1 = -182.12021735146064  E_coul = 53.923640988234695
cycle= 1 E= -128.196576363226  delta_E= -0.0708  |g|= 0.166  |ddm|= 0.182
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.262558
diis-c [-0.06893658  1.        ]
  HOMO = -0.808727941056797  LUMO = 2.58714627929413
  mo_energy =
[-3.27897148e+01 -1.92194984e+00 -8.08727941e-01 -8.08727941e-01
 -8.08727941e-01  2.58714628e+00  2.58714628e+00  2.58714628e+00
  2.71055062e+00  1.96095258e+01  1.96095258e+01  1.96095258e+01
  4.52682120e+01  3.34753335e+02  2.02447679e+03  7.31465919e+03]
E1 = -182.58797640771766  E_coul = 54.38973586827343
cycle= 2 E= -128.198240539444  delta_E= -0.00166  |g|= 0.0632  |ddm|= 0.065
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.103077
diis-c [-4.06321266e-04  2.78575644e-01  7.21424356e-01]
  HOMO = -0.785718402241696  LUMO = 2.60787848599183
  mo_energy =
[-3.27142174e+01 -1.89806768e+00 -7.85718402e-01 -7.85718402e-01
 -7.85718402e-01  2.60787849e+00  2.60787849e+00  2.60787849e+00
  2.73095530e+00  1.96661063e+01  1.96661063e+01  1.96661063e+01
  4.53350624e+01  3.34835912e+02  2.02456478e+03  7.31474869e+03]
E1 = -182.4540922581352  E_coul = 54.255539125752605
cycle= 3 E= -128.198553132383  delta_E= -0.000313  |g|= 0.000676  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000837879
diis-c [-8.33913392e-08 -3.93733101e-03 -2.47065440e-03  1.00640799e+00]
  HOMO = -0.785937878704815  LUMO = 2.60771556495731
  mo_energy =
[-3.27148445e+01 -1.89836007e+00 -7.85937879e-01 -7.85937879e-01
 -7.85937879e-01  2.60771556e+00  2.60771556e+00  2.60771556e+00
  2.73072620e+00  1.96656174e+01  1.96656174e+01  1.96656174e+01
  4.53344707e+01  3.34835450e+02  2.02456446e+03  7.31474840e+03]
E1 = -182.45530772698112  E_coul = 54.256754563023826
cycle= 4 E= -128.198553163957  delta_E= -3.16e-08  |g|= 5.32e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.43946e-05
diis-c [-2.21845422e-10  5.07773342e-04 -7.85843207e-04 -1.71761193e-01
  1.17203926e+00]
  HOMO = -0.785922826765224  LUMO = 2.60772851450613
  mo_energy =
[-3.27148057e+01 -1.89835764e+00 -7.85922827e-01 -7.85922827e-01
 -7.85922827e-01  2.60772851e+00  2.60772851e+00  2.60772851e+00
  2.73072745e+00  1.96656473e+01  1.96656473e+01  1.96656473e+01
  4.53345022e+01  3.34835503e+02  2.02456453e+03  7.31474848e+03]
E1 = -182.45524252639788  E_coul = 54.25668936211422
cycle= 5 E= -128.198553164284  delta_E= -3.26e-10  |g|= 1.55e-06  |ddm|= 2.73e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45524252639788  E_coul = 54.25668936211422
  HOMO = -0.785922765156323  LUMO = 2.60772858548539
  mo_energy =
[-3.27148056e+01 -1.89835797e+00 -7.85922765e-01 -7.85922765e-01
 -7.85922765e-01  2.60772859e+00  2.60772859e+00  2.60772859e+00
  2.73072717e+00  1.96656473e+01  1.96656473e+01  1.96656473e+01
  4.53345022e+01  3.34835504e+02  2.02456453e+03  7.31474848e+03]
E1 = -182.45524249324487  E_coul = 54.25668932896089
Extra cycle  E= -128.198553164284  delta_E= -3.13e-13  |g|= 2.85e-07  |ddm|= 9.01e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 159.23124263981353
E1 = -182.45524249324487  E_coul = 54.25668932896089
init E= -128.198553164284
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.785922752220497  LUMO = 2.6077285955304
  mo_energy =
[-3.27148056e+01 -1.89835803e+00 -7.85922752e-01 -7.85922752e-01
 -7.85922752e-01  2.60772860e+00  2.60772860e+00  2.60772860e+00
  2.73072712e+00  1.96656473e+01  1.96656473e+01  1.96656473e+01
  4.53345021e+01  3.34835504e+02  2.02456453e+03  7.31474848e+03]
E1 = -182.45524251254372  E_coul = 54.256689348259755
cycle= 1 E= -128.198553164284  delta_E=    0  |g|= 5.18e-08  |ddm|= 1.63e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45524251254372  E_coul = 54.256689348259755
  HOMO = -0.785922748000134  LUMO = 2.6077285990592
  mo_energy =
[-3.27148056e+01 -1.89835803e+00 -7.85922748e-01 -7.85922748e-01
 -7.85922748e-01  2.60772860e+00  2.60772860e+00  2.60772860e+00
  2.73072711e+00  1.96656473e+01  1.96656473e+01  1.96656473e+01
  4.53345021e+01  3.34835504e+02  2.02456453e+03  7.31474848e+03]
E1 = -182.45524250666426  E_coul = 54.25668934238037
Extra cycle  E= -128.198553164284  delta_E= 5.68e-14  |g|= 9.53e-09  |ddm|= 2.89e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14500184e+03 2.27271991e+02 1.42569216e+03 5.75247894e-01
 5.00075739e+01 1.32603359e+01 1.92789182e+00 2.76116090e+00
 1.32360462e+01 5.97986679e-01]
grad_E = [-9.98014435e-06  6.56410191e-06  3.38963070e-05 -2.17719992e-04
  1.55721916e-05 -1.67372976e-04  5.57460986e-05 -1.39995901e-03
 -1.89933895e-04 -3.88351652e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:13 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2145.32379071        1
[INPUT] 0    0    [1    /1   ]  227.166081807        1
[INPUT] 0    0    [1    /1   ]  1424.59082467        1
[INPUT] 0    0    [1    /1   ]  0.574926420246       1
[INPUT] 0    0    [1    /1   ]  49.9857352342        1
[INPUT] 0    0    [1    /1   ]  13.2549847033        1
[INPUT] 0    0    [1    /1   ]  1.92678055327        1
[INPUT] 1    0    [1    /1   ]  2.7550544697         1
[INPUT] 1    0    [1    /1   ]  13.2008352473        1
[INPUT] 1    0    [1    /1   ]  0.597010516988       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2145.3237907118832, 1.0]], [0, [227.16608180697355, 1.0]], [0, [1424.5908246710085, 1.0]], [0, [0.5749264202456269, 1.0]], [0, [49.98573523415269, 1.0]], [0, [13.254984703346892, 1.0]], [0, [1.9267805532671336, 1.0]], [1, [2.755054469695178, 1.0]], [1, [13.200835247256085, 1.0]], [1, [0.5970105169875652, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2145.32379071]
bas 1, expnt(s) = [227.16608181]
bas 2, expnt(s) = [1424.59082467]
bas 3, expnt(s) = [0.57492642]
bas 4, expnt(s) = [49.98573523]
bas 5, expnt(s) = [13.2549847]
bas 6, expnt(s) = [1.92678055]
bas 7, expnt(s) = [2.75505447]
bas 8, expnt(s) = [13.20083525]
bas 9, expnt(s) = [0.59701052]
CPU time:       210.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14532379e+03 7.96406252e+02 2.27166082e+02 1.47833425e+02
 1.42459082e+03 5.85844870e+02 5.74926420e-01 1.66810823e+00
 4.99857352e+01 4.74951854e+01 1.32549847e+01 1.75509022e+01
 1.92678055e+00 4.13179927e+00 2.75505447e+00 1.03549291e+01
 1.32008352e+01 7.34067770e+01 5.97010517e-01 1.53095304e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966336770270974
cond(S) = 158.56009588595984
E1 = -183.13683336245526  E_coul = 55.01095255527374
init E= -128.125880807182
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742888243247479  LUMO = 2.63566427543385
  mo_energy =
[-3.25140671e+01 -1.85365233e+00 -7.42888243e-01 -7.42888243e-01
 -7.42888243e-01  2.63566428e+00  2.63566428e+00  2.63566428e+00
  2.76281130e+00  1.97427163e+01  1.97427163e+01  1.97427163e+01
  4.54755006e+01  3.34882475e+02  2.02385150e+03  7.31265996e+03]
E1 = -182.11434153516026  E_coul = 53.91776147795173
cycle= 1 E= -128.196580057209  delta_E= -0.0707  |g|= 0.167  |ddm|= 0.183
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263584
diis-c [-0.06947675  1.        ]
  HOMO = -0.809142921473598  LUMO = 2.58079968403966
  mo_energy =
[-3.27909375e+01 -1.92243702e+00 -8.09142921e-01 -8.09142921e-01
 -8.09142921e-01  2.58079968e+00  2.58079968e+00  2.58079968e+00
  2.70753186e+00  1.95501185e+01  1.95501185e+01  1.95501185e+01
  4.52367798e+01  3.34568452e+02  2.02348901e+03  7.31227321e+03]
E1 = -182.58461107082223  E_coul = 54.38635191097744
cycle= 2 E= -128.198259159845  delta_E= -0.00168  |g|= 0.0636  |ddm|= 0.0654
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.103639
diis-c [-4.07278801e-04  2.78915026e-01  7.21084974e-01]
  HOMO = -0.786016656431823  LUMO = 2.6015956285614
  mo_energy =
[-3.27150900e+01 -1.89843172e+00 -7.86016656e-01 -7.86016656e-01
 -7.86016656e-01  2.60159563e+00  2.60159563e+00  2.60159563e+00
  2.72802772e+00  1.96069152e+01  1.96069152e+01  1.96069152e+01
  4.53039362e+01  3.34651401e+02  2.02357741e+03  7.31236311e+03]
E1 = -182.44995186666924  E_coul = 54.251376620324514
cycle= 3 E= -128.198575246345  delta_E= -0.000316  |g|= 0.00067  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000823071
diis-c [-8.68805850e-08 -3.95889502e-03 -2.74178396e-03  1.00670068e+00]
  HOMO = -0.786231990668074  LUMO = 2.60143704761422
  mo_energy =
[-3.27157053e+01 -1.89872146e+00 -7.86231991e-01 -7.86231991e-01
 -7.86231991e-01  2.60143705e+00  2.60143705e+00  2.60143705e+00
  2.72780124e+00  1.96064361e+01  1.96064361e+01  1.96064361e+01
  4.53033549e+01  3.34650952e+02  2.02357710e+03  7.31236284e+03]
E1 = -182.45114689287874  E_coul = 54.25257161543115
cycle= 4 E= -128.198575277448  delta_E= -3.11e-08  |g|= 5.44e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.61017e-05
diis-c [-2.27089680e-10  5.09657816e-04 -7.60165166e-04 -1.72603543e-01
  1.17285405e+00]
  HOMO = -0.786216668691167  LUMO = 2.6014501965907
  mo_energy =
[-3.27156659e+01 -1.89871909e+00 -7.86216669e-01 -7.86216669e-01
 -7.86216669e-01  2.60145020e+00  2.60145020e+00  2.60145020e+00
  2.72780242e+00  1.96064664e+01  1.96064664e+01  1.96064664e+01
  4.53033869e+01  3.34651007e+02  2.02357717e+03  7.31236292e+03]
E1 = -182.45108051416307  E_coul = 54.252505236374105
cycle= 5 E= -128.198575277789  delta_E= -3.41e-10  |g|= 1.56e-06  |ddm|= 2.8e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45108051416307  E_coul = 54.252505236374105
  HOMO = -0.786216605592699  LUMO = 2.60145026926495
  mo_energy =
[-3.27156658e+01 -1.89871941e+00 -7.86216606e-01 -7.86216606e-01
 -7.86216606e-01  2.60145027e+00  2.60145027e+00  2.60145027e+00
  2.72780215e+00  1.96064665e+01  1.96064665e+01  1.96064665e+01
  4.53033868e+01  3.34651007e+02  2.02357717e+03  7.31236292e+03]
E1 = -182.45108046929286  E_coul = 54.25250519150362
Extra cycle  E= -128.198575277789  delta_E= -2.84e-13  |g|= 2.86e-07  |ddm|= 9.05e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14532379e+03 2.27166082e+02 1.42459082e+03 5.74926420e-01
 4.99857352e+01 1.32549847e+01 1.92678055e+00 2.75505447e+00
 1.32008352e+01 5.97010517e-01]
E = -128.19857527778925
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2145.32379071        1
[INPUT] 0    0    [1    /1   ]  227.166081807        1
[INPUT] 0    0    [1    /1   ]  1424.59082467        1
[INPUT] 0    0    [1    /1   ]  0.574926420246       1
[INPUT] 0    0    [1    /1   ]  49.9857352342        1
[INPUT] 0    0    [1    /1   ]  13.2549847033        1
[INPUT] 0    0    [1    /1   ]  1.92678055327        1
[INPUT] 1    0    [1    /1   ]  2.7550544697         1
[INPUT] 1    0    [1    /1   ]  13.2008352473        1
[INPUT] 1    0    [1    /1   ]  0.597010516988       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2145.3237907118832, 1.0]], [0, [227.16608180697355, 1.0]], [0, [1424.5908246710085, 1.0]], [0, [0.5749264202456269, 1.0]], [0, [49.98573523415269, 1.0]], [0, [13.254984703346892, 1.0]], [0, [1.9267805532671336, 1.0]], [1, [2.755054469695178, 1.0]], [1, [13.200835247256085, 1.0]], [1, [0.5970105169875652, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2145.32379071]
bas 1, expnt(s) = [227.16608181]
bas 2, expnt(s) = [1424.59082467]
bas 3, expnt(s) = [0.57492642]
bas 4, expnt(s) = [49.98573523]
bas 5, expnt(s) = [13.2549847]
bas 6, expnt(s) = [1.92678055]
bas 7, expnt(s) = [2.75505447]
bas 8, expnt(s) = [13.20083525]
bas 9, expnt(s) = [0.59701052]
CPU time:       211.42
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14532379e+03 7.96406252e+02 2.27166082e+02 1.47833425e+02
 1.42459082e+03 5.85844870e+02 5.74926420e-01 1.66810823e+00
 4.99857352e+01 4.74951854e+01 1.32549847e+01 1.75509022e+01
 1.92678055e+00 4.13179927e+00 2.75505447e+00 1.03549291e+01
 1.32008352e+01 7.34067770e+01 5.97010517e-01 1.53095304e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966336770270974
cond(S) = 158.56009588595984
E1 = -183.13683336245526  E_coul = 55.01095255527374
init E= -128.125880807182
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742888243247479  LUMO = 2.63566427543385
  mo_energy =
[-3.25140671e+01 -1.85365233e+00 -7.42888243e-01 -7.42888243e-01
 -7.42888243e-01  2.63566428e+00  2.63566428e+00  2.63566428e+00
  2.76281130e+00  1.97427163e+01  1.97427163e+01  1.97427163e+01
  4.54755006e+01  3.34882475e+02  2.02385150e+03  7.31265996e+03]
E1 = -182.11434153516026  E_coul = 53.91776147795173
cycle= 1 E= -128.196580057209  delta_E= -0.0707  |g|= 0.167  |ddm|= 0.183
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.263584
diis-c [-0.06947675  1.        ]
  HOMO = -0.809142921473598  LUMO = 2.58079968403966
  mo_energy =
[-3.27909375e+01 -1.92243702e+00 -8.09142921e-01 -8.09142921e-01
 -8.09142921e-01  2.58079968e+00  2.58079968e+00  2.58079968e+00
  2.70753186e+00  1.95501185e+01  1.95501185e+01  1.95501185e+01
  4.52367798e+01  3.34568452e+02  2.02348901e+03  7.31227321e+03]
E1 = -182.58461107082223  E_coul = 54.38635191097744
cycle= 2 E= -128.198259159845  delta_E= -0.00168  |g|= 0.0636  |ddm|= 0.0654
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.103639
diis-c [-4.07278801e-04  2.78915026e-01  7.21084974e-01]
  HOMO = -0.786016656431823  LUMO = 2.6015956285614
  mo_energy =
[-3.27150900e+01 -1.89843172e+00 -7.86016656e-01 -7.86016656e-01
 -7.86016656e-01  2.60159563e+00  2.60159563e+00  2.60159563e+00
  2.72802772e+00  1.96069152e+01  1.96069152e+01  1.96069152e+01
  4.53039362e+01  3.34651401e+02  2.02357741e+03  7.31236311e+03]
E1 = -182.44995186666924  E_coul = 54.251376620324514
cycle= 3 E= -128.198575246345  delta_E= -0.000316  |g|= 0.00067  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000823071
diis-c [-8.68805850e-08 -3.95889502e-03 -2.74178396e-03  1.00670068e+00]
  HOMO = -0.786231990668074  LUMO = 2.60143704761422
  mo_energy =
[-3.27157053e+01 -1.89872146e+00 -7.86231991e-01 -7.86231991e-01
 -7.86231991e-01  2.60143705e+00  2.60143705e+00  2.60143705e+00
  2.72780124e+00  1.96064361e+01  1.96064361e+01  1.96064361e+01
  4.53033549e+01  3.34650952e+02  2.02357710e+03  7.31236284e+03]
E1 = -182.45114689287874  E_coul = 54.25257161543115
cycle= 4 E= -128.198575277448  delta_E= -3.11e-08  |g|= 5.44e-05  |ddm|= 0.00026
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.61017e-05
diis-c [-2.27089680e-10  5.09657816e-04 -7.60165166e-04 -1.72603543e-01
  1.17285405e+00]
  HOMO = -0.786216668691167  LUMO = 2.6014501965907
  mo_energy =
[-3.27156659e+01 -1.89871909e+00 -7.86216669e-01 -7.86216669e-01
 -7.86216669e-01  2.60145020e+00  2.60145020e+00  2.60145020e+00
  2.72780242e+00  1.96064664e+01  1.96064664e+01  1.96064664e+01
  4.53033869e+01  3.34651007e+02  2.02357717e+03  7.31236292e+03]
E1 = -182.45108051416307  E_coul = 54.252505236374105
cycle= 5 E= -128.198575277789  delta_E= -3.41e-10  |g|= 1.56e-06  |ddm|= 2.8e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.45108051416307  E_coul = 54.252505236374105
  HOMO = -0.786216605592699  LUMO = 2.60145026926495
  mo_energy =
[-3.27156658e+01 -1.89871941e+00 -7.86216606e-01 -7.86216606e-01
 -7.86216606e-01  2.60145027e+00  2.60145027e+00  2.60145027e+00
  2.72780215e+00  1.96064665e+01  1.96064665e+01  1.96064665e+01
  4.53033868e+01  3.34651007e+02  2.02357717e+03  7.31236292e+03]
E1 = -182.45108046929286  E_coul = 54.25250519150362
Extra cycle  E= -128.198575277789  delta_E= -2.84e-13  |g|= 2.86e-07  |ddm|= 9.05e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 158.56009588595984
E1 = -182.45108046929286  E_coul = 54.25250519150362
init E= -128.198575277789
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786216593416089  LUMO = 2.601450278587
  mo_energy =
[-3.27156658e+01 -1.89871947e+00 -7.86216593e-01 -7.86216593e-01
 -7.86216593e-01  2.60145028e+00  2.60145028e+00  2.60145028e+00
  2.72780209e+00  1.96064665e+01  1.96064665e+01  1.96064665e+01
  4.53033868e+01  3.34651007e+02  2.02357717e+03  7.31236292e+03]
E1 = -182.45108049288805  E_coul = 54.252505215098935
cycle= 1 E= -128.198575277789  delta_E= 1.14e-13  |g|= 5.2e-08  |ddm|= 1.64e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.45108049288805  E_coul = 54.252505215098935
  HOMO = -0.786216588890389  LUMO = 2.60145028237973
  mo_energy =
[-3.27156658e+01 -1.89871948e+00 -7.86216589e-01 -7.86216589e-01
 -7.86216589e-01  2.60145028e+00  2.60145028e+00  2.60145028e+00
  2.72780208e+00  1.96064665e+01  1.96064665e+01  1.96064665e+01
  4.53033868e+01  3.34651007e+02  2.02357717e+03  7.31236292e+03]
E1 = -182.45108048523917  E_coul = 54.25250520745008
Extra cycle  E= -128.198575277789  delta_E= 2.84e-14  |g|= 9.63e-09  |ddm|= 2.9e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14532379e+03 2.27166082e+02 1.42459082e+03 5.74926420e-01
 4.99857352e+01 1.32549847e+01 1.92678055e+00 2.75505447e+00
 1.32008352e+01 5.97010517e-01]
grad_E = [-1.00147356e-05  6.34255739e-06  3.40007168e-05 -2.97693329e-04
  2.10116844e-05 -2.29131475e-04  7.61976909e-05 -1.91616554e-03
 -2.60870524e-04 -5.30067293e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2145.91940424        1
[INPUT] 0    0    [1    /1   ]  226.992487667        1
[INPUT] 0    0    [1    /1   ]  1422.55143121        1
[INPUT] 0    0    [1    /1   ]  0.574451187942       1
[INPUT] 0    0    [1    /1   ]  49.9516869791        1
[INPUT] 0    0    [1    /1   ]  13.246899028         1
[INPUT] 0    0    [1    /1   ]  1.92514089766        1
[INPUT] 1    0    [1    /1   ]  2.74632117861        1
[INPUT] 1    0    [1    /1   ]  13.1505879852        1
[INPUT] 1    0    [1    /1   ]  0.595612140347       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2145.9194042415024, 1.0]], [0, [226.99248766742843, 1.0]], [0, [1422.5514312053003, 1.0]], [0, [0.5744511879417797, 1.0]], [0, [49.9516869791271, 1.0]], [0, [13.24689902804217, 1.0]], [0, [1.9251408976596993, 1.0]], [1, [2.7463211786081323, 1.0]], [1, [13.150587985193738, 1.0]], [1, [0.5956121403470214, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2145.91940424]
bas 1, expnt(s) = [226.99248767]
bas 2, expnt(s) = [1422.55143121]
bas 3, expnt(s) = [0.57445119]
bas 4, expnt(s) = [49.95168698]
bas 5, expnt(s) = [13.24689903]
bas 6, expnt(s) = [1.9251409]
bas 7, expnt(s) = [2.74632118]
bas 8, expnt(s) = [13.15058799]
bas 9, expnt(s) = [0.59561214]
CPU time:       214.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14591940e+03 7.96572078e+02 2.26992488e+02 1.47748690e+02
 1.42255143e+03 5.85215751e+02 5.74451188e-01 1.66707398e+00
 4.99516870e+01 4.74709195e+01 1.32468990e+01 1.75428720e+01
 1.92514090e+00 4.12916193e+00 2.74632118e+00 1.03139151e+01
 1.31505880e+01 7.30576766e+01 5.95612140e-01 1.52647192e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966628772261785
cond(S) = 157.34327143029583
E1 = -183.13679393961223  E_coul = 55.01070704543519
init E= -128.126086894177
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742882278845339  LUMO = 2.62696093513282
  mo_energy =
[-3.25142447e+01 -1.85366243e+00 -7.42882279e-01 -7.42882279e-01
 -7.42882279e-01  2.62696094e+00  2.62696094e+00  2.62696094e+00
  2.75891459e+00  1.96588688e+01  1.96588688e+01  1.96588688e+01
  4.54291204e+01  3.34588650e+02  2.02212043e+03  7.30834921e+03]
E1 = -182.10591340676447  E_coul = 53.909321283725205
cycle= 1 E= -128.196592123039  delta_E= -0.0705  |g|= 0.168  |ddm|= 0.183
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.265058
diis-c [-0.07025588  1.        ]
  HOMO = -0.809736738116895  LUMO = 2.57172246467206
  mo_energy =
[-3.27927016e+01 -1.92313680e+00 -8.09736738e-01 -8.09736738e-01
 -8.09736738e-01  2.57172246e+00  2.57172246e+00  2.57172246e+00
  2.70309067e+00  1.94653353e+01  1.94653353e+01  1.94653353e+01
  4.51890095e+01  3.34272984e+02  2.02175625e+03  7.30796074e+03]
E1 = -182.57979218415971  E_coul = 54.38149941421825
cycle= 2 E= -128.198292769941  delta_E= -0.0017  |g|= 0.064  |ddm|= 0.0659
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104447
diis-c [-4.08583647e-04  2.79399662e-01  7.20600338e-01]
  HOMO = -0.786442712426022  LUMO = 2.59260951287148
  mo_energy =
[-3.27163511e+01 -1.89895450e+00 -7.86442712e-01 -7.86442712e-01
 -7.86442712e-01  2.59260951e+00  2.59260951e+00  2.59260951e+00
  2.72371672e+00  1.95224421e+01  1.95224421e+01  1.95224421e+01
  4.52566045e+01  3.34356466e+02  2.02184521e+03  7.30805122e+03]
E1 = -182.44401802918932  E_coul = 54.24540411567325
cycle= 3 E= -128.198613913516  delta_E= -0.000321  |g|= 0.000662  |ddm|= 0.0187
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000802127
diis-c [-9.20086990e-08 -3.99062413e-03 -3.13058120e-03  1.00712121e+00]
  HOMO = -0.786652058340841  LUMO = 2.59245717612377
  mo_energy =
[-3.27169495e+01 -1.89924038e+00 -7.86652058e-01 -7.86652058e-01
 -7.86652058e-01  2.59245718e+00  2.59245718e+00  2.59245718e+00
  2.72349407e+00  1.95219769e+01  1.95219769e+01  1.95219769e+01
  4.52560380e+01  3.34356037e+02  2.02184492e+03  7.30805097e+03]
E1 = -182.44518338217725  E_coul = 54.24656943819912
cycle= 4 E= -128.198613943978  delta_E= -3.05e-08  |g|= 5.6e-05  |ddm|= 0.000261
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.8541e-05
diis-c [-2.34784986e-10  5.12138999e-04 -7.22685989e-04 -1.73730985e-01
  1.17394153e+00]
  HOMO = -0.786636351646607  LUMO = 2.59247060677491
  mo_energy =
[-3.27169091e+01 -1.89923807e+00 -7.86636352e-01 -7.86636352e-01
 -7.86636352e-01  2.59247061e+00  2.59247061e+00  2.59247061e+00
  2.72349515e+00  1.95220080e+01  1.95220080e+01  1.95220080e+01
  4.52560707e+01  3.34356093e+02  2.02184499e+03  7.30805105e+03]
E1 = -182.4451153211674  E_coul = 54.24650137682567
cycle= 5 E= -128.198613944342  delta_E= -3.64e-10  |g|= 1.57e-06  |ddm|= 2.9e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4451153211674  E_coul = 54.24650137682567
  HOMO = -0.786636286013501  LUMO = 2.59247068223423
  mo_energy =
[-3.27169090e+01 -1.89923840e+00 -7.86636286e-01 -7.86636286e-01
 -7.86636286e-01  2.59247068e+00  2.59247068e+00  2.59247068e+00
  2.72349488e+00  1.95220080e+01  1.95220080e+01  1.95220080e+01
  4.52560707e+01  3.34356093e+02  2.02184499e+03  7.30805105e+03]
E1 = -182.44511525734418  E_coul = 54.246501313002035
Extra cycle  E= -128.198613944342  delta_E= -4.26e-13  |g|= 2.88e-07  |ddm|= 9.11e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14591940e+03 2.26992488e+02 1.42255143e+03 5.74451188e-01
 4.99516870e+01 1.32468990e+01 1.92514090e+00 2.74632118e+00
 1.31505880e+01 5.95612140e-01]
E = -128.19861394434216
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2145.91940424        1
[INPUT] 0    0    [1    /1   ]  226.992487667        1
[INPUT] 0    0    [1    /1   ]  1422.55143121        1
[INPUT] 0    0    [1    /1   ]  0.574451187942       1
[INPUT] 0    0    [1    /1   ]  49.9516869791        1
[INPUT] 0    0    [1    /1   ]  13.246899028         1
[INPUT] 0    0    [1    /1   ]  1.92514089766        1
[INPUT] 1    0    [1    /1   ]  2.74632117861        1
[INPUT] 1    0    [1    /1   ]  13.1505879852        1
[INPUT] 1    0    [1    /1   ]  0.595612140347       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2145.9194042415024, 1.0]], [0, [226.99248766742843, 1.0]], [0, [1422.5514312053003, 1.0]], [0, [0.5744511879417797, 1.0]], [0, [49.9516869791271, 1.0]], [0, [13.24689902804217, 1.0]], [0, [1.9251408976596993, 1.0]], [1, [2.7463211786081323, 1.0]], [1, [13.150587985193738, 1.0]], [1, [0.5956121403470214, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2145.91940424]
bas 1, expnt(s) = [226.99248767]
bas 2, expnt(s) = [1422.55143121]
bas 3, expnt(s) = [0.57445119]
bas 4, expnt(s) = [49.95168698]
bas 5, expnt(s) = [13.24689903]
bas 6, expnt(s) = [1.9251409]
bas 7, expnt(s) = [2.74632118]
bas 8, expnt(s) = [13.15058799]
bas 9, expnt(s) = [0.59561214]
CPU time:       215.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14591940e+03 7.96572078e+02 2.26992488e+02 1.47748690e+02
 1.42255143e+03 5.85215751e+02 5.74451188e-01 1.66707398e+00
 4.99516870e+01 4.74709195e+01 1.32468990e+01 1.75428720e+01
 1.92514090e+00 4.12916193e+00 2.74632118e+00 1.03139151e+01
 1.31505880e+01 7.30576766e+01 5.95612140e-01 1.52647192e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966628772261785
cond(S) = 157.34327143029583
E1 = -183.13679393961223  E_coul = 55.01070704543519
init E= -128.126086894177
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742882278845339  LUMO = 2.62696093513282
  mo_energy =
[-3.25142447e+01 -1.85366243e+00 -7.42882279e-01 -7.42882279e-01
 -7.42882279e-01  2.62696094e+00  2.62696094e+00  2.62696094e+00
  2.75891459e+00  1.96588688e+01  1.96588688e+01  1.96588688e+01
  4.54291204e+01  3.34588650e+02  2.02212043e+03  7.30834921e+03]
E1 = -182.10591340676447  E_coul = 53.909321283725205
cycle= 1 E= -128.196592123039  delta_E= -0.0705  |g|= 0.168  |ddm|= 0.183
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.265058
diis-c [-0.07025588  1.        ]
  HOMO = -0.809736738116895  LUMO = 2.57172246467206
  mo_energy =
[-3.27927016e+01 -1.92313680e+00 -8.09736738e-01 -8.09736738e-01
 -8.09736738e-01  2.57172246e+00  2.57172246e+00  2.57172246e+00
  2.70309067e+00  1.94653353e+01  1.94653353e+01  1.94653353e+01
  4.51890095e+01  3.34272984e+02  2.02175625e+03  7.30796074e+03]
E1 = -182.57979218415971  E_coul = 54.38149941421825
cycle= 2 E= -128.198292769941  delta_E= -0.0017  |g|= 0.064  |ddm|= 0.0659
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104447
diis-c [-4.08583647e-04  2.79399662e-01  7.20600338e-01]
  HOMO = -0.786442712426022  LUMO = 2.59260951287148
  mo_energy =
[-3.27163511e+01 -1.89895450e+00 -7.86442712e-01 -7.86442712e-01
 -7.86442712e-01  2.59260951e+00  2.59260951e+00  2.59260951e+00
  2.72371672e+00  1.95224421e+01  1.95224421e+01  1.95224421e+01
  4.52566045e+01  3.34356466e+02  2.02184521e+03  7.30805122e+03]
E1 = -182.44401802918932  E_coul = 54.24540411567325
cycle= 3 E= -128.198613913516  delta_E= -0.000321  |g|= 0.000662  |ddm|= 0.0187
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000802127
diis-c [-9.20086990e-08 -3.99062413e-03 -3.13058120e-03  1.00712121e+00]
  HOMO = -0.786652058340841  LUMO = 2.59245717612377
  mo_energy =
[-3.27169495e+01 -1.89924038e+00 -7.86652058e-01 -7.86652058e-01
 -7.86652058e-01  2.59245718e+00  2.59245718e+00  2.59245718e+00
  2.72349407e+00  1.95219769e+01  1.95219769e+01  1.95219769e+01
  4.52560380e+01  3.34356037e+02  2.02184492e+03  7.30805097e+03]
E1 = -182.44518338217725  E_coul = 54.24656943819912
cycle= 4 E= -128.198613943978  delta_E= -3.05e-08  |g|= 5.6e-05  |ddm|= 0.000261
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.8541e-05
diis-c [-2.34784986e-10  5.12138999e-04 -7.22685989e-04 -1.73730985e-01
  1.17394153e+00]
  HOMO = -0.786636351646607  LUMO = 2.59247060677491
  mo_energy =
[-3.27169091e+01 -1.89923807e+00 -7.86636352e-01 -7.86636352e-01
 -7.86636352e-01  2.59247061e+00  2.59247061e+00  2.59247061e+00
  2.72349515e+00  1.95220080e+01  1.95220080e+01  1.95220080e+01
  4.52560707e+01  3.34356093e+02  2.02184499e+03  7.30805105e+03]
E1 = -182.4451153211674  E_coul = 54.24650137682567
cycle= 5 E= -128.198613944342  delta_E= -3.64e-10  |g|= 1.57e-06  |ddm|= 2.9e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4451153211674  E_coul = 54.24650137682567
  HOMO = -0.786636286013501  LUMO = 2.59247068223423
  mo_energy =
[-3.27169090e+01 -1.89923840e+00 -7.86636286e-01 -7.86636286e-01
 -7.86636286e-01  2.59247068e+00  2.59247068e+00  2.59247068e+00
  2.72349488e+00  1.95220080e+01  1.95220080e+01  1.95220080e+01
  4.52560707e+01  3.34356093e+02  2.02184499e+03  7.30805105e+03]
E1 = -182.44511525734418  E_coul = 54.246501313002035
Extra cycle  E= -128.198613944342  delta_E= -4.26e-13  |g|= 2.88e-07  |ddm|= 9.11e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 157.34327143029583
E1 = -182.44511525734418  E_coul = 54.246501313002035
init E= -128.198613944342
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786636275067664  LUMO = 2.59247069039623
  mo_energy =
[-3.27169090e+01 -1.89923846e+00 -7.86636275e-01 -7.86636275e-01
 -7.86636275e-01  2.59247069e+00  2.59247069e+00  2.59247069e+00
  2.72349482e+00  1.95220080e+01  1.95220080e+01  1.95220080e+01
  4.52560707e+01  3.34356093e+02  2.02184499e+03  7.30805105e+03]
E1 = -182.445115287976  E_coul = 54.246501343633895
cycle= 1 E= -128.198613944342  delta_E= 5.68e-14  |g|= 5.24e-08  |ddm|= 1.65e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.445115287976  E_coul = 54.246501343633895
  HOMO = -0.786636270043101  LUMO = 2.59247069462007
  mo_energy =
[-3.27169090e+01 -1.89923847e+00 -7.86636270e-01 -7.86636270e-01
 -7.86636270e-01  2.59247069e+00  2.59247069e+00  2.59247069e+00
  2.72349481e+00  1.95220080e+01  1.95220080e+01  1.95220080e+01
  4.52560707e+01  3.34356093e+02  2.02184499e+03  7.30805105e+03]
E1 = -182.4451152774361  E_coul = 54.24650133309402
Extra cycle  E= -128.198613944342  delta_E= 2.84e-14  |g|= 9.79e-09  |ddm|= 2.91e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14591940e+03 2.26992488e+02 1.42255143e+03 5.74451188e-01
 4.99516870e+01 1.32468990e+01 1.92514090e+00 2.74632118e+00
 1.31505880e+01 5.95612140e-01]
grad_E = [-1.00816941e-05  6.03429203e-06  3.41791946e-05 -4.12553799e-04
  2.88245876e-05 -3.17949903e-04  1.05468886e-04 -2.65885078e-03
 -3.63309482e-04 -7.32503808e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2147.00156357        1
[INPUT] 0    0    [1    /1   ]  226.709453236        1
[INPUT] 0    0    [1    /1   ]  1418.84336744        1
[INPUT] 0    0    [1    /1   ]  0.573762326405       1
[INPUT] 0    0    [1    /1   ]  49.8990599266        1
[INPUT] 0    0    [1    /1   ]  13.2348493544        1
[INPUT] 0    0    [1    /1   ]  1.92277116327        1
[INPUT] 1    0    [1    /1   ]  2.73420131199        1
[INPUT] 1    0    [1    /1   ]  13.0810833284        1
[INPUT] 1    0    [1    /1   ]  0.59366676956        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2147.0015635728637, 1.0]], [0, [226.70945323648095, 1.0]], [0, [1418.8433674441844, 1.0]], [0, [0.5737623264048707, 1.0]], [0, [49.89905992659456, 1.0]], [0, [13.234849354354253, 1.0]], [0, [1.922771163268812, 1.0]], [1, [2.734201311994109, 1.0]], [1, [13.08108332837453, 1.0]], [1, [0.5936667695598109, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2147.00156357]
bas 1, expnt(s) = [226.70945324]
bas 2, expnt(s) = [1418.84336744]
bas 3, expnt(s) = [0.57376233]
bas 4, expnt(s) = [49.89905993]
bas 5, expnt(s) = [13.23484935]
bas 6, expnt(s) = [1.92277116]
bas 7, expnt(s) = [2.73420131]
bas 8, expnt(s) = [13.08108333]
bas 9, expnt(s) = [0.59366677]
CPU time:       217.78
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14700156e+03 7.96873335e+02 2.26709453e+02 1.47610498e+02
 1.41884337e+03 5.84071298e+02 5.73762326e-01 1.66557443e+00
 4.98990599e+01 4.74334045e+01 1.32348494e+01 1.75309026e+01
 1.92277116e+00 4.12534928e+00 2.73420131e+00 1.02570507e+01
 1.30810833e+01 7.25753323e+01 5.93666770e-01 1.52024232e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967032455639968
cond(S) = 155.18805492498996
E1 = -183.1367418598569  E_coul = 55.01035023562637
init E= -128.126391624231
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742871709515706  LUMO = 2.61487867667392
  mo_energy =
[-3.25145102e+01 -1.85367930e+00 -7.42871710e-01 -7.42871710e-01
 -7.42871710e-01  2.61487868e+00  2.61487868e+00  2.61487868e+00
  2.75326991e+00  1.95428707e+01  1.95428707e+01  1.95428707e+01
  4.53593845e+01  3.34121741e+02  2.01910884e+03  7.30065880e+03]
E1 = -182.09416593549975  E_coul = 53.89754458437385
cycle= 1 E= -128.196621351126  delta_E= -0.0702  |g|= 0.169  |ddm|= 0.183
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.267115
diis-c [-0.07135036  1.        ]
  HOMO = -0.810561598535809  LUMO = 2.55912326879956
  mo_energy =
[-3.27951797e+01 -1.92411398e+00 -8.10561599e-01 -8.10561599e-01
 -8.10561599e-01  2.55912327e+00  2.55912327e+00  2.55912327e+00
  2.69669416e+00  1.93480362e+01  1.93480362e+01  1.93480362e+01
  4.51173430e+01  3.33803790e+02  2.01874231e+03  7.30026795e+03]
E1 = -182.57309122318813  E_coul = 54.37473893364461
cycle= 2 E= -128.198352289544  delta_E= -0.00173  |g|= 0.0647  |ddm|= 0.0666
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105576
diis-c [-4.10269479e-04  2.80070753e-01  7.19929247e-01]
  HOMO = -0.787033107774944  LUMO = 2.58013667031081
  mo_energy =
[-3.27181272e+01 -1.89968422e+00 -7.87033108e-01 -7.87033108e-01
 -7.87033108e-01  2.58013667e+00  2.58013667e+00  2.58013667e+00
  2.71750060e+00  1.94055747e+01  1.94055747e+01  1.94055747e+01
  4.51855485e+01  3.33888014e+02  2.01883205e+03  7.30035922e+03]
E1 = -182.43575679585038  E_coul = 54.2370762236653
cycle= 3 E= -128.198680572185  delta_E= -0.000328  |g|= 0.000652  |ddm|= 0.0189
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00077363
diis-c [-9.93977315e-08 -4.03642699e-03 -3.67218525e-03  1.00770861e+00]
  HOMO = -0.787234018646004  LUMO = 2.5799930700287
  mo_energy =
[-3.27187017e+01 -1.89996461e+00 -7.87234019e-01 -7.87234019e-01
 -7.87234019e-01  2.57999307e+00  2.57999307e+00  2.57999307e+00
  2.71728337e+00  1.94051293e+01  1.94051293e+01  1.94051293e+01
  4.51850030e+01  3.33887613e+02  2.01883180e+03  7.30035901e+03]
E1 = -182.4368801220871  E_coul = 54.23819952025859
cycle= 4 E= -128.198680601829  delta_E= -2.96e-08  |g|= 5.83e-05  |ddm|= 0.000262
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.19227e-05
diis-c [-2.45881013e-10  5.15210499e-04 -6.69353271e-04 -1.75159046e-01
  1.17531319e+00]
  HOMO = -0.787217780818822  LUMO = 2.58000688476742
  mo_energy =
[-3.27186600e+01 -1.89996241e+00 -7.87217781e-01 -7.87217781e-01
 -7.87217781e-01  2.58000688e+00  2.58000688e+00  2.58000688e+00
  2.71728431e+00  1.94051613e+01  1.94051613e+01  1.94051613e+01
  4.51850366e+01  3.33887671e+02  2.01883187e+03  7.30035909e+03]
E1 = -182.43680973143137  E_coul = 54.23812912920693
cycle= 5 E= -128.198680602224  delta_E= -3.96e-10  |g|= 1.59e-06  |ddm|= 3.04e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.43680973143137  E_coul = 54.23812912920693
  HOMO = -0.787217710924654  LUMO = 2.58000696475095
  mo_energy =
[-3.27186599e+01 -1.89996274e+00 -7.87217711e-01 -7.87217711e-01
 -7.87217711e-01  2.58000696e+00  2.58000696e+00  2.58000696e+00
  2.71728404e+00  1.94051614e+01  1.94051614e+01  1.94051614e+01
  4.51850366e+01  3.33887671e+02  2.01883187e+03  7.30035909e+03]
E1 = -182.43680963724483  E_coul = 54.23812903502013
Extra cycle  E= -128.198680602225  delta_E= -2.56e-13  |g|= 2.92e-07  |ddm|= 9.2e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.14700156e+03 2.26709453e+02 1.41884337e+03 5.73762326e-01
 4.98990599e+01 1.32348494e+01 1.92277116e+00 2.73420131e+00
 1.30810833e+01 5.93666770e-01]
E = -128.1986806022247
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2147.00156357        1
[INPUT] 0    0    [1    /1   ]  226.709453236        1
[INPUT] 0    0    [1    /1   ]  1418.84336744        1
[INPUT] 0    0    [1    /1   ]  0.573762326405       1
[INPUT] 0    0    [1    /1   ]  49.8990599266        1
[INPUT] 0    0    [1    /1   ]  13.2348493544        1
[INPUT] 0    0    [1    /1   ]  1.92277116327        1
[INPUT] 1    0    [1    /1   ]  2.73420131199        1
[INPUT] 1    0    [1    /1   ]  13.0810833284        1
[INPUT] 1    0    [1    /1   ]  0.59366676956        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2147.0015635728637, 1.0]], [0, [226.70945323648095, 1.0]], [0, [1418.8433674441844, 1.0]], [0, [0.5737623264048707, 1.0]], [0, [49.89905992659456, 1.0]], [0, [13.234849354354253, 1.0]], [0, [1.922771163268812, 1.0]], [1, [2.734201311994109, 1.0]], [1, [13.08108332837453, 1.0]], [1, [0.5936667695598109, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2147.00156357]
bas 1, expnt(s) = [226.70945324]
bas 2, expnt(s) = [1418.84336744]
bas 3, expnt(s) = [0.57376233]
bas 4, expnt(s) = [49.89905993]
bas 5, expnt(s) = [13.23484935]
bas 6, expnt(s) = [1.92277116]
bas 7, expnt(s) = [2.73420131]
bas 8, expnt(s) = [13.08108333]
bas 9, expnt(s) = [0.59366677]
CPU time:       218.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14700156e+03 7.96873335e+02 2.26709453e+02 1.47610498e+02
 1.41884337e+03 5.84071298e+02 5.73762326e-01 1.66557443e+00
 4.98990599e+01 4.74334045e+01 1.32348494e+01 1.75309026e+01
 1.92277116e+00 4.12534928e+00 2.73420131e+00 1.02570507e+01
 1.30810833e+01 7.25753323e+01 5.93666770e-01 1.52024232e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967032455639968
cond(S) = 155.18805492498996
E1 = -183.1367418598569  E_coul = 55.01035023562637
init E= -128.126391624231
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742871709515706  LUMO = 2.61487867667392
  mo_energy =
[-3.25145102e+01 -1.85367930e+00 -7.42871710e-01 -7.42871710e-01
 -7.42871710e-01  2.61487868e+00  2.61487868e+00  2.61487868e+00
  2.75326991e+00  1.95428707e+01  1.95428707e+01  1.95428707e+01
  4.53593845e+01  3.34121741e+02  2.01910884e+03  7.30065880e+03]
E1 = -182.09416593549975  E_coul = 53.89754458437385
cycle= 1 E= -128.196621351126  delta_E= -0.0702  |g|= 0.169  |ddm|= 0.183
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.267115
diis-c [-0.07135036  1.        ]
  HOMO = -0.810561598535809  LUMO = 2.55912326879956
  mo_energy =
[-3.27951797e+01 -1.92411398e+00 -8.10561599e-01 -8.10561599e-01
 -8.10561599e-01  2.55912327e+00  2.55912327e+00  2.55912327e+00
  2.69669416e+00  1.93480362e+01  1.93480362e+01  1.93480362e+01
  4.51173430e+01  3.33803790e+02  2.01874231e+03  7.30026795e+03]
E1 = -182.57309122318813  E_coul = 54.37473893364461
cycle= 2 E= -128.198352289544  delta_E= -0.00173  |g|= 0.0647  |ddm|= 0.0666
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105576
diis-c [-4.10269479e-04  2.80070753e-01  7.19929247e-01]
  HOMO = -0.787033107774944  LUMO = 2.58013667031081
  mo_energy =
[-3.27181272e+01 -1.89968422e+00 -7.87033108e-01 -7.87033108e-01
 -7.87033108e-01  2.58013667e+00  2.58013667e+00  2.58013667e+00
  2.71750060e+00  1.94055747e+01  1.94055747e+01  1.94055747e+01
  4.51855485e+01  3.33888014e+02  2.01883205e+03  7.30035922e+03]
E1 = -182.43575679585038  E_coul = 54.2370762236653
cycle= 3 E= -128.198680572185  delta_E= -0.000328  |g|= 0.000652  |ddm|= 0.0189
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00077363
diis-c [-9.93977315e-08 -4.03642699e-03 -3.67218525e-03  1.00770861e+00]
  HOMO = -0.787234018646004  LUMO = 2.5799930700287
  mo_energy =
[-3.27187017e+01 -1.89996461e+00 -7.87234019e-01 -7.87234019e-01
 -7.87234019e-01  2.57999307e+00  2.57999307e+00  2.57999307e+00
  2.71728337e+00  1.94051293e+01  1.94051293e+01  1.94051293e+01
  4.51850030e+01  3.33887613e+02  2.01883180e+03  7.30035901e+03]
E1 = -182.4368801220871  E_coul = 54.23819952025859
cycle= 4 E= -128.198680601829  delta_E= -2.96e-08  |g|= 5.83e-05  |ddm|= 0.000262
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.19227e-05
diis-c [-2.45881013e-10  5.15210499e-04 -6.69353271e-04 -1.75159046e-01
  1.17531319e+00]
  HOMO = -0.787217780818822  LUMO = 2.58000688476742
  mo_energy =
[-3.27186600e+01 -1.89996241e+00 -7.87217781e-01 -7.87217781e-01
 -7.87217781e-01  2.58000688e+00  2.58000688e+00  2.58000688e+00
  2.71728431e+00  1.94051613e+01  1.94051613e+01  1.94051613e+01
  4.51850366e+01  3.33887671e+02  2.01883187e+03  7.30035909e+03]
E1 = -182.43680973143137  E_coul = 54.23812912920693
cycle= 5 E= -128.198680602224  delta_E= -3.96e-10  |g|= 1.59e-06  |ddm|= 3.04e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.43680973143137  E_coul = 54.23812912920693
  HOMO = -0.787217710924654  LUMO = 2.58000696475095
  mo_energy =
[-3.27186599e+01 -1.89996274e+00 -7.87217711e-01 -7.87217711e-01
 -7.87217711e-01  2.58000696e+00  2.58000696e+00  2.58000696e+00
  2.71728404e+00  1.94051614e+01  1.94051614e+01  1.94051614e+01
  4.51850366e+01  3.33887671e+02  2.01883187e+03  7.30035909e+03]
E1 = -182.43680963724483  E_coul = 54.23812903502013
Extra cycle  E= -128.198680602225  delta_E= -2.56e-13  |g|= 2.92e-07  |ddm|= 9.2e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 155.18805492498996
E1 = -182.43680963724483  E_coul = 54.23812903502013
init E= -128.198680602225
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787217701954333  LUMO = 2.58000697107281
  mo_energy =
[-3.27186599e+01 -1.89996280e+00 -7.87217702e-01 -7.87217702e-01
 -7.87217702e-01  2.58000697e+00  2.58000697e+00  2.58000697e+00
  2.71728398e+00  1.94051613e+01  1.94051613e+01  1.94051613e+01
  4.51850366e+01  3.33887671e+02  2.01883187e+03  7.30035909e+03]
E1 = -182.43680967930004  E_coul = 54.2381290770753
cycle= 1 E= -128.198680602225  delta_E= -2.84e-14  |g|= 5.3e-08  |ddm|= 1.68e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.43680967930004  E_coul = 54.2381290770753
  HOMO = -0.787217696121717  LUMO = 2.58000697599375
  mo_energy =
[-3.27186599e+01 -1.89996281e+00 -7.87217696e-01 -7.87217696e-01
 -7.87217696e-01  2.58000698e+00  2.58000698e+00  2.58000698e+00
  2.71728397e+00  1.94051614e+01  1.94051614e+01  1.94051614e+01
  4.51850366e+01  3.33887671e+02  2.01883187e+03  7.30035909e+03]
E1 = -182.4368096640742  E_coul = 54.23812906184931
Extra cycle  E= -128.198680602225  delta_E= -1.71e-13  |g|= 1.01e-08  |ddm|= 2.93e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.14700156e+03 2.26709453e+02 1.41884337e+03 5.73762326e-01
 4.98990599e+01 1.32348494e+01 1.92277116e+00 2.73420131e+00
 1.30810833e+01 5.93666770e-01]
grad_E = [-1.02078013e-05  5.62799490e-06  3.44826283e-05 -5.73018769e-04
  3.97204290e-05 -4.42189584e-04  1.46163047e-04 -3.69872622e-03
 -5.07262846e-04 -1.01467339e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2148.91228459        1
[INPUT] 0    0    [1    /1   ]  226.254762086        1
[INPUT] 0    0    [1    /1   ]  1412.29240569        1
[INPUT] 0    0    [1    /1   ]  0.572793509794       1
[INPUT] 0    0    [1    /1   ]  49.8191076407        1
[INPUT] 0    0    [1    /1   ]  13.2172965764        1
[INPUT] 0    0    [1    /1   ]  1.91945311067        1
[INPUT] 1    0    [1    /1   ]  2.71812185182        1
[INPUT] 1    0    [1    /1   ]  12.9893143973        1
[INPUT] 1    0    [1    /1   ]  0.591076639109       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2148.9122845927905, 1.0]], [0, [226.25476208611965, 1.0]], [0, [1412.2924056927084, 1.0]], [0, [0.5727935097939596, 1.0]], [0, [49.81910764069201, 1.0]], [0, [13.21729657640985, 1.0]], [0, [1.9194531106682673, 1.0]], [1, [2.718121851816674, 1.0]], [1, [12.989314397324305, 1.0]], [1, [0.5910766391090111, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2148.91228459]
bas 1, expnt(s) = [226.25476209]
bas 2, expnt(s) = [1412.29240569]
bas 3, expnt(s) = [0.57279351]
bas 4, expnt(s) = [49.81910764]
bas 5, expnt(s) = [13.21729658]
bas 6, expnt(s) = [1.91945311]
bas 7, expnt(s) = [2.71812185]
bas 8, expnt(s) = [12.9893144]
bas 9, expnt(s) = [0.59107664]
CPU time:       221.56
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14891228e+03 7.97405158e+02 2.26254762e+02 1.47388406e+02
 1.41229241e+03 5.82047586e+02 5.72793510e-01 1.66346471e+00
 4.98191076e+01 4.73763919e+01 1.32172966e+01 1.75134618e+01
 1.91945311e+00 4.12000891e+00 2.71812185e+00 1.01817058e+01
 1.29893144e+01 7.19394608e+01 5.91076639e-01 1.51195594e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96756534336891
cond(S) = 151.51863658945138
E1 = -183.13668066262167  E_coul = 55.009847285059784
init E= -128.126833377562
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742853619235263  LUMO = 2.59883907327817
  mo_energy =
[-3.25148983e+01 -1.85370698e+00 -7.42853619e-01 -7.42853619e-01
 -7.42853619e-01  2.59883907e+00  2.59883907e+00  2.59883907e+00
  2.74534119e+00  1.93896602e+01  1.93896602e+01  1.93896602e+01
  4.52567595e+01  3.33391089e+02  2.01396851e+03  7.28726239e+03]
E1 = -182.078484339968  E_coul = 53.88179864352466
cycle= 1 E= -128.196685696443  delta_E= -0.0699  |g|= 0.171  |ddm|= 0.184
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269865
diis-c [-0.07282709  1.        ]
  HOMO = -0.811657867399222  LUMO = 2.54240098440018
  mo_energy =
[-3.27985245e+01 -1.92542191e+00 -8.11657867e-01 -8.11657867e-01
 -8.11657867e-01  2.54240098e+00  2.54240098e+00  2.54240098e+00
  2.68777495e+00  1.91930943e+01  1.91930943e+01  1.91930943e+01
  4.50121538e+01  3.33070095e+02  2.01359885e+03  7.28686836e+03]
E1 = -182.56417579622263  E_coul = 54.36571824142408
cycle= 2 E= -128.198457554799  delta_E= -0.00177  |g|= 0.0656  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.107091
diis-c [-4.12264132e-04  2.80958820e-01  7.19041180e-01]
  HOMO = -0.787815197165302  LUMO = 2.5635819628782
  mo_energy =
[-3.27205327e+01 -1.90066044e+00 -7.87815197e-01 -7.87815197e-01
 -7.87815197e-01  2.56358196e+00  2.56358196e+00  2.56358196e+00
  2.70882012e+00  1.92512086e+01  1.92512086e+01  1.92512086e+01
  4.50811729e+01  3.33155311e+02  2.01368964e+03  7.28696070e+03]
E1 = -182.42474710563505  E_coul = 54.22595157192977
cycle= 3 E= -128.198795533705  delta_E= -0.000338  |g|= 0.000639  |ddm|= 0.0191
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000737102
diis-c [-1.09693828e-07 -4.10055902e-03 -4.39524502e-03  1.00849580e+00]
  HOMO = -0.788004681564164  LUMO = 2.56345008937624
  mo_energy =
[-3.27210747e+01 -1.90093331e+00 -7.88004682e-01 -7.88004682e-01
 -7.88004682e-01  2.56345009e+00  2.56345009e+00  2.56345009e+00
  2.70861031e+00  1.92507899e+01  1.92507899e+01  1.92507899e+01
  4.50806557e+01  3.33154947e+02  2.01368943e+03  7.28696053e+03]
E1 = -182.4258130853385  E_coul = 54.22701752294304
cycle= 4 E= -128.198795562395  delta_E= -2.87e-08  |g|= 6.14e-05  |ddm|= 0.000264
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.64017e-05
diis-c [-2.61442006e-10  5.18725383e-04 -5.96400026e-04 -1.76837611e-01
  1.17691529e+00]
  HOMO = -0.787987744112196  LUMO = 2.56346440133804
  mo_energy =
[-3.27210313e+01 -1.90093126e+00 -7.87987744e-01 -7.87987744e-01
 -7.87987744e-01  2.56346440e+00  2.56346440e+00  2.56346440e+00
  2.70861105e+00  1.92508231e+01  1.92508231e+01  1.92508231e+01
  4.50806907e+01  3.33155008e+02  2.01368951e+03  7.28696062e+03]
E1 = -182.42573961471828  E_coul = 54.22694405188222
cycle= 5 E= -128.198795562836  delta_E= -4.41e-10  |g|= 1.61e-06  |ddm|= 3.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.42573961471828  E_coul = 54.22694405188222
  HOMO = -0.787987667324724  LUMO = 2.56346448841494
  mo_energy =
[-3.27210312e+01 -1.90093158e+00 -7.87987667e-01 -7.87987667e-01
 -7.87987667e-01  2.56346449e+00  2.56346449e+00  2.56346449e+00
  2.70861078e+00  1.92508232e+01  1.92508232e+01  1.92508232e+01
  4.50806907e+01  3.33155008e+02  2.01368951e+03  7.28696062e+03]
E1 = -182.4257394734363  E_coul = 54.226943910599786
Extra cycle  E= -128.198795562836  delta_E= -4.26e-13  |g|= 2.97e-07  |ddm|= 9.32e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14891228e+03 2.26254762e+02 1.41229241e+03 5.72793510e-01
 4.98191076e+01 1.32172966e+01 1.91945311e+00 2.71812185e+00
 1.29893144e+01 5.91076639e-01]
E = -128.1987955628365
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2148.91228459        1
[INPUT] 0    0    [1    /1   ]  226.254762086        1
[INPUT] 0    0    [1    /1   ]  1412.29240569        1
[INPUT] 0    0    [1    /1   ]  0.572793509794       1
[INPUT] 0    0    [1    /1   ]  49.8191076407        1
[INPUT] 0    0    [1    /1   ]  13.2172965764        1
[INPUT] 0    0    [1    /1   ]  1.91945311067        1
[INPUT] 1    0    [1    /1   ]  2.71812185182        1
[INPUT] 1    0    [1    /1   ]  12.9893143973        1
[INPUT] 1    0    [1    /1   ]  0.591076639109       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2148.9122845927905, 1.0]], [0, [226.25476208611965, 1.0]], [0, [1412.2924056927084, 1.0]], [0, [0.5727935097939596, 1.0]], [0, [49.81910764069201, 1.0]], [0, [13.21729657640985, 1.0]], [0, [1.9194531106682673, 1.0]], [1, [2.718121851816674, 1.0]], [1, [12.989314397324305, 1.0]], [1, [0.5910766391090111, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2148.91228459]
bas 1, expnt(s) = [226.25476209]
bas 2, expnt(s) = [1412.29240569]
bas 3, expnt(s) = [0.57279351]
bas 4, expnt(s) = [49.81910764]
bas 5, expnt(s) = [13.21729658]
bas 6, expnt(s) = [1.91945311]
bas 7, expnt(s) = [2.71812185]
bas 8, expnt(s) = [12.9893144]
bas 9, expnt(s) = [0.59107664]
CPU time:       222.56
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.14891228e+03 7.97405158e+02 2.26254762e+02 1.47388406e+02
 1.41229241e+03 5.82047586e+02 5.72793510e-01 1.66346471e+00
 4.98191076e+01 4.73763919e+01 1.32172966e+01 1.75134618e+01
 1.91945311e+00 4.12000891e+00 2.71812185e+00 1.01817058e+01
 1.29893144e+01 7.19394608e+01 5.91076639e-01 1.51195594e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96756534336891
cond(S) = 151.51863658945138
E1 = -183.13668066262167  E_coul = 55.009847285059784
init E= -128.126833377562
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742853619235263  LUMO = 2.59883907327817
  mo_energy =
[-3.25148983e+01 -1.85370698e+00 -7.42853619e-01 -7.42853619e-01
 -7.42853619e-01  2.59883907e+00  2.59883907e+00  2.59883907e+00
  2.74534119e+00  1.93896602e+01  1.93896602e+01  1.93896602e+01
  4.52567595e+01  3.33391089e+02  2.01396851e+03  7.28726239e+03]
E1 = -182.078484339968  E_coul = 53.88179864352466
cycle= 1 E= -128.196685696443  delta_E= -0.0699  |g|= 0.171  |ddm|= 0.184
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269865
diis-c [-0.07282709  1.        ]
  HOMO = -0.811657867399222  LUMO = 2.54240098440018
  mo_energy =
[-3.27985245e+01 -1.92542191e+00 -8.11657867e-01 -8.11657867e-01
 -8.11657867e-01  2.54240098e+00  2.54240098e+00  2.54240098e+00
  2.68777495e+00  1.91930943e+01  1.91930943e+01  1.91930943e+01
  4.50121538e+01  3.33070095e+02  2.01359885e+03  7.28686836e+03]
E1 = -182.56417579622263  E_coul = 54.36571824142408
cycle= 2 E= -128.198457554799  delta_E= -0.00177  |g|= 0.0656  |ddm|= 0.0675
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.107091
diis-c [-4.12264132e-04  2.80958820e-01  7.19041180e-01]
  HOMO = -0.787815197165302  LUMO = 2.5635819628782
  mo_energy =
[-3.27205327e+01 -1.90066044e+00 -7.87815197e-01 -7.87815197e-01
 -7.87815197e-01  2.56358196e+00  2.56358196e+00  2.56358196e+00
  2.70882012e+00  1.92512086e+01  1.92512086e+01  1.92512086e+01
  4.50811729e+01  3.33155311e+02  2.01368964e+03  7.28696070e+03]
E1 = -182.42474710563505  E_coul = 54.22595157192977
cycle= 3 E= -128.198795533705  delta_E= -0.000338  |g|= 0.000639  |ddm|= 0.0191
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000737102
diis-c [-1.09693828e-07 -4.10055902e-03 -4.39524502e-03  1.00849580e+00]
  HOMO = -0.788004681564164  LUMO = 2.56345008937624
  mo_energy =
[-3.27210747e+01 -1.90093331e+00 -7.88004682e-01 -7.88004682e-01
 -7.88004682e-01  2.56345009e+00  2.56345009e+00  2.56345009e+00
  2.70861031e+00  1.92507899e+01  1.92507899e+01  1.92507899e+01
  4.50806557e+01  3.33154947e+02  2.01368943e+03  7.28696053e+03]
E1 = -182.4258130853385  E_coul = 54.22701752294304
cycle= 4 E= -128.198795562395  delta_E= -2.87e-08  |g|= 6.14e-05  |ddm|= 0.000264
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=9.64017e-05
diis-c [-2.61442006e-10  5.18725383e-04 -5.96400026e-04 -1.76837611e-01
  1.17691529e+00]
  HOMO = -0.787987744112196  LUMO = 2.56346440133804
  mo_energy =
[-3.27210313e+01 -1.90093126e+00 -7.87987744e-01 -7.87987744e-01
 -7.87987744e-01  2.56346440e+00  2.56346440e+00  2.56346440e+00
  2.70861105e+00  1.92508231e+01  1.92508231e+01  1.92508231e+01
  4.50806907e+01  3.33155008e+02  2.01368951e+03  7.28696062e+03]
E1 = -182.42573961471828  E_coul = 54.22694405188222
cycle= 5 E= -128.198795562836  delta_E= -4.41e-10  |g|= 1.61e-06  |ddm|= 3.23e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.42573961471828  E_coul = 54.22694405188222
  HOMO = -0.787987667324724  LUMO = 2.56346448841494
  mo_energy =
[-3.27210312e+01 -1.90093158e+00 -7.87987667e-01 -7.87987667e-01
 -7.87987667e-01  2.56346449e+00  2.56346449e+00  2.56346449e+00
  2.70861078e+00  1.92508232e+01  1.92508232e+01  1.92508232e+01
  4.50806907e+01  3.33155008e+02  2.01368951e+03  7.28696062e+03]
E1 = -182.4257394734363  E_coul = 54.226943910599786
Extra cycle  E= -128.198795562836  delta_E= -4.26e-13  |g|= 2.97e-07  |ddm|= 9.32e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 151.51863658945138
E1 = -182.4257394734363  E_coul = 54.226943910599786
init E= -128.198795562836
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.78798766142259  LUMO = 2.56346449191646
  mo_energy =
[-3.27210312e+01 -1.90093165e+00 -7.87987661e-01 -7.87987661e-01
 -7.87987661e-01  2.56346449e+00  2.56346449e+00  2.56346449e+00
  2.70861072e+00  1.92508232e+01  1.92508232e+01  1.92508232e+01
  4.50806907e+01  3.33155008e+02  2.01368951e+03  7.28696062e+03]
E1 = -182.4257395334464  E_coul = 54.22694397060991
cycle= 1 E= -128.198795562836  delta_E=    0  |g|= 5.39e-08  |ddm|= 1.72e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.4257395334464  E_coul = 54.22694397060991
  HOMO = -0.78798765432186  LUMO = 2.56346449792683
  mo_energy =
[-3.27210312e+01 -1.90093166e+00 -7.87987654e-01 -7.87987654e-01
 -7.87987654e-01  2.56346450e+00  2.56346450e+00  2.56346450e+00
  2.70861071e+00  1.92508232e+01  1.92508232e+01  1.92508232e+01
  4.50806907e+01  3.33155008e+02  2.01368951e+03  7.28696062e+03]
E1 = -182.42573951085654  E_coul = 54.22694394802017
Extra cycle  E= -128.198795562836  delta_E= 1.14e-13  |g|= 1.06e-08  |ddm|= 2.95e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.14891228e+03 2.26254762e+02 1.41229241e+03 5.72793510e-01
 4.98191076e+01 1.32172966e+01 1.91945311e+00 2.71812185e+00
 1.29893144e+01 5.91076639e-01]
grad_E = [-1.04370820e-05  5.14314981e-06  3.49905180e-05 -7.88174349e-04
  5.42472230e-05 -6.08874580e-04  2.00357715e-04 -5.09691188e-03
 -7.01005878e-04 -1.39478321e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2152.20177786        1
[INPUT] 0    0    [1    /1   ]  225.529343023        1
[INPUT] 0    0    [1    /1   ]  1401.00944387        1
[INPUT] 0    0    [1    /1   ]  0.571453624056       1
[INPUT] 0    0    [1    /1   ]  49.6983471215        1
[INPUT] 0    0    [1    /1   ]  13.1919662289        1
[INPUT] 0    0    [1    /1   ]  1.9148924005         1
[INPUT] 1    0    [1    /1   ]  2.69751034206        1
[INPUT] 1    0    [1    /1   ]  12.8724579194        1
[INPUT] 1    0    [1    /1   ]  0.587740354122       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2152.201777858408, 1.0]], [0, [225.52934302294273, 1.0]], [0, [1401.0094438667459, 1.0]], [0, [0.5714536240555887, 1.0]], [0, [49.698347121533004, 1.0]], [0, [13.191966228898554, 1.0]], [0, [1.9148924005044834, 1.0]], [1, [2.6975103420636044, 1.0]], [1, [12.872457919409708, 1.0]], [1, [0.587740354122083, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2152.20177786]
bas 1, expnt(s) = [225.52934302]
bas 2, expnt(s) = [1401.00944387]
bas 3, expnt(s) = [0.57145362]
bas 4, expnt(s) = [49.69834712]
bas 5, expnt(s) = [13.19196623]
bas 6, expnt(s) = [1.9148924]
bas 7, expnt(s) = [2.69751034]
bas 8, expnt(s) = [12.87245792]
bas 9, expnt(s) = [0.58774035]
CPU time:       225.49
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.15220178e+03 7.98320467e+02 2.25529343e+02 1.47033845e+02
 1.40100944e+03 5.78556559e+02 5.71453624e-01 1.66054545e+00
 4.96983471e+01 4.72902362e+01 1.31919662e+01 1.74882830e+01
 1.91489240e+00 4.11266472e+00 2.69751034e+00 1.00852877e+01
 1.28724579e+01 7.11313815e+01 5.87740354e-01 1.50129584e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.968244069655995
cond(S) = 145.54271058526618
E1 = -183.1366260754836  E_coul = 55.00915201755831
init E= -128.127474057925
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742823662864609  LUMO = 2.57825867585471
  mo_energy =
[-3.25154610e+01 -1.85375169e+00 -7.42823663e-01 -7.42823663e-01
 -7.42823663e-01  2.57825868e+00  2.57825868e+00  2.57825868e+00
  2.73439827e+00  1.91944418e+01  1.91944418e+01  1.91944418e+01
  4.51070287e+01  3.32254377e+02  2.00531728e+03  7.26438466e+03]
E1 = -182.05822290044824  E_coul = 53.86140221099377
cycle= 1 E= -128.196820689454  delta_E= -0.0693  |g|= 0.173  |ddm|= 0.185
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273427
diis-c [-0.07476256  1.        ]
  HOMO = -0.813066927191329  LUMO = 2.52095049359508
  mo_energy =
[-3.28029142e+01 -1.92711864e+00 -8.13066927e-01 -8.13066927e-01
 -8.13066927e-01  2.52095049e+00  2.52095049e+00  2.52095049e+00
  2.67557512e+00  1.89956463e+01  1.89956463e+01  1.89956463e+01
  4.48591325e+01  3.31929466e+02  2.00494360e+03  7.26398654e+03]
E1 = -182.5527103116113  E_coul = 54.354064048045984
cycle= 2 E= -128.198646263565  delta_E= -0.00183  |g|= 0.0667  |ddm|= 0.0687
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.109059
diis-c [-4.14364769e-04  2.82094130e-01  7.17905870e-01]
  HOMO = -0.788816138215795  LUMO = 2.54234624937953
  mo_energy =
[-3.27237044e+01 -1.90192605e+00 -7.88816138e-01 -7.88816138e-01
 -7.88816138e-01  2.54234625e+00  2.54234625e+00  2.54234625e+00
  2.69692501e+00  1.90545041e+01  1.90545041e+01  1.90545041e+01
  4.49292001e+01  3.32015964e+02  2.00503575e+03  7.26408026e+03]
E1 = -182.41055541452877  E_coul = 54.21155835445735
cycle= 3 E= -128.198997060071  delta_E= -0.000351  |g|= 0.000623  |ddm|= 0.0195
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000693104
diis-c [-1.23718294e-07 -4.18888196e-03 -5.33173436e-03  1.00952062e+00]
  HOMO = -0.78899055165881  LUMO = 2.5422296571449
  mo_energy =
[-3.27242038e+01 -1.90218888e+00 -7.88990552e-01 -7.88990552e-01
 -7.88990552e-01  2.54222966e+00  2.54222966e+00  2.54222966e+00
  2.69672508e+00  1.90541203e+01  1.90541203e+01  1.90541203e+01
  4.49287204e+01  3.32015649e+02  2.00503559e+03  7.26408015e+03]
E1 = -182.41154505261645  E_coul = 54.2125479648432
cycle= 4 E= -128.198997087773  delta_E= -2.77e-08  |g|= 6.53e-05  |ddm|= 0.000266
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000102125
diis-c [-2.82993903e-10  5.22501501e-04 -4.99443009e-04 -1.78680958e-01
  1.17865790e+00]
  HOMO = -0.788972726428723  LUMO = 2.54224458516668
  mo_energy =
[-3.27241581e+01 -1.90218704e+00 -7.88972726e-01 -7.88972726e-01
 -7.88972726e-01  2.54224459e+00  2.54224459e+00  2.54224459e+00
  2.69672555e+00  1.90541551e+01  1.90541551e+01  1.90541551e+01
  4.49287569e+01  3.32015713e+02  2.00503568e+03  7.26408024e+03]
E1 = -182.41146765871903  E_coul = 54.21247057044361
cycle= 5 E= -128.198997088275  delta_E= -5.02e-10  |g|= 1.64e-06  |ddm|= 3.47e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.41146765871903  E_coul = 54.21247057044361
  HOMO = -0.788972638902929  LUMO = 2.54224468299416
  mo_energy =
[-3.27241580e+01 -1.90218735e+00 -7.88972639e-01 -7.88972639e-01
 -7.88972639e-01  2.54224468e+00  2.54224468e+00  2.54224468e+00
  2.69672528e+00  1.90541552e+01  1.90541552e+01  1.90541552e+01
  4.49287570e+01  3.32015713e+02  2.00503568e+03  7.26408024e+03]
E1 = -182.41146744652679  E_coul = 54.212470358250854
Extra cycle  E= -128.198997088276  delta_E= -4.83e-13  |g|= 3.04e-07  |ddm|= 9.49e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.15220178e+03 2.25529343e+02 1.40100944e+03 5.71453624e-01
 4.96983471e+01 1.31919662e+01 1.91489240e+00 2.69751034e+00
 1.28724579e+01 5.87740354e-01]
E = -128.19899708827592
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2152.20177786        1
[INPUT] 0    0    [1    /1   ]  225.529343023        1
[INPUT] 0    0    [1    /1   ]  1401.00944387        1
[INPUT] 0    0    [1    /1   ]  0.571453624056       1
[INPUT] 0    0    [1    /1   ]  49.6983471215        1
[INPUT] 0    0    [1    /1   ]  13.1919662289        1
[INPUT] 0    0    [1    /1   ]  1.9148924005         1
[INPUT] 1    0    [1    /1   ]  2.69751034206        1
[INPUT] 1    0    [1    /1   ]  12.8724579194        1
[INPUT] 1    0    [1    /1   ]  0.587740354122       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2152.201777858408, 1.0]], [0, [225.52934302294273, 1.0]], [0, [1401.0094438667459, 1.0]], [0, [0.5714536240555887, 1.0]], [0, [49.698347121533004, 1.0]], [0, [13.191966228898554, 1.0]], [0, [1.9148924005044834, 1.0]], [1, [2.6975103420636044, 1.0]], [1, [12.872457919409708, 1.0]], [1, [0.587740354122083, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2152.20177786]
bas 1, expnt(s) = [225.52934302]
bas 2, expnt(s) = [1401.00944387]
bas 3, expnt(s) = [0.57145362]
bas 4, expnt(s) = [49.69834712]
bas 5, expnt(s) = [13.19196623]
bas 6, expnt(s) = [1.9148924]
bas 7, expnt(s) = [2.69751034]
bas 8, expnt(s) = [12.87245792]
bas 9, expnt(s) = [0.58774035]
CPU time:       226.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.15220178e+03 7.98320467e+02 2.25529343e+02 1.47033845e+02
 1.40100944e+03 5.78556559e+02 5.71453624e-01 1.66054545e+00
 4.96983471e+01 4.72902362e+01 1.31919662e+01 1.74882830e+01
 1.91489240e+00 4.11266472e+00 2.69751034e+00 1.00852877e+01
 1.28724579e+01 7.11313815e+01 5.87740354e-01 1.50129584e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.968244069655995
cond(S) = 145.54271058526618
E1 = -183.1366260754836  E_coul = 55.00915201755831
init E= -128.127474057925
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742823662864609  LUMO = 2.57825867585471
  mo_energy =
[-3.25154610e+01 -1.85375169e+00 -7.42823663e-01 -7.42823663e-01
 -7.42823663e-01  2.57825868e+00  2.57825868e+00  2.57825868e+00
  2.73439827e+00  1.91944418e+01  1.91944418e+01  1.91944418e+01
  4.51070287e+01  3.32254377e+02  2.00531728e+03  7.26438466e+03]
E1 = -182.05822290044824  E_coul = 53.86140221099377
cycle= 1 E= -128.196820689454  delta_E= -0.0693  |g|= 0.173  |ddm|= 0.185
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.273427
diis-c [-0.07476256  1.        ]
  HOMO = -0.813066927191329  LUMO = 2.52095049359508
  mo_energy =
[-3.28029142e+01 -1.92711864e+00 -8.13066927e-01 -8.13066927e-01
 -8.13066927e-01  2.52095049e+00  2.52095049e+00  2.52095049e+00
  2.67557512e+00  1.89956463e+01  1.89956463e+01  1.89956463e+01
  4.48591325e+01  3.31929466e+02  2.00494360e+03  7.26398654e+03]
E1 = -182.5527103116113  E_coul = 54.354064048045984
cycle= 2 E= -128.198646263565  delta_E= -0.00183  |g|= 0.0667  |ddm|= 0.0687
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.109059
diis-c [-4.14364769e-04  2.82094130e-01  7.17905870e-01]
  HOMO = -0.788816138215795  LUMO = 2.54234624937953
  mo_energy =
[-3.27237044e+01 -1.90192605e+00 -7.88816138e-01 -7.88816138e-01
 -7.88816138e-01  2.54234625e+00  2.54234625e+00  2.54234625e+00
  2.69692501e+00  1.90545041e+01  1.90545041e+01  1.90545041e+01
  4.49292001e+01  3.32015964e+02  2.00503575e+03  7.26408026e+03]
E1 = -182.41055541452877  E_coul = 54.21155835445735
cycle= 3 E= -128.198997060071  delta_E= -0.000351  |g|= 0.000623  |ddm|= 0.0195
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000693104
diis-c [-1.23718294e-07 -4.18888196e-03 -5.33173436e-03  1.00952062e+00]
  HOMO = -0.78899055165881  LUMO = 2.5422296571449
  mo_energy =
[-3.27242038e+01 -1.90218888e+00 -7.88990552e-01 -7.88990552e-01
 -7.88990552e-01  2.54222966e+00  2.54222966e+00  2.54222966e+00
  2.69672508e+00  1.90541203e+01  1.90541203e+01  1.90541203e+01
  4.49287204e+01  3.32015649e+02  2.00503559e+03  7.26408015e+03]
E1 = -182.41154505261645  E_coul = 54.2125479648432
cycle= 4 E= -128.198997087773  delta_E= -2.77e-08  |g|= 6.53e-05  |ddm|= 0.000266
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000102125
diis-c [-2.82993903e-10  5.22501501e-04 -4.99443009e-04 -1.78680958e-01
  1.17865790e+00]
  HOMO = -0.788972726428723  LUMO = 2.54224458516668
  mo_energy =
[-3.27241581e+01 -1.90218704e+00 -7.88972726e-01 -7.88972726e-01
 -7.88972726e-01  2.54224459e+00  2.54224459e+00  2.54224459e+00
  2.69672555e+00  1.90541551e+01  1.90541551e+01  1.90541551e+01
  4.49287569e+01  3.32015713e+02  2.00503568e+03  7.26408024e+03]
E1 = -182.41146765871903  E_coul = 54.21247057044361
cycle= 5 E= -128.198997088275  delta_E= -5.02e-10  |g|= 1.64e-06  |ddm|= 3.47e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.41146765871903  E_coul = 54.21247057044361
  HOMO = -0.788972638902929  LUMO = 2.54224468299416
  mo_energy =
[-3.27241580e+01 -1.90218735e+00 -7.88972639e-01 -7.88972639e-01
 -7.88972639e-01  2.54224468e+00  2.54224468e+00  2.54224468e+00
  2.69672528e+00  1.90541552e+01  1.90541552e+01  1.90541552e+01
  4.49287570e+01  3.32015713e+02  2.00503568e+03  7.26408024e+03]
E1 = -182.41146744652679  E_coul = 54.212470358250854
Extra cycle  E= -128.198997088276  delta_E= -4.83e-13  |g|= 3.04e-07  |ddm|= 9.49e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 145.54271058526618
E1 = -182.41146744652679  E_coul = 54.212470358250854
init E= -128.198997088276
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.78897263762284  LUMO = 2.54224468230886
  mo_energy =
[-3.27241580e+01 -1.90218743e+00 -7.88972638e-01 -7.88972638e-01
 -7.88972638e-01  2.54224468e+00  2.54224468e+00  2.54224468e+00
  2.69672522e+00  1.90541551e+01  1.90541551e+01  1.90541551e+01
  4.49287569e+01  3.32015713e+02  2.00503568e+03  7.26408024e+03]
E1 = -182.41146753392195  E_coul = 54.21247044564629
cycle= 1 E= -128.198997088276  delta_E= 2.56e-13  |g|= 5.55e-08  |ddm|= 1.77e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.41146753392195  E_coul = 54.21247044564629
  HOMO = -0.788972628589308  LUMO = 2.54224468996803
  mo_energy =
[-3.27241580e+01 -1.90218743e+00 -7.88972629e-01 -7.88972629e-01
 -7.88972629e-01  2.54224469e+00  2.54224469e+00  2.54224469e+00
  2.69672521e+00  1.90541552e+01  1.90541552e+01  1.90541552e+01
  4.49287569e+01  3.32015713e+02  2.00503568e+03  7.26408024e+03]
E1 = -182.41146750008863  E_coul = 54.2124704118128
Extra cycle  E= -128.198997088276  delta_E= -1.71e-13  |g|= 1.14e-08  |ddm|= 2.98e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.15220178e+03 2.25529343e+02 1.40100944e+03 5.71453624e-01
 4.96983471e+01 1.31919662e+01 1.91489240e+00 2.69751034e+00
 1.28724579e+01 5.87740354e-01]
grad_E = [-1.08413838e-05  4.66348740e-06  3.58324538e-05 -1.06801997e-03
  7.28848796e-05 -8.25629066e-04  2.70008070e-04 -6.92358119e-03
 -9.53383022e-04 -1.89371468e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2157.83389944        1
[INPUT] 0    0    [1    /1   ]  224.35137474         1
[INPUT] 0    0    [1    /1   ]  1381.68585093        1
[INPUT] 0    0    [1    /1   ]  0.569563142486       1
[INPUT] 0    0    [1    /1   ]  49.5115418989        1
[INPUT] 0    0    [1    /1   ]  13.1544973726        1
[INPUT] 0    0    [1    /1   ]  1.90850765776        1
[INPUT] 1    0    [1    /1   ]  2.67096662795        1
[INPUT] 1    0    [1    /1   ]  12.7231938717        1
[INPUT] 1    0    [1    /1   ]  0.58341806275        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2157.8338994409996, 1.0]], [0, [224.3513747400891, 1.0]], [0, [1381.685850929516, 1.0]], [0, [0.5695631424860707, 1.0]], [0, [49.511541898877404, 1.0]], [0, [13.154497372559478, 1.0]], [0, [1.908507657757137, 1.0]], [1, [2.670966627951059, 1.0]], [1, [12.723193871690377, 1.0]], [1, [0.5834180627504, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2157.83389944]
bas 1, expnt(s) = [224.35137474]
bas 2, expnt(s) = [1381.68585093]
bas 3, expnt(s) = [0.56956314]
bas 4, expnt(s) = [49.5115419]
bas 5, expnt(s) = [13.15449737]
bas 6, expnt(s) = [1.90850766]
bas 7, expnt(s) = [2.67096663]
bas 8, expnt(s) = [12.72319387]
bas 9, expnt(s) = [0.58341806]
CPU time:       229.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.15783390e+03 7.99886805e+02 2.24351375e+02 1.46457486e+02
 1.38168585e+03 5.72561322e+02 5.69563142e-01 1.65642369e+00
 4.95115419e+01 4.71568582e+01 1.31544974e+01 1.74510161e+01
 1.90850766e+00 4.10237592e+00 2.67096663e+00 9.96139060e+00
 1.27231939e+01 7.01018652e+01 5.83418063e-01 1.48750773e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.969110477446412
cond(S) = 136.1731517308326
E1 = -183.13660699051374  E_coul = 55.00817138249032
init E= -128.128435608023
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742773639712659  LUMO = 2.55172589821094
  mo_energy =
[-3.25163008e+01 -1.85382466e+00 -7.42773640e-01 -7.42773640e-01
 -7.42773640e-01  2.55172590e+00  2.55172590e+00  2.55172590e+00
  2.71900702e+00  1.89449105e+01  1.89449105e+01  1.89449105e+01
  4.48832136e+01  3.30448697e+02  1.99063929e+03  7.22527232e+03]
E1 = -182.0318876065018  E_coul = 53.83479390283755
cycle= 1 E= -128.197093703664  delta_E= -0.0687  |g|= 0.176  |ddm|= 0.186
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.278075
diis-c [-0.07732575  1.        ]
  HOMO = -0.8148867546998  LUMO = 2.49330677109125
  mo_energy =
[-3.28087415e+01 -1.92933625e+00 -8.14886755e-01 -8.14886755e-01
 -8.14886755e-01  2.49330677e+00  2.49330677e+00  2.49330677e+00
  2.65858888e+00  1.87432297e+01  1.87432297e+01  1.87432297e+01
  4.46310792e+01  3.30118718e+02  1.99026042e+03  7.22486888e+03]
E1 = -182.5379028486155  E_coul = 54.338912294322796
cycle= 2 E= -128.198990554293  delta_E= -0.0019  |g|= 0.0682  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.111638
diis-c [-4.16231283e-04  2.83550911e-01  7.16449089e-01]
  HOMO = -0.790101615843832  LUMO = 2.51497874410164
  mo_energy =
[-3.27279409e+01 -1.90357888e+00 -7.90101616e-01 -7.90101616e-01
 -7.90101616e-01  2.51497874e+00  2.51497874e+00  2.51497874e+00
  2.68032834e+00  1.88030531e+01  1.88030531e+01  1.88030531e+01
  4.47025051e+01  3.30206883e+02  1.99035433e+03  7.22496441e+03]
E1 = -182.39216904986108  E_coul = 54.19281053760715
cycle= 3 E= -128.199358512254  delta_E= -0.000368  |g|= 0.000606  |ddm|= 0.0199
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000643156
diis-c [-1.43156090e-07 -4.31377962e-03 -6.55646765e-03  1.01087025e+00]
  HOMO = -0.790255887278643  LUMO = 2.51488225802143
  mo_energy =
[-3.27283833e+01 -1.90382803e+00 -7.90255887e-01 -7.90255887e-01
 -7.90255887e-01  2.51488226e+00  2.51488226e+00  2.51488226e+00
  2.68014180e+00  1.88027158e+01  1.88027158e+01  1.88027158e+01
  4.47020754e+01  3.30206633e+02  1.99035425e+03  7.22496438e+03]
E1 = -182.39305549833657  E_coul = 54.19369695922817
cycle= 4 E= -128.199358539108  delta_E= -2.69e-08  |g|= 7.03e-05  |ddm|= 0.00027
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000109457
diis-c [-3.13826479e-10  5.26507498e-04 -3.69486308e-04 -1.80633323e-01
  1.18047630e+00]
  HOMO = -0.790236935234756  LUMO = 2.5148979426034
  mo_energy =
[-3.27283349e+01 -1.90382648e+00 -7.90236935e-01 -7.90236935e-01
 -7.90236935e-01  2.51489794e+00  2.51489794e+00  2.51489794e+00
  2.68014190e+00  1.88027525e+01  1.88027525e+01  1.88027525e+01
  4.47021140e+01  3.30206701e+02  1.99035434e+03  7.22496447e+03]
E1 = -182.39297310766486  E_coul = 54.193614567968645
cycle= 5 E= -128.199358539696  delta_E= -5.88e-10  |g|= 1.69e-06  |ddm|= 3.79e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.39297310766486  E_coul = 54.193614567968645
  HOMO = -0.790236831030787  LUMO = 2.51489805672399
  mo_energy =
[-3.27283347e+01 -1.90382679e+00 -7.90236831e-01 -7.90236831e-01
 -7.90236831e-01  2.51489806e+00  2.51489806e+00  2.51489806e+00
  2.68014165e+00  1.88027526e+01  1.88027526e+01  1.88027526e+01
  4.47021141e+01  3.30206701e+02  1.99035434e+03  7.22496447e+03]
E1 = -182.39297278810233  E_coul = 54.19361424840576
Extra cycle  E= -128.199358539697  delta_E= -3.41e-13  |g|= 3.16e-07  |ddm|= 9.74e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.15783390e+03 2.24351375e+02 1.38168585e+03 5.69563142e-01
 4.95115419e+01 1.31544974e+01 1.90850766e+00 2.67096663e+00
 1.27231939e+01 5.83418063e-01]
E = -128.19935853969656
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2157.83389944        1
[INPUT] 0    0    [1    /1   ]  224.35137474         1
[INPUT] 0    0    [1    /1   ]  1381.68585093        1
[INPUT] 0    0    [1    /1   ]  0.569563142486       1
[INPUT] 0    0    [1    /1   ]  49.5115418989        1
[INPUT] 0    0    [1    /1   ]  13.1544973726        1
[INPUT] 0    0    [1    /1   ]  1.90850765776        1
[INPUT] 1    0    [1    /1   ]  2.67096662795        1
[INPUT] 1    0    [1    /1   ]  12.7231938717        1
[INPUT] 1    0    [1    /1   ]  0.58341806275        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2157.8338994409996, 1.0]], [0, [224.3513747400891, 1.0]], [0, [1381.685850929516, 1.0]], [0, [0.5695631424860707, 1.0]], [0, [49.511541898877404, 1.0]], [0, [13.154497372559478, 1.0]], [0, [1.908507657757137, 1.0]], [1, [2.670966627951059, 1.0]], [1, [12.723193871690377, 1.0]], [1, [0.5834180627504, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2157.83389944]
bas 1, expnt(s) = [224.35137474]
bas 2, expnt(s) = [1381.68585093]
bas 3, expnt(s) = [0.56956314]
bas 4, expnt(s) = [49.5115419]
bas 5, expnt(s) = [13.15449737]
bas 6, expnt(s) = [1.90850766]
bas 7, expnt(s) = [2.67096663]
bas 8, expnt(s) = [12.72319387]
bas 9, expnt(s) = [0.58341806]
CPU time:       230.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.15783390e+03 7.99886805e+02 2.24351375e+02 1.46457486e+02
 1.38168585e+03 5.72561322e+02 5.69563142e-01 1.65642369e+00
 4.95115419e+01 4.71568582e+01 1.31544974e+01 1.74510161e+01
 1.90850766e+00 4.10237592e+00 2.67096663e+00 9.96139060e+00
 1.27231939e+01 7.01018652e+01 5.83418063e-01 1.48750773e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.969110477446412
cond(S) = 136.1731517308326
E1 = -183.13660699051374  E_coul = 55.00817138249032
init E= -128.128435608023
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742773639712659  LUMO = 2.55172589821094
  mo_energy =
[-3.25163008e+01 -1.85382466e+00 -7.42773640e-01 -7.42773640e-01
 -7.42773640e-01  2.55172590e+00  2.55172590e+00  2.55172590e+00
  2.71900702e+00  1.89449105e+01  1.89449105e+01  1.89449105e+01
  4.48832136e+01  3.30448697e+02  1.99063929e+03  7.22527232e+03]
E1 = -182.0318876065018  E_coul = 53.83479390283755
cycle= 1 E= -128.197093703664  delta_E= -0.0687  |g|= 0.176  |ddm|= 0.186
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.278075
diis-c [-0.07732575  1.        ]
  HOMO = -0.8148867546998  LUMO = 2.49330677109125
  mo_energy =
[-3.28087415e+01 -1.92933625e+00 -8.14886755e-01 -8.14886755e-01
 -8.14886755e-01  2.49330677e+00  2.49330677e+00  2.49330677e+00
  2.65858888e+00  1.87432297e+01  1.87432297e+01  1.87432297e+01
  4.46310792e+01  3.30118718e+02  1.99026042e+03  7.22486888e+03]
E1 = -182.5379028486155  E_coul = 54.338912294322796
cycle= 2 E= -128.198990554293  delta_E= -0.0019  |g|= 0.0682  |ddm|= 0.0703
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.111638
diis-c [-4.16231283e-04  2.83550911e-01  7.16449089e-01]
  HOMO = -0.790101615843832  LUMO = 2.51497874410164
  mo_energy =
[-3.27279409e+01 -1.90357888e+00 -7.90101616e-01 -7.90101616e-01
 -7.90101616e-01  2.51497874e+00  2.51497874e+00  2.51497874e+00
  2.68032834e+00  1.88030531e+01  1.88030531e+01  1.88030531e+01
  4.47025051e+01  3.30206883e+02  1.99035433e+03  7.22496441e+03]
E1 = -182.39216904986108  E_coul = 54.19281053760715
cycle= 3 E= -128.199358512254  delta_E= -0.000368  |g|= 0.000606  |ddm|= 0.0199
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000643156
diis-c [-1.43156090e-07 -4.31377962e-03 -6.55646765e-03  1.01087025e+00]
  HOMO = -0.790255887278643  LUMO = 2.51488225802143
  mo_energy =
[-3.27283833e+01 -1.90382803e+00 -7.90255887e-01 -7.90255887e-01
 -7.90255887e-01  2.51488226e+00  2.51488226e+00  2.51488226e+00
  2.68014180e+00  1.88027158e+01  1.88027158e+01  1.88027158e+01
  4.47020754e+01  3.30206633e+02  1.99035425e+03  7.22496438e+03]
E1 = -182.39305549833657  E_coul = 54.19369695922817
cycle= 4 E= -128.199358539108  delta_E= -2.69e-08  |g|= 7.03e-05  |ddm|= 0.00027
    CPU time for cycle= 4      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000109457
diis-c [-3.13826479e-10  5.26507498e-04 -3.69486308e-04 -1.80633323e-01
  1.18047630e+00]
  HOMO = -0.790236935234756  LUMO = 2.5148979426034
  mo_energy =
[-3.27283349e+01 -1.90382648e+00 -7.90236935e-01 -7.90236935e-01
 -7.90236935e-01  2.51489794e+00  2.51489794e+00  2.51489794e+00
  2.68014190e+00  1.88027525e+01  1.88027525e+01  1.88027525e+01
  4.47021140e+01  3.30206701e+02  1.99035434e+03  7.22496447e+03]
E1 = -182.39297310766486  E_coul = 54.193614567968645
cycle= 5 E= -128.199358539696  delta_E= -5.88e-10  |g|= 1.69e-06  |ddm|= 3.79e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.39297310766486  E_coul = 54.193614567968645
  HOMO = -0.790236831030787  LUMO = 2.51489805672399
  mo_energy =
[-3.27283347e+01 -1.90382679e+00 -7.90236831e-01 -7.90236831e-01
 -7.90236831e-01  2.51489806e+00  2.51489806e+00  2.51489806e+00
  2.68014165e+00  1.88027526e+01  1.88027526e+01  1.88027526e+01
  4.47021141e+01  3.30206701e+02  1.99035434e+03  7.22496447e+03]
E1 = -182.39297278810233  E_coul = 54.19361424840576
Extra cycle  E= -128.199358539697  delta_E= -3.41e-13  |g|= 3.16e-07  |ddm|= 9.74e-07
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 136.1731517308326
E1 = -182.39297278810233  E_coul = 54.19361424840576
init E= -128.199358539697
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.790236836748503  LUMO = 2.51489804980477
  mo_energy =
[-3.27283348e+01 -1.90382687e+00 -7.90236837e-01 -7.90236837e-01
 -7.90236837e-01  2.51489805e+00  2.51489805e+00  2.51489805e+00
  2.68014157e+00  1.88027526e+01  1.88027526e+01  1.88027526e+01
  4.47021140e+01  3.30206701e+02  1.99035434e+03  7.22496447e+03]
E1 = -182.39297291749477  E_coul = 54.19361437779808
cycle= 1 E= -128.199358539697  delta_E= -1.42e-13  |g|= 5.81e-08  |ddm|= 1.85e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.39297291749477  E_coul = 54.19361437779808
  HOMO = -0.790236824750601  LUMO = 2.51489805996606
  mo_energy =
[-3.27283347e+01 -1.90382687e+00 -7.90236825e-01 -7.90236825e-01
 -7.90236825e-01  2.51489806e+00  2.51489806e+00  2.51489806e+00
  2.68014157e+00  1.88027526e+01  1.88027526e+01  1.88027526e+01
  4.47021140e+01  3.30206701e+02  1.99035434e+03  7.22496447e+03]
E1 = -182.39297286636838  E_coul = 54.193614326671614
Extra cycle  E= -128.199358539697  delta_E= -5.68e-14  |g|= 1.3e-08  |ddm|= 3.05e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.15783390e+03 2.24351375e+02 1.38168585e+03 5.69563142e-01
 4.95115419e+01 1.31544974e+01 1.90850766e+00 2.67096663e+00
 1.27231939e+01 5.83418063e-01]
grad_E = [-1.15475689e-05  4.45028396e-06  3.72463353e-05 -1.43378685e-03
  9.64600432e-05 -1.10880834e-03  3.58509848e-04 -9.33347769e-03
 -1.28572993e-03 -2.54588790e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2167.61206279        1
[INPUT] 0    0    [1    /1   ]  222.361377245        1
[INPUT] 0    0    [1    /1   ]  1348.13264737        1
[INPUT] 0    0    [1    /1   ]  0.566750401851       1
[INPUT] 0    0    [1    /1   ]  49.2079880116        1
[INPUT] 0    0    [1    /1   ]  13.0959746929        1
[INPUT] 0    0    [1    /1   ]  1.89909795076        1
[INPUT] 1    0    [1    /1   ]  2.63519588486        1
[INPUT] 1    0    [1    /1   ]  12.5238469           1
[INPUT] 1    0    [1    /1   ]  0.57755320995        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2167.612062792722, 1.0]], [0, [222.36137724518412, 1.0]], [0, [1348.1326473694053, 1.0]], [0, [0.5667504018512618, 1.0]], [0, [49.20798801160813, 1.0]], [0, [13.095974692902677, 1.0]], [0, [1.8990979507603976, 1.0]], [1, [2.6351958848572075, 1.0]], [1, [12.523846899971153, 1.0]], [1, [0.5775532099495717, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2167.61206279]
bas 1, expnt(s) = [222.36137725]
bas 2, expnt(s) = [1348.13264737]
bas 3, expnt(s) = [0.5667504]
bas 4, expnt(s) = [49.20798801]
bas 5, expnt(s) = [13.09597469]
bas 6, expnt(s) = [1.89909795]
bas 7, expnt(s) = [2.63519588]
bas 8, expnt(s) = [12.5238469]
bas 9, expnt(s) = [0.57755321]
CPU time:       233.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.16761206e+03 8.02603767e+02 2.22361377e+02 1.45482093e+02
 1.34813265e+03 5.62101176e+02 5.66750402e-01 1.65028481e+00
 4.92079880e+01 4.69398536e+01 1.30959747e+01 1.73927556e+01
 1.89909795e+00 4.08719679e+00 2.63519588e+00 9.79491163e+00
 1.25238469e+01 6.87316199e+01 5.77553210e-01 1.46883968e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.970261985395128
cond(S) = 122.0791875414555
E1 = -183.13665627543287  E_coul = 55.00669582111291
init E= -128.12996045432
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74268478303237  LUMO = 2.51594394322944
  mo_energy =
[-3.25176413e+01 -1.85394837e+00 -7.42684783e-01 -7.42684783e-01
 -7.42684783e-01  2.51594394e+00  2.51594394e+00  2.51594394e+00
  2.69621691e+00  1.86115861e+01  1.86115861e+01  1.86115861e+01
  4.45306841e+01  3.27451752e+02  1.96496674e+03  7.15689503e+03]
E1 = -181.99603513630413  E_coul = 53.79840226111121
cycle= 1 E= -128.197632875193  delta_E= -0.0677  |g|= 0.18  |ddm|= 0.188
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.284433
diis-c [-0.08090188  1.        ]
  HOMO = -0.817341942994486  LUMO = 2.45605072615115
  mo_energy =
[-3.28168916e+01 -1.93237541e+00 -8.17341943e-01 -8.17341943e-01
 -8.17341943e-01  2.45605073e+00  2.45605073e+00  2.45605073e+00
  2.63369433e+00  1.84060082e+01  1.84060082e+01  1.84060082e+01
  4.42728508e+01  3.27114919e+02  1.96458087e+03  7.15648441e+03]
E1 = -182.5179139552796  E_coul = 54.31828454924975
cycle= 2 E= -128.19962940603  delta_E= -0.002  |g|= 0.0703  |ddm|= 0.0724
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.115186
diis-c [-4.17187236e-04  2.85500328e-01  7.14499672e-01]
  HOMO = -0.791822396462772  LUMO = 2.47809276523879
  mo_energy =
[-3.27339120e+01 -1.90584116e+00 -7.91822396e-01 -7.91822396e-01
 -7.91822396e-01  2.47809277e+00  2.47809277e+00  2.47809277e+00
  2.65595294e+00  1.84671432e+01  1.84671432e+01  1.84671432e+01
  4.43461174e+01  3.27205354e+02  1.96467720e+03  7.15658240e+03]
E1 = -182.36724419603013  E_coul = 54.16722254329537
cycle= 3 E= -128.200021652735  delta_E= -0.000392  |g|= 0.000589  |ddm|= 0.0206
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000594088
diis-c [-1.71857518e-07 -4.50416949e-03 -8.24229135e-03  1.01274646e+00]
  HOMO = -0.791948244771834  LUMO = 2.47802407373376
  mo_energy =
[-3.27342741e+01 -1.90607064e+00 -7.91948245e-01 -7.91948245e-01
 -7.91948245e-01  2.47802407e+00  2.47802407e+00  2.47802407e+00
  2.65578553e+00  1.84668708e+01  1.84668708e+01  1.84668708e+01
  4.43457579e+01  3.27205196e+02  1.96467723e+03  7.15658248e+03]
E1 = -182.36798305909969  E_coul = 54.167961379774226
cycle= 4 E= -128.200021679325  delta_E= -2.66e-08  |g|= 7.7e-05  |ddm|= 0.000277
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000119255
diis-c [-3.61790699e-10  5.30961005e-04 -1.87242689e-04 -1.82669579e-01
  1.18232586e+00]
  HOMO = -0.7919278057864  LUMO = 2.47804071009316
  mo_energy =
[-3.27342221e+01 -1.90606951e+00 -7.91927806e-01 -7.91927806e-01
 -7.91927806e-01  2.47804071e+00  2.47804071e+00  2.47804071e+00
  2.65578509e+00  1.84669100e+01  1.84669100e+01  1.84669100e+01
  4.43457991e+01  3.27205269e+02  1.96467732e+03  7.15658259e+03]
E1 = -182.36789405784626  E_coul = 54.16787237780647
cycle= 5 E= -128.20002168004  delta_E= -7.14e-10  |g|= 1.77e-06  |ddm|= 4.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.36789405784626  E_coul = 54.16787237780647
  HOMO = -0.791927674618501  LUMO = 2.47804084993319
  mo_energy =
[-3.27342218e+01 -1.90606981e+00 -7.91927675e-01 -7.91927675e-01
 -7.91927675e-01  2.47804085e+00  2.47804085e+00  2.47804085e+00
  2.65578484e+00  1.84669101e+01  1.84669101e+01  1.84669101e+01
  4.43457992e+01  3.27205269e+02  1.96467732e+03  7.15658259e+03]
E1 = -182.36789356750654  E_coul = 54.16787188746635
Extra cycle  E= -128.20002168004  delta_E= -4.26e-13  |g|= 3.36e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
exp = [2.16761206e+03 2.22361377e+02 1.34813265e+03 5.66750402e-01
 4.92079880e+01 1.30959747e+01 1.89909795e+00 2.63519588e+00
 1.25238469e+01 5.77553210e-01]
E = -128.2000216800402
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2167.61206279        1
[INPUT] 0    0    [1    /1   ]  222.361377245        1
[INPUT] 0    0    [1    /1   ]  1348.13264737        1
[INPUT] 0    0    [1    /1   ]  0.566750401851       1
[INPUT] 0    0    [1    /1   ]  49.2079880116        1
[INPUT] 0    0    [1    /1   ]  13.0959746929        1
[INPUT] 0    0    [1    /1   ]  1.89909795076        1
[INPUT] 1    0    [1    /1   ]  2.63519588486        1
[INPUT] 1    0    [1    /1   ]  12.5238469           1
[INPUT] 1    0    [1    /1   ]  0.57755320995        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2167.612062792722, 1.0]], [0, [222.36137724518412, 1.0]], [0, [1348.1326473694053, 1.0]], [0, [0.5667504018512618, 1.0]], [0, [49.20798801160813, 1.0]], [0, [13.095974692902677, 1.0]], [0, [1.8990979507603976, 1.0]], [1, [2.6351958848572075, 1.0]], [1, [12.523846899971153, 1.0]], [1, [0.5775532099495717, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2167.61206279]
bas 1, expnt(s) = [222.36137725]
bas 2, expnt(s) = [1348.13264737]
bas 3, expnt(s) = [0.5667504]
bas 4, expnt(s) = [49.20798801]
bas 5, expnt(s) = [13.09597469]
bas 6, expnt(s) = [1.89909795]
bas 7, expnt(s) = [2.63519588]
bas 8, expnt(s) = [12.5238469]
bas 9, expnt(s) = [0.57755321]
CPU time:       234.06
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.16761206e+03 8.02603767e+02 2.22361377e+02 1.45482093e+02
 1.34813265e+03 5.62101176e+02 5.66750402e-01 1.65028481e+00
 4.92079880e+01 4.69398536e+01 1.30959747e+01 1.73927556e+01
 1.89909795e+00 4.08719679e+00 2.63519588e+00 9.79491163e+00
 1.25238469e+01 6.87316199e+01 5.77553210e-01 1.46883968e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.970261985395128
cond(S) = 122.0791875414555
E1 = -183.13665627543287  E_coul = 55.00669582111291
init E= -128.12996045432
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74268478303237  LUMO = 2.51594394322944
  mo_energy =
[-3.25176413e+01 -1.85394837e+00 -7.42684783e-01 -7.42684783e-01
 -7.42684783e-01  2.51594394e+00  2.51594394e+00  2.51594394e+00
  2.69621691e+00  1.86115861e+01  1.86115861e+01  1.86115861e+01
  4.45306841e+01  3.27451752e+02  1.96496674e+03  7.15689503e+03]
E1 = -181.99603513630413  E_coul = 53.79840226111121
cycle= 1 E= -128.197632875193  delta_E= -0.0677  |g|= 0.18  |ddm|= 0.188
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.284433
diis-c [-0.08090188  1.        ]
  HOMO = -0.817341942994486  LUMO = 2.45605072615115
  mo_energy =
[-3.28168916e+01 -1.93237541e+00 -8.17341943e-01 -8.17341943e-01
 -8.17341943e-01  2.45605073e+00  2.45605073e+00  2.45605073e+00
  2.63369433e+00  1.84060082e+01  1.84060082e+01  1.84060082e+01
  4.42728508e+01  3.27114919e+02  1.96458087e+03  7.15648441e+03]
E1 = -182.5179139552796  E_coul = 54.31828454924975
cycle= 2 E= -128.19962940603  delta_E= -0.002  |g|= 0.0703  |ddm|= 0.0724
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.115186
diis-c [-4.17187236e-04  2.85500328e-01  7.14499672e-01]
  HOMO = -0.791822396462772  LUMO = 2.47809276523879
  mo_energy =
[-3.27339120e+01 -1.90584116e+00 -7.91822396e-01 -7.91822396e-01
 -7.91822396e-01  2.47809277e+00  2.47809277e+00  2.47809277e+00
  2.65595294e+00  1.84671432e+01  1.84671432e+01  1.84671432e+01
  4.43461174e+01  3.27205354e+02  1.96467720e+03  7.15658240e+03]
E1 = -182.36724419603013  E_coul = 54.16722254329537
cycle= 3 E= -128.200021652735  delta_E= -0.000392  |g|= 0.000589  |ddm|= 0.0206
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000594088
diis-c [-1.71857518e-07 -4.50416949e-03 -8.24229135e-03  1.01274646e+00]
  HOMO = -0.791948244771834  LUMO = 2.47802407373376
  mo_energy =
[-3.27342741e+01 -1.90607064e+00 -7.91948245e-01 -7.91948245e-01
 -7.91948245e-01  2.47802407e+00  2.47802407e+00  2.47802407e+00
  2.65578553e+00  1.84668708e+01  1.84668708e+01  1.84668708e+01
  4.43457579e+01  3.27205196e+02  1.96467723e+03  7.15658248e+03]
E1 = -182.36798305909969  E_coul = 54.167961379774226
cycle= 4 E= -128.200021679325  delta_E= -2.66e-08  |g|= 7.7e-05  |ddm|= 0.000277
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000119255
diis-c [-3.61790699e-10  5.30961005e-04 -1.87242689e-04 -1.82669579e-01
  1.18232586e+00]
  HOMO = -0.7919278057864  LUMO = 2.47804071009316
  mo_energy =
[-3.27342221e+01 -1.90606951e+00 -7.91927806e-01 -7.91927806e-01
 -7.91927806e-01  2.47804071e+00  2.47804071e+00  2.47804071e+00
  2.65578509e+00  1.84669100e+01  1.84669100e+01  1.84669100e+01
  4.43457991e+01  3.27205269e+02  1.96467732e+03  7.15658259e+03]
E1 = -182.36789405784626  E_coul = 54.16787237780647
cycle= 5 E= -128.20002168004  delta_E= -7.14e-10  |g|= 1.77e-06  |ddm|= 4.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.36789405784626  E_coul = 54.16787237780647
  HOMO = -0.791927674618501  LUMO = 2.47804084993319
  mo_energy =
[-3.27342218e+01 -1.90606981e+00 -7.91927675e-01 -7.91927675e-01
 -7.91927675e-01  2.47804085e+00  2.47804085e+00  2.47804085e+00
  2.65578484e+00  1.84669101e+01  1.84669101e+01  1.84669101e+01
  4.43457992e+01  3.27205269e+02  1.96467732e+03  7.15658259e+03]
E1 = -182.36789356750654  E_coul = 54.16787188746635
Extra cycle  E= -128.20002168004  delta_E= -4.26e-13  |g|= 3.36e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 122.0791875414555
E1 = -182.36789356750654  E_coul = 54.16787188746635
init E= -128.20002168004
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.791927691463661  LUMO = 2.47804083330124
  mo_energy =
[-3.27342219e+01 -1.90606991e+00 -7.91927691e-01 -7.91927691e-01
 -7.91927691e-01  2.47804083e+00  2.47804083e+00  2.47804083e+00
  2.65578475e+00  1.84669101e+01  1.84669101e+01  1.84669101e+01
  4.43457991e+01  3.27205269e+02  1.96467732e+03  7.15658259e+03]
E1 = -182.36789376457122  E_coul = 54.167872084531076
cycle= 1 E= -128.20002168004  delta_E= 5.68e-14  |g|= 6.32e-08  |ddm|= 1.98e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.36789376457122  E_coul = 54.167872084531076
  HOMO = -0.791927674685276  LUMO = 2.47804084743515
  mo_energy =
[-3.27342219e+01 -1.90606991e+00 -7.91927675e-01 -7.91927675e-01
 -7.91927675e-01  2.47804085e+00  2.47804085e+00  2.47804085e+00
  2.65578476e+00  1.84669101e+01  1.84669101e+01  1.84669101e+01
  4.43457992e+01  3.27205269e+02  1.96467732e+03  7.15658259e+03]
E1 = -182.36789368543307  E_coul = 54.167872005392795
Extra cycle  E= -128.20002168004  delta_E= -1.14e-13  |g|= 1.6e-08  |ddm|= 3.17e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.16761206e+03 2.22361377e+02 1.34813265e+03 5.66750402e-01
 4.92079880e+01 1.30959747e+01 1.89909795e+00 2.63519588e+00
 1.25238469e+01 5.77553210e-01]
grad_E = [-1.27956291e-05  5.43690304e-06  3.97030152e-05 -1.93027177e-03
  1.25787748e-04 -1.49274620e-03  4.70172787e-04 -1.26708342e-02
 -1.75189026e-03 -3.40342775e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2184.96900682        1
[INPUT] 0    0    [1    /1   ]  218.827423543        1
[INPUT] 0    0    [1    /1   ]  1288.573255          1
[INPUT] 0    0    [1    /1   ]  0.562270584769       1
[INPUT] 0    0    [1    /1   ]  48.6840313921        1
[INPUT] 0    0    [1    /1   ]  12.9981619925        1
[INPUT] 0    0    [1    /1   ]  1.88428619357        1
[INPUT] 1    0    [1    /1   ]  2.58348156618        1
[INPUT] 1    0    [1    /1   ]  12.2382548895        1
[INPUT] 1    0    [1    /1   ]  0.569010077601       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2184.9690068229775, 1.0]], [0, [218.82742354273796, 1.0]], [0, [1288.5732549951167, 1.0]], [0, [0.5622705847687954, 1.0]], [0, [48.68403139205139, 1.0]], [0, [12.998161992545484, 1.0]], [0, [1.8842861935691528, 1.0]], [1, [2.5834815661843806, 1.0]], [1, [12.238254889484335, 1.0]], [1, [0.569010077600944, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2184.96900682]
bas 1, expnt(s) = [218.82742354]
bas 2, expnt(s) = [1288.573255]
bas 3, expnt(s) = [0.56227058]
bas 4, expnt(s) = [48.68403139]
bas 5, expnt(s) = [12.99816199]
bas 6, expnt(s) = [1.88428619]
bas 7, expnt(s) = [2.58348157]
bas 8, expnt(s) = [12.23825489]
bas 9, expnt(s) = [0.56901008]
CPU time:       236.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.18496901e+03 8.07419037e+02 2.18827424e+02 1.43744532e+02
 1.28857325e+03 5.43371504e+02 5.62270585e-01 1.64049174e+00
 4.86840314e+01 4.65644979e+01 1.29981620e+01 1.72952356e+01
 1.88428619e+00 4.06326525e+00 2.58348157e+00 9.55522904e+00
 1.22382549e+01 6.67780542e+01 5.69010078e-01 1.44173134e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.97188659070917
cond(S) = 102.36697327890273
E1 = -183.13676335738808  E_coul = 55.00424270711624
init E= -128.132520650272
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742509428429107  LUMO = 2.46423679614485
  mo_energy =
[-3.25199889e+01 -1.85417068e+00 -7.42509428e-01 -7.42509428e-01
 -7.42509428e-01  2.46423680e+00  2.46423680e+00  2.46423680e+00
  2.66019452e+00  1.81346269e+01  1.81346269e+01  1.81346269e+01
  4.39385522e+01  3.22201224e+02  1.91803390e+03  7.03318277e+03]
E1 = -181.94362247099764  E_coul = 53.74493166178989
cycle= 1 E= -128.198690809208  delta_E= -0.0662  |g|= 0.186  |ddm|= 0.191
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.293777
diis-c [-0.0863051  1.       ]
  HOMO = -0.820876948047458  LUMO = 2.40227662009463
  mo_energy =
[-3.28292137e+01 -1.93684884e+00 -8.20876948e-01 -8.20876948e-01
 -8.20876948e-01  2.40227662e+00  2.40227662e+00  2.40227662e+00
  2.59471955e+00  1.79234467e+01  1.79234467e+01  1.79234467e+01
  4.36725310e+01  3.21854482e+02  1.91763797e+03  7.03276176e+03]
E1 = -182.48901113557523  E_coul = 54.28817274531388
cycle= 2 E= -128.200838390261  delta_E= -0.00215  |g|= 0.0734  |ddm|= 0.0756
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.120442
diis-c [-4.15464632e-04  2.88275953e-01  7.11724047e-01]
  HOMO = -0.794270762569816  LUMO = 2.42484486633055
  mo_energy =
[-3.27430252e+01 -1.90916365e+00 -7.94270763e-01 -7.94270763e-01
 -7.94270763e-01  2.42484487e+00  2.42484487e+00  2.42484487e+00
  2.61771718e+00  1.79864855e+01  1.79864855e+01  1.79864855e+01
  4.37484708e+01  3.21948234e+02  1.91773784e+03  7.03286338e+03]
E1 = -182.33100258897133  E_coul = 54.129734522368715
cycle= 3 E= -128.201268066603  delta_E= -0.00043  |g|= 0.000583  |ddm|= 0.0215
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000579016
diis-c [-2.18696013e-07 -4.83085469e-03 -1.07548506e-02  1.01558571e+00]
  HOMO = -0.794353129460895  LUMO = 2.42481749420861
  mo_energy =
[-3.27432650e+01 -1.90936244e+00 -7.94353129e-01 -7.94353129e-01
 -7.94353129e-01  2.42481749e+00  2.42481749e+00  2.42481749e+00
  2.61757924e+00  1.79863110e+01  1.79863110e+01  1.79863110e+01
  4.37482182e+01  3.21948214e+02  1.91773802e+03  7.03286363e+03]
E1 = -182.331512033318  E_coul = 54.13024393836317
cycle= 4 E= -128.201268094955  delta_E= -2.84e-08  |g|= 8.67e-05  |ddm|= 0.00029
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133247
diis-c [-4.46742645e-10  5.36520539e-04  8.52694578e-05 -1.84693311e-01
  1.18407152e+00]
  HOMO = -0.794330609637019  LUMO = 2.42483536422664
  mo_energy =
[-3.27432080e+01 -1.90936205e+00 -7.94330610e-01 -7.94330610e-01
 -7.94330610e-01  2.42483536e+00  2.42483536e+00  2.42483536e+00
  2.61757789e+00  1.79863536e+01  1.79863536e+01  1.79863536e+01
  4.37482628e+01  3.21948295e+02  1.91773813e+03  7.03286374e+03]
E1 = -182.33141377420466  E_coul = 54.13014567832799
cycle= 5 E= -128.201268095877  delta_E= -9.22e-10  |g|= 1.9e-06  |ddm|= 4.85e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.33141377420466  E_coul = 54.13014567832799
  HOMO = -0.794330431622165  LUMO = 2.42483554756558
  mo_energy =
[-3.27432076e+01 -1.90936233e+00 -7.94330432e-01 -7.94330432e-01
 -7.94330432e-01  2.42483555e+00  2.42483555e+00  2.42483555e+00
  2.61757767e+00  1.79863539e+01  1.79863539e+01  1.79863539e+01
  4.37482630e+01  3.21948295e+02  1.91773813e+03  7.03286374e+03]
E1 = -182.33141298875154  E_coul = 54.13014489287461
Extra cycle  E= -128.201268095877  delta_E= -2.27e-13  |g|= 3.72e-07  |ddm|= 1.08e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.18496901e+03 2.18827424e+02 1.28857325e+03 5.62270585e-01
 4.86840314e+01 1.29981620e+01 1.88428619e+00 2.58348157e+00
 1.22382549e+01 5.69010078e-01]
E = -128.2012680958769
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2184.96900682        1
[INPUT] 0    0    [1    /1   ]  218.827423543        1
[INPUT] 0    0    [1    /1   ]  1288.573255          1
[INPUT] 0    0    [1    /1   ]  0.562270584769       1
[INPUT] 0    0    [1    /1   ]  48.6840313921        1
[INPUT] 0    0    [1    /1   ]  12.9981619925        1
[INPUT] 0    0    [1    /1   ]  1.88428619357        1
[INPUT] 1    0    [1    /1   ]  2.58348156618        1
[INPUT] 1    0    [1    /1   ]  12.2382548895        1
[INPUT] 1    0    [1    /1   ]  0.569010077601       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2184.9690068229775, 1.0]], [0, [218.82742354273796, 1.0]], [0, [1288.5732549951167, 1.0]], [0, [0.5622705847687954, 1.0]], [0, [48.68403139205139, 1.0]], [0, [12.998161992545484, 1.0]], [0, [1.8842861935691528, 1.0]], [1, [2.5834815661843806, 1.0]], [1, [12.238254889484335, 1.0]], [1, [0.569010077600944, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2184.96900682]
bas 1, expnt(s) = [218.82742354]
bas 2, expnt(s) = [1288.573255]
bas 3, expnt(s) = [0.56227058]
bas 4, expnt(s) = [48.68403139]
bas 5, expnt(s) = [12.99816199]
bas 6, expnt(s) = [1.88428619]
bas 7, expnt(s) = [2.58348157]
bas 8, expnt(s) = [12.23825489]
bas 9, expnt(s) = [0.56901008]
CPU time:       237.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.18496901e+03 8.07419037e+02 2.18827424e+02 1.43744532e+02
 1.28857325e+03 5.43371504e+02 5.62270585e-01 1.64049174e+00
 4.86840314e+01 4.65644979e+01 1.29981620e+01 1.72952356e+01
 1.88428619e+00 4.06326525e+00 2.58348157e+00 9.55522904e+00
 1.22382549e+01 6.67780542e+01 5.69010078e-01 1.44173134e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.97188659070917
cond(S) = 102.36697327890273
E1 = -183.13676335738808  E_coul = 55.00424270711624
init E= -128.132520650272
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742509428429107  LUMO = 2.46423679614485
  mo_energy =
[-3.25199889e+01 -1.85417068e+00 -7.42509428e-01 -7.42509428e-01
 -7.42509428e-01  2.46423680e+00  2.46423680e+00  2.46423680e+00
  2.66019452e+00  1.81346269e+01  1.81346269e+01  1.81346269e+01
  4.39385522e+01  3.22201224e+02  1.91803390e+03  7.03318277e+03]
E1 = -181.94362247099764  E_coul = 53.74493166178989
cycle= 1 E= -128.198690809208  delta_E= -0.0662  |g|= 0.186  |ddm|= 0.191
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.293777
diis-c [-0.0863051  1.       ]
  HOMO = -0.820876948047458  LUMO = 2.40227662009463
  mo_energy =
[-3.28292137e+01 -1.93684884e+00 -8.20876948e-01 -8.20876948e-01
 -8.20876948e-01  2.40227662e+00  2.40227662e+00  2.40227662e+00
  2.59471955e+00  1.79234467e+01  1.79234467e+01  1.79234467e+01
  4.36725310e+01  3.21854482e+02  1.91763797e+03  7.03276176e+03]
E1 = -182.48901113557523  E_coul = 54.28817274531388
cycle= 2 E= -128.200838390261  delta_E= -0.00215  |g|= 0.0734  |ddm|= 0.0756
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.120442
diis-c [-4.15464632e-04  2.88275953e-01  7.11724047e-01]
  HOMO = -0.794270762569816  LUMO = 2.42484486633055
  mo_energy =
[-3.27430252e+01 -1.90916365e+00 -7.94270763e-01 -7.94270763e-01
 -7.94270763e-01  2.42484487e+00  2.42484487e+00  2.42484487e+00
  2.61771718e+00  1.79864855e+01  1.79864855e+01  1.79864855e+01
  4.37484708e+01  3.21948234e+02  1.91773784e+03  7.03286338e+03]
E1 = -182.33100258897133  E_coul = 54.129734522368715
cycle= 3 E= -128.201268066603  delta_E= -0.00043  |g|= 0.000583  |ddm|= 0.0215
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000579016
diis-c [-2.18696013e-07 -4.83085469e-03 -1.07548506e-02  1.01558571e+00]
  HOMO = -0.794353129460895  LUMO = 2.42481749420861
  mo_energy =
[-3.27432650e+01 -1.90936244e+00 -7.94353129e-01 -7.94353129e-01
 -7.94353129e-01  2.42481749e+00  2.42481749e+00  2.42481749e+00
  2.61757924e+00  1.79863110e+01  1.79863110e+01  1.79863110e+01
  4.37482182e+01  3.21948214e+02  1.91773802e+03  7.03286363e+03]
E1 = -182.331512033318  E_coul = 54.13024393836317
cycle= 4 E= -128.201268094955  delta_E= -2.84e-08  |g|= 8.67e-05  |ddm|= 0.00029
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000133247
diis-c [-4.46742645e-10  5.36520539e-04  8.52694578e-05 -1.84693311e-01
  1.18407152e+00]
  HOMO = -0.794330609637019  LUMO = 2.42483536422664
  mo_energy =
[-3.27432080e+01 -1.90936205e+00 -7.94330610e-01 -7.94330610e-01
 -7.94330610e-01  2.42483536e+00  2.42483536e+00  2.42483536e+00
  2.61757789e+00  1.79863536e+01  1.79863536e+01  1.79863536e+01
  4.37482628e+01  3.21948295e+02  1.91773813e+03  7.03286374e+03]
E1 = -182.33141377420466  E_coul = 54.13014567832799
cycle= 5 E= -128.201268095877  delta_E= -9.22e-10  |g|= 1.9e-06  |ddm|= 4.85e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.33141377420466  E_coul = 54.13014567832799
  HOMO = -0.794330431622165  LUMO = 2.42483554756558
  mo_energy =
[-3.27432076e+01 -1.90936233e+00 -7.94330432e-01 -7.94330432e-01
 -7.94330432e-01  2.42483555e+00  2.42483555e+00  2.42483555e+00
  2.61757767e+00  1.79863539e+01  1.79863539e+01  1.79863539e+01
  4.37482630e+01  3.21948295e+02  1.91773813e+03  7.03286374e+03]
E1 = -182.33141298875154  E_coul = 54.13014489287461
Extra cycle  E= -128.201268095877  delta_E= -2.27e-13  |g|= 3.72e-07  |ddm|= 1.08e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 102.36697327890273
E1 = -182.33141298875154  E_coul = 54.13014489287461
init E= -128.201268095877
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.794330467699156  LUMO = 2.42483551460036
  mo_energy =
[-3.27432077e+01 -1.90936246e+00 -7.94330468e-01 -7.94330468e-01
 -7.94330468e-01  2.42483551e+00  2.42483551e+00  2.42483551e+00
  2.61757756e+00  1.79863537e+01  1.79863537e+01  1.79863537e+01
  4.37482629e+01  3.21948295e+02  1.91773813e+03  7.03286374e+03]
E1 = -182.331413304436  E_coul = 54.130145208559114
cycle= 1 E= -128.201268095877  delta_E=    0  |g|= 7.4e-08  |ddm|= 2.21e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.331413304436  E_coul = 54.130145208559114
  HOMO = -0.794330442529029  LUMO = 2.42483553554439
  mo_energy =
[-3.27432077e+01 -1.90936245e+00 -7.94330443e-01 -7.94330443e-01
 -7.94330443e-01  2.42483554e+00  2.42483554e+00  2.42483554e+00
  2.61757757e+00  1.79863538e+01  1.79863538e+01  1.79863538e+01
  4.37482629e+01  3.21948295e+02  1.91773813e+03  7.03286374e+03]
E1 = -182.33141317576923  E_coul = 54.130145079892195
Extra cycle  E= -128.201268095877  delta_E= -1.14e-13  |g|= 2.19e-08  |ddm|= 3.47e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.18496901e+03 2.18827424e+02 1.28857325e+03 5.62270585e-01
 4.86840314e+01 1.29981620e+01 1.88428619e+00 2.58348157e+00
 1.22382549e+01 5.69010078e-01]
grad_E = [-1.50473636e-05  1.13193729e-05  4.41551047e-05 -2.63901444e-03
  1.57447873e-04 -2.03619509e-03  5.99841277e-04 -1.76332145e-02
 -2.48026081e-03 -4.49810369e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2216.51336279        1
[INPUT] 0    0    [1    /1   ]  212.192002616        1
[INPUT] 0    0    [1    /1   ]  1180.34794019        1
[INPUT] 0    0    [1    /1   ]  0.554595806783       1
[INPUT] 0    0    [1    /1   ]  47.7186746331        1
[INPUT] 0    0    [1    /1   ]  12.8223241515        1
[INPUT] 0    0    [1    /1   ]  1.85928170178        1
[INPUT] 1    0    [1    /1   ]  2.50215951379        1
[INPUT] 1    0    [1    /1   ]  11.7929313708        1
[INPUT] 1    0    [1    /1   ]  0.555466872409       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2216.513362793605, 1.0]], [0, [212.19200261584118, 1.0]], [0, [1180.3479401929803, 1.0]], [0, [0.5545958067831992, 1.0]], [0, [47.71867463305319, 1.0]], [0, [12.822324151523139, 1.0]], [0, [1.8592817017801213, 1.0]], [1, [2.502159513789451, 1.0]], [1, [11.792931370834912, 1.0]], [1, [0.5554668724086342, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2216.51336279]
bas 1, expnt(s) = [212.19200262]
bas 2, expnt(s) = [1180.34794019]
bas 3, expnt(s) = [0.55459581]
bas 4, expnt(s) = [47.71867463]
bas 5, expnt(s) = [12.82232415]
bas 6, expnt(s) = [1.8592817]
bas 7, expnt(s) = [2.50215951]
bas 8, expnt(s) = [11.79293137]
bas 9, expnt(s) = [0.55546687]
CPU time:       240.71
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.21651336e+03 8.16145874e+02 2.12192003e+02 1.40462949e+02
 1.18034794e+03 5.08771247e+02 5.54595807e-01 1.62366886e+00
 4.77186746e+01 4.58702708e+01 1.28223242e+01 1.71194610e+01
 1.85928170e+00 4.02275812e+00 2.50215951e+00 9.18074941e+00
 1.17929314e+01 6.37546119e+01 5.55466872e-01 1.39896580e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.974325111866111
cond(S) = 78.47254006128613
E1 = -183.13661878356737  E_coul = 54.99957682780221
init E= -128.137041955765
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742110007654661  LUMO = 2.38318170737757
  mo_energy =
[-3.25246219e+01 -1.85460367e+00 -7.42110008e-01 -7.42110008e-01
 -7.42110008e-01  2.38318171e+00  2.38318171e+00  2.38318171e+00
  2.59923844e+00  1.73940393e+01  1.73940393e+01  1.73940393e+01
  4.28736610e+01  3.12442989e+02  1.82725140e+03  6.79941910e+03]
E1 = -181.86014574100508  E_coul = 53.659350312304525
cycle= 1 E= -128.200795428701  delta_E= -0.0638  |g|= 0.195  |ddm|= 0.195
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.308741
diis-c [-0.09532097  1.        ]
  HOMO = -0.826346258223848  LUMO = 2.31816999006134
  mo_energy =
[-3.28497117e+01 -1.94401612e+00 -8.26346258e-01 -8.26346258e-01
 -8.26346258e-01  2.31816999e+00  2.31816999e+00  2.31816999e+00
  2.52932362e+00  1.71742570e+01  1.71742570e+01  1.71742570e+01
  4.25949408e+01  3.12080775e+02  1.82683994e+03  6.79898189e+03]
E1 = -182.44363286108208  E_coul = 54.240436839579104
cycle= 2 E= -128.203196021503  delta_E= -0.0024  |g|= 0.0783  |ddm|= 0.0807
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.128953
diis-c [-4.05726656e-04  2.92500840e-01  7.07499160e-01]
  HOMO = -0.797982840648496  LUMO = 2.34153273023326
  mo_energy =
[-3.27583710e+01 -1.91446567e+00 -7.97982841e-01 -7.97982841e-01
 -7.97982841e-01  2.34153273e+00  2.34153273e+00  2.34153273e+00
  2.55345857e+00  1.72402717e+01  1.72402717e+01  1.72402717e+01
  4.26750937e+01  3.12179798e+02  1.82694543e+03  6.79908932e+03]
E1 = -182.27367296837764  E_coul = 54.069982982453965
cycle= 3 E= -128.203689985924  delta_E= -0.000494  |g|= 0.000626  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000714126
diis-c [-3.06176628e-07 -5.49892283e-03 -1.49292652e-02  1.02042819e+00]
  HOMO = -0.797991746361955  LUMO = 2.34157219134739
  mo_energy =
[-3.27584065e+01 -1.91461173e+00 -7.97991746e-01 -7.97991746e-01
 -7.97991746e-01  2.34157219e+00  2.34157219e+00  2.34157219e+00
  2.55337010e+00  1.72402588e+01  1.72402588e+01  1.72402588e+01
  4.26750187e+01  3.12180007e+02  1.82694588e+03  6.79908984e+03]
E1 = -182.27378722131309  E_coul = 54.07009719790063
cycle= 4 E= -128.203690023412  delta_E= -3.75e-08  |g|= 0.000102  |ddm|= 0.000319
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000154749
diis-c [-6.27855000e-10  5.45500635e-04  5.22735618e-04 -1.86208287e-01
  1.18514005e+00]
  HOMO = -0.797966154292171  LUMO = 2.34159162773047
  mo_energy =
[-3.27583423e+01 -1.91461282e+00 -7.97966154e-01 -7.97966154e-01
 -7.97966154e-01  2.34159163e+00  2.34159163e+00  2.34159163e+00
  2.55336703e+00  1.72403060e+01  1.72403060e+01  1.72403060e+01
  4.26750679e+01  3.12180098e+02  1.82694600e+03  6.79908998e+03]
E1 = -182.27367536824195  E_coul = 54.06998534352159
cycle= 5 E= -128.20369002472  delta_E= -1.31e-09  |g|= 2.15e-06  |ddm|= 5.89e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.62885e-06
diis-c [-9.07944840e-14 -1.72784617e-05  7.27470026e-07  7.73410478e-03
 -7.05806161e-02  1.06286306e+00]
  HOMO = -0.797965905690036  LUMO = 2.34159187363028
  mo_energy =
[-3.27583418e+01 -1.91461321e+00 -7.97965906e-01 -7.97965906e-01
 -7.97965906e-01  2.34159187e+00  2.34159187e+00  2.34159187e+00
  2.55336672e+00  1.72403063e+01  1.72403063e+01  1.72403063e+01
  4.26750682e+01  3.12180098e+02  1.82694600e+03  6.79908998e+03]
E1 = -182.27367428339033  E_coul = 54.069984258669216
cycle= 6 E= -128.203690024721  delta_E= -7.39e-13  |g|= 5.52e-08  |ddm|= 1.52e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.27367428339033  E_coul = 54.069984258669216
  HOMO = -0.79796593624351  LUMO = 2.34159184698392
  mo_energy =
[-3.27583418e+01 -1.91461324e+00 -7.97965936e-01 -7.97965936e-01
 -7.97965936e-01  2.34159185e+00  2.34159185e+00  2.34159185e+00
  2.55336669e+00  1.72403063e+01  1.72403063e+01  1.72403063e+01
  4.26750681e+01  3.12180098e+02  1.82694600e+03  6.79908998e+03]
E1 = -182.2736744487177  E_coul = 54.069984423996544
Extra cycle  E= -128.203690024721  delta_E= -5.68e-14  |g|= 2.25e-08  |ddm|= 2.09e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.21651336e+03 2.12192003e+02 1.18034794e+03 5.54595807e-01
 4.77186746e+01 1.28223242e+01 1.85928170e+00 2.50215951e+00
 1.17929314e+01 5.55466872e-01]
E = -128.20369002472117
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2216.51336279        1
[INPUT] 0    0    [1    /1   ]  212.192002616        1
[INPUT] 0    0    [1    /1   ]  1180.34794019        1
[INPUT] 0    0    [1    /1   ]  0.554595806783       1
[INPUT] 0    0    [1    /1   ]  47.7186746331        1
[INPUT] 0    0    [1    /1   ]  12.8223241515        1
[INPUT] 0    0    [1    /1   ]  1.85928170178        1
[INPUT] 1    0    [1    /1   ]  2.50215951379        1
[INPUT] 1    0    [1    /1   ]  11.7929313708        1
[INPUT] 1    0    [1    /1   ]  0.555466872409       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2216.513362793605, 1.0]], [0, [212.19200261584118, 1.0]], [0, [1180.3479401929803, 1.0]], [0, [0.5545958067831992, 1.0]], [0, [47.71867463305319, 1.0]], [0, [12.822324151523139, 1.0]], [0, [1.8592817017801213, 1.0]], [1, [2.502159513789451, 1.0]], [1, [11.792931370834912, 1.0]], [1, [0.5554668724086342, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2216.51336279]
bas 1, expnt(s) = [212.19200262]
bas 2, expnt(s) = [1180.34794019]
bas 3, expnt(s) = [0.55459581]
bas 4, expnt(s) = [47.71867463]
bas 5, expnt(s) = [12.82232415]
bas 6, expnt(s) = [1.8592817]
bas 7, expnt(s) = [2.50215951]
bas 8, expnt(s) = [11.79293137]
bas 9, expnt(s) = [0.55546687]
CPU time:       241.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.21651336e+03 8.16145874e+02 2.12192003e+02 1.40462949e+02
 1.18034794e+03 5.08771247e+02 5.54595807e-01 1.62366886e+00
 4.77186746e+01 4.58702708e+01 1.28223242e+01 1.71194610e+01
 1.85928170e+00 4.02275812e+00 2.50215951e+00 9.18074941e+00
 1.17929314e+01 6.37546119e+01 5.55466872e-01 1.39896580e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.974325111866111
cond(S) = 78.47254006128613
E1 = -183.13661878356737  E_coul = 54.99957682780221
init E= -128.137041955765
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742110007654661  LUMO = 2.38318170737757
  mo_energy =
[-3.25246219e+01 -1.85460367e+00 -7.42110008e-01 -7.42110008e-01
 -7.42110008e-01  2.38318171e+00  2.38318171e+00  2.38318171e+00
  2.59923844e+00  1.73940393e+01  1.73940393e+01  1.73940393e+01
  4.28736610e+01  3.12442989e+02  1.82725140e+03  6.79941910e+03]
E1 = -181.86014574100508  E_coul = 53.659350312304525
cycle= 1 E= -128.200795428701  delta_E= -0.0638  |g|= 0.195  |ddm|= 0.195
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.308741
diis-c [-0.09532097  1.        ]
  HOMO = -0.826346258223848  LUMO = 2.31816999006134
  mo_energy =
[-3.28497117e+01 -1.94401612e+00 -8.26346258e-01 -8.26346258e-01
 -8.26346258e-01  2.31816999e+00  2.31816999e+00  2.31816999e+00
  2.52932362e+00  1.71742570e+01  1.71742570e+01  1.71742570e+01
  4.25949408e+01  3.12080775e+02  1.82683994e+03  6.79898189e+03]
E1 = -182.44363286108208  E_coul = 54.240436839579104
cycle= 2 E= -128.203196021503  delta_E= -0.0024  |g|= 0.0783  |ddm|= 0.0807
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.128953
diis-c [-4.05726656e-04  2.92500840e-01  7.07499160e-01]
  HOMO = -0.797982840648496  LUMO = 2.34153273023326
  mo_energy =
[-3.27583710e+01 -1.91446567e+00 -7.97982841e-01 -7.97982841e-01
 -7.97982841e-01  2.34153273e+00  2.34153273e+00  2.34153273e+00
  2.55345857e+00  1.72402717e+01  1.72402717e+01  1.72402717e+01
  4.26750937e+01  3.12179798e+02  1.82694543e+03  6.79908932e+03]
E1 = -182.27367296837764  E_coul = 54.069982982453965
cycle= 3 E= -128.203689985924  delta_E= -0.000494  |g|= 0.000626  |ddm|= 0.023
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000714126
diis-c [-3.06176628e-07 -5.49892283e-03 -1.49292652e-02  1.02042819e+00]
  HOMO = -0.797991746361955  LUMO = 2.34157219134739
  mo_energy =
[-3.27584065e+01 -1.91461173e+00 -7.97991746e-01 -7.97991746e-01
 -7.97991746e-01  2.34157219e+00  2.34157219e+00  2.34157219e+00
  2.55337010e+00  1.72402588e+01  1.72402588e+01  1.72402588e+01
  4.26750187e+01  3.12180007e+02  1.82694588e+03  6.79908984e+03]
E1 = -182.27378722131309  E_coul = 54.07009719790063
cycle= 4 E= -128.203690023412  delta_E= -3.75e-08  |g|= 0.000102  |ddm|= 0.000319
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000154749
diis-c [-6.27855000e-10  5.45500635e-04  5.22735618e-04 -1.86208287e-01
  1.18514005e+00]
  HOMO = -0.797966154292171  LUMO = 2.34159162773047
  mo_energy =
[-3.27583423e+01 -1.91461282e+00 -7.97966154e-01 -7.97966154e-01
 -7.97966154e-01  2.34159163e+00  2.34159163e+00  2.34159163e+00
  2.55336703e+00  1.72403060e+01  1.72403060e+01  1.72403060e+01
  4.26750679e+01  3.12180098e+02  1.82694600e+03  6.79908998e+03]
E1 = -182.27367536824195  E_coul = 54.06998534352159
cycle= 5 E= -128.20369002472  delta_E= -1.31e-09  |g|= 2.15e-06  |ddm|= 5.89e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.62885e-06
diis-c [-9.07944840e-14 -1.72784617e-05  7.27470026e-07  7.73410478e-03
 -7.05806161e-02  1.06286306e+00]
  HOMO = -0.797965905690036  LUMO = 2.34159187363028
  mo_energy =
[-3.27583418e+01 -1.91461321e+00 -7.97965906e-01 -7.97965906e-01
 -7.97965906e-01  2.34159187e+00  2.34159187e+00  2.34159187e+00
  2.55336672e+00  1.72403063e+01  1.72403063e+01  1.72403063e+01
  4.26750682e+01  3.12180098e+02  1.82694600e+03  6.79908998e+03]
E1 = -182.27367428339033  E_coul = 54.069984258669216
cycle= 6 E= -128.203690024721  delta_E= -7.39e-13  |g|= 5.52e-08  |ddm|= 1.52e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.27367428339033  E_coul = 54.069984258669216
  HOMO = -0.79796593624351  LUMO = 2.34159184698392
  mo_energy =
[-3.27583418e+01 -1.91461324e+00 -7.97965936e-01 -7.97965936e-01
 -7.97965936e-01  2.34159185e+00  2.34159185e+00  2.34159185e+00
  2.55336669e+00  1.72403063e+01  1.72403063e+01  1.72403063e+01
  4.26750681e+01  3.12180098e+02  1.82694600e+03  6.79908998e+03]
E1 = -182.2736744487177  E_coul = 54.069984423996544
Extra cycle  E= -128.203690024721  delta_E= -5.68e-14  |g|= 2.25e-08  |ddm|= 2.09e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 78.47254006128613
E1 = -182.2736744487177  E_coul = 54.069984423996544
init E= -128.203690024721
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.797965925014453  LUMO = 2.3415918562491
  mo_energy =
[-3.27583418e+01 -1.91461323e+00 -7.97965925e-01 -7.97965925e-01
 -7.97965925e-01  2.34159186e+00  2.34159186e+00  2.34159186e+00
  2.55336670e+00  1.72403063e+01  1.72403063e+01  1.72403063e+01
  4.26750682e+01  3.12180098e+02  1.82694600e+03  6.79908998e+03]
E1 = -182.2736743801748  E_coul = 54.069984355453876
cycle= 1 E= -128.203690024721  delta_E= 2.27e-13  |g|= 9.2e-09  |ddm|= 9.82e-09
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.2736743801748  E_coul = 54.069984355453876
  HOMO = -0.797965929746669  LUMO = 2.34159185235282
  mo_energy =
[-3.27583418e+01 -1.91461323e+00 -7.97965930e-01 -7.97965930e-01
 -7.97965930e-01  2.34159185e+00  2.34159185e+00  2.34159185e+00
  2.55336670e+00  1.72403063e+01  1.72403063e+01  1.72403063e+01
  4.26750682e+01  3.12180098e+02  1.82694600e+03  6.79908998e+03]
E1 = -182.27367440852484  E_coul = 54.06998438380379
Extra cycle  E= -128.203690024721  delta_E= -1.14e-13  |g|= 3.82e-09  |ddm|= 3.79e-09
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.21651336e+03 2.12192003e+02 1.18034794e+03 5.54595807e-01
 4.77186746e+01 1.28223242e+01 1.85928170e+00 2.50215951e+00
 1.17929314e+01 5.55466872e-01]
grad_E = [-1.91588614e-05  3.87615309e-05  5.24269763e-05 -3.69387074e-03
  1.58951916e-04 -2.80640007e-03  6.76985673e-04 -2.56444394e-02
 -3.81071261e-03 -5.60135337e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2342.69078668        1
[INPUT] 0    0    [1    /1   ]  185.650318908        1
[INPUT] 0    0    [1    /1   ]  747.446680984        1
[INPUT] 0    0    [1    /1   ]  0.523896694841       1
[INPUT] 0    0    [1    /1   ]  43.8572475971        1
[INPUT] 0    0    [1    /1   ]  12.1189727874        1
[INPUT] 0    0    [1    /1   ]  1.75926373462        1
[INPUT] 1    0    [1    /1   ]  2.17687130421        1
[INPUT] 1    0    [1    /1   ]  10.0116372962        1
[INPUT] 1    0    [1    /1   ]  0.501294051639       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2342.6907866761153, 1.0]], [0, [185.65031890825406, 1.0]], [0, [747.4466809844345, 1.0]], [0, [0.523896694840814, 1.0]], [0, [43.85724759706041, 1.0]], [0, [12.118972787433757, 1.0]], [0, [1.7592637346239957, 1.0]], [1, [2.1768713042097305, 1.0]], [1, [10.011637296237227, 1.0]], [1, [0.5012940516393951, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2342.69078668]
bas 1, expnt(s) = [185.65031891]
bas 2, expnt(s) = [747.44668098]
bas 3, expnt(s) = [0.52389669]
bas 4, expnt(s) = [43.8572476]
bas 5, expnt(s) = [12.11897279]
bas 6, expnt(s) = [1.75926373]
bas 7, expnt(s) = [2.1768713]
bas 8, expnt(s) = [10.0116373]
bas 9, expnt(s) = [0.50129405]
CPU time:       244.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34269079e+03 8.50748616e+02 1.85650319e+02 1.27068177e+02
 7.47446681e+02 3.61160452e+02 5.23896695e-01 1.55578388e+00
 4.38572476e+01 4.30572267e+01 1.21189728e+01 1.64102192e+01
 1.75926373e+00 3.85934174e+00 2.17687130e+00 7.71392364e+00
 1.00116373e+01 5.19536156e+01 5.01294052e-01 1.23055231e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.982245194557956
cond(S) = 54.109784172445956
E1 = -183.11109222594786  E_coul = 54.968080136447774
init E= -128.1430120895
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.738518891305106  LUMO = 2.06785925895619
  mo_energy =
[-3.25519838e+01 -1.85703016e+00 -7.38518891e-01 -7.38518891e-01
 -7.38518891e-01  2.06785926e+00  2.06785926e+00  2.06785926e+00
  2.36177384e+00  1.45099147e+01  1.45099147e+01  1.45099147e+01
  3.86194411e+01  2.72810361e+02  1.39752355e+03  5.74694700e+03]
E1 = -181.5110803169227  E_coul = 53.30815928705036
cycle= 1 E= -128.202921029872  delta_E= -0.0599  |g|= 0.233  |ddm|= 0.212
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.369671
diis-c [-0.13665657  1.        ]
  HOMO = -0.845717789466374  LUMO = 1.99397216942263
  mo_energy =
[-3.29401429e+01 -1.97321781e+00 -8.45717789e-01 -8.45717789e-01
 -8.45717789e-01  1.99397217e+00  1.99397217e+00  1.99397217e+00
  2.27603402e+00  1.42613959e+01  1.42613959e+01  1.42613959e+01
  3.82921040e+01  2.72389049e+02  1.39705535e+03  5.74644981e+03]
E1 = -182.25431749681266  E_coul = 54.047823980604356
cycle= 2 E= -128.206493516208  delta_E= -0.00357  |g|= 0.0986  |ddm|= 0.102
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.16442
diis-c [-3.29220128e-04  3.06802674e-01  6.93197326e-01]
  HOMO = -0.809997746959047  LUMO = 2.01984681796188
  mo_energy =
[-3.28277049e+01 -1.93579441e+00 -8.09997747e-01 -8.09997747e-01
 -8.09997747e-01  2.01984682e+00  2.01984682e+00  2.01984682e+00
  2.30453599e+00  1.43381631e+01  1.43381631e+01  1.43381631e+01
  3.83890323e+01  2.72509205e+02  1.39718330e+03  5.74658080e+03]
E1 = -182.03361284995418  E_coul = 53.82630744667391
cycle= 3 E= -128.20730540328  delta_E= -0.000812  |g|= 0.00129  |ddm|= 0.0292
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00210711
diis-c [-8.48732848e-07 -1.14264280e-02 -3.67359523e-02  1.04816238e+00]
  HOMO = -0.809673663603719  LUMO = 2.02014978662736
  mo_energy =
[-3.28268663e+01 -1.93570832e+00 -8.09673664e-01 -8.09673664e-01
 -8.09673664e-01  2.02014979e+00  2.02014979e+00  2.02014979e+00
  2.30465223e+00  1.43388182e+01  1.43388182e+01  1.43388182e+01
  3.83897008e+01  2.72510383e+02  1.39718486e+03  5.74658255e+03]
E1 = -182.031887755986  E_coul = 53.82458216704515
cycle= 4 E= -128.207305588941  delta_E= -1.86e-07  |g|= 0.000158  |ddm|= 0.000558
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000223657
diis-c [-2.40834682e-09  6.20564936e-04  2.14440838e-03 -1.74991507e-01
  1.17222653e+00]
  HOMO = -0.809641352014742  LUMO = 2.02016841974032
  mo_energy =
[-3.28267883e+01 -1.93572182e+00 -8.09641352e-01 -8.09641352e-01
 -8.09641352e-01  2.02016842e+00  2.02016842e+00  2.02016842e+00
  2.30463624e+00  1.43388701e+01  1.43388701e+01  1.43388701e+01
  3.83897529e+01  2.72510496e+02  1.39718502e+03  5.74658274e+03]
E1 = -182.03175082889894  E_coul = 53.82444523644322
cycle= 5 E= -128.207305592456  delta_E= -3.51e-09  |g|= 3.85e-06  |ddm|= 0.000104
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.20412e-06
diis-c [-2.17203174e-13 -6.53218559e-06 -3.65739964e-05  5.72126169e-03
 -6.25405368e-02  1.05686238e+00]
  HOMO = -0.809640761125857  LUMO = 2.02016894938505
  mo_energy =
[-3.28267869e+01 -1.93572234e+00 -8.09640761e-01 -8.09640761e-01
 -8.09640761e-01  2.02016895e+00  2.02016895e+00  2.02016895e+00
  2.30463586e+00  1.43388712e+01  1.43388712e+01  1.43388712e+01
  3.83897539e+01  2.72510497e+02  1.39718502e+03  5.74658274e+03]
E1 = -182.03174727204552  E_coul = 53.824441679587615
cycle= 6 E= -128.207305592458  delta_E= -2.19e-12  |g|= 1.15e-07  |ddm|= 2.72e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.03174727204552  E_coul = 53.824441679587615
  HOMO = -0.80964082705345  LUMO = 2.02016889990659
  mo_energy =
[-3.28267871e+01 -1.93572241e+00 -8.09640827e-01 -8.09640827e-01
 -8.09640827e-01  2.02016890e+00  2.02016890e+00  2.02016890e+00
  2.30463581e+00  1.43388711e+01  1.43388711e+01  1.43388711e+01
  3.83897538e+01  2.72510496e+02  1.39718502e+03  5.74658274e+03]
E1 = -182.03174763467908  E_coul = 53.824442042221314
Extra cycle  E= -128.207305592458  delta_E= 1.42e-13  |g|= 4.89e-08  |ddm|= 4.5e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.34269079e+03 1.85650319e+02 7.47446681e+02 5.23896695e-01
 4.38572476e+01 1.21189728e+01 1.75926373e+00 2.17687130e+00
 1.00116373e+01 5.01294052e-01]
E = -128.20730559245777
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2342.69078668        1
[INPUT] 0    0    [1    /1   ]  185.650318908        1
[INPUT] 0    0    [1    /1   ]  747.446680984        1
[INPUT] 0    0    [1    /1   ]  0.523896694841       1
[INPUT] 0    0    [1    /1   ]  43.8572475971        1
[INPUT] 0    0    [1    /1   ]  12.1189727874        1
[INPUT] 0    0    [1    /1   ]  1.75926373462        1
[INPUT] 1    0    [1    /1   ]  2.17687130421        1
[INPUT] 1    0    [1    /1   ]  10.0116372962        1
[INPUT] 1    0    [1    /1   ]  0.501294051639       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2342.6907866761153, 1.0]], [0, [185.65031890825406, 1.0]], [0, [747.4466809844345, 1.0]], [0, [0.523896694840814, 1.0]], [0, [43.85724759706041, 1.0]], [0, [12.118972787433757, 1.0]], [0, [1.7592637346239957, 1.0]], [1, [2.1768713042097305, 1.0]], [1, [10.011637296237227, 1.0]], [1, [0.5012940516393951, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2342.69078668]
bas 1, expnt(s) = [185.65031891]
bas 2, expnt(s) = [747.44668098]
bas 3, expnt(s) = [0.52389669]
bas 4, expnt(s) = [43.8572476]
bas 5, expnt(s) = [12.11897279]
bas 6, expnt(s) = [1.75926373]
bas 7, expnt(s) = [2.1768713]
bas 8, expnt(s) = [10.0116373]
bas 9, expnt(s) = [0.50129405]
CPU time:       245.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34269079e+03 8.50748616e+02 1.85650319e+02 1.27068177e+02
 7.47446681e+02 3.61160452e+02 5.23896695e-01 1.55578388e+00
 4.38572476e+01 4.30572267e+01 1.21189728e+01 1.64102192e+01
 1.75926373e+00 3.85934174e+00 2.17687130e+00 7.71392364e+00
 1.00116373e+01 5.19536156e+01 5.01294052e-01 1.23055231e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.982245194557956
cond(S) = 54.109784172445956
E1 = -183.11109222594786  E_coul = 54.968080136447774
init E= -128.1430120895
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.738518891305106  LUMO = 2.06785925895619
  mo_energy =
[-3.25519838e+01 -1.85703016e+00 -7.38518891e-01 -7.38518891e-01
 -7.38518891e-01  2.06785926e+00  2.06785926e+00  2.06785926e+00
  2.36177384e+00  1.45099147e+01  1.45099147e+01  1.45099147e+01
  3.86194411e+01  2.72810361e+02  1.39752355e+03  5.74694700e+03]
E1 = -181.5110803169227  E_coul = 53.30815928705036
cycle= 1 E= -128.202921029872  delta_E= -0.0599  |g|= 0.233  |ddm|= 0.212
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.369671
diis-c [-0.13665657  1.        ]
  HOMO = -0.845717789466374  LUMO = 1.99397216942263
  mo_energy =
[-3.29401429e+01 -1.97321781e+00 -8.45717789e-01 -8.45717789e-01
 -8.45717789e-01  1.99397217e+00  1.99397217e+00  1.99397217e+00
  2.27603402e+00  1.42613959e+01  1.42613959e+01  1.42613959e+01
  3.82921040e+01  2.72389049e+02  1.39705535e+03  5.74644981e+03]
E1 = -182.25431749681266  E_coul = 54.047823980604356
cycle= 2 E= -128.206493516208  delta_E= -0.00357  |g|= 0.0986  |ddm|= 0.102
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.16442
diis-c [-3.29220128e-04  3.06802674e-01  6.93197326e-01]
  HOMO = -0.809997746959047  LUMO = 2.01984681796188
  mo_energy =
[-3.28277049e+01 -1.93579441e+00 -8.09997747e-01 -8.09997747e-01
 -8.09997747e-01  2.01984682e+00  2.01984682e+00  2.01984682e+00
  2.30453599e+00  1.43381631e+01  1.43381631e+01  1.43381631e+01
  3.83890323e+01  2.72509205e+02  1.39718330e+03  5.74658080e+03]
E1 = -182.03361284995418  E_coul = 53.82630744667391
cycle= 3 E= -128.20730540328  delta_E= -0.000812  |g|= 0.00129  |ddm|= 0.0292
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00210711
diis-c [-8.48732848e-07 -1.14264280e-02 -3.67359523e-02  1.04816238e+00]
  HOMO = -0.809673663603719  LUMO = 2.02014978662736
  mo_energy =
[-3.28268663e+01 -1.93570832e+00 -8.09673664e-01 -8.09673664e-01
 -8.09673664e-01  2.02014979e+00  2.02014979e+00  2.02014979e+00
  2.30465223e+00  1.43388182e+01  1.43388182e+01  1.43388182e+01
  3.83897008e+01  2.72510383e+02  1.39718486e+03  5.74658255e+03]
E1 = -182.031887755986  E_coul = 53.82458216704515
cycle= 4 E= -128.207305588941  delta_E= -1.86e-07  |g|= 0.000158  |ddm|= 0.000558
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000223657
diis-c [-2.40834682e-09  6.20564936e-04  2.14440838e-03 -1.74991507e-01
  1.17222653e+00]
  HOMO = -0.809641352014742  LUMO = 2.02016841974032
  mo_energy =
[-3.28267883e+01 -1.93572182e+00 -8.09641352e-01 -8.09641352e-01
 -8.09641352e-01  2.02016842e+00  2.02016842e+00  2.02016842e+00
  2.30463624e+00  1.43388701e+01  1.43388701e+01  1.43388701e+01
  3.83897529e+01  2.72510496e+02  1.39718502e+03  5.74658274e+03]
E1 = -182.03175082889894  E_coul = 53.82444523644322
cycle= 5 E= -128.207305592456  delta_E= -3.51e-09  |g|= 3.85e-06  |ddm|= 0.000104
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.20412e-06
diis-c [-2.17203174e-13 -6.53218559e-06 -3.65739964e-05  5.72126169e-03
 -6.25405368e-02  1.05686238e+00]
  HOMO = -0.809640761125857  LUMO = 2.02016894938505
  mo_energy =
[-3.28267869e+01 -1.93572234e+00 -8.09640761e-01 -8.09640761e-01
 -8.09640761e-01  2.02016895e+00  2.02016895e+00  2.02016895e+00
  2.30463586e+00  1.43388712e+01  1.43388712e+01  1.43388712e+01
  3.83897539e+01  2.72510497e+02  1.39718502e+03  5.74658274e+03]
E1 = -182.03174727204552  E_coul = 53.824441679587615
cycle= 6 E= -128.207305592458  delta_E= -2.19e-12  |g|= 1.15e-07  |ddm|= 2.72e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.03174727204552  E_coul = 53.824441679587615
  HOMO = -0.80964082705345  LUMO = 2.02016889990659
  mo_energy =
[-3.28267871e+01 -1.93572241e+00 -8.09640827e-01 -8.09640827e-01
 -8.09640827e-01  2.02016890e+00  2.02016890e+00  2.02016890e+00
  2.30463581e+00  1.43388711e+01  1.43388711e+01  1.43388711e+01
  3.83897538e+01  2.72510496e+02  1.39718502e+03  5.74658274e+03]
E1 = -182.03174763467908  E_coul = 53.824442042221314
Extra cycle  E= -128.207305592458  delta_E= 1.42e-13  |g|= 4.89e-08  |ddm|= 4.5e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 54.109784172445956
E1 = -182.03174763467908  E_coul = 53.824442042221314
init E= -128.207305592458
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.80964080222769  LUMO = 2.02016891793717
  mo_energy =
[-3.28267870e+01 -1.93572238e+00 -8.09640802e-01 -8.09640802e-01
 -8.09640802e-01  2.02016892e+00  2.02016892e+00  2.02016892e+00
  2.30463583e+00  1.43388711e+01  1.43388711e+01  1.43388711e+01
  3.83897538e+01  2.72510497e+02  1.39718502e+03  5.74658274e+03]
E1 = -182.03174747780855  E_coul = 53.824441885350666
cycle= 1 E= -128.207305592458  delta_E= -1.14e-13  |g|= 2.08e-08  |ddm|= 2.19e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.03174747780855  E_coul = 53.824441885350666
  HOMO = -0.809640813127104  LUMO = 2.02016891004124
  mo_energy =
[-3.28267870e+01 -1.93572239e+00 -8.09640813e-01 -8.09640813e-01
 -8.09640813e-01  2.02016891e+00  2.02016891e+00  2.02016891e+00
  2.30463582e+00  1.43388711e+01  1.43388711e+01  1.43388711e+01
  3.83897538e+01  2.72510496e+02  1.39718502e+03  5.74658274e+03]
E1 = -182.03174754550042  E_coul = 53.8244419530427
Extra cycle  E= -128.207305592458  delta_E= 1.71e-13  |g|= 9.03e-09  |ddm|= 8.92e-09
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.34269079e+03 1.85650319e+02 7.47446681e+02 5.23896695e-01
 4.38572476e+01 1.21189728e+01 1.75926373e+00 2.17687130e+00
 1.00116373e+01 5.01294052e-01]
grad_E = [-2.70942511e-05  7.16409272e-04  3.72636804e-05 -6.30608682e-03
 -1.61570332e-03 -2.84184697e-03 -1.77821193e-03 -5.64822201e-02
 -1.35929330e-02  5.91208327e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2270.82400625        1
[INPUT] 0    0    [1    /1   ]  200.767645737        1
[INPUT] 0    0    [1    /1   ]  994.013925628        1
[INPUT] 0    0    [1    /1   ]  0.541381964943       1
[INPUT] 0    0    [1    /1   ]  46.05659769          1
[INPUT] 0    0    [1    /1   ]  12.5195800949        1
[INPUT] 0    0    [1    /1   ]  1.81623089296        1
[INPUT] 1    0    [1    /1   ]  2.36214546511        1
[INPUT] 1    0    [1    /1   ]  11.0262076227        1
[INPUT] 1    0    [1    /1   ]  0.532149224424       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2270.824006247196, 1.0]], [0, [200.767645736888, 1.0]], [0, [994.013925628075, 1.0]], [0, [0.5413819649425443, 1.0]], [0, [46.05659768996123, 1.0]], [0, [12.519580094922135, 1.0]], [0, [1.8162308929585105, 1.0]], [1, [2.3621454651067686, 1.0]], [1, [11.026207622682064, 1.0]], [1, [0.5321492244242134, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2270.82400625]
bas 1, expnt(s) = [200.76764574]
bas 2, expnt(s) = [994.01392563]
bas 3, expnt(s) = [0.54138196]
bas 4, expnt(s) = [46.05659769]
bas 5, expnt(s) = [12.51958009]
bas 6, expnt(s) = [1.81623089]
bas 7, expnt(s) = [2.36214547]
bas 8, expnt(s) = [11.02620762]
bas 9, expnt(s) = [0.53214922]
CPU time:       248.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.27082401e+03 8.31098755e+02 2.00767646e+02 1.34752031e+02
 9.94013926e+02 4.47259296e+02 5.41381965e-01 1.59456733e+00
 4.60565977e+01 4.46667047e+01 1.25195801e+01 1.68154056e+01
 1.81623089e+00 3.95269512e+00 2.36214547e+00 8.54314330e+00
 1.10262076e+01 5.86161244e+01 5.32149224e-01 1.32594706e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.97809767541514
cond(S) = 58.63406778278338
E1 = -183.13243444804476  E_coul = 54.988959129567604
init E= -128.143475318477
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.740992745249885  LUMO = 2.24566826141764
  mo_energy =
[-3.25347661e+01 -1.85550190e+00 -7.40992745e-01 -7.40992745e-01
 -7.40992745e-01  2.24566826e+00  2.24566826e+00  2.24566826e+00
  2.49576564e+00  1.61367303e+01  1.61367303e+01  1.61367303e+01
  4.10446354e+01  2.95561533e+02  1.65572052e+03  6.37057728e+03]
E1 = -181.71469556061652  E_coul = 53.51092104504017
cycle= 1 E= -128.203774515576  delta_E= -0.0603  |g|= 0.211  |ddm|= 0.202
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.334585
diis-c [-0.11194688  1.        ]
  HOMO = -0.835172682165475  LUMO = 2.17620440782411
  mo_energy =
[-3.28869668e+01 -1.95641936e+00 -8.35172682e-01 -8.35172682e-01
 -8.35172682e-01  2.17620441e+00  2.17620441e+00  2.17620441e+00
  2.41869430e+00  1.59034696e+01  1.59034696e+01  1.59034696e+01
  4.07446326e+01  2.95173434e+02  1.65528367e+03  6.37011352e+03]
E1 = -182.36536687329624  E_coul = 54.15872125064408
cycle= 2 E= -128.206645622652  delta_E= -0.00287  |g|= 0.0869  |ddm|= 0.0896
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.143923
diis-c [-3.74366272e-04  2.99211565e-01  7.00788435e-01]
  HOMO = -0.803718357438446  LUMO = 2.20077521048161
  mo_energy =
[-3.27866756e+01 -1.92357365e+00 -8.03718357e-01 -8.03718357e-01
 -8.03718357e-01  2.20077521e+00  2.20077521e+00  2.20077521e+00
  2.44473705e+00  1.59743381e+01  1.59743381e+01  1.59743381e+01
  4.08319983e+01  2.95281518e+02  1.65539882e+03  6.37023098e+03]
E1 = -182.1741763867993  E_coul = 53.96691252995646
cycle= 3 E= -128.207263856843  delta_E= -0.000618  |g|= 0.000846  |ddm|= 0.0256
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00123574
diis-c [-5.01333264e-07 -7.28627005e-03 -2.31116395e-02  1.03039791e+00]
  HOMO = -0.803589182785615  LUMO = 2.20093122625142
  mo_energy =
[-3.27863368e+01 -1.92362079e+00 -8.03589183e-01 -8.03589183e-01
 -8.03589183e-01  2.20093123e+00  2.20093123e+00  2.20093123e+00
  2.44473784e+00  1.59746152e+01  1.59746152e+01  1.59746152e+01
  4.08322451e+01  2.95282144e+02  1.65539975e+03  6.37023202e+03]
E1 = -182.1735322502389  E_coul = 53.96626831648641
cycle= 4 E= -128.207263933753  delta_E= -7.69e-08  |g|= 0.000128  |ddm|= 0.000399
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000189511
diis-c [-1.13237512e-09  5.68416355e-04  1.26267244e-03 -1.84771733e-01
  1.18294064e+00]
  HOMO = -0.803559149275181  LUMO = 2.20095204996434
  mo_energy =
[-3.27862626e+01 -1.92362562e+00 -8.03559149e-01 -8.03559149e-01
 -8.03559149e-01  2.20095205e+00  2.20095205e+00  2.20095205e+00
  2.44473065e+00  1.59746680e+01  1.59746680e+01  1.59746680e+01
  4.08322995e+01  2.95282250e+02  1.65539989e+03  6.37023218e+03]
E1 = -182.17340127196826  E_coul = 53.96613733606337
cycle= 5 E= -128.207263935905  delta_E= -2.15e-09  |g|= 2.74e-06  |ddm|= 7.79e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.54768e-06
diis-c [-1.20422913e-13 -1.36837878e-05 -2.28880204e-05  7.03243451e-03
 -6.64772246e-02  1.05948136e+00]
  HOMO = -0.803558760971597  LUMO = 2.20095241712616
  mo_energy =
[-3.27862617e+01 -1.92362604e+00 -8.03558761e-01 -8.03558761e-01
 -8.03558761e-01  2.20095242e+00  2.20095242e+00  2.20095242e+00
  2.44473034e+00  1.59746687e+01  1.59746687e+01  1.59746687e+01
  4.08323002e+01  2.95282250e+02  1.65539989e+03  6.37023218e+03]
E1 = -182.17339925614854  E_coul = 53.96613532024267
cycle= 6 E= -128.207263935906  delta_E= -9.66e-13  |g|= 8.07e-08  |ddm|= 1.92e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.17339925614854  E_coul = 53.96613532024267
  HOMO = -0.80355880620454  LUMO = 2.20095237991439
  mo_energy =
[-3.27862618e+01 -1.92362608e+00 -8.03558806e-01 -8.03558806e-01
 -8.03558806e-01  2.20095238e+00  2.20095238e+00  2.20095238e+00
  2.44473030e+00  1.59746686e+01  1.59746686e+01  1.59746686e+01
  4.08323000e+01  2.95282250e+02  1.65539989e+03  6.37023218e+03]
E1 = -182.17339950434868  E_coul = 53.9661355684428
Extra cycle  E= -128.207263935906  delta_E=    0  |g|= 3.36e-08  |ddm|= 3.12e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.27082401e+03 2.00767646e+02 9.94013926e+02 5.41381965e-01
 4.60565977e+01 1.25195801e+01 1.81623089e+00 2.36214547e+00
 1.10262076e+01 5.32149224e-01]
E = -128.20726393590587
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2270.82400625        1
[INPUT] 0    0    [1    /1   ]  200.767645737        1
[INPUT] 0    0    [1    /1   ]  994.013925628        1
[INPUT] 0    0    [1    /1   ]  0.541381964943       1
[INPUT] 0    0    [1    /1   ]  46.05659769          1
[INPUT] 0    0    [1    /1   ]  12.5195800949        1
[INPUT] 0    0    [1    /1   ]  1.81623089296        1
[INPUT] 1    0    [1    /1   ]  2.36214546511        1
[INPUT] 1    0    [1    /1   ]  11.0262076227        1
[INPUT] 1    0    [1    /1   ]  0.532149224424       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2270.824006247196, 1.0]], [0, [200.767645736888, 1.0]], [0, [994.013925628075, 1.0]], [0, [0.5413819649425443, 1.0]], [0, [46.05659768996123, 1.0]], [0, [12.519580094922135, 1.0]], [0, [1.8162308929585105, 1.0]], [1, [2.3621454651067686, 1.0]], [1, [11.026207622682064, 1.0]], [1, [0.5321492244242134, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2270.82400625]
bas 1, expnt(s) = [200.76764574]
bas 2, expnt(s) = [994.01392563]
bas 3, expnt(s) = [0.54138196]
bas 4, expnt(s) = [46.05659769]
bas 5, expnt(s) = [12.51958009]
bas 6, expnt(s) = [1.81623089]
bas 7, expnt(s) = [2.36214547]
bas 8, expnt(s) = [11.02620762]
bas 9, expnt(s) = [0.53214922]
CPU time:       249.70
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.27082401e+03 8.31098755e+02 2.00767646e+02 1.34752031e+02
 9.94013926e+02 4.47259296e+02 5.41381965e-01 1.59456733e+00
 4.60565977e+01 4.46667047e+01 1.25195801e+01 1.68154056e+01
 1.81623089e+00 3.95269512e+00 2.36214547e+00 8.54314330e+00
 1.10262076e+01 5.86161244e+01 5.32149224e-01 1.32594706e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.97809767541514
cond(S) = 58.63406778278338
E1 = -183.13243444804476  E_coul = 54.988959129567604
init E= -128.143475318477
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.740992745249885  LUMO = 2.24566826141764
  mo_energy =
[-3.25347661e+01 -1.85550190e+00 -7.40992745e-01 -7.40992745e-01
 -7.40992745e-01  2.24566826e+00  2.24566826e+00  2.24566826e+00
  2.49576564e+00  1.61367303e+01  1.61367303e+01  1.61367303e+01
  4.10446354e+01  2.95561533e+02  1.65572052e+03  6.37057728e+03]
E1 = -181.71469556061652  E_coul = 53.51092104504017
cycle= 1 E= -128.203774515576  delta_E= -0.0603  |g|= 0.211  |ddm|= 0.202
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.334585
diis-c [-0.11194688  1.        ]
  HOMO = -0.835172682165475  LUMO = 2.17620440782411
  mo_energy =
[-3.28869668e+01 -1.95641936e+00 -8.35172682e-01 -8.35172682e-01
 -8.35172682e-01  2.17620441e+00  2.17620441e+00  2.17620441e+00
  2.41869430e+00  1.59034696e+01  1.59034696e+01  1.59034696e+01
  4.07446326e+01  2.95173434e+02  1.65528367e+03  6.37011352e+03]
E1 = -182.36536687329624  E_coul = 54.15872125064408
cycle= 2 E= -128.206645622652  delta_E= -0.00287  |g|= 0.0869  |ddm|= 0.0896
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.143923
diis-c [-3.74366272e-04  2.99211565e-01  7.00788435e-01]
  HOMO = -0.803718357438446  LUMO = 2.20077521048161
  mo_energy =
[-3.27866756e+01 -1.92357365e+00 -8.03718357e-01 -8.03718357e-01
 -8.03718357e-01  2.20077521e+00  2.20077521e+00  2.20077521e+00
  2.44473705e+00  1.59743381e+01  1.59743381e+01  1.59743381e+01
  4.08319983e+01  2.95281518e+02  1.65539882e+03  6.37023098e+03]
E1 = -182.1741763867993  E_coul = 53.96691252995646
cycle= 3 E= -128.207263856843  delta_E= -0.000618  |g|= 0.000846  |ddm|= 0.0256
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00123574
diis-c [-5.01333264e-07 -7.28627005e-03 -2.31116395e-02  1.03039791e+00]
  HOMO = -0.803589182785615  LUMO = 2.20093122625142
  mo_energy =
[-3.27863368e+01 -1.92362079e+00 -8.03589183e-01 -8.03589183e-01
 -8.03589183e-01  2.20093123e+00  2.20093123e+00  2.20093123e+00
  2.44473784e+00  1.59746152e+01  1.59746152e+01  1.59746152e+01
  4.08322451e+01  2.95282144e+02  1.65539975e+03  6.37023202e+03]
E1 = -182.1735322502389  E_coul = 53.96626831648641
cycle= 4 E= -128.207263933753  delta_E= -7.69e-08  |g|= 0.000128  |ddm|= 0.000399
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000189511
diis-c [-1.13237512e-09  5.68416355e-04  1.26267244e-03 -1.84771733e-01
  1.18294064e+00]
  HOMO = -0.803559149275181  LUMO = 2.20095204996434
  mo_energy =
[-3.27862626e+01 -1.92362562e+00 -8.03559149e-01 -8.03559149e-01
 -8.03559149e-01  2.20095205e+00  2.20095205e+00  2.20095205e+00
  2.44473065e+00  1.59746680e+01  1.59746680e+01  1.59746680e+01
  4.08322995e+01  2.95282250e+02  1.65539989e+03  6.37023218e+03]
E1 = -182.17340127196826  E_coul = 53.96613733606337
cycle= 5 E= -128.207263935905  delta_E= -2.15e-09  |g|= 2.74e-06  |ddm|= 7.79e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.54768e-06
diis-c [-1.20422913e-13 -1.36837878e-05 -2.28880204e-05  7.03243451e-03
 -6.64772246e-02  1.05948136e+00]
  HOMO = -0.803558760971597  LUMO = 2.20095241712616
  mo_energy =
[-3.27862617e+01 -1.92362604e+00 -8.03558761e-01 -8.03558761e-01
 -8.03558761e-01  2.20095242e+00  2.20095242e+00  2.20095242e+00
  2.44473034e+00  1.59746687e+01  1.59746687e+01  1.59746687e+01
  4.08323002e+01  2.95282250e+02  1.65539989e+03  6.37023218e+03]
E1 = -182.17339925614854  E_coul = 53.96613532024267
cycle= 6 E= -128.207263935906  delta_E= -9.66e-13  |g|= 8.07e-08  |ddm|= 1.92e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.17339925614854  E_coul = 53.96613532024267
  HOMO = -0.80355880620454  LUMO = 2.20095237991439
  mo_energy =
[-3.27862618e+01 -1.92362608e+00 -8.03558806e-01 -8.03558806e-01
 -8.03558806e-01  2.20095238e+00  2.20095238e+00  2.20095238e+00
  2.44473030e+00  1.59746686e+01  1.59746686e+01  1.59746686e+01
  4.08323000e+01  2.95282250e+02  1.65539989e+03  6.37023218e+03]
E1 = -182.17339950434868  E_coul = 53.9661355684428
Extra cycle  E= -128.207263935906  delta_E=    0  |g|= 3.36e-08  |ddm|= 3.12e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 58.63406778278338
E1 = -182.17339950434868  E_coul = 53.9661355684428
init E= -128.207263935906
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.803558789271503  LUMO = 2.20095239316819
  mo_energy =
[-3.27862618e+01 -1.92362606e+00 -8.03558789e-01 -8.03558789e-01
 -8.03558789e-01  2.20095239e+00  2.20095239e+00  2.20095239e+00
  2.44473031e+00  1.59746686e+01  1.59746686e+01  1.59746686e+01
  4.08323001e+01  2.95282250e+02  1.65539989e+03  6.37023218e+03]
E1 = -182.17339939945734  E_coul = 53.96613546355146
cycle= 1 E= -128.207263935906  delta_E=    0  |g|= 1.4e-08  |ddm|= 1.48e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.17339939945734  E_coul = 53.96613546355146
  HOMO = -0.803558796530902  LUMO = 2.20095238749807
  mo_energy =
[-3.27862618e+01 -1.92362607e+00 -8.03558797e-01 -8.03558797e-01
 -8.03558797e-01  2.20095239e+00  2.20095239e+00  2.20095239e+00
  2.44473031e+00  1.59746686e+01  1.59746686e+01  1.59746686e+01
  4.08323001e+01  2.95282250e+02  1.65539989e+03  6.37023218e+03]
E1 = -182.17339944368837  E_coul = 53.96613550778252
Extra cycle  E= -128.207263935906  delta_E= 2.84e-14  |g|= 5.93e-09  |ddm|= 5.88e-09
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.27082401e+03 2.00767646e+02 9.94013926e+02 5.41381965e-01
 4.60565977e+01 1.25195801e+01 1.81623089e+00 2.36214547e+00
 1.10262076e+01 5.32149224e-01]
grad_E = [-2.55247439e-05  1.91768799e-04  6.26026714e-05 -5.09321690e-03
 -1.43208847e-04 -3.56946202e-03  1.86228832e-04 -3.94522629e-02
 -6.96719915e-03 -3.54224098e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2427.72465711        1
[INPUT] 0    0    [1    /1   ]  161.619718567        1
[INPUT] 0    0    [1    /1   ]  456.211144038        1
[INPUT] 0    0    [1    /1   ]  0.502069639545       1
[INPUT] 0    0    [1    /1   ]  40.4764084771        1
[INPUT] 0    0    [1    /1   ]  11.5364587706        1
[INPUT] 0    0    [1    /1   ]  1.69202716954        1
[INPUT] 1    0    [1    /1   ]  1.99457973396        1
[INPUT] 1    0    [1    /1   ]  9.03667230114        1
[INPUT] 1    0    [1    /1   ]  0.4699674985         1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2427.7246571095943, 1.0]], [0, [161.6197185670978, 1.0]], [0, [456.21114403809406, 1.0]], [0, [0.5020696395448327, 1.0]], [0, [40.47640847713046, 1.0]], [0, [11.5364587706073, 1.0]], [0, [1.6920271695402473, 1.0]], [1, [1.9945797339570972, 1.0]], [1, [9.036672301144575, 1.0]], [1, [0.4699674985003277, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2427.72465711]
bas 1, expnt(s) = [161.61971857]
bas 2, expnt(s) = [456.21114404]
bas 3, expnt(s) = [0.50206964]
bas 4, expnt(s) = [40.47640848]
bas 5, expnt(s) = [11.53645877]
bas 6, expnt(s) = [1.69202717]
bas 7, expnt(s) = [1.99457973]
bas 8, expnt(s) = [9.0366723]
bas 9, expnt(s) = [0.4699675]
CPU time:       252.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.42772466e+03 8.73805142e+02 1.61619719e+02 1.14521172e+02
 4.56211144e+02 2.49395976e+02 5.02069640e-01 1.50691236e+00
 4.04764085e+01 4.05430579e+01 1.15364588e+01 1.58150079e+01
 1.69202717e+00 3.74818073e+00 1.99457973e+00 6.91510287e+00
 9.03667230e+00 4.57082990e+01 4.69967499e-01 1.13519161e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.985453436957293
cond(S) = 71.4738124492626
E1 = -183.02395261181192  E_coul = 54.93608474411756
init E= -128.087867867694
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.734845254900097  LUMO = 1.89399667080321
  mo_energy =
[-3.25633916e+01 -1.85861054e+00 -7.34845255e-01 -7.34845255e-01
 -7.34845255e-01  1.89399667e+00  1.89399667e+00  1.89399667e+00
  2.20317807e+00  1.29709068e+01  1.29709068e+01  1.29709068e+01
  3.50863001e+01  2.36798535e+02  1.02508376e+03  4.89596466e+03]
E1 = -181.2540960027553  E_coul = 53.08229293177878
cycle= 1 E= -128.171803070977  delta_E= -0.0839  |g|= 0.258  |ddm|= 0.227
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.410116
diis-c [-0.16819476  1.        ]
  HOMO = -0.85577899816703  LUMO = 1.81680166704093
  mo_energy =
[-3.29903747e+01 -1.99097587e+00 -8.55778998e-01 -8.55778998e-01
 -8.55778998e-01  1.81680167e+00  1.81680167e+00  1.81680167e+00
  2.11011387e+00  1.27084753e+01  1.27084753e+01  1.27084753e+01
  3.47337943e+01  2.36344277e+02  1.02458424e+03  4.89542808e+03]
E1 = -182.09882949439321  E_coul = 53.92260896031997
cycle= 2 E= -128.176220534073  delta_E= -0.00442  |g|= 0.111  |ddm|= 0.115
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.186868
diis-c [-4.32963087e-04  3.11957427e-01  6.88042573e-01]
  HOMO = -0.815284180027681  LUMO = 1.8438281573125
  mo_energy =
[-3.28645233e+01 -1.94839777e+00 -8.15284180e-01 -8.15284180e-01
 -8.15284180e-01  1.84382816e+00  1.84382816e+00  1.84382816e+00
  2.14091891e+00  1.27911335e+01  1.27911335e+01  1.27911335e+01
  3.48402237e+01  2.36476911e+02  1.02472538e+03  4.89557389e+03]
E1 = -181.84515125134052  E_coul = 53.66787728823578
cycle= 3 E= -128.177273963105  delta_E= -0.00105  |g|= 0.00169  |ddm|= 0.0332
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0027632
diis-c [-1.49037070e-06 -1.28119525e-02 -4.09726282e-02  1.05378458e+00]
  HOMO = -0.814827380477144  LUMO = 1.84421733383559
  mo_energy =
[-3.28634182e+01 -1.94824823e+00 -8.14827380e-01 -8.14827380e-01
 -8.14827380e-01  1.84421733e+00  1.84421733e+00  1.84421733e+00
  2.14109434e+00  1.27920032e+01  1.27920032e+01  1.27920032e+01
  3.48411000e+01  2.36478352e+02  1.02472726e+03  4.89557608e+03]
E1 = -181.8427467705534  E_coul = 53.6654724822698
cycle= 4 E= -128.177274288284  delta_E= -3.25e-07  |g|= 0.000198  |ddm|= 0.000739
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000270957
diis-c [-5.21625695e-09  4.79280957e-04  2.04347319e-03 -1.67190020e-01
  1.16466727e+00]
  HOMO = -0.814791697048183  LUMO = 1.84423438038846
  mo_energy =
[-3.28633327e+01 -1.94827192e+00 -8.14791697e-01 -8.14791697e-01
 -8.14791697e-01  1.84423438e+00  1.84423438e+00  1.84423438e+00
  2.14106895e+00  1.27920560e+01  1.27920560e+01  1.27920560e+01
  3.48411498e+01  2.36478473e+02  1.02472743e+03  4.89557630e+03]
E1 = -181.8425987182945  E_coul = 53.66532442421018
cycle= 5 E= -128.177274294084  delta_E= -5.8e-09  |g|= 5.88e-06  |ddm|= 0.000138
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.79692e-06
diis-c [-3.96349668e-13  8.94305013e-07 -2.94374890e-05  5.79682659e-03
 -6.97156587e-02  1.06394738e+00]
  HOMO = -0.814790969008843  LUMO = 1.84423492670183
  mo_energy =
[-3.28633309e+01 -1.94827296e+00 -8.14790969e-01 -8.14790969e-01
 -8.14790969e-01  1.84423493e+00  1.84423493e+00  1.84423493e+00
  2.14106812e+00  1.27920572e+01  1.27920572e+01  1.27920572e+01
  3.48411510e+01  2.36478474e+02  1.02472743e+03  4.89557630e+03]
E1 = -181.84259396520912  E_coul = 53.665319671119235
cycle= 6 E= -128.17727429409  delta_E= -5.57e-12  |g|= 1.5e-07  |ddm|= 4.39e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -181.84259396520912  E_coul = 53.665319671119235
  HOMO = -0.814791056708108  LUMO = 1.84423486760208
  mo_energy =
[-3.28633311e+01 -1.94827305e+00 -8.14791057e-01 -8.14791057e-01
 -8.14791057e-01  1.84423487e+00  1.84423487e+00  1.84423487e+00
  2.14106806e+00  1.27920571e+01  1.27920571e+01  1.27920571e+01
  3.48411508e+01  2.36478474e+02  1.02472743e+03  4.89557630e+03]
E1 = -181.84259444303387  E_coul = 53.66532014894401
Extra cycle  E= -128.17727429409  delta_E= 2.84e-14  |g|= 6.41e-08  |ddm|= 5.83e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
exp = [2.42772466e+03 1.61619719e+02 4.56211144e+02 5.02069640e-01
 4.04764085e+01 1.15364588e+01 1.69202717e+00 1.99457973e+00
 9.03667230e+00 4.69967499e-01]
E = -128.17727429408987
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2427.72465711        1
[INPUT] 0    0    [1    /1   ]  161.619718567        1
[INPUT] 0    0    [1    /1   ]  456.211144038        1
[INPUT] 0    0    [1    /1   ]  0.502069639545       1
[INPUT] 0    0    [1    /1   ]  40.4764084771        1
[INPUT] 0    0    [1    /1   ]  11.5364587706        1
[INPUT] 0    0    [1    /1   ]  1.69202716954        1
[INPUT] 1    0    [1    /1   ]  1.99457973396        1
[INPUT] 1    0    [1    /1   ]  9.03667230114        1
[INPUT] 1    0    [1    /1   ]  0.4699674985         1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2427.7246571095943, 1.0]], [0, [161.6197185670978, 1.0]], [0, [456.21114403809406, 1.0]], [0, [0.5020696395448327, 1.0]], [0, [40.47640847713046, 1.0]], [0, [11.5364587706073, 1.0]], [0, [1.6920271695402473, 1.0]], [1, [1.9945797339570972, 1.0]], [1, [9.036672301144575, 1.0]], [1, [0.4699674985003277, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2427.72465711]
bas 1, expnt(s) = [161.61971857]
bas 2, expnt(s) = [456.21114404]
bas 3, expnt(s) = [0.50206964]
bas 4, expnt(s) = [40.47640848]
bas 5, expnt(s) = [11.53645877]
bas 6, expnt(s) = [1.69202717]
bas 7, expnt(s) = [1.99457973]
bas 8, expnt(s) = [9.0366723]
bas 9, expnt(s) = [0.4699675]
CPU time:       253.76
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.42772466e+03 8.73805142e+02 1.61619719e+02 1.14521172e+02
 4.56211144e+02 2.49395976e+02 5.02069640e-01 1.50691236e+00
 4.04764085e+01 4.05430579e+01 1.15364588e+01 1.58150079e+01
 1.69202717e+00 3.74818073e+00 1.99457973e+00 6.91510287e+00
 9.03667230e+00 4.57082990e+01 4.69967499e-01 1.13519161e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.985453436957293
cond(S) = 71.4738124492626
E1 = -183.02395261181192  E_coul = 54.93608474411756
init E= -128.087867867694
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.734845254900097  LUMO = 1.89399667080321
  mo_energy =
[-3.25633916e+01 -1.85861054e+00 -7.34845255e-01 -7.34845255e-01
 -7.34845255e-01  1.89399667e+00  1.89399667e+00  1.89399667e+00
  2.20317807e+00  1.29709068e+01  1.29709068e+01  1.29709068e+01
  3.50863001e+01  2.36798535e+02  1.02508376e+03  4.89596466e+03]
E1 = -181.2540960027553  E_coul = 53.08229293177878
cycle= 1 E= -128.171803070977  delta_E= -0.0839  |g|= 0.258  |ddm|= 0.227
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.410116
diis-c [-0.16819476  1.        ]
  HOMO = -0.85577899816703  LUMO = 1.81680166704093
  mo_energy =
[-3.29903747e+01 -1.99097587e+00 -8.55778998e-01 -8.55778998e-01
 -8.55778998e-01  1.81680167e+00  1.81680167e+00  1.81680167e+00
  2.11011387e+00  1.27084753e+01  1.27084753e+01  1.27084753e+01
  3.47337943e+01  2.36344277e+02  1.02458424e+03  4.89542808e+03]
E1 = -182.09882949439321  E_coul = 53.92260896031997
cycle= 2 E= -128.176220534073  delta_E= -0.00442  |g|= 0.111  |ddm|= 0.115
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.186868
diis-c [-4.32963087e-04  3.11957427e-01  6.88042573e-01]
  HOMO = -0.815284180027681  LUMO = 1.8438281573125
  mo_energy =
[-3.28645233e+01 -1.94839777e+00 -8.15284180e-01 -8.15284180e-01
 -8.15284180e-01  1.84382816e+00  1.84382816e+00  1.84382816e+00
  2.14091891e+00  1.27911335e+01  1.27911335e+01  1.27911335e+01
  3.48402237e+01  2.36476911e+02  1.02472538e+03  4.89557389e+03]
E1 = -181.84515125134052  E_coul = 53.66787728823578
cycle= 3 E= -128.177273963105  delta_E= -0.00105  |g|= 0.00169  |ddm|= 0.0332
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.0027632
diis-c [-1.49037070e-06 -1.28119525e-02 -4.09726282e-02  1.05378458e+00]
  HOMO = -0.814827380477144  LUMO = 1.84421733383559
  mo_energy =
[-3.28634182e+01 -1.94824823e+00 -8.14827380e-01 -8.14827380e-01
 -8.14827380e-01  1.84421733e+00  1.84421733e+00  1.84421733e+00
  2.14109434e+00  1.27920032e+01  1.27920032e+01  1.27920032e+01
  3.48411000e+01  2.36478352e+02  1.02472726e+03  4.89557608e+03]
E1 = -181.8427467705534  E_coul = 53.6654724822698
cycle= 4 E= -128.177274288284  delta_E= -3.25e-07  |g|= 0.000198  |ddm|= 0.000739
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000270957
diis-c [-5.21625695e-09  4.79280957e-04  2.04347319e-03 -1.67190020e-01
  1.16466727e+00]
  HOMO = -0.814791697048183  LUMO = 1.84423438038846
  mo_energy =
[-3.28633327e+01 -1.94827192e+00 -8.14791697e-01 -8.14791697e-01
 -8.14791697e-01  1.84423438e+00  1.84423438e+00  1.84423438e+00
  2.14106895e+00  1.27920560e+01  1.27920560e+01  1.27920560e+01
  3.48411498e+01  2.36478473e+02  1.02472743e+03  4.89557630e+03]
E1 = -181.8425987182945  E_coul = 53.66532442421018
cycle= 5 E= -128.177274294084  delta_E= -5.8e-09  |g|= 5.88e-06  |ddm|= 0.000138
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=7.79692e-06
diis-c [-3.96349668e-13  8.94305013e-07 -2.94374890e-05  5.79682659e-03
 -6.97156587e-02  1.06394738e+00]
  HOMO = -0.814790969008843  LUMO = 1.84423492670183
  mo_energy =
[-3.28633309e+01 -1.94827296e+00 -8.14790969e-01 -8.14790969e-01
 -8.14790969e-01  1.84423493e+00  1.84423493e+00  1.84423493e+00
  2.14106812e+00  1.27920572e+01  1.27920572e+01  1.27920572e+01
  3.48411510e+01  2.36478474e+02  1.02472743e+03  4.89557630e+03]
E1 = -181.84259396520912  E_coul = 53.665319671119235
cycle= 6 E= -128.17727429409  delta_E= -5.57e-12  |g|= 1.5e-07  |ddm|= 4.39e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -181.84259396520912  E_coul = 53.665319671119235
  HOMO = -0.814791056708108  LUMO = 1.84423486760208
  mo_energy =
[-3.28633311e+01 -1.94827305e+00 -8.14791057e-01 -8.14791057e-01
 -8.14791057e-01  1.84423487e+00  1.84423487e+00  1.84423487e+00
  2.14106806e+00  1.27920571e+01  1.27920571e+01  1.27920571e+01
  3.48411508e+01  2.36478474e+02  1.02472743e+03  4.89557630e+03]
E1 = -181.84259444303387  E_coul = 53.66532014894401
Extra cycle  E= -128.17727429409  delta_E= 2.84e-14  |g|= 6.41e-08  |ddm|= 5.83e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 71.4738124492626
E1 = -181.84259444303387  E_coul = 53.66532014894401
init E= -128.17727429409
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.814791023919453  LUMO = 1.844234889559
  mo_energy =
[-3.28633310e+01 -1.94827301e+00 -8.14791024e-01 -8.14791024e-01
 -8.14791024e-01  1.84423489e+00  1.84423489e+00  1.84423489e+00
  2.14106808e+00  1.27920571e+01  1.27920571e+01  1.27920571e+01
  3.48411509e+01  2.36478474e+02  1.02472743e+03  4.89557630e+03]
E1 = -181.8425942318633  E_coul = 53.6653199377737
cycle= 1 E= -128.17727429409  delta_E= 2.56e-13  |g|= 2.79e-08  |ddm|= 2.92e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -181.8425942318633  E_coul = 53.6653199377737
  HOMO = -0.814791038653961  LUMO = 1.84423487972467
  mo_energy =
[-3.28633310e+01 -1.94827303e+00 -8.14791039e-01 -8.14791039e-01
 -8.14791039e-01  1.84423488e+00  1.84423488e+00  1.84423488e+00
  2.14106807e+00  1.27920571e+01  1.27920571e+01  1.27920571e+01
  3.48411508e+01  2.36478474e+02  1.02472743e+03  4.89557630e+03]
E1 = -181.84259432488707  E_coul = 53.66532003079725
Extra cycle  E= -128.17727429409  delta_E= -2.27e-13  |g|= 1.23e-08  |ddm|= 1.21e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.42772466e+03 1.61619719e+02 4.56211144e+02 5.02069640e-01
 4.04764085e+01 1.15364588e+01 1.69202717e+00 1.99457973e+00
 9.03667230e+00 4.69967499e-01]
grad_E = [ 7.62850414e-06  1.81264286e-03 -2.75315535e-04 -8.68995161e-03
 -6.21365222e-03  2.79625352e-03 -5.37579755e-03 -7.08880010e-02
 -2.36339441e-02  1.41809423e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:48:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2320.45189684        1
[INPUT] 0    0    [1    /1   ]  188.385102797        1
[INPUT] 0    0    [1    /1   ]  823.906169805        1
[INPUT] 0    0    [1    /1   ]  0.528947422619       1
[INPUT] 0    0    [1    /1   ]  44.2915762052        1
[INPUT] 0    0    [1    /1   ]  12.2086174746        1
[INPUT] 0    0    [1    /1   ]  1.77694508526        1
[INPUT] 1    0    [1    /1   ]  2.24588392131        1
[INPUT] 1    0    [1    /1   ]  10.3969148777        1
[INPUT] 1    0    [1    /1   ]  0.512481059416       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2320.4518968402713, 1.0]], [0, [188.38510279745887, 1.0]], [0, [823.9061698048934, 1.0]], [0, [0.5289474226186376, 1.0]], [0, [44.29157620521357, 1.0]], [0, [12.208617474597476, 1.0]], [0, [1.7769450852631687, 1.0]], [1, [2.2458839213145927, 1.0]], [1, [10.396914877714975, 1.0]], [1, [0.5124810594161182, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2320.45189684]
bas 1, expnt(s) = [188.3851028]
bas 2, expnt(s) = [823.9061698]
bas 3, expnt(s) = [0.52894742]
bas 4, expnt(s) = [44.29157621]
bas 5, expnt(s) = [12.20861747]
bas 6, expnt(s) = [1.77694509]
bas 7, expnt(s) = [2.24588392]
bas 8, expnt(s) = [10.39691488]
bas 9, expnt(s) = [0.51248106]
CPU time:       256.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.32045190e+03 8.44684357e+02 1.88385103e+02 1.28469473e+02
 8.23906170e+02 3.88528911e+02 5.28947423e-01 1.56701951e+00
 4.42915762e+01 4.33766368e+01 1.22086175e+01 1.65011757e+01
 1.77694509e+00 3.88839637e+00 2.24588392e+00 8.02081547e+00
 1.03969149e+01 5.44646858e+01 5.12481059e-01 1.26497420e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.98087012867746
cond(S) = 53.59200513214565
E1 = -183.12481775810434  E_coul = 54.97688799082001
init E= -128.147929767284
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.739627002895859  LUMO = 2.1323284951708
  mo_energy =
[-3.25460630e+01 -1.85648794e+00 -7.39627003e-01 -7.39627003e-01
 -7.39627003e-01  2.13232850e+00  2.13232850e+00  2.13232850e+00
  2.40106846e+00  1.51166292e+01  1.51166292e+01  1.51166292e+01
  3.91768439e+01  2.77580294e+02  1.47487761e+03  5.93974409e+03]
E1 = -181.58816997926127  E_coul = 53.38175247392749
cycle= 1 E= -128.206417505334  delta_E= -0.0585  |g|= 0.225  |ddm|= 0.209
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.357189
diis-c [-0.12758378  1.        ]
  HOMO = -0.842219771715156  LUMO = 2.05973053485516
  mo_energy =
[-3.29213682e+01 -1.96719303e+00 -8.42219772e-01 -8.42219772e-01
 -8.42219772e-01  2.05973053e+00  2.05973053e+00  2.05973053e+00
  2.31858541e+00  1.48728911e+01  1.48728911e+01  1.48728911e+01
  3.88598045e+01  2.77171158e+02  1.47442063e+03  5.93925875e+03]
E1 = -182.29794367151385  E_coul = 54.08821497921414
cycle= 2 E= -128.2097286923  delta_E= -0.00331  |g|= 0.0944  |ddm|= 0.0975
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.157057
diis-c [-3.39845933e-04  3.04225344e-01  6.95774656e-01]
  HOMO = -0.808042588801902  LUMO = 2.08520640759018
  mo_energy =
[-3.28132893e+01 -1.93143187e+00 -8.08042589e-01 -8.08042589e-01
 -8.08042589e-01  2.08520641e+00  2.08520641e+00  2.08520641e+00
  2.34614537e+00  1.49477093e+01  1.49477093e+01  1.49477093e+01
  3.89531590e+01  2.77286919e+02  1.47454401e+03  5.93938490e+03]
E1 = -182.08792186376573  E_coul = 53.87745429218774
cycle= 3 E= -128.210467571578  delta_E= -0.000739  |g|= 0.00111  |ddm|= 0.0279
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00177191
diis-c [-7.05263898e-07 -9.68524868e-03 -3.13678305e-02  1.04105308e+00]
  HOMO = -0.807791688439931  LUMO = 2.08545677942718
  mo_energy =
[-3.28126335e+01 -1.93139384e+00 -8.07791688e-01 -8.07791688e-01
 -8.07791688e-01  2.08545678e+00  2.08545678e+00  2.08545678e+00
  2.34622039e+00  1.49482274e+01  1.49482274e+01  1.49482274e+01
  3.89536730e+01  2.77287891e+02  1.47454534e+03  5.93938638e+03]
E1 = -182.08660109766612  E_coul = 53.87613338939621
cycle= 4 E= -128.21046770827  delta_E= -1.37e-07  |g|= 0.000147  |ddm|= 0.000491
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000212027
diis-c [-1.83757050e-09  6.00324524e-04  1.84538054e-03 -1.79584394e-01
  1.17713869e+00]
  HOMO = -0.807759779068303  LUMO = 2.08547670186943
  mo_energy =
[-3.28125561e+01 -1.93140362e+00 -8.07759779e-01 -8.07759779e-01
 -8.07759779e-01  2.08547670e+00  2.08547670e+00  2.08547670e+00
  2.34620812e+00  1.49482806e+01  1.49482806e+01  1.49482806e+01
  3.89537267e+01  2.77288002e+02  1.47454549e+03  5.93938656e+03]
E1 = -182.08646439635464  E_coul = 53.87599668511409
cycle= 5 E= -128.210467711241  delta_E= -2.97e-09  |g|= 3.41e-06  |ddm|= 9.42e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.57572e-06
diis-c [-1.76105756e-13 -9.32610915e-06 -3.40045334e-05  6.20912707e-03
 -6.37236804e-02  1.05755788e+00]
  HOMO = -0.807759247322295  LUMO = 2.08547718602017
  mo_energy =
[-3.28125548e+01 -1.93140408e+00 -8.07759247e-01 -8.07759247e-01
 -8.07759247e-01  2.08547719e+00  2.08547719e+00  2.08547719e+00
  2.34620778e+00  1.49482815e+01  1.49482815e+01  1.49482815e+01
  3.89537276e+01  2.77288002e+02  1.47454549e+03  5.93938656e+03]
E1 = -182.08646137317498  E_coul = 53.87599366193279
cycle= 6 E= -128.210467711242  delta_E= -1.65e-12  |g|= 1.03e-07  |ddm|= 2.39e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.08646137317498  E_coul = 53.87599366193279
  HOMO = -0.807759305940566  LUMO = 2.08547714043026
  mo_energy =
[-3.28125550e+01 -1.93140413e+00 -8.07759306e-01 -8.07759306e-01
 -8.07759306e-01  2.08547714e+00  2.08547714e+00  2.08547714e+00
  2.34620774e+00  1.49482814e+01  1.49482814e+01  1.49482814e+01
  3.89537274e+01  2.77288002e+02  1.47454549e+03  5.93938656e+03]
E1 = -182.08646169595914  E_coul = 53.87599398471691
Extra cycle  E= -128.210467711242  delta_E= -5.68e-14  |g|= 4.36e-08  |ddm|= 4.04e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.32045190e+03 1.88385103e+02 8.23906170e+02 5.28947423e-01
 4.42915762e+01 1.22086175e+01 1.77694509e+00 2.24588392e+00
 1.03969149e+01 5.12481059e-01]
E = -128.21046771124225
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2320.45189684        1
[INPUT] 0    0    [1    /1   ]  188.385102797        1
[INPUT] 0    0    [1    /1   ]  823.906169805        1
[INPUT] 0    0    [1    /1   ]  0.528947422619       1
[INPUT] 0    0    [1    /1   ]  44.2915762052        1
[INPUT] 0    0    [1    /1   ]  12.2086174746        1
[INPUT] 0    0    [1    /1   ]  1.77694508526        1
[INPUT] 1    0    [1    /1   ]  2.24588392131        1
[INPUT] 1    0    [1    /1   ]  10.3969148777        1
[INPUT] 1    0    [1    /1   ]  0.512481059416       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2320.4518968402713, 1.0]], [0, [188.38510279745887, 1.0]], [0, [823.9061698048934, 1.0]], [0, [0.5289474226186376, 1.0]], [0, [44.29157620521357, 1.0]], [0, [12.208617474597476, 1.0]], [0, [1.7769450852631687, 1.0]], [1, [2.2458839213145927, 1.0]], [1, [10.396914877714975, 1.0]], [1, [0.5124810594161182, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2320.45189684]
bas 1, expnt(s) = [188.3851028]
bas 2, expnt(s) = [823.9061698]
bas 3, expnt(s) = [0.52894742]
bas 4, expnt(s) = [44.29157621]
bas 5, expnt(s) = [12.20861747]
bas 6, expnt(s) = [1.77694509]
bas 7, expnt(s) = [2.24588392]
bas 8, expnt(s) = [10.39691488]
bas 9, expnt(s) = [0.51248106]
CPU time:       257.69
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.32045190e+03 8.44684357e+02 1.88385103e+02 1.28469473e+02
 8.23906170e+02 3.88528911e+02 5.28947423e-01 1.56701951e+00
 4.42915762e+01 4.33766368e+01 1.22086175e+01 1.65011757e+01
 1.77694509e+00 3.88839637e+00 2.24588392e+00 8.02081547e+00
 1.03969149e+01 5.44646858e+01 5.12481059e-01 1.26497420e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.98087012867746
cond(S) = 53.59200513214565
E1 = -183.12481775810434  E_coul = 54.97688799082001
init E= -128.147929767284
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.739627002895859  LUMO = 2.1323284951708
  mo_energy =
[-3.25460630e+01 -1.85648794e+00 -7.39627003e-01 -7.39627003e-01
 -7.39627003e-01  2.13232850e+00  2.13232850e+00  2.13232850e+00
  2.40106846e+00  1.51166292e+01  1.51166292e+01  1.51166292e+01
  3.91768439e+01  2.77580294e+02  1.47487761e+03  5.93974409e+03]
E1 = -181.58816997926127  E_coul = 53.38175247392749
cycle= 1 E= -128.206417505334  delta_E= -0.0585  |g|= 0.225  |ddm|= 0.209
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.357189
diis-c [-0.12758378  1.        ]
  HOMO = -0.842219771715156  LUMO = 2.05973053485516
  mo_energy =
[-3.29213682e+01 -1.96719303e+00 -8.42219772e-01 -8.42219772e-01
 -8.42219772e-01  2.05973053e+00  2.05973053e+00  2.05973053e+00
  2.31858541e+00  1.48728911e+01  1.48728911e+01  1.48728911e+01
  3.88598045e+01  2.77171158e+02  1.47442063e+03  5.93925875e+03]
E1 = -182.29794367151385  E_coul = 54.08821497921414
cycle= 2 E= -128.2097286923  delta_E= -0.00331  |g|= 0.0944  |ddm|= 0.0975
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.157057
diis-c [-3.39845933e-04  3.04225344e-01  6.95774656e-01]
  HOMO = -0.808042588801902  LUMO = 2.08520640759018
  mo_energy =
[-3.28132893e+01 -1.93143187e+00 -8.08042589e-01 -8.08042589e-01
 -8.08042589e-01  2.08520641e+00  2.08520641e+00  2.08520641e+00
  2.34614537e+00  1.49477093e+01  1.49477093e+01  1.49477093e+01
  3.89531590e+01  2.77286919e+02  1.47454401e+03  5.93938490e+03]
E1 = -182.08792186376573  E_coul = 53.87745429218774
cycle= 3 E= -128.210467571578  delta_E= -0.000739  |g|= 0.00111  |ddm|= 0.0279
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00177191
diis-c [-7.05263898e-07 -9.68524868e-03 -3.13678305e-02  1.04105308e+00]
  HOMO = -0.807791688439931  LUMO = 2.08545677942718
  mo_energy =
[-3.28126335e+01 -1.93139384e+00 -8.07791688e-01 -8.07791688e-01
 -8.07791688e-01  2.08545678e+00  2.08545678e+00  2.08545678e+00
  2.34622039e+00  1.49482274e+01  1.49482274e+01  1.49482274e+01
  3.89536730e+01  2.77287891e+02  1.47454534e+03  5.93938638e+03]
E1 = -182.08660109766612  E_coul = 53.87613338939621
cycle= 4 E= -128.21046770827  delta_E= -1.37e-07  |g|= 0.000147  |ddm|= 0.000491
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000212027
diis-c [-1.83757050e-09  6.00324524e-04  1.84538054e-03 -1.79584394e-01
  1.17713869e+00]
  HOMO = -0.807759779068303  LUMO = 2.08547670186943
  mo_energy =
[-3.28125561e+01 -1.93140362e+00 -8.07759779e-01 -8.07759779e-01
 -8.07759779e-01  2.08547670e+00  2.08547670e+00  2.08547670e+00
  2.34620812e+00  1.49482806e+01  1.49482806e+01  1.49482806e+01
  3.89537267e+01  2.77288002e+02  1.47454549e+03  5.93938656e+03]
E1 = -182.08646439635464  E_coul = 53.87599668511409
cycle= 5 E= -128.210467711241  delta_E= -2.97e-09  |g|= 3.41e-06  |ddm|= 9.42e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.57572e-06
diis-c [-1.76105756e-13 -9.32610915e-06 -3.40045334e-05  6.20912707e-03
 -6.37236804e-02  1.05755788e+00]
  HOMO = -0.807759247322295  LUMO = 2.08547718602017
  mo_energy =
[-3.28125548e+01 -1.93140408e+00 -8.07759247e-01 -8.07759247e-01
 -8.07759247e-01  2.08547719e+00  2.08547719e+00  2.08547719e+00
  2.34620778e+00  1.49482815e+01  1.49482815e+01  1.49482815e+01
  3.89537276e+01  2.77288002e+02  1.47454549e+03  5.93938656e+03]
E1 = -182.08646137317498  E_coul = 53.87599366193279
cycle= 6 E= -128.210467711242  delta_E= -1.65e-12  |g|= 1.03e-07  |ddm|= 2.39e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.08646137317498  E_coul = 53.87599366193279
  HOMO = -0.807759305940566  LUMO = 2.08547714043026
  mo_energy =
[-3.28125550e+01 -1.93140413e+00 -8.07759306e-01 -8.07759306e-01
 -8.07759306e-01  2.08547714e+00  2.08547714e+00  2.08547714e+00
  2.34620774e+00  1.49482814e+01  1.49482814e+01  1.49482814e+01
  3.89537274e+01  2.77288002e+02  1.47454549e+03  5.93938656e+03]
E1 = -182.08646169595914  E_coul = 53.87599398471691
Extra cycle  E= -128.210467711242  delta_E= -5.68e-14  |g|= 4.36e-08  |ddm|= 4.04e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 53.59200513214565
E1 = -182.08646169595914  E_coul = 53.87599398471691
init E= -128.210467711242
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.807759283860167  LUMO = 2.08547715692722
  mo_energy =
[-3.28125549e+01 -1.93140411e+00 -8.07759284e-01 -8.07759284e-01
 -8.07759284e-01  2.08547716e+00  2.08547716e+00  2.08547716e+00
  2.34620776e+00  1.49482814e+01  1.49482814e+01  1.49482814e+01
  3.89537275e+01  2.77288002e+02  1.47454549e+03  5.93938656e+03]
E1 = -182.08646155743  E_coul = 53.87599384618778
cycle= 1 E= -128.210467711242  delta_E= 2.84e-14  |g|= 1.84e-08  |ddm|= 1.93e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.08646155743  E_coul = 53.87599384618778
  HOMO = -0.807759293470526  LUMO = 2.08547714976314
  mo_energy =
[-3.28125549e+01 -1.93140412e+00 -8.07759293e-01 -8.07759293e-01
 -8.07759293e-01  2.08547715e+00  2.08547715e+00  2.08547715e+00
  2.34620775e+00  1.49482814e+01  1.49482814e+01  1.49482814e+01
  3.89537275e+01  2.77288002e+02  1.47454549e+03  5.93938656e+03]
E1 = -182.0864616167373  E_coul = 53.87599390549495
Extra cycle  E= -128.210467711242  delta_E= -1.42e-13  |g|= 7.93e-09  |ddm|= 7.84e-09
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.32045190e+03 1.88385103e+02 8.23906170e+02 5.28947423e-01
 4.42915762e+01 1.22086175e+01 1.77694509e+00 2.24588392e+00
 1.03969149e+01 5.12481059e-01]
grad_E = [-2.86083509e-05  4.44345836e-04  5.97846872e-05 -6.16636803e-03
 -7.74788264e-04 -3.51188243e-03 -7.95494872e-04 -5.06807165e-02
 -1.05501871e-02 -7.44023041e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2386.2909232         1
[INPUT] 0    0    [1    /1   ]  166.194859454        1
[INPUT] 0    0    [1    /1   ]  598.7073388          1
[INPUT] 0    0    [1    /1   ]  0.510579340849       1
[INPUT] 0    0    [1    /1   ]  41.2145651434        1
[INPUT] 0    0    [1    /1   ]  11.6892541424        1
[INPUT] 0    0    [1    /1   ]  1.72111255486        1
[INPUT] 1    0    [1    /1   ]  2.11122739324        1
[INPUT] 1    0    [1    /1   ]  9.68337302145        1
[INPUT] 1    0    [1    /1   ]  0.489147899178       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2386.2909231957833, 1.0]], [0, [166.1948594539418, 1.0]], [0, [598.7073387999717, 1.0]], [0, [0.5105793408486802, 1.0]], [0, [41.21456514335296, 1.0]], [0, [11.689254142418571, 1.0]], [0, [1.7211125548598705, 1.0]], [1, [2.1112273932436527, 1.0]], [1, [9.683373021454829, 1.0]], [1, [0.4891478991783805, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2386.2909232]
bas 1, expnt(s) = [166.19485945]
bas 2, expnt(s) = [598.7073388]
bas 3, expnt(s) = [0.51057934]
bas 4, expnt(s) = [41.21456514]
bas 5, expnt(s) = [11.68925414]
bas 6, expnt(s) = [1.72111255]
bas 7, expnt(s) = [2.11122739]
bas 8, expnt(s) = [9.68337302]
bas 9, expnt(s) = [0.4891479]
CPU time:       260.52
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.38629092e+03 8.62596251e+02 1.66194859e+02 1.16944073e+02
 5.98707339e+02 3.05791888e+02 5.10579341e-01 1.52602783e+00
 4.12145651e+01 4.10963324e+01 1.16892541e+01 1.59718464e+01
 1.72111255e+00 3.79640012e+00 2.11122739e+00 7.42425975e+00
 9.68337302e+00 4.98330788e+01 4.89147899e-01 1.19339615e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.98367524447617
cond(S) = 58.01281774785431
E1 = -183.10453116433487  E_coul = 54.95808673781598
init E= -128.146444426519
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.737505993393861  LUMO = 2.00124746267792
  mo_energy =
[-3.25620347e+01 -1.85791934e+00 -7.37505993e-01 -7.37505993e-01
 -7.37505993e-01  2.00124746e+00  2.00124746e+00  2.00124746e+00
  2.26605209e+00  1.39683205e+01  1.39683205e+01  1.39683205e+01
  3.60907174e+01  2.46447219e+02  1.18998580e+03  5.29605991e+03]
E1 = -181.42883962176737  E_coul = 53.22130950511414
cycle= 1 E= -128.207530116653  delta_E= -0.0611  |g|= 0.242  |ddm|= 0.218
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.385973
diis-c [-0.14897529  1.        ]
  HOMO = -0.850237103380168  LUMO = 1.9255852212392
  mo_energy =
[-3.29653969e+01 -1.98043879e+00 -8.50237103e-01 -8.50237103e-01
 -8.50237103e-01  1.92558522e+00  1.92558522e+00  1.92558522e+00
  2.17841579e+00  1.37129684e+01  1.37129684e+01  1.37129684e+01
  3.57559536e+01  2.46014864e+02  1.18950698e+03  5.29554923e+03]
E1 = -182.2121562630534  E_coul = 54.00073274115354
cycle= 2 E= -128.2114235219  delta_E= -0.00389  |g|= 0.104  |ddm|= 0.107
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.173415
diis-c [-3.20746112e-04  3.09092184e-01  6.90907816e-01]
  HOMO = -0.812639999383068  LUMO = 1.9520296310709
  mo_energy =
[-3.28476469e+01 -1.94100486e+00 -8.12639999e-01 -8.12639999e-01
 -8.12639999e-01  1.95202963e+00  1.95202963e+00  1.95202963e+00
  2.20752110e+00  1.37924004e+01  1.37924004e+01  1.37924004e+01
  3.58559691e+01  2.46139613e+02  1.18964014e+03  5.29568612e+03]
E1 = -181.9784648643413  E_coul = 53.76613805677349
cycle= 3 E= -128.212326807568  delta_E= -0.000903  |g|= 0.00144  |ddm|= 0.0308
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00236705
diis-c [-1.00581321e-06 -1.32147041e-02 -4.13634945e-02  1.05457820e+00]
  HOMO = -0.812257258404027  LUMO = 1.95237378451892
  mo_energy =
[-3.28466768e+01 -1.94088271e+00 -8.12257258e-01 -8.12257258e-01
 -8.12257258e-01  1.95237378e+00  1.95237378e+00  1.95237378e+00
  2.20766786e+00  1.37931587e+01  1.37931587e+01  1.37931587e+01
  3.58567362e+01  2.46140907e+02  1.18964185e+03  5.29568807e+03]
E1 = -181.9764265531708  E_coul = 53.76409951298093
cycle= 4 E= -128.21232704019  delta_E= -2.33e-07  |g|= 0.000166  |ddm|= 0.000621
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000228976
diis-c [-3.29141744e-09  6.21960476e-04  2.31424827e-03 -1.69304352e-01
  1.16636814e+00]
  HOMO = -0.812226039649468  LUMO = 1.95238997501528
  mo_energy =
[-3.28466030e+01 -1.94090094e+00 -8.12226040e-01 -8.12226040e-01
 -8.12226040e-01  1.95238998e+00  1.95238998e+00  1.95238998e+00
  2.20764755e+00  1.37932062e+01  1.37932062e+01  1.37932062e+01
  3.58567811e+01  2.46141012e+02  1.18964201e+03  5.29568826e+03]
E1 = -181.9763005535043  E_coul = 53.76397350931381
cycle= 5 E= -128.21232704419  delta_E= -4e-09  |g|= 4.58e-06  |ddm|= 0.000113
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.32976e-06
diis-c [-2.71689209e-13 -1.78187800e-06 -3.32866191e-05  5.22311234e-03
 -6.32849817e-02  1.05809694e+00]
  HOMO = -0.812225285037538  LUMO = 1.9523906139968
  mo_energy =
[-3.28466012e+01 -1.94090151e+00 -8.12225285e-01 -8.12225285e-01
 -8.12225285e-01  1.95239061e+00  1.95239061e+00  1.95239061e+00
  2.20764713e+00  1.37932075e+01  1.37932075e+01  1.37932075e+01
  3.58567824e+01  2.46141014e+02  1.18964201e+03  5.29568826e+03]
E1 = -181.97629600497677  E_coul = 53.76396896078309
cycle= 6 E= -128.212327044194  delta_E= -3.18e-12  |g|= 1.29e-07  |ddm|= 3.26e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -181.97629600497677  E_coul = 53.76396896078309
  HOMO = -0.812225359619387  LUMO = 1.95239056053098
  mo_energy =
[-3.28466014e+01 -1.94090158e+00 -8.12225360e-01 -8.12225360e-01
 -8.12225360e-01  1.95239056e+00  1.95239056e+00  1.95239056e+00
  2.20764707e+00  1.37932074e+01  1.37932074e+01  1.37932074e+01
  3.58567822e+01  2.46141013e+02  1.18964201e+03  5.29568826e+03]
E1 = -181.97629641308583  E_coul = 53.763969368892226
Extra cycle  E= -128.212327044194  delta_E= 5.68e-14  |g|= 5.49e-08  |ddm|= 5.04e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.38629092e+03 1.66194859e+02 5.98707339e+02 5.10579341e-01
 4.12145651e+01 1.16892541e+01 1.72111255e+00 2.11122739e+00
 9.68337302e+00 4.89147899e-01]
E = -128.21232704419361
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2386.2909232         1
[INPUT] 0    0    [1    /1   ]  166.194859454        1
[INPUT] 0    0    [1    /1   ]  598.7073388          1
[INPUT] 0    0    [1    /1   ]  0.510579340849       1
[INPUT] 0    0    [1    /1   ]  41.2145651434        1
[INPUT] 0    0    [1    /1   ]  11.6892541424        1
[INPUT] 0    0    [1    /1   ]  1.72111255486        1
[INPUT] 1    0    [1    /1   ]  2.11122739324        1
[INPUT] 1    0    [1    /1   ]  9.68337302145        1
[INPUT] 1    0    [1    /1   ]  0.489147899178       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2386.2909231957833, 1.0]], [0, [166.1948594539418, 1.0]], [0, [598.7073387999717, 1.0]], [0, [0.5105793408486802, 1.0]], [0, [41.21456514335296, 1.0]], [0, [11.689254142418571, 1.0]], [0, [1.7211125548598705, 1.0]], [1, [2.1112273932436527, 1.0]], [1, [9.683373021454829, 1.0]], [1, [0.4891478991783805, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2386.2909232]
bas 1, expnt(s) = [166.19485945]
bas 2, expnt(s) = [598.7073388]
bas 3, expnt(s) = [0.51057934]
bas 4, expnt(s) = [41.21456514]
bas 5, expnt(s) = [11.68925414]
bas 6, expnt(s) = [1.72111255]
bas 7, expnt(s) = [2.11122739]
bas 8, expnt(s) = [9.68337302]
bas 9, expnt(s) = [0.4891479]
CPU time:       261.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.38629092e+03 8.62596251e+02 1.66194859e+02 1.16944073e+02
 5.98707339e+02 3.05791888e+02 5.10579341e-01 1.52602783e+00
 4.12145651e+01 4.10963324e+01 1.16892541e+01 1.59718464e+01
 1.72111255e+00 3.79640012e+00 2.11122739e+00 7.42425975e+00
 9.68337302e+00 4.98330788e+01 4.89147899e-01 1.19339615e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.98367524447617
cond(S) = 58.01281774785431
E1 = -183.10453116433487  E_coul = 54.95808673781598
init E= -128.146444426519
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.737505993393861  LUMO = 2.00124746267792
  mo_energy =
[-3.25620347e+01 -1.85791934e+00 -7.37505993e-01 -7.37505993e-01
 -7.37505993e-01  2.00124746e+00  2.00124746e+00  2.00124746e+00
  2.26605209e+00  1.39683205e+01  1.39683205e+01  1.39683205e+01
  3.60907174e+01  2.46447219e+02  1.18998580e+03  5.29605991e+03]
E1 = -181.42883962176737  E_coul = 53.22130950511414
cycle= 1 E= -128.207530116653  delta_E= -0.0611  |g|= 0.242  |ddm|= 0.218
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.385973
diis-c [-0.14897529  1.        ]
  HOMO = -0.850237103380168  LUMO = 1.9255852212392
  mo_energy =
[-3.29653969e+01 -1.98043879e+00 -8.50237103e-01 -8.50237103e-01
 -8.50237103e-01  1.92558522e+00  1.92558522e+00  1.92558522e+00
  2.17841579e+00  1.37129684e+01  1.37129684e+01  1.37129684e+01
  3.57559536e+01  2.46014864e+02  1.18950698e+03  5.29554923e+03]
E1 = -182.2121562630534  E_coul = 54.00073274115354
cycle= 2 E= -128.2114235219  delta_E= -0.00389  |g|= 0.104  |ddm|= 0.107
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.173415
diis-c [-3.20746112e-04  3.09092184e-01  6.90907816e-01]
  HOMO = -0.812639999383068  LUMO = 1.9520296310709
  mo_energy =
[-3.28476469e+01 -1.94100486e+00 -8.12639999e-01 -8.12639999e-01
 -8.12639999e-01  1.95202963e+00  1.95202963e+00  1.95202963e+00
  2.20752110e+00  1.37924004e+01  1.37924004e+01  1.37924004e+01
  3.58559691e+01  2.46139613e+02  1.18964014e+03  5.29568612e+03]
E1 = -181.9784648643413  E_coul = 53.76613805677349
cycle= 3 E= -128.212326807568  delta_E= -0.000903  |g|= 0.00144  |ddm|= 0.0308
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00236705
diis-c [-1.00581321e-06 -1.32147041e-02 -4.13634945e-02  1.05457820e+00]
  HOMO = -0.812257258404027  LUMO = 1.95237378451892
  mo_energy =
[-3.28466768e+01 -1.94088271e+00 -8.12257258e-01 -8.12257258e-01
 -8.12257258e-01  1.95237378e+00  1.95237378e+00  1.95237378e+00
  2.20766786e+00  1.37931587e+01  1.37931587e+01  1.37931587e+01
  3.58567362e+01  2.46140907e+02  1.18964185e+03  5.29568807e+03]
E1 = -181.9764265531708  E_coul = 53.76409951298093
cycle= 4 E= -128.21232704019  delta_E= -2.33e-07  |g|= 0.000166  |ddm|= 0.000621
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000228976
diis-c [-3.29141744e-09  6.21960476e-04  2.31424827e-03 -1.69304352e-01
  1.16636814e+00]
  HOMO = -0.812226039649468  LUMO = 1.95238997501528
  mo_energy =
[-3.28466030e+01 -1.94090094e+00 -8.12226040e-01 -8.12226040e-01
 -8.12226040e-01  1.95238998e+00  1.95238998e+00  1.95238998e+00
  2.20764755e+00  1.37932062e+01  1.37932062e+01  1.37932062e+01
  3.58567811e+01  2.46141012e+02  1.18964201e+03  5.29568826e+03]
E1 = -181.9763005535043  E_coul = 53.76397350931381
cycle= 5 E= -128.21232704419  delta_E= -4e-09  |g|= 4.58e-06  |ddm|= 0.000113
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.32976e-06
diis-c [-2.71689209e-13 -1.78187800e-06 -3.32866191e-05  5.22311234e-03
 -6.32849817e-02  1.05809694e+00]
  HOMO = -0.812225285037538  LUMO = 1.9523906139968
  mo_energy =
[-3.28466012e+01 -1.94090151e+00 -8.12225285e-01 -8.12225285e-01
 -8.12225285e-01  1.95239061e+00  1.95239061e+00  1.95239061e+00
  2.20764713e+00  1.37932075e+01  1.37932075e+01  1.37932075e+01
  3.58567824e+01  2.46141014e+02  1.18964201e+03  5.29568826e+03]
E1 = -181.97629600497677  E_coul = 53.76396896078309
cycle= 6 E= -128.212327044194  delta_E= -3.18e-12  |g|= 1.29e-07  |ddm|= 3.26e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -181.97629600497677  E_coul = 53.76396896078309
  HOMO = -0.812225359619387  LUMO = 1.95239056053098
  mo_energy =
[-3.28466014e+01 -1.94090158e+00 -8.12225360e-01 -8.12225360e-01
 -8.12225360e-01  1.95239056e+00  1.95239056e+00  1.95239056e+00
  2.20764707e+00  1.37932074e+01  1.37932074e+01  1.37932074e+01
  3.58567822e+01  2.46141013e+02  1.18964201e+03  5.29568826e+03]
E1 = -181.97629641308583  E_coul = 53.763969368892226
Extra cycle  E= -128.212327044194  delta_E= 5.68e-14  |g|= 5.49e-08  |ddm|= 5.04e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 58.01281774785431
E1 = -181.97629641308583  E_coul = 53.763969368892226
init E= -128.212327044194
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.812225331645523  LUMO = 1.95239058026236
  mo_energy =
[-3.28466013e+01 -1.94090155e+00 -8.12225332e-01 -8.12225332e-01
 -8.12225332e-01  1.95239058e+00  1.95239058e+00  1.95239058e+00
  2.20764709e+00  1.37932074e+01  1.37932074e+01  1.37932074e+01
  3.58567823e+01  2.46141014e+02  1.18964201e+03  5.29568826e+03]
E1 = -181.97629623490508  E_coul = 53.7639691907113
cycle= 1 E= -128.212327044194  delta_E= -1.71e-13  |g|= 2.36e-08  |ddm|= 2.47e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -181.97629623490508  E_coul = 53.7639691907113
  HOMO = -0.812225344046522  LUMO = 1.95239057153879
  mo_energy =
[-3.28466013e+01 -1.94090157e+00 -8.12225344e-01 -8.12225344e-01
 -8.12225344e-01  1.95239057e+00  1.95239057e+00  1.95239057e+00
  2.20764708e+00  1.37932074e+01  1.37932074e+01  1.37932074e+01
  3.58567822e+01  2.46141014e+02  1.18964201e+03  5.29568826e+03]
E1 = -181.97629631245738  E_coul = 53.763969268263615
Extra cycle  E= -128.212327044194  delta_E= 2.84e-14  |g|= 1.03e-08  |ddm|= 1.02e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.38629092e+03 1.66194859e+02 5.98707339e+02 5.10579341e-01
 4.12145651e+01 1.16892541e+01 1.72111255e+00 2.11122739e+00
 9.68337302e+00 4.89147899e-01]
grad_E = [-2.13220435e-05  1.01550424e-03 -1.77418926e-05 -7.67905831e-03
 -2.39601253e-03 -1.75033071e-03 -3.05791991e-03 -6.36210641e-02
 -1.59752767e-02  2.57911143e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2348.80428392        1
[INPUT] 0    0    [1    /1   ]  178.829275449        1
[INPUT] 0    0    [1    /1   ]  726.928362266        1
[INPUT] 0    0    [1    /1   ]  0.52103754009        1
[INPUT] 0    0    [1    /1   ]  42.9665169888        1
[INPUT] 0    0    [1    /1   ]  11.9849630398        1
[INPUT] 0    0    [1    /1   ]  1.75290181486        1
[INPUT] 1    0    [1    /1   ]  2.18789652056        1
[INPUT] 1    0    [1    /1   ]  10.08964097          1
[INPUT] 1    0    [1    /1   ]  0.502433055558       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2348.804283919669, 1.0]], [0, [178.8292754487338, 1.0]], [0, [726.9283622655972, 1.0]], [0, [0.5210375400903662, 1.0]], [0, [42.96651698877882, 1.0]], [0, [11.984963039775332, 1.0]], [0, [1.75290181486198, 1.0]], [1, [2.1878965205589997, 1.0]], [1, [10.089640970035958, 1.0]], [1, [0.5024330555578325, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2348.80428392]
bas 1, expnt(s) = [178.82927545]
bas 2, expnt(s) = [726.92836227]
bas 3, expnt(s) = [0.52103754]
bas 4, expnt(s) = [42.96651699]
bas 5, expnt(s) = [11.98496304]
bas 6, expnt(s) = [1.75290181]
bas 7, expnt(s) = [2.18789652]
bas 8, expnt(s) = [10.08964097]
bas 9, expnt(s) = [0.50243306]
CPU time:       264.43
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34880428e+03 8.52413162e+02 1.78829275e+02 1.23550352e+02
 7.26928362e+02 3.53698921e+02 5.21037540e-01 1.54941154e+00
 4.29665170e+01 4.23996856e+01 1.19849630e+01 1.62739339e+01
 1.75290181e+00 3.84886978e+00 2.18789652e+00 7.76279048e+00
 1.00896410e+01 5.24600902e+01 5.02433056e-01 1.23404827e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.982151189277811
cond(S) = 54.021684522590405
E1 = -183.11980580406842  E_coul = 54.96947774121723
init E= -128.150328062851
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.738800109729392  LUMO = 2.07556137929596
  mo_energy =
[-3.25531250e+01 -1.85710082e+00 -7.38800110e-01 -7.38800110e-01
 -7.38800110e-01  2.07556138e+00  2.07556138e+00  2.07556138e+00
  2.34240456e+00  1.46193804e+01  1.46193804e+01  1.46193804e+01
  3.78474907e+01  2.64209491e+02  1.35571685e+03  5.66973583e+03]
E1 = -181.5218690115268  E_coul = 53.31338763943476
cycle= 1 E= -128.208481372092  delta_E= -0.0582  |g|= 0.232  |ddm|= 0.212
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.36941
diis-c [-0.1364637  1.       ]
  HOMO = -0.845765145772233  LUMO = 2.00152204318777
  mo_energy =
[-3.29404886e+01 -1.97287996e+00 -8.45765146e-01 -8.45765146e-01
 -8.45765146e-01  2.00152204e+00  2.00152204e+00  2.00152204e+00
  2.25761979e+00  1.43704092e+01  1.43704092e+01  1.43704092e+01
  3.75226192e+01  2.63790191e+02  1.35525019e+03  5.66923957e+03]
E1 = -182.26305220713348  E_coul = 54.051015866612396
cycle= 2 E= -128.212036340521  delta_E= -0.00355  |g|= 0.0984  |ddm|= 0.102
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.164044
diis-c [-3.24152548e-04  3.06476365e-01  6.93523635e-01]
  HOMO = -0.810132064272135  LUMO = 2.02743928323144
  mo_energy =
[-3.28282772e+01 -1.93555772e+00 -8.10132064e-01 -8.10132064e-01
 -8.10132064e-01  2.02743928e+00  2.02743928e+00  2.02743928e+00
  2.28585711e+00  1.44472575e+01  1.44472575e+01  1.44472575e+01
  3.76188735e+01  2.63909843e+02  1.35537781e+03  5.66937031e+03]
E1 = -182.04295404934808  E_coul = 53.83011056196621
cycle= 3 E= -128.212843487382  delta_E= -0.000807  |g|= 0.00126  |ddm|= 0.0291
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00203694
diis-c [-8.20355408e-07 -1.12301803e-02 -3.59132023e-02  1.04714338e+00]
  HOMO = -0.80982183739104  LUMO = 2.02773308769911
  mo_energy =
[-3.28274747e+01 -1.93547987e+00 -8.09821837e-01 -8.09821837e-01
 -8.09821837e-01  2.02773309e+00  2.02773309e+00  2.02773309e+00
  2.28596613e+00  1.44478870e+01  1.44478870e+01  1.44478870e+01
  3.76195074e+01  2.63910968e+02  1.35537932e+03  5.66937201e+03]
E1 = -182.04130608405035  E_coul = 53.828462421762076
cycle= 4 E= -128.212843662288  delta_E= -1.75e-07  |g|= 0.000155  |ddm|= 0.000544
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000219435
diis-c [-2.35275081e-09  6.17956070e-04  2.09837976e-03 -1.75517596e-01
  1.17280126e+00]
  HOMO = -0.809790026883306  LUMO = 2.02775158172099
  mo_energy =
[-3.28273985e+01 -1.93549301e+00 -8.09790027e-01 -8.09790027e-01
 -8.09790027e-01  2.02775158e+00  2.02775158e+00  2.02775158e+00
  2.28595060e+00  1.44479382e+01  1.44479382e+01  1.44479382e+01
  3.76195577e+01  2.63911077e+02  1.35537948e+03  5.66937219e+03]
E1 = -182.04117282980243  E_coul = 53.82832916413034
cycle= 5 E= -128.212843665672  delta_E= -3.38e-09  |g|= 3.85e-06  |ddm|= 0.000102
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.25367e-06
diis-c [-2.12958580e-13 -6.27616863e-06 -3.54410984e-05  5.73483244e-03
 -6.28853848e-02  1.05719227e+00]
  HOMO = -0.809789399721804  LUMO = 2.02775213792958
  mo_energy =
[-3.28273970e+01 -1.93549350e+00 -8.09789400e-01 -8.09789400e-01
 -8.09789400e-01  2.02775214e+00  2.02775214e+00  2.02775214e+00
  2.28595025e+00  1.44479393e+01  1.44479393e+01  1.44479393e+01
  3.76195588e+01  2.63911078e+02  1.35537948e+03  5.66937219e+03]
E1 = -182.04116915829786  E_coul = 53.828325492623655
cycle= 6 E= -128.212843665674  delta_E= -2.1e-12  |g|= 1.15e-07  |ddm|= 2.71e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.04116915829786  E_coul = 53.828325492623655
  HOMO = -0.809789465327635  LUMO = 2.02775208857151
  mo_energy =
[-3.28273971e+01 -1.93549356e+00 -8.09789465e-01 -8.09789465e-01
 -8.09789465e-01  2.02775209e+00  2.02775209e+00  2.02775209e+00
  2.28595020e+00  1.44479391e+01  1.44479391e+01  1.44479391e+01
  3.76195587e+01  2.63911078e+02  1.35537948e+03  5.66937219e+03]
E1 = -182.0411695190024  E_coul = 53.8283258533281
Extra cycle  E= -128.212843665674  delta_E= -1.14e-13  |g|= 4.86e-08  |ddm|= 4.49e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.34880428e+03 1.78829275e+02 7.26928362e+02 5.21037540e-01
 4.29665170e+01 1.19849630e+01 1.75290181e+00 2.18789652e+00
 1.00896410e+01 5.02433056e-01]
E = -128.2128436656743
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:08 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2348.80428392        1
[INPUT] 0    0    [1    /1   ]  178.829275449        1
[INPUT] 0    0    [1    /1   ]  726.928362266        1
[INPUT] 0    0    [1    /1   ]  0.52103754009        1
[INPUT] 0    0    [1    /1   ]  42.9665169888        1
[INPUT] 0    0    [1    /1   ]  11.9849630398        1
[INPUT] 0    0    [1    /1   ]  1.75290181486        1
[INPUT] 1    0    [1    /1   ]  2.18789652056        1
[INPUT] 1    0    [1    /1   ]  10.08964097          1
[INPUT] 1    0    [1    /1   ]  0.502433055558       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2348.804283919669, 1.0]], [0, [178.8292754487338, 1.0]], [0, [726.9283622655972, 1.0]], [0, [0.5210375400903662, 1.0]], [0, [42.96651698877882, 1.0]], [0, [11.984963039775332, 1.0]], [0, [1.75290181486198, 1.0]], [1, [2.1878965205589997, 1.0]], [1, [10.089640970035958, 1.0]], [1, [0.5024330555578325, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2348.80428392]
bas 1, expnt(s) = [178.82927545]
bas 2, expnt(s) = [726.92836227]
bas 3, expnt(s) = [0.52103754]
bas 4, expnt(s) = [42.96651699]
bas 5, expnt(s) = [11.98496304]
bas 6, expnt(s) = [1.75290181]
bas 7, expnt(s) = [2.18789652]
bas 8, expnt(s) = [10.08964097]
bas 9, expnt(s) = [0.50243306]
CPU time:       265.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.34880428e+03 8.52413162e+02 1.78829275e+02 1.23550352e+02
 7.26928362e+02 3.53698921e+02 5.21037540e-01 1.54941154e+00
 4.29665170e+01 4.23996856e+01 1.19849630e+01 1.62739339e+01
 1.75290181e+00 3.84886978e+00 2.18789652e+00 7.76279048e+00
 1.00896410e+01 5.24600902e+01 5.02433056e-01 1.23404827e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.982151189277811
cond(S) = 54.021684522590405
E1 = -183.11980580406842  E_coul = 54.96947774121723
init E= -128.150328062851
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.738800109729392  LUMO = 2.07556137929596
  mo_energy =
[-3.25531250e+01 -1.85710082e+00 -7.38800110e-01 -7.38800110e-01
 -7.38800110e-01  2.07556138e+00  2.07556138e+00  2.07556138e+00
  2.34240456e+00  1.46193804e+01  1.46193804e+01  1.46193804e+01
  3.78474907e+01  2.64209491e+02  1.35571685e+03  5.66973583e+03]
E1 = -181.5218690115268  E_coul = 53.31338763943476
cycle= 1 E= -128.208481372092  delta_E= -0.0582  |g|= 0.232  |ddm|= 0.212
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.36941
diis-c [-0.1364637  1.       ]
  HOMO = -0.845765145772233  LUMO = 2.00152204318777
  mo_energy =
[-3.29404886e+01 -1.97287996e+00 -8.45765146e-01 -8.45765146e-01
 -8.45765146e-01  2.00152204e+00  2.00152204e+00  2.00152204e+00
  2.25761979e+00  1.43704092e+01  1.43704092e+01  1.43704092e+01
  3.75226192e+01  2.63790191e+02  1.35525019e+03  5.66923957e+03]
E1 = -182.26305220713348  E_coul = 54.051015866612396
cycle= 2 E= -128.212036340521  delta_E= -0.00355  |g|= 0.0984  |ddm|= 0.102
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.164044
diis-c [-3.24152548e-04  3.06476365e-01  6.93523635e-01]
  HOMO = -0.810132064272135  LUMO = 2.02743928323144
  mo_energy =
[-3.28282772e+01 -1.93555772e+00 -8.10132064e-01 -8.10132064e-01
 -8.10132064e-01  2.02743928e+00  2.02743928e+00  2.02743928e+00
  2.28585711e+00  1.44472575e+01  1.44472575e+01  1.44472575e+01
  3.76188735e+01  2.63909843e+02  1.35537781e+03  5.66937031e+03]
E1 = -182.04295404934808  E_coul = 53.83011056196621
cycle= 3 E= -128.212843487382  delta_E= -0.000807  |g|= 0.00126  |ddm|= 0.0291
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00203694
diis-c [-8.20355408e-07 -1.12301803e-02 -3.59132023e-02  1.04714338e+00]
  HOMO = -0.80982183739104  LUMO = 2.02773308769911
  mo_energy =
[-3.28274747e+01 -1.93547987e+00 -8.09821837e-01 -8.09821837e-01
 -8.09821837e-01  2.02773309e+00  2.02773309e+00  2.02773309e+00
  2.28596613e+00  1.44478870e+01  1.44478870e+01  1.44478870e+01
  3.76195074e+01  2.63910968e+02  1.35537932e+03  5.66937201e+03]
E1 = -182.04130608405035  E_coul = 53.828462421762076
cycle= 4 E= -128.212843662288  delta_E= -1.75e-07  |g|= 0.000155  |ddm|= 0.000544
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000219435
diis-c [-2.35275081e-09  6.17956070e-04  2.09837976e-03 -1.75517596e-01
  1.17280126e+00]
  HOMO = -0.809790026883306  LUMO = 2.02775158172099
  mo_energy =
[-3.28273985e+01 -1.93549301e+00 -8.09790027e-01 -8.09790027e-01
 -8.09790027e-01  2.02775158e+00  2.02775158e+00  2.02775158e+00
  2.28595060e+00  1.44479382e+01  1.44479382e+01  1.44479382e+01
  3.76195577e+01  2.63911077e+02  1.35537948e+03  5.66937219e+03]
E1 = -182.04117282980243  E_coul = 53.82832916413034
cycle= 5 E= -128.212843665672  delta_E= -3.38e-09  |g|= 3.85e-06  |ddm|= 0.000102
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.25367e-06
diis-c [-2.12958580e-13 -6.27616863e-06 -3.54410984e-05  5.73483244e-03
 -6.28853848e-02  1.05719227e+00]
  HOMO = -0.809789399721804  LUMO = 2.02775213792958
  mo_energy =
[-3.28273970e+01 -1.93549350e+00 -8.09789400e-01 -8.09789400e-01
 -8.09789400e-01  2.02775214e+00  2.02775214e+00  2.02775214e+00
  2.28595025e+00  1.44479393e+01  1.44479393e+01  1.44479393e+01
  3.76195588e+01  2.63911078e+02  1.35537948e+03  5.66937219e+03]
E1 = -182.04116915829786  E_coul = 53.828325492623655
cycle= 6 E= -128.212843665674  delta_E= -2.1e-12  |g|= 1.15e-07  |ddm|= 2.71e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.04116915829786  E_coul = 53.828325492623655
  HOMO = -0.809789465327635  LUMO = 2.02775208857151
  mo_energy =
[-3.28273971e+01 -1.93549356e+00 -8.09789465e-01 -8.09789465e-01
 -8.09789465e-01  2.02775209e+00  2.02775209e+00  2.02775209e+00
  2.28595020e+00  1.44479391e+01  1.44479391e+01  1.44479391e+01
  3.76195587e+01  2.63911078e+02  1.35537948e+03  5.66937219e+03]
E1 = -182.0411695190024  E_coul = 53.8283258533281
Extra cycle  E= -128.212843665674  delta_E= -1.14e-13  |g|= 4.86e-08  |ddm|= 4.49e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 54.021684522590405
E1 = -182.0411695190024  E_coul = 53.8283258533281
init E= -128.212843665674
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.809789440627026  LUMO = 2.02775210658215
  mo_energy =
[-3.28273971e+01 -1.93549353e+00 -8.09789441e-01 -8.09789441e-01
 -8.09789441e-01  2.02775211e+00  2.02775211e+00  2.02775211e+00
  2.28595022e+00  1.44479392e+01  1.44479392e+01  1.44479392e+01
  3.76195587e+01  2.63911078e+02  1.35537948e+03  5.66937219e+03]
E1 = -182.04116936301662  E_coul = 53.82832569734244
cycle= 1 E= -128.212843665674  delta_E= 1.42e-13  |g|= 2.07e-08  |ddm|= 2.17e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.04116936301662  E_coul = 53.82832569734244
  HOMO = -0.809789451462995  LUMO = 2.02775209869983
  mo_energy =
[-3.28273971e+01 -1.93549355e+00 -8.09789451e-01 -8.09789451e-01
 -8.09789451e-01  2.02775210e+00  2.02775210e+00  2.02775210e+00
  2.28595021e+00  1.44479392e+01  1.44479392e+01  1.44479392e+01
  3.76195587e+01  2.63911078e+02  1.35537948e+03  5.66937219e+03]
E1 = -182.04116943028797  E_coul = 53.82832576461381
Extra cycle  E= -128.212843665674  delta_E= 2.84e-14  |g|= 8.97e-09  |ddm|= 8.87e-09
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.34880428e+03 1.78829275e+02 7.26928362e+02 5.21037540e-01
 4.29665170e+01 1.19849630e+01 1.75290181e+00 2.18789652e+00
 1.00896410e+01 5.02433056e-01]
grad_E = [-2.81651885e-05  6.15578434e-04  4.74693774e-05 -6.76149220e-03
 -1.20606037e-03 -3.17742868e-03 -1.59727840e-03 -5.63811296e-02
 -1.26457042e-02  1.74529184e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2377.37906643        1
[INPUT] 0    0    [1    /1   ]  166.167748573        1
[INPUT] 0    0    [1    /1   ]  629.439954412        1
[INPUT] 0    0    [1    /1   ]  0.512239010869       1
[INPUT] 0    0    [1    /1   ]  41.2308379875        1
[INPUT] 0    0    [1    /1   ]  11.7009041667        1
[INPUT] 0    0    [1    /1   ]  1.72734562197        1
[INPUT] 1    0    [1    /1   ]  2.14385650593        1
[INPUT] 1    0    [1    /1   ]  9.86431555587        1
[INPUT] 1    0    [1    /1   ]  0.494507554345       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2377.3790664279695, 1.0]], [0, [166.16774857254705, 1.0]], [0, [629.4399544119613, 1.0]], [0, [0.5122390108692246, 1.0]], [0, [41.23083798749302, 1.0]], [0, [11.700904166693068, 1.0]], [0, [1.7273456219702756, 1.0]], [1, [2.1438565059320354, 1.0]], [1, [9.864315555865469, 1.0]], [1, [0.4945075543452632, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2377.37906643]
bas 1, expnt(s) = [166.16774857]
bas 2, expnt(s) = [629.43995441]
bas 3, expnt(s) = [0.51223901]
bas 4, expnt(s) = [41.23083799]
bas 5, expnt(s) = [11.70090417]
bas 6, expnt(s) = [1.72734562]
bas 7, expnt(s) = [2.14385651]
bas 8, expnt(s) = [9.86431556]
bas 9, expnt(s) = [0.49450755]
CPU time:       268.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.37737907e+03 8.60179028e+02 1.66167749e+02 1.16929765e+02
 6.29439954e+02 3.17490514e+02 5.12239011e-01 1.52974665e+00
 4.12308380e+01 4.11085014e+01 1.17009042e+01 1.59837836e+01
 1.72734562e+00 3.80670705e+00 2.14385651e+00 7.56796360e+00
 9.86431556e+00 5.09997548e+01 4.94507554e-01 1.20976372e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.983113683689247
cond(S) = 56.49372232018916
E1 = -183.11708052781574  E_coul = 54.963084856082546
init E= -128.153995671733
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.738135793860352  LUMO = 2.03159163986759
  mo_energy =
[-3.25600514e+01 -1.85768042e+00 -7.38135794e-01 -7.38135794e-01
 -7.38135794e-01  2.03159164e+00  2.03159164e+00  2.03159164e+00
  2.27882985e+00  1.42508075e+01  1.42508075e+01  1.42508075e+01
  3.61879599e+01  2.47065487e+02  1.22031178e+03  5.37512419e+03]
E1 = -181.46983587286536  E_coul = 53.25748936587109
cycle= 1 E= -128.212346506994  delta_E= -0.0584  |g|= 0.238  |ddm|= 0.215
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.379882
diis-c [-0.14431015  1.        ]
  HOMO = -0.848662677594114  LUMO = 1.95641267314829
  mo_energy =
[-3.29572151e+01 -1.97753586e+00 -8.48662678e-01 -8.48662678e-01
 -8.48662678e-01  1.95641267e+00  1.95641267e+00  1.95641267e+00
  2.19287236e+00  1.39975055e+01  1.39975055e+01  1.39975055e+01
  3.58584107e+01  2.46639160e+02  1.21983841e+03  5.37461941e+03]
E1 = -182.2368181097989  E_coul = 54.02071186919106
cycle= 2 E= -128.216106240608  delta_E= -0.00376  |g|= 0.102  |ddm|= 0.105
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.169844
diis-c [-3.14074327e-04  3.08026423e-01  6.91973577e-01]
  HOMO = -0.811822526499825  LUMO = 1.98269397556845
  mo_energy =
[-3.28415908e+01 -1.93892250e+00 -8.11822526e-01 -8.11822526e-01
 -8.11822526e-01  1.98269398e+00  1.98269398e+00  1.98269398e+00
  2.22148061e+00  1.40760490e+01  1.40760490e+01  1.40760490e+01
  3.59566166e+01  2.46761745e+02  1.21996937e+03  5.37475395e+03]
E1 = -182.00838689758902  E_coul = 53.79141546852926
cycle= 3 E= -128.21697142906  delta_E= -0.000865  |g|= 0.00135  |ddm|= 0.0302
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00221437
diis-c [-9.15635500e-07 -1.25213678e-02 -3.93152747e-02  1.05183664e+00]
  HOMO = -0.811471704373432  LUMO = 1.9830167161216
  mo_energy =
[-3.28406951e+01 -1.93881870e+00 -8.11471704e-01 -8.11471704e-01
 -8.11471704e-01  1.98301672e+00  1.98301672e+00  1.98301672e+00
  2.22161141e+00  1.40767511e+01  1.40767511e+01  1.40767511e+01
  3.59573211e+01  2.46762953e+02  1.21997099e+03  5.37475578e+03]
E1 = -182.00652214345422  E_coul = 53.789550509642076
cycle= 4 E= -128.216971633812  delta_E= -2.05e-07  |g|= 0.00016  |ddm|= 0.000585
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000222443
diis-c [-2.90152012e-09  6.26731331e-04  2.24401397e-03 -1.71563260e-01
  1.16869251e+00]
  HOMO = -0.811440648979681  LUMO = 1.98303356776604
  mo_energy =
[-3.28406218e+01 -1.93883490e+00 -8.11440649e-01 -8.11440649e-01
 -8.11440649e-01  1.98303357e+00  1.98303357e+00  1.98303357e+00
  2.22159306e+00  1.40767992e+01  1.40767992e+01  1.40767992e+01
  3.59573667e+01  2.46763057e+02  1.21997114e+03  5.37475596e+03]
E1 = -182.00639638982372  E_coul = 53.78942475233341
cycle= 5 E= -128.21697163749  delta_E= -3.68e-09  |g|= 4.31e-06  |ddm|= 0.000108
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.98608e-06
diis-c [-2.47880515e-13 -3.13907610e-06 -3.37851706e-05  5.35731994e-03
 -6.31146677e-02  1.05779427e+00]
  HOMO = -0.811439910603985  LUMO = 1.98303420138209
  mo_energy =
[-3.28406200e+01 -1.93883540e+00 -8.11439911e-01 -8.11439911e-01
 -8.11439911e-01  1.98303420e+00  1.98303420e+00  1.98303420e+00
  2.22159270e+00  1.40768005e+01  1.40768005e+01  1.40768005e+01
  3.59573680e+01  2.46763058e+02  1.21997114e+03  5.37475596e+03]
E1 = -182.0063920497901  E_coul = 53.78942041229707
cycle= 6 E= -128.216971637493  delta_E= -2.73e-12  |g|= 1.24e-07  |ddm|= 3.05e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.0063920497901  E_coul = 53.78942041229707
  HOMO = -0.811439981900912  LUMO = 1.98303414932233
  mo_energy =
[-3.28406202e+01 -1.93883547e+00 -8.11439982e-01 -8.11439982e-01
 -8.11439982e-01  1.98303415e+00  1.98303415e+00  1.98303415e+00
  2.22159264e+00  1.40768003e+01  1.40768003e+01  1.40768003e+01
  3.59573678e+01  2.46763058e+02  1.21997114e+03  5.37475596e+03]
E1 = -182.00639244047426  E_coul = 53.789420802981134
Extra cycle  E= -128.216971637493  delta_E= -8.53e-14  |g|= 5.26e-08  |ddm|= 4.84e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.37737907e+03 1.66167749e+02 6.29439954e+02 5.12239011e-01
 4.12308380e+01 1.17009042e+01 1.72734562e+00 2.14385651e+00
 9.86431556e+00 4.94507554e-01]
E = -128.21697163749312
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2377.37906643        1
[INPUT] 0    0    [1    /1   ]  166.167748573        1
[INPUT] 0    0    [1    /1   ]  629.439954412        1
[INPUT] 0    0    [1    /1   ]  0.512239010869       1
[INPUT] 0    0    [1    /1   ]  41.2308379875        1
[INPUT] 0    0    [1    /1   ]  11.7009041667        1
[INPUT] 0    0    [1    /1   ]  1.72734562197        1
[INPUT] 1    0    [1    /1   ]  2.14385650593        1
[INPUT] 1    0    [1    /1   ]  9.86431555587        1
[INPUT] 1    0    [1    /1   ]  0.494507554345       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2377.3790664279695, 1.0]], [0, [166.16774857254705, 1.0]], [0, [629.4399544119613, 1.0]], [0, [0.5122390108692246, 1.0]], [0, [41.23083798749302, 1.0]], [0, [11.700904166693068, 1.0]], [0, [1.7273456219702756, 1.0]], [1, [2.1438565059320354, 1.0]], [1, [9.864315555865469, 1.0]], [1, [0.4945075543452632, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2377.37906643]
bas 1, expnt(s) = [166.16774857]
bas 2, expnt(s) = [629.43995441]
bas 3, expnt(s) = [0.51223901]
bas 4, expnt(s) = [41.23083799]
bas 5, expnt(s) = [11.70090417]
bas 6, expnt(s) = [1.72734562]
bas 7, expnt(s) = [2.14385651]
bas 8, expnt(s) = [9.86431556]
bas 9, expnt(s) = [0.49450755]
CPU time:       269.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.37737907e+03 8.60179028e+02 1.66167749e+02 1.16929765e+02
 6.29439954e+02 3.17490514e+02 5.12239011e-01 1.52974665e+00
 4.12308380e+01 4.11085014e+01 1.17009042e+01 1.59837836e+01
 1.72734562e+00 3.80670705e+00 2.14385651e+00 7.56796360e+00
 9.86431556e+00 5.09997548e+01 4.94507554e-01 1.20976372e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.983113683689247
cond(S) = 56.49372232018916
E1 = -183.11708052781574  E_coul = 54.963084856082546
init E= -128.153995671733
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.738135793860352  LUMO = 2.03159163986759
  mo_energy =
[-3.25600514e+01 -1.85768042e+00 -7.38135794e-01 -7.38135794e-01
 -7.38135794e-01  2.03159164e+00  2.03159164e+00  2.03159164e+00
  2.27882985e+00  1.42508075e+01  1.42508075e+01  1.42508075e+01
  3.61879599e+01  2.47065487e+02  1.22031178e+03  5.37512419e+03]
E1 = -181.46983587286536  E_coul = 53.25748936587109
cycle= 1 E= -128.212346506994  delta_E= -0.0584  |g|= 0.238  |ddm|= 0.215
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.379882
diis-c [-0.14431015  1.        ]
  HOMO = -0.848662677594114  LUMO = 1.95641267314829
  mo_energy =
[-3.29572151e+01 -1.97753586e+00 -8.48662678e-01 -8.48662678e-01
 -8.48662678e-01  1.95641267e+00  1.95641267e+00  1.95641267e+00
  2.19287236e+00  1.39975055e+01  1.39975055e+01  1.39975055e+01
  3.58584107e+01  2.46639160e+02  1.21983841e+03  5.37461941e+03]
E1 = -182.2368181097989  E_coul = 54.02071186919106
cycle= 2 E= -128.216106240608  delta_E= -0.00376  |g|= 0.102  |ddm|= 0.105
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.169844
diis-c [-3.14074327e-04  3.08026423e-01  6.91973577e-01]
  HOMO = -0.811822526499825  LUMO = 1.98269397556845
  mo_energy =
[-3.28415908e+01 -1.93892250e+00 -8.11822526e-01 -8.11822526e-01
 -8.11822526e-01  1.98269398e+00  1.98269398e+00  1.98269398e+00
  2.22148061e+00  1.40760490e+01  1.40760490e+01  1.40760490e+01
  3.59566166e+01  2.46761745e+02  1.21996937e+03  5.37475395e+03]
E1 = -182.00838689758902  E_coul = 53.79141546852926
cycle= 3 E= -128.21697142906  delta_E= -0.000865  |g|= 0.00135  |ddm|= 0.0302
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00221437
diis-c [-9.15635500e-07 -1.25213678e-02 -3.93152747e-02  1.05183664e+00]
  HOMO = -0.811471704373432  LUMO = 1.9830167161216
  mo_energy =
[-3.28406951e+01 -1.93881870e+00 -8.11471704e-01 -8.11471704e-01
 -8.11471704e-01  1.98301672e+00  1.98301672e+00  1.98301672e+00
  2.22161141e+00  1.40767511e+01  1.40767511e+01  1.40767511e+01
  3.59573211e+01  2.46762953e+02  1.21997099e+03  5.37475578e+03]
E1 = -182.00652214345422  E_coul = 53.789550509642076
cycle= 4 E= -128.216971633812  delta_E= -2.05e-07  |g|= 0.00016  |ddm|= 0.000585
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000222443
diis-c [-2.90152012e-09  6.26731331e-04  2.24401397e-03 -1.71563260e-01
  1.16869251e+00]
  HOMO = -0.811440648979681  LUMO = 1.98303356776604
  mo_energy =
[-3.28406218e+01 -1.93883490e+00 -8.11440649e-01 -8.11440649e-01
 -8.11440649e-01  1.98303357e+00  1.98303357e+00  1.98303357e+00
  2.22159306e+00  1.40767992e+01  1.40767992e+01  1.40767992e+01
  3.59573667e+01  2.46763057e+02  1.21997114e+03  5.37475596e+03]
E1 = -182.00639638982372  E_coul = 53.78942475233341
cycle= 5 E= -128.21697163749  delta_E= -3.68e-09  |g|= 4.31e-06  |ddm|= 0.000108
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=5.98608e-06
diis-c [-2.47880515e-13 -3.13907610e-06 -3.37851706e-05  5.35731994e-03
 -6.31146677e-02  1.05779427e+00]
  HOMO = -0.811439910603985  LUMO = 1.98303420138209
  mo_energy =
[-3.28406200e+01 -1.93883540e+00 -8.11439911e-01 -8.11439911e-01
 -8.11439911e-01  1.98303420e+00  1.98303420e+00  1.98303420e+00
  2.22159270e+00  1.40768005e+01  1.40768005e+01  1.40768005e+01
  3.59573680e+01  2.46763058e+02  1.21997114e+03  5.37475596e+03]
E1 = -182.0063920497901  E_coul = 53.78942041229707
cycle= 6 E= -128.216971637493  delta_E= -2.73e-12  |g|= 1.24e-07  |ddm|= 3.05e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.0063920497901  E_coul = 53.78942041229707
  HOMO = -0.811439981900912  LUMO = 1.98303414932233
  mo_energy =
[-3.28406202e+01 -1.93883547e+00 -8.11439982e-01 -8.11439982e-01
 -8.11439982e-01  1.98303415e+00  1.98303415e+00  1.98303415e+00
  2.22159264e+00  1.40768003e+01  1.40768003e+01  1.40768003e+01
  3.59573678e+01  2.46763058e+02  1.21997114e+03  5.37475596e+03]
E1 = -182.00639244047426  E_coul = 53.789420802981134
Extra cycle  E= -128.216971637493  delta_E= -8.53e-14  |g|= 5.26e-08  |ddm|= 4.84e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 56.49372232018916
E1 = -182.00639244047426  E_coul = 53.789420802981134
init E= -128.216971637493
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.811439955124934  LUMO = 1.98303416847401
  mo_energy =
[-3.28406201e+01 -1.93883544e+00 -8.11439955e-01 -8.11439955e-01
 -8.11439955e-01  1.98303417e+00  1.98303417e+00  1.98303417e+00
  2.22159266e+00  1.40768004e+01  1.40768004e+01  1.40768004e+01
  3.59573679e+01  2.46763058e+02  1.21997114e+03  5.37475596e+03]
E1 = -182.0063922705027  E_coul = 53.789420633009655
cycle= 1 E= -128.216971637493  delta_E= 8.53e-14  |g|= 2.26e-08  |ddm|= 2.36e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.0063922705027  E_coul = 53.789420633009655
  HOMO = -0.811439966945673  LUMO = 1.98303416003995
  mo_energy =
[-3.28406201e+01 -1.93883546e+00 -8.11439967e-01 -8.11439967e-01
 -8.11439967e-01  1.98303416e+00  1.98303416e+00  1.98303416e+00
  2.22159266e+00  1.40768004e+01  1.40768004e+01  1.40768004e+01
  3.59573679e+01  2.46763058e+02  1.21997114e+03  5.37475596e+03]
E1 = -182.00639234421757  E_coul = 53.78942070672448
Extra cycle  E= -128.216971637493  delta_E= -5.68e-14  |g|= 9.82e-09  |ddm|= 9.69e-09
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.37737907e+03 1.66167749e+02 6.29439954e+02 5.12239011e-01
 4.12308380e+01 1.17009042e+01 1.72734562e+00 2.14385651e+00
 9.86431556e+00 4.94507554e-01]
grad_E = [-2.51077135e-05  7.98705427e-04  1.82454210e-05 -7.49790616e-03
 -1.62659203e-03 -2.59277029e-03 -2.53146456e-03 -6.10996284e-02
 -1.42493451e-02 -4.92685878e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2404.90961406        1
[INPUT] 0    0    [1    /1   ]  149.941488544        1
[INPUT] 0    0    [1    /1   ]  535.846713644        1
[INPUT] 0    0    [1    /1   ]  0.502784168061       1
[INPUT] 0    0    [1    /1   ]  39.0068804107        1
[INPUT] 0    0    [1    /1   ]  11.3472578032        1
[INPUT] 0    0    [1    /1   ]  1.70106321282        1
[INPUT] 1    0    [1    /1   ]  2.1255434048         1
[INPUT] 1    0    [1    /1   ]  9.7781515584         1
[INPUT] 1    0    [1    /1   ]  0.49074877926        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2404.9096140649704, 1.0]], [0, [149.9414885440548, 1.0]], [0, [535.8467136439036, 1.0]], [0, [0.5027841680610962, 1.0]], [0, [39.00688041068554, 1.0]], [0, [11.347257803206954, 1.0]], [0, [1.701063212822641, 1.0]], [1, [2.125543404800821, 1.0]], [1, [9.778151558397097, 1.0]], [1, [0.4907487792595221, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2404.90961406]
bas 1, expnt(s) = [149.94148854]
bas 2, expnt(s) = [535.84671364]
bas 3, expnt(s) = [0.50278417]
bas 4, expnt(s) = [39.00688041]
bas 5, expnt(s) = [11.3472578]
bas 6, expnt(s) = [1.70106321]
bas 7, expnt(s) = [2.1255434]
bas 8, expnt(s) = [9.77815156]
bas 9, expnt(s) = [0.49074878]
CPU time:       272.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.40490961e+03 8.67639056e+02 1.49941489e+02 1.08257100e+02
 5.35846714e+02 2.81381443e+02 5.02784168e-01 1.50852051e+00
 3.90068804e+01 3.94340096e+01 1.13472578e+01 1.56200786e+01
 1.70106321e+00 3.76318322e+00 2.12554340e+00 7.48724191e+00
 9.77815156e+00 5.04435158e+01 4.90748779e-01 1.19828032e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.983596282341228
cond(S) = 61.239659543993284
E1 = -183.11995362856206  E_coul = 54.95990199878139
init E= -128.160051629781
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.737906003462801  LUMO = 2.0116243868603
  mo_energy =
[-3.25655372e+01 -1.85808975e+00 -7.37906003e-01 -7.37906003e-01
 -7.37906003e-01  2.01162439e+00  2.01162439e+00  2.01162439e+00
  2.21221650e+00  1.41034544e+01  1.41034544e+01  1.41034544e+01
  3.41667875e+01  2.25814591e+02  1.07216769e+03  5.06562212e+03]
E1 = -181.44722555481107  E_coul = 53.228064691133014
cycle= 1 E= -128.219160863678  delta_E= -0.0591  |g|= 0.241  |ddm|= 0.217
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.38643
diis-c [-0.14932788  1.        ]
  HOMO = -0.850371361576359  LUMO = 1.93569397807529
  mo_energy =
[-3.29678244e+01 -1.98002376e+00 -8.50371362e-01 -8.50371362e-01
 -8.50371362e-01  1.93569398e+00  1.93569398e+00  1.93569398e+00
  2.12691335e+00  1.38474760e+01  1.38474760e+01  1.38474760e+01
  3.38381478e+01  2.25387101e+02  1.07169311e+03  5.06511351e+03]
E1 = -182.22795732117143  E_coul = 54.00492757621071
cycle= 2 E= -128.223029744961  delta_E= -0.00387  |g|= 0.103  |ddm|= 0.107
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.173118
diis-c [-3.13765086e-04  3.08490593e-01  6.91509407e-01]
  HOMO = -0.812868248435148  LUMO = 1.9622213037527
  mo_energy =
[-3.28503249e+01 -1.94071263e+00 -8.12868248e-01 -8.12868248e-01
 -8.12868248e-01  1.96222130e+00  1.96222130e+00  1.96222130e+00
  2.15536502e+00  1.39270517e+01  1.39270517e+01  1.39270517e+01
  3.39365521e+01  2.25510733e+02  1.07182560e+03  5.06525011e+03]
E1 = -181.99498222976192  E_coul = 53.77105588254042
cycle= 3 E= -128.223926347221  delta_E= -0.000897  |g|= 0.00137  |ddm|= 0.0307
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00222695
diis-c [-9.67420462e-07 -1.28513547e-02 -3.97595250e-02  1.05261088e+00]
  HOMO = -0.812513154767725  LUMO = 1.96254757724908
  mo_energy =
[-3.28494329e+01 -1.94060859e+00 -8.12513155e-01 -8.12513155e-01
 -8.12513155e-01  1.96254758e+00  1.96254758e+00  1.96254758e+00
  2.15549600e+00  1.39277567e+01  1.39277567e+01  1.39277567e+01
  3.39372428e+01  2.25511905e+02  1.07182718e+03  5.06525195e+03]
E1 = -181.99311150901462  E_coul = 53.769184952053735
cycle= 4 E= -128.223926556961  delta_E= -2.1e-07  |g|= 0.000162  |ddm|= 0.000597
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00022234
diis-c [-3.33114892e-09  6.07876480e-04  2.19026628e-03 -1.69414886e-01
  1.16661674e+00]
  HOMO = -0.812482670321424  LUMO = 1.96256363176147
  mo_energy =
[-3.28493621e+01 -1.94062619e+00 -8.12482670e-01 -8.12482670e-01
 -8.12482670e-01  1.96256363e+00  1.96256363e+00  1.96256363e+00
  2.15547661e+00  1.39278028e+01  1.39278028e+01  1.39278028e+01
  3.39372842e+01  2.25512003e+02  1.07182733e+03  5.06525213e+03]
E1 = -181.99299261870334  E_coul = 53.769066057955875
cycle= 5 E= -128.223926560747  delta_E= -3.79e-09  |g|= 4.75e-06  |ddm|= 0.000111
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.67315e-06
diis-c [-2.74502202e-13 -8.98138867e-07 -3.03111888e-05  5.27718127e-03
 -6.52271792e-02  1.05998121e+00]
  HOMO = -0.812481810808222  LUMO = 1.96256434003809
  mo_energy =
[-3.28493601e+01 -1.94062670e+00 -8.12481811e-01 -8.12481811e-01
 -8.12481811e-01  1.96256434e+00  1.96256434e+00  1.96256434e+00
  2.15547623e+00  1.39278042e+01  1.39278042e+01  1.39278042e+01
  3.39372856e+01  2.25512005e+02  1.07182733e+03  5.06525213e+03]
E1 = -181.9929877301489  E_coul = 53.76906116939818
cycle= 6 E= -128.223926560751  delta_E= -3.27e-12  |g|= 1.29e-07  |ddm|= 3.39e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -181.9929877301489  E_coul = 53.76906116939818
  HOMO = -0.812481885461848  LUMO = 1.96256428647598
  mo_energy =
[-3.28493603e+01 -1.94062678e+00 -8.12481885e-01 -8.12481885e-01
 -8.12481885e-01  1.96256429e+00  1.96256429e+00  1.96256429e+00
  2.15547618e+00  1.39278041e+01  1.39278041e+01  1.39278041e+01
  3.39372854e+01  2.25512004e+02  1.07182733e+03  5.06525213e+03]
E1 = -181.99298813796457  E_coul = 53.76906157721371
Extra cycle  E= -128.223926560751  delta_E= -1.42e-13  |g|= 5.48e-08  |ddm|= 5.05e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.40490961e+03 1.49941489e+02 5.35846714e+02 5.02784168e-01
 3.90068804e+01 1.13472578e+01 1.70106321e+00 2.12554340e+00
 9.77815156e+00 4.90748779e-01]
E = -128.22392656075087
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:16 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2404.90961406        1
[INPUT] 0    0    [1    /1   ]  149.941488544        1
[INPUT] 0    0    [1    /1   ]  535.846713644        1
[INPUT] 0    0    [1    /1   ]  0.502784168061       1
[INPUT] 0    0    [1    /1   ]  39.0068804107        1
[INPUT] 0    0    [1    /1   ]  11.3472578032        1
[INPUT] 0    0    [1    /1   ]  1.70106321282        1
[INPUT] 1    0    [1    /1   ]  2.1255434048         1
[INPUT] 1    0    [1    /1   ]  9.7781515584         1
[INPUT] 1    0    [1    /1   ]  0.49074877926        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2404.9096140649704, 1.0]], [0, [149.9414885440548, 1.0]], [0, [535.8467136439036, 1.0]], [0, [0.5027841680610962, 1.0]], [0, [39.00688041068554, 1.0]], [0, [11.347257803206954, 1.0]], [0, [1.701063212822641, 1.0]], [1, [2.125543404800821, 1.0]], [1, [9.778151558397097, 1.0]], [1, [0.4907487792595221, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2404.90961406]
bas 1, expnt(s) = [149.94148854]
bas 2, expnt(s) = [535.84671364]
bas 3, expnt(s) = [0.50278417]
bas 4, expnt(s) = [39.00688041]
bas 5, expnt(s) = [11.3472578]
bas 6, expnt(s) = [1.70106321]
bas 7, expnt(s) = [2.1255434]
bas 8, expnt(s) = [9.77815156]
bas 9, expnt(s) = [0.49074878]
CPU time:       273.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.40490961e+03 8.67639056e+02 1.49941489e+02 1.08257100e+02
 5.35846714e+02 2.81381443e+02 5.02784168e-01 1.50852051e+00
 3.90068804e+01 3.94340096e+01 1.13472578e+01 1.56200786e+01
 1.70106321e+00 3.76318322e+00 2.12554340e+00 7.48724191e+00
 9.77815156e+00 5.04435158e+01 4.90748779e-01 1.19828032e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.983596282341228
cond(S) = 61.239659543993284
E1 = -183.11995362856206  E_coul = 54.95990199878139
init E= -128.160051629781
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.737906003462801  LUMO = 2.0116243868603
  mo_energy =
[-3.25655372e+01 -1.85808975e+00 -7.37906003e-01 -7.37906003e-01
 -7.37906003e-01  2.01162439e+00  2.01162439e+00  2.01162439e+00
  2.21221650e+00  1.41034544e+01  1.41034544e+01  1.41034544e+01
  3.41667875e+01  2.25814591e+02  1.07216769e+03  5.06562212e+03]
E1 = -181.44722555481107  E_coul = 53.228064691133014
cycle= 1 E= -128.219160863678  delta_E= -0.0591  |g|= 0.241  |ddm|= 0.217
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.38643
diis-c [-0.14932788  1.        ]
  HOMO = -0.850371361576359  LUMO = 1.93569397807529
  mo_energy =
[-3.29678244e+01 -1.98002376e+00 -8.50371362e-01 -8.50371362e-01
 -8.50371362e-01  1.93569398e+00  1.93569398e+00  1.93569398e+00
  2.12691335e+00  1.38474760e+01  1.38474760e+01  1.38474760e+01
  3.38381478e+01  2.25387101e+02  1.07169311e+03  5.06511351e+03]
E1 = -182.22795732117143  E_coul = 54.00492757621071
cycle= 2 E= -128.223029744961  delta_E= -0.00387  |g|= 0.103  |ddm|= 0.107
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.173118
diis-c [-3.13765086e-04  3.08490593e-01  6.91509407e-01]
  HOMO = -0.812868248435148  LUMO = 1.9622213037527
  mo_energy =
[-3.28503249e+01 -1.94071263e+00 -8.12868248e-01 -8.12868248e-01
 -8.12868248e-01  1.96222130e+00  1.96222130e+00  1.96222130e+00
  2.15536502e+00  1.39270517e+01  1.39270517e+01  1.39270517e+01
  3.39365521e+01  2.25510733e+02  1.07182560e+03  5.06525011e+03]
E1 = -181.99498222976192  E_coul = 53.77105588254042
cycle= 3 E= -128.223926347221  delta_E= -0.000897  |g|= 0.00137  |ddm|= 0.0307
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00222695
diis-c [-9.67420462e-07 -1.28513547e-02 -3.97595250e-02  1.05261088e+00]
  HOMO = -0.812513154767725  LUMO = 1.96254757724908
  mo_energy =
[-3.28494329e+01 -1.94060859e+00 -8.12513155e-01 -8.12513155e-01
 -8.12513155e-01  1.96254758e+00  1.96254758e+00  1.96254758e+00
  2.15549600e+00  1.39277567e+01  1.39277567e+01  1.39277567e+01
  3.39372428e+01  2.25511905e+02  1.07182718e+03  5.06525195e+03]
E1 = -181.99311150901462  E_coul = 53.769184952053735
cycle= 4 E= -128.223926556961  delta_E= -2.1e-07  |g|= 0.000162  |ddm|= 0.000597
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00022234
diis-c [-3.33114892e-09  6.07876480e-04  2.19026628e-03 -1.69414886e-01
  1.16661674e+00]
  HOMO = -0.812482670321424  LUMO = 1.96256363176147
  mo_energy =
[-3.28493621e+01 -1.94062619e+00 -8.12482670e-01 -8.12482670e-01
 -8.12482670e-01  1.96256363e+00  1.96256363e+00  1.96256363e+00
  2.15547661e+00  1.39278028e+01  1.39278028e+01  1.39278028e+01
  3.39372842e+01  2.25512003e+02  1.07182733e+03  5.06525213e+03]
E1 = -181.99299261870334  E_coul = 53.769066057955875
cycle= 5 E= -128.223926560747  delta_E= -3.79e-09  |g|= 4.75e-06  |ddm|= 0.000111
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.67315e-06
diis-c [-2.74502202e-13 -8.98138867e-07 -3.03111888e-05  5.27718127e-03
 -6.52271792e-02  1.05998121e+00]
  HOMO = -0.812481810808222  LUMO = 1.96256434003809
  mo_energy =
[-3.28493601e+01 -1.94062670e+00 -8.12481811e-01 -8.12481811e-01
 -8.12481811e-01  1.96256434e+00  1.96256434e+00  1.96256434e+00
  2.15547623e+00  1.39278042e+01  1.39278042e+01  1.39278042e+01
  3.39372856e+01  2.25512005e+02  1.07182733e+03  5.06525213e+03]
E1 = -181.9929877301489  E_coul = 53.76906116939818
cycle= 6 E= -128.223926560751  delta_E= -3.27e-12  |g|= 1.29e-07  |ddm|= 3.39e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -181.9929877301489  E_coul = 53.76906116939818
  HOMO = -0.812481885461848  LUMO = 1.96256428647598
  mo_energy =
[-3.28493603e+01 -1.94062678e+00 -8.12481885e-01 -8.12481885e-01
 -8.12481885e-01  1.96256429e+00  1.96256429e+00  1.96256429e+00
  2.15547618e+00  1.39278041e+01  1.39278041e+01  1.39278041e+01
  3.39372854e+01  2.25512004e+02  1.07182733e+03  5.06525213e+03]
E1 = -181.99298813796457  E_coul = 53.76906157721371
Extra cycle  E= -128.223926560751  delta_E= -1.42e-13  |g|= 5.48e-08  |ddm|= 5.05e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 61.239659543993284
E1 = -181.99298813796457  E_coul = 53.76906157721371
init E= -128.223926560751
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.812481857489657  LUMO = 1.96256430631187
  mo_energy =
[-3.28493602e+01 -1.94062675e+00 -8.12481857e-01 -8.12481857e-01
 -8.12481857e-01  1.96256431e+00  1.96256431e+00  1.96256431e+00
  2.15547620e+00  1.39278042e+01  1.39278042e+01  1.39278042e+01
  3.39372855e+01  2.25512004e+02  1.07182733e+03  5.06525213e+03]
E1 = -181.99298795994804  E_coul = 53.76906139919725
cycle= 1 E= -128.223926560751  delta_E= 8.53e-14  |g|= 2.36e-08  |ddm|= 2.46e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -181.99298795994804  E_coul = 53.76906139919725
  HOMO = -0.812481869876787  LUMO = 1.96256429754829
  mo_energy =
[-3.28493602e+01 -1.94062676e+00 -8.12481870e-01 -8.12481870e-01
 -8.12481870e-01  1.96256430e+00  1.96256430e+00  1.96256430e+00
  2.15547619e+00  1.39278041e+01  1.39278041e+01  1.39278041e+01
  3.39372855e+01  2.25512004e+02  1.07182733e+03  5.06525213e+03]
E1 = -181.9929880373645  E_coul = 53.769061476613686
Extra cycle  E= -128.223926560751  delta_E= -5.68e-14  |g|= 1.03e-08  |ddm|= 1.02e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.40490961e+03 1.49941489e+02 5.35846714e+02 5.02784168e-01
 3.90068804e+01 1.13472578e+01 1.70106321e+00 2.12554340e+00
 9.77815156e+00 4.90748779e-01]
grad_E = [-1.82366966e-05  9.71285122e-04 -4.32585951e-05 -8.42890726e-03
 -1.89359454e-03 -1.79302061e-03 -3.53810753e-03 -6.30037175e-02
 -1.47935847e-02 -4.39091420e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2425.69710164        1
[INPUT] 0    0    [1    /1   ]  131.494594386        1
[INPUT] 0    0    [1    /1   ]  465.689141852        1
[INPUT] 0    0    [1    /1   ]  0.494251437959       1
[INPUT] 0    0    [1    /1   ]  36.4491714013        1
[INPUT] 0    0    [1    /1   ]  10.9555768435        1
[INPUT] 0    0    [1    /1   ]  1.67861255308        1
[INPUT] 1    0    [1    /1   ]  2.15604449558        1
[INPUT] 1    0    [1    /1   ]  9.95008418071        1
[INPUT] 1    0    [1    /1   ]  0.495144763651       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2425.697101641153, 1.0]], [0, [131.49459438629063, 1.0]], [0, [465.6891418517632, 1.0]], [0, [0.4942514379591015, 1.0]], [0, [36.44917140131191, 1.0]], [0, [10.955576843549803, 1.0]], [0, [1.6786125530754648, 1.0]], [1, [2.156044495579375, 1.0]], [1, [9.950084180713313, 1.0]], [1, [0.49514476365058974, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2425.69710164]
bas 1, expnt(s) = [131.49459439]
bas 2, expnt(s) = [465.68914185]
bas 3, expnt(s) = [0.49425144]
bas 4, expnt(s) = [36.4491714]
bas 5, expnt(s) = [10.95557684]
bas 6, expnt(s) = [1.67861255]
bas 7, expnt(s) = [2.1560445]
bas 8, expnt(s) = [9.95008418]
bas 9, expnt(s) = [0.49514476]
CPU time:       276.27
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.42569710e+03 8.73257755e+02 1.31494594e+02 9.81060859e+01
 4.65689142e+02 2.53271958e+02 4.94251438e-01 1.48927871e+00
 3.64491714e+01 3.74783765e+01 1.09555768e+01 1.52139317e+01
 1.67861255e+00 3.72587151e+00 2.15604450e+00 7.62178233e+00
 9.95008418e+00 5.15546492e+01 4.95144764e-01 1.21171262e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.983214109875345
cond(S) = 67.37920422068426
E1 = -183.1367574388396  E_coul = 54.963576239372024
init E= -128.173181199468
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.738550308808914  LUMO = 2.03783302177683
  mo_energy =
[-3.25676902e+01 -1.85812781e+00 -7.38550309e-01 -7.38550309e-01
 -7.38550309e-01  2.03783302e+00  2.03783302e+00  2.03783302e+00
  2.15340169e+00  1.43686813e+01  1.43686813e+01  1.43686813e+01
  3.19960984e+01  2.02582652e+02  9.37760982e+02  4.80210558e+03]
E1 = -181.4832985545588  E_coul = 53.25190215782872
cycle= 1 E= -128.23139639673  delta_E= -0.0582  |g|= 0.239  |ddm|= 0.216
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.384432
diis-c [-0.14778778  1.        ]
  HOMO = -0.849705949022849  LUMO = 1.96183706348296
  mo_energy =
[-3.29657759e+01 -1.97818350e+00 -8.49705949e-01 -8.49705949e-01
 -8.49705949e-01  1.96183706e+00  1.96183706e+00  1.96183706e+00
  2.07163197e+00  1.41132675e+01  1.41132675e+01  1.41132675e+01
  3.16775178e+01  2.02164372e+02  9.37294776e+02  4.80160209e+03]
E1 = -182.2534273975458  E_coul = 54.01825200542172
cycle= 2 E= -128.235175392124  delta_E= -0.00378  |g|= 0.102  |ddm|= 0.105
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.171177
diis-c [-3.17860097e-04  3.07156732e-01  6.92843268e-01]
  HOMO = -0.812657311517634  LUMO = 1.98838127499435
  mo_energy =
[-3.28495377e+01 -1.93938893e+00 -8.12657312e-01 -8.12657312e-01
 -8.12657312e-01  1.98838127e+00  1.98838127e+00  1.98838127e+00
  2.09907786e+00  1.41925209e+01  1.41925209e+01  1.41925209e+01
  3.17731026e+01  2.02285548e+02  9.37425339e+02  4.80173728e+03]
E1 = -182.0236728857954  E_coul = 53.787626077059194
cycle= 3 E= -128.236046808736  delta_E= -0.000871  |g|= 0.00123  |ddm|= 0.0303
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00196976
diis-c [-9.01053426e-07 -1.16236960e-02 -3.56166906e-02  1.04724039e+00]
  HOMO = -0.812357256165088  LUMO = 1.98867021785979
  mo_energy =
[-3.28487963e+01 -1.93932310e+00 -8.12357256e-01 -8.12357256e-01
 -8.12357256e-01  1.98867022e+00  1.98867022e+00  1.98867022e+00
  2.09917773e+00  1.41931193e+01  1.41931193e+01  1.41931193e+01
  3.17736574e+01  2.02286515e+02  9.37426694e+02  4.80173891e+03]
E1 = -182.0221261074977  E_coul = 53.7860791276349
cycle= 4 E= -128.236046979863  delta_E= -1.71e-07  |g|= 0.000155  |ddm|= 0.000553
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000214531
diis-c [-3.21512604e-09  5.64556348e-04  1.89492054e-03 -1.71047830e-01
  1.16858835e+00]
  HOMO = -0.812327138875348  LUMO = 1.9886869224489
  mo_energy =
[-3.28487275e+01 -1.93933878e+00 -8.12327139e-01 -8.12327139e-01
 -8.12327139e-01  1.98868692e+00  1.98868692e+00  1.98868692e+00
  2.09916056e+00  1.41931652e+01  1.41931652e+01  1.41931652e+01
  3.17736965e+01  2.02286605e+02  9.37426832e+02  4.80173908e+03]
E1 = -182.02201204789415  E_coul = 53.78596506456427
cycle= 5 E= -128.23604698333  delta_E= -3.47e-09  |g|= 4.89e-06  |ddm|= 0.000106
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.94338e-06
diis-c [-2.71183538e-13 -1.11634298e-06 -2.66964033e-05  5.63123003e-03
 -6.89998797e-02  1.06339646e+00]
  HOMO = -0.812326176123375  LUMO = 1.9886876931974
  mo_energy =
[-3.28487253e+01 -1.93933923e+00 -8.12326176e-01 -8.12326176e-01
 -8.12326176e-01  1.98868769e+00  1.98868769e+00  1.98868769e+00
  2.09916021e+00  1.41931668e+01  1.41931668e+01  1.41931668e+01
  3.17736981e+01  2.02286607e+02  9.37426834e+02  4.80173908e+03]
E1 = -182.02200696989638  E_coul = 53.78595998656275
cycle= 6 E= -128.236046983334  delta_E= -3.75e-12  |g|= 1.27e-07  |ddm|= 3.49e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.02200696989638  E_coul = 53.78595998656275
  HOMO = -0.812326249371627  LUMO = 1.98868764005685
  mo_energy =
[-3.28487254e+01 -1.93933931e+00 -8.12326249e-01 -8.12326249e-01
 -8.12326249e-01  1.98868764e+00  1.98868764e+00  1.98868764e+00
  2.09916016e+00  1.41931666e+01  1.41931666e+01  1.41931666e+01
  3.17736979e+01  2.02286607e+02  9.37426834e+02  4.80173908e+03]
E1 = -182.02200737001704  E_coul = 53.785960386683556
Extra cycle  E= -128.236046983333  delta_E= 1.42e-13  |g|= 5.38e-08  |ddm|= 4.99e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.42569710e+03 1.31494594e+02 4.65689142e+02 4.94251438e-01
 3.64491714e+01 1.09555768e+01 1.67861255e+00 2.15604450e+00
 9.95008418e+00 4.95144764e-01]
E = -128.2360469833335
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2425.69710164        1
[INPUT] 0    0    [1    /1   ]  131.494594386        1
[INPUT] 0    0    [1    /1   ]  465.689141852        1
[INPUT] 0    0    [1    /1   ]  0.494251437959       1
[INPUT] 0    0    [1    /1   ]  36.4491714013        1
[INPUT] 0    0    [1    /1   ]  10.9555768435        1
[INPUT] 0    0    [1    /1   ]  1.67861255308        1
[INPUT] 1    0    [1    /1   ]  2.15604449558        1
[INPUT] 1    0    [1    /1   ]  9.95008418071        1
[INPUT] 1    0    [1    /1   ]  0.495144763651       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2425.697101641153, 1.0]], [0, [131.49459438629063, 1.0]], [0, [465.6891418517632, 1.0]], [0, [0.4942514379591015, 1.0]], [0, [36.44917140131191, 1.0]], [0, [10.955576843549803, 1.0]], [0, [1.6786125530754648, 1.0]], [1, [2.156044495579375, 1.0]], [1, [9.950084180713313, 1.0]], [1, [0.49514476365058974, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2425.69710164]
bas 1, expnt(s) = [131.49459439]
bas 2, expnt(s) = [465.68914185]
bas 3, expnt(s) = [0.49425144]
bas 4, expnt(s) = [36.4491714]
bas 5, expnt(s) = [10.95557684]
bas 6, expnt(s) = [1.67861255]
bas 7, expnt(s) = [2.1560445]
bas 8, expnt(s) = [9.95008418]
bas 9, expnt(s) = [0.49514476]
CPU time:       277.38
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.42569710e+03 8.73257755e+02 1.31494594e+02 9.81060859e+01
 4.65689142e+02 2.53271958e+02 4.94251438e-01 1.48927871e+00
 3.64491714e+01 3.74783765e+01 1.09555768e+01 1.52139317e+01
 1.67861255e+00 3.72587151e+00 2.15604450e+00 7.62178233e+00
 9.95008418e+00 5.15546492e+01 4.95144764e-01 1.21171262e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.983214109875345
cond(S) = 67.37920422068426
E1 = -183.1367574388396  E_coul = 54.963576239372024
init E= -128.173181199468
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.738550308808914  LUMO = 2.03783302177683
  mo_energy =
[-3.25676902e+01 -1.85812781e+00 -7.38550309e-01 -7.38550309e-01
 -7.38550309e-01  2.03783302e+00  2.03783302e+00  2.03783302e+00
  2.15340169e+00  1.43686813e+01  1.43686813e+01  1.43686813e+01
  3.19960984e+01  2.02582652e+02  9.37760982e+02  4.80210558e+03]
E1 = -181.4832985545588  E_coul = 53.25190215782872
cycle= 1 E= -128.23139639673  delta_E= -0.0582  |g|= 0.239  |ddm|= 0.216
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.384432
diis-c [-0.14778778  1.        ]
  HOMO = -0.849705949022849  LUMO = 1.96183706348296
  mo_energy =
[-3.29657759e+01 -1.97818350e+00 -8.49705949e-01 -8.49705949e-01
 -8.49705949e-01  1.96183706e+00  1.96183706e+00  1.96183706e+00
  2.07163197e+00  1.41132675e+01  1.41132675e+01  1.41132675e+01
  3.16775178e+01  2.02164372e+02  9.37294776e+02  4.80160209e+03]
E1 = -182.2534273975458  E_coul = 54.01825200542172
cycle= 2 E= -128.235175392124  delta_E= -0.00378  |g|= 0.102  |ddm|= 0.105
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.171177
diis-c [-3.17860097e-04  3.07156732e-01  6.92843268e-01]
  HOMO = -0.812657311517634  LUMO = 1.98838127499435
  mo_energy =
[-3.28495377e+01 -1.93938893e+00 -8.12657312e-01 -8.12657312e-01
 -8.12657312e-01  1.98838127e+00  1.98838127e+00  1.98838127e+00
  2.09907786e+00  1.41925209e+01  1.41925209e+01  1.41925209e+01
  3.17731026e+01  2.02285548e+02  9.37425339e+02  4.80173728e+03]
E1 = -182.0236728857954  E_coul = 53.787626077059194
cycle= 3 E= -128.236046808736  delta_E= -0.000871  |g|= 0.00123  |ddm|= 0.0303
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00196976
diis-c [-9.01053426e-07 -1.16236960e-02 -3.56166906e-02  1.04724039e+00]
  HOMO = -0.812357256165088  LUMO = 1.98867021785979
  mo_energy =
[-3.28487963e+01 -1.93932310e+00 -8.12357256e-01 -8.12357256e-01
 -8.12357256e-01  1.98867022e+00  1.98867022e+00  1.98867022e+00
  2.09917773e+00  1.41931193e+01  1.41931193e+01  1.41931193e+01
  3.17736574e+01  2.02286515e+02  9.37426694e+02  4.80173891e+03]
E1 = -182.0221261074977  E_coul = 53.7860791276349
cycle= 4 E= -128.236046979863  delta_E= -1.71e-07  |g|= 0.000155  |ddm|= 0.000553
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000214531
diis-c [-3.21512604e-09  5.64556348e-04  1.89492054e-03 -1.71047830e-01
  1.16858835e+00]
  HOMO = -0.812327138875348  LUMO = 1.9886869224489
  mo_energy =
[-3.28487275e+01 -1.93933878e+00 -8.12327139e-01 -8.12327139e-01
 -8.12327139e-01  1.98868692e+00  1.98868692e+00  1.98868692e+00
  2.09916056e+00  1.41931652e+01  1.41931652e+01  1.41931652e+01
  3.17736965e+01  2.02286605e+02  9.37426832e+02  4.80173908e+03]
E1 = -182.02201204789415  E_coul = 53.78596506456427
cycle= 5 E= -128.23604698333  delta_E= -3.47e-09  |g|= 4.89e-06  |ddm|= 0.000106
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.94338e-06
diis-c [-2.71183538e-13 -1.11634298e-06 -2.66964033e-05  5.63123003e-03
 -6.89998797e-02  1.06339646e+00]
  HOMO = -0.812326176123375  LUMO = 1.9886876931974
  mo_energy =
[-3.28487253e+01 -1.93933923e+00 -8.12326176e-01 -8.12326176e-01
 -8.12326176e-01  1.98868769e+00  1.98868769e+00  1.98868769e+00
  2.09916021e+00  1.41931668e+01  1.41931668e+01  1.41931668e+01
  3.17736981e+01  2.02286607e+02  9.37426834e+02  4.80173908e+03]
E1 = -182.02200696989638  E_coul = 53.78595998656275
cycle= 6 E= -128.236046983334  delta_E= -3.75e-12  |g|= 1.27e-07  |ddm|= 3.49e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.02200696989638  E_coul = 53.78595998656275
  HOMO = -0.812326249371627  LUMO = 1.98868764005685
  mo_energy =
[-3.28487254e+01 -1.93933931e+00 -8.12326249e-01 -8.12326249e-01
 -8.12326249e-01  1.98868764e+00  1.98868764e+00  1.98868764e+00
  2.09916016e+00  1.41931666e+01  1.41931666e+01  1.41931666e+01
  3.17736979e+01  2.02286607e+02  9.37426834e+02  4.80173908e+03]
E1 = -182.02200737001704  E_coul = 53.785960386683556
Extra cycle  E= -128.236046983333  delta_E= 1.42e-13  |g|= 5.38e-08  |ddm|= 4.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 67.37920422068426
E1 = -182.02200737001704  E_coul = 53.785960386683556
init E= -128.236046983333
    CPU time for initialize scf      0.06 sec, wall time      0.06 sec
  HOMO = -0.81232622190356  LUMO = 1.98868765977809
  mo_energy =
[-3.28487254e+01 -1.93933928e+00 -8.12326222e-01 -8.12326222e-01
 -8.12326222e-01  1.98868766e+00  1.98868766e+00  1.98868766e+00
  2.09916018e+00  1.41931667e+01  1.41931667e+01  1.41931667e+01
  3.17736980e+01  2.02286607e+02  9.37426834e+02  4.80173908e+03]
E1 = -182.02200719569475  E_coul = 53.78596021236125
cycle= 1 E= -128.236046983333  delta_E=    0  |g|= 2.32e-08  |ddm|= 2.39e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.02200719569475  E_coul = 53.78596021236125
  HOMO = -0.812326234025988  LUMO = 1.98868765109039
  mo_energy =
[-3.28487254e+01 -1.93933929e+00 -8.12326234e-01 -8.12326234e-01
 -8.12326234e-01  1.98868765e+00  1.98868765e+00  1.98868765e+00
  2.09916017e+00  1.41931667e+01  1.41931667e+01  1.41931667e+01
  3.17736980e+01  2.02286607e+02  9.37426834e+02  4.80173908e+03]
E1 = -182.02200727131395  E_coul = 53.785960287980586
Extra cycle  E= -128.236046983333  delta_E= 1.14e-13  |g|= 1.01e-08  |ddm|= 9.94e-09
    CPU time for scf_cycle      0.11 sec, wall time      0.12 sec
exp = [2.42569710e+03 1.31494594e+02 4.65689142e+02 4.94251438e-01
 3.64491714e+01 1.09555768e+01 1.67861255e+00 2.15604450e+00
 9.95008418e+00 4.95144764e-01]
grad_E = [-1.06185073e-05  9.03824520e-04 -1.08804096e-04 -9.30855723e-03
 -1.17809285e-03 -1.77490166e-03 -4.25827054e-03 -5.91698273e-02
 -1.32837165e-02 -1.35846429e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2438.02455478        1
[INPUT] 0    0    [1    /1   ]  110.197930483        1
[INPUT] 0    0    [1    /1   ]  424.942538479        1
[INPUT] 0    0    [1    /1   ]  0.48714747373        1
[INPUT] 0    0    [1    /1   ]  33.2233827718        1
[INPUT] 0    0    [1    /1   ]  10.4706659861        1
[INPUT] 0    0    [1    /1   ]  1.66305092384        1
[INPUT] 1    0    [1    /1   ]  2.26343859364        1
[INPUT] 1    0    [1    /1   ]  10.5327441172        1
[INPUT] 1    0    [1    /1   ]  0.512536905988       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2438.0245547833406, 1.0]], [0, [110.19793048307983, 1.0]], [0, [424.9425384785174, 1.0]], [0, [0.4871474737304359, 1.0]], [0, [33.22338277176377, 1.0]], [0, [10.47066598605482, 1.0]], [0, [1.663050923843341, 1.0]], [1, [2.263438593637828, 1.0]], [1, [10.53274411721986, 1.0]], [1, [0.5125369059875861, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2438.02455478]
bas 1, expnt(s) = [110.19793048]
bas 2, expnt(s) = [424.94253848]
bas 3, expnt(s) = [0.48714747]
bas 4, expnt(s) = [33.22338277]
bas 5, expnt(s) = [10.47066599]
bas 6, expnt(s) = [1.66305092]
bas 7, expnt(s) = [2.26343859]
bas 8, expnt(s) = [10.53274412]
bas 9, expnt(s) = [0.51253691]
CPU time:       280.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43802455e+03 8.76584084e+02 1.10197930e+02 8.59300576e+01
 4.24942538e+02 2.36462720e+02 4.87147474e-01 1.47319544e+00
 3.32233828e+01 3.49621323e+01 1.04706660e+01 1.47060404e+01
 1.66305092e+00 3.69993577e+00 2.26343859e+00 8.09925902e+00
 1.05327441e+01 5.53555678e+01 5.12536906e-01 1.26514651e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.981276074301329
cond(S) = 74.75180429917842
E1 = -183.17399755229135  E_coul = 54.97573800704409
init E= -128.198259545247
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.740273149643655  LUMO = 2.10584957988848
  mo_energy =
[-3.25658558e+01 -1.85771186e+00 -7.40273150e-01 -7.40273150e-01
 -7.40273150e-01  2.10584958e+00  2.13829094e+00  2.13829094e+00
  2.13829094e+00  1.52980830e+01  1.52980830e+01  1.52980830e+01
  2.94907860e+01  1.75938340e+02  8.22155880e+02  4.60392064e+03]
E1 = -181.60741430602334  E_coul = 53.3566423978064
cycle= 1 E= -128.250771908217  delta_E= -0.0525  |g|= 0.228  |ddm|= 0.211
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.368757
diis-c [-0.13598155  1.        ]
  HOMO = -0.844993665074263  LUMO = 2.03202589567455
  mo_energy =
[-3.29454057e+01 -1.96964987e+00 -8.44993665e-01 -8.44993665e-01
 -8.44993665e-01  2.03202590e+00  2.06359931e+00  2.06359931e+00
  2.06359931e+00  1.50487638e+01  1.50487638e+01  1.50487638e+01
  2.91961581e+01  1.75545184e+02  8.21711970e+02  4.60343495e+03]
E1 = -182.32966490555995  E_coul = 54.07549449648637
cycle= 2 E= -128.254170409074  delta_E= -0.0034  |g|= 0.0963  |ddm|= 0.098
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.16107
diis-c [-3.02421289e-04  3.03000386e-01  6.96999614e-01]
  HOMO = -0.810123938053292  LUMO = 2.05722796410042
  mo_energy =
[-3.28352897e+01 -1.93323310e+00 -8.10123938e-01 -8.10123938e-01
 -8.10123938e-01  2.05722796e+00  2.08973022e+00  2.08973022e+00
  2.08973022e+00  1.51254236e+01  1.51254236e+01  1.51254236e+01
  2.92843381e+01  1.75658521e+02  8.21835376e+02  4.60356329e+03]
E1 = -182.1151648674372  E_coul = 53.86023078259016
cycle= 3 E= -128.254934084847  delta_E= -0.000764  |g|= 0.000902  |ddm|= 0.0284
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00136622
diis-c [-6.05893389e-07 -9.17414869e-03 -2.72052000e-02  1.03637935e+00]
  HOMO = -0.809950889815065  LUMO = 2.0572666980131
  mo_energy =
[-3.28348654e+01 -1.93324290e+00 -8.09950890e-01 -8.09950890e-01
 -8.09950890e-01  2.05726670e+00  2.08992739e+00  2.08992739e+00
  2.08992739e+00  1.51257813e+01  1.51257813e+01  1.51257813e+01
  2.92846253e+01  1.75659095e+02  8.21836281e+02  4.60356443e+03]
E1 = -182.1143128049316  E_coul = 53.85937862944314
cycle= 4 E= -128.254934175488  delta_E= -9.06e-08  |g|= 0.000127  |ddm|= 0.000425
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000179151
diis-c [-2.14492973e-09  5.61570081e-04  1.49773173e-03 -1.76446863e-01
  1.17438756e+00]
  HOMO = -0.809924404653226  LUMO = 2.05725498602599
  mo_energy =
[-3.28348062e+01 -1.93325339e+00 -8.09924405e-01 -8.09924405e-01
 -8.09924405e-01  2.05725499e+00  2.08994383e+00  2.08994383e+00
  2.08994383e+00  1.51258227e+01  1.51258227e+01  1.51258227e+01
  2.92846587e+01  1.75659168e+02  8.21836395e+02  4.60356458e+03]
E1 = -182.11421674723346  E_coul = 53.85928256945148
cycle= 5 E= -128.254934177782  delta_E= -2.29e-09  |g|= 4.31e-06  |ddm|= 8.51e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.28364e-06
diis-c [-2.15919289e-13 -5.23723886e-06 -2.51113797e-05  6.17525259e-03
 -7.27746028e-02  1.06662970e+00]
  HOMO = -0.809923406572772  LUMO = 2.05725480460707
  mo_energy =
[-3.28348039e+01 -1.93325362e+00 -8.09923407e-01 -8.09923407e-01
 -8.09923407e-01  2.05725480e+00  2.08994465e+00  2.08994465e+00
  2.08994465e+00  1.51258244e+01  1.51258244e+01  1.51258244e+01
  2.92846604e+01  1.75659170e+02  8.21836397e+02  4.60356458e+03]
E1 = -182.11421198424515  E_coul = 53.85927780646048
cycle= 6 E= -128.254934177785  delta_E= -2.67e-12  |g|= 1.12e-07  |ddm|= 3.01e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.11421198424515  E_coul = 53.85927780646048
  HOMO = -0.80992346996823  LUMO = 2.05725475793965
  mo_energy =
[-3.28348041e+01 -1.93325369e+00 -8.09923470e-01 -8.09923470e-01
 -8.09923470e-01  2.05725476e+00  2.08994460e+00  2.08994460e+00
  2.08994460e+00  1.51258243e+01  1.51258243e+01  1.51258243e+01
  2.92846602e+01  1.75659170e+02  8.21836397e+02  4.60356458e+03]
E1 = -182.11421233238966  E_coul = 53.85927815460505
Extra cycle  E= -128.254934177785  delta_E= 5.68e-14  |g|= 4.68e-08  |ddm|= 4.44e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.43802455e+03 1.10197930e+02 4.24942538e+02 4.87147474e-01
 3.32233828e+01 1.04706660e+01 1.66305092e+00 2.26343859e+00
 1.05327441e+01 5.12536906e-01]
E = -128.2549341777846
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2438.02455478        1
[INPUT] 0    0    [1    /1   ]  110.197930483        1
[INPUT] 0    0    [1    /1   ]  424.942538479        1
[INPUT] 0    0    [1    /1   ]  0.48714747373        1
[INPUT] 0    0    [1    /1   ]  33.2233827718        1
[INPUT] 0    0    [1    /1   ]  10.4706659861        1
[INPUT] 0    0    [1    /1   ]  1.66305092384        1
[INPUT] 1    0    [1    /1   ]  2.26343859364        1
[INPUT] 1    0    [1    /1   ]  10.5327441172        1
[INPUT] 1    0    [1    /1   ]  0.512536905988       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2438.0245547833406, 1.0]], [0, [110.19793048307983, 1.0]], [0, [424.9425384785174, 1.0]], [0, [0.4871474737304359, 1.0]], [0, [33.22338277176377, 1.0]], [0, [10.47066598605482, 1.0]], [0, [1.663050923843341, 1.0]], [1, [2.263438593637828, 1.0]], [1, [10.53274411721986, 1.0]], [1, [0.5125369059875861, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2438.02455478]
bas 1, expnt(s) = [110.19793048]
bas 2, expnt(s) = [424.94253848]
bas 3, expnt(s) = [0.48714747]
bas 4, expnt(s) = [33.22338277]
bas 5, expnt(s) = [10.47066599]
bas 6, expnt(s) = [1.66305092]
bas 7, expnt(s) = [2.26343859]
bas 8, expnt(s) = [10.53274412]
bas 9, expnt(s) = [0.51253691]
CPU time:       281.53
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43802455e+03 8.76584084e+02 1.10197930e+02 8.59300576e+01
 4.24942538e+02 2.36462720e+02 4.87147474e-01 1.47319544e+00
 3.32233828e+01 3.49621323e+01 1.04706660e+01 1.47060404e+01
 1.66305092e+00 3.69993577e+00 2.26343859e+00 8.09925902e+00
 1.05327441e+01 5.53555678e+01 5.12536906e-01 1.26514651e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.981276074301329
cond(S) = 74.75180429917842
E1 = -183.17399755229135  E_coul = 54.97573800704409
init E= -128.198259545247
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.740273149643655  LUMO = 2.10584957988848
  mo_energy =
[-3.25658558e+01 -1.85771186e+00 -7.40273150e-01 -7.40273150e-01
 -7.40273150e-01  2.10584958e+00  2.13829094e+00  2.13829094e+00
  2.13829094e+00  1.52980830e+01  1.52980830e+01  1.52980830e+01
  2.94907860e+01  1.75938340e+02  8.22155880e+02  4.60392064e+03]
E1 = -181.60741430602334  E_coul = 53.3566423978064
cycle= 1 E= -128.250771908217  delta_E= -0.0525  |g|= 0.228  |ddm|= 0.211
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.368757
diis-c [-0.13598155  1.        ]
  HOMO = -0.844993665074263  LUMO = 2.03202589567455
  mo_energy =
[-3.29454057e+01 -1.96964987e+00 -8.44993665e-01 -8.44993665e-01
 -8.44993665e-01  2.03202590e+00  2.06359931e+00  2.06359931e+00
  2.06359931e+00  1.50487638e+01  1.50487638e+01  1.50487638e+01
  2.91961581e+01  1.75545184e+02  8.21711970e+02  4.60343495e+03]
E1 = -182.32966490555995  E_coul = 54.07549449648637
cycle= 2 E= -128.254170409074  delta_E= -0.0034  |g|= 0.0963  |ddm|= 0.098
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.16107
diis-c [-3.02421289e-04  3.03000386e-01  6.96999614e-01]
  HOMO = -0.810123938053292  LUMO = 2.05722796410042
  mo_energy =
[-3.28352897e+01 -1.93323310e+00 -8.10123938e-01 -8.10123938e-01
 -8.10123938e-01  2.05722796e+00  2.08973022e+00  2.08973022e+00
  2.08973022e+00  1.51254236e+01  1.51254236e+01  1.51254236e+01
  2.92843381e+01  1.75658521e+02  8.21835376e+02  4.60356329e+03]
E1 = -182.1151648674372  E_coul = 53.86023078259016
cycle= 3 E= -128.254934084847  delta_E= -0.000764  |g|= 0.000902  |ddm|= 0.0284
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00136622
diis-c [-6.05893389e-07 -9.17414869e-03 -2.72052000e-02  1.03637935e+00]
  HOMO = -0.809950889815065  LUMO = 2.0572666980131
  mo_energy =
[-3.28348654e+01 -1.93324290e+00 -8.09950890e-01 -8.09950890e-01
 -8.09950890e-01  2.05726670e+00  2.08992739e+00  2.08992739e+00
  2.08992739e+00  1.51257813e+01  1.51257813e+01  1.51257813e+01
  2.92846253e+01  1.75659095e+02  8.21836281e+02  4.60356443e+03]
E1 = -182.1143128049316  E_coul = 53.85937862944314
cycle= 4 E= -128.254934175488  delta_E= -9.06e-08  |g|= 0.000127  |ddm|= 0.000425
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000179151
diis-c [-2.14492973e-09  5.61570081e-04  1.49773173e-03 -1.76446863e-01
  1.17438756e+00]
  HOMO = -0.809924404653226  LUMO = 2.05725498602599
  mo_energy =
[-3.28348062e+01 -1.93325339e+00 -8.09924405e-01 -8.09924405e-01
 -8.09924405e-01  2.05725499e+00  2.08994383e+00  2.08994383e+00
  2.08994383e+00  1.51258227e+01  1.51258227e+01  1.51258227e+01
  2.92846587e+01  1.75659168e+02  8.21836395e+02  4.60356458e+03]
E1 = -182.11421674723346  E_coul = 53.85928256945148
cycle= 5 E= -128.254934177782  delta_E= -2.29e-09  |g|= 4.31e-06  |ddm|= 8.51e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.28364e-06
diis-c [-2.15919289e-13 -5.23723886e-06 -2.51113797e-05  6.17525259e-03
 -7.27746028e-02  1.06662970e+00]
  HOMO = -0.809923406572772  LUMO = 2.05725480460707
  mo_energy =
[-3.28348039e+01 -1.93325362e+00 -8.09923407e-01 -8.09923407e-01
 -8.09923407e-01  2.05725480e+00  2.08994465e+00  2.08994465e+00
  2.08994465e+00  1.51258244e+01  1.51258244e+01  1.51258244e+01
  2.92846604e+01  1.75659170e+02  8.21836397e+02  4.60356458e+03]
E1 = -182.11421198424515  E_coul = 53.85927780646048
cycle= 6 E= -128.254934177785  delta_E= -2.67e-12  |g|= 1.12e-07  |ddm|= 3.01e-06
    CPU time for cycle= 6      0.01 sec, wall time      0.01 sec
E1 = -182.11421198424515  E_coul = 53.85927780646048
  HOMO = -0.80992346996823  LUMO = 2.05725475793965
  mo_energy =
[-3.28348041e+01 -1.93325369e+00 -8.09923470e-01 -8.09923470e-01
 -8.09923470e-01  2.05725476e+00  2.08994460e+00  2.08994460e+00
  2.08994460e+00  1.51258243e+01  1.51258243e+01  1.51258243e+01
  2.92846602e+01  1.75659170e+02  8.21836397e+02  4.60356458e+03]
E1 = -182.11421233238966  E_coul = 53.85927815460505
Extra cycle  E= -128.254934177785  delta_E= 5.68e-14  |g|= 4.68e-08  |ddm|= 4.44e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 74.75180429917842
E1 = -182.11421233238966  E_coul = 53.85927815460505
init E= -128.254934177785
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.809923446030751  LUMO = 2.05725477566761
  mo_energy =
[-3.28348040e+01 -1.93325366e+00 -8.09923446e-01 -8.09923446e-01
 -8.09923446e-01  2.05725478e+00  2.08994462e+00  2.08994462e+00
  2.08994462e+00  1.51258243e+01  1.51258243e+01  1.51258243e+01
  2.92846603e+01  1.75659170e+02  8.21836397e+02  4.60356458e+03]
E1 = -182.11421218241304  E_coul = 53.85927800462839
cycle= 1 E= -128.254934177785  delta_E= -5.68e-14  |g|= 2e-08  |ddm|= 2.03e-08
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.11421218241304  E_coul = 53.85927800462839
  HOMO = -0.809923456430914  LUMO = 2.05725476813723
  mo_energy =
[-3.28348040e+01 -1.93325367e+00 -8.09923456e-01 -8.09923456e-01
 -8.09923456e-01  2.05725477e+00  2.08994461e+00  2.08994461e+00
  2.08994461e+00  1.51258243e+01  1.51258243e+01  1.51258243e+01
  2.92846603e+01  1.75659170e+02  8.21836397e+02  4.60356458e+03]
E1 = -182.11421224673174  E_coul = 53.85927806894715
Extra cycle  E= -128.254934177785  delta_E= 5.68e-14  |g|= 8.61e-09  |ddm|= 8.52e-09
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
exp = [2.43802455e+03 1.10197930e+02 4.24942538e+02 4.87147474e-01
 3.32233828e+01 1.04706660e+01 1.66305092e+00 2.26343859e+00
 1.05327441e+01 5.12536906e-01]
grad_E = [-1.05633887e-05 -1.69735952e-04 -1.62194904e-05 -1.02701936e-02
  2.15438967e-03 -4.71751939e-03 -4.06245665e-03 -4.67813856e-02
 -9.25513085e-03 -2.74382114e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2441.6370261         1
[INPUT] 0    0    [1    /1   ]  97.9025209227        1
[INPUT] 0    0    [1    /1   ]  413.52230812         1
[INPUT] 0    0    [1    /1   ]  0.502769213251       1
[INPUT] 0    0    [1    /1   ]  29.6051584628        1
[INPUT] 0    0    [1    /1   ]  9.82857247719        1
[INPUT] 0    0    [1    /1   ]  1.75147796241        1
[INPUT] 1    0    [1    /1   ]  2.53687620472        1
[INPUT] 1    0    [1    /1   ]  12.1541448707        1
[INPUT] 1    0    [1    /1   ]  0.557433894849       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2441.63702610232, 1.0]], [0, [97.90252092269168, 1.0]], [0, [413.52230812031763, 1.0]], [0, [0.5027692132507233, 1.0]], [0, [29.605158462840144, 1.0]], [0, [9.828572477187684, 1.0]], [0, [1.7514779624110406, 1.0]], [1, [2.536876204724191, 1.0]], [1, [12.154144870659376, 1.0]], [1, [0.5574338948488005, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2441.6370261]
bas 1, expnt(s) = [97.90252092]
bas 2, expnt(s) = [413.52230812]
bas 3, expnt(s) = [0.50276921]
bas 4, expnt(s) = [29.60515846]
bas 5, expnt(s) = [9.82857248]
bas 6, expnt(s) = [1.75147796]
bas 7, expnt(s) = [2.5368762]
bas 8, expnt(s) = [12.15414487]
bas 9, expnt(s) = [0.55743389]
CPU time:       284.57
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44163703e+03 8.77558043e+02 9.79025209e+01 7.86340112e+01
 4.13522308e+02 2.31680367e+02 5.02769213e-01 1.50848686e+00
 2.96051585e+01 3.20656883e+01 9.82857248e+00 1.40243537e+01
 1.75147796e+00 3.84652476e+00 2.53687620e+00 9.34024969e+00
 1.21541449e+01 6.62048648e+01 5.57433895e-01 1.40516107e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.974671501329784
cond(S) = 79.59159114594821
E1 = -183.21731934404605  E_coul = 54.99846198582322
init E= -128.218857358223
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742852223186555  LUMO = 2.23986312884979
  mo_energy =
[-3.25555650e+01 -1.85696259e+00 -7.42852223e-01 -7.42852223e-01
 -7.42852223e-01  2.23986313e+00  2.40150217e+00  2.40150217e+00
  2.40150217e+00  1.78681521e+01  1.78681521e+01  1.78681521e+01
  2.72157840e+01  1.55474193e+02  7.59987966e+02  4.51647423e+03]
E1 = -181.90137779181237  E_coul = 53.63100729218477
cycle= 1 E= -128.270370499628  delta_E= -0.0515  |g|= 0.199  |ddm|=  0.2
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.320691
diis-c [-0.10284295  1.        ]
  HOMO = -0.829512892205859  LUMO = 2.17925544182831
  mo_energy =
[-3.28857858e+01 -1.94747579e+00 -8.29512892e-01 -8.29512892e-01
 -8.29512892e-01  2.17925544e+00  2.33374294e+00  2.33374294e+00
  2.33374294e+00  1.76409067e+01  1.76409067e+01  1.76409067e+01
  2.69717719e+01  1.55136166e+02  7.59594875e+02  4.51603628e+03]
E1 = -182.49693370156285  E_coul = 54.22408031564788
cycle= 2 E= -128.272853385915  delta_E= -0.00248  |g|= 0.0803  |ddm|= 0.0804
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.13325
diis-c [-2.65228024e-04  2.92249597e-01  7.07750403e-01]
  HOMO = -0.800547180712812  LUMO = 2.20090836139059
  mo_energy =
[-3.27924820e+01 -1.91736409e+00 -8.00547181e-01 -8.00547181e-01
 -8.00547181e-01  2.20090836e+00  2.35783115e+00  2.35783115e+00
  2.35783115e+00  1.77091139e+01  1.77091139e+01  1.77091139e+01
  2.70436508e+01  1.55231154e+02  7.59699900e+02  4.51614593e+03]
E1 = -182.32304850584197  E_coul = 54.04968115721962
cycle= 3 E= -128.273367348622  delta_E= -0.000514  |g|= 0.00046  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000525197
diis-c [-1.58662240e-07 -6.31505619e-03 -1.51056582e-02  1.02142071e+00]
  HOMO = -0.800592628514808  LUMO = 2.2008500958438
  mo_energy =
[-3.27925681e+01 -1.91748848e+00 -8.00592629e-01 -8.00592629e-01
 -8.00592629e-01  2.20085010e+00  2.35784585e+00  2.35784585e+00
  2.35784585e+00  1.77090576e+01  1.77090576e+01  1.77090576e+01
  2.70435206e+01  1.55231168e+02  7.59700152e+02  4.51614635e+03]
E1 = -182.32327441188812  E_coul = 54.04990704984823
cycle= 4 E= -128.27336736204  delta_E= -1.34e-08  |g|= 5.81e-05  |ddm|= 0.000184
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.70842e-05
diis-c [-6.18928794e-10  5.27708386e-04  7.28325758e-04 -1.49594043e-01
  1.14833801e+00]
  HOMO = -0.800578508198951  LUMO = 2.20084756444208
  mo_energy =
[-3.27925355e+01 -1.91748962e+00 -8.00578508e-01 -8.00578508e-01
 -8.00578508e-01  2.20084756e+00  2.35785620e+00  2.35785620e+00
  2.35785620e+00  1.77090823e+01  1.77090823e+01  1.77090823e+01
  2.70435399e+01  1.55231206e+02  7.59700210e+02  4.51614642e+03]
E1 = -182.32322204893148  E_coul = 54.049854686462645
cycle= 5 E= -128.273367362469  delta_E= -4.29e-10  |g|= 3.23e-06  |ddm|= 3.34e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.32322204893148  E_coul = 54.049854686462645
  HOMO = -0.800577717648892  LUMO = 2.2008475709175
  mo_energy =
[-3.27925336e+01 -1.91748960e+00 -8.00577718e-01 -8.00577718e-01
 -8.00577718e-01  2.20084757e+00  2.35785690e+00  2.35785690e+00
  2.35785690e+00  1.77090837e+01  1.77090837e+01  1.77090837e+01
  2.70435413e+01  1.55231208e+02  7.59700213e+02  4.51614642e+03]
E1 = -182.32321852322985  E_coul = 54.04985116075937
Extra cycle  E= -128.27336736247  delta_E= -1.65e-12  |g|= 8.06e-07  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.44163703e+03 9.79025209e+01 4.13522308e+02 5.02769213e-01
 2.96051585e+01 9.82857248e+00 1.75147796e+00 2.53687620e+00
 1.21541449e+01 5.57433895e-01]
E = -128.27336736247048
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2441.6370261         1
[INPUT] 0    0    [1    /1   ]  97.9025209227        1
[INPUT] 0    0    [1    /1   ]  413.52230812         1
[INPUT] 0    0    [1    /1   ]  0.502769213251       1
[INPUT] 0    0    [1    /1   ]  29.6051584628        1
[INPUT] 0    0    [1    /1   ]  9.82857247719        1
[INPUT] 0    0    [1    /1   ]  1.75147796241        1
[INPUT] 1    0    [1    /1   ]  2.53687620472        1
[INPUT] 1    0    [1    /1   ]  12.1541448707        1
[INPUT] 1    0    [1    /1   ]  0.557433894849       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2441.63702610232, 1.0]], [0, [97.90252092269168, 1.0]], [0, [413.52230812031763, 1.0]], [0, [0.5027692132507233, 1.0]], [0, [29.605158462840144, 1.0]], [0, [9.828572477187684, 1.0]], [0, [1.7514779624110406, 1.0]], [1, [2.536876204724191, 1.0]], [1, [12.154144870659376, 1.0]], [1, [0.5574338948488005, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2441.6370261]
bas 1, expnt(s) = [97.90252092]
bas 2, expnt(s) = [413.52230812]
bas 3, expnt(s) = [0.50276921]
bas 4, expnt(s) = [29.60515846]
bas 5, expnt(s) = [9.82857248]
bas 6, expnt(s) = [1.75147796]
bas 7, expnt(s) = [2.5368762]
bas 8, expnt(s) = [12.15414487]
bas 9, expnt(s) = [0.55743389]
CPU time:       285.72
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44163703e+03 8.77558043e+02 9.79025209e+01 7.86340112e+01
 4.13522308e+02 2.31680367e+02 5.02769213e-01 1.50848686e+00
 2.96051585e+01 3.20656883e+01 9.82857248e+00 1.40243537e+01
 1.75147796e+00 3.84652476e+00 2.53687620e+00 9.34024969e+00
 1.21541449e+01 6.62048648e+01 5.57433895e-01 1.40516107e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.974671501329784
cond(S) = 79.59159114594821
E1 = -183.21731934404605  E_coul = 54.99846198582322
init E= -128.218857358223
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742852223186555  LUMO = 2.23986312884979
  mo_energy =
[-3.25555650e+01 -1.85696259e+00 -7.42852223e-01 -7.42852223e-01
 -7.42852223e-01  2.23986313e+00  2.40150217e+00  2.40150217e+00
  2.40150217e+00  1.78681521e+01  1.78681521e+01  1.78681521e+01
  2.72157840e+01  1.55474193e+02  7.59987966e+02  4.51647423e+03]
E1 = -181.90137779181237  E_coul = 53.63100729218477
cycle= 1 E= -128.270370499628  delta_E= -0.0515  |g|= 0.199  |ddm|=  0.2
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.320691
diis-c [-0.10284295  1.        ]
  HOMO = -0.829512892205859  LUMO = 2.17925544182831
  mo_energy =
[-3.28857858e+01 -1.94747579e+00 -8.29512892e-01 -8.29512892e-01
 -8.29512892e-01  2.17925544e+00  2.33374294e+00  2.33374294e+00
  2.33374294e+00  1.76409067e+01  1.76409067e+01  1.76409067e+01
  2.69717719e+01  1.55136166e+02  7.59594875e+02  4.51603628e+03]
E1 = -182.49693370156285  E_coul = 54.22408031564788
cycle= 2 E= -128.272853385915  delta_E= -0.00248  |g|= 0.0803  |ddm|= 0.0804
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.13325
diis-c [-2.65228024e-04  2.92249597e-01  7.07750403e-01]
  HOMO = -0.800547180712812  LUMO = 2.20090836139059
  mo_energy =
[-3.27924820e+01 -1.91736409e+00 -8.00547181e-01 -8.00547181e-01
 -8.00547181e-01  2.20090836e+00  2.35783115e+00  2.35783115e+00
  2.35783115e+00  1.77091139e+01  1.77091139e+01  1.77091139e+01
  2.70436508e+01  1.55231154e+02  7.59699900e+02  4.51614593e+03]
E1 = -182.32304850584197  E_coul = 54.04968115721962
cycle= 3 E= -128.273367348622  delta_E= -0.000514  |g|= 0.00046  |ddm|= 0.0233
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000525197
diis-c [-1.58662240e-07 -6.31505619e-03 -1.51056582e-02  1.02142071e+00]
  HOMO = -0.800592628514808  LUMO = 2.2008500958438
  mo_energy =
[-3.27925681e+01 -1.91748848e+00 -8.00592629e-01 -8.00592629e-01
 -8.00592629e-01  2.20085010e+00  2.35784585e+00  2.35784585e+00
  2.35784585e+00  1.77090576e+01  1.77090576e+01  1.77090576e+01
  2.70435206e+01  1.55231168e+02  7.59700152e+02  4.51614635e+03]
E1 = -182.32327441188812  E_coul = 54.04990704984823
cycle= 4 E= -128.27336736204  delta_E= -1.34e-08  |g|= 5.81e-05  |ddm|= 0.000184
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=8.70842e-05
diis-c [-6.18928794e-10  5.27708386e-04  7.28325758e-04 -1.49594043e-01
  1.14833801e+00]
  HOMO = -0.800578508198951  LUMO = 2.20084756444208
  mo_energy =
[-3.27925355e+01 -1.91748962e+00 -8.00578508e-01 -8.00578508e-01
 -8.00578508e-01  2.20084756e+00  2.35785620e+00  2.35785620e+00
  2.35785620e+00  1.77090823e+01  1.77090823e+01  1.77090823e+01
  2.70435399e+01  1.55231206e+02  7.59700210e+02  4.51614642e+03]
E1 = -182.32322204893148  E_coul = 54.049854686462645
cycle= 5 E= -128.273367362469  delta_E= -4.29e-10  |g|= 3.23e-06  |ddm|= 3.34e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.32322204893148  E_coul = 54.049854686462645
  HOMO = -0.800577717648892  LUMO = 2.2008475709175
  mo_energy =
[-3.27925336e+01 -1.91748960e+00 -8.00577718e-01 -8.00577718e-01
 -8.00577718e-01  2.20084757e+00  2.35785690e+00  2.35785690e+00
  2.35785690e+00  1.77090837e+01  1.77090837e+01  1.77090837e+01
  2.70435413e+01  1.55231208e+02  7.59700213e+02  4.51614642e+03]
E1 = -182.32321852322985  E_coul = 54.04985116075937
Extra cycle  E= -128.27336736247  delta_E= -1.65e-12  |g|= 8.06e-07  |ddm|= 1.84e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 79.59159114594821
E1 = -182.32321852322985  E_coul = 54.04985116075937
init E= -128.27336736247
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.80057792416404  LUMO = 2.20084729175609
  mo_energy =
[-3.27925344e+01 -1.91748998e+00 -8.00577924e-01 -8.00577924e-01
 -8.00577924e-01  2.20084729e+00  2.35785672e+00  2.35785672e+00
  2.35785672e+00  1.77090832e+01  1.77090832e+01  1.77090832e+01
  2.70435407e+01  1.55231207e+02  7.59700212e+02  4.51614642e+03]
E1 = -182.3232200297154  E_coul = 54.049852667244785
cycle= 1 E= -128.273367362471  delta_E= -1.42e-13  |g|= 2.24e-07  |ddm|= 4.7e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.3232200297154  E_coul = 54.049852667244785
  HOMO = -0.800577813442712  LUMO = 2.20084735139897
  mo_energy =
[-3.27925340e+01 -1.91748989e+00 -8.00577813e-01 -8.00577813e-01
 -8.00577813e-01  2.20084735e+00  2.35785681e+00  2.35785681e+00
  2.35785681e+00  1.77090834e+01  1.77090834e+01  1.77090834e+01
  2.70435409e+01  1.55231208e+02  7.59700212e+02  4.51614642e+03]
E1 = -182.3232194149965  E_coul = 54.04985205252608
Extra cycle  E= -128.27336736247  delta_E= 1.99e-13  |g|= 8.81e-08  |ddm|= 8.79e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.44163703e+03 9.79025209e+01 4.13522308e+02 5.02769213e-01
 2.96051585e+01 9.82857248e+00 1.75147796e+00 2.53687620e+00
 1.21541449e+01 5.57433895e-01]
grad_E = [-1.37230136e-05 -9.05601946e-04  1.27050142e-04 -2.50980679e-02
  1.65584483e-03 -2.02248375e-03  7.15928939e-03 -3.09683000e-02
 -4.58134196e-04 -2.73435550e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2436.83819964        1
[INPUT] 0    0    [1    /1   ]  109.650447263        1
[INPUT] 0    0    [1    /1   ]  429.107523405        1
[INPUT] 0    0    [1    /1   ]  0.522992156638       1
[INPUT] 0    0    [1    /1   ]  30.5432909428        1
[INPUT] 0    0    [1    /1   ]  9.82570692116        1
[INPUT] 0    0    [1    /1   ]  1.80458362957        1
[INPUT] 1    0    [1    /1   ]  2.71453908241        1
[INPUT] 1    0    [1    /1   ]  13.1794581711        1
[INPUT] 1    0    [1    /1   ]  0.587503784621       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2436.8381996394487, 1.0]], [0, [109.65044726337156, 1.0]], [0, [429.10752340460687, 1.0]], [0, [0.5229921566382751, 1.0]], [0, [30.54329094280246, 1.0]], [0, [9.825706921164917, 1.0]], [0, [1.8045836295719413, 1.0]], [1, [2.7145390824056967, 1.0]], [1, [13.179458171094357, 1.0]], [1, [0.5875037846214296, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2436.83819964]
bas 1, expnt(s) = [109.65044726]
bas 2, expnt(s) = [429.1075234]
bas 3, expnt(s) = [0.52299216]
bas 4, expnt(s) = [30.54329094]
bas 5, expnt(s) = [9.82570692]
bas 6, expnt(s) = [1.80458363]
bas 7, expnt(s) = [2.71453908]
bas 8, expnt(s) = [13.17945817]
bas 9, expnt(s) = [0.58750378]
CPU time:       288.67
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43683820e+03 8.76264151e+02 1.09650447e+02 8.56096714e+01
 4.29107523e+02 2.38198828e+02 5.22992157e-01 1.55376883e+00
 3.05432909e+01 3.28247854e+01 9.82570692e+00 1.40212870e+01
 1.80458363e+00 3.93366874e+00 2.71453908e+00 1.01649329e+01
 1.31794582e+01 7.32582159e+01 5.87503785e-01 1.50054052e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.969200583647883
cond(S) = 72.69756039058295
E1 = -183.21709377427376  E_coul = 55.005102254079745
init E= -128.211991520194
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74330806645251  LUMO = 2.3668347048529
  mo_energy =
[-3.25513737e+01 -1.85678293e+00 -7.43308066e-01 -7.43308066e-01
 -7.43308066e-01  2.36683470e+00  2.58159223e+00  2.58159223e+00
  2.58159223e+00  1.95638310e+01  1.95638310e+01  1.95638310e+01
  2.78967501e+01  1.66966410e+02  8.13426983e+02  4.60323051e+03]
E1 = -182.09912047652327  E_coul = 53.82586914123623
cycle= 1 E= -128.273251335287  delta_E= -0.0613  |g|= 0.178  |ddm|= 0.187
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.283112
diis-c [-0.08015232  1.        ]
  HOMO = -0.81593196260412  LUMO = 2.31599766998553
  mo_energy =
[-3.28458331e+01 -1.93165457e+00 -8.15931963e-01 -8.15931963e-01
 -8.15931963e-01  2.31599767e+00  2.52191437e+00  2.52191437e+00
  2.52191437e+00  1.93579122e+01  1.93579122e+01  1.93579122e+01
  2.76815179e+01  1.66660196e+02  8.13067771e+02  4.60283038e+03]
E1 = -182.60594352379792  E_coul = 54.3307880402372
cycle= 2 E= -128.275155483561  delta_E= -0.0019  |g|= 0.0686  |ddm|= 0.069
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.113308
diis-c [-2.25428154e-04  2.84309284e-01  7.15690716e-01]
  HOMO = -0.791134334935231  LUMO = 2.33514908682698
  mo_energy =
[-3.27649086e+01 -1.90596289e+00 -7.91134335e-01 -7.91134335e-01
 -7.91134335e-01  2.33514909e+00  2.54385617e+00  2.54385617e+00
  2.54385617e+00  1.94185852e+01  1.94185852e+01  1.94185852e+01
  2.77439862e+01  1.66743455e+02  8.13159511e+02  4.60292609e+03]
E1 = -182.46034353068546  E_coul = 54.184820214783336
cycle= 3 E= -128.275523315902  delta_E= -0.000368  |g|= 0.000481  |ddm|= 0.0198
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000532796
diis-c [-9.54834772e-08 -5.48880903e-03 -1.05250513e-02  1.01601386e+00]
  HOMO = -0.791260698062574  LUMO = 2.33503607288523
  mo_energy =
[-3.27652052e+01 -1.90614494e+00 -7.91260698e-01 -7.91260698e-01
 -7.91260698e-01  2.33503607e+00  2.54378678e+00  2.54378678e+00
  2.54378678e+00  1.94183510e+01  1.94183510e+01  1.94183510e+01
  2.77436896e+01  1.66743270e+02  8.13159521e+02  4.60292623e+03]
E1 = -182.4609748704268  E_coul = 54.185451542953416
cycle= 4 E= -128.275523327473  delta_E= -1.16e-08  |g|= 4.26e-05  |ddm|= 0.000161
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.80528e-05
diis-c [-4.51758932e-10  3.72783761e-04  3.42685494e-05 -1.18207760e-01
  1.11780071e+00]
  HOMO = -0.791248511789241  LUMO = 2.33503696577043
  mo_energy =
[-3.27651753e+01 -1.90614242e+00 -7.91248512e-01 -7.91248512e-01
 -7.91248512e-01  2.33503697e+00  2.54379673e+00  2.54379673e+00
  2.54379673e+00  1.94183745e+01  1.94183745e+01  1.94183745e+01
  2.77437095e+01  1.66743305e+02  8.13159570e+02  4.60292629e+03]
E1 = -182.4609256297145  E_coul = 54.1854023020344
cycle= 5 E= -128.27552332768  delta_E= -2.07e-10  |g|= 2.89e-06  |ddm|= 2.08e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4609256297145  E_coul = 54.1854023020344
  HOMO = -0.791247959903113  LUMO = 2.33503681648388
  mo_energy =
[-3.27651740e+01 -1.90614259e+00 -7.91247960e-01 -7.91247960e-01
 -7.91247960e-01  2.33503682e+00  2.54379723e+00  2.54379723e+00
  2.54379723e+00  1.94183754e+01  1.94183754e+01  1.94183754e+01
  2.77437103e+01  1.66743307e+02  8.13159572e+02  4.60292630e+03]
E1 = -182.46092366569204  E_coul = 54.185400338010915
Extra cycle  E= -128.275523327681  delta_E= -1.02e-12  |g|= 6.34e-07  |ddm|= 1.66e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43683820e+03 1.09650447e+02 4.29107523e+02 5.22992157e-01
 3.05432909e+01 9.82570692e+00 1.80458363e+00 2.71453908e+00
 1.31794582e+01 5.87503785e-01]
E = -128.27552332768113
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2436.83819964        1
[INPUT] 0    0    [1    /1   ]  109.650447263        1
[INPUT] 0    0    [1    /1   ]  429.107523405        1
[INPUT] 0    0    [1    /1   ]  0.522992156638       1
[INPUT] 0    0    [1    /1   ]  30.5432909428        1
[INPUT] 0    0    [1    /1   ]  9.82570692116        1
[INPUT] 0    0    [1    /1   ]  1.80458362957        1
[INPUT] 1    0    [1    /1   ]  2.71453908241        1
[INPUT] 1    0    [1    /1   ]  13.1794581711        1
[INPUT] 1    0    [1    /1   ]  0.587503784621       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2436.8381996394487, 1.0]], [0, [109.65044726337156, 1.0]], [0, [429.10752340460687, 1.0]], [0, [0.5229921566382751, 1.0]], [0, [30.54329094280246, 1.0]], [0, [9.825706921164917, 1.0]], [0, [1.8045836295719413, 1.0]], [1, [2.7145390824056967, 1.0]], [1, [13.179458171094357, 1.0]], [1, [0.5875037846214296, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2436.83819964]
bas 1, expnt(s) = [109.65044726]
bas 2, expnt(s) = [429.1075234]
bas 3, expnt(s) = [0.52299216]
bas 4, expnt(s) = [30.54329094]
bas 5, expnt(s) = [9.82570692]
bas 6, expnt(s) = [1.80458363]
bas 7, expnt(s) = [2.71453908]
bas 8, expnt(s) = [13.17945817]
bas 9, expnt(s) = [0.58750378]
CPU time:       289.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43683820e+03 8.76264151e+02 1.09650447e+02 8.56096714e+01
 4.29107523e+02 2.38198828e+02 5.22992157e-01 1.55376883e+00
 3.05432909e+01 3.28247854e+01 9.82570692e+00 1.40212870e+01
 1.80458363e+00 3.93366874e+00 2.71453908e+00 1.01649329e+01
 1.31794582e+01 7.32582159e+01 5.87503785e-01 1.50054052e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.969200583647883
cond(S) = 72.69756039058295
E1 = -183.21709377427376  E_coul = 55.005102254079745
init E= -128.211991520194
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74330806645251  LUMO = 2.3668347048529
  mo_energy =
[-3.25513737e+01 -1.85678293e+00 -7.43308066e-01 -7.43308066e-01
 -7.43308066e-01  2.36683470e+00  2.58159223e+00  2.58159223e+00
  2.58159223e+00  1.95638310e+01  1.95638310e+01  1.95638310e+01
  2.78967501e+01  1.66966410e+02  8.13426983e+02  4.60323051e+03]
E1 = -182.09912047652327  E_coul = 53.82586914123623
cycle= 1 E= -128.273251335287  delta_E= -0.0613  |g|= 0.178  |ddm|= 0.187
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.283112
diis-c [-0.08015232  1.        ]
  HOMO = -0.81593196260412  LUMO = 2.31599766998553
  mo_energy =
[-3.28458331e+01 -1.93165457e+00 -8.15931963e-01 -8.15931963e-01
 -8.15931963e-01  2.31599767e+00  2.52191437e+00  2.52191437e+00
  2.52191437e+00  1.93579122e+01  1.93579122e+01  1.93579122e+01
  2.76815179e+01  1.66660196e+02  8.13067771e+02  4.60283038e+03]
E1 = -182.60594352379792  E_coul = 54.3307880402372
cycle= 2 E= -128.275155483561  delta_E= -0.0019  |g|= 0.0686  |ddm|= 0.069
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.113308
diis-c [-2.25428154e-04  2.84309284e-01  7.15690716e-01]
  HOMO = -0.791134334935231  LUMO = 2.33514908682698
  mo_energy =
[-3.27649086e+01 -1.90596289e+00 -7.91134335e-01 -7.91134335e-01
 -7.91134335e-01  2.33514909e+00  2.54385617e+00  2.54385617e+00
  2.54385617e+00  1.94185852e+01  1.94185852e+01  1.94185852e+01
  2.77439862e+01  1.66743455e+02  8.13159511e+02  4.60292609e+03]
E1 = -182.46034353068546  E_coul = 54.184820214783336
cycle= 3 E= -128.275523315902  delta_E= -0.000368  |g|= 0.000481  |ddm|= 0.0198
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000532796
diis-c [-9.54834772e-08 -5.48880903e-03 -1.05250513e-02  1.01601386e+00]
  HOMO = -0.791260698062574  LUMO = 2.33503607288523
  mo_energy =
[-3.27652052e+01 -1.90614494e+00 -7.91260698e-01 -7.91260698e-01
 -7.91260698e-01  2.33503607e+00  2.54378678e+00  2.54378678e+00
  2.54378678e+00  1.94183510e+01  1.94183510e+01  1.94183510e+01
  2.77436896e+01  1.66743270e+02  8.13159521e+02  4.60292623e+03]
E1 = -182.4609748704268  E_coul = 54.185451542953416
cycle= 4 E= -128.275523327473  delta_E= -1.16e-08  |g|= 4.26e-05  |ddm|= 0.000161
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.80528e-05
diis-c [-4.51758932e-10  3.72783761e-04  3.42685494e-05 -1.18207760e-01
  1.11780071e+00]
  HOMO = -0.791248511789241  LUMO = 2.33503696577043
  mo_energy =
[-3.27651753e+01 -1.90614242e+00 -7.91248512e-01 -7.91248512e-01
 -7.91248512e-01  2.33503697e+00  2.54379673e+00  2.54379673e+00
  2.54379673e+00  1.94183745e+01  1.94183745e+01  1.94183745e+01
  2.77437095e+01  1.66743305e+02  8.13159570e+02  4.60292629e+03]
E1 = -182.4609256297145  E_coul = 54.1854023020344
cycle= 5 E= -128.27552332768  delta_E= -2.07e-10  |g|= 2.89e-06  |ddm|= 2.08e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4609256297145  E_coul = 54.1854023020344
  HOMO = -0.791247959903113  LUMO = 2.33503681648388
  mo_energy =
[-3.27651740e+01 -1.90614259e+00 -7.91247960e-01 -7.91247960e-01
 -7.91247960e-01  2.33503682e+00  2.54379723e+00  2.54379723e+00
  2.54379723e+00  1.94183754e+01  1.94183754e+01  1.94183754e+01
  2.77437103e+01  1.66743307e+02  8.13159572e+02  4.60292630e+03]
E1 = -182.46092366569204  E_coul = 54.185400338010915
Extra cycle  E= -128.275523327681  delta_E= -1.02e-12  |g|= 6.34e-07  |ddm|= 1.66e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 72.69756039058295
E1 = -182.46092366569204  E_coul = 54.185400338010915
init E= -128.275523327681
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.791248061036969  LUMO = 2.33503662456068
  mo_energy =
[-3.27651745e+01 -1.90614283e+00 -7.91248061e-01 -7.91248061e-01
 -7.91248061e-01  2.33503662e+00  2.54379714e+00  2.54379714e+00
  2.54379714e+00  1.94183751e+01  1.94183751e+01  1.94183751e+01
  2.77437099e+01  1.66743306e+02  8.13159572e+02  4.60292630e+03]
E1 = -182.46092451196074  E_coul = 54.18540118427962
cycle= 1 E= -128.275523327681  delta_E=    0  |g|= 1.46e-07  |ddm|= 3.76e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.46092451196074  E_coul = 54.18540118427962
  HOMO = -0.791247996696614  LUMO = 2.33503665322543
  mo_energy =
[-3.27651743e+01 -1.90614279e+00 -7.91247997e-01 -7.91247997e-01
 -7.91247997e-01  2.33503665e+00  2.54379719e+00  2.54379719e+00
  2.54379719e+00  1.94183753e+01  1.94183753e+01  1.94183753e+01
  2.77437100e+01  1.66743306e+02  8.13159572e+02  4.60292630e+03]
E1 = -182.46092418189016  E_coul = 54.18540085420911
Extra cycle  E= -128.275523327681  delta_E= 5.68e-14  |g|= 5.06e-08  |ddm|= 6.11e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43683820e+03 1.09650447e+02 4.29107523e+02 5.22992157e-01
 3.05432909e+01 9.82570692e+00 1.80458363e+00 2.71453908e+00
 1.31794582e+01 5.87503785e-01]
grad_E = [-8.09972803e-06  1.30312805e-03 -1.16148245e-04 -7.32897332e-03
 -4.67828157e-03  3.06362439e-03  5.01868548e-03 -1.70670154e-02
  2.01836782e-03 -1.22913467e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2438.37217853        1
[INPUT] 0    0    [1    /1   ]  106.422424317        1
[INPUT] 0    0    [1    /1   ]  424.078709688        1
[INPUT] 0    0    [1    /1   ]  0.521715529339       1
[INPUT] 0    0    [1    /1   ]  30.6283967886        1
[INPUT] 0    0    [1    /1   ]  9.86553314072        1
[INPUT] 0    0    [1    /1   ]  1.78328574172        1
[INPUT] 1    0    [1    /1   ]  2.72867489241        1
[INPUT] 1    0    [1    /1   ]  13.1532749267        1
[INPUT] 1    0    [1    /1   ]  0.591768125572       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2438.3721785328835, 1.0]], [0, [106.42242431736551, 1.0]], [0, [424.0787096882629, 1.0]], [0, [0.5217155293387808, 1.0]], [0, [30.628396788606032, 1.0]], [0, [9.865533140715694, 1.0]], [0, [1.7832857417160666, 1.0]], [1, [2.72867489240621, 1.0]], [1, [13.153274926739355, 1.0]], [1, [0.5917681255715944, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2438.37217853]
bas 1, expnt(s) = [106.42242432]
bas 2, expnt(s) = [424.07870969]
bas 3, expnt(s) = [0.52171553]
bas 4, expnt(s) = [30.62839679]
bas 5, expnt(s) = [9.86553314]
bas 6, expnt(s) = [1.78328574]
bas 7, expnt(s) = [2.72867489]
bas 8, expnt(s) = [13.15327493]
bas 9, expnt(s) = [0.59176813]
CPU time:       292.73
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43837218e+03 8.76677822e+02 1.06422424e+02 8.37124177e+01
 4.24078710e+02 2.36102115e+02 5.21715529e-01 1.55092340e+00
 3.06283968e+01 3.28933588e+01 9.86553314e+00 1.40638895e+01
 1.78328574e+00 3.89879793e+00 2.72867489e+00 1.02311426e+01
 1.31532749e+01 7.30763361e+01 5.91768126e-01 1.51416727e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.968481153424012
cond(S) = 74.61858161050073
E1 = -183.22601647304933  E_coul = 55.006071238087756
init E= -128.219945234962
    CPU time for initialize scf      0.02 sec, wall time      0.03 sec
  HOMO = -0.743139827817308  LUMO = 2.34049728491685
  mo_energy =
[-3.25528990e+01 -1.85670177e+00 -7.43139828e-01 -7.43139828e-01
 -7.43139828e-01  2.34049728e+00  2.60399780e+00  2.60399780e+00
  2.60399780e+00  1.95937025e+01  1.95937025e+01  1.95937025e+01
  2.79141292e+01  1.64829987e+02  7.99401542e+02  4.57855550e+03]
E1 = -182.13724446673368  E_coul = 53.8608293873591
cycle= 1 E= -128.276415079375  delta_E= -0.0565  |g|= 0.173  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.277361
diis-c [-0.0769289  1.       ]
  HOMO = -0.813274424623963  LUMO = 2.29257532181847
  mo_energy =
[-3.28407471e+01 -1.92873459e+00 -8.13274425e-01 -8.13274425e-01
 -8.13274425e-01  2.29257532e+00  2.54613014e+00  2.54613014e+00
  2.54613014e+00  1.93929148e+01  1.93929148e+01  1.93929148e+01
  2.77040655e+01  1.64531094e+02  7.99050491e+02  4.57816246e+03]
E1 = -182.6300538505558  E_coul = 54.35182584582242
cycle= 2 E= -128.278228004733  delta_E= -0.00181  |g|= 0.0667  |ddm|= 0.0672
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.110193
diis-c [-2.20989919e-04  2.82755644e-01  7.17244356e-01]
  HOMO = -0.78911723190036  LUMO = 2.31102717619326
  mo_energy =
[-3.27618357e+01 -1.90372589e+00 -7.89117232e-01 -7.89117232e-01
 -7.89117232e-01  2.31102718e+00  2.56763338e+00  2.56763338e+00
  2.56763338e+00  1.94519982e+01  1.94519982e+01  1.94519982e+01
  2.77650162e+01  1.64612131e+02  7.99139893e+02  4.57825579e+03]
E1 = -182.48876544737035  E_coul = 54.210190634082146
cycle= 3 E= -128.278574813288  delta_E= -0.000347  |g|= 0.000485  |ddm|= 0.0192
    CPU time for cycle= 3      0.01 sec, wall time      0.04 sec
diis-norm(errvec)=0.000576436
diis-c [-7.31196829e-08 -5.10156294e-03 -8.59784229e-03  1.01369941e+00]
  HOMO = -0.789263324466654  LUMO = 2.31090350770315
  mo_energy =
[-3.27621953e+01 -1.90392257e+00 -7.89263324e-01 -7.89263324e-01
 -7.89263324e-01  2.31090351e+00  2.56754349e+00  2.56754349e+00
  2.56754349e+00  1.94517134e+01  1.94517134e+01  1.94517134e+01
  2.77646743e+01  1.64611871e+02  7.99139812e+02  4.57825583e+03]
E1 = -182.48950821924896  E_coul = 54.210933393000474
cycle= 4 E= -128.278574826248  delta_E= -1.3e-08  |g|= 3.85e-05  |ddm|= 0.000165
    CPU time for cycle= 4      0.01 sec, wall time      0.02 sec
diis-norm(errvec)=6.13968e-05
diis-c [-3.53895140e-10  3.97925997e-04 -1.00969725e-05 -1.24247244e-01
  1.12385942e+00]
  HOMO = -0.78925222682137  LUMO = 2.310904349575
  mo_energy =
[-3.27621681e+01 -1.90392025e+00 -7.89252227e-01 -7.89252227e-01
 -7.89252227e-01  2.31090435e+00  2.56755264e+00  2.56755264e+00
  2.56755264e+00  1.94517347e+01  1.94517347e+01  1.94517347e+01
  2.77646923e+01  1.64611902e+02  7.99139856e+02  4.57825588e+03]
E1 = -182.4894639698798  E_coul = 54.210889143462424
cycle= 5 E= -128.278574826417  delta_E= -1.69e-10  |g|= 2.49e-06  |ddm|= 1.9e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4894639698798  E_coul = 54.210889143462424
  HOMO = -0.789251768884436  LUMO = 2.31090421135125
  mo_energy =
[-3.27621671e+01 -1.90392042e+00 -7.89251769e-01 -7.89251769e-01
 -7.89251769e-01  2.31090421e+00  2.56755306e+00  2.56755306e+00
  2.56755306e+00  1.94517354e+01  1.94517354e+01  1.94517354e+01
  2.77646930e+01  1.64611903e+02  7.99139858e+02  4.57825589e+03]
E1 = -182.4894624118672  E_coul = 54.21088758544885
Extra cycle  E= -128.278574826418  delta_E= -9.66e-13  |g|= 5.37e-07  |ddm|= 1.45e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.14 sec
exp = [2.43837218e+03 1.06422424e+02 4.24078710e+02 5.21715529e-01
 3.06283968e+01 9.86553314e+00 1.78328574e+00 2.72867489e+00
 1.31532749e+01 5.91768126e-01]
E = -128.27857482641835
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2438.37217853        1
[INPUT] 0    0    [1    /1   ]  106.422424317        1
[INPUT] 0    0    [1    /1   ]  424.078709688        1
[INPUT] 0    0    [1    /1   ]  0.521715529339       1
[INPUT] 0    0    [1    /1   ]  30.6283967886        1
[INPUT] 0    0    [1    /1   ]  9.86553314072        1
[INPUT] 0    0    [1    /1   ]  1.78328574172        1
[INPUT] 1    0    [1    /1   ]  2.72867489241        1
[INPUT] 1    0    [1    /1   ]  13.1532749267        1
[INPUT] 1    0    [1    /1   ]  0.591768125572       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2438.3721785328835, 1.0]], [0, [106.42242431736551, 1.0]], [0, [424.0787096882629, 1.0]], [0, [0.5217155293387808, 1.0]], [0, [30.628396788606032, 1.0]], [0, [9.865533140715694, 1.0]], [0, [1.7832857417160666, 1.0]], [1, [2.72867489240621, 1.0]], [1, [13.153274926739355, 1.0]], [1, [0.5917681255715944, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2438.37217853]
bas 1, expnt(s) = [106.42242432]
bas 2, expnt(s) = [424.07870969]
bas 3, expnt(s) = [0.52171553]
bas 4, expnt(s) = [30.62839679]
bas 5, expnt(s) = [9.86553314]
bas 6, expnt(s) = [1.78328574]
bas 7, expnt(s) = [2.72867489]
bas 8, expnt(s) = [13.15327493]
bas 9, expnt(s) = [0.59176813]
CPU time:       293.92
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43837218e+03 8.76677822e+02 1.06422424e+02 8.37124177e+01
 4.24078710e+02 2.36102115e+02 5.21715529e-01 1.55092340e+00
 3.06283968e+01 3.28933588e+01 9.86553314e+00 1.40638895e+01
 1.78328574e+00 3.89879793e+00 2.72867489e+00 1.02311426e+01
 1.31532749e+01 7.30763361e+01 5.91768126e-01 1.51416727e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.968481153424012
cond(S) = 74.61858161050073
E1 = -183.22601647304933  E_coul = 55.006071238087756
init E= -128.219945234962
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743139827817308  LUMO = 2.34049728491685
  mo_energy =
[-3.25528990e+01 -1.85670177e+00 -7.43139828e-01 -7.43139828e-01
 -7.43139828e-01  2.34049728e+00  2.60399780e+00  2.60399780e+00
  2.60399780e+00  1.95937025e+01  1.95937025e+01  1.95937025e+01
  2.79141292e+01  1.64829987e+02  7.99401542e+02  4.57855550e+03]
E1 = -182.13724446673368  E_coul = 53.8608293873591
cycle= 1 E= -128.276415079375  delta_E= -0.0565  |g|= 0.173  |ddm|= 0.181
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.277361
diis-c [-0.0769289  1.       ]
  HOMO = -0.813274424623963  LUMO = 2.29257532181847
  mo_energy =
[-3.28407471e+01 -1.92873459e+00 -8.13274425e-01 -8.13274425e-01
 -8.13274425e-01  2.29257532e+00  2.54613014e+00  2.54613014e+00
  2.54613014e+00  1.93929148e+01  1.93929148e+01  1.93929148e+01
  2.77040655e+01  1.64531094e+02  7.99050491e+02  4.57816246e+03]
E1 = -182.6300538505558  E_coul = 54.35182584582242
cycle= 2 E= -128.278228004733  delta_E= -0.00181  |g|= 0.0667  |ddm|= 0.0672
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.110193
diis-c [-2.20989919e-04  2.82755644e-01  7.17244356e-01]
  HOMO = -0.78911723190036  LUMO = 2.31102717619326
  mo_energy =
[-3.27618357e+01 -1.90372589e+00 -7.89117232e-01 -7.89117232e-01
 -7.89117232e-01  2.31102718e+00  2.56763338e+00  2.56763338e+00
  2.56763338e+00  1.94519982e+01  1.94519982e+01  1.94519982e+01
  2.77650162e+01  1.64612131e+02  7.99139893e+02  4.57825579e+03]
E1 = -182.48876544737035  E_coul = 54.210190634082146
cycle= 3 E= -128.278574813288  delta_E= -0.000347  |g|= 0.000485  |ddm|= 0.0192
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000576436
diis-c [-7.31196829e-08 -5.10156294e-03 -8.59784229e-03  1.01369941e+00]
  HOMO = -0.789263324466654  LUMO = 2.31090350770315
  mo_energy =
[-3.27621953e+01 -1.90392257e+00 -7.89263324e-01 -7.89263324e-01
 -7.89263324e-01  2.31090351e+00  2.56754349e+00  2.56754349e+00
  2.56754349e+00  1.94517134e+01  1.94517134e+01  1.94517134e+01
  2.77646743e+01  1.64611871e+02  7.99139812e+02  4.57825583e+03]
E1 = -182.48950821924896  E_coul = 54.210933393000474
cycle= 4 E= -128.278574826248  delta_E= -1.3e-08  |g|= 3.85e-05  |ddm|= 0.000165
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=6.13968e-05
diis-c [-3.53895140e-10  3.97925997e-04 -1.00969725e-05 -1.24247244e-01
  1.12385942e+00]
  HOMO = -0.78925222682137  LUMO = 2.310904349575
  mo_energy =
[-3.27621681e+01 -1.90392025e+00 -7.89252227e-01 -7.89252227e-01
 -7.89252227e-01  2.31090435e+00  2.56755264e+00  2.56755264e+00
  2.56755264e+00  1.94517347e+01  1.94517347e+01  1.94517347e+01
  2.77646923e+01  1.64611902e+02  7.99139856e+02  4.57825588e+03]
E1 = -182.4894639698798  E_coul = 54.210889143462424
cycle= 5 E= -128.278574826417  delta_E= -1.69e-10  |g|= 2.49e-06  |ddm|= 1.9e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.4894639698798  E_coul = 54.210889143462424
  HOMO = -0.789251768884436  LUMO = 2.31090421135125
  mo_energy =
[-3.27621671e+01 -1.90392042e+00 -7.89251769e-01 -7.89251769e-01
 -7.89251769e-01  2.31090421e+00  2.56755306e+00  2.56755306e+00
  2.56755306e+00  1.94517354e+01  1.94517354e+01  1.94517354e+01
  2.77646930e+01  1.64611903e+02  7.99139858e+02  4.57825589e+03]
E1 = -182.4894624118672  E_coul = 54.21088758544885
Extra cycle  E= -128.278574826418  delta_E= -9.66e-13  |g|= 5.37e-07  |ddm|= 1.45e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 74.61858161050073
E1 = -182.4894624118672  E_coul = 54.21088758544885
init E= -128.278574826418
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.789251846482532  LUMO = 2.31090405485946
  mo_energy =
[-3.27621675e+01 -1.90392062e+00 -7.89251846e-01 -7.89251846e-01
 -7.89251846e-01  2.31090405e+00  2.56755299e+00  2.56755299e+00
  2.56755299e+00  1.94517352e+01  1.94517352e+01  1.94517352e+01
  2.77646927e+01  1.64611903e+02  7.99139857e+02  4.57825589e+03]
E1 = -182.48946309075467  E_coul = 54.210888264336326
cycle= 1 E= -128.278574826418  delta_E=    0  |g|= 1.21e-07  |ddm|= 3.22e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.48946309075467  E_coul = 54.210888264336326
  HOMO = -0.789251794423678  LUMO = 2.31090407661163
  mo_energy =
[-3.27621673e+01 -1.90392059e+00 -7.89251794e-01 -7.89251794e-01
 -7.89251794e-01  2.31090408e+00  2.56755304e+00  2.56755304e+00
  2.56755304e+00  1.94517353e+01  1.94517353e+01  1.94517353e+01
  2.77646928e+01  1.64611903e+02  7.99139857e+02  4.57825589e+03]
E1 = -182.4894628290174  E_coul = 54.21088800259906
Extra cycle  E= -128.278574826418  delta_E=    0  |g|= 4.08e-08  |ddm|= 5.17e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43837218e+03 1.06422424e+02 4.24078710e+02 5.21715529e-01
 3.06283968e+01 9.86553314e+00 1.78328574e+00 2.72867489e+00
 1.31532749e+01 5.91768126e-01]
grad_E = [-1.00176289e-05  4.93003798e-04 -4.38314719e-05  2.70591521e-03
 -1.42134688e-03 -5.73560216e-04  1.50750374e-03 -1.09928042e-02
  8.14968122e-04  5.23504925e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2441.69855617        1
[INPUT] 0    0    [1    /1   ]  101.969715561        1
[INPUT] 0    0    [1    /1   ]  412.973899192        1
[INPUT] 0    0    [1    /1   ]  0.515447905088       1
[INPUT] 0    0    [1    /1   ]  30.2195216782        1
[INPUT] 0    0    [1    /1   ]  9.84389830633        1
[INPUT] 0    0    [1    /1   ]  1.75701803387        1
[INPUT] 1    0    [1    /1   ]  2.76069545329        1
[INPUT] 1    0    [1    /1   ]  13.2414943471        1
[INPUT] 1    0    [1    /1   ]  0.59783569189        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2441.6985561664965, 1.0]], [0, [101.96971556140988, 1.0]], [0, [412.9738991918164, 1.0]], [0, [0.5154479050884333, 1.0]], [0, [30.219521678208956, 1.0]], [0, [9.84389830633405, 1.0]], [0, [1.7570180338720407, 1.0]], [1, [2.7606954532928993, 1.0]], [1, [13.241494347122865, 1.0]], [1, [0.597835691889739, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2441.69855617]
bas 1, expnt(s) = [101.96971556]
bas 2, expnt(s) = [412.97389919]
bas 3, expnt(s) = [0.51544791]
bas 4, expnt(s) = [30.21952168]
bas 5, expnt(s) = [9.84389831]
bas 6, expnt(s) = [1.75701803]
bas 7, expnt(s) = [2.76069545]
bas 8, expnt(s) = [13.24149435]
bas 9, expnt(s) = [0.59783569]
CPU time:       296.82
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44169856e+03 8.77574629e+02 1.01969716e+02 8.10715414e+01
 4.12973899e+02 2.31449889e+02 5.15447905e-01 1.53692830e+00
 3.02195217e+01 3.25634727e+01 9.84389831e+00 1.40407518e+01
 1.75701803e+00 3.85564632e+00 2.76069545e+00 1.03814381e+01
 1.32414943e+01 7.36895055e+01 5.97835692e-01 1.53359856e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967360117087019
cond(S) = 77.47222951682477
E1 = -183.2288450987727  E_coul = 55.00696576341599
init E= -128.221879335357
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74305208623842  LUMO = 2.29071196731906
  mo_energy =
[-3.25529305e+01 -1.85671877e+00 -7.43052086e-01 -7.43052086e-01
 -7.43052086e-01  2.29071197e+00  2.64040892e+00  2.64040892e+00
  2.64040892e+00  1.98041556e+01  1.98041556e+01  1.98041556e+01
  2.75624956e+01  1.60199045e+02  7.73556281e+02  4.53092597e+03]
E1 = -182.17243171719142  E_coul = 53.89521767427779
cycle= 1 E= -128.277214042914  delta_E= -0.0553  |g|= 0.169  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.272002
diis-c [-0.07398515  1.        ]
  HOMO = -0.810874288393684  LUMO = 2.24620573108969
  mo_energy =
[-3.28339848e+01 -1.92582326e+00 -8.10874288e-01 -8.10874288e-01
 -8.10874288e-01  2.24620573e+00  2.58393134e+00  2.58393134e+00
  2.58393134e+00  1.96078113e+01  1.96078113e+01  1.96078113e+01
  2.73586753e+01  1.59908469e+02  7.73213701e+02  4.53053993e+03]
E1 = -182.6507362799523  E_coul = 54.37179938425154
cycle= 2 E= -128.278936895701  delta_E= -0.00172  |g|= 0.0648  |ddm|= 0.065
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.107
diis-c [-2.21610961e-04  2.80647179e-01  7.19352821e-01]
  HOMO = -0.787377040267222  LUMO = 2.26383714257347
  mo_energy =
[-3.27570782e+01 -1.90151349e+00 -7.87377040e-01 -7.87377040e-01
 -7.87377040e-01  2.26383714e+00  2.60508673e+00  2.60508673e+00
  2.60508673e+00  1.96654847e+01  1.96654847e+01  1.96654847e+01
  2.74178443e+01  1.59987167e+02  7.73300724e+02  4.53063088e+03]
E1 = -182.51380347579396  E_coul = 54.23454056041476
cycle= 3 E= -128.279262915379  delta_E= -0.000326  |g|= 0.000515  |ddm|= 0.0187
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000697423
diis-c [-3.78556916e-08 -4.45849142e-03 -5.19198168e-03  1.00965047e+00]
  HOMO = -0.787562365154756  LUMO = 2.26370104653583
  mo_energy =
[-3.27575431e+01 -1.90172937e+00 -7.87562365e-01 -7.87562365e-01
 -7.87562365e-01  2.26370105e+00  2.60495864e+00  2.60495864e+00
  2.60495864e+00  1.96651147e+01  1.96651147e+01  1.96651147e+01
  2.74174259e+01  1.59986787e+02  7.73300491e+02  4.53063075e+03]
E1 = -182.51472824986436  E_coul = 54.23546531898763
cycle= 4 E= -128.279262930877  delta_E= -1.55e-08  |g|= 2.41e-05  |ddm|= 0.000153
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.97122e-05
diis-c [-1.64167424e-10  2.79813779e-04 -1.87757499e-04 -9.31381418e-02
  1.09304609e+00]
  HOMO = -0.787554973593754  LUMO = 2.26370238320856
  mo_energy =
[-3.27575245e+01 -1.90172679e+00 -7.87554974e-01 -7.87554974e-01
 -7.87554974e-01  2.26370238e+00  2.60496479e+00  2.60496479e+00
  2.60496479e+00  1.96651294e+01  1.96651294e+01  1.96651294e+01
  2.74174385e+01  1.59986808e+02  7.73300521e+02  4.53063078e+03]
E1 = -182.51469773861143  E_coul = 54.23543480767469
cycle= 5 E= -128.279262930937  delta_E= -6e-11  |g|= 1.89e-06  |ddm|= 1.03e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51469773861143  E_coul = 54.23543480767469
  HOMO = -0.787554557731324  LUMO = 2.26370232995945
  mo_energy =
[-3.27575236e+01 -1.90172684e+00 -7.87554558e-01 -7.87554558e-01
 -7.87554558e-01  2.26370233e+00  2.60496517e+00  2.60496517e+00
  2.60496517e+00  1.96651301e+01  1.96651301e+01  1.96651301e+01
  2.74174391e+01  1.59986809e+02  7.73300522e+02  4.53063079e+03]
E1 = -182.51469626273263  E_coul = 54.235433331795385
Extra cycle  E= -128.279262930937  delta_E= -5.12e-13  |g|= 4.27e-07  |ddm|= 1.08e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.44169856e+03 1.01969716e+02 4.12973899e+02 5.15447905e-01
 3.02195217e+01 9.84389831e+00 1.75701803e+00 2.76069545e+00
 1.32414943e+01 5.97835692e-01]
E = -128.27926293093725
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2441.69855617        1
[INPUT] 0    0    [1    /1   ]  101.969715561        1
[INPUT] 0    0    [1    /1   ]  412.973899192        1
[INPUT] 0    0    [1    /1   ]  0.515447905088       1
[INPUT] 0    0    [1    /1   ]  30.2195216782        1
[INPUT] 0    0    [1    /1   ]  9.84389830633        1
[INPUT] 0    0    [1    /1   ]  1.75701803387        1
[INPUT] 1    0    [1    /1   ]  2.76069545329        1
[INPUT] 1    0    [1    /1   ]  13.2414943471        1
[INPUT] 1    0    [1    /1   ]  0.59783569189        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2441.6985561664965, 1.0]], [0, [101.96971556140988, 1.0]], [0, [412.9738991918164, 1.0]], [0, [0.5154479050884333, 1.0]], [0, [30.219521678208956, 1.0]], [0, [9.84389830633405, 1.0]], [0, [1.7570180338720407, 1.0]], [1, [2.7606954532928993, 1.0]], [1, [13.241494347122865, 1.0]], [1, [0.597835691889739, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2441.69855617]
bas 1, expnt(s) = [101.96971556]
bas 2, expnt(s) = [412.97389919]
bas 3, expnt(s) = [0.51544791]
bas 4, expnt(s) = [30.21952168]
bas 5, expnt(s) = [9.84389831]
bas 6, expnt(s) = [1.75701803]
bas 7, expnt(s) = [2.76069545]
bas 8, expnt(s) = [13.24149435]
bas 9, expnt(s) = [0.59783569]
CPU time:       298.04
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44169856e+03 8.77574629e+02 1.01969716e+02 8.10715414e+01
 4.12973899e+02 2.31449889e+02 5.15447905e-01 1.53692830e+00
 3.02195217e+01 3.25634727e+01 9.84389831e+00 1.40407518e+01
 1.75701803e+00 3.85564632e+00 2.76069545e+00 1.03814381e+01
 1.32414943e+01 7.36895055e+01 5.97835692e-01 1.53359856e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967360117087019
cond(S) = 77.47222951682477
E1 = -183.2288450987727  E_coul = 55.00696576341599
init E= -128.221879335357
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74305208623842  LUMO = 2.29071196731906
  mo_energy =
[-3.25529305e+01 -1.85671877e+00 -7.43052086e-01 -7.43052086e-01
 -7.43052086e-01  2.29071197e+00  2.64040892e+00  2.64040892e+00
  2.64040892e+00  1.98041556e+01  1.98041556e+01  1.98041556e+01
  2.75624956e+01  1.60199045e+02  7.73556281e+02  4.53092597e+03]
E1 = -182.17243171719142  E_coul = 53.89521767427779
cycle= 1 E= -128.277214042914  delta_E= -0.0553  |g|= 0.169  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.272002
diis-c [-0.07398515  1.        ]
  HOMO = -0.810874288393684  LUMO = 2.24620573108969
  mo_energy =
[-3.28339848e+01 -1.92582326e+00 -8.10874288e-01 -8.10874288e-01
 -8.10874288e-01  2.24620573e+00  2.58393134e+00  2.58393134e+00
  2.58393134e+00  1.96078113e+01  1.96078113e+01  1.96078113e+01
  2.73586753e+01  1.59908469e+02  7.73213701e+02  4.53053993e+03]
E1 = -182.6507362799523  E_coul = 54.37179938425154
cycle= 2 E= -128.278936895701  delta_E= -0.00172  |g|= 0.0648  |ddm|= 0.065
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.107
diis-c [-2.21610961e-04  2.80647179e-01  7.19352821e-01]
  HOMO = -0.787377040267222  LUMO = 2.26383714257347
  mo_energy =
[-3.27570782e+01 -1.90151349e+00 -7.87377040e-01 -7.87377040e-01
 -7.87377040e-01  2.26383714e+00  2.60508673e+00  2.60508673e+00
  2.60508673e+00  1.96654847e+01  1.96654847e+01  1.96654847e+01
  2.74178443e+01  1.59987167e+02  7.73300724e+02  4.53063088e+03]
E1 = -182.51380347579396  E_coul = 54.23454056041476
cycle= 3 E= -128.279262915379  delta_E= -0.000326  |g|= 0.000515  |ddm|= 0.0187
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000697423
diis-c [-3.78556916e-08 -4.45849142e-03 -5.19198168e-03  1.00965047e+00]
  HOMO = -0.787562365154756  LUMO = 2.26370104653583
  mo_energy =
[-3.27575431e+01 -1.90172937e+00 -7.87562365e-01 -7.87562365e-01
 -7.87562365e-01  2.26370105e+00  2.60495864e+00  2.60495864e+00
  2.60495864e+00  1.96651147e+01  1.96651147e+01  1.96651147e+01
  2.74174259e+01  1.59986787e+02  7.73300491e+02  4.53063075e+03]
E1 = -182.51472824986436  E_coul = 54.23546531898763
cycle= 4 E= -128.279262930877  delta_E= -1.55e-08  |g|= 2.41e-05  |ddm|= 0.000153
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.97122e-05
diis-c [-1.64167424e-10  2.79813779e-04 -1.87757499e-04 -9.31381418e-02
  1.09304609e+00]
  HOMO = -0.787554973593754  LUMO = 2.26370238320856
  mo_energy =
[-3.27575245e+01 -1.90172679e+00 -7.87554974e-01 -7.87554974e-01
 -7.87554974e-01  2.26370238e+00  2.60496479e+00  2.60496479e+00
  2.60496479e+00  1.96651294e+01  1.96651294e+01  1.96651294e+01
  2.74174385e+01  1.59986808e+02  7.73300521e+02  4.53063078e+03]
E1 = -182.51469773861143  E_coul = 54.23543480767469
cycle= 5 E= -128.279262930937  delta_E= -6e-11  |g|= 1.89e-06  |ddm|= 1.03e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51469773861143  E_coul = 54.23543480767469
  HOMO = -0.787554557731324  LUMO = 2.26370232995945
  mo_energy =
[-3.27575236e+01 -1.90172684e+00 -7.87554558e-01 -7.87554558e-01
 -7.87554558e-01  2.26370233e+00  2.60496517e+00  2.60496517e+00
  2.60496517e+00  1.96651301e+01  1.96651301e+01  1.96651301e+01
  2.74174391e+01  1.59986809e+02  7.73300522e+02  4.53063079e+03]
E1 = -182.51469626273263  E_coul = 54.235433331795385
Extra cycle  E= -128.279262930937  delta_E= -5.12e-13  |g|= 4.27e-07  |ddm|= 1.08e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.47222951682477
E1 = -182.51469626273263  E_coul = 54.235433331795385
init E= -128.279262930937
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787554636205857  LUMO = 2.26370219899164
  mo_energy =
[-3.27575239e+01 -1.90172701e+00 -7.87554636e-01 -7.87554636e-01
 -7.87554636e-01  2.26370220e+00  2.60496510e+00  2.60496510e+00
  2.60496510e+00  1.96651299e+01  1.96651299e+01  1.96651299e+01
  2.74174388e+01  1.59986809e+02  7.73300522e+02  4.53063079e+03]
E1 = -182.51469690185172  E_coul = 54.23543397091447
cycle= 1 E= -128.279262930937  delta_E=    0  |g|= 1.04e-07  |ddm|= 2.54e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.51469690185172  E_coul = 54.23543397091447
  HOMO = -0.787554588136969  LUMO = 2.26370222162556
  mo_energy =
[-3.27575237e+01 -1.90172698e+00 -7.87554588e-01 -7.87554588e-01
 -7.87554588e-01  2.26370222e+00  2.60496514e+00  2.60496514e+00
  2.60496514e+00  1.96651300e+01  1.96651300e+01  1.96651300e+01
  2.74174389e+01  1.59986809e+02  7.73300522e+02  4.53063079e+03]
E1 = -182.5146966562367  E_coul = 54.23543372529935
Extra cycle  E= -128.279262930937  delta_E= -1.14e-13  |g|= 3.69e-08  |ddm|= 4.18e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.44169856e+03 1.01969716e+02 4.12973899e+02 5.15447905e-01
 3.02195217e+01 9.84389831e+00 1.75701803e+00 2.76069545e+00
 1.32414943e+01 5.97835692e-01]
grad_E = [-9.58308526e-06 -8.02521560e-05  7.75595903e-07  3.08820006e-03
  3.51740235e-04 -2.01654557e-03 -1.70608947e-04 -1.89647408e-03
 -1.15917332e-04  2.23364323e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:44 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2438.81064223        1
[INPUT] 0    0    [1    /1   ]  104.511333415        1
[INPUT] 0    0    [1    /1   ]  422.719496557        1
[INPUT] 0    0    [1    /1   ]  0.518024343288       1
[INPUT] 0    0    [1    /1   ]  30.8277804206        1
[INPUT] 0    0    [1    /1   ]  9.98398114783        1
[INPUT] 0    0    [1    /1   ]  1.76757951839        1
[INPUT] 1    0    [1    /1   ]  2.76627583604        1
[INPUT] 1    0    [1    /1   ]  13.2762287743        1
[INPUT] 1    0    [1    /1   ]  0.598477252476       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2438.8106422257774, 1.0]], [0, [104.51133341513808, 1.0]], [0, [422.7194965574206, 1.0]], [0, [0.518024343288391, 1.0]], [0, [30.82778042058376, 1.0]], [0, [9.983981147825599, 1.0]], [0, [1.7675795183903007, 1.0]], [1, [2.7662758360378112, 1.0]], [1, [13.276228774296802, 1.0]], [1, [0.5984772524761891, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2438.81064223]
bas 1, expnt(s) = [104.51133342]
bas 2, expnt(s) = [422.71949656]
bas 3, expnt(s) = [0.51802434]
bas 4, expnt(s) = [30.82778042]
bas 5, expnt(s) = [9.98398115]
bas 6, expnt(s) = [1.76757952]
bas 7, expnt(s) = [2.76627584]
bas 8, expnt(s) = [13.27622877]
bas 9, expnt(s) = [0.59847725]
CPU time:       300.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43881064e+03 8.76796051e+02 1.04511333e+02 8.25824125e+01
 4.22719497e+02 2.35534339e+02 5.18024343e-01 1.54268640e+00
 3.08277804e+01 3.30538245e+01 9.98398115e+00 1.41903412e+01
 1.76757952e+00 3.87301559e+00 2.76627584e+00 1.04076756e+01
 1.32762288e+01 7.39312079e+01 5.98477252e-01 1.53565604e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967191356117848
cond(S) = 76.28222507636988
E1 = -183.22950143154202  E_coul = 55.007281217590176
init E= -128.222220213952
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743055563220818  LUMO = 2.31313681629159
  mo_energy =
[-3.25528185e+01 -1.85672093e+00 -7.43055563e-01 -7.43055563e-01
 -7.43055563e-01  2.31313682e+00  2.64508614e+00  2.64508614e+00
  2.64508614e+00  1.98598662e+01  1.98598662e+01  1.98598662e+01
  2.81454383e+01  1.64275061e+02  7.93606456e+02  4.56921364e+03]
E1 = -182.17574619983594  E_coul = 53.89838568719025
cycle= 1 E= -128.277360512646  delta_E= -0.0551  |g|= 0.168  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.271168
diis-c [-0.07353199  1.        ]
  HOMO = -0.810691196269935  LUMO = 2.26822738319962
  mo_energy =
[-3.28332008e+01 -1.92563894e+00 -8.10691196e-01 -8.10691196e-01
 -8.10691196e-01  2.26822738e+00  2.58868223e+00  2.58868223e+00
  2.58868223e+00  1.96637701e+01  1.96637701e+01  1.96637701e+01
  2.79403576e+01  1.63984147e+02  7.93264113e+02  4.56882869e+03]
E1 = -182.6526830345468  E_coul = 54.37360721531666
cycle= 2 E= -128.27907581923  delta_E= -0.00172  |g|= 0.0646  |ddm|= 0.0649
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.106646
diis-c [-2.17507110e-04  2.80617838e-01  7.19382162e-01]
  HOMO = -0.787265153235341  LUMO = 2.28596511879215
  mo_energy =
[-3.27564936e+01 -1.90139988e+00 -7.87265153e-01 -7.87265153e-01
 -7.87265153e-01  2.28596512e+00  2.60981014e+00  2.60981014e+00
  2.60981014e+00  1.97213418e+01  1.97213418e+01  1.97213418e+01
  2.79997717e+01  1.64062860e+02  7.93351002e+02  4.56891941e+03]
E1 = -182.5162030305871  E_coul = 54.23680301791712
cycle= 3 E= -128.27940001267  delta_E= -0.000324  |g|= 0.000508  |ddm|= 0.0186
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000684654
diis-c [-3.65220546e-08 -4.52479533e-03 -5.46969125e-03  1.00999449e+00]
  HOMO = -0.787447894668581  LUMO = 2.28582960247787
  mo_energy =
[-3.27569488e+01 -1.90161299e+00 -7.87447895e-01 -7.87447895e-01
 -7.87447895e-01  2.28582960e+00  2.60968398e+00  2.60968398e+00
  2.60968398e+00  1.97209783e+01  1.97209783e+01  1.97209783e+01
  2.79993585e+01  1.64062492e+02  7.93350782e+02  4.56891929e+03]
E1 = -182.51711138454115  E_coul = 54.23771135689149
cycle= 4 E= -128.27940002765  delta_E= -1.5e-08  |g|= 2.4e-05  |ddm|= 0.000151
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.97213e-05
diis-c [-1.59540507e-10  2.90561768e-04 -1.59357965e-04 -9.41226107e-02
  1.09399141e+00]
  HOMO = -0.787440457915839  LUMO = 2.28583100662142
  mo_energy =
[-3.27569301e+01 -1.90161034e+00 -7.87440458e-01 -7.87440458e-01
 -7.87440458e-01  2.28583101e+00  2.60969018e+00  2.60969018e+00
  2.60969018e+00  1.97209931e+01  1.97209931e+01  1.97209931e+01
  2.79993714e+01  1.64062513e+02  7.93350812e+02  4.56891933e+03]
E1 = -182.51708056830083  E_coul = 54.237680540591455
cycle= 5 E= -128.279400027709  delta_E= -5.97e-11  |g|= 1.86e-06  |ddm|= 1.02e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51708056830083  E_coul = 54.237680540591455
  HOMO = -0.787440060127571  LUMO = 2.28583094686762
  mo_energy =
[-3.27569292e+01 -1.90161040e+00 -7.87440060e-01 -7.87440060e-01
 -7.87440060e-01  2.28583095e+00  2.60969054e+00  2.60969054e+00
  2.60969054e+00  1.97209938e+01  1.97209938e+01  1.97209938e+01
  2.79993720e+01  1.64062514e+02  7.93350813e+02  4.56891933e+03]
E1 = -182.51707916291622  E_coul = 54.23767913520654
Extra cycle  E= -128.27940002771  delta_E= -3.13e-13  |g|= 4.17e-07  |ddm|= 1.06e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43881064e+03 1.04511333e+02 4.22719497e+02 5.18024343e-01
 3.08277804e+01 9.98398115e+00 1.76757952e+00 2.76627584e+00
 1.32762288e+01 5.98477252e-01]
E = -128.27940002770967
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2438.81064223        1
[INPUT] 0    0    [1    /1   ]  104.511333415        1
[INPUT] 0    0    [1    /1   ]  422.719496557        1
[INPUT] 0    0    [1    /1   ]  0.518024343288       1
[INPUT] 0    0    [1    /1   ]  30.8277804206        1
[INPUT] 0    0    [1    /1   ]  9.98398114783        1
[INPUT] 0    0    [1    /1   ]  1.76757951839        1
[INPUT] 1    0    [1    /1   ]  2.76627583604        1
[INPUT] 1    0    [1    /1   ]  13.2762287743        1
[INPUT] 1    0    [1    /1   ]  0.598477252476       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2438.8106422257774, 1.0]], [0, [104.51133341513808, 1.0]], [0, [422.7194965574206, 1.0]], [0, [0.518024343288391, 1.0]], [0, [30.82778042058376, 1.0]], [0, [9.983981147825599, 1.0]], [0, [1.7675795183903007, 1.0]], [1, [2.7662758360378112, 1.0]], [1, [13.276228774296802, 1.0]], [1, [0.5984772524761891, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2438.81064223]
bas 1, expnt(s) = [104.51133342]
bas 2, expnt(s) = [422.71949656]
bas 3, expnt(s) = [0.51802434]
bas 4, expnt(s) = [30.82778042]
bas 5, expnt(s) = [9.98398115]
bas 6, expnt(s) = [1.76757952]
bas 7, expnt(s) = [2.76627584]
bas 8, expnt(s) = [13.27622877]
bas 9, expnt(s) = [0.59847725]
CPU time:       302.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43881064e+03 8.76796051e+02 1.04511333e+02 8.25824125e+01
 4.22719497e+02 2.35534339e+02 5.18024343e-01 1.54268640e+00
 3.08277804e+01 3.30538245e+01 9.98398115e+00 1.41903412e+01
 1.76757952e+00 3.87301559e+00 2.76627584e+00 1.04076756e+01
 1.32762288e+01 7.39312079e+01 5.98477252e-01 1.53565604e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967191356117848
cond(S) = 76.28222507636988
E1 = -183.22950143154202  E_coul = 55.007281217590176
init E= -128.222220213952
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743055563220818  LUMO = 2.31313681629159
  mo_energy =
[-3.25528185e+01 -1.85672093e+00 -7.43055563e-01 -7.43055563e-01
 -7.43055563e-01  2.31313682e+00  2.64508614e+00  2.64508614e+00
  2.64508614e+00  1.98598662e+01  1.98598662e+01  1.98598662e+01
  2.81454383e+01  1.64275061e+02  7.93606456e+02  4.56921364e+03]
E1 = -182.17574619983594  E_coul = 53.89838568719025
cycle= 1 E= -128.277360512646  delta_E= -0.0551  |g|= 0.168  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.271168
diis-c [-0.07353199  1.        ]
  HOMO = -0.810691196269935  LUMO = 2.26822738319962
  mo_energy =
[-3.28332008e+01 -1.92563894e+00 -8.10691196e-01 -8.10691196e-01
 -8.10691196e-01  2.26822738e+00  2.58868223e+00  2.58868223e+00
  2.58868223e+00  1.96637701e+01  1.96637701e+01  1.96637701e+01
  2.79403576e+01  1.63984147e+02  7.93264113e+02  4.56882869e+03]
E1 = -182.6526830345468  E_coul = 54.37360721531666
cycle= 2 E= -128.27907581923  delta_E= -0.00172  |g|= 0.0646  |ddm|= 0.0649
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.106646
diis-c [-2.17507110e-04  2.80617838e-01  7.19382162e-01]
  HOMO = -0.787265153235341  LUMO = 2.28596511879215
  mo_energy =
[-3.27564936e+01 -1.90139988e+00 -7.87265153e-01 -7.87265153e-01
 -7.87265153e-01  2.28596512e+00  2.60981014e+00  2.60981014e+00
  2.60981014e+00  1.97213418e+01  1.97213418e+01  1.97213418e+01
  2.79997717e+01  1.64062860e+02  7.93351002e+02  4.56891941e+03]
E1 = -182.5162030305871  E_coul = 54.23680301791712
cycle= 3 E= -128.27940001267  delta_E= -0.000324  |g|= 0.000508  |ddm|= 0.0186
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000684654
diis-c [-3.65220546e-08 -4.52479533e-03 -5.46969125e-03  1.00999449e+00]
  HOMO = -0.787447894668581  LUMO = 2.28582960247787
  mo_energy =
[-3.27569488e+01 -1.90161299e+00 -7.87447895e-01 -7.87447895e-01
 -7.87447895e-01  2.28582960e+00  2.60968398e+00  2.60968398e+00
  2.60968398e+00  1.97209783e+01  1.97209783e+01  1.97209783e+01
  2.79993585e+01  1.64062492e+02  7.93350782e+02  4.56891929e+03]
E1 = -182.51711138454115  E_coul = 54.23771135689149
cycle= 4 E= -128.27940002765  delta_E= -1.5e-08  |g|= 2.4e-05  |ddm|= 0.000151
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.97213e-05
diis-c [-1.59540507e-10  2.90561768e-04 -1.59357965e-04 -9.41226107e-02
  1.09399141e+00]
  HOMO = -0.787440457915839  LUMO = 2.28583100662142
  mo_energy =
[-3.27569301e+01 -1.90161034e+00 -7.87440458e-01 -7.87440458e-01
 -7.87440458e-01  2.28583101e+00  2.60969018e+00  2.60969018e+00
  2.60969018e+00  1.97209931e+01  1.97209931e+01  1.97209931e+01
  2.79993714e+01  1.64062513e+02  7.93350812e+02  4.56891933e+03]
E1 = -182.51708056830083  E_coul = 54.237680540591455
cycle= 5 E= -128.279400027709  delta_E= -5.97e-11  |g|= 1.86e-06  |ddm|= 1.02e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51708056830083  E_coul = 54.237680540591455
  HOMO = -0.787440060127571  LUMO = 2.28583094686762
  mo_energy =
[-3.27569292e+01 -1.90161040e+00 -7.87440060e-01 -7.87440060e-01
 -7.87440060e-01  2.28583095e+00  2.60969054e+00  2.60969054e+00
  2.60969054e+00  1.97209938e+01  1.97209938e+01  1.97209938e+01
  2.79993720e+01  1.64062514e+02  7.93350813e+02  4.56891933e+03]
E1 = -182.51707916291622  E_coul = 54.23767913520654
Extra cycle  E= -128.27940002771  delta_E= -3.13e-13  |g|= 4.17e-07  |ddm|= 1.06e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 76.28222507636988
E1 = -182.51707916291622  E_coul = 54.23767913520654
init E= -128.27940002771
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787440134256732  LUMO = 2.28583081942517
  mo_energy =
[-3.27569295e+01 -1.90161057e+00 -7.87440134e-01 -7.87440134e-01
 -7.87440134e-01  2.28583082e+00  2.60969047e+00  2.60969047e+00
  2.60969047e+00  1.97209935e+01  1.97209935e+01  1.97209935e+01
  2.79993717e+01  1.64062514e+02  7.93350813e+02  4.56891933e+03]
E1 = -182.51707977124747  E_coul = 54.23767974353756
cycle= 1 E= -128.27940002771  delta_E= -2.27e-13  |g|= 1e-07  |ddm|= 2.47e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.51707977124747  E_coul = 54.23767974353756
  HOMO = -0.787440088403809  LUMO = 2.28583084087384
  mo_energy =
[-3.27569293e+01 -1.90161054e+00 -7.87440088e-01 -7.87440088e-01
 -7.87440088e-01  2.28583084e+00  2.60969051e+00  2.60969051e+00
  2.60969051e+00  1.97209936e+01  1.97209936e+01  1.97209936e+01
  2.79993718e+01  1.64062514e+02  7.93350813e+02  4.56891933e+03]
E1 = -182.51707953760064  E_coul = 54.23767950989069
Extra cycle  E= -128.27940002771  delta_E= -5.68e-14  |g|= 3.53e-08  |ddm|= 4.05e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.43881064e+03 1.04511333e+02 4.22719497e+02 5.18024343e-01
 3.08277804e+01 9.98398115e+00 1.76757952e+00 2.76627584e+00
 1.32762288e+01 5.98477252e-01]
grad_E = [-1.19531614e-05 -8.86439566e-05  1.93300464e-05  1.81839275e-03
  3.78077602e-04 -1.89918681e-03  6.91590629e-04 -1.04240368e-03
 -4.14911442e-05 -3.85466632e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2438.68480412        1
[INPUT] 0    0    [1    /1   ]  105.761789729        1
[INPUT] 0    0    [1    /1   ]  423.046799954        1
[INPUT] 0    0    [1    /1   ]  0.519273455646       1
[INPUT] 0    0    [1    /1   ]  31.3037457237        1
[INPUT] 0    0    [1    /1   ]  10.1277791132        1
[INPUT] 0    0    [1    /1   ]  1.77349151114        1
[INPUT] 1    0    [1    /1   ]  2.77109939613        1
[INPUT] 1    0    [1    /1   ]  13.3123265553        1
[INPUT] 1    0    [1    /1   ]  0.599095560615       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2438.684804119521, 1.0]], [0, [105.76178972928635, 1.0]], [0, [423.04679995367206, 1.0]], [0, [0.5192734556464065, 1.0]], [0, [31.3037457236996, 1.0]], [0, [10.127779113236558, 1.0]], [0, [1.7734915111376368, 1.0]], [1, [2.7710993961306865, 1.0]], [1, [13.312326555294478, 1.0]], [1, [0.5990955606150703, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2438.68480412]
bas 1, expnt(s) = [105.76178973]
bas 2, expnt(s) = [423.04679995]
bas 3, expnt(s) = [0.51927346]
bas 4, expnt(s) = [31.30374572]
bas 5, expnt(s) = [10.12777911]
bas 6, expnt(s) = [1.77349151]
bas 7, expnt(s) = [2.7710994]
bas 8, expnt(s) = [13.31232656]
bas 9, expnt(s) = [0.59909556]
CPU time:       305.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43868480e+03 8.76762120e+02 1.05761790e+02 8.33223707e+01
 4.23046800e+02 2.35671103e+02 5.19273456e-01 1.54547547e+00
 3.13037457e+01 3.34358413e+01 1.01277791e+01 1.43433531e+01
 1.77349151e+00 3.88272704e+00 2.77109940e+00 1.04303654e+01
 1.33123266e+01 7.41825650e+01 5.99095561e-01 1.53763947e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967039419955608
cond(S) = 76.67367915774706
E1 = -183.22946998046083  E_coul = 55.00774156759601
init E= -128.221728412865
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74304777790748  LUMO = 2.32633605884153
  mo_energy =
[-3.25526448e+01 -1.85674218e+00 -7.43047778e-01 -7.43047778e-01
 -7.43047778e-01  2.32633606e+00  2.64928438e+00  2.64928438e+00
  2.64928438e+00  1.99145971e+01  1.99145971e+01  1.99145971e+01
  2.86484893e+01  1.66987913e+02  7.99810002e+02  4.57643554e+03]
E1 = -182.179086066278  E_coul = 53.90158220013115
cycle= 1 E= -128.277503866147  delta_E= -0.0558  |g|= 0.168  |ddm|= 0.18
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.270475
diis-c [-0.07315653  1.        ]
  HOMO = -0.810513914307612  LUMO = 2.28121262328579
  mo_energy =
[-3.28323709e+01 -1.92546716e+00 -8.10513914e-01 -8.10513914e-01
 -8.10513914e-01  2.28121262e+00  2.59296043e+00  2.59296043e+00
  2.59296043e+00  1.97187713e+01  1.97187713e+01  1.97187713e+01
  2.84424353e+01  1.66697197e+02  7.99468616e+02  4.57605198e+03]
E1 = -182.65466000099522  E_coul = 54.3754486036306
cycle= 2 E= -128.279211397365  delta_E= -0.00171  |g|= 0.0644  |ddm|= 0.0647
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.1063
diis-c [-2.19143717e-04  2.80455273e-01  7.19544727e-01]
  HOMO = -0.787153199164724  LUMO = 2.29900712709762
  mo_energy =
[-3.27558525e+01 -1.90129375e+00 -7.87153199e-01 -7.87153199e-01
 -7.87153199e-01  2.29900713e+00  2.61406071e+00  2.61406071e+00
  2.61406071e+00  1.97762525e+01  1.97762525e+01  1.97762525e+01
  2.85020363e+01  1.66775841e+02  7.99555312e+02  4.57614249e+03]
E1 = -182.5186032676375  E_coul = 54.239069546227384
cycle= 3 E= -128.27953372141  delta_E= -0.000322  |g|= 0.000512  |ddm|= 0.0186
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691444
diis-c [-3.59430332e-08 -4.50795983e-03 -5.33873600e-03  1.00984670e+00]
  HOMO = -0.787338009976394  LUMO = 2.29887025109774
  mo_energy =
[-3.27563124e+01 -1.90150748e+00 -7.87338010e-01 -7.87338010e-01
 -7.87338010e-01  2.29887025e+00  2.61393239e+00  2.61393239e+00
  2.61393239e+00  1.97758850e+01  1.97758850e+01  1.97758850e+01
  2.85016176e+01  1.66775469e+02  7.99555088e+02  4.57614237e+03]
E1 = -182.51952032566322  E_coul = 54.2399865891162
cycle= 4 E= -128.279533736547  delta_E= -1.51e-08  |g|= 2.32e-05  |ddm|= 0.00015
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.85874e-05
diis-c [-1.48103883e-10  2.67753794e-04 -1.82992366e-04 -8.82051777e-02
  1.08812042e+00]
  HOMO = -0.787330739828703  LUMO = 2.29887180594256
  mo_energy =
[-3.27562940e+01 -1.90150468e+00 -7.87330740e-01 -7.87330740e-01
 -7.87330740e-01  2.29887181e+00  2.61393846e+00  2.61393846e+00
  2.61393846e+00  1.97758996e+01  1.97758996e+01  1.97758996e+01
  2.85016304e+01  1.66775491e+02  7.99555117e+02  4.57614240e+03]
E1 = -182.51948985216805  E_coul = 54.239956115566635
cycle= 5 E= -128.279533736601  delta_E= -5.44e-11  |g|= 1.83e-06  |ddm|= 9.49e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51948985216805  E_coul = 54.239956115566635
  HOMO = -0.787330338638906  LUMO = 2.298871755009
  mo_energy =
[-3.27562931e+01 -1.90150472e+00 -7.87330339e-01 -7.87330339e-01
 -7.87330339e-01  2.29887176e+00  2.61393883e+00  2.61393883e+00
  2.61393883e+00  1.97759003e+01  1.97759003e+01  1.97759003e+01
  2.85016310e+01  1.66775492e+02  7.99555119e+02  4.57614241e+03]
E1 = -182.51948841077586  E_coul = 54.239954674174236
Extra cycle  E= -128.279533736602  delta_E= -1.99e-13  |g|= 4.13e-07  |ddm|= 1.03e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43868480e+03 1.05761790e+02 4.23046800e+02 5.19273456e-01
 3.13037457e+01 1.01277791e+01 1.77349151e+00 2.77109940e+00
 1.33123266e+01 5.99095561e-01]
E = -128.27953373660162
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2438.68480412        1
[INPUT] 0    0    [1    /1   ]  105.761789729        1
[INPUT] 0    0    [1    /1   ]  423.046799954        1
[INPUT] 0    0    [1    /1   ]  0.519273455646       1
[INPUT] 0    0    [1    /1   ]  31.3037457237        1
[INPUT] 0    0    [1    /1   ]  10.1277791132        1
[INPUT] 0    0    [1    /1   ]  1.77349151114        1
[INPUT] 1    0    [1    /1   ]  2.77109939613        1
[INPUT] 1    0    [1    /1   ]  13.3123265553        1
[INPUT] 1    0    [1    /1   ]  0.599095560615       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2438.684804119521, 1.0]], [0, [105.76178972928635, 1.0]], [0, [423.04679995367206, 1.0]], [0, [0.5192734556464065, 1.0]], [0, [31.3037457236996, 1.0]], [0, [10.127779113236558, 1.0]], [0, [1.7734915111376368, 1.0]], [1, [2.7710993961306865, 1.0]], [1, [13.312326555294478, 1.0]], [1, [0.5990955606150703, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2438.68480412]
bas 1, expnt(s) = [105.76178973]
bas 2, expnt(s) = [423.04679995]
bas 3, expnt(s) = [0.51927346]
bas 4, expnt(s) = [31.30374572]
bas 5, expnt(s) = [10.12777911]
bas 6, expnt(s) = [1.77349151]
bas 7, expnt(s) = [2.7710994]
bas 8, expnt(s) = [13.31232656]
bas 9, expnt(s) = [0.59909556]
CPU time:       306.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43868480e+03 8.76762120e+02 1.05761790e+02 8.33223707e+01
 4.23046800e+02 2.35671103e+02 5.19273456e-01 1.54547547e+00
 3.13037457e+01 3.34358413e+01 1.01277791e+01 1.43433531e+01
 1.77349151e+00 3.88272704e+00 2.77109940e+00 1.04303654e+01
 1.33123266e+01 7.41825650e+01 5.99095561e-01 1.53763947e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967039419955608
cond(S) = 76.67367915774706
E1 = -183.22946998046083  E_coul = 55.00774156759601
init E= -128.221728412865
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74304777790748  LUMO = 2.32633605884153
  mo_energy =
[-3.25526448e+01 -1.85674218e+00 -7.43047778e-01 -7.43047778e-01
 -7.43047778e-01  2.32633606e+00  2.64928438e+00  2.64928438e+00
  2.64928438e+00  1.99145971e+01  1.99145971e+01  1.99145971e+01
  2.86484893e+01  1.66987913e+02  7.99810002e+02  4.57643554e+03]
E1 = -182.179086066278  E_coul = 53.90158220013115
cycle= 1 E= -128.277503866147  delta_E= -0.0558  |g|= 0.168  |ddm|= 0.18
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.270475
diis-c [-0.07315653  1.        ]
  HOMO = -0.810513914307612  LUMO = 2.28121262328579
  mo_energy =
[-3.28323709e+01 -1.92546716e+00 -8.10513914e-01 -8.10513914e-01
 -8.10513914e-01  2.28121262e+00  2.59296043e+00  2.59296043e+00
  2.59296043e+00  1.97187713e+01  1.97187713e+01  1.97187713e+01
  2.84424353e+01  1.66697197e+02  7.99468616e+02  4.57605198e+03]
E1 = -182.65466000099522  E_coul = 54.3754486036306
cycle= 2 E= -128.279211397365  delta_E= -0.00171  |g|= 0.0644  |ddm|= 0.0647
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.1063
diis-c [-2.19143717e-04  2.80455273e-01  7.19544727e-01]
  HOMO = -0.787153199164724  LUMO = 2.29900712709762
  mo_energy =
[-3.27558525e+01 -1.90129375e+00 -7.87153199e-01 -7.87153199e-01
 -7.87153199e-01  2.29900713e+00  2.61406071e+00  2.61406071e+00
  2.61406071e+00  1.97762525e+01  1.97762525e+01  1.97762525e+01
  2.85020363e+01  1.66775841e+02  7.99555312e+02  4.57614249e+03]
E1 = -182.5186032676375  E_coul = 54.239069546227384
cycle= 3 E= -128.27953372141  delta_E= -0.000322  |g|= 0.000512  |ddm|= 0.0186
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691444
diis-c [-3.59430332e-08 -4.50795983e-03 -5.33873600e-03  1.00984670e+00]
  HOMO = -0.787338009976394  LUMO = 2.29887025109774
  mo_energy =
[-3.27563124e+01 -1.90150748e+00 -7.87338010e-01 -7.87338010e-01
 -7.87338010e-01  2.29887025e+00  2.61393239e+00  2.61393239e+00
  2.61393239e+00  1.97758850e+01  1.97758850e+01  1.97758850e+01
  2.85016176e+01  1.66775469e+02  7.99555088e+02  4.57614237e+03]
E1 = -182.51952032566322  E_coul = 54.2399865891162
cycle= 4 E= -128.279533736547  delta_E= -1.51e-08  |g|= 2.32e-05  |ddm|= 0.00015
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.85874e-05
diis-c [-1.48103883e-10  2.67753794e-04 -1.82992366e-04 -8.82051777e-02
  1.08812042e+00]
  HOMO = -0.787330739828703  LUMO = 2.29887180594256
  mo_energy =
[-3.27562940e+01 -1.90150468e+00 -7.87330740e-01 -7.87330740e-01
 -7.87330740e-01  2.29887181e+00  2.61393846e+00  2.61393846e+00
  2.61393846e+00  1.97758996e+01  1.97758996e+01  1.97758996e+01
  2.85016304e+01  1.66775491e+02  7.99555117e+02  4.57614240e+03]
E1 = -182.51948985216805  E_coul = 54.239956115566635
cycle= 5 E= -128.279533736601  delta_E= -5.44e-11  |g|= 1.83e-06  |ddm|= 9.49e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.51948985216805  E_coul = 54.239956115566635
  HOMO = -0.787330338638906  LUMO = 2.298871755009
  mo_energy =
[-3.27562931e+01 -1.90150472e+00 -7.87330339e-01 -7.87330339e-01
 -7.87330339e-01  2.29887176e+00  2.61393883e+00  2.61393883e+00
  2.61393883e+00  1.97759003e+01  1.97759003e+01  1.97759003e+01
  2.85016310e+01  1.66775492e+02  7.99555119e+02  4.57614241e+03]
E1 = -182.51948841077586  E_coul = 54.239954674174236
Extra cycle  E= -128.279533736602  delta_E= -1.99e-13  |g|= 4.13e-07  |ddm|= 1.03e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 76.67367915774706
E1 = -182.51948841077586  E_coul = 54.239954674174236
init E= -128.279533736602
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787330415719632  LUMO = 2.29887162621575
  mo_energy =
[-3.27562934e+01 -1.90150489e+00 -7.87330416e-01 -7.87330416e-01
 -7.87330416e-01  2.29887163e+00  2.61393876e+00  2.61393876e+00
  2.61393876e+00  1.97759001e+01  1.97759001e+01  1.97759001e+01
  2.85016308e+01  1.66775492e+02  7.99555118e+02  4.57614240e+03]
E1 = -182.51948903159195  E_coul = 54.239955294990345
cycle= 1 E= -128.279533736602  delta_E= 2.84e-14  |g|= 1.01e-07  |ddm|= 2.44e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.51948903159195  E_coul = 54.239955294990345
  HOMO = -0.78733036911765  LUMO = 2.29887164868517
  mo_energy =
[-3.27562933e+01 -1.90150486e+00 -7.87330369e-01 -7.87330369e-01
 -7.87330369e-01  2.29887165e+00  2.61393880e+00  2.61393880e+00
  2.61393880e+00  1.97759002e+01  1.97759002e+01  1.97759002e+01
  2.85016309e+01  1.66775492e+02  7.99555119e+02  4.57614241e+03]
E1 = -182.51948879275702  E_coul = 54.23995505615526
Extra cycle  E= -128.279533736602  delta_E= -1.71e-13  |g|= 3.58e-08  |ddm|= 4.02e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43868480e+03 1.05761790e+02 4.23046800e+02 5.19273456e-01
 3.13037457e+01 1.01277791e+01 1.77349151e+00 2.77109940e+00
 1.33123266e+01 5.99095561e-01]
grad_E = [-1.13239337e-05 -9.31985883e-06  1.67574216e-06 -5.53358016e-04
  2.12835351e-04 -1.17908000e-03  1.50684429e-03 -9.73026144e-04
  1.12626588e-04 -1.25818897e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2438.68061668        1
[INPUT] 0    0    [1    /1   ]  106.234514764        1
[INPUT] 0    0    [1    /1   ]  423.01974521         1
[INPUT] 0    0    [1    /1   ]  0.515672065809       1
[INPUT] 0    0    [1    /1   ]  31.5938295222        1
[INPUT] 0    0    [1    /1   ]  10.2447024019        1
[INPUT] 0    0    [1    /1   ]  1.75419497686        1
[INPUT] 1    0    [1    /1   ]  2.77689946676        1
[INPUT] 1    0    [1    /1   ]  13.3416136962        1
[INPUT] 1    0    [1    /1   ]  0.60006547828        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2438.6806166774586, 1.0]], [0, [106.23451476359794, 1.0]], [0, [423.0197452100247, 1.0]], [0, [0.5156720658088007, 1.0]], [0, [31.593829522213227, 1.0]], [0, [10.244702401890253, 1.0]], [0, [1.7541949768599918, 1.0]], [1, [2.7768994667607396, 1.0]], [1, [13.341613696209704, 1.0]], [1, [0.6000654782804891, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2438.68061668]
bas 1, expnt(s) = [106.23451476]
bas 2, expnt(s) = [423.01974521]
bas 3, expnt(s) = [0.51567207]
bas 4, expnt(s) = [31.59382952]
bas 5, expnt(s) = [10.2447024]
bas 6, expnt(s) = [1.75419498]
bas 7, expnt(s) = [2.77689947]
bas 8, expnt(s) = [13.3416137]
bas 9, expnt(s) = [0.60006548]
CPU time:       309.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43868062e+03 8.76760991e+02 1.06234515e+02 8.36015353e+01
 4.23019745e+02 2.35659799e+02 5.15672066e-01 1.53742957e+00
 3.15938295e+01 3.36679541e+01 1.02447024e+01 1.44673682e+01
 1.75419498e+00 3.85099914e+00 2.77689947e+00 1.04576617e+01
 1.33416137e+01 7.43866232e+01 6.00065478e-01 1.54075184e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966872167612284
cond(S) = 76.918364335559
E1 = -183.22903686266469  E_coul = 55.00778793363552
init E= -128.221248929029
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74304223498944  LUMO = 2.29589941411838
  mo_energy =
[-3.25525522e+01 -1.85683643e+00 -7.43042235e-01 -7.43042235e-01
 -7.43042235e-01  2.29589941e+00  2.65529424e+00  2.65529424e+00
  2.65529424e+00  1.99662272e+01  1.99662272e+01  1.99662272e+01
  2.88980721e+01  1.68427481e+02  8.02542042e+02  4.57923775e+03]
E1 = -182.18462815413432  E_coul = 53.90704673180319
cycle= 1 E= -128.277581422331  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269224
diis-c [-0.0724818  1.       ]
  HOMO = -0.810132811400957  LUMO = 2.25171552408122
  mo_energy =
[-3.28311883e+01 -1.92508609e+00 -8.10132811e-01 -8.10132811e-01
 -8.10132811e-01  2.25171552e+00  2.59920005e+00  2.59920005e+00
  2.59920005e+00  1.97710890e+01  1.97710890e+01  1.97710890e+01
  2.86920081e+01  1.68137733e+02  8.02202102e+02  4.57885584e+03]
E1 = -182.65778656520882  E_coul = 54.37851288847557
cycle= 2 E= -128.279273676733  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10569
diis-c [-2.20241463e-04  2.80199787e-01  7.19800213e-01]
  HOMO = -0.786880337892525  LUMO = 2.26925934978809
  mo_energy =
[-3.27550312e+01 -1.90103269e+00 -7.86880338e-01 -7.86880338e-01
 -7.86880338e-01  2.26925935e+00  2.62024237e+00  2.62024237e+00
  2.62024237e+00  1.98283409e+01  1.98283409e+01  1.98283409e+01
  2.87515599e+01  1.68216071e+02  8.02288392e+02  4.57894592e+03]
E1 = -182.52249532702922  E_coul = 54.242902909118186
cycle= 3 E= -128.279592417911  delta_E= -0.000319  |g|= 0.000513  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000696736
diis-c [-3.41755569e-08 -4.47916534e-03 -5.17103905e-03  1.00965020e+00]
  HOMO = -0.787066594626126  LUMO = 2.26912433470803
  mo_energy =
[-3.27554961e+01 -1.90124577e+00 -7.87066595e-01 -7.87066595e-01
 -7.87066595e-01  2.26912433e+00  2.62011219e+00  2.62011219e+00
  2.62011219e+00  1.98279697e+01  1.98279697e+01  1.98279697e+01
  2.87511379e+01  1.68215696e+02  8.02288162e+02  4.57894579e+03]
E1 = -182.52341938838254  E_coul = 54.24382695527478
cycle= 4 E= -128.279592433108  delta_E= -1.52e-08  |g|= 2.19e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.68477e-05
diis-c [-1.35103368e-10  2.41728510e-04 -2.01131901e-04 -8.07729361e-02
  1.08073234e+00]
  HOMO = -0.787059557799163  LUMO = 2.26912604103433
  mo_energy =
[-3.27554783e+01 -1.90124278e+00 -7.87059558e-01 -7.87059558e-01
 -7.87059558e-01  2.26912604e+00  2.62011808e+00  2.62011808e+00
  2.62011808e+00  1.98279839e+01  1.98279839e+01  1.98279839e+01
  2.87511505e+01  1.68215717e+02  8.02288191e+02  4.57894583e+03]
E1 = -182.5233897012806  E_coul = 54.243797268125554
cycle= 5 E= -128.279592433155  delta_E= -4.73e-11  |g|= 1.78e-06  |ddm|= 8.62e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5233897012806  E_coul = 54.243797268125554
  HOMO = -0.787059150796962  LUMO = 2.26912600459721
  mo_energy =
[-3.27554773e+01 -1.90124281e+00 -7.87059151e-01 -7.87059151e-01
 -7.87059151e-01  2.26912600e+00  2.62011845e+00  2.62011845e+00
  2.62011845e+00  1.98279847e+01  1.98279847e+01  1.98279847e+01
  2.87511511e+01  1.68215718e+02  8.02288192e+02  4.57894583e+03]
E1 = -182.52338822658743  E_coul = 54.24379579343182
Extra cycle  E= -128.279592433156  delta_E= -5.68e-13  |g|= 4.06e-07  |ddm|= 9.95e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43868062e+03 1.06234515e+02 4.23019745e+02 5.15672066e-01
 3.15938295e+01 1.02447024e+01 1.75419498e+00 2.77689947e+00
 1.33416137e+01 6.00065478e-01]
E = -128.2795924331556
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2438.68061668        1
[INPUT] 0    0    [1    /1   ]  106.234514764        1
[INPUT] 0    0    [1    /1   ]  423.01974521         1
[INPUT] 0    0    [1    /1   ]  0.515672065809       1
[INPUT] 0    0    [1    /1   ]  31.5938295222        1
[INPUT] 0    0    [1    /1   ]  10.2447024019        1
[INPUT] 0    0    [1    /1   ]  1.75419497686        1
[INPUT] 1    0    [1    /1   ]  2.77689946676        1
[INPUT] 1    0    [1    /1   ]  13.3416136962        1
[INPUT] 1    0    [1    /1   ]  0.60006547828        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2438.6806166774586, 1.0]], [0, [106.23451476359794, 1.0]], [0, [423.0197452100247, 1.0]], [0, [0.5156720658088007, 1.0]], [0, [31.593829522213227, 1.0]], [0, [10.244702401890253, 1.0]], [0, [1.7541949768599918, 1.0]], [1, [2.7768994667607396, 1.0]], [1, [13.341613696209704, 1.0]], [1, [0.6000654782804891, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2438.68061668]
bas 1, expnt(s) = [106.23451476]
bas 2, expnt(s) = [423.01974521]
bas 3, expnt(s) = [0.51567207]
bas 4, expnt(s) = [31.59382952]
bas 5, expnt(s) = [10.2447024]
bas 6, expnt(s) = [1.75419498]
bas 7, expnt(s) = [2.77689947]
bas 8, expnt(s) = [13.3416137]
bas 9, expnt(s) = [0.60006548]
CPU time:       310.54
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43868062e+03 8.76760991e+02 1.06234515e+02 8.36015353e+01
 4.23019745e+02 2.35659799e+02 5.15672066e-01 1.53742957e+00
 3.15938295e+01 3.36679541e+01 1.02447024e+01 1.44673682e+01
 1.75419498e+00 3.85099914e+00 2.77689947e+00 1.04576617e+01
 1.33416137e+01 7.43866232e+01 6.00065478e-01 1.54075184e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966872167612284
cond(S) = 76.918364335559
E1 = -183.22903686266469  E_coul = 55.00778793363552
init E= -128.221248929029
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74304223498944  LUMO = 2.29589941411838
  mo_energy =
[-3.25525522e+01 -1.85683643e+00 -7.43042235e-01 -7.43042235e-01
 -7.43042235e-01  2.29589941e+00  2.65529424e+00  2.65529424e+00
  2.65529424e+00  1.99662272e+01  1.99662272e+01  1.99662272e+01
  2.88980721e+01  1.68427481e+02  8.02542042e+02  4.57923775e+03]
E1 = -182.18462815413432  E_coul = 53.90704673180319
cycle= 1 E= -128.277581422331  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269224
diis-c [-0.0724818  1.       ]
  HOMO = -0.810132811400957  LUMO = 2.25171552408122
  mo_energy =
[-3.28311883e+01 -1.92508609e+00 -8.10132811e-01 -8.10132811e-01
 -8.10132811e-01  2.25171552e+00  2.59920005e+00  2.59920005e+00
  2.59920005e+00  1.97710890e+01  1.97710890e+01  1.97710890e+01
  2.86920081e+01  1.68137733e+02  8.02202102e+02  4.57885584e+03]
E1 = -182.65778656520882  E_coul = 54.37851288847557
cycle= 2 E= -128.279273676733  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10569
diis-c [-2.20241463e-04  2.80199787e-01  7.19800213e-01]
  HOMO = -0.786880337892525  LUMO = 2.26925934978809
  mo_energy =
[-3.27550312e+01 -1.90103269e+00 -7.86880338e-01 -7.86880338e-01
 -7.86880338e-01  2.26925935e+00  2.62024237e+00  2.62024237e+00
  2.62024237e+00  1.98283409e+01  1.98283409e+01  1.98283409e+01
  2.87515599e+01  1.68216071e+02  8.02288392e+02  4.57894592e+03]
E1 = -182.52249532702922  E_coul = 54.242902909118186
cycle= 3 E= -128.279592417911  delta_E= -0.000319  |g|= 0.000513  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000696736
diis-c [-3.41755569e-08 -4.47916534e-03 -5.17103905e-03  1.00965020e+00]
  HOMO = -0.787066594626126  LUMO = 2.26912433470803
  mo_energy =
[-3.27554961e+01 -1.90124577e+00 -7.87066595e-01 -7.87066595e-01
 -7.87066595e-01  2.26912433e+00  2.62011219e+00  2.62011219e+00
  2.62011219e+00  1.98279697e+01  1.98279697e+01  1.98279697e+01
  2.87511379e+01  1.68215696e+02  8.02288162e+02  4.57894579e+03]
E1 = -182.52341938838254  E_coul = 54.24382695527478
cycle= 4 E= -128.279592433108  delta_E= -1.52e-08  |g|= 2.19e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.68477e-05
diis-c [-1.35103368e-10  2.41728510e-04 -2.01131901e-04 -8.07729361e-02
  1.08073234e+00]
  HOMO = -0.787059557799163  LUMO = 2.26912604103433
  mo_energy =
[-3.27554783e+01 -1.90124278e+00 -7.87059558e-01 -7.87059558e-01
 -7.87059558e-01  2.26912604e+00  2.62011808e+00  2.62011808e+00
  2.62011808e+00  1.98279839e+01  1.98279839e+01  1.98279839e+01
  2.87511505e+01  1.68215717e+02  8.02288191e+02  4.57894583e+03]
E1 = -182.5233897012806  E_coul = 54.243797268125554
cycle= 5 E= -128.279592433155  delta_E= -4.73e-11  |g|= 1.78e-06  |ddm|= 8.62e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5233897012806  E_coul = 54.243797268125554
  HOMO = -0.787059150796962  LUMO = 2.26912600459721
  mo_energy =
[-3.27554773e+01 -1.90124281e+00 -7.87059151e-01 -7.87059151e-01
 -7.87059151e-01  2.26912600e+00  2.62011845e+00  2.62011845e+00
  2.62011845e+00  1.98279847e+01  1.98279847e+01  1.98279847e+01
  2.87511511e+01  1.68215718e+02  8.02288192e+02  4.57894583e+03]
E1 = -182.52338822658743  E_coul = 54.24379579343182
Extra cycle  E= -128.279592433156  delta_E= -5.68e-13  |g|= 4.06e-07  |ddm|= 9.95e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 76.918364335559
E1 = -182.52338822658743  E_coul = 54.24379579343182
init E= -128.279592433156
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.78705923063676  LUMO = 2.26912587700591
  mo_energy =
[-3.27554777e+01 -1.90124297e+00 -7.87059231e-01 -7.87059231e-01
 -7.87059231e-01  2.26912588e+00  2.62011838e+00  2.62011838e+00
  2.62011838e+00  1.98279844e+01  1.98279844e+01  1.98279844e+01
  2.87511509e+01  1.68215718e+02  8.02288192e+02  4.57894583e+03]
E1 = -182.52338886185595  E_coul = 54.24379642869997
cycle= 1 E= -128.279592433156  delta_E= -3.69e-13  |g|= 1.01e-07  |ddm|= 2.4e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52338886185595  E_coul = 54.24379642869997
  HOMO = -0.787059183122439  LUMO = 2.26912590030046
  mo_energy =
[-3.27554775e+01 -1.90124294e+00 -7.87059183e-01 -7.87059183e-01
 -7.87059183e-01  2.26912590e+00  2.62011842e+00  2.62011842e+00
  2.62011842e+00  1.98279845e+01  1.98279845e+01  1.98279845e+01
  2.87511510e+01  1.68215718e+02  8.02288192e+02  4.57894583e+03]
E1 = -182.52338861779762  E_coul = 54.243796184641766
Extra cycle  E= -128.279592433156  delta_E= 1.14e-13  |g|= 3.63e-08  |ddm|= 3.99e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.43868062e+03 1.06234515e+02 4.23019745e+02 5.15672066e-01
 3.15938295e+01 1.02447024e+01 1.75419498e+00 2.77689947e+00
 1.33416137e+01 6.00065478e-01]
grad_E = [-1.11117431e-05  2.83580732e-06 -3.17038485e-06  1.63427372e-04
  7.96231856e-05 -2.79126702e-04 -1.13973621e-04 -1.62284113e-04
  1.19151013e-04 -1.05249183e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2438.97329821        1
[INPUT] 0    0    [1    /1   ]  105.912150335        1
[INPUT] 0    0    [1    /1   ]  422.037282279        1
[INPUT] 0    0    [1    /1   ]  0.515817313803       1
[INPUT] 0    0    [1    /1   ]  31.5375014159        1
[INPUT] 0    0    [1    /1   ]  10.2438407068        1
[INPUT] 0    0    [1    /1   ]  1.75532305581        1
[INPUT] 1    0    [1    /1   ]  2.77578898807        1
[INPUT] 1    0    [1    /1   ]  13.3315700181        1
[INPUT] 1    0    [1    /1   ]  0.599993859174       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2438.973298214568, 1.0]], [0, [105.9121503351672, 1.0]], [0, [422.03728227879196, 1.0]], [0, [0.5158173138034371, 1.0]], [0, [31.53750141587984, 1.0]], [0, [10.243840706778139, 1.0]], [0, [1.7553230558106636, 1.0]], [1, [2.7757889880663393, 1.0]], [1, [13.3315700181465, 1.0]], [1, [0.5999938591739961, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2438.97329821]
bas 1, expnt(s) = [105.91215034]
bas 2, expnt(s) = [422.03728228]
bas 3, expnt(s) = [0.51581731]
bas 4, expnt(s) = [31.53750142]
bas 5, expnt(s) = [10.24384071]
bas 6, expnt(s) = [1.75532306]
bas 7, expnt(s) = [2.77578899]
bas 8, expnt(s) = [13.33157002]
bas 9, expnt(s) = [0.59999386]
CPU time:       313.57
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43897330e+03 8.76839909e+02 1.05912150e+02 8.34111989e+01
 4.22037282e+02 2.35249190e+02 5.15817314e-01 1.53775434e+00
 3.15375014e+01 3.36229246e+01 1.02438407e+01 1.44664555e+01
 1.75532306e+00 3.85285635e+00 2.77578899e+00 1.04524345e+01
 1.33315700e+01 7.43166312e+01 5.99993859e-01 1.54052198e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966888533814133
cond(S) = 77.20584078100428
E1 = -183.22909962762404  E_coul = 55.00788347953429
init E= -128.22121614809
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743027286162627  LUMO = 2.29760158724725
  mo_energy =
[-3.25525581e+01 -1.85682870e+00 -7.43027286e-01 -7.43027286e-01
 -7.43027286e-01  2.29760159e+00  2.65460649e+00  2.65460649e+00
  2.65460649e+00  1.99520366e+01  1.99520366e+01  1.99520366e+01
  2.88775646e+01  1.68036753e+02  8.00406752e+02  4.57521764e+03]
E1 = -182.18464858244684  E_coul = 53.90706332938755
cycle= 1 E= -128.277585253059  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269236
diis-c [-0.07248829  1.        ]
  HOMO = -0.810132332718995  LUMO = 2.25336617449025
  mo_energy =
[-3.28311741e+01 -1.92509546e+00 -8.10132333e-01 -8.10132333e-01
 -8.10132333e-01  2.25336617e+00  2.59852143e+00  2.59852143e+00
  2.59852143e+00  1.97569772e+01  1.97569772e+01  1.97569772e+01
  2.86715818e+01  1.67747171e+02  8.00066954e+02  4.57483582e+03]
E1 = -182.65784234619926  E_coul = 54.378564790683484
cycle= 2 E= -128.279277555516  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105707
diis-c [-2.21160658e-04  2.80215851e-01  7.19784149e-01]
  HOMO = -0.786878615694553  LUMO = 2.27092181956406
  mo_energy =
[-3.27550137e+01 -1.90104023e+00 -7.86878616e-01 -7.86878616e-01
 -7.86878616e-01  2.27092182e+00  2.61955873e+00  2.61955873e+00
  2.61955873e+00  1.98142165e+01  1.98142165e+01  1.98142165e+01
  2.87311148e+01  1.67825490e+02  8.00153239e+02  4.57492590e+03]
E1 = -182.52253093174392  E_coul = 54.242934561211165
cycle= 3 E= -128.279596370533  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000697764
diis-c [-3.43898511e-08 -4.48858962e-03 -5.18735989e-03  1.00967595e+00]
  HOMO = -0.787065076882471  LUMO = 2.27078671739042
  mo_energy =
[-3.27554788e+01 -1.90125331e+00 -7.87065077e-01 -7.87065077e-01
 -7.87065077e-01  2.27078672e+00  2.61942845e+00  2.61942845e+00
  2.61942845e+00  1.98138453e+01  1.98138453e+01  1.98138453e+01
  2.87306924e+01  1.67825115e+02  8.00153009e+02  4.57492577e+03]
E1 = -182.52345566356516  E_coul = 54.243859277824164
cycle= 4 E= -128.279596385741  delta_E= -1.52e-08  |g|= 2.18e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.67012e-05
diis-c [-1.33206073e-10  2.38571748e-04 -2.02609905e-04 -7.98325696e-02
  1.07979661e+00]
  HOMO = -0.787058065505373  LUMO = 2.27078844179135
  mo_energy =
[-3.27554610e+01 -1.90125030e+00 -7.87058066e-01 -7.87058066e-01
 -7.87058066e-01  2.27078844e+00  2.61943431e+00  2.61943431e+00
  2.61943431e+00  1.98138595e+01  1.98138595e+01  1.98138595e+01
  2.87307050e+01  1.67825135e+02  8.00153038e+02  4.57492580e+03]
E1 = -182.52342603176007  E_coul = 54.24382964597199
cycle= 5 E= -128.279596385788  delta_E= -4.71e-11  |g|= 1.77e-06  |ddm|= 8.52e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52342603176007  E_coul = 54.24382964597199
  HOMO = -0.787057658034397  LUMO = 2.27078840705766
  mo_energy =
[-3.27554601e+01 -1.90125033e+00 -7.87057658e-01 -7.87057658e-01
 -7.87057658e-01  2.27078841e+00  2.61943468e+00  2.61943468e+00
  2.61943468e+00  1.98138602e+01  1.98138602e+01  1.98138602e+01
  2.87307057e+01  1.67825136e+02  8.00153039e+02  4.57492581e+03]
E1 = -182.52342455053653  E_coul = 54.243828164748095
Extra cycle  E= -128.279596385788  delta_E= -3.69e-13  |g|= 4.05e-07  |ddm|= 9.9e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43897330e+03 1.05912150e+02 4.22037282e+02 5.15817314e-01
 3.15375014e+01 1.02438407e+01 1.75532306e+00 2.77578899e+00
 1.33315700e+01 5.99993859e-01]
E = -128.27959638578844
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:49:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2438.97329821        1
[INPUT] 0    0    [1    /1   ]  105.912150335        1
[INPUT] 0    0    [1    /1   ]  422.037282279        1
[INPUT] 0    0    [1    /1   ]  0.515817313803       1
[INPUT] 0    0    [1    /1   ]  31.5375014159        1
[INPUT] 0    0    [1    /1   ]  10.2438407068        1
[INPUT] 0    0    [1    /1   ]  1.75532305581        1
[INPUT] 1    0    [1    /1   ]  2.77578898807        1
[INPUT] 1    0    [1    /1   ]  13.3315700181        1
[INPUT] 1    0    [1    /1   ]  0.599993859174       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2438.973298214568, 1.0]], [0, [105.9121503351672, 1.0]], [0, [422.03728227879196, 1.0]], [0, [0.5158173138034371, 1.0]], [0, [31.53750141587984, 1.0]], [0, [10.243840706778139, 1.0]], [0, [1.7553230558106636, 1.0]], [1, [2.7757889880663393, 1.0]], [1, [13.3315700181465, 1.0]], [1, [0.5999938591739961, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2438.97329821]
bas 1, expnt(s) = [105.91215034]
bas 2, expnt(s) = [422.03728228]
bas 3, expnt(s) = [0.51581731]
bas 4, expnt(s) = [31.53750142]
bas 5, expnt(s) = [10.24384071]
bas 6, expnt(s) = [1.75532306]
bas 7, expnt(s) = [2.77578899]
bas 8, expnt(s) = [13.33157002]
bas 9, expnt(s) = [0.59999386]
CPU time:       314.81
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43897330e+03 8.76839909e+02 1.05912150e+02 8.34111989e+01
 4.22037282e+02 2.35249190e+02 5.15817314e-01 1.53775434e+00
 3.15375014e+01 3.36229246e+01 1.02438407e+01 1.44664555e+01
 1.75532306e+00 3.85285635e+00 2.77578899e+00 1.04524345e+01
 1.33315700e+01 7.43166312e+01 5.99993859e-01 1.54052198e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966888533814133
cond(S) = 77.20584078100428
E1 = -183.22909962762404  E_coul = 55.00788347953429
init E= -128.22121614809
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743027286162627  LUMO = 2.29760158724725
  mo_energy =
[-3.25525581e+01 -1.85682870e+00 -7.43027286e-01 -7.43027286e-01
 -7.43027286e-01  2.29760159e+00  2.65460649e+00  2.65460649e+00
  2.65460649e+00  1.99520366e+01  1.99520366e+01  1.99520366e+01
  2.88775646e+01  1.68036753e+02  8.00406752e+02  4.57521764e+03]
E1 = -182.18464858244684  E_coul = 53.90706332938755
cycle= 1 E= -128.277585253059  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269236
diis-c [-0.07248829  1.        ]
  HOMO = -0.810132332718995  LUMO = 2.25336617449025
  mo_energy =
[-3.28311741e+01 -1.92509546e+00 -8.10132333e-01 -8.10132333e-01
 -8.10132333e-01  2.25336617e+00  2.59852143e+00  2.59852143e+00
  2.59852143e+00  1.97569772e+01  1.97569772e+01  1.97569772e+01
  2.86715818e+01  1.67747171e+02  8.00066954e+02  4.57483582e+03]
E1 = -182.65784234619926  E_coul = 54.378564790683484
cycle= 2 E= -128.279277555516  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105707
diis-c [-2.21160658e-04  2.80215851e-01  7.19784149e-01]
  HOMO = -0.786878615694553  LUMO = 2.27092181956406
  mo_energy =
[-3.27550137e+01 -1.90104023e+00 -7.86878616e-01 -7.86878616e-01
 -7.86878616e-01  2.27092182e+00  2.61955873e+00  2.61955873e+00
  2.61955873e+00  1.98142165e+01  1.98142165e+01  1.98142165e+01
  2.87311148e+01  1.67825490e+02  8.00153239e+02  4.57492590e+03]
E1 = -182.52253093174392  E_coul = 54.242934561211165
cycle= 3 E= -128.279596370533  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000697764
diis-c [-3.43898511e-08 -4.48858962e-03 -5.18735989e-03  1.00967595e+00]
  HOMO = -0.787065076882471  LUMO = 2.27078671739042
  mo_energy =
[-3.27554788e+01 -1.90125331e+00 -7.87065077e-01 -7.87065077e-01
 -7.87065077e-01  2.27078672e+00  2.61942845e+00  2.61942845e+00
  2.61942845e+00  1.98138453e+01  1.98138453e+01  1.98138453e+01
  2.87306924e+01  1.67825115e+02  8.00153009e+02  4.57492577e+03]
E1 = -182.52345566356516  E_coul = 54.243859277824164
cycle= 4 E= -128.279596385741  delta_E= -1.52e-08  |g|= 2.18e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.67012e-05
diis-c [-1.33206073e-10  2.38571748e-04 -2.02609905e-04 -7.98325696e-02
  1.07979661e+00]
  HOMO = -0.787058065505373  LUMO = 2.27078844179135
  mo_energy =
[-3.27554610e+01 -1.90125030e+00 -7.87058066e-01 -7.87058066e-01
 -7.87058066e-01  2.27078844e+00  2.61943431e+00  2.61943431e+00
  2.61943431e+00  1.98138595e+01  1.98138595e+01  1.98138595e+01
  2.87307050e+01  1.67825135e+02  8.00153038e+02  4.57492580e+03]
E1 = -182.52342603176007  E_coul = 54.24382964597199
cycle= 5 E= -128.279596385788  delta_E= -4.71e-11  |g|= 1.77e-06  |ddm|= 8.52e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52342603176007  E_coul = 54.24382964597199
  HOMO = -0.787057658034397  LUMO = 2.27078840705766
  mo_energy =
[-3.27554601e+01 -1.90125033e+00 -7.87057658e-01 -7.87057658e-01
 -7.87057658e-01  2.27078841e+00  2.61943468e+00  2.61943468e+00
  2.61943468e+00  1.98138602e+01  1.98138602e+01  1.98138602e+01
  2.87307057e+01  1.67825136e+02  8.00153039e+02  4.57492581e+03]
E1 = -182.52342455053653  E_coul = 54.243828164748095
Extra cycle  E= -128.279596385788  delta_E= -3.69e-13  |g|= 4.05e-07  |ddm|= 9.9e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.20584078100428
E1 = -182.52342455053653  E_coul = 54.243828164748095
init E= -128.279596385788
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787057738422664  LUMO = 2.27078827927704
  mo_energy =
[-3.27554604e+01 -1.90125050e+00 -7.87057738e-01 -7.87057738e-01
 -7.87057738e-01  2.27078828e+00  2.61943461e+00  2.61943461e+00
  2.61943461e+00  1.98138599e+01  1.98138599e+01  1.98138599e+01
  2.87307054e+01  1.67825136e+02  8.00153039e+02  4.57492581e+03]
E1 = -182.52342518808388  E_coul = 54.2438288022952
cycle= 1 E= -128.279596385789  delta_E= -2.56e-13  |g|= 1.01e-07  |ddm|= 2.39e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52342518808388  E_coul = 54.2438288022952
  HOMO = -0.787057690772079  LUMO = 2.27078830274681
  mo_energy =
[-3.27554603e+01 -1.90125046e+00 -7.87057691e-01 -7.87057691e-01
 -7.87057691e-01  2.27078830e+00  2.61943465e+00  2.61943465e+00
  2.61943465e+00  1.98138600e+01  1.98138600e+01  1.98138600e+01
  2.87307055e+01  1.67825136e+02  8.00153039e+02  4.57492581e+03]
E1 = -182.52342494301797  E_coul = 54.24382855722944
Extra cycle  E= -128.279596385789  delta_E= 1.71e-13  |g|= 3.64e-08  |ddm|= 3.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43897330e+03 1.05912150e+02 4.22037282e+02 5.15817314e-01
 3.15375014e+01 1.02438407e+01 1.75532306e+00 2.77578899e+00
 1.33315700e+01 5.99993859e-01]
grad_E = [-1.09340804e-05 -1.88289502e-06 -3.65710480e-06 -3.15943061e-04
  4.01484657e-05 -9.51305670e-05  8.48816387e-05 -2.09696551e-04
  6.75432475e-05 -1.86287399e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.03156382        1
[INPUT] 0    0    [1    /1   ]  105.78830001         1
[INPUT] 0    0    [1    /1   ]  421.846844627        1
[INPUT] 0    0    [1    /1   ]  0.515836235152       1
[INPUT] 0    0    [1    /1   ]  31.5025661331        1
[INPUT] 0    0    [1    /1   ]  10.2398567622        1
[INPUT] 0    0    [1    /1   ]  1.75490668818        1
[INPUT] 1    0    [1    /1   ]  2.77516732596        1
[INPUT] 1    0    [1    /1   ]  13.3249591837        1
[INPUT] 1    0    [1    /1   ]  0.599935929334       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0315638183674, 1.0]], [0, [105.78830001028741, 1.0]], [0, [421.8468446274751, 1.0]], [0, [0.5158362351521514, 1.0]], [0, [31.5025661331382, 1.0]], [0, [10.2398567621844, 1.0]], [0, [1.7549066881837203, 1.0]], [1, [2.7751673259608878, 1.0]], [1, [13.32495918371616, 1.0]], [1, [0.5999359293343487, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.03156382]
bas 1, expnt(s) = [105.78830001]
bas 2, expnt(s) = [421.84684463]
bas 3, expnt(s) = [0.51583624]
bas 4, expnt(s) = [31.50256613]
bas 5, expnt(s) = [10.23985676]
bas 6, expnt(s) = [1.75490669]
bas 7, expnt(s) = [2.77516733]
bas 8, expnt(s) = [13.32495918]
bas 9, expnt(s) = [0.59993593]
CPU time:       317.77
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43903156e+03 8.76855620e+02 1.05788300e+02 8.33380344e+01
 4.21846845e+02 2.35169572e+02 5.15836235e-01 1.53779664e+00
 3.15025661e+01 3.35949867e+01 1.02398568e+01 1.44622357e+01
 1.75490669e+00 3.85217090e+00 2.77516733e+00 1.04495084e+01
 1.33249592e+01 7.42705691e+01 5.99935929e-01 1.54033606e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966902562221275
cond(S) = 77.26050672887445
E1 = -183.22908359041645  E_coul = 55.007862752114676
init E= -128.221220838302
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743022686941487  LUMO = 2.29719079748721
  mo_energy =
[-3.25525824e+01 -1.85682862e+00 -7.43022687e-01 -7.43022687e-01
 -7.43022687e-01  2.29719080e+00  2.65417103e+00  2.65417103e+00
  2.65417103e+00  1.99429955e+01  1.99429955e+01  1.99429955e+01
  2.88536323e+01  1.67837233e+02  7.99713697e+02  4.57413537e+03]
E1 = -182.18459203550617  E_coul = 53.90700627370038
cycle= 1 E= -128.277585761806  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269231
diis-c [-0.07248525  1.        ]
  HOMO = -0.8101316693053  LUMO = 2.2529589413703
  mo_energy =
[-3.28311930e+01 -1.92510736e+00 -8.10131669e-01 -8.10131669e-01
 -8.10131669e-01  2.25295894e+00  2.59809319e+00  2.59809319e+00
  2.59809319e+00  1.97479799e+01  1.97479799e+01  1.97479799e+01
  2.86477229e+01  1.67547719e+02  7.99373933e+02  4.57375357e+03]
E1 = -182.65781510318166  E_coul = 54.37853699954759
cycle= 2 E= -128.279278103634  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105718
diis-c [-2.21379726e-04  2.80241089e-01  7.19758911e-01]
  HOMO = -0.78687693797264  LUMO = 2.27051089681219
  mo_energy =
[-3.27550317e+01 -1.90105146e+00 -7.86876938e-01 -7.86876938e-01
 -7.86876938e-01  2.27051090e+00  2.61912796e+00  2.61912796e+00
  2.61912796e+00  1.98052101e+01  1.98052101e+01  1.98052101e+01
  2.87072401e+01  1.67626029e+02  7.99460217e+02  4.57384366e+03]
E1 = -182.5224934194621  E_coul = 54.24289645469482
cycle= 3 E= -128.279596964767  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695813
diis-c [-3.49192416e-08 -4.50094953e-03 -5.24403708e-03  1.00974499e+00]
  HOMO = -0.78706282633147  LUMO = 2.2703758754191
  mo_energy =
[-3.27554955e+01 -1.90126447e+00 -7.87062826e-01 -7.87062826e-01
 -7.87062826e-01  2.27037588e+00  2.61899822e+00  2.61899822e+00
  2.61899822e+00  1.98048401e+01  1.98048401e+01  1.98048401e+01
  2.87068188e+01  1.67625655e+02  7.99459989e+02  4.57384353e+03]
E1 = -182.52341595031083  E_coul = 54.24381897037432
cycle= 4 E= -128.279596979937  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.72165e-05
diis-c [-1.37816431e-10  2.42903836e-04 -2.00639055e-04 -8.09557698e-02
  1.08091350e+00]
  HOMO = -0.787055724236984  LUMO = 2.27037758950796
  mo_energy =
[-3.27554775e+01 -1.90126146e+00 -7.87055724e-01 -7.87055724e-01
 -7.87055724e-01  2.27037759e+00  2.61900416e+00  2.61900416e+00
  2.61900416e+00  1.98048544e+01  1.98048544e+01  1.98048544e+01
  2.87068315e+01  1.67625676e+02  7.99460018e+02  4.57384356e+03]
E1 = -182.52338600155102  E_coul = 54.243789021565895
cycle= 5 E= -128.279596979985  delta_E= -4.86e-11  |g|= 1.79e-06  |ddm|= 8.73e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52338600155102  E_coul = 54.243789021565895
  HOMO = -0.787055313541041  LUMO = 2.27037755220865
  mo_energy =
[-3.27554765e+01 -1.90126149e+00 -7.87055314e-01 -7.87055314e-01
 -7.87055314e-01  2.27037755e+00  2.61900453e+00  2.61900453e+00
  2.61900453e+00  1.98048551e+01  1.98048551e+01  1.98048551e+01
  2.87068322e+01  1.67625677e+02  7.99460019e+02  4.57384356e+03]
E1 = -182.52338451267426  E_coul = 54.243787532688735
Extra cycle  E= -128.279596979986  delta_E= -3.98e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43903156e+03 1.05788300e+02 4.21846845e+02 5.15836235e-01
 3.15025661e+01 1.02398568e+01 1.75490669e+00 2.77516733e+00
 1.33249592e+01 5.99935929e-01]
E = -128.2795969799855
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.03156382        1
[INPUT] 0    0    [1    /1   ]  105.78830001         1
[INPUT] 0    0    [1    /1   ]  421.846844627        1
[INPUT] 0    0    [1    /1   ]  0.515836235152       1
[INPUT] 0    0    [1    /1   ]  31.5025661331        1
[INPUT] 0    0    [1    /1   ]  10.2398567622        1
[INPUT] 0    0    [1    /1   ]  1.75490668818        1
[INPUT] 1    0    [1    /1   ]  2.77516732596        1
[INPUT] 1    0    [1    /1   ]  13.3249591837        1
[INPUT] 1    0    [1    /1   ]  0.599935929334       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0315638183674, 1.0]], [0, [105.78830001028741, 1.0]], [0, [421.8468446274751, 1.0]], [0, [0.5158362351521514, 1.0]], [0, [31.5025661331382, 1.0]], [0, [10.2398567621844, 1.0]], [0, [1.7549066881837203, 1.0]], [1, [2.7751673259608878, 1.0]], [1, [13.32495918371616, 1.0]], [1, [0.5999359293343487, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.03156382]
bas 1, expnt(s) = [105.78830001]
bas 2, expnt(s) = [421.84684463]
bas 3, expnt(s) = [0.51583624]
bas 4, expnt(s) = [31.50256613]
bas 5, expnt(s) = [10.23985676]
bas 6, expnt(s) = [1.75490669]
bas 7, expnt(s) = [2.77516733]
bas 8, expnt(s) = [13.32495918]
bas 9, expnt(s) = [0.59993593]
CPU time:       319.02
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43903156e+03 8.76855620e+02 1.05788300e+02 8.33380344e+01
 4.21846845e+02 2.35169572e+02 5.15836235e-01 1.53779664e+00
 3.15025661e+01 3.35949867e+01 1.02398568e+01 1.44622357e+01
 1.75490669e+00 3.85217090e+00 2.77516733e+00 1.04495084e+01
 1.33249592e+01 7.42705691e+01 5.99935929e-01 1.54033606e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966902562221275
cond(S) = 77.26050672887445
E1 = -183.22908359041645  E_coul = 55.007862752114676
init E= -128.221220838302
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743022686941487  LUMO = 2.29719079748721
  mo_energy =
[-3.25525824e+01 -1.85682862e+00 -7.43022687e-01 -7.43022687e-01
 -7.43022687e-01  2.29719080e+00  2.65417103e+00  2.65417103e+00
  2.65417103e+00  1.99429955e+01  1.99429955e+01  1.99429955e+01
  2.88536323e+01  1.67837233e+02  7.99713697e+02  4.57413537e+03]
E1 = -182.18459203550617  E_coul = 53.90700627370038
cycle= 1 E= -128.277585761806  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269231
diis-c [-0.07248525  1.        ]
  HOMO = -0.8101316693053  LUMO = 2.2529589413703
  mo_energy =
[-3.28311930e+01 -1.92510736e+00 -8.10131669e-01 -8.10131669e-01
 -8.10131669e-01  2.25295894e+00  2.59809319e+00  2.59809319e+00
  2.59809319e+00  1.97479799e+01  1.97479799e+01  1.97479799e+01
  2.86477229e+01  1.67547719e+02  7.99373933e+02  4.57375357e+03]
E1 = -182.65781510318166  E_coul = 54.37853699954759
cycle= 2 E= -128.279278103634  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105718
diis-c [-2.21379726e-04  2.80241089e-01  7.19758911e-01]
  HOMO = -0.78687693797264  LUMO = 2.27051089681219
  mo_energy =
[-3.27550317e+01 -1.90105146e+00 -7.86876938e-01 -7.86876938e-01
 -7.86876938e-01  2.27051090e+00  2.61912796e+00  2.61912796e+00
  2.61912796e+00  1.98052101e+01  1.98052101e+01  1.98052101e+01
  2.87072401e+01  1.67626029e+02  7.99460217e+02  4.57384366e+03]
E1 = -182.5224934194621  E_coul = 54.24289645469482
cycle= 3 E= -128.279596964767  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695813
diis-c [-3.49192416e-08 -4.50094953e-03 -5.24403708e-03  1.00974499e+00]
  HOMO = -0.78706282633147  LUMO = 2.2703758754191
  mo_energy =
[-3.27554955e+01 -1.90126447e+00 -7.87062826e-01 -7.87062826e-01
 -7.87062826e-01  2.27037588e+00  2.61899822e+00  2.61899822e+00
  2.61899822e+00  1.98048401e+01  1.98048401e+01  1.98048401e+01
  2.87068188e+01  1.67625655e+02  7.99459989e+02  4.57384353e+03]
E1 = -182.52341595031083  E_coul = 54.24381897037432
cycle= 4 E= -128.279596979937  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.72165e-05
diis-c [-1.37816431e-10  2.42903836e-04 -2.00639055e-04 -8.09557698e-02
  1.08091350e+00]
  HOMO = -0.787055724236984  LUMO = 2.27037758950796
  mo_energy =
[-3.27554775e+01 -1.90126146e+00 -7.87055724e-01 -7.87055724e-01
 -7.87055724e-01  2.27037759e+00  2.61900416e+00  2.61900416e+00
  2.61900416e+00  1.98048544e+01  1.98048544e+01  1.98048544e+01
  2.87068315e+01  1.67625676e+02  7.99460018e+02  4.57384356e+03]
E1 = -182.52338600155102  E_coul = 54.243789021565895
cycle= 5 E= -128.279596979985  delta_E= -4.86e-11  |g|= 1.79e-06  |ddm|= 8.73e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52338600155102  E_coul = 54.243789021565895
  HOMO = -0.787055313541041  LUMO = 2.27037755220865
  mo_energy =
[-3.27554765e+01 -1.90126149e+00 -7.87055314e-01 -7.87055314e-01
 -7.87055314e-01  2.27037755e+00  2.61900453e+00  2.61900453e+00
  2.61900453e+00  1.98048551e+01  1.98048551e+01  1.98048551e+01
  2.87068322e+01  1.67625677e+02  7.99460019e+02  4.57384356e+03]
E1 = -182.52338451267426  E_coul = 54.243787532688735
Extra cycle  E= -128.279596979986  delta_E= -3.98e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.26050672887445
E1 = -182.52338451267426  E_coul = 54.243787532688735
init E= -128.279596979986
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787055394147781  LUMO = 2.27037742329115
  mo_energy =
[-3.27554769e+01 -1.90126166e+00 -7.87055394e-01 -7.87055394e-01
 -7.87055394e-01  2.27037742e+00  2.61900446e+00  2.61900446e+00
  2.61900446e+00  1.98048549e+01  1.98048549e+01  1.98048549e+01
  2.87068319e+01  1.67625677e+02  7.99460019e+02  4.57384356e+03]
E1 = -182.52338515396823  E_coul = 54.24378817398264
cycle= 1 E= -128.279596979986  delta_E= -8.53e-14  |g|= 1.02e-07  |ddm|= 2.42e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52338515396823  E_coul = 54.24378817398264
  HOMO = -0.787055346181441  LUMO = 2.27037744680684
  mo_energy =
[-3.27554767e+01 -1.90126163e+00 -7.87055346e-01 -7.87055346e-01
 -7.87055346e-01  2.27037745e+00  2.61900450e+00  2.61900450e+00
  2.61900450e+00  1.98048550e+01  1.98048550e+01  1.98048550e+01
  2.87068320e+01  1.67625677e+02  7.99460019e+02  4.57384356e+03]
E1 = -182.52338490752805  E_coul = 54.24378792754253
Extra cycle  E= -128.279596979986  delta_E= 8.53e-14  |g|= 3.67e-08  |ddm|= 4.03e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43903156e+03 1.05788300e+02 4.21846845e+02 5.15836235e-01
 3.15025661e+01 1.02398568e+01 1.75490669e+00 2.77516733e+00
 1.33249592e+01 5.99935929e-01]
grad_E = [-1.09269485e-05 -2.52002611e-06 -3.13362593e-06 -5.65855090e-05
  1.02938699e-05 -1.55077854e-05 -3.74755914e-06 -1.03532851e-04
  2.28041508e-05 -2.12218331e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.01645523        1
[INPUT] 0    0    [1    /1   ]  105.796438393        1
[INPUT] 0    0    [1    /1   ]  421.898343036        1
[INPUT] 0    0    [1    /1   ]  0.515916797515       1
[INPUT] 0    0    [1    /1   ]  31.5015334946        1
[INPUT] 0    0    [1    /1   ]  10.2398977346        1
[INPUT] 0    0    [1    /1   ]  1.75514772292        1
[INPUT] 1    0    [1    /1   ]  2.77511639375        1
[INPUT] 1    0    [1    /1   ]  13.3236188722        1
[INPUT] 1    0    [1    /1   ]  0.599938735894       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.016455231726, 1.0]], [0, [105.79643839337767, 1.0]], [0, [421.8983430363259, 1.0]], [0, [0.5159167975152077, 1.0]], [0, [31.501533494597453, 1.0]], [0, [10.239897734601213, 1.0]], [0, [1.755147722919572, 1.0]], [1, [2.775116393752523, 1.0]], [1, [13.323618872191169, 1.0]], [1, [0.5999387358940896, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.01645523]
bas 1, expnt(s) = [105.79643839]
bas 2, expnt(s) = [421.89834304]
bas 3, expnt(s) = [0.5159168]
bas 4, expnt(s) = [31.50153349]
bas 5, expnt(s) = [10.23989773]
bas 6, expnt(s) = [1.75514772]
bas 7, expnt(s) = [2.77511639]
bas 8, expnt(s) = [13.32361887]
bas 9, expnt(s) = [0.59993874]
CPU time:       322.04
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43901646e+03 8.76851546e+02 1.05796438e+02 8.33428428e+01
 4.21898343e+02 2.35191103e+02 5.15916798e-01 1.53797677e+00
 3.15015335e+01 3.35941608e+01 1.02398977e+01 1.44622791e+01
 1.75514772e+00 3.85256771e+00 2.77511639e+00 1.04492687e+01
 1.33236189e+01 7.42612310e+01 5.99938736e-01 1.54034507e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966901781211323
cond(S) = 77.25645554562638
E1 = -183.22908603825107  E_coul = 55.007865718835866
init E= -128.221220319415
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743021042104394  LUMO = 2.29772892906027
  mo_energy =
[-3.25525867e+01 -1.85682742e+00 -7.43021042e-01 -7.43021042e-01
 -7.43021042e-01  2.29772893e+00  2.65417253e+00  2.65417253e+00
  2.65417253e+00  1.99414432e+01  1.99414432e+01  1.99414432e+01
  2.88547458e+01  1.67842442e+02  7.99787290e+02  4.57430401e+03]
E1 = -182.18468656858184  E_coul = 53.90710047192797
cycle= 1 E= -128.277586096654  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26921
diis-c [-0.07247418  1.        ]
  HOMO = -0.810124130152308  LUMO = 2.25348987474622
  mo_energy =
[-3.28311739e+01 -1.92510193e+00 -8.10124130e-01 -8.10124130e-01
 -8.10124130e-01  2.25348987e+00  2.59810081e+00  2.59810081e+00
  2.59810081e+00  1.97464526e+01  1.97464526e+01  1.97464526e+01
  2.86488536e+01  1.67552952e+02  7.99447552e+02  4.57392224e+03]
E1 = -182.65787178852239  E_coul = 54.378593600748324
cycle= 2 E= -128.279278187774  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105711
diis-c [-2.21373301e-04  2.80243360e-01  7.19756640e-01]
  HOMO = -0.786871392552434  LUMO = 2.27104324268612
  mo_energy =
[-3.27550187e+01 -1.90104811e+00 -7.86871393e-01 -7.86871393e-01
 -7.86871393e-01  2.27104324e+00  2.61913369e+00  2.61913369e+00
  2.61913369e+00  1.98036761e+01  1.98036761e+01  1.98036761e+01
  2.87083658e+01  1.67631256e+02  7.99533829e+02  4.57401231e+03]
E1 = -182.52256122267062  E_coul = 54.24296422083962
cycle= 3 E= -128.279597001831  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695467
diis-c [-3.50168686e-08 -4.50336933e-03 -5.25428228e-03  1.00975765e+00]
  HOMO = -0.787057187480075  LUMO = 2.27090818055309
  mo_energy =
[-3.27554822e+01 -1.90126113e+00 -7.87057187e-01 -7.87057187e-01
 -7.87057187e-01  2.27090818e+00  2.61900402e+00  2.61900402e+00
  2.61900402e+00  1.98033063e+01  1.98033063e+01  1.98033063e+01
  2.87079446e+01  1.67630882e+02  7.99533602e+02  4.57401219e+03]
E1 = -182.52348338631091  E_coul = 54.2438863693158
cycle= 4 E= -128.279597016995  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73241e-05
diis-c [-1.38749836e-10  2.43878642e-04 -2.00290470e-04 -8.12079420e-02
  1.08116435e+00]
  HOMO = -0.787050066620645  LUMO = 2.27090989286817
  mo_energy =
[-3.27554642e+01 -1.90125812e+00 -7.87050067e-01 -7.87050067e-01
 -7.87050067e-01  2.27090989e+00  2.61900997e+00  2.61900997e+00
  2.61900997e+00  1.98033207e+01  1.98033207e+01  1.98033207e+01
  2.87079573e+01  1.67630903e+02  7.99533630e+02  4.57401222e+03]
E1 = -182.52345336949233  E_coul = 54.24385635244808
cycle= 5 E= -128.279597017044  delta_E= -4.91e-11  |g|= 1.8e-06  |ddm|= 8.77e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52345336949233  E_coul = 54.24385635244808
  HOMO = -0.787049655499311  LUMO = 2.27090985494664
  mo_energy =
[-3.27554632e+01 -1.90125815e+00 -7.87049655e-01 -7.87049655e-01
 -7.87049655e-01  2.27090985e+00  2.61901035e+00  2.61901035e+00
  2.61901035e+00  1.98033214e+01  1.98033214e+01  1.98033214e+01
  2.87079580e+01  1.67630904e+02  7.99533632e+02  4.57401222e+03]
E1 = -182.5234518799208  E_coul = 54.243854862876276
Extra cycle  E= -128.279597017045  delta_E= -2.84e-13  |g|= 4.11e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43901646e+03 1.05796438e+02 4.21898343e+02 5.15916798e-01
 3.15015335e+01 1.02398977e+01 1.75514772e+00 2.77511639e+00
 1.33236189e+01 5.99938736e-01]
E = -128.27959701704452
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.01645523        1
[INPUT] 0    0    [1    /1   ]  105.796438393        1
[INPUT] 0    0    [1    /1   ]  421.898343036        1
[INPUT] 0    0    [1    /1   ]  0.515916797515       1
[INPUT] 0    0    [1    /1   ]  31.5015334946        1
[INPUT] 0    0    [1    /1   ]  10.2398977346        1
[INPUT] 0    0    [1    /1   ]  1.75514772292        1
[INPUT] 1    0    [1    /1   ]  2.77511639375        1
[INPUT] 1    0    [1    /1   ]  13.3236188722        1
[INPUT] 1    0    [1    /1   ]  0.599938735894       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.016455231726, 1.0]], [0, [105.79643839337767, 1.0]], [0, [421.8983430363259, 1.0]], [0, [0.5159167975152077, 1.0]], [0, [31.501533494597453, 1.0]], [0, [10.239897734601213, 1.0]], [0, [1.755147722919572, 1.0]], [1, [2.775116393752523, 1.0]], [1, [13.323618872191169, 1.0]], [1, [0.5999387358940896, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.01645523]
bas 1, expnt(s) = [105.79643839]
bas 2, expnt(s) = [421.89834304]
bas 3, expnt(s) = [0.5159168]
bas 4, expnt(s) = [31.50153349]
bas 5, expnt(s) = [10.23989773]
bas 6, expnt(s) = [1.75514772]
bas 7, expnt(s) = [2.77511639]
bas 8, expnt(s) = [13.32361887]
bas 9, expnt(s) = [0.59993874]
CPU time:       323.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43901646e+03 8.76851546e+02 1.05796438e+02 8.33428428e+01
 4.21898343e+02 2.35191103e+02 5.15916798e-01 1.53797677e+00
 3.15015335e+01 3.35941608e+01 1.02398977e+01 1.44622791e+01
 1.75514772e+00 3.85256771e+00 2.77511639e+00 1.04492687e+01
 1.33236189e+01 7.42612310e+01 5.99938736e-01 1.54034507e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966901781211323
cond(S) = 77.25645554562638
E1 = -183.22908603825107  E_coul = 55.007865718835866
init E= -128.221220319415
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743021042104394  LUMO = 2.29772892906027
  mo_energy =
[-3.25525867e+01 -1.85682742e+00 -7.43021042e-01 -7.43021042e-01
 -7.43021042e-01  2.29772893e+00  2.65417253e+00  2.65417253e+00
  2.65417253e+00  1.99414432e+01  1.99414432e+01  1.99414432e+01
  2.88547458e+01  1.67842442e+02  7.99787290e+02  4.57430401e+03]
E1 = -182.18468656858184  E_coul = 53.90710047192797
cycle= 1 E= -128.277586096654  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26921
diis-c [-0.07247418  1.        ]
  HOMO = -0.810124130152308  LUMO = 2.25348987474622
  mo_energy =
[-3.28311739e+01 -1.92510193e+00 -8.10124130e-01 -8.10124130e-01
 -8.10124130e-01  2.25348987e+00  2.59810081e+00  2.59810081e+00
  2.59810081e+00  1.97464526e+01  1.97464526e+01  1.97464526e+01
  2.86488536e+01  1.67552952e+02  7.99447552e+02  4.57392224e+03]
E1 = -182.65787178852239  E_coul = 54.378593600748324
cycle= 2 E= -128.279278187774  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105711
diis-c [-2.21373301e-04  2.80243360e-01  7.19756640e-01]
  HOMO = -0.786871392552434  LUMO = 2.27104324268612
  mo_energy =
[-3.27550187e+01 -1.90104811e+00 -7.86871393e-01 -7.86871393e-01
 -7.86871393e-01  2.27104324e+00  2.61913369e+00  2.61913369e+00
  2.61913369e+00  1.98036761e+01  1.98036761e+01  1.98036761e+01
  2.87083658e+01  1.67631256e+02  7.99533829e+02  4.57401231e+03]
E1 = -182.52256122267062  E_coul = 54.24296422083962
cycle= 3 E= -128.279597001831  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695467
diis-c [-3.50168686e-08 -4.50336933e-03 -5.25428228e-03  1.00975765e+00]
  HOMO = -0.787057187480075  LUMO = 2.27090818055309
  mo_energy =
[-3.27554822e+01 -1.90126113e+00 -7.87057187e-01 -7.87057187e-01
 -7.87057187e-01  2.27090818e+00  2.61900402e+00  2.61900402e+00
  2.61900402e+00  1.98033063e+01  1.98033063e+01  1.98033063e+01
  2.87079446e+01  1.67630882e+02  7.99533602e+02  4.57401219e+03]
E1 = -182.52348338631091  E_coul = 54.2438863693158
cycle= 4 E= -128.279597016995  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73241e-05
diis-c [-1.38749836e-10  2.43878642e-04 -2.00290470e-04 -8.12079420e-02
  1.08116435e+00]
  HOMO = -0.787050066620645  LUMO = 2.27090989286817
  mo_energy =
[-3.27554642e+01 -1.90125812e+00 -7.87050067e-01 -7.87050067e-01
 -7.87050067e-01  2.27090989e+00  2.61900997e+00  2.61900997e+00
  2.61900997e+00  1.98033207e+01  1.98033207e+01  1.98033207e+01
  2.87079573e+01  1.67630903e+02  7.99533630e+02  4.57401222e+03]
E1 = -182.52345336949233  E_coul = 54.24385635244808
cycle= 5 E= -128.279597017044  delta_E= -4.91e-11  |g|= 1.8e-06  |ddm|= 8.77e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52345336949233  E_coul = 54.24385635244808
  HOMO = -0.787049655499311  LUMO = 2.27090985494664
  mo_energy =
[-3.27554632e+01 -1.90125815e+00 -7.87049655e-01 -7.87049655e-01
 -7.87049655e-01  2.27090985e+00  2.61901035e+00  2.61901035e+00
  2.61901035e+00  1.98033214e+01  1.98033214e+01  1.98033214e+01
  2.87079580e+01  1.67630904e+02  7.99533632e+02  4.57401222e+03]
E1 = -182.5234518799208  E_coul = 54.243854862876276
Extra cycle  E= -128.279597017045  delta_E= -2.84e-13  |g|= 4.11e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.25645554562638
E1 = -182.5234518799208  E_coul = 54.243854862876276
init E= -128.279597017045
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787049736098353  LUMO = 2.27090972582756
  mo_energy =
[-3.27554635e+01 -1.90125832e+00 -7.87049736e-01 -7.87049736e-01
 -7.87049736e-01  2.27090973e+00  2.61901027e+00  2.61901027e+00
  2.61901027e+00  1.98033211e+01  1.98033211e+01  1.98033211e+01
  2.87079577e+01  1.67630904e+02  7.99533631e+02  4.57401222e+03]
E1 = -182.52345252157625  E_coul = 54.243855504531595
cycle= 1 E= -128.279597017045  delta_E= -1.14e-13  |g|= 1.02e-07  |ddm|= 2.43e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52345252157625  E_coul = 54.243855504531595
  HOMO = -0.787049688097066  LUMO = 2.27090974933955
  mo_energy =
[-3.27554634e+01 -1.90125829e+00 -7.87049688e-01 -7.87049688e-01
 -7.87049688e-01  2.27090975e+00  2.61901032e+00  2.61901032e+00
  2.61901032e+00  1.98033212e+01  1.98033212e+01  1.98033212e+01
  2.87079578e+01  1.67630904e+02  7.99533632e+02  4.57401222e+03]
E1 = -182.5234522750086  E_coul = 54.24385525796404
Extra cycle  E= -128.279597017045  delta_E= 8.53e-14  |g|= 3.67e-08  |ddm|= 4.04e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43901646e+03 1.05796438e+02 4.21898343e+02 5.15916798e-01
 3.15015335e+01 1.02398977e+01 1.75514772e+00 2.77511639e+00
 1.33236189e+01 5.99938736e-01]
grad_E = [-1.09375174e-05 -1.02105926e-06 -3.11260356e-06 -1.68421747e-05
  1.47117547e-06 -1.49056233e-07  1.97835822e-06 -4.54463243e-05
  8.80246247e-06 -4.17779241e-07]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.00813484        1
[INPUT] 0    0    [1    /1   ]  105.806366963        1
[INPUT] 0    0    [1    /1   ]  421.926273815        1
[INPUT] 0    0    [1    /1   ]  0.515937356904       1
[INPUT] 0    0    [1    /1   ]  31.5028415021        1
[INPUT] 0    0    [1    /1   ]  10.2400661331        1
[INPUT] 0    0    [1    /1   ]  1.75519577434        1
[INPUT] 1    0    [1    /1   ]  2.77513255475        1
[INPUT] 1    0    [1    /1   ]  13.3231574525        1
[INPUT] 1    0    [1    /1   ]  0.599945836716       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.008134841921, 1.0]], [0, [105.80636696338964, 1.0]], [0, [421.92627381528223, 1.0]], [0, [0.5159373569036184, 1.0]], [0, [31.502841502065024, 1.0]], [0, [10.240066133123857, 1.0]], [0, [1.7551957743387854, 1.0]], [1, [2.7751325547547006, 1.0]], [1, [13.32315745246669, 1.0]], [1, [0.5999458367155706, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.00813484]
bas 1, expnt(s) = [105.80636696]
bas 2, expnt(s) = [421.92627382]
bas 3, expnt(s) = [0.51593736]
bas 4, expnt(s) = [31.5028415]
bas 5, expnt(s) = [10.24006613]
bas 6, expnt(s) = [1.75519577]
bas 7, expnt(s) = [2.77513255]
bas 8, expnt(s) = [13.32315745]
bas 9, expnt(s) = [0.59994584]
CPU time:       326.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900813e+03 8.76849303e+02 1.05806367e+02 8.33487087e+01
 4.21926274e+02 2.35202781e+02 5.15937357e-01 1.53802273e+00
 3.15028415e+01 3.35952069e+01 1.02400661e+01 1.44624575e+01
 1.75519577e+00 3.85264682e+00 2.77513255e+00 1.04493447e+01
 1.33231575e+01 7.42580162e+01 5.99945837e-01 1.54036786e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900344731041
cond(S) = 77.25052001466221
E1 = -183.22908586722707  E_coul = 55.007866281423155
init E= -128.221219585804
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743020395446704  LUMO = 2.29785480406367
  mo_energy =
[-3.25525885e+01 -1.85682701e+00 -7.43020395e-01 -7.43020395e-01
 -7.43020395e-01  2.29785480e+00  2.65421177e+00  2.65421177e+00
  2.65421177e+00  1.99410328e+01  1.99410328e+01  1.99410328e+01
  2.88559394e+01  1.67854300e+02  7.99849987e+02  4.57442069e+03]
E1 = -182.184749528349  E_coul = 53.90716322391034
cycle= 1 E= -128.277586304439  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269198
diis-c [-0.07246776  1.        ]
  HOMO = -0.81011937682452  LUMO = 2.25361655788011
  mo_energy =
[-3.28311613e+01 -1.92509736e+00 -8.10119377e-01 -8.10119377e-01
 -8.10119377e-01  2.25361656e+00  2.59814330e+00  2.59814330e+00
  2.59814330e+00  1.97460552e+01  1.97460552e+01  1.97460552e+01
  2.86500553e+01  1.67564822e+02  7.99510263e+02  4.57403894e+03]
E1 = -182.65790839481804  E_coul = 54.378630167303484
cycle= 2 E= -128.279278227515  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105706
diis-c [-2.21353741e-04  2.80242222e-01  7.19757778e-01]
  HOMO = -0.786867931687828  LUMO = 2.27116962034402
  mo_energy =
[-3.27550100e+01 -1.90104490e+00 -7.86867932e-01 -7.86867932e-01
 -7.86867932e-01  2.27116962e+00  2.61917523e+00  2.61917523e+00
  2.61917523e+00  1.98032750e+01  1.98032750e+01  1.98032750e+01
  2.87095651e+01  1.67643122e+02  7.99596536e+02  4.57412901e+03]
E1 = -182.5226056257392  E_coul = 54.24300861876018
cycle= 3 E= -128.279597006979  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695468
diis-c [-3.50215657e-08 -4.50324240e-03 -5.25370346e-03  1.00975695e+00]
  HOMO = -0.7870537291057  LUMO = 2.27103453477497
  mo_energy =
[-3.27554736e+01 -1.90125793e+00 -7.87053729e-01 -7.87053729e-01
 -7.87053729e-01  2.27103453e+00  2.61904556e+00  2.61904556e+00
  2.61904556e+00  1.98029051e+01  1.98029051e+01  1.98029051e+01
  2.87091439e+01  1.67642749e+02  7.99596309e+02  4.57412888e+03]
E1 = -182.52352781922258  E_coul = 54.24393079707749
cycle= 4 E= -128.279597022145  delta_E= -1.52e-08  |g|= 2.23e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73397e-05
diis-c [-1.38909072e-10  2.44050807e-04 -2.00322367e-04 -8.12564161e-02
  1.08121269e+00]
  HOMO = -0.787046605611024  LUMO = 2.27103624655934
  mo_energy =
[-3.27554555e+01 -1.90125493e+00 -7.87046606e-01 -7.87046606e-01
 -7.87046606e-01  2.27103625e+00  2.61905152e+00  2.61905152e+00
  2.61905152e+00  1.98029195e+01  1.98029195e+01  1.98029195e+01
  2.87091566e+01  1.67642770e+02  7.99596338e+02  4.57412892e+03]
E1 = -182.52349779326389  E_coul = 54.24390077106989
cycle= 5 E= -128.279597022194  delta_E= -4.89e-11  |g|= 1.8e-06  |ddm|= 8.78e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52349779326389  E_coul = 54.24390077106989
  HOMO = -0.787046194449653  LUMO = 2.27103620853154
  mo_energy =
[-3.27554546e+01 -1.90125496e+00 -7.87046194e-01 -7.87046194e-01
 -7.87046194e-01  2.27103621e+00  2.61905189e+00  2.61905189e+00
  2.61905189e+00  1.98029202e+01  1.98029202e+01  1.98029202e+01
  2.87091572e+01  1.67642771e+02  7.99596339e+02  4.57412892e+03]
E1 = -182.52349630372544  E_coul = 54.24389928153084
Extra cycle  E= -128.279597022195  delta_E= -5.97e-13  |g|= 4.11e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43900813e+03 1.05806367e+02 4.21926274e+02 5.15937357e-01
 3.15028415e+01 1.02400661e+01 1.75519577e+00 2.77513255e+00
 1.33231575e+01 5.99945837e-01]
E = -128.2795970221946
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:11 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.00813484        1
[INPUT] 0    0    [1    /1   ]  105.806366963        1
[INPUT] 0    0    [1    /1   ]  421.926273815        1
[INPUT] 0    0    [1    /1   ]  0.515937356904       1
[INPUT] 0    0    [1    /1   ]  31.5028415021        1
[INPUT] 0    0    [1    /1   ]  10.2400661331        1
[INPUT] 0    0    [1    /1   ]  1.75519577434        1
[INPUT] 1    0    [1    /1   ]  2.77513255475        1
[INPUT] 1    0    [1    /1   ]  13.3231574525        1
[INPUT] 1    0    [1    /1   ]  0.599945836716       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.008134841921, 1.0]], [0, [105.80636696338964, 1.0]], [0, [421.92627381528223, 1.0]], [0, [0.5159373569036184, 1.0]], [0, [31.502841502065024, 1.0]], [0, [10.240066133123857, 1.0]], [0, [1.7551957743387854, 1.0]], [1, [2.7751325547547006, 1.0]], [1, [13.32315745246669, 1.0]], [1, [0.5999458367155706, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.00813484]
bas 1, expnt(s) = [105.80636696]
bas 2, expnt(s) = [421.92627382]
bas 3, expnt(s) = [0.51593736]
bas 4, expnt(s) = [31.5028415]
bas 5, expnt(s) = [10.24006613]
bas 6, expnt(s) = [1.75519577]
bas 7, expnt(s) = [2.77513255]
bas 8, expnt(s) = [13.32315745]
bas 9, expnt(s) = [0.59994584]
CPU time:       327.55
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900813e+03 8.76849303e+02 1.05806367e+02 8.33487087e+01
 4.21926274e+02 2.35202781e+02 5.15937357e-01 1.53802273e+00
 3.15028415e+01 3.35952069e+01 1.02400661e+01 1.44624575e+01
 1.75519577e+00 3.85264682e+00 2.77513255e+00 1.04493447e+01
 1.33231575e+01 7.42580162e+01 5.99945837e-01 1.54036786e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900344731041
cond(S) = 77.25052001466221
E1 = -183.22908586722707  E_coul = 55.007866281423155
init E= -128.221219585804
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743020395446704  LUMO = 2.29785480406367
  mo_energy =
[-3.25525885e+01 -1.85682701e+00 -7.43020395e-01 -7.43020395e-01
 -7.43020395e-01  2.29785480e+00  2.65421177e+00  2.65421177e+00
  2.65421177e+00  1.99410328e+01  1.99410328e+01  1.99410328e+01
  2.88559394e+01  1.67854300e+02  7.99849987e+02  4.57442069e+03]
E1 = -182.184749528349  E_coul = 53.90716322391034
cycle= 1 E= -128.277586304439  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269198
diis-c [-0.07246776  1.        ]
  HOMO = -0.81011937682452  LUMO = 2.25361655788011
  mo_energy =
[-3.28311613e+01 -1.92509736e+00 -8.10119377e-01 -8.10119377e-01
 -8.10119377e-01  2.25361656e+00  2.59814330e+00  2.59814330e+00
  2.59814330e+00  1.97460552e+01  1.97460552e+01  1.97460552e+01
  2.86500553e+01  1.67564822e+02  7.99510263e+02  4.57403894e+03]
E1 = -182.65790839481804  E_coul = 54.378630167303484
cycle= 2 E= -128.279278227515  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105706
diis-c [-2.21353741e-04  2.80242222e-01  7.19757778e-01]
  HOMO = -0.786867931687828  LUMO = 2.27116962034402
  mo_energy =
[-3.27550100e+01 -1.90104490e+00 -7.86867932e-01 -7.86867932e-01
 -7.86867932e-01  2.27116962e+00  2.61917523e+00  2.61917523e+00
  2.61917523e+00  1.98032750e+01  1.98032750e+01  1.98032750e+01
  2.87095651e+01  1.67643122e+02  7.99596536e+02  4.57412901e+03]
E1 = -182.5226056257392  E_coul = 54.24300861876018
cycle= 3 E= -128.279597006979  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695468
diis-c [-3.50215657e-08 -4.50324240e-03 -5.25370346e-03  1.00975695e+00]
  HOMO = -0.7870537291057  LUMO = 2.27103453477497
  mo_energy =
[-3.27554736e+01 -1.90125793e+00 -7.87053729e-01 -7.87053729e-01
 -7.87053729e-01  2.27103453e+00  2.61904556e+00  2.61904556e+00
  2.61904556e+00  1.98029051e+01  1.98029051e+01  1.98029051e+01
  2.87091439e+01  1.67642749e+02  7.99596309e+02  4.57412888e+03]
E1 = -182.52352781922258  E_coul = 54.24393079707749
cycle= 4 E= -128.279597022145  delta_E= -1.52e-08  |g|= 2.23e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73397e-05
diis-c [-1.38909072e-10  2.44050807e-04 -2.00322367e-04 -8.12564161e-02
  1.08121269e+00]
  HOMO = -0.787046605611024  LUMO = 2.27103624655934
  mo_energy =
[-3.27554555e+01 -1.90125493e+00 -7.87046606e-01 -7.87046606e-01
 -7.87046606e-01  2.27103625e+00  2.61905152e+00  2.61905152e+00
  2.61905152e+00  1.98029195e+01  1.98029195e+01  1.98029195e+01
  2.87091566e+01  1.67642770e+02  7.99596338e+02  4.57412892e+03]
E1 = -182.52349779326389  E_coul = 54.24390077106989
cycle= 5 E= -128.279597022194  delta_E= -4.89e-11  |g|= 1.8e-06  |ddm|= 8.78e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52349779326389  E_coul = 54.24390077106989
  HOMO = -0.787046194449653  LUMO = 2.27103620853154
  mo_energy =
[-3.27554546e+01 -1.90125496e+00 -7.87046194e-01 -7.87046194e-01
 -7.87046194e-01  2.27103621e+00  2.61905189e+00  2.61905189e+00
  2.61905189e+00  1.98029202e+01  1.98029202e+01  1.98029202e+01
  2.87091572e+01  1.67642771e+02  7.99596339e+02  4.57412892e+03]
E1 = -182.52349630372544  E_coul = 54.24389928153084
Extra cycle  E= -128.279597022195  delta_E= -5.97e-13  |g|= 4.11e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.25052001466221
E1 = -182.52349630372544  E_coul = 54.24389928153084
init E= -128.279597022195
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787046275038494  LUMO = 2.27103607938887
  mo_energy =
[-3.27554549e+01 -1.90125513e+00 -7.87046275e-01 -7.87046275e-01
 -7.87046275e-01  2.27103608e+00  2.61905182e+00  2.61905182e+00
  2.61905182e+00  1.98029200e+01  1.98029200e+01  1.98029200e+01
  2.87091570e+01  1.67642770e+02  7.99596339e+02  4.57412892e+03]
E1 = -182.52349694537813  E_coul = 54.24389992318369
cycle= 1 E= -128.279597022194  delta_E= 1.71e-13  |g|= 1.02e-07  |ddm|= 2.43e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52349694537813  E_coul = 54.24389992318369
  HOMO = -0.787046227036001  LUMO = 2.27103610289799
  mo_energy =
[-3.27554548e+01 -1.90125509e+00 -7.87046227e-01 -7.87046227e-01
 -7.87046227e-01  2.27103610e+00  2.61905186e+00  2.61905186e+00
  2.61905186e+00  1.98029201e+01  1.98029201e+01  1.98029201e+01
  2.87091571e+01  1.67642771e+02  7.99596339e+02  4.57412892e+03]
E1 = -182.52349669881528  E_coul = 54.2438996766206
Extra cycle  E= -128.279597022195  delta_E= -2.56e-13  |g|= 3.67e-08  |ddm|= 4.04e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43900813e+03 1.05806367e+02 4.21926274e+02 5.15937357e-01
 3.15028415e+01 1.02400661e+01 1.75519577e+00 2.77513255e+00
 1.33231575e+01 5.99945837e-01]
grad_E = [-1.09406089e-05 -2.09043542e-07 -3.16142213e-06  1.87593114e-06
 -8.74146031e-07  1.85587452e-06  7.67686714e-09 -7.65068460e-06
  1.71476285e-06 -3.57484269e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.00748731        1
[INPUT] 0    0    [1    /1   ]  105.80815081         1
[INPUT] 0    0    [1    /1   ]  421.928406134        1
[INPUT] 0    0    [1    /1   ]  0.515936738117       1
[INPUT] 0    0    [1    /1   ]  31.5033589693        1
[INPUT] 0    0    [1    /1   ]  10.2401265872        1
[INPUT] 0    0    [1    /1   ]  1.75519597494        1
[INPUT] 1    0    [1    /1   ]  2.7751352879         1
[INPUT] 1    0    [1    /1   ]  13.3230532929        1
[INPUT] 1    0    [1    /1   ]  0.59994743193        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0074873094104, 1.0]], [0, [105.80815080994833, 1.0]], [0, [421.92840613416877, 1.0]], [0, [0.5159367381170059, 1.0]], [0, [31.503358969340336, 1.0]], [0, [10.240126587248376, 1.0]], [0, [1.755195974935424, 1.0]], [1, [2.775135287897468, 1.0]], [1, [13.323053292924584, 1.0]], [1, [0.5999474319299872, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.00748731]
bas 1, expnt(s) = [105.80815081]
bas 2, expnt(s) = [421.92840613]
bas 3, expnt(s) = [0.51593674]
bas 4, expnt(s) = [31.50335897]
bas 5, expnt(s) = [10.24012659]
bas 6, expnt(s) = [1.75519597]
bas 7, expnt(s) = [2.77513529]
bas 8, expnt(s) = [13.32305329]
bas 9, expnt(s) = [0.59994743]
CPU time:       330.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900749e+03 8.76849128e+02 1.05808151e+02 8.33497627e+01
 4.21928406e+02 2.35203672e+02 5.15936738e-01 1.53802135e+00
 3.15033590e+01 3.35956208e+01 1.02401266e+01 1.44625215e+01
 1.75519597e+00 3.85264715e+00 2.77513529e+00 1.04493576e+01
 1.33230533e+01 7.42572905e+01 5.99947432e-01 1.54037298e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900057681233
cond(S) = 77.24973020673573
E1 = -183.22908649180965  E_coul = 55.00786671876865
init E= -128.221219773041
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743020244770594  LUMO = 2.29785370132381
  mo_energy =
[-3.25525888e+01 -1.85682689e+00 -7.43020245e-01 -7.43020245e-01
 -7.43020245e-01  2.29785370e+00  2.65422010e+00  2.65422010e+00
  2.65422010e+00  1.99409374e+01  1.99409374e+01  1.99409374e+01
  2.88562687e+01  1.67857192e+02  7.99859385e+02  4.57443464e+03]
E1 = -182.1847596044239  E_coul = 53.90717326837587
cycle= 1 E= -128.277586336048  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269197
diis-c [-0.07246705  1.        ]
  HOMO = -0.810118656630287  LUMO = 2.25361603638943
  mo_energy =
[-3.28311594e+01 -1.92509646e+00 -8.10118657e-01 -8.10118657e-01
 -8.10118657e-01  2.25361604e+00  2.59815205e+00  2.59815205e+00
  2.59815205e+00  1.97459619e+01  1.97459619e+01  1.97459619e+01
  2.86503852e+01  1.67567716e+02  7.99519663e+02  4.57405289e+03]
E1 = -182.6579144438138  E_coul = 54.378636210620385
cycle= 2 E= -128.279278233193  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105705
diis-c [-2.21349636e-04  2.80241683e-01  7.19758317e-01]
  HOMO = -0.786867397070862  LUMO = 2.2711689710965
  mo_energy =
[-3.27550086e+01 -1.90104419e+00 -7.86867397e-01 -7.86867397e-01
 -7.86867397e-01  2.27116897e+00  2.61918386e+00  2.61918386e+00
  2.61918386e+00  1.98031811e+01  1.98031811e+01  1.98031811e+01
  2.87098948e+01  1.67646016e+02  7.99605936e+02  4.57414296e+03]
E1 = -182.52261278597828  E_coul = 54.24301577859729
cycle= 3 E= -128.279597007381  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695519
diis-c [-3.50090908e-08 -4.50288116e-03 -5.25208907e-03  1.00975497e+00]
  HOMO = -0.787053209072408  LUMO = 2.2710338814149
  mo_energy =
[-3.27554723e+01 -1.90125723e+00 -7.87053209e-01 -7.87053209e-01
 -7.87053209e-01  2.27103388e+00  2.61905417e+00  2.61905417e+00
  2.61905417e+00  1.98028112e+01  1.98028112e+01  1.98028112e+01
  2.87094735e+01  1.67645642e+02  7.99605709e+02  4.57414283e+03]
E1 = -182.52353504183924  E_coul = 54.2439380192912
cycle= 4 E= -128.279597022548  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73293e-05
diis-c [-1.38824675e-10  2.43973156e-04 -2.00374502e-04 -8.12370668e-02
  1.08119347e+00]
  HOMO = -0.787046087468939  LUMO = 2.27103559325135
  mo_energy =
[-3.27554542e+01 -1.90125422e+00 -7.87046087e-01 -7.87046087e-01
 -7.87046087e-01  2.27103559e+00  2.61906013e+00  2.61906013e+00
  2.61906013e+00  1.98028255e+01  1.98028255e+01  1.98028255e+01
  2.87094863e+01  1.67645663e+02  7.99605737e+02  4.57414287e+03]
E1 = -182.52350502282457  E_coul = 54.24390800022742
cycle= 5 E= -128.279597022597  delta_E= -4.91e-11  |g|= 1.8e-06  |ddm|= 8.77e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350502282457  E_coul = 54.24390800022742
  HOMO = -0.787045676361524  LUMO = 2.27103555527722
  mo_energy =
[-3.27554532e+01 -1.90125425e+00 -7.87045676e-01 -7.87045676e-01
 -7.87045676e-01  2.27103556e+00  2.61906050e+00  2.61906050e+00
  2.61906050e+00  1.98028263e+01  1.98028263e+01  1.98028263e+01
  2.87094869e+01  1.67645664e+02  7.99605739e+02  4.57414287e+03]
E1 = -182.52350353340063  E_coul = 54.24390651080301
Extra cycle  E= -128.279597022598  delta_E= -4.55e-13  |g|= 4.11e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43900749e+03 1.05808151e+02 4.21928406e+02 5.15936738e-01
 3.15033590e+01 1.02401266e+01 1.75519597e+00 2.77513529e+00
 1.33230533e+01 5.99947432e-01]
E = -128.2795970225976
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.00748731        1
[INPUT] 0    0    [1    /1   ]  105.80815081         1
[INPUT] 0    0    [1    /1   ]  421.928406134        1
[INPUT] 0    0    [1    /1   ]  0.515936738117       1
[INPUT] 0    0    [1    /1   ]  31.5033589693        1
[INPUT] 0    0    [1    /1   ]  10.2401265872        1
[INPUT] 0    0    [1    /1   ]  1.75519597494        1
[INPUT] 1    0    [1    /1   ]  2.7751352879         1
[INPUT] 1    0    [1    /1   ]  13.3230532929        1
[INPUT] 1    0    [1    /1   ]  0.59994743193        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0074873094104, 1.0]], [0, [105.80815080994833, 1.0]], [0, [421.92840613416877, 1.0]], [0, [0.5159367381170059, 1.0]], [0, [31.503358969340336, 1.0]], [0, [10.240126587248376, 1.0]], [0, [1.755195974935424, 1.0]], [1, [2.775135287897468, 1.0]], [1, [13.323053292924584, 1.0]], [1, [0.5999474319299872, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.00748731]
bas 1, expnt(s) = [105.80815081]
bas 2, expnt(s) = [421.92840613]
bas 3, expnt(s) = [0.51593674]
bas 4, expnt(s) = [31.50335897]
bas 5, expnt(s) = [10.24012659]
bas 6, expnt(s) = [1.75519597]
bas 7, expnt(s) = [2.77513529]
bas 8, expnt(s) = [13.32305329]
bas 9, expnt(s) = [0.59994743]
CPU time:       331.87
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900749e+03 8.76849128e+02 1.05808151e+02 8.33497627e+01
 4.21928406e+02 2.35203672e+02 5.15936738e-01 1.53802135e+00
 3.15033590e+01 3.35956208e+01 1.02401266e+01 1.44625215e+01
 1.75519597e+00 3.85264715e+00 2.77513529e+00 1.04493576e+01
 1.33230533e+01 7.42572905e+01 5.99947432e-01 1.54037298e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900057681233
cond(S) = 77.24973020673573
E1 = -183.22908649180965  E_coul = 55.00786671876865
init E= -128.221219773041
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743020244770594  LUMO = 2.29785370132381
  mo_energy =
[-3.25525888e+01 -1.85682689e+00 -7.43020245e-01 -7.43020245e-01
 -7.43020245e-01  2.29785370e+00  2.65422010e+00  2.65422010e+00
  2.65422010e+00  1.99409374e+01  1.99409374e+01  1.99409374e+01
  2.88562687e+01  1.67857192e+02  7.99859385e+02  4.57443464e+03]
E1 = -182.1847596044239  E_coul = 53.90717326837587
cycle= 1 E= -128.277586336048  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269197
diis-c [-0.07246705  1.        ]
  HOMO = -0.810118656630287  LUMO = 2.25361603638943
  mo_energy =
[-3.28311594e+01 -1.92509646e+00 -8.10118657e-01 -8.10118657e-01
 -8.10118657e-01  2.25361604e+00  2.59815205e+00  2.59815205e+00
  2.59815205e+00  1.97459619e+01  1.97459619e+01  1.97459619e+01
  2.86503852e+01  1.67567716e+02  7.99519663e+02  4.57405289e+03]
E1 = -182.6579144438138  E_coul = 54.378636210620385
cycle= 2 E= -128.279278233193  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105705
diis-c [-2.21349636e-04  2.80241683e-01  7.19758317e-01]
  HOMO = -0.786867397070862  LUMO = 2.2711689710965
  mo_energy =
[-3.27550086e+01 -1.90104419e+00 -7.86867397e-01 -7.86867397e-01
 -7.86867397e-01  2.27116897e+00  2.61918386e+00  2.61918386e+00
  2.61918386e+00  1.98031811e+01  1.98031811e+01  1.98031811e+01
  2.87098948e+01  1.67646016e+02  7.99605936e+02  4.57414296e+03]
E1 = -182.52261278597828  E_coul = 54.24301577859729
cycle= 3 E= -128.279597007381  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695519
diis-c [-3.50090908e-08 -4.50288116e-03 -5.25208907e-03  1.00975497e+00]
  HOMO = -0.787053209072408  LUMO = 2.2710338814149
  mo_energy =
[-3.27554723e+01 -1.90125723e+00 -7.87053209e-01 -7.87053209e-01
 -7.87053209e-01  2.27103388e+00  2.61905417e+00  2.61905417e+00
  2.61905417e+00  1.98028112e+01  1.98028112e+01  1.98028112e+01
  2.87094735e+01  1.67645642e+02  7.99605709e+02  4.57414283e+03]
E1 = -182.52353504183924  E_coul = 54.2439380192912
cycle= 4 E= -128.279597022548  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73293e-05
diis-c [-1.38824675e-10  2.43973156e-04 -2.00374502e-04 -8.12370668e-02
  1.08119347e+00]
  HOMO = -0.787046087468939  LUMO = 2.27103559325135
  mo_energy =
[-3.27554542e+01 -1.90125422e+00 -7.87046087e-01 -7.87046087e-01
 -7.87046087e-01  2.27103559e+00  2.61906013e+00  2.61906013e+00
  2.61906013e+00  1.98028255e+01  1.98028255e+01  1.98028255e+01
  2.87094863e+01  1.67645663e+02  7.99605737e+02  4.57414287e+03]
E1 = -182.52350502282457  E_coul = 54.24390800022742
cycle= 5 E= -128.279597022597  delta_E= -4.91e-11  |g|= 1.8e-06  |ddm|= 8.77e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350502282457  E_coul = 54.24390800022742
  HOMO = -0.787045676361524  LUMO = 2.27103555527722
  mo_energy =
[-3.27554532e+01 -1.90125425e+00 -7.87045676e-01 -7.87045676e-01
 -7.87045676e-01  2.27103556e+00  2.61906050e+00  2.61906050e+00
  2.61906050e+00  1.98028263e+01  1.98028263e+01  1.98028263e+01
  2.87094869e+01  1.67645664e+02  7.99605739e+02  4.57414287e+03]
E1 = -182.52350353340063  E_coul = 54.24390651080301
Extra cycle  E= -128.279597022598  delta_E= -4.55e-13  |g|= 4.11e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24973020673573
E1 = -182.52350353340063  E_coul = 54.24390651080301
init E= -128.279597022598
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787045756948268  LUMO = 2.27103542615493
  mo_energy =
[-3.27554536e+01 -1.90125442e+00 -7.87045757e-01 -7.87045757e-01
 -7.87045757e-01  2.27103543e+00  2.61906043e+00  2.61906043e+00
  2.61906043e+00  1.98028260e+01  1.98028260e+01  1.98028260e+01
  2.87094866e+01  1.67645664e+02  7.99605738e+02  4.57414287e+03]
E1 = -182.523504174996  E_coul = 54.24390715239839
cycle= 1 E= -128.279597022598  delta_E=    0  |g|= 1.02e-07  |ddm|= 2.43e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.523504174996  E_coul = 54.24390715239839
  HOMO = -0.787045708950809  LUMO = 2.27103544966383
  mo_energy =
[-3.27554534e+01 -1.90125439e+00 -7.87045709e-01 -7.87045709e-01
 -7.87045709e-01  2.27103545e+00  2.61906047e+00  2.61906047e+00
  2.61906047e+00  1.98028261e+01  1.98028261e+01  1.98028261e+01
  2.87094868e+01  1.67645664e+02  7.99605738e+02  4.57414287e+03]
E1 = -182.5235039284537  E_coul = 54.243906905856015
Extra cycle  E= -128.279597022598  delta_E= -5.68e-14  |g|= 3.67e-08  |ddm|= 4.04e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43900749e+03 1.05808151e+02 4.21928406e+02 5.15936738e-01
 3.15033590e+01 1.02401266e+01 1.75519597e+00 2.77513529e+00
 1.33230533e+01 5.99947432e-01]
grad_E = [-1.09404641e-05 -1.87549279e-07 -3.17277383e-06  6.18734486e-07
 -4.49640766e-07  6.98409947e-07  2.57339137e-07  4.50678073e-09
  1.93132325e-07 -2.03604391e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.0075959         1
[INPUT] 0    0    [1    /1   ]  105.808867337        1
[INPUT] 0    0    [1    /1   ]  421.928057312        1
[INPUT] 0    0    [1    /1   ]  0.51593471356        1
[INPUT] 0    0    [1    /1   ]  31.5036941601        1
[INPUT] 0    0    [1    /1   ]  10.2401669413        1
[INPUT] 0    0    [1    /1   ]  1.75518998016        1
[INPUT] 1    0    [1    /1   ]  2.77513245001        1
[INPUT] 1    0    [1    /1   ]  13.3229646578        1
[INPUT] 1    0    [1    /1   ]  0.599947823218       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0075959018864, 1.0]], [0, [105.80886733684422, 1.0]], [0, [421.92805731186377, 1.0]], [0, [0.5159347135597312, 1.0]], [0, [31.503694160115376, 1.0]], [0, [10.240166941307468, 1.0]], [0, [1.7551899801637585, 1.0]], [1, [2.7751324500084786, 1.0]], [1, [13.322964657794833, 1.0]], [1, [0.5999478232178125, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.0075959]
bas 1, expnt(s) = [105.80886734]
bas 2, expnt(s) = [421.92805731]
bas 3, expnt(s) = [0.51593471]
bas 4, expnt(s) = [31.50369416]
bas 5, expnt(s) = [10.24016694]
bas 6, expnt(s) = [1.75518998]
bas 7, expnt(s) = [2.77513245]
bas 8, expnt(s) = [13.32296466]
bas 9, expnt(s) = [0.59994782]
CPU time:       334.94
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900760e+03 8.76849157e+02 1.05808867e+02 8.33501860e+01
 4.21928057e+02 2.35203526e+02 5.15934714e-01 1.53801682e+00
 3.15036942e+01 3.35958889e+01 1.02401669e+01 1.44625643e+01
 1.75518998e+00 3.85263728e+00 2.77513245e+00 1.04493443e+01
 1.33229647e+01 7.42566730e+01 5.99947823e-01 1.54037423e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900019931664
cond(S) = 77.24952336452307
E1 = -183.22908695847238  E_coul = 55.00786690861593
init E= -128.221220049856
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.743020147411284  LUMO = 2.29784089885011
  mo_energy =
[-3.25525891e+01 -1.85682681e+00 -7.43020147e-01 -7.43020147e-01
 -7.43020147e-01  2.29784090e+00  2.65422115e+00  2.65422115e+00
  2.65422115e+00  1.99408370e+01  1.99408370e+01  1.99408370e+01
  2.88564488e+01  1.67858699e+02  7.99862418e+02  4.57443736e+03]
E1 = -182.18476229435828  E_coul = 53.907175950089254
cycle= 1 E= -128.277586344269  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269197
diis-c [-0.07246701  1.        ]
  HOMO = -0.81011845118388  LUMO = 2.25360363499438
  mo_energy =
[-3.28311590e+01 -1.92509614e+00 -8.10118451e-01 -8.10118451e-01
 -8.10118451e-01  2.25360363e+00  2.59815321e+00  2.59815321e+00
  2.59815321e+00  1.97458625e+01  1.97458625e+01  1.97458625e+01
  2.86505651e+01  1.67569223e+02  7.99522698e+02  4.57405561e+03]
E1 = -182.65791622982346  E_coul = 54.37863799521182
cycle= 2 E= -128.279278234612  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105705
diis-c [-2.21348026e-04  2.80241456e-01  7.19758544e-01]
  HOMO = -0.786867227460163  LUMO = 2.27115648303293
  mo_energy =
[-3.27550084e+01 -1.90104390e+00 -7.86867227e-01 -7.86867227e-01
 -7.86867227e-01  2.27115648e+00  2.61918499e+00  2.61918499e+00
  2.61918499e+00  1.98030814e+01  1.98030814e+01  1.98030814e+01
  2.87100747e+01  1.67647523e+02  7.99608970e+02  4.57414569e+03]
E1 = -182.52261476582902  E_coul = 54.24301775818064
cycle= 3 E= -128.279597007648  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695551
diis-c [-3.50004087e-08 -4.50262103e-03 -5.25099345e-03  1.00975361e+00]
  HOMO = -0.787053048406993  LUMO = 2.27102139232743
  mo_energy =
[-3.27554720e+01 -1.90125695e+00 -7.87053048e-01 -7.87053048e-01
 -7.87053048e-01  2.27102139e+00  2.61905529e+00  2.61905529e+00
  2.61905529e+00  1.98027115e+01  1.98027115e+01  1.98027115e+01
  2.87096535e+01  1.67647149e+02  7.99608742e+02  4.57414556e+03]
E1 = -182.52353706028617  E_coul = 54.24394003746952
cycle= 4 E= -128.279597022817  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73218e-05
diis-c [-1.38764152e-10  2.43917057e-04 -2.00405620e-04 -8.12232509e-02
  1.08117974e+00]
  HOMO = -0.787045928172824  LUMO = 2.27102310417068
  mo_energy =
[-3.27554539e+01 -1.90125394e+00 -7.87045928e-01 -7.87045928e-01
 -7.87045928e-01  2.27102310e+00  2.61906124e+00  2.61906124e+00
  2.61906124e+00  1.98027259e+01  1.98027259e+01  1.98027259e+01
  2.87096662e+01  1.67647170e+02  7.99608771e+02  4.57414559e+03]
E1 = -182.52350704639355  E_coul = 54.24391002352791
cycle= 5 E= -128.279597022866  delta_E= -4.9e-11  |g|= 1.8e-06  |ddm|= 8.77e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350704639355  E_coul = 54.24391002352791
  HOMO = -0.787045517099309  LUMO = 2.27102306623736
  mo_energy =
[-3.27554530e+01 -1.90125397e+00 -7.87045517e-01 -7.87045517e-01
 -7.87045517e-01  2.27102307e+00  2.61906162e+00  2.61906162e+00
  2.61906162e+00  1.98027266e+01  1.98027266e+01  1.98027266e+01
  2.87096668e+01  1.67647171e+02  7.99608772e+02  4.57414559e+03]
E1 = -182.52350555702918  E_coul = 54.24390853416322
Extra cycle  E= -128.279597022866  delta_E= -3.41e-13  |g|= 4.11e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.10 sec, wall time      0.11 sec
exp = [2.43900760e+03 1.05808867e+02 4.21928057e+02 5.15934714e-01
 3.15036942e+01 1.02401669e+01 1.75518998e+00 2.77513245e+00
 1.33229647e+01 5.99947823e-01]
E = -128.27959702286597
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.0075959         1
[INPUT] 0    0    [1    /1   ]  105.808867337        1
[INPUT] 0    0    [1    /1   ]  421.928057312        1
[INPUT] 0    0    [1    /1   ]  0.51593471356        1
[INPUT] 0    0    [1    /1   ]  31.5036941601        1
[INPUT] 0    0    [1    /1   ]  10.2401669413        1
[INPUT] 0    0    [1    /1   ]  1.75518998016        1
[INPUT] 1    0    [1    /1   ]  2.77513245001        1
[INPUT] 1    0    [1    /1   ]  13.3229646578        1
[INPUT] 1    0    [1    /1   ]  0.599947823218       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0075959018864, 1.0]], [0, [105.80886733684422, 1.0]], [0, [421.92805731186377, 1.0]], [0, [0.5159347135597312, 1.0]], [0, [31.503694160115376, 1.0]], [0, [10.240166941307468, 1.0]], [0, [1.7551899801637585, 1.0]], [1, [2.7751324500084786, 1.0]], [1, [13.322964657794833, 1.0]], [1, [0.5999478232178125, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.0075959]
bas 1, expnt(s) = [105.80886734]
bas 2, expnt(s) = [421.92805731]
bas 3, expnt(s) = [0.51593471]
bas 4, expnt(s) = [31.50369416]
bas 5, expnt(s) = [10.24016694]
bas 6, expnt(s) = [1.75518998]
bas 7, expnt(s) = [2.77513245]
bas 8, expnt(s) = [13.32296466]
bas 9, expnt(s) = [0.59994782]
CPU time:       336.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900760e+03 8.76849157e+02 1.05808867e+02 8.33501860e+01
 4.21928057e+02 2.35203526e+02 5.15934714e-01 1.53801682e+00
 3.15036942e+01 3.35958889e+01 1.02401669e+01 1.44625643e+01
 1.75518998e+00 3.85263728e+00 2.77513245e+00 1.04493443e+01
 1.33229647e+01 7.42566730e+01 5.99947823e-01 1.54037423e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900019931664
cond(S) = 77.24952336452307
E1 = -183.22908695847238  E_coul = 55.00786690861593
init E= -128.221220049856
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743020147411284  LUMO = 2.29784089885011
  mo_energy =
[-3.25525891e+01 -1.85682681e+00 -7.43020147e-01 -7.43020147e-01
 -7.43020147e-01  2.29784090e+00  2.65422115e+00  2.65422115e+00
  2.65422115e+00  1.99408370e+01  1.99408370e+01  1.99408370e+01
  2.88564488e+01  1.67858699e+02  7.99862418e+02  4.57443736e+03]
E1 = -182.18476229435828  E_coul = 53.907175950089254
cycle= 1 E= -128.277586344269  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269197
diis-c [-0.07246701  1.        ]
  HOMO = -0.81011845118388  LUMO = 2.25360363499438
  mo_energy =
[-3.28311590e+01 -1.92509614e+00 -8.10118451e-01 -8.10118451e-01
 -8.10118451e-01  2.25360363e+00  2.59815321e+00  2.59815321e+00
  2.59815321e+00  1.97458625e+01  1.97458625e+01  1.97458625e+01
  2.86505651e+01  1.67569223e+02  7.99522698e+02  4.57405561e+03]
E1 = -182.65791622982346  E_coul = 54.37863799521182
cycle= 2 E= -128.279278234612  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105705
diis-c [-2.21348026e-04  2.80241456e-01  7.19758544e-01]
  HOMO = -0.786867227460163  LUMO = 2.27115648303293
  mo_energy =
[-3.27550084e+01 -1.90104390e+00 -7.86867227e-01 -7.86867227e-01
 -7.86867227e-01  2.27115648e+00  2.61918499e+00  2.61918499e+00
  2.61918499e+00  1.98030814e+01  1.98030814e+01  1.98030814e+01
  2.87100747e+01  1.67647523e+02  7.99608970e+02  4.57414569e+03]
E1 = -182.52261476582902  E_coul = 54.24301775818064
cycle= 3 E= -128.279597007648  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695551
diis-c [-3.50004087e-08 -4.50262103e-03 -5.25099345e-03  1.00975361e+00]
  HOMO = -0.787053048406993  LUMO = 2.27102139232743
  mo_energy =
[-3.27554720e+01 -1.90125695e+00 -7.87053048e-01 -7.87053048e-01
 -7.87053048e-01  2.27102139e+00  2.61905529e+00  2.61905529e+00
  2.61905529e+00  1.98027115e+01  1.98027115e+01  1.98027115e+01
  2.87096535e+01  1.67647149e+02  7.99608742e+02  4.57414556e+03]
E1 = -182.52353706028617  E_coul = 54.24394003746952
cycle= 4 E= -128.279597022817  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73218e-05
diis-c [-1.38764152e-10  2.43917057e-04 -2.00405620e-04 -8.12232509e-02
  1.08117974e+00]
  HOMO = -0.787045928172824  LUMO = 2.27102310417068
  mo_energy =
[-3.27554539e+01 -1.90125394e+00 -7.87045928e-01 -7.87045928e-01
 -7.87045928e-01  2.27102310e+00  2.61906124e+00  2.61906124e+00
  2.61906124e+00  1.98027259e+01  1.98027259e+01  1.98027259e+01
  2.87096662e+01  1.67647170e+02  7.99608771e+02  4.57414559e+03]
E1 = -182.52350704639355  E_coul = 54.24391002352791
cycle= 5 E= -128.279597022866  delta_E= -4.9e-11  |g|= 1.8e-06  |ddm|= 8.77e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350704639355  E_coul = 54.24391002352791
  HOMO = -0.787045517099309  LUMO = 2.27102306623736
  mo_energy =
[-3.27554530e+01 -1.90125397e+00 -7.87045517e-01 -7.87045517e-01
 -7.87045517e-01  2.27102307e+00  2.61906162e+00  2.61906162e+00
  2.61906162e+00  1.98027266e+01  1.98027266e+01  1.98027266e+01
  2.87096668e+01  1.67647171e+02  7.99608772e+02  4.57414559e+03]
E1 = -182.52350555702918  E_coul = 54.24390853416322
Extra cycle  E= -128.279597022866  delta_E= -3.41e-13  |g|= 4.11e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24952336452307
E1 = -182.52350555702918  E_coul = 54.24390853416322
init E= -128.279597022866
    CPU time for initialize scf      0.05 sec, wall time      0.06 sec
  HOMO = -0.787045597685969  LUMO = 2.27102293712877
  mo_energy =
[-3.27554533e+01 -1.90125414e+00 -7.87045598e-01 -7.87045598e-01
 -7.87045598e-01  2.27102294e+00  2.61906154e+00  2.61906154e+00
  2.61906154e+00  1.98027263e+01  1.98027263e+01  1.98027263e+01
  2.87096666e+01  1.67647171e+02  7.99608772e+02  4.57414559e+03]
E1 = -182.5235061985938  E_coul = 54.24390917572779
cycle= 1 E= -128.279597022866  delta_E= -2.84e-14  |g|= 1.02e-07  |ddm|= 2.43e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5235061985938  E_coul = 54.24390917572779
  HOMO = -0.787045549691378  LUMO = 2.27102296063782
  mo_energy =
[-3.27554532e+01 -1.90125411e+00 -7.87045550e-01 -7.87045550e-01
 -7.87045550e-01  2.27102296e+00  2.61906159e+00  2.61906159e+00
  2.61906159e+00  1.98027265e+01  1.98027265e+01  1.98027265e+01
  2.87096667e+01  1.67647171e+02  7.99608772e+02  4.57414559e+03]
E1 = -182.52350595206244  E_coul = 54.24390892919624
Extra cycle  E= -128.279597022866  delta_E= -1.99e-13  |g|= 3.67e-08  |ddm|= 4.04e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.43900760e+03 1.05808867e+02 4.21928057e+02 5.15934714e-01
 3.15036942e+01 1.02401669e+01 1.75518998e+00 2.77513245e+00
 1.33229647e+01 5.99947823e-01]
grad_E = [-1.09401255e-05 -2.35281751e-07 -3.17800460e-06 -3.19859424e-07
  8.97032167e-08 -4.12078877e-07  6.58493899e-08  3.87874873e-06
 -7.57951942e-07  5.45629561e-07]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.00788261        1
[INPUT] 0    0    [1    /1   ]  105.809378218        1
[INPUT] 0    0    [1    /1   ]  421.927212015        1
[INPUT] 0    0    [1    /1   ]  0.51593269013        1
[INPUT] 0    0    [1    /1   ]  31.5040066827        1
[INPUT] 0    0    [1    /1   ]  10.2402066452        1
[INPUT] 0    0    [1    /1   ]  1.75518330057        1
[INPUT] 1    0    [1    /1   ]  2.77512688383        1
[INPUT] 1    0    [1    /1   ]  13.3228680748        1
[INPUT] 1    0    [1    /1   ]  0.599947781334       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.007882607858, 1.0]], [0, [105.80937821790603, 1.0]], [0, [421.92721201526064, 1.0]], [0, [0.5159326901295492, 1.0]], [0, [31.504006682716376, 1.0]], [0, [10.240206645179821, 1.0]], [0, [1.7551833005686421, 1.0]], [1, [2.7751268838302763, 1.0]], [1, [13.322868074791703, 1.0]], [1, [0.5999477813339517, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.00788261]
bas 1, expnt(s) = [105.80937822]
bas 2, expnt(s) = [421.92721202]
bas 3, expnt(s) = [0.51593269]
bas 4, expnt(s) = [31.50400668]
bas 5, expnt(s) = [10.24020665]
bas 6, expnt(s) = [1.7551833]
bas 7, expnt(s) = [2.77512688]
bas 8, expnt(s) = [13.32286807]
bas 9, expnt(s) = [0.59994778]
CPU time:       339.57
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900788e+03 8.76849234e+02 1.05809378e+02 8.33504878e+01
 4.21927212e+02 2.35203173e+02 5.15932690e-01 1.53801230e+00
 3.15040067e+01 3.35961388e+01 1.02402066e+01 1.44626063e+01
 1.75518330e+00 3.85262628e+00 2.77512688e+00 1.04493181e+01
 1.33228681e+01 7.42560001e+01 5.99947781e-01 1.54037410e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900071827254
cond(S) = 77.2494685633371
E1 = -183.22908742146893  E_coul = 55.007867038286534
init E= -128.221220383182
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743020054332565  LUMO = 2.29782738788172
  mo_energy =
[-3.25525894e+01 -1.85682674e+00 -7.43020054e-01 -7.43020054e-01
 -7.43020054e-01  2.29782739e+00  2.65421938e+00  2.65421938e+00
  2.65421938e+00  1.99407185e+01  1.99407185e+01  1.99407185e+01
  2.88566148e+01  1.67859986e+02  7.99864266e+02  4.57443796e+03]
E1 = -182.18476291861055  E_coul = 53.90717657259745
cycle= 1 E= -128.277586346013  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269197
diis-c [-0.07246715  1.        ]
  HOMO = -0.810118380120237  LUMO = 2.25359040897238
  mo_energy =
[-3.28311590e+01 -1.92509599e+00 -8.10118380e-01 -8.10118380e-01
 -8.10118380e-01  2.25359041e+00  2.59815150e+00  2.59815150e+00
  2.59815150e+00  1.97457446e+01  1.97457446e+01  1.97457446e+01
  2.86507306e+01  1.67570509e+02  7.99524545e+02  4.57405621e+03]
E1 = -182.65791686133693  E_coul = 54.37863862638101
cycle= 2 E= -128.279278234956  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105705
diis-c [-2.21347130e-04  2.80241348e-01  7.19758652e-01]
  HOMO = -0.786867149185293  LUMO = 2.27114319755006
  mo_energy =
[-3.27550084e+01 -1.90104374e+00 -7.86867149e-01 -7.86867149e-01
 -7.86867149e-01  2.27114320e+00  2.61918325e+00  2.61918325e+00
  2.61918325e+00  1.98029634e+01  1.98029634e+01  1.98029634e+01
  2.87102404e+01  1.67648809e+02  7.99610817e+02  4.57414628e+03]
E1 = -182.52261532038318  E_coul = 54.243018312317666
cycle= 3 E= -128.279597008066  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695576
diis-c [-3.49932963e-08 -4.50239597e-03 -5.25008876e-03  1.00975248e+00]
  HOMO = -0.787052976801419  LUMO = 2.27100810658539
  mo_energy =
[-3.27554721e+01 -1.90125678e+00 -7.87052977e-01 -7.87052977e-01
 -7.87052977e-01  2.27100811e+00  2.61905355e+00  2.61905355e+00
  2.61905355e+00  1.98025935e+01  1.98025935e+01  1.98025935e+01
  2.87098191e+01  1.67648435e+02  7.99610590e+02  4.57414616e+03]
E1 = -182.52353764431618  E_coul = 54.24394062108199
cycle= 4 E= -128.279597023234  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73157e-05
diis-c [-1.38715789e-10  2.43873206e-04 -2.00428449e-04 -8.12127299e-02
  1.08116929e+00]
  HOMO = -0.787045857685971  LUMO = 2.27100981840091
  mo_energy =
[-3.27554540e+01 -1.90125378e+00 -7.87045858e-01 -7.87045858e-01
 -7.87045858e-01  2.27100982e+00  2.61905951e+00  2.61905951e+00
  2.61905951e+00  1.98026078e+01  1.98026078e+01  1.98026078e+01
  2.87098319e+01  1.67648456e+02  7.99610619e+02  4.57414619e+03]
E1 = -182.52350763468132  E_coul = 54.24391061139806
cycle= 5 E= -128.279597023283  delta_E= -4.91e-11  |g|= 1.8e-06  |ddm|= 8.77e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350763468132  E_coul = 54.24391061139806
  HOMO = -0.787045446638092  LUMO = 2.27100978050098
  mo_energy =
[-3.27554531e+01 -1.90125381e+00 -7.87045447e-01 -7.87045447e-01
 -7.87045447e-01  2.27100978e+00  2.61905988e+00  2.61905988e+00
  2.61905988e+00  1.98026086e+01  1.98026086e+01  1.98026086e+01
  2.87098325e+01  1.67648457e+02  7.99610620e+02  4.57414619e+03]
E1 = -182.5235061453568  E_coul = 54.24390912207315
Extra cycle  E= -128.279597023284  delta_E= -3.98e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43900788e+03 1.05809378e+02 4.21927212e+02 5.15932690e-01
 3.15040067e+01 1.02402066e+01 1.75518330e+00 2.77512688e+00
 1.33228681e+01 5.99947781e-01]
E = -128.27959702328366
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.00788261        1
[INPUT] 0    0    [1    /1   ]  105.809378218        1
[INPUT] 0    0    [1    /1   ]  421.927212015        1
[INPUT] 0    0    [1    /1   ]  0.51593269013        1
[INPUT] 0    0    [1    /1   ]  31.5040066827        1
[INPUT] 0    0    [1    /1   ]  10.2402066452        1
[INPUT] 0    0    [1    /1   ]  1.75518330057        1
[INPUT] 1    0    [1    /1   ]  2.77512688383        1
[INPUT] 1    0    [1    /1   ]  13.3228680748        1
[INPUT] 1    0    [1    /1   ]  0.599947781334       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.007882607858, 1.0]], [0, [105.80937821790603, 1.0]], [0, [421.92721201526064, 1.0]], [0, [0.5159326901295492, 1.0]], [0, [31.504006682716376, 1.0]], [0, [10.240206645179821, 1.0]], [0, [1.7551833005686421, 1.0]], [1, [2.7751268838302763, 1.0]], [1, [13.322868074791703, 1.0]], [1, [0.5999477813339517, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.00788261]
bas 1, expnt(s) = [105.80937822]
bas 2, expnt(s) = [421.92721202]
bas 3, expnt(s) = [0.51593269]
bas 4, expnt(s) = [31.50400668]
bas 5, expnt(s) = [10.24020665]
bas 6, expnt(s) = [1.7551833]
bas 7, expnt(s) = [2.77512688]
bas 8, expnt(s) = [13.32286807]
bas 9, expnt(s) = [0.59994778]
CPU time:       340.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900788e+03 8.76849234e+02 1.05809378e+02 8.33504878e+01
 4.21927212e+02 2.35203173e+02 5.15932690e-01 1.53801230e+00
 3.15040067e+01 3.35961388e+01 1.02402066e+01 1.44626063e+01
 1.75518330e+00 3.85262628e+00 2.77512688e+00 1.04493181e+01
 1.33228681e+01 7.42560001e+01 5.99947781e-01 1.54037410e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900071827254
cond(S) = 77.2494685633371
E1 = -183.22908742146893  E_coul = 55.007867038286534
init E= -128.221220383182
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743020054332565  LUMO = 2.29782738788172
  mo_energy =
[-3.25525894e+01 -1.85682674e+00 -7.43020054e-01 -7.43020054e-01
 -7.43020054e-01  2.29782739e+00  2.65421938e+00  2.65421938e+00
  2.65421938e+00  1.99407185e+01  1.99407185e+01  1.99407185e+01
  2.88566148e+01  1.67859986e+02  7.99864266e+02  4.57443796e+03]
E1 = -182.18476291861055  E_coul = 53.90717657259745
cycle= 1 E= -128.277586346013  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269197
diis-c [-0.07246715  1.        ]
  HOMO = -0.810118380120237  LUMO = 2.25359040897238
  mo_energy =
[-3.28311590e+01 -1.92509599e+00 -8.10118380e-01 -8.10118380e-01
 -8.10118380e-01  2.25359041e+00  2.59815150e+00  2.59815150e+00
  2.59815150e+00  1.97457446e+01  1.97457446e+01  1.97457446e+01
  2.86507306e+01  1.67570509e+02  7.99524545e+02  4.57405621e+03]
E1 = -182.65791686133693  E_coul = 54.37863862638101
cycle= 2 E= -128.279278234956  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105705
diis-c [-2.21347130e-04  2.80241348e-01  7.19758652e-01]
  HOMO = -0.786867149185293  LUMO = 2.27114319755006
  mo_energy =
[-3.27550084e+01 -1.90104374e+00 -7.86867149e-01 -7.86867149e-01
 -7.86867149e-01  2.27114320e+00  2.61918325e+00  2.61918325e+00
  2.61918325e+00  1.98029634e+01  1.98029634e+01  1.98029634e+01
  2.87102404e+01  1.67648809e+02  7.99610817e+02  4.57414628e+03]
E1 = -182.52261532038318  E_coul = 54.243018312317666
cycle= 3 E= -128.279597008066  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695576
diis-c [-3.49932963e-08 -4.50239597e-03 -5.25008876e-03  1.00975248e+00]
  HOMO = -0.787052976801419  LUMO = 2.27100810658539
  mo_energy =
[-3.27554721e+01 -1.90125678e+00 -7.87052977e-01 -7.87052977e-01
 -7.87052977e-01  2.27100811e+00  2.61905355e+00  2.61905355e+00
  2.61905355e+00  1.98025935e+01  1.98025935e+01  1.98025935e+01
  2.87098191e+01  1.67648435e+02  7.99610590e+02  4.57414616e+03]
E1 = -182.52353764431618  E_coul = 54.24394062108199
cycle= 4 E= -128.279597023234  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73157e-05
diis-c [-1.38715789e-10  2.43873206e-04 -2.00428449e-04 -8.12127299e-02
  1.08116929e+00]
  HOMO = -0.787045857685971  LUMO = 2.27100981840091
  mo_energy =
[-3.27554540e+01 -1.90125378e+00 -7.87045858e-01 -7.87045858e-01
 -7.87045858e-01  2.27100982e+00  2.61905951e+00  2.61905951e+00
  2.61905951e+00  1.98026078e+01  1.98026078e+01  1.98026078e+01
  2.87098319e+01  1.67648456e+02  7.99610619e+02  4.57414619e+03]
E1 = -182.52350763468132  E_coul = 54.24391061139806
cycle= 5 E= -128.279597023283  delta_E= -4.91e-11  |g|= 1.8e-06  |ddm|= 8.77e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350763468132  E_coul = 54.24391061139806
  HOMO = -0.787045446638092  LUMO = 2.27100978050098
  mo_energy =
[-3.27554531e+01 -1.90125381e+00 -7.87045447e-01 -7.87045447e-01
 -7.87045447e-01  2.27100978e+00  2.61905988e+00  2.61905988e+00
  2.61905988e+00  1.98026086e+01  1.98026086e+01  1.98026086e+01
  2.87098325e+01  1.67648457e+02  7.99610620e+02  4.57414619e+03]
E1 = -182.5235061453568  E_coul = 54.24390912207315
Extra cycle  E= -128.279597023284  delta_E= -3.98e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.2494685633371
E1 = -182.5235061453568  E_coul = 54.24390912207315
init E= -128.279597023284
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787045527225232  LUMO = 2.27100965140301
  mo_energy =
[-3.27554534e+01 -1.90125398e+00 -7.87045527e-01 -7.87045527e-01
 -7.87045527e-01  2.27100965e+00  2.61905980e+00  2.61905980e+00
  2.61905980e+00  1.98026083e+01  1.98026083e+01  1.98026083e+01
  2.87098322e+01  1.67648457e+02  7.99610620e+02  4.57414619e+03]
E1 = -182.52350678689982  E_coul = 54.24390976361602
cycle= 1 E= -128.279597023284  delta_E= -1.42e-13  |g|= 1.02e-07  |ddm|= 2.43e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52350678689982  E_coul = 54.24390976361602
  HOMO = -0.787045479232707  LUMO = 2.27100967491234
  mo_energy =
[-3.27554532e+01 -1.90125394e+00 -7.87045479e-01 -7.87045479e-01
 -7.87045479e-01  2.27100967e+00  2.61905985e+00  2.61905985e+00
  2.61905985e+00  1.98026084e+01  1.98026084e+01  1.98026084e+01
  2.87098323e+01  1.67648457e+02  7.99610620e+02  4.57414619e+03]
E1 = -182.5235065403756  E_coul = 54.24390951709197
Extra cycle  E= -128.279597023284  delta_E= 1.71e-13  |g|= 3.67e-08  |ddm|= 4.04e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.43900788e+03 1.05809378e+02 4.21927212e+02 5.15932690e-01
 3.15040067e+01 1.02402066e+01 1.75518330e+00 2.77512688e+00
 1.33228681e+01 5.99947781e-01]
grad_E = [-1.09397608e-05 -3.03374243e-07 -3.18152947e-06 -8.73457957e-07
  6.81041199e-07 -1.55091823e-06 -2.53980504e-07  6.84409336e-06
 -1.62999539e-06  3.89716789e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.00824866        1
[INPUT] 0    0    [1    /1   ]  105.809849104        1
[INPUT] 0    0    [1    /1   ]  421.926259169        1
[INPUT] 0    0    [1    /1   ]  0.5159307363         1
[INPUT] 0    0    [1    /1   ]  31.5043192251        1
[INPUT] 0    0    [1    /1   ]  10.2402472968        1
[INPUT] 0    0    [1    /1   ]  1.75517643364        1
[INPUT] 1    0    [1    /1   ]  2.77512023018        1
[INPUT] 1    0    [1    /1   ]  13.3227666946        1
[INPUT] 1    0    [1    /1   ]  0.599947581329       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.008248664145, 1.0]], [0, [105.80984910405596, 1.0]], [0, [421.92625916880087, 1.0]], [0, [0.5159307363004823, 1.0]], [0, [31.504319225094232, 1.0]], [0, [10.240247296776609, 1.0]], [0, [1.7551764336440767, 1.0]], [1, [2.7751202301811233, 1.0]], [1, [13.322766694552671, 1.0]], [1, [0.5999475813287908, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.00824866]
bas 1, expnt(s) = [105.8098491]
bas 2, expnt(s) = [421.92625917]
bas 3, expnt(s) = [0.51593074]
bas 4, expnt(s) = [31.50431923]
bas 5, expnt(s) = [10.2402473]
bas 6, expnt(s) = [1.75517643]
bas 7, expnt(s) = [2.77512023]
bas 8, expnt(s) = [13.32276669]
bas 9, expnt(s) = [0.59994758]
CPU time:       344.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900825e+03 8.76849333e+02 1.05809849e+02 8.33507660e+01
 4.21926259e+02 2.35202775e+02 5.15930736e-01 1.53800793e+00
 3.15043192e+01 3.35963888e+01 1.02402473e+01 1.44626494e+01
 1.75517643e+00 3.85261498e+00 2.77512023e+00 1.04492867e+01
 1.33227667e+01 7.42552938e+01 5.99947581e-01 1.54037346e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900156572018
cond(S) = 77.24945355267458
E1 = -183.2290878805257  E_coul = 55.007867140910456
init E= -128.221220739615
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743019961195476  LUMO = 2.29781394780437
  mo_energy =
[-3.25525897e+01 -1.85682666e+00 -7.43019961e-01 -7.43019961e-01
 -7.43019961e-01  2.29781395e+00  2.65421656e+00  2.65421656e+00
  2.65421656e+00  1.99405911e+01  1.99405911e+01  1.99405911e+01
  2.88567820e+01  1.67861244e+02  7.99865891e+02  4.57443818e+03]
E1 = -182.18476289462  E_coul = 53.907176548608874
cycle= 1 E= -128.277586346011  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269198
diis-c [-0.07246734  1.        ]
  HOMO = -0.810118348356922  LUMO = 2.25357720979883
  mo_energy =
[-3.28311592e+01 -1.92509589e+00 -8.10118348e-01 -8.10118348e-01
 -8.10118348e-01  2.25357721e+00  2.59814872e+00  2.59814872e+00
  2.59814872e+00  1.97456178e+01  1.97456178e+01  1.97456178e+01
  2.86508973e+01  1.67571768e+02  7.99526171e+02  4.57405644e+03]
E1 = -182.6579171360835  E_coul = 54.37863890084066
cycle= 2 E= -128.279278235243  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105705
diis-c [-2.21346453e-04  2.80241285e-01  7.19758715e-01]
  HOMO = -0.786867096534803  LUMO = 2.2711299489386
  mo_energy =
[-3.27550086e+01 -1.90104362e+00 -7.86867097e-01 -7.86867097e-01
 -7.86867097e-01  2.27112995e+00  2.61918046e+00  2.61918046e+00
  2.61918046e+00  1.98028364e+01  1.98028364e+01  1.98028364e+01
  2.87104072e+01  1.67650067e+02  7.99612443e+02  4.57414651e+03]
E1 = -182.5226154318137  E_coul = 54.24301842299706
cycle= 3 E= -128.279597008817  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695598
diis-c [-3.49868628e-08 -4.50218427e-03 -5.24925977e-03  1.00975144e+00]
  HOMO = -0.787052929868109  LUMO = 2.27099485794141
  mo_energy =
[-3.27554723e+01 -1.90125666e+00 -7.87052930e-01 -7.87052930e-01
 -7.87052930e-01  2.27099486e+00  2.61905075e+00  2.61905075e+00
  2.61905075e+00  1.98024665e+01  1.98024665e+01  1.98024665e+01
  2.87099859e+01  1.67649694e+02  7.99612216e+02  4.57414638e+03]
E1 = -182.52353778156507  E_coul = 54.243940757579196
cycle= 4 E= -128.279597023986  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73103e-05
diis-c [-1.38673376e-10  2.43835448e-04 -2.00447807e-04 -8.12038605e-02
  1.08116047e+00]
  HOMO = -0.787045811753218  LUMO = 2.27099656971081
  mo_energy =
[-3.27554542e+01 -1.90125366e+00 -7.87045812e-01 -7.87045812e-01
 -7.87045812e-01  2.27099657e+00  2.61905671e+00  2.61905671e+00
  2.61905671e+00  1.98024809e+01  1.98024809e+01  1.98024809e+01
  2.87099987e+01  1.67649715e+02  7.99612245e+02  4.57414641e+03]
E1 = -182.52350777578357  E_coul = 54.24391075174868
cycle= 5 E= -128.279597024035  delta_E= -4.9e-11  |g|= 1.8e-06  |ddm|= 8.77e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350777578357  E_coul = 54.24391075174868
  HOMO = -0.787045400727396  LUMO = 2.27099653184094
  mo_energy =
[-3.27554532e+01 -1.90125369e+00 -7.87045401e-01 -7.87045401e-01
 -7.87045401e-01  2.27099653e+00  2.61905708e+00  2.61905708e+00
  2.61905708e+00  1.98024816e+01  1.98024816e+01  1.98024816e+01
  2.87099993e+01  1.67649716e+02  7.99612246e+02  4.57414642e+03]
E1 = -182.52350628649012  E_coul = 54.24390926245491
Extra cycle  E= -128.279597024035  delta_E= -3.13e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43900825e+03 1.05809849e+02 4.21926259e+02 5.15930736e-01
 3.15043192e+01 1.02402473e+01 1.75517643e+00 2.77512023e+00
 1.33227667e+01 5.99947581e-01]
E = -128.2795970240352
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.00824866        1
[INPUT] 0    0    [1    /1   ]  105.809849104        1
[INPUT] 0    0    [1    /1   ]  421.926259169        1
[INPUT] 0    0    [1    /1   ]  0.5159307363         1
[INPUT] 0    0    [1    /1   ]  31.5043192251        1
[INPUT] 0    0    [1    /1   ]  10.2402472968        1
[INPUT] 0    0    [1    /1   ]  1.75517643364        1
[INPUT] 1    0    [1    /1   ]  2.77512023018        1
[INPUT] 1    0    [1    /1   ]  13.3227666946        1
[INPUT] 1    0    [1    /1   ]  0.599947581329       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.008248664145, 1.0]], [0, [105.80984910405596, 1.0]], [0, [421.92625916880087, 1.0]], [0, [0.5159307363004823, 1.0]], [0, [31.504319225094232, 1.0]], [0, [10.240247296776609, 1.0]], [0, [1.7551764336440767, 1.0]], [1, [2.7751202301811233, 1.0]], [1, [13.322766694552671, 1.0]], [1, [0.5999475813287908, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.00824866]
bas 1, expnt(s) = [105.8098491]
bas 2, expnt(s) = [421.92625917]
bas 3, expnt(s) = [0.51593074]
bas 4, expnt(s) = [31.50431923]
bas 5, expnt(s) = [10.2402473]
bas 6, expnt(s) = [1.75517643]
bas 7, expnt(s) = [2.77512023]
bas 8, expnt(s) = [13.32276669]
bas 9, expnt(s) = [0.59994758]
CPU time:       345.56
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900825e+03 8.76849333e+02 1.05809849e+02 8.33507660e+01
 4.21926259e+02 2.35202775e+02 5.15930736e-01 1.53800793e+00
 3.15043192e+01 3.35963888e+01 1.02402473e+01 1.44626494e+01
 1.75517643e+00 3.85261498e+00 2.77512023e+00 1.04492867e+01
 1.33227667e+01 7.42552938e+01 5.99947581e-01 1.54037346e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900156572018
cond(S) = 77.24945355267458
E1 = -183.2290878805257  E_coul = 55.007867140910456
init E= -128.221220739615
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743019961195476  LUMO = 2.29781394780437
  mo_energy =
[-3.25525897e+01 -1.85682666e+00 -7.43019961e-01 -7.43019961e-01
 -7.43019961e-01  2.29781395e+00  2.65421656e+00  2.65421656e+00
  2.65421656e+00  1.99405911e+01  1.99405911e+01  1.99405911e+01
  2.88567820e+01  1.67861244e+02  7.99865891e+02  4.57443818e+03]
E1 = -182.18476289462  E_coul = 53.907176548608874
cycle= 1 E= -128.277586346011  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269198
diis-c [-0.07246734  1.        ]
  HOMO = -0.810118348356922  LUMO = 2.25357720979883
  mo_energy =
[-3.28311592e+01 -1.92509589e+00 -8.10118348e-01 -8.10118348e-01
 -8.10118348e-01  2.25357721e+00  2.59814872e+00  2.59814872e+00
  2.59814872e+00  1.97456178e+01  1.97456178e+01  1.97456178e+01
  2.86508973e+01  1.67571768e+02  7.99526171e+02  4.57405644e+03]
E1 = -182.6579171360835  E_coul = 54.37863890084066
cycle= 2 E= -128.279278235243  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105705
diis-c [-2.21346453e-04  2.80241285e-01  7.19758715e-01]
  HOMO = -0.786867096534803  LUMO = 2.2711299489386
  mo_energy =
[-3.27550086e+01 -1.90104362e+00 -7.86867097e-01 -7.86867097e-01
 -7.86867097e-01  2.27112995e+00  2.61918046e+00  2.61918046e+00
  2.61918046e+00  1.98028364e+01  1.98028364e+01  1.98028364e+01
  2.87104072e+01  1.67650067e+02  7.99612443e+02  4.57414651e+03]
E1 = -182.5226154318137  E_coul = 54.24301842299706
cycle= 3 E= -128.279597008817  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695598
diis-c [-3.49868628e-08 -4.50218427e-03 -5.24925977e-03  1.00975144e+00]
  HOMO = -0.787052929868109  LUMO = 2.27099485794141
  mo_energy =
[-3.27554723e+01 -1.90125666e+00 -7.87052930e-01 -7.87052930e-01
 -7.87052930e-01  2.27099486e+00  2.61905075e+00  2.61905075e+00
  2.61905075e+00  1.98024665e+01  1.98024665e+01  1.98024665e+01
  2.87099859e+01  1.67649694e+02  7.99612216e+02  4.57414638e+03]
E1 = -182.52353778156507  E_coul = 54.243940757579196
cycle= 4 E= -128.279597023986  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73103e-05
diis-c [-1.38673376e-10  2.43835448e-04 -2.00447807e-04 -8.12038605e-02
  1.08116047e+00]
  HOMO = -0.787045811753218  LUMO = 2.27099656971081
  mo_energy =
[-3.27554542e+01 -1.90125366e+00 -7.87045812e-01 -7.87045812e-01
 -7.87045812e-01  2.27099657e+00  2.61905671e+00  2.61905671e+00
  2.61905671e+00  1.98024809e+01  1.98024809e+01  1.98024809e+01
  2.87099987e+01  1.67649715e+02  7.99612245e+02  4.57414641e+03]
E1 = -182.52350777578357  E_coul = 54.24391075174868
cycle= 5 E= -128.279597024035  delta_E= -4.9e-11  |g|= 1.8e-06  |ddm|= 8.77e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350777578357  E_coul = 54.24391075174868
  HOMO = -0.787045400727396  LUMO = 2.27099653184094
  mo_energy =
[-3.27554532e+01 -1.90125369e+00 -7.87045401e-01 -7.87045401e-01
 -7.87045401e-01  2.27099653e+00  2.61905708e+00  2.61905708e+00
  2.61905708e+00  1.98024816e+01  1.98024816e+01  1.98024816e+01
  2.87099993e+01  1.67649716e+02  7.99612246e+02  4.57414642e+03]
E1 = -182.52350628649012  E_coul = 54.24390926245491
Extra cycle  E= -128.279597024035  delta_E= -3.13e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24945355267458
E1 = -182.52350628649012  E_coul = 54.24390926245491
init E= -128.279597024035
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787045481315201  LUMO = 2.27099640275203
  mo_energy =
[-3.27554536e+01 -1.90125386e+00 -7.87045481e-01 -7.87045481e-01
 -7.87045481e-01  2.27099640e+00  2.61905701e+00  2.61905701e+00
  2.61905701e+00  1.98024813e+01  1.98024813e+01  1.98024813e+01
  2.87099990e+01  1.67649716e+02  7.99612246e+02  4.57414642e+03]
E1 = -182.52350692801642  E_coul = 54.243909903980956
cycle= 1 E= -128.279597024035  delta_E= -2.56e-13  |g|= 1.02e-07  |ddm|= 2.43e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52350692801642  E_coul = 54.243909903980956
  HOMO = -0.787045433324356  LUMO = 2.27099642626173
  mo_energy =
[-3.27554534e+01 -1.90125382e+00 -7.87045433e-01 -7.87045433e-01
 -7.87045433e-01  2.27099643e+00  2.61905705e+00  2.61905705e+00
  2.61905705e+00  1.98024815e+01  1.98024815e+01  1.98024815e+01
  2.87099991e+01  1.67649716e+02  7.99612246e+02  4.57414642e+03]
E1 = -182.52350668149745  E_coul = 54.243909657462304
Extra cycle  E= -128.279597024035  delta_E= 3.13e-13  |g|= 3.67e-08  |ddm|= 4.04e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43900825e+03 1.05809849e+02 4.21926259e+02 5.15930736e-01
 3.15043192e+01 1.02402473e+01 1.75517643e+00 2.77512023e+00
 1.33227667e+01 5.99947581e-01]
grad_E = [-1.09393915e-05 -3.77815750e-07 -3.18457548e-06 -1.16260715e-06
  1.29342164e-06 -2.71027924e-06 -6.48679785e-07  9.55104348e-06
 -2.49175086e-06  7.55979473e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.00874467        1
[INPUT] 0    0    [1    /1   ]  105.810384145        1
[INPUT] 0    0    [1    /1   ]  421.925145316        1
[INPUT] 0    0    [1    /1   ]  0.51592853443        1
[INPUT] 0    0    [1    /1   ]  31.5046804309        1
[INPUT] 0    0    [1    /1   ]  10.2402946499        1
[INPUT] 0    0    [1    /1   ]  1.75516852057        1
[INPUT] 1    0    [1    /1   ]  2.77511219489        1
[INPUT] 1    0    [1    /1   ]  13.3226482089        1
[INPUT] 1    0    [1    /1   ]  0.599947297598       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0087446728166, 1.0]], [0, [105.81038414521268, 1.0]], [0, [421.92514531617053, 1.0]], [0, [0.5159285344296715, 1.0]], [0, [31.504680430925884, 1.0]], [0, [10.240294649900134, 1.0]], [0, [1.7551685205696195, 1.0]], [1, [2.775112194893349, 1.0]], [1, [13.322648208898988, 1.0]], [1, [0.5999472975978297, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.00874467]
bas 1, expnt(s) = [105.81038415]
bas 2, expnt(s) = [421.92514532]
bas 3, expnt(s) = [0.51592853]
bas 4, expnt(s) = [31.50468043]
bas 5, expnt(s) = [10.24029465]
bas 6, expnt(s) = [1.75516852]
bas 7, expnt(s) = [2.77511219]
bas 8, expnt(s) = [13.32264821]
bas 9, expnt(s) = [0.5999473]
CPU time:       348.66
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900874e+03 8.76849467e+02 1.05810384e+02 8.33510821e+01
 4.21925145e+02 2.35202309e+02 5.15928534e-01 1.53800301e+00
 3.15046804e+01 3.35966777e+01 1.02402946e+01 1.44626995e+01
 1.75516852e+00 3.85260195e+00 2.77511219e+00 1.04492489e+01
 1.33226482e+01 7.42544683e+01 5.99947298e-01 1.54037255e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900265114184
cond(S) = 77.24944705648628
E1 = -183.22908840756483  E_coul = 55.007867249420926
init E= -128.221221158144
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74301985379473  LUMO = 2.29779864517803
  mo_energy =
[-3.25525901e+01 -1.85682657e+00 -7.43019854e-01 -7.43019854e-01
 -7.43019854e-01  2.29779865e+00  2.65421296e+00  2.65421296e+00
  2.65421296e+00  1.99404412e+01  1.99404412e+01  1.99404412e+01
  2.88569764e+01  1.67862693e+02  7.99867733e+02  4.57443846e+03]
E1 = -182.18476266914666  E_coul = 53.907176323247114
cycle= 1 E= -128.2775863459  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269198
diis-c [-0.07246757  1.        ]
  HOMO = -0.810118323191835  LUMO = 2.25356216756697
  mo_energy =
[-3.28311595e+01 -1.92509579e+00 -8.10118323e-01 -8.10118323e-01
 -8.10118323e-01  2.25356217e+00  2.59814515e+00  2.59814515e+00
  2.59814515e+00  1.97454686e+01  1.97454686e+01  1.97454686e+01
  2.86510909e+01  1.67573217e+02  7.99528013e+02  4.57405672e+03]
E1 = -182.65791734474217  E_coul = 54.378639108761014
cycle= 2 E= -128.279278235981  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105705
diis-c [-2.21345746e-04  2.80241228e-01  7.19758772e-01]
  HOMO = -0.78686704312843  LUMO = 2.27111485365064
  mo_energy =
[-3.27550088e+01 -1.90104349e+00 -7.86867043e-01 -7.86867043e-01
 -7.86867043e-01  2.27111485e+00  2.61917689e+00  2.61917689e+00
  2.61917689e+00  1.98026871e+01  1.98026871e+01  1.98026871e+01
  2.87106011e+01  1.67651516e+02  7.99614285e+02  4.57414679e+03]
E1 = -182.5226154259412  E_coul = 54.24301841573036
cycle= 3 E= -128.279597010211  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695621
diis-c [-3.49797223e-08 -4.50194557e-03 -5.24833370e-03  1.00975028e+00]
  HOMO = -0.787052882687626  LUMO = 2.27097976267731
  mo_energy =
[-3.27554725e+01 -1.90125653e+00 -7.87052883e-01 -7.87052883e-01
 -7.87052883e-01  2.27097976e+00  2.61904717e+00  2.61904717e+00
  2.61904717e+00  1.98023171e+01  1.98023171e+01  1.98023171e+01
  2.87101798e+01  1.67651143e+02  7.99614058e+02  4.57414666e+03]
E1 = -182.52353780407367  E_coul = 54.24394077869292
cycle= 4 E= -128.279597025381  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73043e-05
diis-c [-1.38626945e-10  2.43794373e-04 -2.00468949e-04 -8.11943112e-02
  1.08115099e+00]
  HOMO = -0.787045765677348  LUMO = 2.27098147438644
  mo_energy =
[-3.27554545e+01 -1.90125353e+00 -7.87045766e-01 -7.87045766e-01
 -7.87045766e-01  2.27098147e+00  2.61905312e+00  2.61905312e+00
  2.61905312e+00  1.98023315e+01  1.98023315e+01  1.98023315e+01
  2.87101925e+01  1.67651164e+02  7.99614087e+02  4.57414670e+03]
E1 = -182.52350780256563  E_coul = 54.24391077713597
cycle= 5 E= -128.27959702543  delta_E= -4.89e-11  |g|= 1.8e-06  |ddm|= 8.76e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350780256563  E_coul = 54.24391077713597
  HOMO = -0.787045354675451  LUMO = 2.27098143654946
  mo_energy =
[-3.27554535e+01 -1.90125356e+00 -7.87045355e-01 -7.87045355e-01
 -7.87045355e-01  2.27098144e+00  2.61905350e+00  2.61905350e+00
  2.61905350e+00  1.98023322e+01  1.98023322e+01  1.98023322e+01
  2.87101932e+01  1.67651165e+02  7.99614088e+02  4.57414670e+03]
E1 = -182.52350631330523  E_coul = 54.243909287875034
Extra cycle  E= -128.27959702543  delta_E= -5.4e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
exp = [2.43900874e+03 1.05810384e+02 4.21925145e+02 5.15928534e-01
 3.15046804e+01 1.02402946e+01 1.75516852e+00 2.77511219e+00
 1.33226482e+01 5.99947298e-01]
E = -128.2795970254302
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.00874467        1
[INPUT] 0    0    [1    /1   ]  105.810384145        1
[INPUT] 0    0    [1    /1   ]  421.925145316        1
[INPUT] 0    0    [1    /1   ]  0.51592853443        1
[INPUT] 0    0    [1    /1   ]  31.5046804309        1
[INPUT] 0    0    [1    /1   ]  10.2402946499        1
[INPUT] 0    0    [1    /1   ]  1.75516852057        1
[INPUT] 1    0    [1    /1   ]  2.77511219489        1
[INPUT] 1    0    [1    /1   ]  13.3226482089        1
[INPUT] 1    0    [1    /1   ]  0.599947297598       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0087446728166, 1.0]], [0, [105.81038414521268, 1.0]], [0, [421.92514531617053, 1.0]], [0, [0.5159285344296715, 1.0]], [0, [31.504680430925884, 1.0]], [0, [10.240294649900134, 1.0]], [0, [1.7551685205696195, 1.0]], [1, [2.775112194893349, 1.0]], [1, [13.322648208898988, 1.0]], [1, [0.5999472975978297, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.00874467]
bas 1, expnt(s) = [105.81038415]
bas 2, expnt(s) = [421.92514532]
bas 3, expnt(s) = [0.51592853]
bas 4, expnt(s) = [31.50468043]
bas 5, expnt(s) = [10.24029465]
bas 6, expnt(s) = [1.75516852]
bas 7, expnt(s) = [2.77511219]
bas 8, expnt(s) = [13.32264821]
bas 9, expnt(s) = [0.5999473]
CPU time:       349.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900874e+03 8.76849467e+02 1.05810384e+02 8.33510821e+01
 4.21925145e+02 2.35202309e+02 5.15928534e-01 1.53800301e+00
 3.15046804e+01 3.35966777e+01 1.02402946e+01 1.44626995e+01
 1.75516852e+00 3.85260195e+00 2.77511219e+00 1.04492489e+01
 1.33226482e+01 7.42544683e+01 5.99947298e-01 1.54037255e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900265114184
cond(S) = 77.24944705648628
E1 = -183.22908840756483  E_coul = 55.007867249420926
init E= -128.221221158144
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74301985379473  LUMO = 2.29779864517803
  mo_energy =
[-3.25525901e+01 -1.85682657e+00 -7.43019854e-01 -7.43019854e-01
 -7.43019854e-01  2.29779865e+00  2.65421296e+00  2.65421296e+00
  2.65421296e+00  1.99404412e+01  1.99404412e+01  1.99404412e+01
  2.88569764e+01  1.67862693e+02  7.99867733e+02  4.57443846e+03]
E1 = -182.18476266914666  E_coul = 53.907176323247114
cycle= 1 E= -128.2775863459  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269198
diis-c [-0.07246757  1.        ]
  HOMO = -0.810118323191835  LUMO = 2.25356216756697
  mo_energy =
[-3.28311595e+01 -1.92509579e+00 -8.10118323e-01 -8.10118323e-01
 -8.10118323e-01  2.25356217e+00  2.59814515e+00  2.59814515e+00
  2.59814515e+00  1.97454686e+01  1.97454686e+01  1.97454686e+01
  2.86510909e+01  1.67573217e+02  7.99528013e+02  4.57405672e+03]
E1 = -182.65791734474217  E_coul = 54.378639108761014
cycle= 2 E= -128.279278235981  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105705
diis-c [-2.21345746e-04  2.80241228e-01  7.19758772e-01]
  HOMO = -0.78686704312843  LUMO = 2.27111485365064
  mo_energy =
[-3.27550088e+01 -1.90104349e+00 -7.86867043e-01 -7.86867043e-01
 -7.86867043e-01  2.27111485e+00  2.61917689e+00  2.61917689e+00
  2.61917689e+00  1.98026871e+01  1.98026871e+01  1.98026871e+01
  2.87106011e+01  1.67651516e+02  7.99614285e+02  4.57414679e+03]
E1 = -182.5226154259412  E_coul = 54.24301841573036
cycle= 3 E= -128.279597010211  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695621
diis-c [-3.49797223e-08 -4.50194557e-03 -5.24833370e-03  1.00975028e+00]
  HOMO = -0.787052882687626  LUMO = 2.27097976267731
  mo_energy =
[-3.27554725e+01 -1.90125653e+00 -7.87052883e-01 -7.87052883e-01
 -7.87052883e-01  2.27097976e+00  2.61904717e+00  2.61904717e+00
  2.61904717e+00  1.98023171e+01  1.98023171e+01  1.98023171e+01
  2.87101798e+01  1.67651143e+02  7.99614058e+02  4.57414666e+03]
E1 = -182.52353780407367  E_coul = 54.24394077869292
cycle= 4 E= -128.279597025381  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.73043e-05
diis-c [-1.38626945e-10  2.43794373e-04 -2.00468949e-04 -8.11943112e-02
  1.08115099e+00]
  HOMO = -0.787045765677348  LUMO = 2.27098147438644
  mo_energy =
[-3.27554545e+01 -1.90125353e+00 -7.87045766e-01 -7.87045766e-01
 -7.87045766e-01  2.27098147e+00  2.61905312e+00  2.61905312e+00
  2.61905312e+00  1.98023315e+01  1.98023315e+01  1.98023315e+01
  2.87101925e+01  1.67651164e+02  7.99614087e+02  4.57414670e+03]
E1 = -182.52350780256563  E_coul = 54.24391077713597
cycle= 5 E= -128.27959702543  delta_E= -4.89e-11  |g|= 1.8e-06  |ddm|= 8.76e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350780256563  E_coul = 54.24391077713597
  HOMO = -0.787045354675451  LUMO = 2.27098143654946
  mo_energy =
[-3.27554535e+01 -1.90125356e+00 -7.87045355e-01 -7.87045355e-01
 -7.87045355e-01  2.27098144e+00  2.61905350e+00  2.61905350e+00
  2.61905350e+00  1.98023322e+01  1.98023322e+01  1.98023322e+01
  2.87101932e+01  1.67651165e+02  7.99614088e+02  4.57414670e+03]
E1 = -182.52350631330523  E_coul = 54.243909287875034
Extra cycle  E= -128.27959702543  delta_E= -5.4e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24944705648628
E1 = -182.52350631330523  E_coul = 54.243909287875034
init E= -128.27959702543
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.78704543526409  LUMO = 2.27098130747064
  mo_energy =
[-3.27554538e+01 -1.90125373e+00 -7.87045435e-01 -7.87045435e-01
 -7.87045435e-01  2.27098131e+00  2.61905342e+00  2.61905342e+00
  2.61905342e+00  1.98023320e+01  1.98023320e+01  1.98023320e+01
  2.87101929e+01  1.67651165e+02  7.99614088e+02  4.57414670e+03]
E1 = -182.52350695481277  E_coul = 54.243909929382504
cycle= 1 E= -128.27959702543  delta_E= -5.68e-14  |g|= 1.02e-07  |ddm|= 2.43e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52350695481277  E_coul = 54.243909929382504
  HOMO = -0.787045387275081  LUMO = 2.27098133098068
  mo_energy =
[-3.27554537e+01 -1.90125369e+00 -7.87045387e-01 -7.87045387e-01
 -7.87045387e-01  2.27098133e+00  2.61905347e+00  2.61905347e+00
  2.61905347e+00  1.98023321e+01  1.98023321e+01  1.98023321e+01
  2.87101930e+01  1.67651165e+02  7.99614088e+02  4.57414670e+03]
E1 = -182.52350670830037  E_coul = 54.24390968287031
Extra cycle  E= -128.27959702543  delta_E= 1.99e-13  |g|= 3.67e-08  |ddm|= 4.04e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.43900874e+03 1.05810384e+02 4.21925145e+02 5.15928534e-01
 3.15046804e+01 1.02402946e+01 1.75516852e+00 2.77511219e+00
 1.33226482e+01 5.99947298e-01]
grad_E = [-1.09389654e-05 -4.65462785e-07 -3.18793456e-06 -1.38361148e-06
  2.00545141e-06 -4.05264089e-06 -1.13049133e-06  1.25854781e-05
 -3.48182127e-06  1.18844279e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.00949235        1
[INPUT] 0    0    [1    /1   ]  105.811077339        1
[INPUT] 0    0    [1    /1   ]  421.923709193        1
[INPUT] 0    0    [1    /1   ]  0.515925705046       1
[INPUT] 0    0    [1    /1   ]  31.5051492925        1
[INPUT] 0    0    [1    /1   ]  10.240356279         1
[INPUT] 0    0    [1    /1   ]  1.75515828017        1
[INPUT] 1    0    [1    /1   ]  2.77510165767        1
[INPUT] 1    0    [1    /1   ]  13.3224941287        1
[INPUT] 1    0    [1    /1   ]  0.599946911621       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0094923472843, 1.0]], [0, [105.81107733868127, 1.0]], [0, [421.92370919328243, 1.0]], [0, [0.5159257050457579, 1.0]], [0, [31.505149292478162, 1.0]], [0, [10.240356278997044, 1.0]], [0, [1.7551582801745256, 1.0]], [1, [2.77510165767054, 1.0]], [1, [13.322494128686229, 1.0]], [1, [0.5999469116207091, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.00949235]
bas 1, expnt(s) = [105.81107734]
bas 2, expnt(s) = [421.92370919]
bas 3, expnt(s) = [0.51592571]
bas 4, expnt(s) = [31.50514929]
bas 5, expnt(s) = [10.24035628]
bas 6, expnt(s) = [1.75515828]
bas 7, expnt(s) = [2.77510166]
bas 8, expnt(s) = [13.32249413]
bas 9, expnt(s) = [0.59994691]
CPU time:       353.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900949e+03 8.76849669e+02 1.05811077e+02 8.33514917e+01
 4.21923709e+02 2.35201708e+02 5.15925705e-01 1.53799668e+00
 3.15051493e+01 3.35970527e+01 1.02403563e+01 1.44627648e+01
 1.75515828e+00 3.85258509e+00 2.77510166e+00 1.04491993e+01
 1.33224941e+01 7.42533949e+01 5.99946912e-01 1.54037131e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900409447835
cond(S) = 77.24944045067808
E1 = -183.22908908952553  E_coul = 55.00786738627571
init E= -128.22122170325
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743019714614134  LUMO = 2.29777891897887
  mo_energy =
[-3.25525905e+01 -1.85682645e+00 -7.43019715e-01 -7.43019715e-01
 -7.43019715e-01  2.29777892e+00  2.65420818e+00  2.65420818e+00
  2.65420818e+00  1.99402460e+01  1.99402460e+01  1.99402460e+01
  2.88572292e+01  1.67864575e+02  7.99870131e+02  4.57443899e+03]
E1 = -182.18476231435193  E_coul = 53.90717596799822
cycle= 1 E= -128.277586346354  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269199
diis-c [-0.07246789  1.        ]
  HOMO = -0.810118294060131  LUMO = 2.2535427722762
  mo_energy =
[-3.28311599e+01 -1.92509566e+00 -8.10118294e-01 -8.10118294e-01
 -8.10118294e-01  2.25354277e+00  2.59814042e+00  2.59814042e+00
  2.59814042e+00  1.97452742e+01  1.97452742e+01  1.97452742e+01
  2.86513428e+01  1.67575097e+02  7.99530412e+02  4.57405724e+03]
E1 = -182.6579175812998  E_coul = 54.378639343597435
cycle= 2 E= -128.279278237702  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105706
diis-c [-2.21344855e-04  2.80241159e-01  7.19758841e-01]
  HOMO = -0.786866976076206  LUMO = 2.27109539108397
  mo_energy =
[-3.27550091e+01 -1.90104332e+00 -7.86866976e-01 -7.86866976e-01
 -7.86866976e-01  2.27109539e+00  2.61917213e+00  2.61917213e+00
  2.61917213e+00  1.98024925e+01  1.98024925e+01  1.98024925e+01
  2.87108533e+01  1.67653397e+02  7.99616684e+02  4.57414731e+03]
E1 = -182.52261537619393  E_coul = 54.24301836337335
cycle= 3 E= -128.279597012821  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695652
diis-c [-3.49705778e-08 -4.50163840e-03 -5.24714517e-03  1.00974878e+00]
  HOMO = -0.787052823565201  LUMO = 2.2709603001587
  mo_energy =
[-3.27554729e+01 -1.90125637e+00 -7.87052824e-01 -7.87052824e-01
 -7.87052824e-01  2.27096030e+00  2.61904241e+00  2.61904241e+00
  2.61904241e+00  1.98021225e+01  1.98021225e+01  1.98021225e+01
  2.87104320e+01  1.67653024e+02  7.99616457e+02  4.57414718e+03]
E1 = -182.52353779058825  E_coul = 54.243940762596935
cycle= 4 E= -128.279597027991  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.72967e-05
diis-c [-1.38567717e-10  2.43742221e-04 -2.00495724e-04 -8.11822154e-02
  1.08113897e+00]
  HOMO = -0.78704570796665  LUMO = 2.27096201178707
  mo_energy =
[-3.27554548e+01 -1.90125336e+00 -7.87045708e-01 -7.87045708e-01
 -7.87045708e-01  2.27096201e+00  2.61904836e+00  2.61904836e+00
  2.61904836e+00  1.98021369e+01  1.98021369e+01  1.98021369e+01
  2.87104447e+01  1.67653045e+02  7.99616485e+02  4.57414722e+03]
E1 = -182.52350779454932  E_coul = 54.24391076650919
cycle= 5 E= -128.27959702804  delta_E= -4.88e-11  |g|= 1.8e-06  |ddm|= 8.76e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350779454932  E_coul = 54.24391076650919
  HOMO = -0.787045296995312  LUMO = 2.27096197399221
  mo_energy =
[-3.27554538e+01 -1.90125339e+00 -7.87045297e-01 -7.87045297e-01
 -7.87045297e-01  2.27096197e+00  2.61904874e+00  2.61904874e+00
  2.61904874e+00  1.98021376e+01  1.98021376e+01  1.98021376e+01
  2.87104454e+01  1.67653046e+02  7.99616487e+02  4.57414722e+03]
E1 = -182.523506305331  E_coul = 54.2439092772904
Extra cycle  E= -128.279597028041  delta_E= -4.55e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43900949e+03 1.05811077e+02 4.21923709e+02 5.15925705e-01
 3.15051493e+01 1.02403563e+01 1.75515828e+00 2.77510166e+00
 1.33224941e+01 5.99946912e-01]
E = -128.2795970280406
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.00949235        1
[INPUT] 0    0    [1    /1   ]  105.811077339        1
[INPUT] 0    0    [1    /1   ]  421.923709193        1
[INPUT] 0    0    [1    /1   ]  0.515925705046       1
[INPUT] 0    0    [1    /1   ]  31.5051492925        1
[INPUT] 0    0    [1    /1   ]  10.240356279         1
[INPUT] 0    0    [1    /1   ]  1.75515828017        1
[INPUT] 1    0    [1    /1   ]  2.77510165767        1
[INPUT] 1    0    [1    /1   ]  13.3224941287        1
[INPUT] 1    0    [1    /1   ]  0.599946911621       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0094923472843, 1.0]], [0, [105.81107733868127, 1.0]], [0, [421.92370919328243, 1.0]], [0, [0.5159257050457579, 1.0]], [0, [31.505149292478162, 1.0]], [0, [10.240356278997044, 1.0]], [0, [1.7551582801745256, 1.0]], [1, [2.77510165767054, 1.0]], [1, [13.322494128686229, 1.0]], [1, [0.5999469116207091, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.00949235]
bas 1, expnt(s) = [105.81107734]
bas 2, expnt(s) = [421.92370919]
bas 3, expnt(s) = [0.51592571]
bas 4, expnt(s) = [31.50514929]
bas 5, expnt(s) = [10.24035628]
bas 6, expnt(s) = [1.75515828]
bas 7, expnt(s) = [2.77510166]
bas 8, expnt(s) = [13.32249413]
bas 9, expnt(s) = [0.59994691]
CPU time:       354.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43900949e+03 8.76849669e+02 1.05811077e+02 8.33514917e+01
 4.21923709e+02 2.35201708e+02 5.15925705e-01 1.53799668e+00
 3.15051493e+01 3.35970527e+01 1.02403563e+01 1.44627648e+01
 1.75515828e+00 3.85258509e+00 2.77510166e+00 1.04491993e+01
 1.33224941e+01 7.42533949e+01 5.99946912e-01 1.54037131e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900409447835
cond(S) = 77.24944045067808
E1 = -183.22908908952553  E_coul = 55.00786738627571
init E= -128.22122170325
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743019714614134  LUMO = 2.29777891897887
  mo_energy =
[-3.25525905e+01 -1.85682645e+00 -7.43019715e-01 -7.43019715e-01
 -7.43019715e-01  2.29777892e+00  2.65420818e+00  2.65420818e+00
  2.65420818e+00  1.99402460e+01  1.99402460e+01  1.99402460e+01
  2.88572292e+01  1.67864575e+02  7.99870131e+02  4.57443899e+03]
E1 = -182.18476231435193  E_coul = 53.90717596799822
cycle= 1 E= -128.277586346354  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269199
diis-c [-0.07246789  1.        ]
  HOMO = -0.810118294060131  LUMO = 2.2535427722762
  mo_energy =
[-3.28311599e+01 -1.92509566e+00 -8.10118294e-01 -8.10118294e-01
 -8.10118294e-01  2.25354277e+00  2.59814042e+00  2.59814042e+00
  2.59814042e+00  1.97452742e+01  1.97452742e+01  1.97452742e+01
  2.86513428e+01  1.67575097e+02  7.99530412e+02  4.57405724e+03]
E1 = -182.6579175812998  E_coul = 54.378639343597435
cycle= 2 E= -128.279278237702  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105706
diis-c [-2.21344855e-04  2.80241159e-01  7.19758841e-01]
  HOMO = -0.786866976076206  LUMO = 2.27109539108397
  mo_energy =
[-3.27550091e+01 -1.90104332e+00 -7.86866976e-01 -7.86866976e-01
 -7.86866976e-01  2.27109539e+00  2.61917213e+00  2.61917213e+00
  2.61917213e+00  1.98024925e+01  1.98024925e+01  1.98024925e+01
  2.87108533e+01  1.67653397e+02  7.99616684e+02  4.57414731e+03]
E1 = -182.52261537619393  E_coul = 54.24301836337335
cycle= 3 E= -128.279597012821  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695652
diis-c [-3.49705778e-08 -4.50163840e-03 -5.24714517e-03  1.00974878e+00]
  HOMO = -0.787052823565201  LUMO = 2.2709603001587
  mo_energy =
[-3.27554729e+01 -1.90125637e+00 -7.87052824e-01 -7.87052824e-01
 -7.87052824e-01  2.27096030e+00  2.61904241e+00  2.61904241e+00
  2.61904241e+00  1.98021225e+01  1.98021225e+01  1.98021225e+01
  2.87104320e+01  1.67653024e+02  7.99616457e+02  4.57414718e+03]
E1 = -182.52353779058825  E_coul = 54.243940762596935
cycle= 4 E= -128.279597027991  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.72967e-05
diis-c [-1.38567717e-10  2.43742221e-04 -2.00495724e-04 -8.11822154e-02
  1.08113897e+00]
  HOMO = -0.78704570796665  LUMO = 2.27096201178707
  mo_energy =
[-3.27554548e+01 -1.90125336e+00 -7.87045708e-01 -7.87045708e-01
 -7.87045708e-01  2.27096201e+00  2.61904836e+00  2.61904836e+00
  2.61904836e+00  1.98021369e+01  1.98021369e+01  1.98021369e+01
  2.87104447e+01  1.67653045e+02  7.99616485e+02  4.57414722e+03]
E1 = -182.52350779454932  E_coul = 54.24391076650919
cycle= 5 E= -128.27959702804  delta_E= -4.88e-11  |g|= 1.8e-06  |ddm|= 8.76e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350779454932  E_coul = 54.24391076650919
  HOMO = -0.787045296995312  LUMO = 2.27096197399221
  mo_energy =
[-3.27554538e+01 -1.90125339e+00 -7.87045297e-01 -7.87045297e-01
 -7.87045297e-01  2.27096197e+00  2.61904874e+00  2.61904874e+00
  2.61904874e+00  1.98021376e+01  1.98021376e+01  1.98021376e+01
  2.87104454e+01  1.67653046e+02  7.99616487e+02  4.57414722e+03]
E1 = -182.523506305331  E_coul = 54.2439092772904
Extra cycle  E= -128.279597028041  delta_E= -4.55e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24944045067808
E1 = -182.523506305331  E_coul = 54.2439092772904
init E= -128.279597028041
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787045377585007  LUMO = 2.27096184492614
  mo_energy =
[-3.27554542e+01 -1.90125356e+00 -7.87045378e-01 -7.87045378e-01
 -7.87045378e-01  2.27096184e+00  2.61904866e+00  2.61904866e+00
  2.61904866e+00  1.98021374e+01  1.98021374e+01  1.98021374e+01
  2.87104451e+01  1.67653045e+02  7.99616486e+02  4.57414722e+03]
E1 = -182.5235069468146  E_coul = 54.243909918774136
cycle= 1 E= -128.27959702804  delta_E= 1.42e-13  |g|= 1.02e-07  |ddm|= 2.42e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5235069468146  E_coul = 54.243909918774136
  HOMO = -0.787045329598339  LUMO = 2.27096186843671
  mo_energy =
[-3.27554540e+01 -1.90125353e+00 -7.87045330e-01 -7.87045330e-01
 -7.87045330e-01  2.27096187e+00  2.61904870e+00  2.61904870e+00
  2.61904870e+00  1.98021375e+01  1.98021375e+01  1.98021375e+01
  2.87104452e+01  1.67653046e+02  7.99616487e+02  4.57414722e+03]
E1 = -182.52350670031007  E_coul = 54.24390967226963
Extra cycle  E= -128.27959702804  delta_E= 2.84e-14  |g|= 3.67e-08  |ddm|= 4.04e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.43900949e+03 1.05811077e+02 4.21923709e+02 5.15925705e-01
 3.15051493e+01 1.02403563e+01 1.75515828e+00 2.77510166e+00
 1.33224941e+01 5.99946912e-01]
grad_E = [-1.09384122e-05 -5.79612148e-07 -3.19223609e-06 -1.62433986e-06
  2.93001983e-06 -5.79392062e-06 -1.76513359e-06  1.64877180e-05
 -4.76355804e-06  1.75226497e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.01070635        1
[INPUT] 0    0    [1    /1   ]  105.812048761        1
[INPUT] 0    0    [1    /1   ]  421.921722304        1
[INPUT] 0    0    [1    /1   ]  0.51592176378        1
[INPUT] 0    0    [1    /1   ]  31.5058052553        1
[INPUT] 0    0    [1    /1   ]  10.2404426073        1
[INPUT] 0    0    [1    /1   ]  1.75514398527        1
[INPUT] 1    0    [1    /1   ]  2.77508689244        1
[INPUT] 1    0    [1    /1   ]  13.322278685         1
[INPUT] 1    0    [1    /1   ]  0.599946365912       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.010706350981, 1.0]], [0, [105.81204876132331, 1.0]], [0, [421.9217223041598, 1.0]], [0, [0.5159217637800154, 1.0]], [0, [31.505805255254128, 1.0]], [0, [10.240442607281464, 1.0]], [0, [1.7551439852732085, 1.0]], [1, [2.775086892444521, 1.0]], [1, [13.322278685000983, 1.0]], [1, [0.599946365912096, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.01070635]
bas 1, expnt(s) = [105.81204876]
bas 2, expnt(s) = [421.9217223]
bas 3, expnt(s) = [0.51592176]
bas 4, expnt(s) = [31.50580526]
bas 5, expnt(s) = [10.24044261]
bas 6, expnt(s) = [1.75514399]
bas 7, expnt(s) = [2.77508689]
bas 8, expnt(s) = [13.32227869]
bas 9, expnt(s) = [0.59994637]
CPU time:       357.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43901071e+03 8.76849996e+02 1.05812049e+02 8.33520656e+01
 4.21921722e+02 2.35200878e+02 5.15921764e-01 1.53798787e+00
 3.15058053e+01 3.35975773e+01 1.02404426e+01 1.44628563e+01
 1.75514399e+00 3.85256156e+00 2.77508689e+00 1.04491298e+01
 1.33222787e+01 7.42518939e+01 5.99946366e-01 1.54036955e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900612354017
cond(S) = 77.24942916460985
E1 = -183.22909004196933  E_coul = 55.00786757597196
init E= -128.221222465997
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743019520141763  LUMO = 2.29775141717562
  mo_energy =
[-3.25525912e+01 -1.85682628e+00 -7.43019520e-01 -7.43019520e-01
 -7.43019520e-01  2.29775142e+00  2.65420145e+00  2.65420145e+00
  2.65420145e+00  1.99399729e+01  1.99399729e+01  1.99399729e+01
  2.88575834e+01  1.67867208e+02  7.99873516e+02  4.57444001e+03]
E1 = -182.1847617994196  E_coul = 53.9071754512763
cycle= 1 E= -128.277586348143  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269199
diis-c [-0.07246832  1.        ]
  HOMO = -0.810118254373879  LUMO = 2.25351573006833
  mo_energy =
[-3.28311604e+01 -1.92509549e+00 -8.10118254e-01 -8.10118254e-01
 -8.10118254e-01  2.25351573e+00  2.59813375e+00  2.59813375e+00
  2.59813375e+00  1.97450022e+01  1.97450022e+01  1.97450022e+01
  2.86516957e+01  1.67577731e+02  7.99533797e+02  4.57405826e+03]
E1 = -182.65791790183894  E_coul = 54.3786396605237
cycle= 2 E= -128.279278241315  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105706
diis-c [-2.21343623e-04  2.80241066e-01  7.19758934e-01]
  HOMO = -0.786866882986651  LUMO = 2.27106825550666
  mo_energy =
[-3.27550096e+01 -1.90104309e+00 -7.86866883e-01 -7.86866883e-01
 -7.86866883e-01  2.27106826e+00  2.61916545e+00  2.61916545e+00
  2.61916545e+00  1.98022203e+01  1.98022203e+01  1.98022203e+01
  2.87112066e+01  1.67656031e+02  7.99620069e+02  4.57414833e+03]
E1 = -182.5226152941196  E_coul = 54.24301827643225
cycle= 3 E= -128.279597017687  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695694
diis-c [-3.49578493e-08 -4.50121002e-03 -5.24548900e-03  1.00974670e+00]
  HOMO = -0.78705274150057  LUMO = 2.27093316465214
  mo_energy =
[-3.27554733e+01 -1.90125614e+00 -7.87052742e-01 -7.87052742e-01
 -7.87052742e-01  2.27093316e+00  2.61903571e+00  2.61903571e+00
  2.61903571e+00  1.98018503e+01  1.98018503e+01  1.98018503e+01
  2.87107853e+01  1.67655657e+02  7.99619842e+02  4.57414820e+03]
E1 = -182.52353775897896  E_coul = 54.243940726120115
cycle= 4 E= -128.279597032859  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.72861e-05
diis-c [-1.38485394e-10  2.43669623e-04 -2.00533191e-04 -8.11654089e-02
  1.08112227e+00]
  HOMO = -0.787045627866423  LUMO = 2.27093487616668
  mo_energy =
[-3.27554553e+01 -1.90125314e+00 -7.87045628e-01 -7.87045628e-01
 -7.87045628e-01  2.27093488e+00  2.61904166e+00  2.61904166e+00
  2.61904166e+00  1.98018647e+01  1.98018647e+01  1.98018647e+01
  2.87107980e+01  1.67655678e+02  7.99619870e+02  4.57414824e+03]
E1 = -182.5235077705536  E_coul = 54.24391073764573
cycle= 5 E= -128.279597032908  delta_E= -4.9e-11  |g|= 1.8e-06  |ddm|= 8.76e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5235077705536  E_coul = 54.24391073764573
  HOMO = -0.787045216937408  LUMO = 2.27093483843054
  mo_energy =
[-3.27554543e+01 -1.90125317e+00 -7.87045217e-01 -7.87045217e-01
 -7.87045217e-01  2.27093484e+00  2.61904204e+00  2.61904204e+00
  2.61904204e+00  1.98018654e+01  1.98018654e+01  1.98018654e+01
  2.87107986e+01  1.67655679e+02  7.99619872e+02  4.57414824e+03]
E1 = -182.52350628139249  E_coul = 54.24390924848435
Extra cycle  E= -128.279597032908  delta_E= -2.56e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43901071e+03 1.05812049e+02 4.21921722e+02 5.15921764e-01
 3.15058053e+01 1.02404426e+01 1.75514399e+00 2.77508689e+00
 1.33222787e+01 5.99946366e-01]
E = -128.27959703290813
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.01070635        1
[INPUT] 0    0    [1    /1   ]  105.812048761        1
[INPUT] 0    0    [1    /1   ]  421.921722304        1
[INPUT] 0    0    [1    /1   ]  0.51592176378        1
[INPUT] 0    0    [1    /1   ]  31.5058052553        1
[INPUT] 0    0    [1    /1   ]  10.2404426073        1
[INPUT] 0    0    [1    /1   ]  1.75514398527        1
[INPUT] 1    0    [1    /1   ]  2.77508689244        1
[INPUT] 1    0    [1    /1   ]  13.322278685         1
[INPUT] 1    0    [1    /1   ]  0.599946365912       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.010706350981, 1.0]], [0, [105.81204876132331, 1.0]], [0, [421.9217223041598, 1.0]], [0, [0.5159217637800154, 1.0]], [0, [31.505805255254128, 1.0]], [0, [10.240442607281464, 1.0]], [0, [1.7551439852732085, 1.0]], [1, [2.775086892444521, 1.0]], [1, [13.322278685000983, 1.0]], [1, [0.599946365912096, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.01070635]
bas 1, expnt(s) = [105.81204876]
bas 2, expnt(s) = [421.9217223]
bas 3, expnt(s) = [0.51592176]
bas 4, expnt(s) = [31.50580526]
bas 5, expnt(s) = [10.24044261]
bas 6, expnt(s) = [1.75514399]
bas 7, expnt(s) = [2.77508689]
bas 8, expnt(s) = [13.32227869]
bas 9, expnt(s) = [0.59994637]
CPU time:       359.24
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43901071e+03 8.76849996e+02 1.05812049e+02 8.33520656e+01
 4.21921722e+02 2.35200878e+02 5.15921764e-01 1.53798787e+00
 3.15058053e+01 3.35975773e+01 1.02404426e+01 1.44628563e+01
 1.75514399e+00 3.85256156e+00 2.77508689e+00 1.04491298e+01
 1.33222787e+01 7.42518939e+01 5.99946366e-01 1.54036955e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900612354017
cond(S) = 77.24942916460985
E1 = -183.22909004196933  E_coul = 55.00786757597196
init E= -128.221222465997
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743019520141763  LUMO = 2.29775141717562
  mo_energy =
[-3.25525912e+01 -1.85682628e+00 -7.43019520e-01 -7.43019520e-01
 -7.43019520e-01  2.29775142e+00  2.65420145e+00  2.65420145e+00
  2.65420145e+00  1.99399729e+01  1.99399729e+01  1.99399729e+01
  2.88575834e+01  1.67867208e+02  7.99873516e+02  4.57444001e+03]
E1 = -182.1847617994196  E_coul = 53.9071754512763
cycle= 1 E= -128.277586348143  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269199
diis-c [-0.07246832  1.        ]
  HOMO = -0.810118254373879  LUMO = 2.25351573006833
  mo_energy =
[-3.28311604e+01 -1.92509549e+00 -8.10118254e-01 -8.10118254e-01
 -8.10118254e-01  2.25351573e+00  2.59813375e+00  2.59813375e+00
  2.59813375e+00  1.97450022e+01  1.97450022e+01  1.97450022e+01
  2.86516957e+01  1.67577731e+02  7.99533797e+02  4.57405826e+03]
E1 = -182.65791790183894  E_coul = 54.3786396605237
cycle= 2 E= -128.279278241315  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105706
diis-c [-2.21343623e-04  2.80241066e-01  7.19758934e-01]
  HOMO = -0.786866882986651  LUMO = 2.27106825550666
  mo_energy =
[-3.27550096e+01 -1.90104309e+00 -7.86866883e-01 -7.86866883e-01
 -7.86866883e-01  2.27106826e+00  2.61916545e+00  2.61916545e+00
  2.61916545e+00  1.98022203e+01  1.98022203e+01  1.98022203e+01
  2.87112066e+01  1.67656031e+02  7.99620069e+02  4.57414833e+03]
E1 = -182.5226152941196  E_coul = 54.24301827643225
cycle= 3 E= -128.279597017687  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695694
diis-c [-3.49578493e-08 -4.50121002e-03 -5.24548900e-03  1.00974670e+00]
  HOMO = -0.78705274150057  LUMO = 2.27093316465214
  mo_energy =
[-3.27554733e+01 -1.90125614e+00 -7.87052742e-01 -7.87052742e-01
 -7.87052742e-01  2.27093316e+00  2.61903571e+00  2.61903571e+00
  2.61903571e+00  1.98018503e+01  1.98018503e+01  1.98018503e+01
  2.87107853e+01  1.67655657e+02  7.99619842e+02  4.57414820e+03]
E1 = -182.52353775897896  E_coul = 54.243940726120115
cycle= 4 E= -128.279597032859  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.72861e-05
diis-c [-1.38485394e-10  2.43669623e-04 -2.00533191e-04 -8.11654089e-02
  1.08112227e+00]
  HOMO = -0.787045627866423  LUMO = 2.27093487616668
  mo_energy =
[-3.27554553e+01 -1.90125314e+00 -7.87045628e-01 -7.87045628e-01
 -7.87045628e-01  2.27093488e+00  2.61904166e+00  2.61904166e+00
  2.61904166e+00  1.98018647e+01  1.98018647e+01  1.98018647e+01
  2.87107980e+01  1.67655678e+02  7.99619870e+02  4.57414824e+03]
E1 = -182.5235077705536  E_coul = 54.24391073764573
cycle= 5 E= -128.279597032908  delta_E= -4.9e-11  |g|= 1.8e-06  |ddm|= 8.76e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5235077705536  E_coul = 54.24391073764573
  HOMO = -0.787045216937408  LUMO = 2.27093483843054
  mo_energy =
[-3.27554543e+01 -1.90125317e+00 -7.87045217e-01 -7.87045217e-01
 -7.87045217e-01  2.27093484e+00  2.61904204e+00  2.61904204e+00
  2.61904204e+00  1.98018654e+01  1.98018654e+01  1.98018654e+01
  2.87107986e+01  1.67655679e+02  7.99619872e+02  4.57414824e+03]
E1 = -182.52350628139249  E_coul = 54.24390924848435
Extra cycle  E= -128.279597032908  delta_E= -2.56e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24942916460985
E1 = -182.52350628139249  E_coul = 54.24390924848435
init E= -128.279597032908
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787045297528653  LUMO = 2.27093470938216
  mo_energy =
[-3.27554547e+01 -1.90125334e+00 -7.87045298e-01 -7.87045298e-01
 -7.87045298e-01  2.27093471e+00  2.61904196e+00  2.61904196e+00
  2.61904196e+00  1.98018652e+01  1.98018652e+01  1.98018652e+01
  2.87107983e+01  1.67655679e+02  7.99619871e+02  4.57414824e+03]
E1 = -182.5235069228445  E_coul = 54.243909889936205
cycle= 1 E= -128.279597032908  delta_E= -1.42e-13  |g|= 1.02e-07  |ddm|= 2.42e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5235069228445  E_coul = 54.243909889936205
  HOMO = -0.787045249545175  LUMO = 2.27093473289334
  mo_energy =
[-3.27554545e+01 -1.90125330e+00 -7.87045250e-01 -7.87045250e-01
 -7.87045250e-01  2.27093473e+00  2.61904201e+00  2.61904201e+00
  2.61904201e+00  1.98018653e+01  1.98018653e+01  1.98018653e+01
  2.87107985e+01  1.67655679e+02  7.99619871e+02  4.57414824e+03]
E1 = -182.52350667635022  E_coul = 54.24390964344199
Extra cycle  E= -128.279597032908  delta_E= 2.84e-14  |g|= 3.67e-08  |ddm|= 4.03e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43901071e+03 1.05812049e+02 4.21921722e+02 5.15921764e-01
 3.15058053e+01 1.02404426e+01 1.75514399e+00 2.77508689e+00
 1.33222787e+01 5.99946366e-01]
grad_E = [-1.09376367e-05 -7.39283667e-07 -3.19822633e-06 -1.94230793e-06
  4.22235176e-06 -8.22722931e-06 -2.65575555e-06  2.19284461e-05
 -6.55377090e-06  2.54118680e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.01277298        1
[INPUT] 0    0    [1    /1   ]  105.813474996        1
[INPUT] 0    0    [1    /1   ]  421.918853565        1
[INPUT] 0    0    [1    /1   ]  0.51591600963        1
[INPUT] 0    0    [1    /1   ]  31.5067656141        1
[INPUT] 0    0    [1    /1   ]  10.2405691181        1
[INPUT] 0    0    [1    /1   ]  1.75512310031        1
[INPUT] 1    0    [1    /1   ]  2.77506529428        1
[INPUT] 1    0    [1    /1   ]  13.3219636984        1
[INPUT] 1    0    [1    /1   ]  0.599945566153       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0127729848055, 1.0]], [0, [105.81347499572651, 1.0]], [0, [421.91885356509584, 1.0]], [0, [0.5159160096302382, 1.0]], [0, [31.506765614124564, 1.0]], [0, [10.240569118086986, 1.0]], [0, [1.7551231003062473, 1.0]], [1, [2.77506529428178, 1.0]], [1, [13.321963698440898, 1.0]], [1, [0.5999455661532622, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.01277298]
bas 1, expnt(s) = [105.813475]
bas 2, expnt(s) = [421.91885357]
bas 3, expnt(s) = [0.51591601]
bas 4, expnt(s) = [31.50676561]
bas 5, expnt(s) = [10.24056912]
bas 6, expnt(s) = [1.7551231]
bas 7, expnt(s) = [2.77506529]
bas 8, expnt(s) = [13.3219637]
bas 9, expnt(s) = [0.59994557]
CPU time:       362.39
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43901277e+03 8.76850553e+02 1.05813475e+02 8.33529082e+01
 4.21918854e+02 2.35199678e+02 5.15916010e-01 1.53797501e+00
 3.15067656e+01 3.35983454e+01 1.02405691e+01 1.44629903e+01
 1.75512310e+00 3.85252718e+00 2.77506529e+00 1.04490282e+01
 1.33219637e+01 7.42496994e+01 5.99945566e-01 1.54036699e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900909303293
cond(S) = 77.24940729707775
E1 = -183.22909143398985  E_coul = 55.007867852525365
init E= -128.221223581464
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743019235786337  LUMO = 2.29771125772421
  mo_energy =
[-3.25525922e+01 -1.85682604e+00 -7.43019236e-01 -7.43019236e-01
 -7.43019236e-01  2.29771126e+00  2.65419160e+00  2.65419160e+00
  2.65419160e+00  1.99395736e+01  1.99395736e+01  1.99395736e+01
  2.88581025e+01  1.67871069e+02  7.99878526e+02  4.57444201e+03]
E1 = -182.1847610439052  E_coul = 53.90717469131014
cycle= 1 E= -128.277586352595  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269201
diis-c [-0.07246896  1.        ]
  HOMO = -0.810118196417388  LUMO = 2.25347624103761
  mo_energy =
[-3.28311613e+01 -1.92509525e+00 -8.10118196e-01 -8.10118196e-01
 -8.10118196e-01  2.25347624e+00  2.59812400e+00  2.59812400e+00
  2.59812400e+00  1.97446046e+01  1.97446046e+01  1.97446046e+01
  2.86522129e+01  1.67581590e+02  7.99538808e+02  4.57406026e+03]
E1 = -182.6579183696822  E_coul = 54.37864012123742
cycle= 2 E= -128.279278248445  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105706
diis-c [-2.21341832e-04  2.80240930e-01  7.19759070e-01]
  HOMO = -0.786866746871315  LUMO = 2.27102863032634
  mo_energy =
[-3.27550102e+01 -1.90104276e+00 -7.86866747e-01 -7.86866747e-01
 -7.86866747e-01  2.27102863e+00  2.61915566e+00  2.61915566e+00
  2.61915566e+00  1.98018223e+01  1.98018223e+01  1.98018223e+01
  2.87117244e+01  1.67659891e+02  7.99625080e+02  4.57415033e+03]
E1 = -182.52261517292206  E_coul = 54.24301814626977
cycle= 3 E= -128.279597026652  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695755
diis-c [-3.49392678e-08 -4.50058418e-03 -5.24306988e-03  1.00974365e+00]
  HOMO = -0.787052621479809  LUMO = 2.27089353957361
  mo_energy =
[-3.27554740e+01 -1.90125581e+00 -7.87052621e-01 -7.87052621e-01
 -7.87052621e-01  2.27089354e+00  2.61902591e+00  2.61902591e+00
  2.61902591e+00  1.98014523e+01  1.98014523e+01  1.98014523e+01
  2.87113030e+01  1.67659517e+02  7.99624853e+02  4.57415020e+03]
E1 = -182.5235377114795  E_coul = 54.243940669654165
cycle= 4 E= -128.279597041825  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.72707e-05
diis-c [-1.38365275e-10  2.43563796e-04 -2.00587586e-04 -8.11408921e-02
  1.08109792e+00]
  HOMO = -0.787045510713289  LUMO = 2.27089525092142
  mo_energy =
[-3.27554560e+01 -1.90125281e+00 -7.87045511e-01 -7.87045511e-01
 -7.87045511e-01  2.27089525e+00  2.61903186e+00  2.61903186e+00
  2.61903186e+00  1.98014667e+01  1.98014667e+01  1.98014667e+01
  2.87113158e+01  1.67659538e+02  7.99624881e+02  4.57415024e+03]
E1 = -182.52350773416893  E_coul = 54.24391069229469
cycle= 5 E= -128.279597041874  delta_E= -4.89e-11  |g|= 1.8e-06  |ddm|= 8.75e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350773416893  E_coul = 54.24391069229469
  HOMO = -0.787045099846295  LUMO = 2.27089521327075
  mo_energy =
[-3.27554550e+01 -1.90125284e+00 -7.87045100e-01 -7.87045100e-01
 -7.87045100e-01  2.27089521e+00  2.61903224e+00  2.61903224e+00
  2.61903224e+00  1.98014674e+01  1.98014674e+01  1.98014674e+01
  2.87113164e+01  1.67659539e+02  7.99624883e+02  4.57415024e+03]
E1 = -182.52350624509302  E_coul = 54.24390920321821
Extra cycle  E= -128.279597041875  delta_E= -5.68e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43901277e+03 1.05813475e+02 4.21918854e+02 5.15916010e-01
 3.15067656e+01 1.02405691e+01 1.75512310e+00 2.77506529e+00
 1.33219637e+01 5.99945566e-01]
E = -128.2795970418748
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.01277298        1
[INPUT] 0    0    [1    /1   ]  105.813474996        1
[INPUT] 0    0    [1    /1   ]  421.918853565        1
[INPUT] 0    0    [1    /1   ]  0.51591600963        1
[INPUT] 0    0    [1    /1   ]  31.5067656141        1
[INPUT] 0    0    [1    /1   ]  10.2405691181        1
[INPUT] 0    0    [1    /1   ]  1.75512310031        1
[INPUT] 1    0    [1    /1   ]  2.77506529428        1
[INPUT] 1    0    [1    /1   ]  13.3219636984        1
[INPUT] 1    0    [1    /1   ]  0.599945566153       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0127729848055, 1.0]], [0, [105.81347499572651, 1.0]], [0, [421.91885356509584, 1.0]], [0, [0.5159160096302382, 1.0]], [0, [31.506765614124564, 1.0]], [0, [10.240569118086986, 1.0]], [0, [1.7551231003062473, 1.0]], [1, [2.77506529428178, 1.0]], [1, [13.321963698440898, 1.0]], [1, [0.5999455661532622, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.01277298]
bas 1, expnt(s) = [105.813475]
bas 2, expnt(s) = [421.91885357]
bas 3, expnt(s) = [0.51591601]
bas 4, expnt(s) = [31.50676561]
bas 5, expnt(s) = [10.24056912]
bas 6, expnt(s) = [1.7551231]
bas 7, expnt(s) = [2.77506529]
bas 8, expnt(s) = [13.3219637]
bas 9, expnt(s) = [0.59994557]
CPU time:       363.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43901277e+03 8.76850553e+02 1.05813475e+02 8.33529082e+01
 4.21918854e+02 2.35199678e+02 5.15916010e-01 1.53797501e+00
 3.15067656e+01 3.35983454e+01 1.02405691e+01 1.44629903e+01
 1.75512310e+00 3.85252718e+00 2.77506529e+00 1.04490282e+01
 1.33219637e+01 7.42496994e+01 5.99945566e-01 1.54036699e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966900909303293
cond(S) = 77.24940729707775
E1 = -183.22909143398985  E_coul = 55.007867852525365
init E= -128.221223581464
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743019235786337  LUMO = 2.29771125772421
  mo_energy =
[-3.25525922e+01 -1.85682604e+00 -7.43019236e-01 -7.43019236e-01
 -7.43019236e-01  2.29771126e+00  2.65419160e+00  2.65419160e+00
  2.65419160e+00  1.99395736e+01  1.99395736e+01  1.99395736e+01
  2.88581025e+01  1.67871069e+02  7.99878526e+02  4.57444201e+03]
E1 = -182.1847610439052  E_coul = 53.90717469131014
cycle= 1 E= -128.277586352595  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269201
diis-c [-0.07246896  1.        ]
  HOMO = -0.810118196417388  LUMO = 2.25347624103761
  mo_energy =
[-3.28311613e+01 -1.92509525e+00 -8.10118196e-01 -8.10118196e-01
 -8.10118196e-01  2.25347624e+00  2.59812400e+00  2.59812400e+00
  2.59812400e+00  1.97446046e+01  1.97446046e+01  1.97446046e+01
  2.86522129e+01  1.67581590e+02  7.99538808e+02  4.57406026e+03]
E1 = -182.6579183696822  E_coul = 54.37864012123742
cycle= 2 E= -128.279278248445  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105706
diis-c [-2.21341832e-04  2.80240930e-01  7.19759070e-01]
  HOMO = -0.786866746871315  LUMO = 2.27102863032634
  mo_energy =
[-3.27550102e+01 -1.90104276e+00 -7.86866747e-01 -7.86866747e-01
 -7.86866747e-01  2.27102863e+00  2.61915566e+00  2.61915566e+00
  2.61915566e+00  1.98018223e+01  1.98018223e+01  1.98018223e+01
  2.87117244e+01  1.67659891e+02  7.99625080e+02  4.57415033e+03]
E1 = -182.52261517292206  E_coul = 54.24301814626977
cycle= 3 E= -128.279597026652  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695755
diis-c [-3.49392678e-08 -4.50058418e-03 -5.24306988e-03  1.00974365e+00]
  HOMO = -0.787052621479809  LUMO = 2.27089353957361
  mo_energy =
[-3.27554740e+01 -1.90125581e+00 -7.87052621e-01 -7.87052621e-01
 -7.87052621e-01  2.27089354e+00  2.61902591e+00  2.61902591e+00
  2.61902591e+00  1.98014523e+01  1.98014523e+01  1.98014523e+01
  2.87113030e+01  1.67659517e+02  7.99624853e+02  4.57415020e+03]
E1 = -182.5235377114795  E_coul = 54.243940669654165
cycle= 4 E= -128.279597041825  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.72707e-05
diis-c [-1.38365275e-10  2.43563796e-04 -2.00587586e-04 -8.11408921e-02
  1.08109792e+00]
  HOMO = -0.787045510713289  LUMO = 2.27089525092142
  mo_energy =
[-3.27554560e+01 -1.90125281e+00 -7.87045511e-01 -7.87045511e-01
 -7.87045511e-01  2.27089525e+00  2.61903186e+00  2.61903186e+00
  2.61903186e+00  1.98014667e+01  1.98014667e+01  1.98014667e+01
  2.87113158e+01  1.67659538e+02  7.99624881e+02  4.57415024e+03]
E1 = -182.52350773416893  E_coul = 54.24391069229469
cycle= 5 E= -128.279597041874  delta_E= -4.89e-11  |g|= 1.8e-06  |ddm|= 8.75e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350773416893  E_coul = 54.24391069229469
  HOMO = -0.787045099846295  LUMO = 2.27089521327075
  mo_energy =
[-3.27554550e+01 -1.90125284e+00 -7.87045100e-01 -7.87045100e-01
 -7.87045100e-01  2.27089521e+00  2.61903224e+00  2.61903224e+00
  2.61903224e+00  1.98014674e+01  1.98014674e+01  1.98014674e+01
  2.87113164e+01  1.67659539e+02  7.99624883e+02  4.57415024e+03]
E1 = -182.52350624509302  E_coul = 54.24390920321821
Extra cycle  E= -128.279597041875  delta_E= -5.68e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24940729707775
E1 = -182.52350624509302  E_coul = 54.24390920321821
init E= -128.279597041875
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787045180439717  LUMO = 2.27089508424821
  mo_energy =
[-3.27554554e+01 -1.90125301e+00 -7.87045180e-01 -7.87045180e-01
 -7.87045180e-01  2.27089508e+00  2.61903216e+00  2.61903216e+00
  2.61903216e+00  1.98014672e+01  1.98014672e+01  1.98014672e+01
  2.87113161e+01  1.67659538e+02  7.99624882e+02  4.57415024e+03]
E1 = -182.52350688649736  E_coul = 54.243909844622884
cycle= 1 E= -128.279597041874  delta_E= 3.41e-13  |g|= 1.02e-07  |ddm|= 2.42e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52350688649736  E_coul = 54.243909844622884
  HOMO = -0.787045132460946  LUMO = 2.27089510776043
  mo_energy =
[-3.27554552e+01 -1.90125297e+00 -7.87045132e-01 -7.87045132e-01
 -7.87045132e-01  2.27089511e+00  2.61903221e+00  2.61903221e+00
  2.61903221e+00  1.98014673e+01  1.98014673e+01  1.98014673e+01
  2.87113162e+01  1.67659539e+02  7.99624882e+02  4.57415024e+03]
E1 = -182.52350664001918  E_coul = 54.24390959814452
Extra cycle  E= -128.279597041875  delta_E= -1.99e-13  |g|= 3.67e-08  |ddm|= 4.03e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43901277e+03 1.05813475e+02 4.21918854e+02 5.15916010e-01
 3.15067656e+01 1.02405691e+01 1.75512310e+00 2.77506529e+00
 1.33219637e+01 5.99945566e-01]
grad_E = [-1.09364979e-05 -9.72764641e-07 -3.20697432e-06 -2.39961076e-06
  6.11173531e-06 -1.17845495e-05 -3.95931369e-06  2.98777027e-05
 -9.17060934e-06  3.69490944e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.01639186        1
[INPUT] 0    0    [1    /1   ]  105.815618701        1
[INPUT] 0    0    [1    /1   ]  421.91463078         1
[INPUT] 0    0    [1    /1   ]  0.515907415862       1
[INPUT] 0    0    [1    /1   ]  31.508203852         1
[INPUT] 0    0    [1    /1   ]  10.2407587901        1
[INPUT] 0    0    [1    /1   ]  1.7550918981         1
[INPUT] 1    0    [1    /1   ]  2.77503300934        1
[INPUT] 1    0    [1    /1   ]  13.3214928782        1
[INPUT] 1    0    [1    /1   ]  0.599944370874       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0163918553767, 1.0]], [0, [105.81561870067316, 1.0]], [0, [421.91463078031086, 1.0]], [0, [0.5159074158624007, 1.0]], [0, [31.50820385195452, 1.0]], [0, [10.240758790059548, 1.0]], [0, [1.755091898102869, 1.0]], [1, [2.7750330093412763, 1.0]], [1, [13.321492878235173, 1.0]], [1, [0.5999443708742145, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.01639186]
bas 1, expnt(s) = [105.8156187]
bas 2, expnt(s) = [421.91463078]
bas 3, expnt(s) = [0.51590742]
bas 4, expnt(s) = [31.50820385]
bas 5, expnt(s) = [10.24075879]
bas 6, expnt(s) = [1.7550919]
bas 7, expnt(s) = [2.77503301]
bas 8, expnt(s) = [13.32149288]
bas 9, expnt(s) = [0.59994437]
CPU time:       366.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43901639e+03 8.76851529e+02 1.05815619e+02 8.33541747e+01
 4.21914631e+02 2.35197913e+02 5.15907416e-01 1.53795579e+00
 3.15082039e+01 3.35994957e+01 1.02407588e+01 1.44631912e+01
 1.75509190e+00 3.85247581e+00 2.77503301e+00 1.04488762e+01
 1.33214929e+01 7.42464193e+01 5.99944371e-01 1.54036315e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966901353008144
cond(S) = 77.24936432854278
E1 = -183.2290935135974  E_coul = 55.00786826523418
init E= -128.221225248363
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743018810557984  LUMO = 2.29765128107003
  mo_energy =
[-3.25525936e+01 -1.85682568e+00 -7.43018811e-01 -7.43018811e-01
 -7.43018811e-01  2.29765128e+00  2.65417688e+00  2.65417688e+00
  2.65417688e+00  1.99389767e+01  1.99389767e+01  1.99389767e+01
  2.88588809e+01  1.67876858e+02  7.99886132e+02  4.57444592e+03]
E1 = -182.18475992168462  E_coul = 53.90717355964644
cycle= 1 E= -128.277586362038  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269202
diis-c [-0.07246991  1.        ]
  HOMO = -0.810118109149365  LUMO = 2.25341726533152
  mo_energy =
[-3.28311625e+01 -1.92509487e+00 -8.10118109e-01 -8.10118109e-01
 -8.10118109e-01  2.25341727e+00  2.59810943e+00  2.59810943e+00
  2.59810943e+00  1.97440103e+01  1.97440103e+01  1.97440103e+01
  2.86529884e+01  1.67587378e+02  7.99546414e+02  4.57406417e+03]
E1 = -182.65791907397588  E_coul = 54.37864081209637
cycle= 2 E= -128.27927826188  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105707
diis-c [-2.21339168e-04  2.80240726e-01  7.19759274e-01]
  HOMO = -0.786866542869851  LUMO = 2.27096945141126
  mo_energy =
[-3.27550112e+01 -1.90104226e+00 -7.86866543e-01 -7.86866543e-01
 -7.86866543e-01  2.27096945e+00  2.61914103e+00  2.61914103e+00
  2.61914103e+00  1.98012275e+01  1.98012275e+01  1.98012275e+01
  2.87125008e+01  1.67665679e+02  7.99632687e+02  4.57415425e+03]
E1 = -182.52261499751526  E_coul = 54.24301795468783
cycle= 3 E= -128.279597042827  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695847
diis-c [-3.49115162e-08 -4.49964882e-03 -5.23945452e-03  1.00973910e+00]
  HOMO = -0.787052441527613  LUMO = 2.27083436080397
  mo_energy =
[-3.27554751e+01 -1.90125532e+00 -7.87052442e-01 -7.87052442e-01
 -7.87052442e-01  2.27083436e+00  2.61901126e+00  2.61901126e+00
  2.61901126e+00  1.98008574e+01  1.98008574e+01  1.98008574e+01
  2.87120794e+01  1.67665305e+02  7.99632459e+02  4.57415412e+03]
E1 = -182.52353764622032  E_coul = 54.24394058821764
cycle= 4 E= -128.279597058003  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.72476e-05
diis-c [-1.38185874e-10  2.43405512e-04 -2.00669152e-04 -8.11042458e-02
  1.08106151e+00]
  HOMO = -0.787045335045474  LUMO = 2.27083607190224
  mo_energy =
[-3.27554571e+01 -1.90125231e+00 -7.87045335e-01 -7.87045335e-01
 -7.87045335e-01  2.27083607e+00  2.61901721e+00  2.61901721e+00
  2.61901721e+00  1.98008718e+01  1.98008718e+01  1.98008718e+01
  2.87120921e+01  1.67665326e+02  7.99632488e+02  4.57415415e+03]
E1 = -182.52350768551662  E_coul = 54.24391062746528
cycle= 5 E= -128.279597058051  delta_E= -4.87e-11  |g|= 1.8e-06  |ddm|= 8.75e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350768551662  E_coul = 54.24391062746528
  HOMO = -0.787044924271033  LUMO = 2.27083603437947
  mo_energy =
[-3.27554561e+01 -1.90125234e+00 -7.87044924e-01 -7.87044924e-01
 -7.87044924e-01  2.27083603e+00  2.61901759e+00  2.61901759e+00
  2.61901759e+00  1.98008725e+01  1.98008725e+01  1.98008725e+01
  2.87120927e+01  1.67665327e+02  7.99632489e+02  4.57415415e+03]
E1 = -182.52350619656656  E_coul = 54.243909138514844
Extra cycle  E= -128.279597058052  delta_E= -3.69e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43901639e+03 1.05815619e+02 4.21914631e+02 5.15907416e-01
 3.15082039e+01 1.02407588e+01 1.75509190e+00 2.77503301e+00
 1.33214929e+01 5.99944371e-01]
E = -128.2795970580517
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.01639186        1
[INPUT] 0    0    [1    /1   ]  105.815618701        1
[INPUT] 0    0    [1    /1   ]  421.91463078         1
[INPUT] 0    0    [1    /1   ]  0.515907415862       1
[INPUT] 0    0    [1    /1   ]  31.508203852         1
[INPUT] 0    0    [1    /1   ]  10.2407587901        1
[INPUT] 0    0    [1    /1   ]  1.7550918981         1
[INPUT] 1    0    [1    /1   ]  2.77503300934        1
[INPUT] 1    0    [1    /1   ]  13.3214928782        1
[INPUT] 1    0    [1    /1   ]  0.599944370874       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0163918553767, 1.0]], [0, [105.81561870067316, 1.0]], [0, [421.91463078031086, 1.0]], [0, [0.5159074158624007, 1.0]], [0, [31.50820385195452, 1.0]], [0, [10.240758790059548, 1.0]], [0, [1.755091898102869, 1.0]], [1, [2.7750330093412763, 1.0]], [1, [13.321492878235173, 1.0]], [1, [0.5999443708742145, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.01639186]
bas 1, expnt(s) = [105.8156187]
bas 2, expnt(s) = [421.91463078]
bas 3, expnt(s) = [0.51590742]
bas 4, expnt(s) = [31.50820385]
bas 5, expnt(s) = [10.24075879]
bas 6, expnt(s) = [1.7550919]
bas 7, expnt(s) = [2.77503301]
bas 8, expnt(s) = [13.32149288]
bas 9, expnt(s) = [0.59994437]
CPU time:       368.23
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43901639e+03 8.76851529e+02 1.05815619e+02 8.33541747e+01
 4.21914631e+02 2.35197913e+02 5.15907416e-01 1.53795579e+00
 3.15082039e+01 3.35994957e+01 1.02407588e+01 1.44631912e+01
 1.75509190e+00 3.85247581e+00 2.77503301e+00 1.04488762e+01
 1.33214929e+01 7.42464193e+01 5.99944371e-01 1.54036315e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966901353008144
cond(S) = 77.24936432854278
E1 = -183.2290935135974  E_coul = 55.00786826523418
init E= -128.221225248363
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743018810557984  LUMO = 2.29765128107003
  mo_energy =
[-3.25525936e+01 -1.85682568e+00 -7.43018811e-01 -7.43018811e-01
 -7.43018811e-01  2.29765128e+00  2.65417688e+00  2.65417688e+00
  2.65417688e+00  1.99389767e+01  1.99389767e+01  1.99389767e+01
  2.88588809e+01  1.67876858e+02  7.99886132e+02  4.57444592e+03]
E1 = -182.18475992168462  E_coul = 53.90717355964644
cycle= 1 E= -128.277586362038  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269202
diis-c [-0.07246991  1.        ]
  HOMO = -0.810118109149365  LUMO = 2.25341726533152
  mo_energy =
[-3.28311625e+01 -1.92509487e+00 -8.10118109e-01 -8.10118109e-01
 -8.10118109e-01  2.25341727e+00  2.59810943e+00  2.59810943e+00
  2.59810943e+00  1.97440103e+01  1.97440103e+01  1.97440103e+01
  2.86529884e+01  1.67587378e+02  7.99546414e+02  4.57406417e+03]
E1 = -182.65791907397588  E_coul = 54.37864081209637
cycle= 2 E= -128.27927826188  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105707
diis-c [-2.21339168e-04  2.80240726e-01  7.19759274e-01]
  HOMO = -0.786866542869851  LUMO = 2.27096945141126
  mo_energy =
[-3.27550112e+01 -1.90104226e+00 -7.86866543e-01 -7.86866543e-01
 -7.86866543e-01  2.27096945e+00  2.61914103e+00  2.61914103e+00
  2.61914103e+00  1.98012275e+01  1.98012275e+01  1.98012275e+01
  2.87125008e+01  1.67665679e+02  7.99632687e+02  4.57415425e+03]
E1 = -182.52261499751526  E_coul = 54.24301795468783
cycle= 3 E= -128.279597042827  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695847
diis-c [-3.49115162e-08 -4.49964882e-03 -5.23945452e-03  1.00973910e+00]
  HOMO = -0.787052441527613  LUMO = 2.27083436080397
  mo_energy =
[-3.27554751e+01 -1.90125532e+00 -7.87052442e-01 -7.87052442e-01
 -7.87052442e-01  2.27083436e+00  2.61901126e+00  2.61901126e+00
  2.61901126e+00  1.98008574e+01  1.98008574e+01  1.98008574e+01
  2.87120794e+01  1.67665305e+02  7.99632459e+02  4.57415412e+03]
E1 = -182.52353764622032  E_coul = 54.24394058821764
cycle= 4 E= -128.279597058003  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.72476e-05
diis-c [-1.38185874e-10  2.43405512e-04 -2.00669152e-04 -8.11042458e-02
  1.08106151e+00]
  HOMO = -0.787045335045474  LUMO = 2.27083607190224
  mo_energy =
[-3.27554571e+01 -1.90125231e+00 -7.87045335e-01 -7.87045335e-01
 -7.87045335e-01  2.27083607e+00  2.61901721e+00  2.61901721e+00
  2.61901721e+00  1.98008718e+01  1.98008718e+01  1.98008718e+01
  2.87120921e+01  1.67665326e+02  7.99632488e+02  4.57415415e+03]
E1 = -182.52350768551662  E_coul = 54.24391062746528
cycle= 5 E= -128.279597058051  delta_E= -4.87e-11  |g|= 1.8e-06  |ddm|= 8.75e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350768551662  E_coul = 54.24391062746528
  HOMO = -0.787044924271033  LUMO = 2.27083603437947
  mo_energy =
[-3.27554561e+01 -1.90125234e+00 -7.87044924e-01 -7.87044924e-01
 -7.87044924e-01  2.27083603e+00  2.61901759e+00  2.61901759e+00
  2.61901759e+00  1.98008725e+01  1.98008725e+01  1.98008725e+01
  2.87120927e+01  1.67665327e+02  7.99632489e+02  4.57415415e+03]
E1 = -182.52350619656656  E_coul = 54.243909138514844
Extra cycle  E= -128.279597058052  delta_E= -3.69e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24936432854278
E1 = -182.52350619656656  E_coul = 54.243909138514844
init E= -128.279597058052
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787045004867773  LUMO = 2.27083590539562
  mo_energy =
[-3.27554564e+01 -1.90125251e+00 -7.87045005e-01 -7.87045005e-01
 -7.87045005e-01  2.27083591e+00  2.61901751e+00  2.61901751e+00
  2.61901751e+00  1.98008723e+01  1.98008723e+01  1.98008723e+01
  2.87120925e+01  1.67665327e+02  7.99632489e+02  4.57415415e+03]
E1 = -182.52350683790067  E_coul = 54.24390977984895
cycle= 1 E= -128.279597058052  delta_E=    0  |g|= 1.02e-07  |ddm|= 2.42e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52350683790067  E_coul = 54.24390977984895
  HOMO = -0.787044956896036  LUMO = 2.27083592890933
  mo_energy =
[-3.27554563e+01 -1.90125248e+00 -7.87044957e-01 -7.87044957e-01
 -7.87044957e-01  2.27083593e+00  2.61901755e+00  2.61901755e+00
  2.61901755e+00  1.98008724e+01  1.98008724e+01  1.98008724e+01
  2.87120926e+01  1.67665327e+02  7.99632489e+02  4.57415415e+03]
E1 = -182.5235065914458  E_coul = 54.243909533394046
Extra cycle  E= -128.279597058052  delta_E= -5.68e-14  |g|= 3.67e-08  |ddm|= 4.03e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43901639e+03 1.05815619e+02 4.21914631e+02 5.15907416e-01
 3.15082039e+01 1.02407588e+01 1.75509190e+00 2.77503301e+00
 1.33214929e+01 5.99944371e-01]
grad_E = [-1.09347861e-05 -1.32179944e-06 -3.22004526e-06 -3.08017222e-06
  8.93611039e-06 -1.71023265e-05 -5.90863402e-06  4.17592050e-05
 -1.30824205e-05  5.41970923e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.02280301        1
[INPUT] 0    0    [1    /1   ]  105.818843243        1
[INPUT] 0    0    [1    /1   ]  421.908448348        1
[INPUT] 0    0    [1    /1   ]  0.515894593239       1
[INPUT] 0    0    [1    /1   ]  31.5103572203        1
[INPUT] 0    0    [1    /1   ]  10.2410431906        1
[INPUT] 0    0    [1    /1   ]  1.75504532803        1
[INPUT] 1    0    [1    /1   ]  2.77498480436        1
[INPUT] 1    0    [1    /1   ]  13.3207898018        1
[INPUT] 1    0    [1    /1   ]  0.599942588172       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.022803014838, 1.0]], [0, [105.81884324315118, 1.0]], [0, [421.9084483480291, 1.0]], [0, [0.5158945932386301, 1.0]], [0, [31.51035722033206, 1.0]], [0, [10.241043190619925, 1.0]], [0, [1.7550453280264648, 1.0]], [1, [2.7749848043634118, 1.0]], [1, [13.320789801816396, 1.0]], [1, [0.5999425881719365, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.02280301]
bas 1, expnt(s) = [105.81884324]
bas 2, expnt(s) = [421.90844835]
bas 3, expnt(s) = [0.51589459]
bas 4, expnt(s) = [31.51035722]
bas 5, expnt(s) = [10.24104319]
bas 6, expnt(s) = [1.75504533]
bas 7, expnt(s) = [2.7749848]
bas 8, expnt(s) = [13.3207898]
bas 9, expnt(s) = [0.59994259]
CPU time:       371.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43902280e+03 8.76853258e+02 1.05818843e+02 8.33560798e+01
 4.21908448e+02 2.35195328e+02 5.15894593e-01 1.53792712e+00
 3.15103572e+01 3.36012179e+01 1.02410432e+01 1.44634924e+01
 1.75504533e+00 3.85239914e+00 2.77498480e+00 1.04486493e+01
 1.33207898e+01 7.42415212e+01 5.99942588e-01 1.54035743e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966902014914954
cond(S) = 77.24928079834316
E1 = -183.22909661556622  E_coul = 55.0078688804694
init E= -128.221227735097
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74301817507951  LUMO = 2.2975618000118
  mo_energy =
[-3.25525958e+01 -1.85682514e+00 -7.43018175e-01 -7.43018175e-01
 -7.43018175e-01  2.29756180e+00  2.65415491e+00  2.65415491e+00
  2.65415491e+00  1.99380854e+01  1.99380854e+01  1.99380854e+01
  2.88600482e+01  1.67885541e+02  7.99897714e+02  4.57445352e+03]
E1 = -182.18475826544122  E_coul = 53.90717188504968
cycle= 1 E= -128.277586380392  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269205
diis-c [-0.07247133  1.        ]
  HOMO = -0.810117977086519  LUMO = 2.25332927757525
  mo_energy =
[-3.28311643e+01 -1.92509432e+00 -8.10117977e-01 -8.10117977e-01
 -8.10117977e-01  2.25332928e+00  2.59808767e+00  2.59808767e+00
  2.59808767e+00  1.97431229e+01  1.97431229e+01  1.97431229e+01
  2.86541513e+01  1.67596058e+02  7.99557998e+02  4.57407178e+03]
E1 = -182.65792013809602  E_coul = 54.37864185194242
cycle= 2 E= -128.279278286154  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105708
diis-c [-2.21335212e-04  2.80240420e-01  7.19759580e-01]
  HOMO = -0.786866236807895  LUMO = 2.27088116060455
  mo_energy =
[-3.27550127e+01 -1.90104151e+00 -7.86866237e-01 -7.86866237e-01
 -7.86866237e-01  2.27088116e+00  2.61911920e+00  2.61911920e+00
  2.61911920e+00  1.98003392e+01  1.98003392e+01  1.98003392e+01
  2.87136651e+01  1.67674360e+02  7.99644271e+02  4.57416185e+03]
E1 = -182.5226147503351  E_coul = 54.243017679151684
cycle= 3 E= -128.279597071183  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695984
diis-c [-3.48701089e-08 -4.49825167e-03 -5.23405454e-03  1.00973231e+00]
  HOMO = -0.787052171381672  LUMO = 2.27074607019937
  mo_energy =
[-3.27554767e+01 -1.90125458e+00 -7.87052171e-01 -7.87052171e-01
 -7.87052171e-01  2.27074607e+00  2.61898940e+00  2.61898940e+00
  2.61898940e+00  1.97999691e+01  1.97999691e+01  1.97999691e+01
  2.87132436e+01  1.67673986e+02  7.99644043e+02  4.57416172e+03]
E1 = -182.5235375635726  E_coul = 54.243940477210785
cycle= 4 E= -128.279597086362  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.72132e-05
diis-c [-1.37918117e-10  2.43169364e-04 -2.00790377e-04 -8.10495263e-02
  1.08100715e+00]
  HOMO = -0.787045071295403  LUMO = 2.27074778092519
  mo_energy =
[-3.27554586e+01 -1.90125158e+00 -7.87045071e-01 -7.87045071e-01
 -7.87045071e-01  2.27074778e+00  2.61899535e+00  2.61899535e+00
  2.61899535e+00  1.97999834e+01  1.97999834e+01  1.97999834e+01
  2.87132563e+01  1.67674007e+02  7.99644071e+02  4.57416176e+03]
E1 = -182.5235076276597  E_coul = 54.24391054124932
cycle= 5 E= -128.27959708641  delta_E= -4.85e-11  |g|= 1.79e-06  |ddm|= 8.73e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5235076276597  E_coul = 54.24391054124932
  HOMO = -0.787044660659812  LUMO = 2.27074774359312
  mo_energy =
[-3.27554577e+01 -1.90125161e+00 -7.87044661e-01 -7.87044661e-01
 -7.87044661e-01  2.27074774e+00  2.61899572e+00  2.61899572e+00
  2.61899572e+00  1.97999842e+01  1.97999842e+01  1.97999842e+01
  2.87132570e+01  1.67674008e+02  7.99644073e+02  4.57416176e+03]
E1 = -182.52350613890104  E_coul = 54.243909052490174
Extra cycle  E= -128.279597086411  delta_E= -4.83e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43902280e+03 1.05818843e+02 4.21908448e+02 5.15894593e-01
 3.15103572e+01 1.02410432e+01 1.75504533e+00 2.77498480e+00
 1.33207898e+01 5.99942588e-01]
E = -128.27959708641086
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:50:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.02280301        1
[INPUT] 0    0    [1    /1   ]  105.818843243        1
[INPUT] 0    0    [1    /1   ]  421.908448348        1
[INPUT] 0    0    [1    /1   ]  0.515894593239       1
[INPUT] 0    0    [1    /1   ]  31.5103572203        1
[INPUT] 0    0    [1    /1   ]  10.2410431906        1
[INPUT] 0    0    [1    /1   ]  1.75504532803        1
[INPUT] 1    0    [1    /1   ]  2.77498480436        1
[INPUT] 1    0    [1    /1   ]  13.3207898018        1
[INPUT] 1    0    [1    /1   ]  0.599942588172       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.022803014838, 1.0]], [0, [105.81884324315118, 1.0]], [0, [421.9084483480291, 1.0]], [0, [0.5158945932386301, 1.0]], [0, [31.51035722033206, 1.0]], [0, [10.241043190619925, 1.0]], [0, [1.7550453280264648, 1.0]], [1, [2.7749848043634118, 1.0]], [1, [13.320789801816396, 1.0]], [1, [0.5999425881719365, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.02280301]
bas 1, expnt(s) = [105.81884324]
bas 2, expnt(s) = [421.90844835]
bas 3, expnt(s) = [0.51589459]
bas 4, expnt(s) = [31.51035722]
bas 5, expnt(s) = [10.24104319]
bas 6, expnt(s) = [1.75504533]
bas 7, expnt(s) = [2.7749848]
bas 8, expnt(s) = [13.3207898]
bas 9, expnt(s) = [0.59994259]
CPU time:       372.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43902280e+03 8.76853258e+02 1.05818843e+02 8.33560798e+01
 4.21908448e+02 2.35195328e+02 5.15894593e-01 1.53792712e+00
 3.15103572e+01 3.36012179e+01 1.02410432e+01 1.44634924e+01
 1.75504533e+00 3.85239914e+00 2.77498480e+00 1.04486493e+01
 1.33207898e+01 7.42415212e+01 5.99942588e-01 1.54035743e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966902014914954
cond(S) = 77.24928079834316
E1 = -183.22909661556622  E_coul = 55.0078688804694
init E= -128.221227735097
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74301817507951  LUMO = 2.2975618000118
  mo_energy =
[-3.25525958e+01 -1.85682514e+00 -7.43018175e-01 -7.43018175e-01
 -7.43018175e-01  2.29756180e+00  2.65415491e+00  2.65415491e+00
  2.65415491e+00  1.99380854e+01  1.99380854e+01  1.99380854e+01
  2.88600482e+01  1.67885541e+02  7.99897714e+02  4.57445352e+03]
E1 = -182.18475826544122  E_coul = 53.90717188504968
cycle= 1 E= -128.277586380392  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269205
diis-c [-0.07247133  1.        ]
  HOMO = -0.810117977086519  LUMO = 2.25332927757525
  mo_energy =
[-3.28311643e+01 -1.92509432e+00 -8.10117977e-01 -8.10117977e-01
 -8.10117977e-01  2.25332928e+00  2.59808767e+00  2.59808767e+00
  2.59808767e+00  1.97431229e+01  1.97431229e+01  1.97431229e+01
  2.86541513e+01  1.67596058e+02  7.99557998e+02  4.57407178e+03]
E1 = -182.65792013809602  E_coul = 54.37864185194242
cycle= 2 E= -128.279278286154  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105708
diis-c [-2.21335212e-04  2.80240420e-01  7.19759580e-01]
  HOMO = -0.786866236807895  LUMO = 2.27088116060455
  mo_energy =
[-3.27550127e+01 -1.90104151e+00 -7.86866237e-01 -7.86866237e-01
 -7.86866237e-01  2.27088116e+00  2.61911920e+00  2.61911920e+00
  2.61911920e+00  1.98003392e+01  1.98003392e+01  1.98003392e+01
  2.87136651e+01  1.67674360e+02  7.99644271e+02  4.57416185e+03]
E1 = -182.5226147503351  E_coul = 54.243017679151684
cycle= 3 E= -128.279597071183  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000695984
diis-c [-3.48701089e-08 -4.49825167e-03 -5.23405454e-03  1.00973231e+00]
  HOMO = -0.787052171381672  LUMO = 2.27074607019937
  mo_energy =
[-3.27554767e+01 -1.90125458e+00 -7.87052171e-01 -7.87052171e-01
 -7.87052171e-01  2.27074607e+00  2.61898940e+00  2.61898940e+00
  2.61898940e+00  1.97999691e+01  1.97999691e+01  1.97999691e+01
  2.87132436e+01  1.67673986e+02  7.99644043e+02  4.57416172e+03]
E1 = -182.5235375635726  E_coul = 54.243940477210785
cycle= 4 E= -128.279597086362  delta_E= -1.52e-08  |g|= 2.22e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.72132e-05
diis-c [-1.37918117e-10  2.43169364e-04 -2.00790377e-04 -8.10495263e-02
  1.08100715e+00]
  HOMO = -0.787045071295403  LUMO = 2.27074778092519
  mo_energy =
[-3.27554586e+01 -1.90125158e+00 -7.87045071e-01 -7.87045071e-01
 -7.87045071e-01  2.27074778e+00  2.61899535e+00  2.61899535e+00
  2.61899535e+00  1.97999834e+01  1.97999834e+01  1.97999834e+01
  2.87132563e+01  1.67674007e+02  7.99644071e+02  4.57416176e+03]
E1 = -182.5235076276597  E_coul = 54.24391054124932
cycle= 5 E= -128.27959708641  delta_E= -4.85e-11  |g|= 1.79e-06  |ddm|= 8.73e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5235076276597  E_coul = 54.24391054124932
  HOMO = -0.787044660659812  LUMO = 2.27074774359312
  mo_energy =
[-3.27554577e+01 -1.90125161e+00 -7.87044661e-01 -7.87044661e-01
 -7.87044661e-01  2.27074774e+00  2.61899572e+00  2.61899572e+00
  2.61899572e+00  1.97999842e+01  1.97999842e+01  1.97999842e+01
  2.87132570e+01  1.67674008e+02  7.99644073e+02  4.57416176e+03]
E1 = -182.52350613890104  E_coul = 54.243909052490174
Extra cycle  E= -128.279597086411  delta_E= -4.83e-13  |g|= 4.1e-07  |ddm|= 1.01e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24928079834316
E1 = -182.52350613890104  E_coul = 54.243909052490174
init E= -128.279597086411
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787044741261309  LUMO = 2.27074761466712
  mo_energy =
[-3.27554580e+01 -1.90125178e+00 -7.87044741e-01 -7.87044741e-01
 -7.87044741e-01  2.27074761e+00  2.61899564e+00  2.61899564e+00
  2.61899564e+00  1.97999839e+01  1.97999839e+01  1.97999839e+01
  2.87132567e+01  1.67674008e+02  7.99644072e+02  4.57416176e+03]
E1 = -182.5235067801292  E_coul = 54.243909693718145
cycle= 1 E= -128.279597086411  delta_E= -1.99e-13  |g|= 1.02e-07  |ddm|= 2.42e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5235067801292  E_coul = 54.243909693718145
  HOMO = -0.787044693300125  LUMO = 2.27074763818298
  mo_energy =
[-3.27554579e+01 -1.90125174e+00 -7.87044693e-01 -7.87044693e-01
 -7.87044693e-01  2.27074764e+00  2.61899569e+00  2.61899569e+00
  2.61899569e+00  1.97999840e+01  1.97999840e+01  1.97999840e+01
  2.87132568e+01  1.67674008e+02  7.99644073e+02  4.57416176e+03]
E1 = -182.5235065337089  E_coul = 54.24390944729799
Extra cycle  E= -128.279597086411  delta_E= 1.42e-13  |g|= 3.67e-08  |ddm|= 4.03e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.43902280e+03 1.05818843e+02 4.21908448e+02 5.15894593e-01
 3.15103572e+01 1.02410432e+01 1.75504533e+00 2.77498480e+00
 1.33207898e+01 5.99942588e-01]
grad_E = [-1.09322115e-05 -1.84310751e-06 -3.23956099e-06 -4.09569801e-06
  1.31545408e-05 -2.50450976e-05 -8.82046847e-06  5.95053829e-05
 -1.89253185e-05  7.99591398e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.03407136        1
[INPUT] 0    0    [1    /1   ]  105.823559642        1
[INPUT] 0    0    [1    /1   ]  421.899738188        1
[INPUT] 0    0    [1    /1   ]  0.515876044803       1
[INPUT] 0    0    [1    /1   ]  31.5134872195        1
[INPUT] 0    0    [1    /1   ]  10.2414574599        1
[INPUT] 0    0    [1    /1   ]  1.75497793712        1
[INPUT] 1    0    [1    /1   ]  2.77491501786        1
[INPUT] 1    0    [1    /1   ]  13.3197716888        1
[INPUT] 1    0    [1    /1   ]  0.599940012564       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0340713593455, 1.0]], [0, [105.82355964239542, 1.0]], [0, [421.8997381882822, 1.0]], [0, [0.5158760448034134, 1.0]], [0, [31.51348721948755, 1.0]], [0, [10.241457459866309, 1.0]], [0, [1.754977937116897, 1.0]], [1, [2.7749150178580346, 1.0]], [1, [13.319771688824945, 1.0]], [1, [0.5999400125639534, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.03407136]
bas 1, expnt(s) = [105.82355964]
bas 2, expnt(s) = [421.89973819]
bas 3, expnt(s) = [0.51587604]
bas 4, expnt(s) = [31.51348722]
bas 5, expnt(s) = [10.24145746]
bas 6, expnt(s) = [1.75497794]
bas 7, expnt(s) = [2.77491502]
bas 8, expnt(s) = [13.31977169]
bas 9, expnt(s) = [0.59994001]
CPU time:       376.25
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43903407e+03 8.76856296e+02 1.05823560e+02 8.33588662e+01
 4.21899738e+02 2.35191686e+02 5.15876045e-01 1.53788565e+00
 3.15134872e+01 3.36037212e+01 1.02414575e+01 1.44639312e+01
 1.75497794e+00 3.85228820e+00 2.77491502e+00 1.04483209e+01
 1.33197717e+01 7.42344283e+01 5.99940013e-01 1.54034916e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966902971755038
cond(S) = 77.24912237497006
E1 = -183.22910109903492  E_coul = 55.00786976947146
init E= -128.221231329563
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743017253781079  LUMO = 2.29743238397807
  mo_energy =
[-3.25525990e+01 -1.85682435e+00 -7.43017254e-01 -7.43017254e-01
 -7.43017254e-01  2.29743238e+00  2.65412313e+00  2.65412313e+00
  2.65412313e+00  1.99367949e+01  1.99367949e+01  1.99367949e+01
  2.88617487e+01  1.67898192e+02  7.99914934e+02  4.57446801e+03]
E1 = -182.18475591240352  E_coul = 53.90716949815574
cycle= 1 E= -128.277586414248  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269209
diis-c [-0.07247337  1.        ]
  HOMO = -0.810117781767846  LUMO = 2.25320202168223
  mo_energy =
[-3.28311669e+01 -1.92509351e+00 -8.10117782e-01 -8.10117782e-01
 -8.10117782e-01  2.25320202e+00  2.59805621e+00  2.59805621e+00
  2.59805621e+00  1.97418379e+01  1.97418379e+01  1.97418379e+01
  2.86558455e+01  1.67608706e+02  7.99575221e+02  4.57408627e+03]
E1 = -182.65792170684426  E_coul = 54.37864337835867
cycle= 2 E= -128.279278328486  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105709
diis-c [-2.21329527e-04  2.80239975e-01  7.19760025e-01]
  HOMO = -0.786865790304445  LUMO = 2.27075346656112
  mo_energy =
[-3.27550148e+01 -1.90104043e+00 -7.86865790e-01 -7.86865790e-01
 -7.86865790e-01  2.27075347e+00  2.61908763e+00  2.61908763e+00
  2.61908763e+00  1.97990531e+01  1.97990531e+01  1.97990531e+01
  2.87153612e+01  1.67687009e+02  7.99661493e+02  4.57417634e+03]
E1 = -182.5226144258677  E_coul = 54.243017306466825
cycle= 3 E= -128.279597119401  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000696183
diis-c [-3.48102070e-08 -4.49622806e-03 -5.22623294e-03  1.00972246e+00]
  HOMO = -0.787051776905855  LUMO = 2.27061837641541
  mo_energy =
[-3.27554789e+01 -1.90125351e+00 -7.87051777e-01 -7.87051777e-01
 -7.87051777e-01  2.27061838e+00  2.61895778e+00  2.61895778e+00
  2.61895778e+00  1.97986829e+01  1.97986829e+01  1.97986829e+01
  2.87149397e+01  1.67686635e+02  7.99661265e+02  4.57417621e+03]
E1 = -182.5235374775118  E_coul = 54.24394034292765
cycle= 4 E= -128.279597134584  delta_E= -1.52e-08  |g|= 2.21e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.71634e-05
diis-c [-1.37530734e-10  2.42827051e-04 -2.00966151e-04 -8.09702061e-02
  1.08092835e+00]
  HOMO = -0.787044686079375  LUMO = 2.27062008660201
  mo_energy =
[-3.27554609e+01 -1.90125051e+00 -7.87044686e-01 -7.87044686e-01
 -7.87044686e-01  2.27062009e+00  2.61896372e+00  2.61896372e+00
  2.61896372e+00  1.97986972e+01  1.97986972e+01  1.97986972e+01
  2.87149524e+01  1.67686656e+02  7.99661293e+02  4.57417625e+03]
E1 = -182.52350757748945  E_coul = 54.24391044285662
cycle= 5 E= -128.279597134633  delta_E= -4.87e-11  |g|= 1.79e-06  |ddm|= 8.72e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350757748945  E_coul = 54.24391044285662
  HOMO = -0.787044275645346  LUMO = 2.27062004954618
  mo_energy =
[-3.27554600e+01 -1.90125053e+00 -7.87044276e-01 -7.87044276e-01
 -7.87044276e-01  2.27062005e+00  2.61896409e+00  2.61896409e+00
  2.61896409e+00  1.97986979e+01  1.97986979e+01  1.97986979e+01
  2.87149530e+01  1.67686657e+02  7.99661295e+02  4.57417625e+03]
E1 = -182.5235060890093  E_coul = 54.24390895437602
Extra cycle  E= -128.279597134633  delta_E= -4.26e-13  |g|= 4.09e-07  |ddm|= 1e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43903407e+03 1.05823560e+02 4.21899738e+02 5.15876045e-01
 3.15134872e+01 1.02414575e+01 1.75497794e+00 2.77491502e+00
 1.33197717e+01 5.99940013e-01]
E = -128.27959713463326
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.03407136        1
[INPUT] 0    0    [1    /1   ]  105.823559642        1
[INPUT] 0    0    [1    /1   ]  421.899738188        1
[INPUT] 0    0    [1    /1   ]  0.515876044803       1
[INPUT] 0    0    [1    /1   ]  31.5134872195        1
[INPUT] 0    0    [1    /1   ]  10.2414574599        1
[INPUT] 0    0    [1    /1   ]  1.75497793712        1
[INPUT] 1    0    [1    /1   ]  2.77491501786        1
[INPUT] 1    0    [1    /1   ]  13.3197716888        1
[INPUT] 1    0    [1    /1   ]  0.599940012564       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0340713593455, 1.0]], [0, [105.82355964239542, 1.0]], [0, [421.8997381882822, 1.0]], [0, [0.5158760448034134, 1.0]], [0, [31.51348721948755, 1.0]], [0, [10.241457459866309, 1.0]], [0, [1.754977937116897, 1.0]], [1, [2.7749150178580346, 1.0]], [1, [13.319771688824945, 1.0]], [1, [0.5999400125639534, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.03407136]
bas 1, expnt(s) = [105.82355964]
bas 2, expnt(s) = [421.89973819]
bas 3, expnt(s) = [0.51587604]
bas 4, expnt(s) = [31.51348722]
bas 5, expnt(s) = [10.24145746]
bas 6, expnt(s) = [1.75497794]
bas 7, expnt(s) = [2.77491502]
bas 8, expnt(s) = [13.31977169]
bas 9, expnt(s) = [0.59994001]
CPU time:       377.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43903407e+03 8.76856296e+02 1.05823560e+02 8.33588662e+01
 4.21899738e+02 2.35191686e+02 5.15876045e-01 1.53788565e+00
 3.15134872e+01 3.36037212e+01 1.02414575e+01 1.44639312e+01
 1.75497794e+00 3.85228820e+00 2.77491502e+00 1.04483209e+01
 1.33197717e+01 7.42344283e+01 5.99940013e-01 1.54034916e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966902971755038
cond(S) = 77.24912237497006
E1 = -183.22910109903492  E_coul = 55.00786976947146
init E= -128.221231329563
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743017253781079  LUMO = 2.29743238397807
  mo_energy =
[-3.25525990e+01 -1.85682435e+00 -7.43017254e-01 -7.43017254e-01
 -7.43017254e-01  2.29743238e+00  2.65412313e+00  2.65412313e+00
  2.65412313e+00  1.99367949e+01  1.99367949e+01  1.99367949e+01
  2.88617487e+01  1.67898192e+02  7.99914934e+02  4.57446801e+03]
E1 = -182.18475591240352  E_coul = 53.90716949815574
cycle= 1 E= -128.277586414248  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269209
diis-c [-0.07247337  1.        ]
  HOMO = -0.810117781767846  LUMO = 2.25320202168223
  mo_energy =
[-3.28311669e+01 -1.92509351e+00 -8.10117782e-01 -8.10117782e-01
 -8.10117782e-01  2.25320202e+00  2.59805621e+00  2.59805621e+00
  2.59805621e+00  1.97418379e+01  1.97418379e+01  1.97418379e+01
  2.86558455e+01  1.67608706e+02  7.99575221e+02  4.57408627e+03]
E1 = -182.65792170684426  E_coul = 54.37864337835867
cycle= 2 E= -128.279278328486  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105709
diis-c [-2.21329527e-04  2.80239975e-01  7.19760025e-01]
  HOMO = -0.786865790304445  LUMO = 2.27075346656112
  mo_energy =
[-3.27550148e+01 -1.90104043e+00 -7.86865790e-01 -7.86865790e-01
 -7.86865790e-01  2.27075347e+00  2.61908763e+00  2.61908763e+00
  2.61908763e+00  1.97990531e+01  1.97990531e+01  1.97990531e+01
  2.87153612e+01  1.67687009e+02  7.99661493e+02  4.57417634e+03]
E1 = -182.5226144258677  E_coul = 54.243017306466825
cycle= 3 E= -128.279597119401  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000696183
diis-c [-3.48102070e-08 -4.49622806e-03 -5.22623294e-03  1.00972246e+00]
  HOMO = -0.787051776905855  LUMO = 2.27061837641541
  mo_energy =
[-3.27554789e+01 -1.90125351e+00 -7.87051777e-01 -7.87051777e-01
 -7.87051777e-01  2.27061838e+00  2.61895778e+00  2.61895778e+00
  2.61895778e+00  1.97986829e+01  1.97986829e+01  1.97986829e+01
  2.87149397e+01  1.67686635e+02  7.99661265e+02  4.57417621e+03]
E1 = -182.5235374775118  E_coul = 54.24394034292765
cycle= 4 E= -128.279597134584  delta_E= -1.52e-08  |g|= 2.21e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.71634e-05
diis-c [-1.37530734e-10  2.42827051e-04 -2.00966151e-04 -8.09702061e-02
  1.08092835e+00]
  HOMO = -0.787044686079375  LUMO = 2.27062008660201
  mo_energy =
[-3.27554609e+01 -1.90125051e+00 -7.87044686e-01 -7.87044686e-01
 -7.87044686e-01  2.27062009e+00  2.61896372e+00  2.61896372e+00
  2.61896372e+00  1.97986972e+01  1.97986972e+01  1.97986972e+01
  2.87149524e+01  1.67686656e+02  7.99661293e+02  4.57417625e+03]
E1 = -182.52350757748945  E_coul = 54.24391044285662
cycle= 5 E= -128.279597134633  delta_E= -4.87e-11  |g|= 1.79e-06  |ddm|= 8.72e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350757748945  E_coul = 54.24391044285662
  HOMO = -0.787044275645346  LUMO = 2.27062004954618
  mo_energy =
[-3.27554600e+01 -1.90125053e+00 -7.87044276e-01 -7.87044276e-01
 -7.87044276e-01  2.27062005e+00  2.61896409e+00  2.61896409e+00
  2.61896409e+00  1.97986979e+01  1.97986979e+01  1.97986979e+01
  2.87149530e+01  1.67686657e+02  7.99661295e+02  4.57417625e+03]
E1 = -182.5235060890093  E_coul = 54.24390895437602
Extra cycle  E= -128.279597134633  delta_E= -4.26e-13  |g|= 4.09e-07  |ddm|= 1e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24912237497006
E1 = -182.5235060890093  E_coul = 54.24390895437602
init E= -128.279597134633
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787044356253651  LUMO = 2.2706199207041
  mo_energy =
[-3.27554603e+01 -1.90125070e+00 -7.87044356e-01 -7.87044356e-01
 -7.87044356e-01  2.27061992e+00  2.61896401e+00  2.61896401e+00
  2.61896401e+00  1.97986977e+01  1.97986977e+01  1.97986977e+01
  2.87149527e+01  1.67686656e+02  7.99661295e+02  4.57417625e+03]
E1 = -182.5235067300824  E_coul = 54.24390959544928
cycle= 1 E= -128.279597134633  delta_E= 1.42e-13  |g|= 1.02e-07  |ddm|= 2.42e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5235067300824  E_coul = 54.24390959544928
  HOMO = -0.787044308307818  LUMO = 2.27061994422305
  mo_energy =
[-3.27554602e+01 -1.90125067e+00 -7.87044308e-01 -7.87044308e-01
 -7.87044308e-01  2.27061994e+00  2.61896406e+00  2.61896406e+00
  2.61896406e+00  1.97986978e+01  1.97986978e+01  1.97986978e+01
  2.87149528e+01  1.67686657e+02  7.99661295e+02  4.57417625e+03]
E1 = -182.52350648371353  E_coul = 54.243909349080376
Extra cycle  E= -128.279597134633  delta_E= -2.84e-14  |g|= 3.66e-08  |ddm|= 4.03e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.43903407e+03 1.05823560e+02 4.21899738e+02 5.15876045e-01
 3.15134872e+01 1.02414575e+01 1.75497794e+00 2.77491502e+00
 1.33197717e+01 5.99940013e-01]
grad_E = [-1.09284462e-05 -2.59825211e-06 -3.26781973e-06 -5.56705483e-06
  1.92652520e-05 -3.65510751e-05 -1.30386137e-05  8.52129047e-05
 -2.73895850e-05  1.17278037e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:04 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.05323327        1
[INPUT] 0    0    [1    /1   ]  105.830029026        1
[INPUT] 0    0    [1    /1   ]  421.888443329        1
[INPUT] 0    0    [1    /1   ]  0.515851011354       1
[INPUT] 0    0    [1    /1   ]  31.5177420938        1
[INPUT] 0    0    [1    /1   ]  10.2420224183        1
[INPUT] 0    0    [1    /1   ]  1.75488693288        1
[INPUT] 1    0    [1    /1   ]  2.77482072416        1
[INPUT] 1    0    [1    /1   ]  13.3183954481        1
[INPUT] 1    0    [1    /1   ]  0.599936543848       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0532332660623, 1.0]], [0, [105.83002902628918, 1.0]], [0, [421.8884433288769, 1.0]], [0, [0.515851011354334, 1.0]], [0, [31.517742093767673, 1.0]], [0, [10.24202241829952, 1.0]], [0, [1.7548869328833412, 1.0]], [1, [2.7748207241603495, 1.0]], [1, [13.31839544812337, 1.0]], [1, [0.5999365438476296, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.05323327]
bas 1, expnt(s) = [105.83002903]
bas 2, expnt(s) = [421.88844333]
bas 3, expnt(s) = [0.51585101]
bas 4, expnt(s) = [31.51774209]
bas 5, expnt(s) = [10.24202242]
bas 6, expnt(s) = [1.75488693]
bas 7, expnt(s) = [2.77482072]
bas 8, expnt(s) = [13.31839545]
bas 9, expnt(s) = [0.59993654]
CPU time:       380.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43905323e+03 8.76861463e+02 1.05830029e+02 8.33626882e+01
 4.21888443e+02 2.35186964e+02 5.15851011e-01 1.53782968e+00
 3.15177421e+01 3.36071239e+01 1.02420224e+01 1.44645296e+01
 1.75488693e+00 3.85213838e+00 2.77482072e+00 1.04478771e+01
 1.33183954e+01 7.42248408e+01 5.99936544e-01 1.54033803e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966904261674795
cond(S) = 77.24883449757608
E1 = -183.22910714617282  E_coul = 55.00787096859276
init E= -128.22123617758
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743016006284962  LUMO = 2.29725776518351
  mo_energy =
[-3.25526032e+01 -1.85682329e+00 -7.43016006e-01 -7.43016006e-01
 -7.43016006e-01  2.29725777e+00  2.65408024e+00  2.65408024e+00
  2.65408024e+00  1.99350507e+01  1.99350507e+01  1.99350507e+01
  2.88640680e+01  1.67915449e+02  7.99939103e+02  4.57449448e+03]
E1 = -182.18475283389694  E_coul = 53.90716635796834
cycle= 1 E= -128.277586475929  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269214
diis-c [-0.07247613  1.        ]
  HOMO = -0.81011750898775  LUMO = 2.25303031880812
  mo_energy =
[-3.28311704e+01 -1.92509241e+00 -8.10117509e-01 -8.10117509e-01
 -8.10117509e-01  2.25303032e+00  2.59801375e+00  2.59801375e+00
  2.59801375e+00  1.97401012e+01  1.97401012e+01  1.97401012e+01
  2.86581563e+01  1.67625959e+02  7.99599392e+02  4.57411274e+03]
E1 = -182.65792389092215  E_coul = 54.37864548951901
cycle= 2 E= -128.279278401403  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105711
diis-c [-2.21321932e-04  2.80239368e-01  7.19760632e-01]
  HOMO = -0.786865179712128  LUMO = 2.27058117269512
  mo_energy =
[-3.27550177e+01 -1.90103897e+00 -7.86865180e-01 -7.86865180e-01
 -7.86865180e-01  2.27058117e+00  2.61904502e+00  2.61904502e+00
  2.61904502e+00  1.97973148e+01  1.97973148e+01  1.97973148e+01
  2.87176747e+01  1.67704263e+02  7.99685665e+02  4.57420281e+03]
E1 = -182.52261406317092  E_coul = 54.2430168629518
cycle= 3 E= -128.279597200219  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000696452
diis-c [-3.47293419e-08 -4.49349124e-03 -5.21565418e-03  1.00970915e+00]
  HOMO = -0.787051236687156  LUMO = 2.27044608283097
  mo_energy =
[-3.27554820e+01 -1.90125205e+00 -7.87051237e-01 -7.87051237e-01
 -7.87051237e-01  2.27044608e+00  2.61891511e+00  2.61891511e+00
  2.61891511e+00  1.97969444e+01  1.97969444e+01  1.97969444e+01
  2.87172530e+01  1.67703889e+02  7.99685437e+02  4.57420268e+03]
E1 = -182.52353743742324  E_coul = 54.243940222014366
cycle= 4 E= -128.279597215409  delta_E= -1.52e-08  |g|= 2.21e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.7096e-05
diis-c [-1.37007611e-10  2.42364258e-04 -2.01203027e-04 -8.08628810e-02
  1.08082172e+00]
  HOMO = -0.787044158374596  LUMO = 2.27044779228923
  mo_energy =
[-3.27554641e+01 -1.90124906e+00 -7.87044158e-01 -7.87044158e-01
 -7.87044158e-01  2.27044779e+00  2.61892103e+00  2.61892103e+00
  2.61892103e+00  1.97969587e+01  1.97969587e+01  1.97969587e+01
  2.87172657e+01  1.67703910e+02  7.99685465e+02  4.57420272e+03]
E1 = -182.52350758590117  E_coul = 54.243910370443984
cycle= 5 E= -128.279597215457  delta_E= -4.83e-11  |g|= 1.79e-06  |ddm|= 8.69e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350758590117  E_coul = 54.243910370443984
  HOMO = -0.787043748214596  LUMO = 2.27044775560626
  mo_energy =
[-3.27554631e+01 -1.90124908e+00 -7.87043748e-01 -7.87043748e-01
 -7.87043748e-01  2.27044776e+00  2.61892141e+00  2.61892141e+00
  2.61892141e+00  1.97969594e+01  1.97969594e+01  1.97969594e+01
  2.87172664e+01  1.67703911e+02  7.99685466e+02  4.57420272e+03]
E1 = -182.5235060978043  E_coul = 54.24390888234683
Extra cycle  E= -128.279597215457  delta_E= -2.84e-13  |g|= 4.09e-07  |ddm|= 1e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43905323e+03 1.05830029e+02 4.21888443e+02 5.15851011e-01
 3.15177421e+01 1.02420224e+01 1.75488693e+00 2.77482072e+00
 1.33183954e+01 5.99936544e-01]
E = -128.27959721545747
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:06 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.05323327        1
[INPUT] 0    0    [1    /1   ]  105.830029026        1
[INPUT] 0    0    [1    /1   ]  421.888443329        1
[INPUT] 0    0    [1    /1   ]  0.515851011354       1
[INPUT] 0    0    [1    /1   ]  31.5177420938        1
[INPUT] 0    0    [1    /1   ]  10.2420224183        1
[INPUT] 0    0    [1    /1   ]  1.75488693288        1
[INPUT] 1    0    [1    /1   ]  2.77482072416        1
[INPUT] 1    0    [1    /1   ]  13.3183954481        1
[INPUT] 1    0    [1    /1   ]  0.599936543848       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0532332660623, 1.0]], [0, [105.83002902628918, 1.0]], [0, [421.8884433288769, 1.0]], [0, [0.515851011354334, 1.0]], [0, [31.517742093767673, 1.0]], [0, [10.24202241829952, 1.0]], [0, [1.7548869328833412, 1.0]], [1, [2.7748207241603495, 1.0]], [1, [13.31839544812337, 1.0]], [1, [0.5999365438476296, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.05323327]
bas 1, expnt(s) = [105.83002903]
bas 2, expnt(s) = [421.88844333]
bas 3, expnt(s) = [0.51585101]
bas 4, expnt(s) = [31.51774209]
bas 5, expnt(s) = [10.24202242]
bas 6, expnt(s) = [1.75488693]
bas 7, expnt(s) = [2.77482072]
bas 8, expnt(s) = [13.31839545]
bas 9, expnt(s) = [0.59993654]
CPU time:       382.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43905323e+03 8.76861463e+02 1.05830029e+02 8.33626882e+01
 4.21888443e+02 2.35186964e+02 5.15851011e-01 1.53782968e+00
 3.15177421e+01 3.36071239e+01 1.02420224e+01 1.44645296e+01
 1.75488693e+00 3.85213838e+00 2.77482072e+00 1.04478771e+01
 1.33183954e+01 7.42248408e+01 5.99936544e-01 1.54033803e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966904261674795
cond(S) = 77.24883449757608
E1 = -183.22910714617282  E_coul = 55.00787096859276
init E= -128.22123617758
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743016006284962  LUMO = 2.29725776518351
  mo_energy =
[-3.25526032e+01 -1.85682329e+00 -7.43016006e-01 -7.43016006e-01
 -7.43016006e-01  2.29725777e+00  2.65408024e+00  2.65408024e+00
  2.65408024e+00  1.99350507e+01  1.99350507e+01  1.99350507e+01
  2.88640680e+01  1.67915449e+02  7.99939103e+02  4.57449448e+03]
E1 = -182.18475283389694  E_coul = 53.90716635796834
cycle= 1 E= -128.277586475929  delta_E= -0.0564  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269214
diis-c [-0.07247613  1.        ]
  HOMO = -0.81011750898775  LUMO = 2.25303031880812
  mo_energy =
[-3.28311704e+01 -1.92509241e+00 -8.10117509e-01 -8.10117509e-01
 -8.10117509e-01  2.25303032e+00  2.59801375e+00  2.59801375e+00
  2.59801375e+00  1.97401012e+01  1.97401012e+01  1.97401012e+01
  2.86581563e+01  1.67625959e+02  7.99599392e+02  4.57411274e+03]
E1 = -182.65792389092215  E_coul = 54.37864548951901
cycle= 2 E= -128.279278401403  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105711
diis-c [-2.21321932e-04  2.80239368e-01  7.19760632e-01]
  HOMO = -0.786865179712128  LUMO = 2.27058117269512
  mo_energy =
[-3.27550177e+01 -1.90103897e+00 -7.86865180e-01 -7.86865180e-01
 -7.86865180e-01  2.27058117e+00  2.61904502e+00  2.61904502e+00
  2.61904502e+00  1.97973148e+01  1.97973148e+01  1.97973148e+01
  2.87176747e+01  1.67704263e+02  7.99685665e+02  4.57420281e+03]
E1 = -182.52261406317092  E_coul = 54.2430168629518
cycle= 3 E= -128.279597200219  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000696452
diis-c [-3.47293419e-08 -4.49349124e-03 -5.21565418e-03  1.00970915e+00]
  HOMO = -0.787051236687156  LUMO = 2.27044608283097
  mo_energy =
[-3.27554820e+01 -1.90125205e+00 -7.87051237e-01 -7.87051237e-01
 -7.87051237e-01  2.27044608e+00  2.61891511e+00  2.61891511e+00
  2.61891511e+00  1.97969444e+01  1.97969444e+01  1.97969444e+01
  2.87172530e+01  1.67703889e+02  7.99685437e+02  4.57420268e+03]
E1 = -182.52353743742324  E_coul = 54.243940222014366
cycle= 4 E= -128.279597215409  delta_E= -1.52e-08  |g|= 2.21e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.7096e-05
diis-c [-1.37007611e-10  2.42364258e-04 -2.01203027e-04 -8.08628810e-02
  1.08082172e+00]
  HOMO = -0.787044158374596  LUMO = 2.27044779228923
  mo_energy =
[-3.27554641e+01 -1.90124906e+00 -7.87044158e-01 -7.87044158e-01
 -7.87044158e-01  2.27044779e+00  2.61892103e+00  2.61892103e+00
  2.61892103e+00  1.97969587e+01  1.97969587e+01  1.97969587e+01
  2.87172657e+01  1.67703910e+02  7.99685465e+02  4.57420272e+03]
E1 = -182.52350758590117  E_coul = 54.243910370443984
cycle= 5 E= -128.279597215457  delta_E= -4.83e-11  |g|= 1.79e-06  |ddm|= 8.69e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350758590117  E_coul = 54.243910370443984
  HOMO = -0.787043748214596  LUMO = 2.27044775560626
  mo_energy =
[-3.27554631e+01 -1.90124908e+00 -7.87043748e-01 -7.87043748e-01
 -7.87043748e-01  2.27044776e+00  2.61892141e+00  2.61892141e+00
  2.61892141e+00  1.97969594e+01  1.97969594e+01  1.97969594e+01
  2.87172664e+01  1.67703911e+02  7.99685466e+02  4.57420272e+03]
E1 = -182.5235060978043  E_coul = 54.24390888234683
Extra cycle  E= -128.279597215457  delta_E= -2.84e-13  |g|= 4.09e-07  |ddm|= 1e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24883449757608
E1 = -182.5235060978043  E_coul = 54.24390888234683
init E= -128.279597215457
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787043828831691  LUMO = 2.2704476268781
  mo_energy =
[-3.27554634e+01 -1.90124925e+00 -7.87043829e-01 -7.87043829e-01
 -7.87043829e-01  2.27044763e+00  2.61892133e+00  2.61892133e+00
  2.61892133e+00  1.97969592e+01  1.97969592e+01  1.97969592e+01
  2.87172661e+01  1.67703910e+02  7.99685466e+02  4.57420272e+03]
E1 = -182.5235067386654  E_coul = 54.243909523207876
cycle= 1 E= -128.279597215457  delta_E= -2.84e-14  |g|= 1.02e-07  |ddm|= 2.42e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5235067386654  E_coul = 54.243909523207876
  HOMO = -0.787043780906836  LUMO = 2.27044765040105
  mo_energy =
[-3.27554633e+01 -1.90124922e+00 -7.87043781e-01 -7.87043781e-01
 -7.87043781e-01  2.27044765e+00  2.61892138e+00  2.61892138e+00
  2.61892138e+00  1.97969593e+01  1.97969593e+01  1.97969593e+01
  2.87172662e+01  1.67703910e+02  7.99685466e+02  4.57420272e+03]
E1 = -182.5235064923673  E_coul = 54.24390927690959
Extra cycle  E= -128.279597215458  delta_E= -1.99e-13  |g|= 3.66e-08  |ddm|= 4.02e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43905323e+03 1.05830029e+02 4.21888443e+02 5.15851011e-01
 3.15177421e+01 1.02420224e+01 1.75488693e+00 2.77482072e+00
 1.33183954e+01 5.99936544e-01]
grad_E = [-1.09232828e-05 -3.61965393e-06 -3.30602030e-06 -7.55796289e-06
  2.75304467e-05 -5.21133751e-05 -1.87435205e-05  1.19982840e-04
 -3.88377003e-05  1.67755109e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.08437411        1
[INPUT] 0    0    [1    /1   ]  105.838221021        1
[INPUT] 0    0    [1    /1   ]  421.875348698        1
[INPUT] 0    0    [1    /1   ]  0.515820065471       1
[INPUT] 0    0    [1    /1   ]  31.5230586663        1
[INPUT] 0    0    [1    /1   ]  10.2427316413        1
[INPUT] 0    0    [1    /1   ]  1.75477433631        1
[INPUT] 1    0    [1    /1   ]  2.77470395461        1
[INPUT] 1    0    [1    /1   ]  13.3166900962        1
[INPUT] 1    0    [1    /1   ]  0.599932268766       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0843741079498, 1.0]], [0, [105.8382210214008, 1.0]], [0, [421.8753486979483, 1.0]], [0, [0.5158200654711552, 1.0]], [0, [31.52305866631772, 1.0]], [0, [10.242731641289108, 1.0]], [0, [1.7547743363087052, 1.0]], [1, [2.7747039546073937, 1.0]], [1, [13.316690096207575, 1.0]], [1, [0.5999322687658895, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.08437411]
bas 1, expnt(s) = [105.83822102]
bas 2, expnt(s) = [421.8753487]
bas 3, expnt(s) = [0.51582007]
bas 4, expnt(s) = [31.52305867]
bas 5, expnt(s) = [10.24273164]
bas 6, expnt(s) = [1.75477434]
bas 7, expnt(s) = [2.77470395]
bas 8, expnt(s) = [13.3166901]
bas 9, expnt(s) = [0.59993227]
CPU time:       385.37
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43908437e+03 8.76869859e+02 1.05838221e+02 8.33675278e+01
 4.21875349e+02 2.35181489e+02 5.15820065e-01 1.53776049e+00
 3.15230587e+01 3.36113756e+01 1.02427316e+01 1.44652808e+01
 1.75477434e+00 3.85195300e+00 2.77470395e+00 1.04473275e+01
 1.33166901e+01 7.42129608e+01 5.99932269e-01 1.54032431e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966905853846514
cond(S) = 77.24833708281388
E1 = -183.22911462893353  E_coul = 55.00787245233754
init E= -128.221242176596
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743014456878584  LUMO = 2.29704198334013
  mo_energy =
[-3.25526086e+01 -1.85682198e+00 -7.43014457e-01 -7.43014457e-01
 -7.43014457e-01  2.29704198e+00  2.65402722e+00  2.65402722e+00
  2.65402722e+00  1.99328897e+01  1.99328897e+01  1.99328897e+01
  2.88669803e+01  1.67937123e+02  7.99970722e+02  4.57454023e+03]
E1 = -182.1847492229008  E_coul = 53.90716263242857
cycle= 1 E= -128.277586590472  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26922
diis-c [-0.07247952  1.        ]
  HOMO = -0.810117154950838  LUMO = 2.25281814265317
  mo_energy =
[-3.28311748e+01 -1.92509104e+00 -8.10117155e-01 -8.10117155e-01
 -8.10117155e-01  2.25281814e+00  2.59796128e+00  2.59796128e+00
  2.59796128e+00  1.97379496e+01  1.97379496e+01  1.97379496e+01
  2.86610579e+01  1.67647628e+02  7.99631015e+02  4.57415849e+03]
E1 = -182.65792672855204  E_coul = 54.37864819909994
cycle= 2 E= -128.279278529452  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105713
diis-c [-2.21312686e-04  2.80238605e-01  7.19761395e-01]
  HOMO = -0.786864410321685  LUMO = 2.27036826658947
  mo_energy =
[-3.27550213e+01 -1.90103714e+00 -7.86864410e-01 -7.86864410e-01
 -7.86864410e-01  2.27036827e+00  2.61899236e+00  2.61899236e+00
  2.61899236e+00  1.97951612e+01  1.97951612e+01  1.97951612e+01
  2.87205797e+01  1.67725934e+02  7.99717288e+02  4.57424856e+03]
E1 = -182.5226137680987  E_coul = 54.24301643014389
cycle= 3 E= -128.279597337955  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000696787
diis-c [-3.46293115e-08 -4.49009719e-03 -5.20253435e-03  1.00969263e+00]
  HOMO = -0.787050554579961  LUMO = 2.27023317694648
  mo_energy =
[-3.27554858e+01 -1.90125025e+00 -7.87050555e-01 -7.87050555e-01
 -7.87050555e-01  2.27023318e+00  2.61886237e+00  2.61886237e+00
  2.61886237e+00  1.97947906e+01  1.97947906e+01  1.97947906e+01
  2.87201578e+01  1.67725559e+02  7.99717059e+02  4.57424843e+03]
E1 = -182.52353754273767  E_coul = 54.243940189585096
cycle= 4 E= -128.279597353153  delta_E= -1.52e-08  |g|= 2.21e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.70125e-05
diis-c [-1.36360368e-10  2.41790290e-04 -2.01496301e-04 -8.07296962e-02
  1.08068940e+00]
  HOMO = -0.787043491767658  LUMO = 2.27023488550327
  mo_energy =
[-3.27554679e+01 -1.90124725e+00 -7.87043492e-01 -7.87043492e-01
 -7.87043492e-01  2.27023489e+00  2.61886828e+00  2.61886828e+00
  2.61886828e+00  1.97948049e+01  1.97948049e+01  1.97948049e+01
  2.87201705e+01  1.67725580e+02  7.99717087e+02  4.57424847e+03]
E1 = -182.523507751286  E_coul = 54.24391039808538
cycle= 5 E= -128.279597353201  delta_E= -4.8e-11  |g|= 1.79e-06  |ddm|= 8.67e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.523507751286  E_coul = 54.24391039808538
  HOMO = -0.787043081949454  LUMO = 2.27023484928183
  mo_energy =
[-3.27554670e+01 -1.90124728e+00 -7.87043082e-01 -7.87043082e-01
 -7.87043082e-01  2.27023485e+00  2.61886865e+00  2.61886865e+00
  2.61886865e+00  1.97948056e+01  1.97948056e+01  1.97948056e+01
  2.87201711e+01  1.67725581e+02  7.99717089e+02  4.57424847e+03]
E1 = -182.52350626367314  E_coul = 54.24390891047199
Extra cycle  E= -128.279597353201  delta_E= -5.4e-13  |g|= 4.08e-07  |ddm|= 1e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43908437e+03 1.05838221e+02 4.21875349e+02 5.15820065e-01
 3.15230587e+01 1.02427316e+01 1.75477434e+00 2.77470395e+00
 1.33166901e+01 5.99932269e-01]
E = -128.27959735320115
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.08437411        1
[INPUT] 0    0    [1    /1   ]  105.838221021        1
[INPUT] 0    0    [1    /1   ]  421.875348698        1
[INPUT] 0    0    [1    /1   ]  0.515820065471       1
[INPUT] 0    0    [1    /1   ]  31.5230586663        1
[INPUT] 0    0    [1    /1   ]  10.2427316413        1
[INPUT] 0    0    [1    /1   ]  1.75477433631        1
[INPUT] 1    0    [1    /1   ]  2.77470395461        1
[INPUT] 1    0    [1    /1   ]  13.3166900962        1
[INPUT] 1    0    [1    /1   ]  0.599932268766       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.0843741079498, 1.0]], [0, [105.8382210214008, 1.0]], [0, [421.8753486979483, 1.0]], [0, [0.5158200654711552, 1.0]], [0, [31.52305866631772, 1.0]], [0, [10.242731641289108, 1.0]], [0, [1.7547743363087052, 1.0]], [1, [2.7747039546073937, 1.0]], [1, [13.316690096207575, 1.0]], [1, [0.5999322687658895, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.08437411]
bas 1, expnt(s) = [105.83822102]
bas 2, expnt(s) = [421.8753487]
bas 3, expnt(s) = [0.51582007]
bas 4, expnt(s) = [31.52305867]
bas 5, expnt(s) = [10.24273164]
bas 6, expnt(s) = [1.75477434]
bas 7, expnt(s) = [2.77470395]
bas 8, expnt(s) = [13.3166901]
bas 9, expnt(s) = [0.59993227]
CPU time:       386.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43908437e+03 8.76869859e+02 1.05838221e+02 8.33675278e+01
 4.21875349e+02 2.35181489e+02 5.15820065e-01 1.53776049e+00
 3.15230587e+01 3.36113756e+01 1.02427316e+01 1.44652808e+01
 1.75477434e+00 3.85195300e+00 2.77470395e+00 1.04473275e+01
 1.33166901e+01 7.42129608e+01 5.99932269e-01 1.54032431e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966905853846514
cond(S) = 77.24833708281388
E1 = -183.22911462893353  E_coul = 55.00787245233754
init E= -128.221242176596
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743014456878584  LUMO = 2.29704198334013
  mo_energy =
[-3.25526086e+01 -1.85682198e+00 -7.43014457e-01 -7.43014457e-01
 -7.43014457e-01  2.29704198e+00  2.65402722e+00  2.65402722e+00
  2.65402722e+00  1.99328897e+01  1.99328897e+01  1.99328897e+01
  2.88669803e+01  1.67937123e+02  7.99970722e+02  4.57454023e+03]
E1 = -182.1847492229008  E_coul = 53.90716263242857
cycle= 1 E= -128.277586590472  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26922
diis-c [-0.07247952  1.        ]
  HOMO = -0.810117154950838  LUMO = 2.25281814265317
  mo_energy =
[-3.28311748e+01 -1.92509104e+00 -8.10117155e-01 -8.10117155e-01
 -8.10117155e-01  2.25281814e+00  2.59796128e+00  2.59796128e+00
  2.59796128e+00  1.97379496e+01  1.97379496e+01  1.97379496e+01
  2.86610579e+01  1.67647628e+02  7.99631015e+02  4.57415849e+03]
E1 = -182.65792672855204  E_coul = 54.37864819909994
cycle= 2 E= -128.279278529452  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105713
diis-c [-2.21312686e-04  2.80238605e-01  7.19761395e-01]
  HOMO = -0.786864410321685  LUMO = 2.27036826658947
  mo_energy =
[-3.27550213e+01 -1.90103714e+00 -7.86864410e-01 -7.86864410e-01
 -7.86864410e-01  2.27036827e+00  2.61899236e+00  2.61899236e+00
  2.61899236e+00  1.97951612e+01  1.97951612e+01  1.97951612e+01
  2.87205797e+01  1.67725934e+02  7.99717288e+02  4.57424856e+03]
E1 = -182.5226137680987  E_coul = 54.24301643014389
cycle= 3 E= -128.279597337955  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000696787
diis-c [-3.46293115e-08 -4.49009719e-03 -5.20253435e-03  1.00969263e+00]
  HOMO = -0.787050554579961  LUMO = 2.27023317694648
  mo_energy =
[-3.27554858e+01 -1.90125025e+00 -7.87050555e-01 -7.87050555e-01
 -7.87050555e-01  2.27023318e+00  2.61886237e+00  2.61886237e+00
  2.61886237e+00  1.97947906e+01  1.97947906e+01  1.97947906e+01
  2.87201578e+01  1.67725559e+02  7.99717059e+02  4.57424843e+03]
E1 = -182.52353754273767  E_coul = 54.243940189585096
cycle= 4 E= -128.279597353153  delta_E= -1.52e-08  |g|= 2.21e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.70125e-05
diis-c [-1.36360368e-10  2.41790290e-04 -2.01496301e-04 -8.07296962e-02
  1.08068940e+00]
  HOMO = -0.787043491767658  LUMO = 2.27023488550327
  mo_energy =
[-3.27554679e+01 -1.90124725e+00 -7.87043492e-01 -7.87043492e-01
 -7.87043492e-01  2.27023489e+00  2.61886828e+00  2.61886828e+00
  2.61886828e+00  1.97948049e+01  1.97948049e+01  1.97948049e+01
  2.87201705e+01  1.67725580e+02  7.99717087e+02  4.57424847e+03]
E1 = -182.523507751286  E_coul = 54.24391039808538
cycle= 5 E= -128.279597353201  delta_E= -4.8e-11  |g|= 1.79e-06  |ddm|= 8.67e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.523507751286  E_coul = 54.24391039808538
  HOMO = -0.787043081949454  LUMO = 2.27023484928183
  mo_energy =
[-3.27554670e+01 -1.90124728e+00 -7.87043082e-01 -7.87043082e-01
 -7.87043082e-01  2.27023485e+00  2.61886865e+00  2.61886865e+00
  2.61886865e+00  1.97948056e+01  1.97948056e+01  1.97948056e+01
  2.87201711e+01  1.67725581e+02  7.99717089e+02  4.57424847e+03]
E1 = -182.52350626367314  E_coul = 54.24390891047199
Extra cycle  E= -128.279597353201  delta_E= -5.4e-13  |g|= 4.08e-07  |ddm|= 1e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24833708281388
E1 = -182.52350626367314  E_coul = 54.24390891047199
init E= -128.279597353201
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787043162576917  LUMO = 2.27023472069543
  mo_energy =
[-3.27554673e+01 -1.90124745e+00 -7.87043163e-01 -7.87043163e-01
 -7.87043163e-01  2.27023472e+00  2.61886858e+00  2.61886858e+00
  2.61886858e+00  1.97948053e+01  1.97948053e+01  1.97948053e+01
  2.87201708e+01  1.67725581e+02  7.99717089e+02  4.57424847e+03]
E1 = -182.52350690426758  E_coul = 54.24390955106636
cycle= 1 E= -128.279597353201  delta_E= -5.68e-14  |g|= 1.02e-07  |ddm|= 2.41e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52350690426758  E_coul = 54.24390955106636
  HOMO = -0.787043114678323  LUMO = 2.27023474422331
  mo_energy =
[-3.27554671e+01 -1.90124741e+00 -7.87043115e-01 -7.87043115e-01
 -7.87043115e-01  2.27023474e+00  2.61886862e+00  2.61886862e+00
  2.61886862e+00  1.97948055e+01  1.97948055e+01  1.97948055e+01
  2.87201709e+01  1.67725581e+02  7.99717089e+02  4.57424847e+03]
E1 = -182.5235066580576  E_coul = 54.24390930485669
Extra cycle  E= -128.279597353201  delta_E= 2.84e-13  |g|= 3.66e-08  |ddm|= 4.02e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.43908437e+03 1.05838221e+02 4.21875349e+02 5.15820065e-01
 3.15230587e+01 1.02427316e+01 1.75477434e+00 2.77470395e+00
 1.33166901e+01 5.99932269e-01]
grad_E = [-1.09167461e-05 -4.88659912e-06 -3.35336167e-06 -1.00264168e-05
  3.77819796e-05 -7.14135331e-05 -2.58181066e-05  1.63100656e-04
 -5.30342982e-05  2.30362509e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.13419607        1
[INPUT] 0    0    [1    /1   ]  105.848254872        1
[INPUT] 0    0    [1    /1   ]  421.861349298        1
[INPUT] 0    0    [1    /1   ]  0.515783411883       1
[INPUT] 0    0    [1    /1   ]  31.529449913         1
[INPUT] 0    0    [1    /1   ]  10.2435894451        1
[INPUT] 0    0    [1    /1   ]  1.75464080548        1
[INPUT] 1    0    [1    /1   ]  2.77456528653        1
[INPUT] 1    0    [1    /1   ]  13.3146633493        1
[INPUT] 1    0    [1    /1   ]  0.599927222049       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.134196071017, 1.0]], [0, [105.84825487180731, 1.0]], [0, [421.86134929758384, 1.0]], [0, [0.5157834118830701, 1.0]], [0, [31.529449913003724, 1.0]], [0, [10.24358944512597, 1.0]], [0, [1.7546408054839375, 1.0]], [1, [2.7745652865325536, 1.0]], [1, [13.314663349347871, 1.0]], [1, [0.5999272220490579, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.13419607]
bas 1, expnt(s) = [105.84825487]
bas 2, expnt(s) = [421.8613493]
bas 3, expnt(s) = [0.51578341]
bas 4, expnt(s) = [31.52944991]
bas 5, expnt(s) = [10.24358945]
bas 6, expnt(s) = [1.75464081]
bas 7, expnt(s) = [2.77456529]
bas 8, expnt(s) = [13.31466335]
bas 9, expnt(s) = [0.59992722]
CPU time:       390.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43913420e+03 8.76883293e+02 1.05848255e+02 8.33734553e+01
 4.21861349e+02 2.35175636e+02 5.15783412e-01 1.53767854e+00
 3.15294499e+01 3.36164864e+01 1.02435894e+01 1.44661894e+01
 1.75464081e+00 3.85173316e+00 2.77456529e+00 1.04466749e+01
 1.33146633e+01 7.41988425e+01 5.99927222e-01 1.54030812e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966907736757562
cond(S) = 77.24749611523922
E1 = -183.22912352580843  E_coul = 55.00787421425726
init E= -128.221249311551
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743012610172698  LUMO = 2.29678652623477
  mo_energy =
[-3.25526150e+01 -1.85682043e+00 -7.43012610e-01 -7.43012610e-01
 -7.43012610e-01  2.29678653e+00  2.65396440e+00  2.65396440e+00
  2.65396440e+00  1.99303221e+01  1.99303221e+01  1.99303221e+01
  2.88705043e+01  1.67963367e+02  8.00011161e+02  4.57461700e+03]
E1 = -182.18474526841067  E_coul = 53.90715846261156
cycle= 1 E= -128.277586805799  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269228
diis-c [-0.07248351  1.        ]
  HOMO = -0.810116709717638  LUMO = 2.25256695670668
  mo_energy =
[-3.28311800e+01 -1.92508940e+00 -8.10116710e-01 -8.10116710e-01
 -8.10116710e-01  2.25256696e+00  2.59789912e+00  2.59789912e+00
  2.59789912e+00  1.97353930e+01  1.97353930e+01  1.97353930e+01
  2.86645690e+01  1.67673866e+02  7.99671458e+02  4.57423526e+03]
E1 = -182.65793032652573  E_coul = 54.378651566343
cycle= 2 E= -128.279278760183  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105715
diis-c [-2.21301979e-04  2.80237682e-01  7.19762318e-01]
  HOMO = -0.786863476449839  LUMO = 2.27011621736934
  mo_energy =
[-3.27550255e+01 -1.90103496e+00 -7.86863476e-01 -7.86863476e-01
 -7.86863476e-01  2.27011622e+00  2.61892996e+00  2.61892996e+00
  2.61892996e+00  1.97926023e+01  1.97926023e+01  1.97926023e+01
  2.87240948e+01  1.67752174e+02  7.99757731e+02  4.57432533e+03]
E1 = -182.52261367858299  E_coul = 54.24301609854497
cycle= 3 E= -128.279597580038  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000697185
diis-c [-3.45106996e-08 -4.48605862e-03 -5.18692364e-03  1.00967298e+00]
  HOMO = -0.78704972454799  LUMO = 2.26998112778453
  mo_energy =
[-3.27554904e+01 -1.90124808e+00 -7.87049725e-01 -7.87049725e-01
 -7.87049725e-01  2.26998113e+00  2.61879989e+00  2.61879989e+00
  2.61879989e+00  1.97922315e+01  1.97922315e+01  1.97922315e+01
  2.87236727e+01  1.67751799e+02  7.99757502e+02  4.57432520e+03]
E1 = -182.52353793000773  E_coul = 54.24394033476232
cycle= 4 E= -128.279597595245  delta_E= -1.52e-08  |g|= 2.2e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.69134e-05
diis-c [-1.35592675e-10  2.41107841e-04 -2.01844251e-04 -8.05712249e-02
  1.08053196e+00]
  HOMO = -0.787042680143557  LUMO = 2.26998283527135
  mo_energy =
[-3.27554725e+01 -1.90124509e+00 -7.87042680e-01 -7.87042680e-01
 -7.87042680e-01  2.26998284e+00  2.61880578e+00  2.61880578e+00
  2.61880578e+00  1.97922457e+01  1.97922457e+01  1.97922457e+01
  2.87236854e+01  1.67751819e+02  7.99757530e+02  4.57432524e+03]
E1 = -182.52350820988892  E_coul = 54.24391061459582
cycle= 5 E= -128.279597595293  delta_E= -4.77e-11  |g|= 1.78e-06  |ddm|= 8.63e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350820988892  E_coul = 54.24391061459582
  HOMO = -0.787042270734656  LUMO = 2.26998279959759
  mo_energy =
[-3.27554716e+01 -1.90124512e+00 -7.87042271e-01 -7.87042271e-01
 -7.87042271e-01  2.26998280e+00  2.61880616e+00  2.61880616e+00
  2.61880616e+00  1.97922465e+01  1.97922465e+01  1.97922465e+01
  2.87236860e+01  1.67751821e+02  7.99757531e+02  4.57432524e+03]
E1 = -182.52350672286366  E_coul = 54.24390912757008
Extra cycle  E= -128.279597595294  delta_E= -4.83e-13  |g|= 4.07e-07  |ddm|= 9.97e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43913420e+03 1.05848255e+02 4.21861349e+02 5.15783412e-01
 3.15294499e+01 1.02435894e+01 1.75464081e+00 2.77456529e+00
 1.33146633e+01 5.99927222e-01]
E = -128.27959759529358
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.13419607        1
[INPUT] 0    0    [1    /1   ]  105.848254872        1
[INPUT] 0    0    [1    /1   ]  421.861349298        1
[INPUT] 0    0    [1    /1   ]  0.515783411883       1
[INPUT] 0    0    [1    /1   ]  31.529449913         1
[INPUT] 0    0    [1    /1   ]  10.2435894451        1
[INPUT] 0    0    [1    /1   ]  1.75464080548        1
[INPUT] 1    0    [1    /1   ]  2.77456528653        1
[INPUT] 1    0    [1    /1   ]  13.3146633493        1
[INPUT] 1    0    [1    /1   ]  0.599927222049       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.134196071017, 1.0]], [0, [105.84825487180731, 1.0]], [0, [421.86134929758384, 1.0]], [0, [0.5157834118830701, 1.0]], [0, [31.529449913003724, 1.0]], [0, [10.24358944512597, 1.0]], [0, [1.7546408054839375, 1.0]], [1, [2.7745652865325536, 1.0]], [1, [13.314663349347871, 1.0]], [1, [0.5999272220490579, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.13419607]
bas 1, expnt(s) = [105.84825487]
bas 2, expnt(s) = [421.8613493]
bas 3, expnt(s) = [0.51578341]
bas 4, expnt(s) = [31.52944991]
bas 5, expnt(s) = [10.24358945]
bas 6, expnt(s) = [1.75464081]
bas 7, expnt(s) = [2.77456529]
bas 8, expnt(s) = [13.31466335]
bas 9, expnt(s) = [0.59992722]
CPU time:       391.65
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43913420e+03 8.76883293e+02 1.05848255e+02 8.33734553e+01
 4.21861349e+02 2.35175636e+02 5.15783412e-01 1.53767854e+00
 3.15294499e+01 3.36164864e+01 1.02435894e+01 1.44661894e+01
 1.75464081e+00 3.85173316e+00 2.77456529e+00 1.04466749e+01
 1.33146633e+01 7.41988425e+01 5.99927222e-01 1.54030812e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966907736757562
cond(S) = 77.24749611523922
E1 = -183.22912352580843  E_coul = 55.00787421425726
init E= -128.221249311551
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743012610172698  LUMO = 2.29678652623477
  mo_energy =
[-3.25526150e+01 -1.85682043e+00 -7.43012610e-01 -7.43012610e-01
 -7.43012610e-01  2.29678653e+00  2.65396440e+00  2.65396440e+00
  2.65396440e+00  1.99303221e+01  1.99303221e+01  1.99303221e+01
  2.88705043e+01  1.67963367e+02  8.00011161e+02  4.57461700e+03]
E1 = -182.18474526841067  E_coul = 53.90715846261156
cycle= 1 E= -128.277586805799  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269228
diis-c [-0.07248351  1.        ]
  HOMO = -0.810116709717638  LUMO = 2.25256695670668
  mo_energy =
[-3.28311800e+01 -1.92508940e+00 -8.10116710e-01 -8.10116710e-01
 -8.10116710e-01  2.25256696e+00  2.59789912e+00  2.59789912e+00
  2.59789912e+00  1.97353930e+01  1.97353930e+01  1.97353930e+01
  2.86645690e+01  1.67673866e+02  7.99671458e+02  4.57423526e+03]
E1 = -182.65793032652573  E_coul = 54.378651566343
cycle= 2 E= -128.279278760183  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105715
diis-c [-2.21301979e-04  2.80237682e-01  7.19762318e-01]
  HOMO = -0.786863476449839  LUMO = 2.27011621736934
  mo_energy =
[-3.27550255e+01 -1.90103496e+00 -7.86863476e-01 -7.86863476e-01
 -7.86863476e-01  2.27011622e+00  2.61892996e+00  2.61892996e+00
  2.61892996e+00  1.97926023e+01  1.97926023e+01  1.97926023e+01
  2.87240948e+01  1.67752174e+02  7.99757731e+02  4.57432533e+03]
E1 = -182.52261367858299  E_coul = 54.24301609854497
cycle= 3 E= -128.279597580038  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000697185
diis-c [-3.45106996e-08 -4.48605862e-03 -5.18692364e-03  1.00967298e+00]
  HOMO = -0.78704972454799  LUMO = 2.26998112778453
  mo_energy =
[-3.27554904e+01 -1.90124808e+00 -7.87049725e-01 -7.87049725e-01
 -7.87049725e-01  2.26998113e+00  2.61879989e+00  2.61879989e+00
  2.61879989e+00  1.97922315e+01  1.97922315e+01  1.97922315e+01
  2.87236727e+01  1.67751799e+02  7.99757502e+02  4.57432520e+03]
E1 = -182.52353793000773  E_coul = 54.24394033476232
cycle= 4 E= -128.279597595245  delta_E= -1.52e-08  |g|= 2.2e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.69134e-05
diis-c [-1.35592675e-10  2.41107841e-04 -2.01844251e-04 -8.05712249e-02
  1.08053196e+00]
  HOMO = -0.787042680143557  LUMO = 2.26998283527135
  mo_energy =
[-3.27554725e+01 -1.90124509e+00 -7.87042680e-01 -7.87042680e-01
 -7.87042680e-01  2.26998284e+00  2.61880578e+00  2.61880578e+00
  2.61880578e+00  1.97922457e+01  1.97922457e+01  1.97922457e+01
  2.87236854e+01  1.67751819e+02  7.99757530e+02  4.57432524e+03]
E1 = -182.52350820988892  E_coul = 54.24391061459582
cycle= 5 E= -128.279597595293  delta_E= -4.77e-11  |g|= 1.78e-06  |ddm|= 8.63e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350820988892  E_coul = 54.24391061459582
  HOMO = -0.787042270734656  LUMO = 2.26998279959759
  mo_energy =
[-3.27554716e+01 -1.90124512e+00 -7.87042271e-01 -7.87042271e-01
 -7.87042271e-01  2.26998280e+00  2.61880616e+00  2.61880616e+00
  2.61880616e+00  1.97922465e+01  1.97922465e+01  1.97922465e+01
  2.87236860e+01  1.67751821e+02  7.99757531e+02  4.57432524e+03]
E1 = -182.52350672286366  E_coul = 54.24390912757008
Extra cycle  E= -128.279597595294  delta_E= -4.83e-13  |g|= 4.07e-07  |ddm|= 9.97e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24749611523922
E1 = -182.52350672286366  E_coul = 54.24390912757008
init E= -128.279597595294
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.78704235137368  LUMO = 2.26998267118036
  mo_energy =
[-3.27554719e+01 -1.90124529e+00 -7.87042351e-01 -7.87042351e-01
 -7.87042351e-01  2.26998267e+00  2.61880608e+00  2.61880608e+00
  2.61880608e+00  1.97922462e+01  1.97922462e+01  1.97922462e+01
  2.87236857e+01  1.67751820e+02  7.99757531e+02  4.57432524e+03]
E1 = -182.5235073631359  E_coul = 54.243909767842354
cycle= 1 E= -128.279597595294  delta_E= 2.84e-14  |g|= 1.02e-07  |ddm|= 2.41e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5235073631359  E_coul = 54.243909767842354
  HOMO = -0.78704230350666  LUMO = 2.26998269471378
  mo_energy =
[-3.27554718e+01 -1.90124525e+00 -7.87042304e-01 -7.87042304e-01
 -7.87042304e-01  2.26998269e+00  2.61880612e+00  2.61880612e+00
  2.61880612e+00  1.97922463e+01  1.97922463e+01  1.97922463e+01
  2.87236858e+01  1.67751820e+02  7.99757531e+02  4.57432524e+03]
E1 = -182.52350711703374  E_coul = 54.24390952174003
Extra cycle  E= -128.279597595294  delta_E= -1.71e-13  |g|= 3.66e-08  |ddm|= 4.01e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.10 sec
exp = [2.43913420e+03 1.05848255e+02 4.21861349e+02 5.15783412e-01
 3.15294499e+01 1.02435894e+01 1.75464081e+00 2.77456529e+00
 1.33146633e+01 5.99927222e-01]
grad_E = [-1.09087393e-05 -6.39427436e-06 -3.40962558e-06 -1.29581749e-05
  4.99803716e-05 -9.43754618e-05 -3.42348239e-05  2.14392715e-04
 -6.99221180e-05  3.04856927e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.21589814        1
[INPUT] 0    0    [1    /1   ]  105.86094124         1
[INPUT] 0    0    [1    /1   ]  421.846900097        1
[INPUT] 0    0    [1    /1   ]  0.515739024861       1
[INPUT] 0    0    [1    /1   ]  31.5373377216        1
[INPUT] 0    0    [1    /1   ]  10.2446559473        1
[INPUT] 0    0    [1    /1   ]  1.75447884144        1
[INPUT] 1    0    [1    /1   ]  2.77439676386        1
[INPUT] 1    0    [1    /1   ]  13.3121980797        1
[INPUT] 1    0    [1    /1   ]  0.599921130171       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.2158981413295, 1.0]], [0, [105.86094124018545, 1.0]], [0, [421.84690009705946, 1.0]], [0, [0.5157390248605777, 1.0]], [0, [31.537337721569894, 1.0]], [0, [10.24465594730197, 1.0]], [0, [1.754478841443021, 1.0]], [1, [2.774396763860665, 1.0]], [1, [13.312198079716785, 1.0]], [1, [0.5999211301712456, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.21589814]
bas 1, expnt(s) = [105.86094124]
bas 2, expnt(s) = [421.8469001]
bas 3, expnt(s) = [0.51573902]
bas 4, expnt(s) = [31.53733772]
bas 5, expnt(s) = [10.24465595]
bas 6, expnt(s) = [1.75447884]
bas 7, expnt(s) = [2.77439676]
bas 8, expnt(s) = [13.31219808]
bas 9, expnt(s) = [0.59992113]
CPU time:       394.86
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43921590e+03 8.76905322e+02 1.05860941e+02 8.33809497e+01
 4.21846900e+02 2.35169595e+02 5.15739025e-01 1.53757929e+00
 3.15373377e+01 3.36227937e+01 1.02446559e+01 1.44673190e+01
 1.75447884e+00 3.85146651e+00 2.77439676e+00 1.04458817e+01
 1.33121981e+01 7.41816701e+01 5.99921130e-01 1.54028856e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96691001380261
cond(S) = 77.24605335324075
E1 = -183.22913437197678  E_coul = 55.007876355117254
init E= -128.22125801686
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743010356224226  LUMO = 2.29647736412703
  mo_energy =
[-3.25526228e+01 -1.85681854e+00 -7.43010356e-01 -7.43010356e-01
 -7.43010356e-01  2.29647736e+00  2.65388824e+00  2.65388824e+00
  2.65388824e+00  1.99271997e+01  1.99271997e+01  1.99271997e+01
  2.88748888e+01  1.67996061e+02  8.00065012e+02  4.57474722e+03]
E1 = -182.18474096555386  E_coul = 53.9071537558086
cycle= 1 E= -128.277587209745  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269237
diis-c [-0.0724883  1.       ]
  HOMO = -0.810116133324981  LUMO = 2.25226296472872
  mo_energy =
[-3.28311863e+01 -1.92508737e+00 -8.10116133e-01 -8.10116133e-01
 -8.10116133e-01  2.25226296e+00  2.59782379e+00  2.59782379e+00
  2.59782379e+00  1.97322842e+01  1.97322842e+01  1.97322842e+01
  2.86689376e+01  1.67706552e+02  7.99725314e+02  4.57436549e+03]
E1 = -182.65793505222936  E_coul = 54.378655870279346
cycle= 2 E= -128.27927918195  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105718
diis-c [-2.21289409e-04  2.80236538e-01  7.19763462e-01]
  HOMO = -0.786862312763997  LUMO = 2.26981118264403
  mo_energy =
[-3.27550307e+01 -1.90103229e+00 -7.86862313e-01 -7.86862313e-01
 -7.86862313e-01  2.26981118e+00  2.61885435e+00  2.61885435e+00
  2.61885435e+00  1.97894906e+01  1.97894906e+01  1.97894906e+01
  2.87284684e+01  1.67784863e+02  7.99811588e+02  4.57445556e+03]
E1 = -182.52261396963968  E_coul = 54.243015954251796
cycle= 3 E= -128.279598015388  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000697671
diis-c [-3.43668557e-08 -4.48113885e-03 -5.16790925e-03  1.00964905e+00]
  HOMO = -0.787048687295191  LUMO = 2.26967609282107
  mo_energy =
[-3.27554960e+01 -1.90124544e+00 -7.87048687e-01 -7.87048687e-01
 -7.87048687e-01  2.26967609e+00  2.61872416e+00  2.61872416e+00
  2.61872416e+00  1.97891195e+01  1.97891195e+01  1.97891195e+01
  2.87280461e+01  1.67784487e+02  7.99811358e+02  4.57445543e+03]
E1 = -182.52353880230592  E_coul = 54.24394077169881
cycle= 4 E= -128.279598030607  delta_E= -1.52e-08  |g|= 2.19e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.6793e-05
diis-c [-1.34661415e-10  2.40277490e-04 -2.02266671e-04 -8.03782578e-02
  1.08034025e+00]
  HOMO = -0.787041665254812  LUMO = 2.2696777990084
  mo_energy =
[-3.27554782e+01 -1.90124245e+00 -7.87041665e-01 -7.87041665e-01
 -7.87041665e-01  2.26967780e+00  2.61873004e+00  2.61873004e+00
  2.61873004e+00  1.97891337e+01  1.97891337e+01  1.97891337e+01
  2.87280586e+01  1.67784508e+02  7.99811386e+02  4.57445547e+03]
E1 = -182.52350916884373  E_coul = 54.243911138189226
cycle= 5 E= -128.279598030655  delta_E= -4.74e-11  |g|= 1.78e-06  |ddm|= 8.59e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350916884373  E_coul = 54.243911138189226
  HOMO = -0.787041256348033  LUMO = 2.26967776399931
  mo_energy =
[-3.27554772e+01 -1.90124248e+00 -7.87041256e-01 -7.87041256e-01
 -7.87041256e-01  2.26967776e+00  2.61873041e+00  2.61873041e+00
  2.61873041e+00  1.97891344e+01  1.97891344e+01  1.97891344e+01
  2.87280593e+01  1.67784509e+02  7.99811387e+02  4.57445547e+03]
E1 = -182.5235076825507  E_coul = 54.24390965189577
Extra cycle  E= -128.279598030655  delta_E= -4.26e-13  |g|= 4.06e-07  |ddm|= 9.94e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43921590e+03 1.05860941e+02 4.21846900e+02 5.15739025e-01
 3.15373377e+01 1.02446559e+01 1.75447884e+00 2.77439676e+00
 1.33121981e+01 5.99921130e-01]
E = -128.27959803065494
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.21589814        1
[INPUT] 0    0    [1    /1   ]  105.86094124         1
[INPUT] 0    0    [1    /1   ]  421.846900097        1
[INPUT] 0    0    [1    /1   ]  0.515739024861       1
[INPUT] 0    0    [1    /1   ]  31.5373377216        1
[INPUT] 0    0    [1    /1   ]  10.2446559473        1
[INPUT] 0    0    [1    /1   ]  1.75447884144        1
[INPUT] 1    0    [1    /1   ]  2.77439676386        1
[INPUT] 1    0    [1    /1   ]  13.3121980797        1
[INPUT] 1    0    [1    /1   ]  0.599921130171       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.2158981413295, 1.0]], [0, [105.86094124018545, 1.0]], [0, [421.84690009705946, 1.0]], [0, [0.5157390248605777, 1.0]], [0, [31.537337721569894, 1.0]], [0, [10.24465594730197, 1.0]], [0, [1.754478841443021, 1.0]], [1, [2.774396763860665, 1.0]], [1, [13.312198079716785, 1.0]], [1, [0.5999211301712456, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.21589814]
bas 1, expnt(s) = [105.86094124]
bas 2, expnt(s) = [421.8469001]
bas 3, expnt(s) = [0.51573902]
bas 4, expnt(s) = [31.53733772]
bas 5, expnt(s) = [10.24465595]
bas 6, expnt(s) = [1.75447884]
bas 7, expnt(s) = [2.77439676]
bas 8, expnt(s) = [13.31219808]
bas 9, expnt(s) = [0.59992113]
CPU time:       396.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43921590e+03 8.76905322e+02 1.05860941e+02 8.33809497e+01
 4.21846900e+02 2.35169595e+02 5.15739025e-01 1.53757929e+00
 3.15373377e+01 3.36227937e+01 1.02446559e+01 1.44673190e+01
 1.75447884e+00 3.85146651e+00 2.77439676e+00 1.04458817e+01
 1.33121981e+01 7.41816701e+01 5.99921130e-01 1.54028856e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96691001380261
cond(S) = 77.24605335324075
E1 = -183.22913437197678  E_coul = 55.007876355117254
init E= -128.22125801686
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743010356224226  LUMO = 2.29647736412703
  mo_energy =
[-3.25526228e+01 -1.85681854e+00 -7.43010356e-01 -7.43010356e-01
 -7.43010356e-01  2.29647736e+00  2.65388824e+00  2.65388824e+00
  2.65388824e+00  1.99271997e+01  1.99271997e+01  1.99271997e+01
  2.88748888e+01  1.67996061e+02  8.00065012e+02  4.57474722e+03]
E1 = -182.18474096555386  E_coul = 53.9071537558086
cycle= 1 E= -128.277587209745  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269237
diis-c [-0.0724883  1.       ]
  HOMO = -0.810116133324981  LUMO = 2.25226296472872
  mo_energy =
[-3.28311863e+01 -1.92508737e+00 -8.10116133e-01 -8.10116133e-01
 -8.10116133e-01  2.25226296e+00  2.59782379e+00  2.59782379e+00
  2.59782379e+00  1.97322842e+01  1.97322842e+01  1.97322842e+01
  2.86689376e+01  1.67706552e+02  7.99725314e+02  4.57436549e+03]
E1 = -182.65793505222936  E_coul = 54.378655870279346
cycle= 2 E= -128.27927918195  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105718
diis-c [-2.21289409e-04  2.80236538e-01  7.19763462e-01]
  HOMO = -0.786862312763997  LUMO = 2.26981118264403
  mo_energy =
[-3.27550307e+01 -1.90103229e+00 -7.86862313e-01 -7.86862313e-01
 -7.86862313e-01  2.26981118e+00  2.61885435e+00  2.61885435e+00
  2.61885435e+00  1.97894906e+01  1.97894906e+01  1.97894906e+01
  2.87284684e+01  1.67784863e+02  7.99811588e+02  4.57445556e+03]
E1 = -182.52261396963968  E_coul = 54.243015954251796
cycle= 3 E= -128.279598015388  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000697671
diis-c [-3.43668557e-08 -4.48113885e-03 -5.16790925e-03  1.00964905e+00]
  HOMO = -0.787048687295191  LUMO = 2.26967609282107
  mo_energy =
[-3.27554960e+01 -1.90124544e+00 -7.87048687e-01 -7.87048687e-01
 -7.87048687e-01  2.26967609e+00  2.61872416e+00  2.61872416e+00
  2.61872416e+00  1.97891195e+01  1.97891195e+01  1.97891195e+01
  2.87280461e+01  1.67784487e+02  7.99811358e+02  4.57445543e+03]
E1 = -182.52353880230592  E_coul = 54.24394077169881
cycle= 4 E= -128.279598030607  delta_E= -1.52e-08  |g|= 2.19e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.6793e-05
diis-c [-1.34661415e-10  2.40277490e-04 -2.02266671e-04 -8.03782578e-02
  1.08034025e+00]
  HOMO = -0.787041665254812  LUMO = 2.2696777990084
  mo_energy =
[-3.27554782e+01 -1.90124245e+00 -7.87041665e-01 -7.87041665e-01
 -7.87041665e-01  2.26967780e+00  2.61873004e+00  2.61873004e+00
  2.61873004e+00  1.97891337e+01  1.97891337e+01  1.97891337e+01
  2.87280586e+01  1.67784508e+02  7.99811386e+02  4.57445547e+03]
E1 = -182.52350916884373  E_coul = 54.243911138189226
cycle= 5 E= -128.279598030655  delta_E= -4.74e-11  |g|= 1.78e-06  |ddm|= 8.59e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52350916884373  E_coul = 54.243911138189226
  HOMO = -0.787041256348033  LUMO = 2.26967776399931
  mo_energy =
[-3.27554772e+01 -1.90124248e+00 -7.87041256e-01 -7.87041256e-01
 -7.87041256e-01  2.26967776e+00  2.61873041e+00  2.61873041e+00
  2.61873041e+00  1.97891344e+01  1.97891344e+01  1.97891344e+01
  2.87280593e+01  1.67784509e+02  7.99811387e+02  4.57445547e+03]
E1 = -182.5235076825507  E_coul = 54.24390965189577
Extra cycle  E= -128.279598030655  delta_E= -4.26e-13  |g|= 4.06e-07  |ddm|= 9.94e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24605335324075
E1 = -182.5235076825507  E_coul = 54.24390965189577
init E= -128.279598030655
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787041337000049  LUMO = 2.26967763578898
  mo_energy =
[-3.27554775e+01 -1.90124264e+00 -7.87041337e-01 -7.87041337e-01
 -7.87041337e-01  2.26967764e+00  2.61873033e+00  2.61873033e+00
  2.61873033e+00  1.97891342e+01  1.97891342e+01  1.97891342e+01
  2.87280590e+01  1.67784508e+02  7.99811387e+02  4.57445547e+03]
E1 = -182.5235083224238  E_coul = 54.243910291768735
cycle= 1 E= -128.279598030655  delta_E= -1.14e-13  |g|= 1.02e-07  |ddm|= 2.4e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5235083224238  E_coul = 54.243910291768735
  HOMO = -0.787041289172001  LUMO = 2.26967765932893
  mo_energy =
[-3.27554774e+01 -1.90124261e+00 -7.87041289e-01 -7.87041289e-01
 -7.87041289e-01  2.26967766e+00  2.61873038e+00  2.61873038e+00
  2.61873038e+00  1.97891343e+01  1.97891343e+01  1.97891343e+01
  2.87280591e+01  1.67784509e+02  7.99811387e+02  4.57445547e+03]
E1 = -182.52350807645502  E_coul = 54.2439100457999
Extra cycle  E= -128.279598030655  delta_E= -5.68e-14  |g|= 3.65e-08  |ddm|= 4e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43921590e+03 1.05860941e+02 4.21846900e+02 5.15739025e-01
 3.15373377e+01 1.02446559e+01 1.75447884e+00 2.77439676e+00
 1.33121981e+01 5.99921130e-01]
grad_E = [-1.08986110e-05 -8.23070135e-06 -3.47804083e-06 -1.65198223e-05
  6.48377053e-05 -1.22339406e-04 -4.44857202e-05  2.76851335e-04
 -9.04863923e-05  3.95585221e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:23 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.35498198        1
[INPUT] 0    0    [1    /1   ]  105.877939301        1
[INPUT] 0    0    [1    /1   ]  421.832672201        1
[INPUT] 0    0    [1    /1   ]  0.515682604548       1
[INPUT] 0    0    [1    /1   ]  31.5476010688        1
[INPUT] 0    0    [1    /1   ]  10.2460557483        1
[INPUT] 0    0    [1    /1   ]  1.75427256261        1
[INPUT] 1    0    [1    /1   ]  2.77418157861        1
[INPUT] 1    0    [1    /1   ]  13.3090470059        1
[INPUT] 1    0    [1    /1   ]  0.599913412225       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.3549819772984, 1.0]], [0, [105.87793930132636, 1.0]], [0, [421.8326722007412, 1.0]], [0, [0.5156826045478277, 1.0]], [0, [31.547601068764948, 1.0]], [0, [10.246055748295577, 1.0]], [0, [1.7542725626115174, 1.0]], [1, [2.774181578613484, 1.0]], [1, [13.309047005881002, 1.0]], [1, [0.5999134122245292, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.35498198]
bas 1, expnt(s) = [105.8779393]
bas 2, expnt(s) = [421.8326722]
bas 3, expnt(s) = [0.5156826]
bas 4, expnt(s) = [31.54760107]
bas 5, expnt(s) = [10.24605575]
bas 6, expnt(s) = [1.75427256]
bas 7, expnt(s) = [2.77418158]
bas 8, expnt(s) = [13.30904701]
bas 9, expnt(s) = [0.59991341]
CPU time:       399.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43935498e+03 8.76942822e+02 1.05877939e+02 8.33909909e+01
 4.21832672e+02 2.35163646e+02 5.15682605e-01 1.53745313e+00
 3.15476011e+01 3.36309999e+01 1.02460557e+01 1.44688016e+01
 1.75427256e+00 3.85112688e+00 2.77418158e+00 1.04448690e+01
 1.33090470e+01 7.41597217e+01 5.99913412e-01 1.54026379e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966912904251203
cond(S) = 77.24351314237789
E1 = -183.22914827862647  E_coul = 55.00787908547576
init E= -128.221269193151
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743007463291352  LUMO = 2.29608470421858
  mo_energy =
[-3.25526331e+01 -1.85681612e+00 -7.43007463e-01 -7.43007463e-01
 -7.43007463e-01  2.29608470e+00  2.65379126e+00  2.65379126e+00
  2.65379126e+00  1.99232099e+01  1.99232099e+01  1.99232099e+01
  2.88806491e+01  1.68039092e+02  8.00141459e+02  4.57497416e+03]
E1 = -182.18473623729417  E_coul = 53.90714827462779
cycle= 1 E= -128.277587962666  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269248
diis-c [-0.07249434  1.        ]
  HOMO = -0.810115344663339  LUMO = 2.2518768698208
  mo_energy =
[-3.28311945e+01 -1.92508475e+00 -8.10115345e-01 -8.10115345e-01
 -8.10115345e-01  2.25187687e+00  2.59772791e+00  2.59772791e+00
  2.59772791e+00  1.97283119e+01  1.97283119e+01  1.97283119e+01
  2.86746773e+01  1.67749574e+02  7.99801767e+02  4.57459243e+03]
E1 = -182.6579416307018  E_coul = 54.37866167439798
cycle= 2 E= -128.279279956304  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105721
diis-c [-2.21274078e-04  2.80235043e-01  7.19764957e-01]
  HOMO = -0.786860783860865  LUMO = 2.26942376726094
  mo_energy =
[-3.27550375e+01 -1.90102886e+00 -7.86860784e-01 -7.86860784e-01
 -7.86860784e-01  2.26942377e+00  2.61875810e+00  2.61875810e+00
  2.61875810e+00  1.97855145e+01  1.97855145e+01  1.97855145e+01
  2.87342145e+01  1.67827887e+02  7.99888042e+02  4.57468250e+03]
E1 = -182.52261495501807  E_coul = 54.243016148250035
cycle= 3 E= -128.279598806768  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000698294
diis-c [-3.41837142e-08 -4.47483905e-03 -5.14356667e-03  1.00961841e+00]
  HOMO = -0.787047320160779  LUMO = 2.26928867665317
  mo_energy =
[-3.27555032e+01 -1.90124204e+00 -7.87047320e-01 -7.87047320e-01
 -7.87047320e-01  2.26928868e+00  2.61862777e+00  2.61862777e+00
  2.61862777e+00  1.97851431e+01  1.97851431e+01  1.97851431e+01
  2.87337918e+01  1.67827511e+02  7.99887810e+02  4.57468237e+03]
E1 = -182.52354053251156  E_coul = 54.243941710509134
cycle= 4 E= -128.279598822002  delta_E= -1.52e-08  |g|= 2.18e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.66393e-05
diis-c [-1.33475431e-10  2.39215531e-04 -2.02805881e-04 -8.01312792e-02
  1.08009487e+00]
  HOMO = -0.787040326659695  LUMO = 2.26929038118221
  mo_energy =
[-3.27554854e+01 -1.90123905e+00 -7.87040327e-01 -7.87040327e-01
 -7.87040327e-01  2.26929038e+00  2.61863362e+00  2.61863362e+00
  2.61863362e+00  1.97851572e+01  1.97851572e+01  1.97851572e+01
  2.87338044e+01  1.67827531e+02  7.99887839e+02  4.57468240e+03]
E1 = -182.52351100962292  E_coul = 54.24391218757365
cycle= 5 E= -128.279598822049  delta_E= -4.69e-11  |g|= 1.77e-06  |ddm|= 8.54e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52351100962292  E_coul = 54.24391218757365
  HOMO = -0.787039918400893  LUMO = 2.26929034702054
  mo_energy =
[-3.27554845e+01 -1.90123908e+00 -7.87039918e-01 -7.87039918e-01
 -7.87039918e-01  2.26929035e+00  2.61863399e+00  2.61863399e+00
  2.61863399e+00  1.97851580e+01  1.97851580e+01  1.97851580e+01
  2.87338050e+01  1.67827532e+02  7.99887840e+02  4.57468240e+03]
E1 = -182.5235095242917  E_coul = 54.24391070224186
Extra cycle  E= -128.27959882205  delta_E= -5.68e-13  |g|= 4.05e-07  |ddm|= 9.9e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43935498e+03 1.05877939e+02 4.21832672e+02 5.15682605e-01
 3.15476011e+01 1.02460557e+01 1.75427256e+00 2.77418158e+00
 1.33090470e+01 5.99913412e-01]
E = -128.27959882204985
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:24 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.35498198        1
[INPUT] 0    0    [1    /1   ]  105.877939301        1
[INPUT] 0    0    [1    /1   ]  421.832672201        1
[INPUT] 0    0    [1    /1   ]  0.515682604548       1
[INPUT] 0    0    [1    /1   ]  31.5476010688        1
[INPUT] 0    0    [1    /1   ]  10.2460557483        1
[INPUT] 0    0    [1    /1   ]  1.75427256261        1
[INPUT] 1    0    [1    /1   ]  2.77418157861        1
[INPUT] 1    0    [1    /1   ]  13.3090470059        1
[INPUT] 1    0    [1    /1   ]  0.599913412225       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.3549819772984, 1.0]], [0, [105.87793930132636, 1.0]], [0, [421.8326722007412, 1.0]], [0, [0.5156826045478277, 1.0]], [0, [31.547601068764948, 1.0]], [0, [10.246055748295577, 1.0]], [0, [1.7542725626115174, 1.0]], [1, [2.774181578613484, 1.0]], [1, [13.309047005881002, 1.0]], [1, [0.5999134122245292, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.35498198]
bas 1, expnt(s) = [105.8779393]
bas 2, expnt(s) = [421.8326722]
bas 3, expnt(s) = [0.5156826]
bas 4, expnt(s) = [31.54760107]
bas 5, expnt(s) = [10.24605575]
bas 6, expnt(s) = [1.75427256]
bas 7, expnt(s) = [2.77418158]
bas 8, expnt(s) = [13.30904701]
bas 9, expnt(s) = [0.59991341]
CPU time:       400.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43935498e+03 8.76942822e+02 1.05877939e+02 8.33909909e+01
 4.21832672e+02 2.35163646e+02 5.15682605e-01 1.53745313e+00
 3.15476011e+01 3.36309999e+01 1.02460557e+01 1.44688016e+01
 1.75427256e+00 3.85112688e+00 2.77418158e+00 1.04448690e+01
 1.33090470e+01 7.41597217e+01 5.99913412e-01 1.54026379e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966912904251203
cond(S) = 77.24351314237789
E1 = -183.22914827862647  E_coul = 55.00787908547576
init E= -128.221269193151
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743007463291352  LUMO = 2.29608470421858
  mo_energy =
[-3.25526331e+01 -1.85681612e+00 -7.43007463e-01 -7.43007463e-01
 -7.43007463e-01  2.29608470e+00  2.65379126e+00  2.65379126e+00
  2.65379126e+00  1.99232099e+01  1.99232099e+01  1.99232099e+01
  2.88806491e+01  1.68039092e+02  8.00141459e+02  4.57497416e+03]
E1 = -182.18473623729417  E_coul = 53.90714827462779
cycle= 1 E= -128.277587962666  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269248
diis-c [-0.07249434  1.        ]
  HOMO = -0.810115344663339  LUMO = 2.2518768698208
  mo_energy =
[-3.28311945e+01 -1.92508475e+00 -8.10115345e-01 -8.10115345e-01
 -8.10115345e-01  2.25187687e+00  2.59772791e+00  2.59772791e+00
  2.59772791e+00  1.97283119e+01  1.97283119e+01  1.97283119e+01
  2.86746773e+01  1.67749574e+02  7.99801767e+02  4.57459243e+03]
E1 = -182.6579416307018  E_coul = 54.37866167439798
cycle= 2 E= -128.279279956304  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105721
diis-c [-2.21274078e-04  2.80235043e-01  7.19764957e-01]
  HOMO = -0.786860783860865  LUMO = 2.26942376726094
  mo_energy =
[-3.27550375e+01 -1.90102886e+00 -7.86860784e-01 -7.86860784e-01
 -7.86860784e-01  2.26942377e+00  2.61875810e+00  2.61875810e+00
  2.61875810e+00  1.97855145e+01  1.97855145e+01  1.97855145e+01
  2.87342145e+01  1.67827887e+02  7.99888042e+02  4.57468250e+03]
E1 = -182.52261495501807  E_coul = 54.243016148250035
cycle= 3 E= -128.279598806768  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000698294
diis-c [-3.41837142e-08 -4.47483905e-03 -5.14356667e-03  1.00961841e+00]
  HOMO = -0.787047320160779  LUMO = 2.26928867665317
  mo_energy =
[-3.27555032e+01 -1.90124204e+00 -7.87047320e-01 -7.87047320e-01
 -7.87047320e-01  2.26928868e+00  2.61862777e+00  2.61862777e+00
  2.61862777e+00  1.97851431e+01  1.97851431e+01  1.97851431e+01
  2.87337918e+01  1.67827511e+02  7.99887810e+02  4.57468237e+03]
E1 = -182.52354053251156  E_coul = 54.243941710509134
cycle= 4 E= -128.279598822002  delta_E= -1.52e-08  |g|= 2.18e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.66393e-05
diis-c [-1.33475431e-10  2.39215531e-04 -2.02805881e-04 -8.01312792e-02
  1.08009487e+00]
  HOMO = -0.787040326659695  LUMO = 2.26929038118221
  mo_energy =
[-3.27554854e+01 -1.90123905e+00 -7.87040327e-01 -7.87040327e-01
 -7.87040327e-01  2.26929038e+00  2.61863362e+00  2.61863362e+00
  2.61863362e+00  1.97851572e+01  1.97851572e+01  1.97851572e+01
  2.87338044e+01  1.67827531e+02  7.99887839e+02  4.57468240e+03]
E1 = -182.52351100962292  E_coul = 54.24391218757365
cycle= 5 E= -128.279598822049  delta_E= -4.69e-11  |g|= 1.77e-06  |ddm|= 8.54e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52351100962292  E_coul = 54.24391218757365
  HOMO = -0.787039918400893  LUMO = 2.26929034702054
  mo_energy =
[-3.27554845e+01 -1.90123908e+00 -7.87039918e-01 -7.87039918e-01
 -7.87039918e-01  2.26929035e+00  2.61863399e+00  2.61863399e+00
  2.61863399e+00  1.97851580e+01  1.97851580e+01  1.97851580e+01
  2.87338050e+01  1.67827532e+02  7.99887840e+02  4.57468240e+03]
E1 = -182.5235095242917  E_coul = 54.24391070224186
Extra cycle  E= -128.27959882205  delta_E= -5.68e-13  |g|= 4.05e-07  |ddm|= 9.9e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.24351314237789
E1 = -182.5235095242917  E_coul = 54.24391070224186
init E= -128.27959882205
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787039999067945  LUMO = 2.2692902190762
  mo_energy =
[-3.27554848e+01 -1.90123925e+00 -7.87039999e-01 -7.87039999e-01
 -7.87039999e-01  2.26929022e+00  2.61863392e+00  2.61863392e+00
  2.61863392e+00  1.97851577e+01  1.97851577e+01  1.97851577e+01
  2.87338047e+01  1.67827532e+02  7.99887840e+02  4.57468240e+03]
E1 = -182.52351016364273  E_coul = 54.24391134159306
cycle= 1 E= -128.27959882205  delta_E= 1.99e-13  |g|= 1.01e-07  |ddm|= 2.39e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52351016364273  E_coul = 54.24391134159306
  HOMO = -0.787039951290508  LUMO = 2.26929024262399
  mo_energy =
[-3.27554847e+01 -1.90123921e+00 -7.87039951e-01 -7.87039951e-01
 -7.87039951e-01  2.26929024e+00  2.61863396e+00  2.61863396e+00
  2.61863396e+00  1.97851578e+01  1.97851578e+01  1.97851578e+01
  2.87338048e+01  1.67827532e+02  7.99887840e+02  4.57468240e+03]
E1 = -182.52350991784908  E_coul = 54.24391109579928
Extra cycle  E= -128.27959882205  delta_E= -1.71e-13  |g|= 3.65e-08  |ddm|= 3.99e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43935498e+03 1.05877939e+02 4.21832672e+02 5.15682605e-01
 3.15476011e+01 1.02460557e+01 1.75427256e+00 2.77418158e+00
 1.33090470e+01 5.99913412e-01]
grad_E = [-1.08850303e-05 -1.05813353e-05 -3.56542234e-06 -2.10700249e-05
  8.38548259e-05 -1.58131833e-04 -5.76074680e-05  3.56790967e-04
 -1.16806268e-04  5.11712439e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.59934544        1
[INPUT] 0    0    [1    /1   ]  105.901998733        1
[INPUT] 0    0    [1    /1   ]  421.820756055        1
[INPUT] 0    0    [1    /1   ]  0.515607619881       1
[INPUT] 0    0    [1    /1   ]  31.5616387829        1
[INPUT] 0    0    [1    /1   ]  10.2479901302        1
[INPUT] 0    0    [1    /1   ]  1.75399774184        1
[INPUT] 1    0    [1    /1   ]  2.77389395844        1
[INPUT] 1    0    [1    /1   ]  13.304829985         1
[INPUT] 1    0    [1    /1   ]  0.599903196054       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.599345443744, 1.0]], [0, [105.90199873304026, 1.0]], [0, [421.8207560553679, 1.0]], [0, [0.51560761988145, 1.0]], [0, [31.56163878288369, 1.0]], [0, [10.247990130150509, 1.0]], [0, [1.75399774184431, 1.0]], [1, [2.7738939584448725, 1.0]], [1, [13.304829984960666, 1.0]], [1, [0.5999031960543184, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.59934544]
bas 1, expnt(s) = [105.90199873]
bas 2, expnt(s) = [421.82075606]
bas 3, expnt(s) = [0.51560762]
bas 4, expnt(s) = [31.56163878]
bas 5, expnt(s) = [10.24799013]
bas 6, expnt(s) = [1.75399774]
bas 7, expnt(s) = [2.77389396]
bas 8, expnt(s) = [13.30482998]
bas 9, expnt(s) = [0.5999032]
CPU time:       404.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43959935e+03 8.77008708e+02 1.05901999e+02 8.34052026e+01
 4.21820756e+02 2.35158664e+02 5.15607620e-01 1.53728546e+00
 3.15616388e+01 3.36422228e+01 1.02479901e+01 1.44708502e+01
 1.75399774e+00 3.85067439e+00 2.77389396e+00 1.04435154e+01
 1.33048300e+01 7.41303506e+01 5.99903196e-01 1.54023101e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966916739170818
cond(S) = 77.23894450037648
E1 = -183.22916693650748  E_coul = 55.00788272326389
init E= -128.221284213244
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743003571253432  LUMO = 2.29556338553406
  mo_energy =
[-3.25526470e+01 -1.85681291e+00 -7.43003571e-01 -7.43003571e-01
 -7.43003571e-01  2.29556339e+00  2.65366211e+00  2.65366211e+00
  2.65366211e+00  1.99178724e+01  1.99178724e+01  1.99178724e+01
  2.88886188e+01  1.68098757e+02  8.00256540e+02  4.57537946e+03]
E1 = -182.18473114732072  E_coul = 53.90714179333213
cycle= 1 E= -128.277589353989  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269262
diis-c [-0.07250229  1.        ]
  HOMO = -0.810114204381981  LUMO = 2.25136426292345
  mo_energy =
[-3.28312054e+01 -1.92508119e+00 -8.10114204e-01 -8.10114204e-01
 -8.10114204e-01  2.25136426e+00  2.59760027e+00  2.59760027e+00
  2.59760027e+00  1.97229979e+01  1.97229979e+01  1.97229979e+01
  2.86826187e+01  1.67809225e+02  7.99916857e+02  4.57499774e+03]
E1 = -182.65795129480523  E_coul = 54.37866992065741
cycle= 2 E= -128.279281374148  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105726
diis-c [-2.21254794e-04  2.80232988e-01  7.19767012e-01]
  HOMO = -0.786858669760755  LUMO = 2.26890941414801
  mo_energy =
[-3.27550466e+01 -1.90102424e+00 -7.86858670e-01 -7.86858670e-01
 -7.86858670e-01  2.26890941e+00  2.61862995e+00  2.61862995e+00
  2.61862995e+00  1.97801955e+01  1.97801955e+01  1.97801955e+01
  2.87421646e+01  1.67887542e+02  8.00003132e+02  4.57508781e+03]
E1 = -182.5226172558916  E_coul = 54.24301700903572
cycle= 3 E= -128.279600246856  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000699131
diis-c [-3.39398745e-08 -4.46639003e-03 -5.11092794e-03  1.00957732e+00]
  HOMO = -0.787045422818807  LUMO = 2.26877432169195
  mo_energy =
[-3.27555130e+01 -1.90123746e+00 -7.87045423e-01 -7.87045423e-01
 -7.87045423e-01  2.26877432e+00  2.61849943e+00  2.61849943e+00
  2.61849943e+00  1.97798237e+01  1.97798237e+01  1.97798237e+01
  2.87417415e+01  1.67887165e+02  8.00002899e+02  4.57508768e+03]
E1 = -182.52354383327096  E_coul = 54.243943571159896
cycle= 4 E= -128.279600262111  delta_E= -1.53e-08  |g|= 2.17e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.64341e-05
diis-c [-1.31895736e-10  2.37793529e-04 -2.03525131e-04 -7.98001693e-02
  1.07976590e+00]
  HOMO = -0.787038467433283  LUMO = 2.2687760240063
  mo_energy =
[-3.27554953e+01 -1.90123448e+00 -7.87038467e-01 -7.87038467e-01
 -7.87038467e-01  2.26877602e+00  2.61850525e+00  2.61850525e+00
  2.61850525e+00  1.97798377e+01  1.97798377e+01  1.97798377e+01
  2.87417540e+01  1.67887186e+02  8.00002927e+02  4.57508771e+03]
E1 = -182.52351445803984  E_coul = 54.24391419588236
cycle= 5 E= -128.279600262157  delta_E= -4.64e-11  |g|= 1.76e-06  |ddm|= 8.47e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52351445803984  E_coul = 54.24391419588236
  HOMO = -0.787038060053228  LUMO = 2.26877599097466
  mo_energy =
[-3.27554944e+01 -1.90123450e+00 -7.87038060e-01 -7.87038060e-01
 -7.87038060e-01  2.26877599e+00  2.61850562e+00  2.61850562e+00
  2.61850562e+00  1.97798385e+01  1.97798385e+01  1.97798385e+01
  2.87417547e+01  1.67887187e+02  8.00002929e+02  4.57508771e+03]
E1 = -182.52351297404311  E_coul = 54.24391271188532
Extra cycle  E= -128.279600262158  delta_E= -3.13e-13  |g|= 4.04e-07  |ddm|= 9.85e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.43959935e+03 1.05901999e+02 4.21820756e+02 5.15607620e-01
 3.15616388e+01 1.02479901e+01 1.75399774e+00 2.77389396e+00
 1.33048300e+01 5.99903196e-01]
E = -128.2796002621578
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:29 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2439.59934544        1
[INPUT] 0    0    [1    /1   ]  105.901998733        1
[INPUT] 0    0    [1    /1   ]  421.820756055        1
[INPUT] 0    0    [1    /1   ]  0.515607619881       1
[INPUT] 0    0    [1    /1   ]  31.5616387829        1
[INPUT] 0    0    [1    /1   ]  10.2479901302        1
[INPUT] 0    0    [1    /1   ]  1.75399774184        1
[INPUT] 1    0    [1    /1   ]  2.77389395844        1
[INPUT] 1    0    [1    /1   ]  13.304829985         1
[INPUT] 1    0    [1    /1   ]  0.599903196054       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2439.599345443744, 1.0]], [0, [105.90199873304026, 1.0]], [0, [421.8207560553679, 1.0]], [0, [0.51560761988145, 1.0]], [0, [31.56163878288369, 1.0]], [0, [10.247990130150509, 1.0]], [0, [1.75399774184431, 1.0]], [1, [2.7738939584448725, 1.0]], [1, [13.304829984960666, 1.0]], [1, [0.5999031960543184, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2439.59934544]
bas 1, expnt(s) = [105.90199873]
bas 2, expnt(s) = [421.82075606]
bas 3, expnt(s) = [0.51560762]
bas 4, expnt(s) = [31.56163878]
bas 5, expnt(s) = [10.24799013]
bas 6, expnt(s) = [1.75399774]
bas 7, expnt(s) = [2.77389396]
bas 8, expnt(s) = [13.30482998]
bas 9, expnt(s) = [0.5999032]
CPU time:       405.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.43959935e+03 8.77008708e+02 1.05901999e+02 8.34052026e+01
 4.21820756e+02 2.35158664e+02 5.15607620e-01 1.53728546e+00
 3.15616388e+01 3.36422228e+01 1.02479901e+01 1.44708502e+01
 1.75399774e+00 3.85067439e+00 2.77389396e+00 1.04435154e+01
 1.33048300e+01 7.41303506e+01 5.99903196e-01 1.54023101e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966916739170818
cond(S) = 77.23894450037648
E1 = -183.22916693650748  E_coul = 55.00788272326389
init E= -128.221284213244
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.743003571253432  LUMO = 2.29556338553406
  mo_energy =
[-3.25526470e+01 -1.85681291e+00 -7.43003571e-01 -7.43003571e-01
 -7.43003571e-01  2.29556339e+00  2.65366211e+00  2.65366211e+00
  2.65366211e+00  1.99178724e+01  1.99178724e+01  1.99178724e+01
  2.88886188e+01  1.68098757e+02  8.00256540e+02  4.57537946e+03]
E1 = -182.18473114732072  E_coul = 53.90714179333213
cycle= 1 E= -128.277589353989  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269262
diis-c [-0.07250229  1.        ]
  HOMO = -0.810114204381981  LUMO = 2.25136426292345
  mo_energy =
[-3.28312054e+01 -1.92508119e+00 -8.10114204e-01 -8.10114204e-01
 -8.10114204e-01  2.25136426e+00  2.59760027e+00  2.59760027e+00
  2.59760027e+00  1.97229979e+01  1.97229979e+01  1.97229979e+01
  2.86826187e+01  1.67809225e+02  7.99916857e+02  4.57499774e+03]
E1 = -182.65795129480523  E_coul = 54.37866992065741
cycle= 2 E= -128.279281374148  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105726
diis-c [-2.21254794e-04  2.80232988e-01  7.19767012e-01]
  HOMO = -0.786858669760755  LUMO = 2.26890941414801
  mo_energy =
[-3.27550466e+01 -1.90102424e+00 -7.86858670e-01 -7.86858670e-01
 -7.86858670e-01  2.26890941e+00  2.61862995e+00  2.61862995e+00
  2.61862995e+00  1.97801955e+01  1.97801955e+01  1.97801955e+01
  2.87421646e+01  1.67887542e+02  8.00003132e+02  4.57508781e+03]
E1 = -182.5226172558916  E_coul = 54.24301700903572
cycle= 3 E= -128.279600246856  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000699131
diis-c [-3.39398745e-08 -4.46639003e-03 -5.11092794e-03  1.00957732e+00]
  HOMO = -0.787045422818807  LUMO = 2.26877432169195
  mo_energy =
[-3.27555130e+01 -1.90123746e+00 -7.87045423e-01 -7.87045423e-01
 -7.87045423e-01  2.26877432e+00  2.61849943e+00  2.61849943e+00
  2.61849943e+00  1.97798237e+01  1.97798237e+01  1.97798237e+01
  2.87417415e+01  1.67887165e+02  8.00002899e+02  4.57508768e+03]
E1 = -182.52354383327096  E_coul = 54.243943571159896
cycle= 4 E= -128.279600262111  delta_E= -1.53e-08  |g|= 2.17e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.64341e-05
diis-c [-1.31895736e-10  2.37793529e-04 -2.03525131e-04 -7.98001693e-02
  1.07976590e+00]
  HOMO = -0.787038467433283  LUMO = 2.2687760240063
  mo_energy =
[-3.27554953e+01 -1.90123448e+00 -7.87038467e-01 -7.87038467e-01
 -7.87038467e-01  2.26877602e+00  2.61850525e+00  2.61850525e+00
  2.61850525e+00  1.97798377e+01  1.97798377e+01  1.97798377e+01
  2.87417540e+01  1.67887186e+02  8.00002927e+02  4.57508771e+03]
E1 = -182.52351445803984  E_coul = 54.24391419588236
cycle= 5 E= -128.279600262157  delta_E= -4.64e-11  |g|= 1.76e-06  |ddm|= 8.47e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52351445803984  E_coul = 54.24391419588236
  HOMO = -0.787038060053228  LUMO = 2.26877599097466
  mo_energy =
[-3.27554944e+01 -1.90123450e+00 -7.87038060e-01 -7.87038060e-01
 -7.87038060e-01  2.26877599e+00  2.61850562e+00  2.61850562e+00
  2.61850562e+00  1.97798385e+01  1.97798385e+01  1.97798385e+01
  2.87417547e+01  1.67887187e+02  8.00002929e+02  4.57508771e+03]
E1 = -182.52351297404311  E_coul = 54.24391271188532
Extra cycle  E= -128.279600262158  delta_E= -3.13e-13  |g|= 4.04e-07  |ddm|= 9.85e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.23894450037648
E1 = -182.52351297404311  E_coul = 54.24391271188532
init E= -128.279600262158
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787038140737473  LUMO = 2.26877586338924
  mo_energy =
[-3.27554947e+01 -1.90123467e+00 -7.87038141e-01 -7.87038141e-01
 -7.87038141e-01  2.26877586e+00  2.61850554e+00  2.61850554e+00
  2.61850554e+00  1.97798382e+01  1.97798382e+01  1.97798382e+01
  2.87417544e+01  1.67887187e+02  8.00002928e+02  4.57508771e+03]
E1 = -182.52351361267586  E_coul = 54.24391335051802
cycle= 1 E= -128.279600262158  delta_E= -2.84e-14  |g|= 1.01e-07  |ddm|= 2.38e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52351361267586  E_coul = 54.24391335051802
  HOMO = -0.787038093029235  LUMO = 2.26877588694661
  mo_energy =
[-3.27554945e+01 -1.90123464e+00 -7.87038093e-01 -7.87038093e-01
 -7.87038093e-01  2.26877589e+00  2.61850559e+00  2.61850559e+00
  2.61850559e+00  1.97798383e+01  1.97798383e+01  1.97798383e+01
  2.87417545e+01  1.67887187e+02  8.00002929e+02  4.57508771e+03]
E1 = -182.5235133671243  E_coul = 54.243913104966495
Extra cycle  E= -128.279600262158  delta_E=    0  |g|= 3.64e-08  |ddm|= 3.98e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.43959935e+03 1.05901999e+02 4.21820756e+02 5.15607620e-01
 3.15616388e+01 1.02479901e+01 1.75399774e+00 2.77389396e+00
 1.33048300e+01 5.99903196e-01]
grad_E = [-1.08657921e-05 -1.37320379e-05 -3.68222459e-06 -2.71667453e-05
  1.09345695e-04 -2.06112269e-04 -7.51984018e-05  4.63953935e-04
 -1.52089665e-04  6.67371046e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2440.03799649        1
[INPUT] 0    0    [1    /1   ]  105.937523134        1
[INPUT] 0    0    [1    /1   ]  421.816628798        1
[INPUT] 0    0    [1    /1   ]  0.515504914847       1
[INPUT] 0    0    [1    /1   ]  31.5815654281        1
[INPUT] 0    0    [1    /1   ]  10.2507702801        1
[INPUT] 0    0    [1    /1   ]  1.75362015489        1
[INPUT] 1    0    [1    /1   ]  2.7734971877         1
[INPUT] 1    0    [1    /1   ]  13.299003083         1
[INPUT] 1    0    [1    /1   ]  0.599889284394       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2440.0379964861413, 1.0]], [0, [105.93752313439296, 1.0]], [0, [421.8166287979322, 1.0]], [0, [0.5155049148470904, 1.0]], [0, [31.581565428052514, 1.0]], [0, [10.250770280129375, 1.0]], [0, [1.7536201548919044, 1.0]], [1, [2.7734971876959356, 1.0]], [1, [13.299003082979802, 1.0]], [1, [0.5998892843943708, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2440.03799649]
bas 1, expnt(s) = [105.93752313]
bas 2, expnt(s) = [421.8166288]
bas 3, expnt(s) = [0.51550491]
bas 4, expnt(s) = [31.58156543]
bas 5, expnt(s) = [10.25077028]
bas 6, expnt(s) = [1.75362015]
bas 7, expnt(s) = [2.77349719]
bas 8, expnt(s) = [13.29900308]
bas 9, expnt(s) = [0.59988928]
CPU time:       408.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44003800e+03 8.77126972e+02 1.05937523e+02 8.34261852e+01
 4.21816629e+02 2.35156938e+02 5.15504915e-01 1.53705579e+00
 3.15815654e+01 3.36581518e+01 1.02507703e+01 1.44737944e+01
 1.75362015e+00 3.85005267e+00 2.77349719e+00 1.04416482e+01
 1.32990031e+01 7.40897707e+01 5.99889284e-01 1.54018636e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966921977764027
cond(S) = 77.23062041009106
E1 = -183.22919271881625  E_coul = 55.00788770959262
init E= -128.221305009224
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742998155547816  LUMO = 2.29485030718632
  mo_energy =
[-3.25526666e+01 -1.85680848e+00 -7.42998156e-01 -7.42998156e-01
 -7.42998156e-01  2.29485031e+00  2.65348480e+00  2.65348480e+00
  2.65348480e+00  1.99105009e+01  1.99105009e+01  1.99105009e+01
  2.89000884e+01  1.68184826e+02  8.00437730e+02  4.57611571e+03]
E1 = -182.1847262238438  E_coul = 53.90713432836255
cycle= 1 E= -128.277591895481  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269282
diis-c [-0.07251302  1.        ]
  HOMO = -0.810112477457281  LUMO = 2.25066309492682
  mo_energy =
[-3.28312207e+01 -1.92507618e+00 -8.10112477e-01 -8.10112477e-01
 -8.10112477e-01  2.25066309e+00  2.59742514e+00  2.59742514e+00
  2.59742514e+00  1.97156592e+01  1.97156592e+01  1.97156592e+01
  2.86940482e+01  1.67895275e+02  8.00098058e+02  4.57573400e+03]
E1 = -182.6579660901232  E_coul = 54.37868214163678
cycle= 2 E= -128.279283948486  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105732
diis-c [-2.21230299e-04  2.80230053e-01  7.19769947e-01]
  HOMO = -0.786855626984465  LUMO = 2.26820586945847
  mo_energy =
[-3.27550595e+01 -1.90101779e+00 -7.86855627e-01 -7.86855627e-01
 -7.86855627e-01  2.26820587e+00  2.61845409e+00  2.61845409e+00
  2.61845409e+00  1.97728498e+01  1.97728498e+01  1.97728498e+01
  2.87536063e+01  1.67973598e+02  8.00184334e+02  4.57582407e+03]
E1 = -182.52262209267738  E_coul = 54.243019241704964
cycle= 3 E= -128.279602850972  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000700294
diis-c [-3.36052453e-08 -4.45468540e-03 -5.06572319e-03  1.00952041e+00]
  HOMO = -0.787042680072438  LUMO = 2.26807077303007
  mo_energy =
[-3.27555267e+01 -1.90123107e+00 -7.87042680e-01 -7.87042680e-01
 -7.87042680e-01  2.26807077e+00  2.61832331e+00  2.61832331e+00
  2.61832331e+00  1.97724773e+01  1.97724773e+01  1.97724773e+01
  2.87531827e+01  1.67973220e+02  8.00184100e+02  4.57582393e+03]
E1 = -182.52355005728433  E_coul = 54.2439471910275
cycle= 4 E= -128.279602866257  delta_E= -1.53e-08  |g|= 2.15e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.61512e-05
diis-c [-1.29726441e-10  2.35826816e-04 -2.04513351e-04 -7.93413804e-02
  1.07931007e+00]
  HOMO = -0.787035777222441  LUMO = 2.2680724722918
  mo_energy =
[-3.27555091e+01 -1.90122810e+00 -7.87035777e-01 -7.87035777e-01
 -7.87035777e-01  2.26807247e+00  2.61832908e+00  2.61832908e+00
  2.61832908e+00  1.97724913e+01  1.97724913e+01  1.97724913e+01
  2.87531951e+01  1.67973241e+02  8.00184128e+02  4.57582396e+03]
E1 = -182.52352088553684  E_coul = 54.24391801923464
cycle= 5 E= -128.279602866302  delta_E= -4.54e-11  |g|= 1.75e-06  |ddm|= 8.38e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52352088553684  E_coul = 54.24391801923464
  HOMO = -0.787035371079122  LUMO = 2.26807244081432
  mo_energy =
[-3.27555082e+01 -1.90122812e+00 -7.87035371e-01 -7.87035371e-01
 -7.87035371e-01  2.26807244e+00  2.61832945e+00  2.61832945e+00
  2.61832945e+00  1.97724920e+01  1.97724920e+01  1.97724920e+01
  2.87531957e+01  1.67973242e+02  8.00184129e+02  4.57582397e+03]
E1 = -182.5235194034784  E_coul = 54.24391653717583
Extra cycle  E= -128.279602866303  delta_E= -3.69e-13  |g|= 4.01e-07  |ddm|= 9.77e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.44003800e+03 1.05937523e+02 4.21816629e+02 5.15504915e-01
 3.15815654e+01 1.02507703e+01 1.75362015e+00 2.77349719e+00
 1.32990031e+01 5.99889284e-01]
E = -128.27960286630255
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:34 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2440.03799649        1
[INPUT] 0    0    [1    /1   ]  105.937523134        1
[INPUT] 0    0    [1    /1   ]  421.816628798        1
[INPUT] 0    0    [1    /1   ]  0.515504914847       1
[INPUT] 0    0    [1    /1   ]  31.5815654281        1
[INPUT] 0    0    [1    /1   ]  10.2507702801        1
[INPUT] 0    0    [1    /1   ]  1.75362015489        1
[INPUT] 1    0    [1    /1   ]  2.7734971877         1
[INPUT] 1    0    [1    /1   ]  13.299003083         1
[INPUT] 1    0    [1    /1   ]  0.599889284394       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2440.0379964861413, 1.0]], [0, [105.93752313439296, 1.0]], [0, [421.8166287979322, 1.0]], [0, [0.5155049148470904, 1.0]], [0, [31.581565428052514, 1.0]], [0, [10.250770280129375, 1.0]], [0, [1.7536201548919044, 1.0]], [1, [2.7734971876959356, 1.0]], [1, [13.299003082979802, 1.0]], [1, [0.5998892843943708, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2440.03799649]
bas 1, expnt(s) = [105.93752313]
bas 2, expnt(s) = [421.8166288]
bas 3, expnt(s) = [0.51550491]
bas 4, expnt(s) = [31.58156543]
bas 5, expnt(s) = [10.25077028]
bas 6, expnt(s) = [1.75362015]
bas 7, expnt(s) = [2.77349719]
bas 8, expnt(s) = [13.29900308]
bas 9, expnt(s) = [0.59988928]
CPU time:       410.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44003800e+03 8.77126972e+02 1.05937523e+02 8.34261852e+01
 4.21816629e+02 2.35156938e+02 5.15504915e-01 1.53705579e+00
 3.15815654e+01 3.36581518e+01 1.02507703e+01 1.44737944e+01
 1.75362015e+00 3.85005267e+00 2.77349719e+00 1.04416482e+01
 1.32990031e+01 7.40897707e+01 5.99889284e-01 1.54018636e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966921977764027
cond(S) = 77.23062041009106
E1 = -183.22919271881625  E_coul = 55.00788770959262
init E= -128.221305009224
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742998155547816  LUMO = 2.29485030718632
  mo_energy =
[-3.25526666e+01 -1.85680848e+00 -7.42998156e-01 -7.42998156e-01
 -7.42998156e-01  2.29485031e+00  2.65348480e+00  2.65348480e+00
  2.65348480e+00  1.99105009e+01  1.99105009e+01  1.99105009e+01
  2.89000884e+01  1.68184826e+02  8.00437730e+02  4.57611571e+03]
E1 = -182.1847262238438  E_coul = 53.90713432836255
cycle= 1 E= -128.277591895481  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269282
diis-c [-0.07251302  1.        ]
  HOMO = -0.810112477457281  LUMO = 2.25066309492682
  mo_energy =
[-3.28312207e+01 -1.92507618e+00 -8.10112477e-01 -8.10112477e-01
 -8.10112477e-01  2.25066309e+00  2.59742514e+00  2.59742514e+00
  2.59742514e+00  1.97156592e+01  1.97156592e+01  1.97156592e+01
  2.86940482e+01  1.67895275e+02  8.00098058e+02  4.57573400e+03]
E1 = -182.6579660901232  E_coul = 54.37868214163678
cycle= 2 E= -128.279283948486  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105732
diis-c [-2.21230299e-04  2.80230053e-01  7.19769947e-01]
  HOMO = -0.786855626984465  LUMO = 2.26820586945847
  mo_energy =
[-3.27550595e+01 -1.90101779e+00 -7.86855627e-01 -7.86855627e-01
 -7.86855627e-01  2.26820587e+00  2.61845409e+00  2.61845409e+00
  2.61845409e+00  1.97728498e+01  1.97728498e+01  1.97728498e+01
  2.87536063e+01  1.67973598e+02  8.00184334e+02  4.57582407e+03]
E1 = -182.52262209267738  E_coul = 54.243019241704964
cycle= 3 E= -128.279602850972  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000700294
diis-c [-3.36052453e-08 -4.45468540e-03 -5.06572319e-03  1.00952041e+00]
  HOMO = -0.787042680072438  LUMO = 2.26807077303007
  mo_energy =
[-3.27555267e+01 -1.90123107e+00 -7.87042680e-01 -7.87042680e-01
 -7.87042680e-01  2.26807077e+00  2.61832331e+00  2.61832331e+00
  2.61832331e+00  1.97724773e+01  1.97724773e+01  1.97724773e+01
  2.87531827e+01  1.67973220e+02  8.00184100e+02  4.57582393e+03]
E1 = -182.52355005728433  E_coul = 54.2439471910275
cycle= 4 E= -128.279602866257  delta_E= -1.53e-08  |g|= 2.15e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.61512e-05
diis-c [-1.29726441e-10  2.35826816e-04 -2.04513351e-04 -7.93413804e-02
  1.07931007e+00]
  HOMO = -0.787035777222441  LUMO = 2.2680724722918
  mo_energy =
[-3.27555091e+01 -1.90122810e+00 -7.87035777e-01 -7.87035777e-01
 -7.87035777e-01  2.26807247e+00  2.61832908e+00  2.61832908e+00
  2.61832908e+00  1.97724913e+01  1.97724913e+01  1.97724913e+01
  2.87531951e+01  1.67973241e+02  8.00184128e+02  4.57582396e+03]
E1 = -182.52352088553684  E_coul = 54.24391801923464
cycle= 5 E= -128.279602866302  delta_E= -4.54e-11  |g|= 1.75e-06  |ddm|= 8.38e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52352088553684  E_coul = 54.24391801923464
  HOMO = -0.787035371079122  LUMO = 2.26807244081432
  mo_energy =
[-3.27555082e+01 -1.90122812e+00 -7.87035371e-01 -7.87035371e-01
 -7.87035371e-01  2.26807244e+00  2.61832945e+00  2.61832945e+00
  2.61832945e+00  1.97724920e+01  1.97724920e+01  1.97724920e+01
  2.87531957e+01  1.67973242e+02  8.00184129e+02  4.57582397e+03]
E1 = -182.5235194034784  E_coul = 54.24391653717583
Extra cycle  E= -128.279602866303  delta_E= -3.69e-13  |g|= 4.01e-07  |ddm|= 9.77e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.23062041009106
E1 = -182.5235194034784  E_coul = 54.24391653717583
init E= -128.279602866303
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787035451781391  LUMO = 2.26807231373056
  mo_energy =
[-3.27555085e+01 -1.90122828e+00 -7.87035452e-01 -7.87035452e-01
 -7.87035452e-01  2.26807231e+00  2.61832937e+00  2.61832937e+00
  2.61832937e+00  1.97724918e+01  1.97724918e+01  1.97724918e+01
  2.87531954e+01  1.67973241e+02  8.00184129e+02  4.57582397e+03]
E1 = -182.5235200410778  E_coul = 54.2439171747753
cycle= 1 E= -128.279602866302  delta_E= 5.68e-14  |g|= 1.01e-07  |ddm|= 2.37e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5235200410778  E_coul = 54.2439171747753
  HOMO = -0.787035404171666  LUMO = 2.26807233729946
  mo_energy =
[-3.27555084e+01 -1.90122825e+00 -7.87035404e-01 -7.87035404e-01
 -7.87035404e-01  2.26807234e+00  2.61832942e+00  2.61832942e+00
  2.61832942e+00  1.97724919e+01  1.97724919e+01  1.97724919e+01
  2.87531955e+01  1.67973241e+02  8.00184129e+02  4.57582397e+03]
E1 = -182.5235197958767  E_coul = 54.24391692957412
Extra cycle  E= -128.279602866303  delta_E= -8.53e-14  |g|= 3.64e-08  |ddm|= 3.96e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.44003800e+03 1.05937523e+02 4.21816629e+02 5.15504915e-01
 3.15815654e+01 1.02507703e+01 1.75362015e+00 2.77349719e+00
 1.32990031e+01 5.99889284e-01]
grad_E = [-1.08373682e-05 -1.80937696e-05 -3.84335498e-06 -3.56208727e-05
  1.44638043e-04 -2.72553965e-04 -9.95574191e-05  6.12364713e-04
 -2.00954713e-04  8.82888867e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:37 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2440.83454865        1
[INPUT] 0    0    [1    /1   ]  105.991480669        1
[INPUT] 0    0    [1    /1   ]  421.832885033        1
[INPUT] 0    0    [1    /1   ]  0.51536243785        1
[INPUT] 0    0    [1    /1   ]  31.6104962963        1
[INPUT] 0    0    [1    /1   ]  10.2548688043        1
[INPUT] 0    0    [1    /1   ]  1.75309417988        1
[INPUT] 1    0    [1    /1   ]  2.7729416968         1
[INPUT] 1    0    [1    /1   ]  13.2908266081        1
[INPUT] 1    0    [1    /1   ]  0.599870162217       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2440.834548651207, 1.0]], [0, [105.99148066859884, 1.0]], [0, [421.83288503265135, 1.0]], [0, [0.5153624378502727, 1.0]], [0, [31.61049629628935, 1.0]], [0, [10.254868804281685, 1.0]], [0, [1.7530941798792887, 1.0]], [1, [2.772941696799582, 1.0]], [1, [13.290826608133253, 1.0]], [1, [0.5998701622166035, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2440.83454865]
bas 1, expnt(s) = [105.99148067]
bas 2, expnt(s) = [421.83288503]
bas 3, expnt(s) = [0.51536244]
bas 4, expnt(s) = [31.6104963]
bas 5, expnt(s) = [10.2548688]
bas 6, expnt(s) = [1.75309418]
bas 7, expnt(s) = [2.7729417]
bas 8, expnt(s) = [13.29082661]
bas 9, expnt(s) = [0.59987016]
CPU time:       413.47
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44083455e+03 8.77341718e+02 1.05991481e+02 8.34580520e+01
 4.21832885e+02 2.35163735e+02 5.15362438e-01 1.53673717e+00
 3.16104963e+01 3.36812740e+01 1.02548688e+01 1.44781345e+01
 1.75309418e+00 3.84918656e+00 2.77294170e+00 1.04390341e+01
 1.32908266e+01 7.40328354e+01 5.99870162e-01 1.54012499e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966929212567353
cond(S) = 77.2153835258049
E1 = -183.22922873415857  E_coul = 55.007894615244865
init E= -128.221334118914
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742990482607349  LUMO = 2.29386285606124
  mo_energy =
[-3.25526949e+01 -1.85680229e+00 -7.42990483e-01 -7.42990483e-01
 -7.42990483e-01  2.29386286e+00  2.65323820e+00  2.65323820e+00
  2.65323820e+00  1.99001642e+01  1.99001642e+01  1.99001642e+01
  2.89170213e+01  1.68312187e+02  8.00731812e+02  4.57746461e+03]
E1 = -182.1847231266294  E_coul = 53.90712665649989
cycle= 1 E= -128.27759647013  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269309
diis-c [-0.0725276  1.       ]
  HOMO = -0.810109765579143  LUMO = 2.24969213492123
  mo_energy =
[-3.28312422e+01 -1.92506898e+00 -8.10109766e-01 -8.10109766e-01
 -8.10109766e-01  2.24969213e+00  2.59718177e+00  2.59718177e+00
  2.59718177e+00  1.97053690e+01  1.97053690e+01  1.97053690e+01
  2.87109229e+01  1.68022608e+02  8.00392155e+02  4.57708291e+03]
E1 = -182.65798939449468  E_coul = 54.37870083246415
cycle= 2 E= -128.279288562031  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10574
diis-c [-2.21199820e-04  2.80225748e-01  7.19774252e-01]
  HOMO = -0.786851125090559  LUMO = 2.26723163812576
  mo_energy =
[-3.27550778e+01 -1.90100862e+00 -7.86851125e-01 -7.86851125e-01
 -7.86851125e-01  2.26723164e+00  2.61820966e+00  2.61820966e+00
  2.61820966e+00  1.97625496e+01  1.97625496e+01  1.97625496e+01
  2.87704986e+01  1.68100940e+02  8.00478432e+02  4.57717298e+03]
E1 = -182.52263183190826  E_coul = 54.24302432742468
cycle= 3 E= -128.279607504484  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000701938
diis-c [-3.31400203e-08 -4.43820831e-03 -5.00209461e-03  1.00944030e+00]
  HOMO = -0.787038600327438  LUMO = 2.2670965334559
  mo_energy =
[-3.27555463e+01 -1.90122198e+00 -7.87038600e-01 -7.87038600e-01
 -7.87038600e-01  2.26709653e+00  2.61807851e+00  2.61807851e+00
  2.61807851e+00  1.97621762e+01  1.97621762e+01  1.97621762e+01
  2.87700742e+01  1.68100560e+02  8.00478196e+02  4.57717284e+03]
E1 = -182.52356175415576  E_coul = 54.24395423434601
cycle= 4 E= -128.27960751981  delta_E= -1.53e-08  |g|= 2.13e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.57553e-05
diis-c [-1.26707326e-10  2.33063275e-04 -2.05886044e-04 -7.86948074e-02
  1.07866763e+00]
  HOMO = -0.787031770974119  LUMO = 2.26709822844755
  mo_energy =
[-3.27555289e+01 -1.90121903e+00 -7.87031771e-01 -7.87031771e-01
 -7.87031771e-01  2.26709823e+00  2.61808422e+00  2.61808422e+00
  2.61808422e+00  1.97621900e+01  1.97621900e+01  1.97621900e+01
  2.87700864e+01  1.68100580e+02  8.00478223e+02  4.57717288e+03]
E1 = -182.52353286701094  E_coul = 54.24392534715698
cycle= 5 E= -128.279607519854  delta_E= -4.42e-11  |g|= 1.73e-06  |ddm|= 8.25e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52353286701094  E_coul = 54.24392534715698
  HOMO = -0.787031366612779  LUMO = 2.26709819913669
  mo_energy =
[-3.27555279e+01 -1.90121905e+00 -7.87031367e-01 -7.87031367e-01
 -7.87031367e-01  2.26709820e+00  2.61808459e+00  2.61808459e+00
  2.61808459e+00  1.97621907e+01  1.97621907e+01  1.97621907e+01
  2.87700871e+01  1.68100581e+02  8.00478224e+02  4.57717288e+03]
E1 = -182.52353138786467  E_coul = 54.24392386801045
Extra cycle  E= -128.279607519854  delta_E= -2.56e-13  |g|= 3.98e-07  |ddm|= 9.67e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.44083455e+03 1.05991481e+02 4.21832885e+02 5.15362438e-01
 3.16104963e+01 1.02548688e+01 1.75309418e+00 2.77294170e+00
 1.32908266e+01 5.99870162e-01]
E = -128.2796075198542
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2440.83454865        1
[INPUT] 0    0    [1    /1   ]  105.991480669        1
[INPUT] 0    0    [1    /1   ]  421.832885033        1
[INPUT] 0    0    [1    /1   ]  0.51536243785        1
[INPUT] 0    0    [1    /1   ]  31.6104962963        1
[INPUT] 0    0    [1    /1   ]  10.2548688043        1
[INPUT] 0    0    [1    /1   ]  1.75309417988        1
[INPUT] 1    0    [1    /1   ]  2.7729416968         1
[INPUT] 1    0    [1    /1   ]  13.2908266081        1
[INPUT] 1    0    [1    /1   ]  0.599870162217       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2440.834548651207, 1.0]], [0, [105.99148066859884, 1.0]], [0, [421.83288503265135, 1.0]], [0, [0.5153624378502727, 1.0]], [0, [31.61049629628935, 1.0]], [0, [10.254868804281685, 1.0]], [0, [1.7530941798792887, 1.0]], [1, [2.772941696799582, 1.0]], [1, [13.290826608133253, 1.0]], [1, [0.5998701622166035, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2440.83454865]
bas 1, expnt(s) = [105.99148067]
bas 2, expnt(s) = [421.83288503]
bas 3, expnt(s) = [0.51536244]
bas 4, expnt(s) = [31.6104963]
bas 5, expnt(s) = [10.2548688]
bas 6, expnt(s) = [1.75309418]
bas 7, expnt(s) = [2.7729417]
bas 8, expnt(s) = [13.29082661]
bas 9, expnt(s) = [0.59987016]
CPU time:       414.95
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44083455e+03 8.77341718e+02 1.05991481e+02 8.34580520e+01
 4.21832885e+02 2.35163735e+02 5.15362438e-01 1.53673717e+00
 3.16104963e+01 3.36812740e+01 1.02548688e+01 1.44781345e+01
 1.75309418e+00 3.84918656e+00 2.77294170e+00 1.04390341e+01
 1.32908266e+01 7.40328354e+01 5.99870162e-01 1.54012499e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966929212567353
cond(S) = 77.2153835258049
E1 = -183.22922873415857  E_coul = 55.007894615244865
init E= -128.221334118914
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742990482607349  LUMO = 2.29386285606124
  mo_energy =
[-3.25526949e+01 -1.85680229e+00 -7.42990483e-01 -7.42990483e-01
 -7.42990483e-01  2.29386286e+00  2.65323820e+00  2.65323820e+00
  2.65323820e+00  1.99001642e+01  1.99001642e+01  1.99001642e+01
  2.89170213e+01  1.68312187e+02  8.00731812e+02  4.57746461e+03]
E1 = -182.1847231266294  E_coul = 53.90712665649989
cycle= 1 E= -128.27759647013  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269309
diis-c [-0.0725276  1.       ]
  HOMO = -0.810109765579143  LUMO = 2.24969213492123
  mo_energy =
[-3.28312422e+01 -1.92506898e+00 -8.10109766e-01 -8.10109766e-01
 -8.10109766e-01  2.24969213e+00  2.59718177e+00  2.59718177e+00
  2.59718177e+00  1.97053690e+01  1.97053690e+01  1.97053690e+01
  2.87109229e+01  1.68022608e+02  8.00392155e+02  4.57708291e+03]
E1 = -182.65798939449468  E_coul = 54.37870083246415
cycle= 2 E= -128.279288562031  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10574
diis-c [-2.21199820e-04  2.80225748e-01  7.19774252e-01]
  HOMO = -0.786851125090559  LUMO = 2.26723163812576
  mo_energy =
[-3.27550778e+01 -1.90100862e+00 -7.86851125e-01 -7.86851125e-01
 -7.86851125e-01  2.26723164e+00  2.61820966e+00  2.61820966e+00
  2.61820966e+00  1.97625496e+01  1.97625496e+01  1.97625496e+01
  2.87704986e+01  1.68100940e+02  8.00478432e+02  4.57717298e+03]
E1 = -182.52263183190826  E_coul = 54.24302432742468
cycle= 3 E= -128.279607504484  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000701938
diis-c [-3.31400203e-08 -4.43820831e-03 -5.00209461e-03  1.00944030e+00]
  HOMO = -0.787038600327438  LUMO = 2.2670965334559
  mo_energy =
[-3.27555463e+01 -1.90122198e+00 -7.87038600e-01 -7.87038600e-01
 -7.87038600e-01  2.26709653e+00  2.61807851e+00  2.61807851e+00
  2.61807851e+00  1.97621762e+01  1.97621762e+01  1.97621762e+01
  2.87700742e+01  1.68100560e+02  8.00478196e+02  4.57717284e+03]
E1 = -182.52356175415576  E_coul = 54.24395423434601
cycle= 4 E= -128.27960751981  delta_E= -1.53e-08  |g|= 2.13e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.57553e-05
diis-c [-1.26707326e-10  2.33063275e-04 -2.05886044e-04 -7.86948074e-02
  1.07866763e+00]
  HOMO = -0.787031770974119  LUMO = 2.26709822844755
  mo_energy =
[-3.27555289e+01 -1.90121903e+00 -7.87031771e-01 -7.87031771e-01
 -7.87031771e-01  2.26709823e+00  2.61808422e+00  2.61808422e+00
  2.61808422e+00  1.97621900e+01  1.97621900e+01  1.97621900e+01
  2.87700864e+01  1.68100580e+02  8.00478223e+02  4.57717288e+03]
E1 = -182.52353286701094  E_coul = 54.24392534715698
cycle= 5 E= -128.279607519854  delta_E= -4.42e-11  |g|= 1.73e-06  |ddm|= 8.25e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52353286701094  E_coul = 54.24392534715698
  HOMO = -0.787031366612779  LUMO = 2.26709819913669
  mo_energy =
[-3.27555279e+01 -1.90121905e+00 -7.87031367e-01 -7.87031367e-01
 -7.87031367e-01  2.26709820e+00  2.61808459e+00  2.61808459e+00
  2.61808459e+00  1.97621907e+01  1.97621907e+01  1.97621907e+01
  2.87700871e+01  1.68100581e+02  8.00478224e+02  4.57717288e+03]
E1 = -182.52353138786467  E_coul = 54.24392386801045
Extra cycle  E= -128.279607519854  delta_E= -2.56e-13  |g|= 3.98e-07  |ddm|= 9.67e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.2153835258049
E1 = -182.52353138786467  E_coul = 54.24392386801045
init E= -128.279607519854
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.78703144732859  LUMO = 2.26709807276906
  mo_energy =
[-3.27555283e+01 -1.90121921e+00 -7.87031447e-01 -7.87031447e-01
 -7.87031447e-01  2.26709807e+00  2.61808451e+00  2.61808451e+00
  2.61808451e+00  1.97621905e+01  1.97621905e+01  1.97621905e+01
  2.87700868e+01  1.68100581e+02  8.00478224e+02  4.57717288e+03]
E1 = -182.5235320239321  E_coul = 54.243924504077725
cycle= 1 E= -128.279607519854  delta_E= -1.71e-13  |g|= 1e-07  |ddm|= 2.35e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5235320239321  E_coul = 54.243924504077725
  HOMO = -0.787031399863037  LUMO = 2.2670980963506
  mo_energy =
[-3.27555281e+01 -1.90121918e+00 -7.87031400e-01 -7.87031400e-01
 -7.87031400e-01  2.26709810e+00  2.61808455e+00  2.61808455e+00
  2.61808455e+00  1.97621906e+01  1.97621906e+01  1.97621906e+01
  2.87700869e+01  1.68100581e+02  8.00478224e+02  4.57717288e+03]
E1 = -182.52353177925443  E_coul = 54.243924259400195
Extra cycle  E= -128.279607519854  delta_E= 1.42e-13  |g|= 3.62e-08  |ddm|= 3.93e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.44083455e+03 1.05991481e+02 4.21832885e+02 5.15362438e-01
 3.16104963e+01 1.02548688e+01 1.75309418e+00 2.77294170e+00
 1.32908266e+01 5.99870162e-01]
grad_E = [-1.07941863e-05 -2.42299063e-05 -4.06898139e-06 -4.75633073e-05
  1.94295631e-04 -3.66066390e-04 -1.33836214e-04  8.21279553e-04
 -2.69742686e-04  1.18615325e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2442.28357515        1
[INPUT] 0    0    [1    /1   ]  106.074629444        1
[INPUT] 0    0    [1    /1   ]  421.896153278        1
[INPUT] 0    0    [1    /1   ]  0.515166092431       1
[INPUT] 0    0    [1    /1   ]  31.6528212744        1
[INPUT] 0    0    [1    /1   ]  10.260980535         1
[INPUT] 0    0    [1    /1   ]  1.75236512874        1
[INPUT] 1    0    [1    /1   ]  2.77216674407        1
[INPUT] 1    0    [1    /1   ]  13.2793820536        1
[INPUT] 1    0    [1    /1   ]  0.599844203052       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2442.2835751504126, 1.0]], [0, [106.0746294440795, 1.0]], [0, [421.8961532779901, 1.0]], [0, [0.5151660924307931, 1.0]], [0, [31.65282127437614, 1.0]], [0, [10.260980534981597, 1.0]], [0, [1.752365128740841, 1.0]], [1, [2.772166744068443, 1.0]], [1, [13.279382053550187, 1.0]], [1, [0.5998442030516478, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2442.28357515]
bas 1, expnt(s) = [106.07462944]
bas 2, expnt(s) = [421.89615328]
bas 3, expnt(s) = [0.51516609]
bas 4, expnt(s) = [31.65282127]
bas 5, expnt(s) = [10.26098053]
bas 6, expnt(s) = [1.75236513]
bas 7, expnt(s) = [2.77216674]
bas 8, expnt(s) = [13.27938205]
bas 9, expnt(s) = [0.5998442]
CPU time:       418.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44228358e+03 8.77732321e+02 1.06074629e+02 8.35071509e+01
 4.21896153e+02 2.35190188e+02 5.15166092e-01 1.53629804e+00
 3.16528213e+01 3.37150916e+01 1.02609805e+01 1.44846055e+01
 1.75236513e+00 3.84798594e+00 2.77216674e+00 1.04353875e+01
 1.32793821e+01 7.39531581e+01 5.99844203e-01 1.54004168e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966939108535144
cond(S) = 77.18759938286723
E1 = -183.22927859147768  E_coul = 55.007904096851284
init E= -128.221374494626
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742979597743262  LUMO = 2.29250535604963
  mo_energy =
[-3.25527358e+01 -1.85679367e+00 -7.42979598e-01 -7.42979598e-01
 -7.42979598e-01  2.29250536e+00  2.65289750e+00  2.65289750e+00
  2.65289750e+00  1.98857105e+01  1.98857105e+01  1.98857105e+01
  2.89423103e+01  1.68502793e+02  8.01217077e+02  4.57993525e+03]
E1 = -182.18472604342364  E_coul = 53.90712147423904
cycle= 1 E= -128.277604569185  delta_E= -0.0562  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269346
diis-c [-0.07254713  1.        ]
  HOMO = -0.810105397436237  LUMO = 2.24835732466823
  mo_energy =
[-3.28312725e+01 -1.92505855e+00 -8.10105397e-01 -8.10105397e-01
 -8.10105397e-01  2.24835732e+00  2.59684594e+00  2.59684594e+00
  2.59684594e+00  1.96909812e+01  1.96909812e+01  1.96909812e+01
  2.87361267e+01  1.68213172e+02  8.00877440e+02  4.57955356e+03]
E1 = -182.6580267436786  E_coul = 54.3787300424645
cycle= 2 E= -128.279296701214  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105751
diis-c [-2.21164435e-04  2.80219348e-01  7.19780652e-01]
  HOMO = -0.786844363654069  LUMO = 2.26589236349768
  mo_energy =
[-3.27551040e+01 -1.90099555e+00 -7.86844364e-01 -7.86844364e-01
 -7.86844364e-01  2.26589236e+00  2.61787226e+00  2.61787226e+00
  2.61787226e+00  1.97481475e+01  1.97481475e+01  1.97481475e+01
  2.87957279e+01  1.68291516e+02  8.00963719e+02  4.57964363e+03]
E1 = -182.52265100450623  E_coul = 54.243035308507245
cycle= 3 E= -128.279615695999  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000704265
diis-c [-3.24970767e-08 -4.41504792e-03 -4.91265049e-03  1.00932770e+00]
  HOMO = -0.787032432325385  LUMO = 2.26575724207957
  mo_energy =
[-3.27555742e+01 -1.90120904e+00 -7.87032432e-01 -7.87032432e-01
 -7.87032432e-01  2.26575724e+00  2.61774059e+00  2.61774059e+00
  2.61774059e+00  1.97477728e+01  1.97477728e+01  1.97477728e+01
  2.87953022e+01  1.68291134e+02  8.00963479e+02  4.57964349e+03]
E1 = -182.5235836895032  E_coul = 54.243967978118036
cycle= 4 E= -128.279615711385  delta_E= -1.54e-08  |g|= 2.09e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.52031e-05
diis-c [-1.22528548e-10  2.29186479e-04 -2.07777786e-04 -7.77838360e-02
  1.07776243e+00]
  HOMO = -0.787025705459948  LUMO = 2.26575893111801
  mo_energy =
[-3.27555570e+01 -1.90120609e+00 -7.87025705e-01 -7.87025705e-01
 -7.87025705e-01  2.26575893e+00  2.61774621e+00  2.61774621e+00
  2.61774621e+00  1.97477864e+01  1.97477864e+01  1.97477864e+01
  2.87953144e+01  1.68291154e+02  8.00963507e+02  4.57964352e+03]
E1 = -182.52355519909082  E_coul = 54.24393948766281
cycle= 5 E= -128.279615711428  delta_E= -4.29e-11  |g|= 1.71e-06  |ddm|= 8.06e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52355519909082  E_coul = 54.24393948766281
  HOMO = -0.787025303687545  LUMO = 2.26575890481243
  mo_energy =
[-3.27555561e+01 -1.90120611e+00 -7.87025304e-01 -7.87025304e-01
 -7.87025304e-01  2.26575890e+00  2.61774658e+00  2.61774658e+00
  2.61774658e+00  1.97477872e+01  1.97477872e+01  1.97477872e+01
  2.87953150e+01  1.68291155e+02  8.00963508e+02  4.57964352e+03]
E1 = -182.52355372441374  E_coul = 54.24393801298553
Extra cycle  E= -128.279615711428  delta_E= -1.99e-13  |g|= 3.94e-07  |ddm|= 9.52e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.44228358e+03 1.06074629e+02 4.21896153e+02 5.15166092e-01
 3.16528213e+01 1.02609805e+01 1.75236513e+00 2.77216674e+00
 1.32793821e+01 5.99844203e-01]
E = -128.27961571142822
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2442.28357515        1
[INPUT] 0    0    [1    /1   ]  106.074629444        1
[INPUT] 0    0    [1    /1   ]  421.896153278        1
[INPUT] 0    0    [1    /1   ]  0.515166092431       1
[INPUT] 0    0    [1    /1   ]  31.6528212744        1
[INPUT] 0    0    [1    /1   ]  10.260980535         1
[INPUT] 0    0    [1    /1   ]  1.75236512874        1
[INPUT] 1    0    [1    /1   ]  2.77216674407        1
[INPUT] 1    0    [1    /1   ]  13.2793820536        1
[INPUT] 1    0    [1    /1   ]  0.599844203052       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2442.2835751504126, 1.0]], [0, [106.0746294440795, 1.0]], [0, [421.8961532779901, 1.0]], [0, [0.5151660924307931, 1.0]], [0, [31.65282127437614, 1.0]], [0, [10.260980534981597, 1.0]], [0, [1.752365128740841, 1.0]], [1, [2.772166744068443, 1.0]], [1, [13.279382053550187, 1.0]], [1, [0.5998442030516478, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2442.28357515]
bas 1, expnt(s) = [106.07462944]
bas 2, expnt(s) = [421.89615328]
bas 3, expnt(s) = [0.51516609]
bas 4, expnt(s) = [31.65282127]
bas 5, expnt(s) = [10.26098053]
bas 6, expnt(s) = [1.75236513]
bas 7, expnt(s) = [2.77216674]
bas 8, expnt(s) = [13.27938205]
bas 9, expnt(s) = [0.5998442]
CPU time:       419.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44228358e+03 8.77732321e+02 1.06074629e+02 8.35071509e+01
 4.21896153e+02 2.35190188e+02 5.15166092e-01 1.53629804e+00
 3.16528213e+01 3.37150916e+01 1.02609805e+01 1.44846055e+01
 1.75236513e+00 3.84798594e+00 2.77216674e+00 1.04353875e+01
 1.32793821e+01 7.39531581e+01 5.99844203e-01 1.54004168e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966939108535144
cond(S) = 77.18759938286723
E1 = -183.22927859147768  E_coul = 55.007904096851284
init E= -128.221374494626
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742979597743262  LUMO = 2.29250535604963
  mo_energy =
[-3.25527358e+01 -1.85679367e+00 -7.42979598e-01 -7.42979598e-01
 -7.42979598e-01  2.29250536e+00  2.65289750e+00  2.65289750e+00
  2.65289750e+00  1.98857105e+01  1.98857105e+01  1.98857105e+01
  2.89423103e+01  1.68502793e+02  8.01217077e+02  4.57993525e+03]
E1 = -182.18472604342364  E_coul = 53.90712147423904
cycle= 1 E= -128.277604569185  delta_E= -0.0562  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269346
diis-c [-0.07254713  1.        ]
  HOMO = -0.810105397436237  LUMO = 2.24835732466823
  mo_energy =
[-3.28312725e+01 -1.92505855e+00 -8.10105397e-01 -8.10105397e-01
 -8.10105397e-01  2.24835732e+00  2.59684594e+00  2.59684594e+00
  2.59684594e+00  1.96909812e+01  1.96909812e+01  1.96909812e+01
  2.87361267e+01  1.68213172e+02  8.00877440e+02  4.57955356e+03]
E1 = -182.6580267436786  E_coul = 54.3787300424645
cycle= 2 E= -128.279296701214  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105751
diis-c [-2.21164435e-04  2.80219348e-01  7.19780652e-01]
  HOMO = -0.786844363654069  LUMO = 2.26589236349768
  mo_energy =
[-3.27551040e+01 -1.90099555e+00 -7.86844364e-01 -7.86844364e-01
 -7.86844364e-01  2.26589236e+00  2.61787226e+00  2.61787226e+00
  2.61787226e+00  1.97481475e+01  1.97481475e+01  1.97481475e+01
  2.87957279e+01  1.68291516e+02  8.00963719e+02  4.57964363e+03]
E1 = -182.52265100450623  E_coul = 54.243035308507245
cycle= 3 E= -128.279615695999  delta_E= -0.000319  |g|= 0.000514  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000704265
diis-c [-3.24970767e-08 -4.41504792e-03 -4.91265049e-03  1.00932770e+00]
  HOMO = -0.787032432325385  LUMO = 2.26575724207957
  mo_energy =
[-3.27555742e+01 -1.90120904e+00 -7.87032432e-01 -7.87032432e-01
 -7.87032432e-01  2.26575724e+00  2.61774059e+00  2.61774059e+00
  2.61774059e+00  1.97477728e+01  1.97477728e+01  1.97477728e+01
  2.87953022e+01  1.68291134e+02  8.00963479e+02  4.57964349e+03]
E1 = -182.5235836895032  E_coul = 54.243967978118036
cycle= 4 E= -128.279615711385  delta_E= -1.54e-08  |g|= 2.09e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.52031e-05
diis-c [-1.22528548e-10  2.29186479e-04 -2.07777786e-04 -7.77838360e-02
  1.07776243e+00]
  HOMO = -0.787025705459948  LUMO = 2.26575893111801
  mo_energy =
[-3.27555570e+01 -1.90120609e+00 -7.87025705e-01 -7.87025705e-01
 -7.87025705e-01  2.26575893e+00  2.61774621e+00  2.61774621e+00
  2.61774621e+00  1.97477864e+01  1.97477864e+01  1.97477864e+01
  2.87953144e+01  1.68291154e+02  8.00963507e+02  4.57964352e+03]
E1 = -182.52355519909082  E_coul = 54.24393948766281
cycle= 5 E= -128.279615711428  delta_E= -4.29e-11  |g|= 1.71e-06  |ddm|= 8.06e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52355519909082  E_coul = 54.24393948766281
  HOMO = -0.787025303687545  LUMO = 2.26575890481243
  mo_energy =
[-3.27555561e+01 -1.90120611e+00 -7.87025304e-01 -7.87025304e-01
 -7.87025304e-01  2.26575890e+00  2.61774658e+00  2.61774658e+00
  2.61774658e+00  1.97477872e+01  1.97477872e+01  1.97477872e+01
  2.87953150e+01  1.68291155e+02  8.00963508e+02  4.57964352e+03]
E1 = -182.52355372441374  E_coul = 54.24393801298553
Extra cycle  E= -128.279615711428  delta_E= -1.99e-13  |g|= 3.94e-07  |ddm|= 9.52e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.18759938286723
E1 = -182.52355372441374  E_coul = 54.24393801298553
init E= -128.279615711428
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787025384398424  LUMO = 2.26575877947226
  mo_energy =
[-3.27555564e+01 -1.90120627e+00 -7.87025384e-01 -7.87025384e-01
 -7.87025384e-01  2.26575878e+00  2.61774650e+00  2.61774650e+00
  2.61774650e+00  1.97477869e+01  1.97477869e+01  1.97477869e+01
  2.87953147e+01  1.68291155e+02  8.00963508e+02  4.57964352e+03]
E1 = -182.52355435816858  E_coul = 54.243938646740425
cycle= 1 E= -128.279615711428  delta_E= 5.68e-14  |g|= 9.96e-08  |ddm|= 2.32e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52355435816858  E_coul = 54.243938646740425
  HOMO = -0.787025337146762  LUMO = 2.26575880306438
  mo_energy =
[-3.27555563e+01 -1.90120624e+00 -7.87025337e-01 -7.87025337e-01
 -7.87025337e-01  2.26575880e+00  2.61774654e+00  2.61774654e+00
  2.61774654e+00  1.97477870e+01  1.97477870e+01  1.97477870e+01
  2.87953148e+01  1.68291155e+02  8.00963508e+02  4.57964352e+03]
E1 = -182.52355411428948  E_coul = 54.24393840286126
Extra cycle  E= -128.279615711428  delta_E= -5.68e-14  |g|= 3.61e-08  |ddm|= 3.9e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.44228358e+03 1.06074629e+02 4.21896153e+02 5.15166092e-01
 3.16528213e+01 1.02609805e+01 1.75236513e+00 2.77216674e+00
 1.32793821e+01 5.99844203e-01]
grad_E = [-1.07276738e-05 -3.28510760e-05 -4.38393713e-06 -6.44594943e-05
  2.64076461e-04 -4.97515753e-04 -1.82002404e-04  1.11500818e-03
 -3.66459397e-04  1.61236954e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2444.89721831        1
[INPUT] 0    0    [1    /1   ]  106.202894703        1
[INPUT] 0    0    [1    /1   ]  422.058667667        1
[INPUT] 0    0    [1    /1   ]  0.514903071099       1
[INPUT] 0    0    [1    /1   ]  31.7142936165        1
[INPUT] 0    0    [1    /1   ]  10.2700729624        1
[INPUT] 0    0    [1    /1   ]  1.75138008395        1
[INPUT] 1    0    [1    /1   ]  2.77111057947        1
[INPUT] 1    0    [1    /1   ]  13.2637083628        1
[INPUT] 1    0    [1    /1   ]  0.599810271558       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2444.897218306425, 1.0]], [0, [106.20289470276018, 1.0]], [0, [422.0586676665003, 1.0]], [0, [0.5149030710992728, 1.0]], [0, [31.71429361652376, 1.0]], [0, [10.270072962382207, 1.0]], [0, [1.751380083951317, 1.0]], [1, [2.7711105794662156, 1.0]], [1, [13.2637083627634, 1.0]], [1, [0.5998102715582411, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2444.89721831]
bas 1, expnt(s) = [106.2028947]
bas 2, expnt(s) = [422.05866767]
bas 3, expnt(s) = [0.51490307]
bas 4, expnt(s) = [31.71429362]
bas 5, expnt(s) = [10.27007296]
bas 6, expnt(s) = [1.75138008]
bas 7, expnt(s) = [2.77111058]
bas 8, expnt(s) = [13.26370836]
bas 9, expnt(s) = [0.59981027]
CPU time:       422.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44489722e+03 8.78436715e+02 1.06202895e+02 8.35828720e+01
 4.22058668e+02 2.35258131e+02 5.14903071e-01 1.53570973e+00
 3.17142936e+01 3.37641877e+01 1.02700730e+01 1.44942307e+01
 1.75138008e+00 3.84636354e+00 2.77111058e+00 1.04304180e+01
 1.32637084e+01 7.38440653e+01 5.99810272e-01 1.53993279e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966952205660323
cond(S) = 77.13757570519054
E1 = -183.22934566056352  E_coul = 55.00791677111632
init E= -128.221428889447
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742964409007006  LUMO = 2.29069300904326
  mo_energy =
[-3.25527941e+01 -1.85678196e+00 -7.42964409e-01 -7.42964409e-01
 -7.42964409e-01  2.29069301e+00  2.65243985e+00  2.65243985e+00
  2.65243985e+00  1.98659440e+01  1.98659440e+01  1.98659440e+01
  2.89799949e+01  1.68787315e+02  8.02020277e+02  4.58441503e+03]
E1 = -182.1847443170147  E_coul = 53.90712561807892
cycle= 1 E= -128.277618698936  delta_E= -0.0562  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269392
diis-c [-0.07257213  1.        ]
  HOMO = -0.810098274307545  LUMO = 2.24657534660185
  mo_energy =
[-3.28313140e+01 -1.92504352e+00 -8.10098274e-01 -8.10098274e-01
 -8.10098274e-01  2.24657535e+00  2.59639562e+00  2.59639562e+00
  2.59639562e+00  1.96713069e+01  1.96713069e+01  1.96713069e+01
  2.87736876e+01  1.68497634e+02  8.01680667e+02  4.58403336e+03]
E1 = -182.65808709820539  E_coul = 54.37877624123954
cycle= 2 E= -128.279310856966  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105763
diis-c [-2.21129842e-04  2.80209829e-01  7.19790171e-01]
  HOMO = -0.786834188778691  LUMO = 2.26410447985473
  mo_energy =
[-3.27551406e+01 -1.90097714e+00 -7.86834189e-01 -7.86834189e-01
 -7.86834189e-01  2.26410448e+00  2.61741965e+00  2.61741965e+00
  2.61741965e+00  1.97284530e+01  1.97284530e+01  1.97284530e+01
  2.88333252e+01  1.68575995e+02  8.01766948e+02  4.58412343e+03]
E1 = -182.52268808989402  E_coul = 54.24305817373158
cycle= 3 E= -128.279629916162  delta_E= -0.000319  |g|= 0.000515  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000707505
diis-c [-3.16318066e-08 -4.38313979e-03 -4.78937732e-03  1.00917252e+00]
  HOMO = -0.787023075769778  LUMO = 2.26396932516819
  mo_energy =
[-3.27556132e+01 -1.90119081e+00 -7.87023076e-01 -7.87023076e-01
 -7.87023076e-01  2.26396933e+00  2.61728726e+00  2.61728726e+00
  2.61728726e+00  1.97280767e+01  1.97280767e+01  1.97280767e+01
  2.88328980e+01  1.68575611e+02  8.01766704e+02  4.58412328e+03]
E1 = -182.5236246053558  E_coul = 54.24399467372092
cycle= 4 E= -128.279629931635  delta_E= -1.55e-08  |g|= 2.04e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.44504e-05
diis-c [-1.16894051e-10  2.23861517e-04 -2.10308597e-04 -7.65248175e-02
  1.07651126e+00]
  HOMO = -0.787016488576512  LUMO = 2.26397100609479
  mo_energy =
[-3.27555964e+01 -1.90118789e+00 -7.87016489e-01 -7.87016489e-01
 -7.87016489e-01  2.26397101e+00  2.61729276e+00  2.61729276e+00
  2.61729276e+00  1.97280900e+01  1.97280900e+01  1.97280900e+01
  2.88329099e+01  1.68575630e+02  8.01766731e+02  4.58412332e+03]
E1 = -182.52359665537577  E_coul = 54.24396672370051
cycle= 5 E= -128.279629931675  delta_E= -4.04e-11  |g|= 1.67e-06  |ddm|= 7.81e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52359665537577  E_coul = 54.24396672370051
  HOMO = -0.787016090535487  LUMO = 2.26397098385237
  mo_energy =
[-3.27555954e+01 -1.90118790e+00 -7.87016091e-01 -7.87016091e-01
 -7.87016091e-01  2.26397098e+00  2.61729312e+00  2.61729312e+00
  2.61729312e+00  1.97280907e+01  1.97280907e+01  1.97280907e+01
  2.88329105e+01  1.68575631e+02  8.01766732e+02  4.58412332e+03]
E1 = -182.52359518759258  E_coul = 54.24396525591676
Extra cycle  E= -128.279629931676  delta_E= -5.4e-13  |g|= 3.87e-07  |ddm|= 9.31e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.44489722e+03 1.06202895e+02 4.22058668e+02 5.14903071e-01
 3.17142936e+01 1.02700730e+01 1.75138008e+00 2.77111058e+00
 1.32637084e+01 5.99810272e-01]
E = -128.2796299316758
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:48 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2444.89721831        1
[INPUT] 0    0    [1    /1   ]  106.202894703        1
[INPUT] 0    0    [1    /1   ]  422.058667667        1
[INPUT] 0    0    [1    /1   ]  0.514903071099       1
[INPUT] 0    0    [1    /1   ]  31.7142936165        1
[INPUT] 0    0    [1    /1   ]  10.2700729624        1
[INPUT] 0    0    [1    /1   ]  1.75138008395        1
[INPUT] 1    0    [1    /1   ]  2.77111057947        1
[INPUT] 1    0    [1    /1   ]  13.2637083628        1
[INPUT] 1    0    [1    /1   ]  0.599810271558       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2444.897218306425, 1.0]], [0, [106.20289470276018, 1.0]], [0, [422.0586676665003, 1.0]], [0, [0.5149030710992728, 1.0]], [0, [31.71429361652376, 1.0]], [0, [10.270072962382207, 1.0]], [0, [1.751380083951317, 1.0]], [1, [2.7711105794662156, 1.0]], [1, [13.2637083627634, 1.0]], [1, [0.5998102715582411, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2444.89721831]
bas 1, expnt(s) = [106.2028947]
bas 2, expnt(s) = [422.05866767]
bas 3, expnt(s) = [0.51490307]
bas 4, expnt(s) = [31.71429362]
bas 5, expnt(s) = [10.27007296]
bas 6, expnt(s) = [1.75138008]
bas 7, expnt(s) = [2.77111058]
bas 8, expnt(s) = [13.26370836]
bas 9, expnt(s) = [0.59981027]
CPU time:       424.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44489722e+03 8.78436715e+02 1.06202895e+02 8.35828720e+01
 4.22058668e+02 2.35258131e+02 5.14903071e-01 1.53570973e+00
 3.17142936e+01 3.37641877e+01 1.02700730e+01 1.44942307e+01
 1.75138008e+00 3.84636354e+00 2.77111058e+00 1.04304180e+01
 1.32637084e+01 7.38440653e+01 5.99810272e-01 1.53993279e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966952205660323
cond(S) = 77.13757570519054
E1 = -183.22934566056352  E_coul = 55.00791677111632
init E= -128.221428889447
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742964409007006  LUMO = 2.29069300904326
  mo_energy =
[-3.25527941e+01 -1.85678196e+00 -7.42964409e-01 -7.42964409e-01
 -7.42964409e-01  2.29069301e+00  2.65243985e+00  2.65243985e+00
  2.65243985e+00  1.98659440e+01  1.98659440e+01  1.98659440e+01
  2.89799949e+01  1.68787315e+02  8.02020277e+02  4.58441503e+03]
E1 = -182.1847443170147  E_coul = 53.90712561807892
cycle= 1 E= -128.277618698936  delta_E= -0.0562  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269392
diis-c [-0.07257213  1.        ]
  HOMO = -0.810098274307545  LUMO = 2.24657534660185
  mo_energy =
[-3.28313140e+01 -1.92504352e+00 -8.10098274e-01 -8.10098274e-01
 -8.10098274e-01  2.24657535e+00  2.59639562e+00  2.59639562e+00
  2.59639562e+00  1.96713069e+01  1.96713069e+01  1.96713069e+01
  2.87736876e+01  1.68497634e+02  8.01680667e+02  4.58403336e+03]
E1 = -182.65808709820539  E_coul = 54.37877624123954
cycle= 2 E= -128.279310856966  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105763
diis-c [-2.21129842e-04  2.80209829e-01  7.19790171e-01]
  HOMO = -0.786834188778691  LUMO = 2.26410447985473
  mo_energy =
[-3.27551406e+01 -1.90097714e+00 -7.86834189e-01 -7.86834189e-01
 -7.86834189e-01  2.26410448e+00  2.61741965e+00  2.61741965e+00
  2.61741965e+00  1.97284530e+01  1.97284530e+01  1.97284530e+01
  2.88333252e+01  1.68575995e+02  8.01766948e+02  4.58412343e+03]
E1 = -182.52268808989402  E_coul = 54.24305817373158
cycle= 3 E= -128.279629916162  delta_E= -0.000319  |g|= 0.000515  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000707505
diis-c [-3.16318066e-08 -4.38313979e-03 -4.78937732e-03  1.00917252e+00]
  HOMO = -0.787023075769778  LUMO = 2.26396932516819
  mo_energy =
[-3.27556132e+01 -1.90119081e+00 -7.87023076e-01 -7.87023076e-01
 -7.87023076e-01  2.26396933e+00  2.61728726e+00  2.61728726e+00
  2.61728726e+00  1.97280767e+01  1.97280767e+01  1.97280767e+01
  2.88328980e+01  1.68575611e+02  8.01766704e+02  4.58412328e+03]
E1 = -182.5236246053558  E_coul = 54.24399467372092
cycle= 4 E= -128.279629931635  delta_E= -1.55e-08  |g|= 2.04e-05  |ddm|= 0.000148
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.44504e-05
diis-c [-1.16894051e-10  2.23861517e-04 -2.10308597e-04 -7.65248175e-02
  1.07651126e+00]
  HOMO = -0.787016488576512  LUMO = 2.26397100609479
  mo_energy =
[-3.27555964e+01 -1.90118789e+00 -7.87016489e-01 -7.87016489e-01
 -7.87016489e-01  2.26397101e+00  2.61729276e+00  2.61729276e+00
  2.61729276e+00  1.97280900e+01  1.97280900e+01  1.97280900e+01
  2.88329099e+01  1.68575630e+02  8.01766731e+02  4.58412332e+03]
E1 = -182.52359665537577  E_coul = 54.24396672370051
cycle= 5 E= -128.279629931675  delta_E= -4.04e-11  |g|= 1.67e-06  |ddm|= 7.81e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52359665537577  E_coul = 54.24396672370051
  HOMO = -0.787016090535487  LUMO = 2.26397098385237
  mo_energy =
[-3.27555954e+01 -1.90118790e+00 -7.87016091e-01 -7.87016091e-01
 -7.87016091e-01  2.26397098e+00  2.61729312e+00  2.61729312e+00
  2.61729312e+00  1.97280907e+01  1.97280907e+01  1.97280907e+01
  2.88329105e+01  1.68575631e+02  8.01766732e+02  4.58412332e+03]
E1 = -182.52359518759258  E_coul = 54.24396525591676
Extra cycle  E= -128.279629931676  delta_E= -5.4e-13  |g|= 3.87e-07  |ddm|= 9.31e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.13757570519054
E1 = -182.52359518759258  E_coul = 54.24396525591676
init E= -128.279629931676
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787016171192629  LUMO = 2.26397085996871
  mo_energy =
[-3.27555958e+01 -1.90118806e+00 -7.87016171e-01 -7.87016171e-01
 -7.87016171e-01  2.26397086e+00  2.61729304e+00  2.61729304e+00
  2.61729304e+00  1.97280905e+01  1.97280905e+01  1.97280905e+01
  2.88329102e+01  1.68575631e+02  8.01766732e+02  4.58412332e+03]
E1 = -182.52359581785055  E_coul = 54.24396588617479
cycle= 1 E= -128.279629931676  delta_E= 5.68e-14  |g|= 9.85e-08  |ddm|= 2.28e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52359581785055  E_coul = 54.24396588617479
  HOMO = -0.787016124257675  LUMO = 2.2639708835615
  mo_energy =
[-3.27555956e+01 -1.90118803e+00 -7.87016124e-01 -7.87016124e-01
 -7.87016124e-01  2.26397088e+00  2.61729309e+00  2.61729309e+00
  2.61729309e+00  1.97280906e+01  1.97280906e+01  1.97280906e+01
  2.88329103e+01  1.68575631e+02  8.01766732e+02  4.58412332e+03]
E1 = -182.52359557519307  E_coul = 54.24396564351734
Extra cycle  E= -128.279629931676  delta_E=    0  |g|= 3.58e-08  |ddm|= 3.84e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.44489722e+03 1.06202895e+02 4.22058668e+02 5.14903071e-01
 3.17142936e+01 1.02700730e+01 1.75138008e+00 2.77111058e+00
 1.32637084e+01 5.99810272e-01]
grad_E = [-1.06252123e-05 -4.47279502e-05 -4.81376072e-06 -8.79618863e-05
  3.60220451e-04 -6.78658383e-04 -2.48321585e-04  1.51982529e-03
 -4.99757301e-04  2.19972887e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2449.52865098        1
[INPUT] 0    0    [1    /1   ]  106.398884743        1
[INPUT] 0    0    [1    /1   ]  422.415170458        1
[INPUT] 0    0    [1    /1   ]  0.514567873665       1
[INPUT] 0    0    [1    /1   ]  31.8018887741        1
[INPUT] 0    0    [1    /1   ]  10.2834178926        1
[INPUT] 0    0    [1    /1   ]  1.75010784041        1
[INPUT] 1    0    [1    /1   ]  2.7697296104         1
[INPUT] 1    0    [1    /1   ]  13.2430675972        1
[INPUT] 1    0    [1    /1   ]  0.599768692414       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2449.528650982519, 1.0]], [0, [106.39888474280346, 1.0]], [0, [422.41517045783957, 1.0]], [0, [0.5145678736649949, 1.0]], [0, [31.80188877412234, 1.0]], [0, [10.283417892630599, 1.0]], [0, [1.7501078404056618, 1.0]], [1, [2.769729610397658, 1.0]], [1, [13.243067597173601, 1.0]], [1, [0.5997686924144401, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2449.52865098]
bas 1, expnt(s) = [106.39888474]
bas 2, expnt(s) = [422.41517046]
bas 3, expnt(s) = [0.51456787]
bas 4, expnt(s) = [31.80188877]
bas 5, expnt(s) = [10.28341789]
bas 6, expnt(s) = [1.75010784]
bas 7, expnt(s) = [2.76972961]
bas 8, expnt(s) = [13.2430676]
bas 9, expnt(s) = [0.59976869]
CPU time:       427.55
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44952865e+03 8.79684454e+02 1.06398885e+02 8.36985301e+01
 4.22415170e+02 2.35407153e+02 5.14567874e-01 1.53495987e+00
 3.18018888e+01 3.38341063e+01 1.02834179e+01 1.45083538e+01
 1.75010784e+00 3.84426778e+00 2.76972961e+00 1.04239210e+01
 1.32430676e+01 7.37004496e+01 5.99768692e-01 1.53979935e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966968589996515
cond(S) = 77.04931852766296
E1 = -183.22943214061564  E_coul = 55.00793307016299
init E= -128.221499070453
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742943888682065  LUMO = 2.28839448381201
  mo_energy =
[-3.25528754e+01 -1.85676672e+00 -7.42943889e-01 -7.42943889e-01
 -7.42943889e-01  2.28839448e+00  2.65185426e+00  2.65185426e+00
  2.65185426e+00  1.98399668e+01  1.98399668e+01  1.98399668e+01
  2.90354130e+01  1.69206384e+02  8.03338848e+02  4.59238380e+03]
E1 = -182.18479646918837  E_coul = 53.90715330242755
cycle= 1 E= -128.277643166761  delta_E= -0.0561  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269447
diis-c [-0.07260166  1.        ]
  HOMO = -0.810086697485126  LUMO = 2.24431553021496
  mo_energy =
[-3.28313684e+01 -1.92502229e+00 -8.10086697e-01 -8.10086697e-01
 -8.10086697e-01  2.24431553e+00  2.59582099e+00  2.59582099e+00
  2.59582099e+00  1.96454549e+01  1.96454549e+01  1.96454549e+01
  2.88289300e+01  1.68916619e+02  8.02999272e+02  4.59200217e+03]
E1 = -182.65818474755906  E_coul = 54.378849445601496
cycle= 2 E= -128.279335301958  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105777
diis-c [-2.21110709e-04  2.80195836e-01  7.19804164e-01]
  HOMO = -0.786819035210241  LUMO = 2.26183726831546
  mo_energy =
[-3.27551901e+01 -1.90095190e+00 -7.86819035e-01 -7.86819035e-01
 -7.86819035e-01  2.26183727e+00  2.61684169e+00  2.61684169e+00
  2.61684169e+00  1.97025733e+01  1.97025733e+01  1.97025733e+01
  2.88886184e+01  1.68995003e+02  8.03085554e+02  4.59209223e+03]
E1 = -182.52275825656977  E_coul = 54.24310382476412
cycle= 3 E= -128.279654431806  delta_E= -0.000319  |g|= 0.000515  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000711869
diis-c [-3.05192822e-08 -4.34074584e-03 -4.62548286e-03  1.00896623e+00]
  HOMO = -0.78700901120422  LUMO = 2.26170204968079
  mo_energy =
[-3.27556658e+01 -1.90116583e+00 -7.87009011e-01 -7.87009011e-01
 -7.87009011e-01  2.26170205e+00  2.61670834e+00  2.61670834e+00
  2.61670834e+00  1.97021946e+01  1.97021946e+01  1.97021946e+01
  2.88881889e+01  1.68994614e+02  8.03085305e+02  4.59209208e+03]
E1 = -182.5236999096257  E_coul = 54.244045462227376
cycle= 4 E= -128.279654447398  delta_E= -1.56e-08  |g|= 1.98e-05  |ddm|= 0.000147
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.34657e-05
diis-c [-1.09636330e-10  2.16828504e-04 -2.13534772e-04 -7.48484308e-02
  1.07484514e+00]
  HOMO = -0.787002606651751  LUMO = 2.26170371999142
  mo_energy =
[-3.27556495e+01 -1.90116294e+00 -7.87002607e-01 -7.87002607e-01
 -7.87002607e-01  2.26170372e+00  2.61671368e+00  2.61671368e+00
  2.61671368e+00  1.97022075e+01  1.97022075e+01  1.97022075e+01
  2.88882005e+01  1.68994633e+02  8.03085331e+02  4.59209211e+03]
E1 = -182.52367266596306  E_coul = 54.24401821852695
cycle= 5 E= -128.279654447436  delta_E= -3.78e-11  |g|= 1.63e-06  |ddm|= 7.48e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52367266596306  E_coul = 54.24401821852695
  HOMO = -0.787002213857663  LUMO = 2.26170370300102
  mo_energy =
[-3.27556485e+01 -1.90116294e+00 -7.87002214e-01 -7.87002214e-01
 -7.87002214e-01  2.26170370e+00  2.61671403e+00  2.61671403e+00
  2.61671403e+00  1.97022083e+01  1.97022083e+01  1.97022083e+01
  2.88882011e+01  1.68994634e+02  8.03085332e+02  4.59209211e+03]
E1 = -182.52367120865406  E_coul = 54.24401676121768
Extra cycle  E= -128.279654447436  delta_E= -2.56e-13  |g|= 3.79e-07  |ddm|= 9.03e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.44952865e+03 1.06398885e+02 4.22415170e+02 5.14567874e-01
 3.18018888e+01 1.02834179e+01 1.75010784e+00 2.76972961e+00
 1.32430676e+01 5.99768692e-01]
E = -128.27965444743637
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:53 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2449.52865098        1
[INPUT] 0    0    [1    /1   ]  106.398884743        1
[INPUT] 0    0    [1    /1   ]  422.415170458        1
[INPUT] 0    0    [1    /1   ]  0.514567873665       1
[INPUT] 0    0    [1    /1   ]  31.8018887741        1
[INPUT] 0    0    [1    /1   ]  10.2834178926        1
[INPUT] 0    0    [1    /1   ]  1.75010784041        1
[INPUT] 1    0    [1    /1   ]  2.7697296104         1
[INPUT] 1    0    [1    /1   ]  13.2430675972        1
[INPUT] 1    0    [1    /1   ]  0.599768692414       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2449.528650982519, 1.0]], [0, [106.39888474280346, 1.0]], [0, [422.41517045783957, 1.0]], [0, [0.5145678736649949, 1.0]], [0, [31.80188877412234, 1.0]], [0, [10.283417892630599, 1.0]], [0, [1.7501078404056618, 1.0]], [1, [2.769729610397658, 1.0]], [1, [13.243067597173601, 1.0]], [1, [0.5997686924144401, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2449.52865098]
bas 1, expnt(s) = [106.39888474]
bas 2, expnt(s) = [422.41517046]
bas 3, expnt(s) = [0.51456787]
bas 4, expnt(s) = [31.80188877]
bas 5, expnt(s) = [10.28341789]
bas 6, expnt(s) = [1.75010784]
bas 7, expnt(s) = [2.76972961]
bas 8, expnt(s) = [13.2430676]
bas 9, expnt(s) = [0.59976869]
CPU time:       429.08
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.44952865e+03 8.79684454e+02 1.06398885e+02 8.36985301e+01
 4.22415170e+02 2.35407153e+02 5.14567874e-01 1.53495987e+00
 3.18018888e+01 3.38341063e+01 1.02834179e+01 1.45083538e+01
 1.75010784e+00 3.84426778e+00 2.76972961e+00 1.04239210e+01
 1.32430676e+01 7.37004496e+01 5.99768692e-01 1.53979935e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966968589996515
cond(S) = 77.04931852766296
E1 = -183.22943214061564  E_coul = 55.00793307016299
init E= -128.221499070453
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742943888682065  LUMO = 2.28839448381201
  mo_energy =
[-3.25528754e+01 -1.85676672e+00 -7.42943889e-01 -7.42943889e-01
 -7.42943889e-01  2.28839448e+00  2.65185426e+00  2.65185426e+00
  2.65185426e+00  1.98399668e+01  1.98399668e+01  1.98399668e+01
  2.90354130e+01  1.69206384e+02  8.03338848e+02  4.59238380e+03]
E1 = -182.18479646918837  E_coul = 53.90715330242755
cycle= 1 E= -128.277643166761  delta_E= -0.0561  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269447
diis-c [-0.07260166  1.        ]
  HOMO = -0.810086697485126  LUMO = 2.24431553021496
  mo_energy =
[-3.28313684e+01 -1.92502229e+00 -8.10086697e-01 -8.10086697e-01
 -8.10086697e-01  2.24431553e+00  2.59582099e+00  2.59582099e+00
  2.59582099e+00  1.96454549e+01  1.96454549e+01  1.96454549e+01
  2.88289300e+01  1.68916619e+02  8.02999272e+02  4.59200217e+03]
E1 = -182.65818474755906  E_coul = 54.378849445601496
cycle= 2 E= -128.279335301958  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105777
diis-c [-2.21110709e-04  2.80195836e-01  7.19804164e-01]
  HOMO = -0.786819035210241  LUMO = 2.26183726831546
  mo_energy =
[-3.27551901e+01 -1.90095190e+00 -7.86819035e-01 -7.86819035e-01
 -7.86819035e-01  2.26183727e+00  2.61684169e+00  2.61684169e+00
  2.61684169e+00  1.97025733e+01  1.97025733e+01  1.97025733e+01
  2.88886184e+01  1.68995003e+02  8.03085554e+02  4.59209223e+03]
E1 = -182.52275825656977  E_coul = 54.24310382476412
cycle= 3 E= -128.279654431806  delta_E= -0.000319  |g|= 0.000515  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000711869
diis-c [-3.05192822e-08 -4.34074584e-03 -4.62548286e-03  1.00896623e+00]
  HOMO = -0.78700901120422  LUMO = 2.26170204968079
  mo_energy =
[-3.27556658e+01 -1.90116583e+00 -7.87009011e-01 -7.87009011e-01
 -7.87009011e-01  2.26170205e+00  2.61670834e+00  2.61670834e+00
  2.61670834e+00  1.97021946e+01  1.97021946e+01  1.97021946e+01
  2.88881889e+01  1.68994614e+02  8.03085305e+02  4.59209208e+03]
E1 = -182.5236999096257  E_coul = 54.244045462227376
cycle= 4 E= -128.279654447398  delta_E= -1.56e-08  |g|= 1.98e-05  |ddm|= 0.000147
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.34657e-05
diis-c [-1.09636330e-10  2.16828504e-04 -2.13534772e-04 -7.48484308e-02
  1.07484514e+00]
  HOMO = -0.787002606651751  LUMO = 2.26170371999142
  mo_energy =
[-3.27556495e+01 -1.90116294e+00 -7.87002607e-01 -7.87002607e-01
 -7.87002607e-01  2.26170372e+00  2.61671368e+00  2.61671368e+00
  2.61671368e+00  1.97022075e+01  1.97022075e+01  1.97022075e+01
  2.88882005e+01  1.68994633e+02  8.03085331e+02  4.59209211e+03]
E1 = -182.52367266596306  E_coul = 54.24401821852695
cycle= 5 E= -128.279654447436  delta_E= -3.78e-11  |g|= 1.63e-06  |ddm|= 7.48e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52367266596306  E_coul = 54.24401821852695
  HOMO = -0.787002213857663  LUMO = 2.26170370300102
  mo_energy =
[-3.27556485e+01 -1.90116294e+00 -7.87002214e-01 -7.87002214e-01
 -7.87002214e-01  2.26170370e+00  2.61671403e+00  2.61671403e+00
  2.61671403e+00  1.97022083e+01  1.97022083e+01  1.97022083e+01
  2.88882011e+01  1.68994634e+02  8.03085332e+02  4.59209211e+03]
E1 = -182.52367120865406  E_coul = 54.24401676121768
Extra cycle  E= -128.279654447436  delta_E= -2.56e-13  |g|= 3.79e-07  |ddm|= 9.03e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 77.04931852766296
E1 = -182.52367120865406  E_coul = 54.24401676121768
init E= -128.279654447436
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.787002294358716  LUMO = 2.26170358112383
  mo_energy =
[-3.27556489e+01 -1.90116310e+00 -7.87002294e-01 -7.87002294e-01
 -7.87002294e-01  2.26170358e+00  2.61671396e+00  2.61671396e+00
  2.61671396e+00  1.97022080e+01  1.97022080e+01  1.97022080e+01
  2.88882008e+01  1.68994634e+02  8.03085332e+02  4.59209211e+03]
E1 = -182.5236718337116  E_coul = 54.24401738627504
cycle= 1 E= -128.279654447437  delta_E= -1.99e-13  |g|= 9.71e-08  |ddm|= 2.23e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5236718337116  E_coul = 54.24401738627504
  HOMO = -0.787002247883694  LUMO = 2.26170360469211
  mo_energy =
[-3.27556487e+01 -1.90116307e+00 -7.87002248e-01 -7.87002248e-01
 -7.87002248e-01  2.26170360e+00  2.61671400e+00  2.61671400e+00
  2.61671400e+00  1.97022081e+01  1.97022081e+01  1.97022081e+01
  2.88882009e+01  1.68994634e+02  8.03085332e+02  4.59209211e+03]
E1 = -182.52367159289497  E_coul = 54.24401714545846
Extra cycle  E= -128.279654447437  delta_E= 5.68e-14  |g|= 3.55e-08  |ddm|= 3.77e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.44952865e+03 1.06398885e+02 4.22415170e+02 5.14567874e-01
 3.18018888e+01 1.02834179e+01 1.75010784e+00 2.76972961e+00
 1.32430676e+01 5.99768692e-01]
grad_E = [-1.04690281e-05 -6.05147330e-05 -5.37698899e-06 -1.19532371e-04
  4.87999968e-04 -9.19332521e-04 -3.36305707e-04  2.05758491e-03
 -6.76829438e-04  2.98055064e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2457.56906081        1
[INPUT] 0    0    [1    /1   ]  106.695064625        1
[INPUT] 0    0    [1    /1   ]  423.127030493        1
[INPUT] 0    0    [1    /1   ]  0.514167064972       1
[INPUT] 0    0    [1    /1   ]  31.9241617525        1
[INPUT] 0    0    [1    /1   ]  10.3026980083        1
[INPUT] 0    0    [1    /1   ]  1.74855335987        1
[INPUT] 1    0    [1    /1   ]  2.76801073411        1
[INPUT] 1    0    [1    /1   ]  13.2171149303        1
[INPUT] 1    0    [1    /1   ]  0.599721886389       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2457.56906080616, 1.0]], [0, [106.69506462486365, 1.0]], [0, [423.12703049280117, 1.0]], [0, [0.5141670649720572, 1.0]], [0, [31.92416175246233, 1.0]], [0, [10.302698008263098, 1.0]], [0, [1.7485533598725038, 1.0]], [1, [2.7680107341057574, 1.0]], [1, [13.217114930333345, 1.0]], [1, [0.5997218863887619, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2457.56906081]
bas 1, expnt(s) = [106.69506462]
bas 2, expnt(s) = [423.12703049]
bas 3, expnt(s) = [0.51416706]
bas 4, expnt(s) = [31.92416175]
bas 5, expnt(s) = [10.30269801]
bas 6, expnt(s) = [1.74855336]
bas 7, expnt(s) = [2.76801073]
bas 8, expnt(s) = [13.21711493]
bas 9, expnt(s) = [0.59972189]
CPU time:       432.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.45756906e+03 8.81849194e+02 1.06695065e+02 8.38732115e+01
 4.23127030e+02 2.35704624e+02 5.14167065e-01 1.53406307e+00
 3.19241618e+01 3.39316244e+01 1.03026980e+01 1.45287500e+01
 1.74855336e+00 3.84170658e+00 2.76801073e+00 1.04158353e+01
 1.32171149e+01 7.35199538e+01 5.99721886e-01 1.53964915e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966987670680538
cond(S) = 76.89690302791028
E1 = -183.22953932143736  E_coul = 55.00795331345923
init E= -128.221586007978
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742917203309326  LUMO = 2.28566539970337
  mo_energy =
[-3.25529856e+01 -1.85674790e+00 -7.42917203e-01 -7.42917203e-01
 -7.42917203e-01  2.28566540e+00  2.65114795e+00  2.65114795e+00
  2.65114795e+00  1.98073967e+01  1.98073967e+01  1.98073967e+01
  2.91156940e+01  1.69814734e+02  8.05477914e+02  4.60625140e+03]
E1 = -182.1849149137604  E_coul = 53.90722928453839
cycle= 1 E= -128.277685629222  delta_E= -0.0561  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269504
diis-c [-0.07263255  1.        ]
  HOMO = -0.810068194712504  LUMO = 2.24163275176843
  mo_energy =
[-3.28314365e+01 -1.92499301e+00 -8.10068195e-01 -8.10068195e-01
 -8.10068195e-01  2.24163275e+00  2.59513090e+00  2.59513090e+00
  2.59513090e+00  1.96130489e+01  1.96130489e+01  1.96130489e+01
  2.89089667e+01  1.69524851e+02  8.05138375e+02  4.60586981e+03]
E1 = -182.65834227221623  E_coul = 54.3789646417897
cycle= 2 E= -128.279377630427  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105789
diis-c [-2.21135899e-04  2.80175615e-01  7.19824385e-01]
  HOMO = -0.786796843923654  LUMO = 2.25914588886573
  mo_energy =
[-3.27552544e+01 -1.90091842e+00 -7.86796844e-01 -7.86796844e-01
 -7.86796844e-01  2.25914589e+00  2.61614683e+00  2.61614683e+00
  2.61614683e+00  1.96701304e+01  1.96701304e+01  1.96701304e+01
  2.89687240e+01  1.69603265e+02  8.05224659e+02  4.60595987e+03]
E1 = -182.52288697910555  E_coul = 54.243190155880114
cycle= 3 E= -128.279696823225  delta_E= -0.000319  |g|= 0.000516  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000717525
diis-c [-2.91653810e-08 -4.28672407e-03 -4.41646716e-03  1.00870319e+00]
  HOMO = -0.786988209806732  LUMO = 2.25901055223395
  mo_energy =
[-3.27557343e+01 -1.90113270e+00 -7.86988210e-01 -7.86988210e-01
 -7.86988210e-01  2.25901055e+00  2.61601224e+00  2.61601224e+00
  2.61601224e+00  1.96697486e+01  1.96697486e+01  1.96697486e+01
  2.89682916e+01  1.69602872e+02  8.05224403e+02  4.60595971e+03]
E1 = -182.52383526503948  E_coul = 54.24413842605882
cycle= 4 E= -128.279696838981  delta_E= -1.58e-08  |g|= 1.91e-05  |ddm|= 0.000147
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.22409e-05
diis-c [-1.00799972e-10  2.07977580e-04 -2.17427762e-04 -7.27186254e-02
  1.07272808e+00]
  HOMO = -0.786982032335067  LUMO = 2.25901220928078
  mo_energy =
[-3.27557185e+01 -1.90112986e+00 -7.86982032e-01 -7.86982032e-01
 -7.86982032e-01  2.25901221e+00  2.61601739e+00  2.61601739e+00
  2.61601739e+00  1.96697612e+01  1.96697612e+01  1.96697612e+01
  2.89683029e+01  1.69602891e+02  8.05224428e+02  4.60595974e+03]
E1 = -182.5238088991136  E_coul = 54.24411206009833
cycle= 5 E= -128.279696839015  delta_E= -3.46e-11  |g|= 1.57e-06  |ddm|= 7.08e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5238088991136  E_coul = 54.24411206009833
  HOMO = -0.786981646666778  LUMO = 2.25901219871684
  mo_energy =
[-3.27557176e+01 -1.90112985e+00 -7.86981647e-01 -7.86981647e-01
 -7.86981647e-01  2.25901220e+00  2.61601774e+00  2.61601774e+00
  2.61601774e+00  1.96697619e+01  1.96697619e+01  1.96697619e+01
  2.89683035e+01  1.69602891e+02  8.05224429e+02  4.60595974e+03]
E1 = -182.52380745722647  E_coul = 54.24411061821085
Extra cycle  E= -128.279696839016  delta_E= -3.69e-13  |g|= 3.68e-07  |ddm|= 8.68e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.45756906e+03 1.06695065e+02 4.23127030e+02 5.14167065e-01
 3.19241618e+01 1.03026980e+01 1.74855336e+00 2.76801073e+00
 1.32171149e+01 5.99721886e-01]
E = -128.27969683901563
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:51:57 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2457.56906081        1
[INPUT] 0    0    [1    /1   ]  106.695064625        1
[INPUT] 0    0    [1    /1   ]  423.127030493        1
[INPUT] 0    0    [1    /1   ]  0.514167064972       1
[INPUT] 0    0    [1    /1   ]  31.9241617525        1
[INPUT] 0    0    [1    /1   ]  10.3026980083        1
[INPUT] 0    0    [1    /1   ]  1.74855335987        1
[INPUT] 1    0    [1    /1   ]  2.76801073411        1
[INPUT] 1    0    [1    /1   ]  13.2171149303        1
[INPUT] 1    0    [1    /1   ]  0.599721886389       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2457.56906080616, 1.0]], [0, [106.69506462486365, 1.0]], [0, [423.12703049280117, 1.0]], [0, [0.5141670649720572, 1.0]], [0, [31.92416175246233, 1.0]], [0, [10.302698008263098, 1.0]], [0, [1.7485533598725038, 1.0]], [1, [2.7680107341057574, 1.0]], [1, [13.217114930333345, 1.0]], [1, [0.5997218863887619, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2457.56906081]
bas 1, expnt(s) = [106.69506462]
bas 2, expnt(s) = [423.12703049]
bas 3, expnt(s) = [0.51416706]
bas 4, expnt(s) = [31.92416175]
bas 5, expnt(s) = [10.30269801]
bas 6, expnt(s) = [1.74855336]
bas 7, expnt(s) = [2.76801073]
bas 8, expnt(s) = [13.21711493]
bas 9, expnt(s) = [0.59972189]
CPU time:       433.94
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.45756906e+03 8.81849194e+02 1.06695065e+02 8.38732115e+01
 4.23127030e+02 2.35704624e+02 5.14167065e-01 1.53406307e+00
 3.19241618e+01 3.39316244e+01 1.03026980e+01 1.45287500e+01
 1.74855336e+00 3.84170658e+00 2.76801073e+00 1.04158353e+01
 1.32171149e+01 7.35199538e+01 5.99721886e-01 1.53964915e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966987670680538
cond(S) = 76.89690302791028
E1 = -183.22953932143736  E_coul = 55.00795331345923
init E= -128.221586007978
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742917203309326  LUMO = 2.28566539970337
  mo_energy =
[-3.25529856e+01 -1.85674790e+00 -7.42917203e-01 -7.42917203e-01
 -7.42917203e-01  2.28566540e+00  2.65114795e+00  2.65114795e+00
  2.65114795e+00  1.98073967e+01  1.98073967e+01  1.98073967e+01
  2.91156940e+01  1.69814734e+02  8.05477914e+02  4.60625140e+03]
E1 = -182.1849149137604  E_coul = 53.90722928453839
cycle= 1 E= -128.277685629222  delta_E= -0.0561  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269504
diis-c [-0.07263255  1.        ]
  HOMO = -0.810068194712504  LUMO = 2.24163275176843
  mo_energy =
[-3.28314365e+01 -1.92499301e+00 -8.10068195e-01 -8.10068195e-01
 -8.10068195e-01  2.24163275e+00  2.59513090e+00  2.59513090e+00
  2.59513090e+00  1.96130489e+01  1.96130489e+01  1.96130489e+01
  2.89089667e+01  1.69524851e+02  8.05138375e+02  4.60586981e+03]
E1 = -182.65834227221623  E_coul = 54.3789646417897
cycle= 2 E= -128.279377630427  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105789
diis-c [-2.21135899e-04  2.80175615e-01  7.19824385e-01]
  HOMO = -0.786796843923654  LUMO = 2.25914588886573
  mo_energy =
[-3.27552544e+01 -1.90091842e+00 -7.86796844e-01 -7.86796844e-01
 -7.86796844e-01  2.25914589e+00  2.61614683e+00  2.61614683e+00
  2.61614683e+00  1.96701304e+01  1.96701304e+01  1.96701304e+01
  2.89687240e+01  1.69603265e+02  8.05224659e+02  4.60595987e+03]
E1 = -182.52288697910555  E_coul = 54.243190155880114
cycle= 3 E= -128.279696823225  delta_E= -0.000319  |g|= 0.000516  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000717525
diis-c [-2.91653810e-08 -4.28672407e-03 -4.41646716e-03  1.00870319e+00]
  HOMO = -0.786988209806732  LUMO = 2.25901055223395
  mo_energy =
[-3.27557343e+01 -1.90113270e+00 -7.86988210e-01 -7.86988210e-01
 -7.86988210e-01  2.25901055e+00  2.61601224e+00  2.61601224e+00
  2.61601224e+00  1.96697486e+01  1.96697486e+01  1.96697486e+01
  2.89682916e+01  1.69602872e+02  8.05224403e+02  4.60595971e+03]
E1 = -182.52383526503948  E_coul = 54.24413842605882
cycle= 4 E= -128.279696838981  delta_E= -1.58e-08  |g|= 1.91e-05  |ddm|= 0.000147
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.22409e-05
diis-c [-1.00799972e-10  2.07977580e-04 -2.17427762e-04 -7.27186254e-02
  1.07272808e+00]
  HOMO = -0.786982032335067  LUMO = 2.25901220928078
  mo_energy =
[-3.27557185e+01 -1.90112986e+00 -7.86982032e-01 -7.86982032e-01
 -7.86982032e-01  2.25901221e+00  2.61601739e+00  2.61601739e+00
  2.61601739e+00  1.96697612e+01  1.96697612e+01  1.96697612e+01
  2.89683029e+01  1.69602891e+02  8.05224428e+02  4.60595974e+03]
E1 = -182.5238088991136  E_coul = 54.24411206009833
cycle= 5 E= -128.279696839015  delta_E= -3.46e-11  |g|= 1.57e-06  |ddm|= 7.08e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5238088991136  E_coul = 54.24411206009833
  HOMO = -0.786981646666778  LUMO = 2.25901219871684
  mo_energy =
[-3.27557176e+01 -1.90112985e+00 -7.86981647e-01 -7.86981647e-01
 -7.86981647e-01  2.25901220e+00  2.61601774e+00  2.61601774e+00
  2.61601774e+00  1.96697619e+01  1.96697619e+01  1.96697619e+01
  2.89683035e+01  1.69602891e+02  8.05224429e+02  4.60595974e+03]
E1 = -182.52380745722647  E_coul = 54.24411061821085
Extra cycle  E= -128.279696839016  delta_E= -3.69e-13  |g|= 3.68e-07  |ddm|= 8.68e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 76.89690302791028
E1 = -182.52380745722647  E_coul = 54.24411061821085
init E= -128.279696839016
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786981726832406  LUMO = 2.25901207950008
  mo_energy =
[-3.27557179e+01 -1.90113001e+00 -7.86981727e-01 -7.86981727e-01
 -7.86981727e-01  2.25901208e+00  2.61601766e+00  2.61601766e+00
  2.61601766e+00  1.96697616e+01  1.96697616e+01  1.96697616e+01
  2.89683032e+01  1.69602891e+02  8.05224429e+02  4.60595974e+03]
E1 = -182.52380807478625  E_coul = 54.24411123577073
cycle= 1 E= -128.279696839016  delta_E= 1.14e-13  |g|= 9.52e-08  |ddm|= 2.16e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52380807478625  E_coul = 54.24411123577073
  HOMO = -0.786981681004374  LUMO = 2.25901210299643
  mo_energy =
[-3.27557178e+01 -1.90112997e+00 -7.86981681e-01 -7.86981681e-01
 -7.86981681e-01  2.25901210e+00  2.61601771e+00  2.61601771e+00
  2.61601771e+00  1.96697617e+01  1.96697617e+01  1.96697617e+01
  2.89683033e+01  1.69602891e+02  8.05224429e+02  4.60595974e+03]
E1 = -182.52380783665848  E_coul = 54.244110997643
Extra cycle  E= -128.279696839015  delta_E= 2.84e-14  |g|= 3.49e-08  |ddm|= 3.68e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.45756906e+03 1.06695065e+02 4.23127030e+02 5.14167065e-01
 3.19241618e+01 1.03026980e+01 1.74855336e+00 2.76801073e+00
 1.32171149e+01 5.99721886e-01]
grad_E = [-1.02338933e-05 -8.06431584e-05 -6.07932551e-06 -1.60089393e-04
  6.50830894e-04 -1.22566695e-03 -4.48052388e-04  2.74155544e-03
 -9.02033319e-04  3.97576072e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2471.3524553         1
[INPUT] 0    0    [1    /1   ]  107.14238357         1
[INPUT] 0    0    [1    /1   ]  424.466223285        1
[INPUT] 0    0    [1    /1   ]  0.513718650947       1
[INPUT] 0    0    [1    /1   ]  32.0934679331        1
[INPUT] 0    0    [1    /1   ]  10.3303990445        1
[INPUT] 0    0    [1    /1   ]  1.74675052282        1
[INPUT] 1    0    [1    /1   ]  2.76595797971        1
[INPUT] 1    0    [1    /1   ]  13.1856944259        1
[INPUT] 1    0    [1    /1   ]  0.59967404582        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2471.352455303842, 1.0]], [0, [107.14238356967195, 1.0]], [0, [424.4662232849106, 1.0]], [0, [0.513718650947085, 1.0]], [0, [32.09346793314865, 1.0]], [0, [10.33039904446945, 1.0]], [0, [1.746750522819313, 1.0]], [1, [2.765957979710187, 1.0]], [1, [13.185694425906517, 1.0]], [1, [0.599674045819774, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2471.3524553]
bas 1, expnt(s) = [107.14238357]
bas 2, expnt(s) = [424.46622328]
bas 3, expnt(s) = [0.51371865]
bas 4, expnt(s) = [32.09346793]
bas 5, expnt(s) = [10.33039904]
bas 6, expnt(s) = [1.74675052]
bas 7, expnt(s) = [2.76595798]
bas 8, expnt(s) = [13.18569443]
bas 9, expnt(s) = [0.59967405]
CPU time:       437.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47135246e+03 8.85556020e+02 1.07142384e+02 8.41368023e+01
 4.24466223e+02 2.36263905e+02 5.13718651e-01 1.53305955e+00
 3.20934679e+01 3.40664995e+01 1.03303990e+01 1.45580380e+01
 1.74675052e+00 3.83873547e+00 2.76595798e+00 1.04061808e+01
 1.31856944e+01 7.33015488e+01 5.99674046e-01 1.53949562e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967008288232808
cond(S) = 76.6371267666479
E1 = -183.22967001403416  E_coul = 55.00797818352761
init E= -128.221691830507
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742883490345604  LUMO = 2.28264454645585
  mo_energy =
[-3.25531333e+01 -1.85672584e+00 -7.42883490e-01 -7.42883490e-01
 -7.42883490e-01  2.28264455e+00  2.65034113e+00  2.65034113e+00
  2.65034113e+00  1.97681111e+01  1.97681111e+01  1.97681111e+01
  2.92315062e+01  1.70695522e+02  8.08932580e+02  4.63004700e+03]
E1 = -182.18515181735418  E_coul = 53.90739194669797
cycle= 1 E= -128.277759870656  delta_E= -0.0561  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269554
diis-c [-0.07265913  1.        ]
  HOMO = -0.810039210507766  LUMO = 2.23866358279122
  mo_energy =
[-3.28315187e+01 -1.92495340e+00 -8.10039211e-01 -8.10039211e-01
 -8.10039211e-01  2.23866358e+00  2.59434782e+00  2.59434782e+00
  2.59434782e+00  1.95739735e+01  1.95739735e+01  1.95739735e+01
  2.90244422e+01  1.70405477e+02  8.08593080e+02  4.62966547e+03]
E1 = -182.65859576230508  E_coul = 54.37914423277501
cycle= 2 E= -128.27945152953  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105794
diis-c [-2.21255585e-04  2.80146751e-01  7.19853249e-01]
  HOMO = -0.786764765748638  LUMO = 2.25616756918328
  mo_energy =
[-3.27553367e+01 -1.90087513e+00 -7.86764766e-01 -7.86764766e-01
 -7.86764766e-01  2.25616757e+00  2.61535699e+00  2.61535699e+00
  2.61535699e+00  1.96310067e+01  1.96310067e+01  1.96310067e+01
  2.90842918e+01  1.70483931e+02  8.08679365e+02  4.62975551e+03]
E1 = -182.5231153208067  E_coul = 54.24334456611446
cycle= 3 E= -128.279770754692  delta_E= -0.000319  |g|= 0.000517  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000724634
diis-c [-2.75977053e-08 -4.22001666e-03 -4.15822896e-03  1.00837825e+00]
  HOMO = -0.786957848038937  LUMO = 2.25603202267509
  mo_energy =
[-3.27558217e+01 -1.90108991e+00 -7.86957848e-01 -7.86957848e-01
 -7.86957848e-01  2.25603202e+00  2.61522088e+00  2.61522088e+00
  2.61522088e+00  1.96306212e+01  1.96306212e+01  1.96306212e+01
  2.90838557e+01  1.70483531e+02  8.08679100e+02  4.62975534e+03]
E1 = -182.5240719362467  E_coul = 54.244301165582876
cycle= 4 E= -128.279770770664  delta_E= -1.6e-08  |g|= 1.82e-05  |ddm|= 0.000147
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.07856e-05
diis-c [-9.06017305e-11  1.97317635e-04 -2.21925899e-04 -7.01286705e-02
  1.07015328e+00]
  HOMO = -0.786951940321745  LUMO = 2.25603366371467
  mo_energy =
[-3.27558066e+01 -1.90108711e+00 -7.86951940e-01 -7.86951940e-01
 -7.86951940e-01  2.25603366e+00  2.61522579e+00  2.61522579e+00
  2.61522579e+00  1.96306332e+01  1.96306332e+01  1.96306332e+01
  2.90838666e+01  1.70483549e+02  8.08679124e+02  4.62975537e+03]
E1 = -182.5240466127739  E_coul = 54.24427584207909
cycle= 5 E= -128.279770770695  delta_E= -3.1e-11  |g|= 1.5e-06  |ddm|= 6.6e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5240466127739  E_coul = 54.24427584207909
  HOMO = -0.786951564008821  LUMO = 2.25603366062557
  mo_energy =
[-3.27558057e+01 -1.90108709e+00 -7.86951564e-01 -7.86951564e-01
 -7.86951564e-01  2.25603366e+00  2.61522613e+00  2.61522613e+00
  2.61522613e+00  1.96306339e+01  1.96306339e+01  1.96306339e+01
  2.90838672e+01  1.70483550e+02  8.08679125e+02  4.62975537e+03]
E1 = -182.52404519276118  E_coul = 54.24427442206626
Extra cycle  E= -128.279770770695  delta_E= -8.53e-14  |g|= 3.54e-07  |ddm|= 8.24e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.47135246e+03 1.07142384e+02 4.24466223e+02 5.13718651e-01
 3.20934679e+01 1.03303990e+01 1.74675052e+00 2.76595798e+00
 1.31856944e+01 5.99674046e-01]
E = -128.2797707706949
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:02 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2471.3524553         1
[INPUT] 0    0    [1    /1   ]  107.14238357         1
[INPUT] 0    0    [1    /1   ]  424.466223285        1
[INPUT] 0    0    [1    /1   ]  0.513718650947       1
[INPUT] 0    0    [1    /1   ]  32.0934679331        1
[INPUT] 0    0    [1    /1   ]  10.3303990445        1
[INPUT] 0    0    [1    /1   ]  1.74675052282        1
[INPUT] 1    0    [1    /1   ]  2.76595797971        1
[INPUT] 1    0    [1    /1   ]  13.1856944259        1
[INPUT] 1    0    [1    /1   ]  0.59967404582        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2471.352455303842, 1.0]], [0, [107.14238356967195, 1.0]], [0, [424.4662232849106, 1.0]], [0, [0.513718650947085, 1.0]], [0, [32.09346793314865, 1.0]], [0, [10.33039904446945, 1.0]], [0, [1.746750522819313, 1.0]], [1, [2.765957979710187, 1.0]], [1, [13.185694425906517, 1.0]], [1, [0.599674045819774, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2471.3524553]
bas 1, expnt(s) = [107.14238357]
bas 2, expnt(s) = [424.46622328]
bas 3, expnt(s) = [0.51371865]
bas 4, expnt(s) = [32.09346793]
bas 5, expnt(s) = [10.33039904]
bas 6, expnt(s) = [1.74675052]
bas 7, expnt(s) = [2.76595798]
bas 8, expnt(s) = [13.18569443]
bas 9, expnt(s) = [0.59967405]
CPU time:       438.74
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.47135246e+03 8.85556020e+02 1.07142384e+02 8.41368023e+01
 4.24466223e+02 2.36263905e+02 5.13718651e-01 1.53305955e+00
 3.20934679e+01 3.40664995e+01 1.03303990e+01 1.45580380e+01
 1.74675052e+00 3.83873547e+00 2.76595798e+00 1.04061808e+01
 1.31856944e+01 7.33015488e+01 5.99674046e-01 1.53949562e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967008288232808
cond(S) = 76.6371267666479
E1 = -183.22967001403416  E_coul = 55.00797818352761
init E= -128.221691830507
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742883490345604  LUMO = 2.28264454645585
  mo_energy =
[-3.25531333e+01 -1.85672584e+00 -7.42883490e-01 -7.42883490e-01
 -7.42883490e-01  2.28264455e+00  2.65034113e+00  2.65034113e+00
  2.65034113e+00  1.97681111e+01  1.97681111e+01  1.97681111e+01
  2.92315062e+01  1.70695522e+02  8.08932580e+02  4.63004700e+03]
E1 = -182.18515181735418  E_coul = 53.90739194669797
cycle= 1 E= -128.277759870656  delta_E= -0.0561  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269554
diis-c [-0.07265913  1.        ]
  HOMO = -0.810039210507766  LUMO = 2.23866358279122
  mo_energy =
[-3.28315187e+01 -1.92495340e+00 -8.10039211e-01 -8.10039211e-01
 -8.10039211e-01  2.23866358e+00  2.59434782e+00  2.59434782e+00
  2.59434782e+00  1.95739735e+01  1.95739735e+01  1.95739735e+01
  2.90244422e+01  1.70405477e+02  8.08593080e+02  4.62966547e+03]
E1 = -182.65859576230508  E_coul = 54.37914423277501
cycle= 2 E= -128.27945152953  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105794
diis-c [-2.21255585e-04  2.80146751e-01  7.19853249e-01]
  HOMO = -0.786764765748638  LUMO = 2.25616756918328
  mo_energy =
[-3.27553367e+01 -1.90087513e+00 -7.86764766e-01 -7.86764766e-01
 -7.86764766e-01  2.25616757e+00  2.61535699e+00  2.61535699e+00
  2.61535699e+00  1.96310067e+01  1.96310067e+01  1.96310067e+01
  2.90842918e+01  1.70483931e+02  8.08679365e+02  4.62975551e+03]
E1 = -182.5231153208067  E_coul = 54.24334456611446
cycle= 3 E= -128.279770754692  delta_E= -0.000319  |g|= 0.000517  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000724634
diis-c [-2.75977053e-08 -4.22001666e-03 -4.15822896e-03  1.00837825e+00]
  HOMO = -0.786957848038937  LUMO = 2.25603202267509
  mo_energy =
[-3.27558217e+01 -1.90108991e+00 -7.86957848e-01 -7.86957848e-01
 -7.86957848e-01  2.25603202e+00  2.61522088e+00  2.61522088e+00
  2.61522088e+00  1.96306212e+01  1.96306212e+01  1.96306212e+01
  2.90838557e+01  1.70483531e+02  8.08679100e+02  4.62975534e+03]
E1 = -182.5240719362467  E_coul = 54.244301165582876
cycle= 4 E= -128.279770770664  delta_E= -1.6e-08  |g|= 1.82e-05  |ddm|= 0.000147
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.07856e-05
diis-c [-9.06017305e-11  1.97317635e-04 -2.21925899e-04 -7.01286705e-02
  1.07015328e+00]
  HOMO = -0.786951940321745  LUMO = 2.25603366371467
  mo_energy =
[-3.27558066e+01 -1.90108711e+00 -7.86951940e-01 -7.86951940e-01
 -7.86951940e-01  2.25603366e+00  2.61522579e+00  2.61522579e+00
  2.61522579e+00  1.96306332e+01  1.96306332e+01  1.96306332e+01
  2.90838666e+01  1.70483549e+02  8.08679124e+02  4.62975537e+03]
E1 = -182.5240466127739  E_coul = 54.24427584207909
cycle= 5 E= -128.279770770695  delta_E= -3.1e-11  |g|= 1.5e-06  |ddm|= 6.6e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5240466127739  E_coul = 54.24427584207909
  HOMO = -0.786951564008821  LUMO = 2.25603366062557
  mo_energy =
[-3.27558057e+01 -1.90108709e+00 -7.86951564e-01 -7.86951564e-01
 -7.86951564e-01  2.25603366e+00  2.61522613e+00  2.61522613e+00
  2.61522613e+00  1.96306339e+01  1.96306339e+01  1.96306339e+01
  2.90838672e+01  1.70483550e+02  8.08679125e+02  4.62975537e+03]
E1 = -182.52404519276118  E_coul = 54.24427442206626
Extra cycle  E= -128.279770770695  delta_E= -8.53e-14  |g|= 3.54e-07  |ddm|= 8.24e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 76.6371267666479
E1 = -182.52404519276118  E_coul = 54.24427442206626
init E= -128.279770770695
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786951643566025  LUMO = 2.25603354481151
  mo_energy =
[-3.27558060e+01 -1.90108725e+00 -7.86951644e-01 -7.86951644e-01
 -7.86951644e-01  2.25603354e+00  2.61522606e+00  2.61522606e+00
  2.61522606e+00  1.96306337e+01  1.96306337e+01  1.96306337e+01
  2.90838669e+01  1.70483550e+02  8.08679125e+02  4.62975537e+03]
E1 = -182.52404579988578  E_coul = 54.2442750291908
cycle= 1 E= -128.279770770695  delta_E= -8.53e-14  |g|= 9.28e-08  |ddm|= 2.07e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52404579988578  E_coul = 54.2442750291908
  HOMO = -0.786951598617841  LUMO = 2.25603356816121
  mo_energy =
[-3.27558059e+01 -1.90108721e+00 -7.86951599e-01 -7.86951599e-01
 -7.86951599e-01  2.25603357e+00  2.61522610e+00  2.61522610e+00
  2.61522610e+00  1.96306338e+01  1.96306338e+01  1.96306338e+01
  2.90838670e+01  1.70483550e+02  8.08679125e+02  4.62975537e+03]
E1 = -182.52404556554524  E_coul = 54.24427479485012
Extra cycle  E= -128.279770770695  delta_E= -1.14e-13  |g|= 3.42e-08  |ddm|= 3.56e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.47135246e+03 1.07142384e+02 4.24466223e+02 5.13718651e-01
 3.20934679e+01 1.03303990e+01 1.74675052e+00 2.76595798e+00
 1.31856944e+01 5.99674046e-01]
grad_E = [-9.88108095e-06 -1.05491583e-04 -6.91584088e-06 -2.10200295e-04
  8.51615642e-04 -1.60250136e-03 -5.85146893e-04  3.58173306e-03
 -1.17864122e-03  5.20288818e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2494.98731837        1
[INPUT] 0    0    [1    /1   ]  107.826799114        1
[INPUT] 0    0    [1    /1   ]  426.905931463        1
[INPUT] 0    0    [1    /1   ]  0.513253962117       1
[INPUT] 0    0    [1    /1   ]  32.3298810434        1
[INPUT] 0    0    [1    /1   ]  10.370521636         1
[INPUT] 0    0    [1    /1   ]  1.74475925844        1
[INPUT] 1    0    [1    /1   ]  2.76357785858        1
[INPUT] 1    0    [1    /1   ]  13.1486025134        1
[INPUT] 1    0    [1    /1   ]  0.599631024065       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2494.9873183659784, 1.0]], [0, [107.82679911374612, 1.0]], [0, [426.9059314633363, 1.0]], [0, [0.5132539621174054, 1.0]], [0, [32.32988104342535, 1.0]], [0, [10.370521636017902, 1.0]], [0, [1.7447592584398415, 1.0]], [1, [2.763577858577272, 1.0]], [1, [13.148602513375158, 1.0]], [1, [0.5996310240645932, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2494.98731837]
bas 1, expnt(s) = [107.82679911]
bas 2, expnt(s) = [426.90593146]
bas 3, expnt(s) = [0.51325396]
bas 4, expnt(s) = [32.32988104]
bas 5, expnt(s) = [10.37052164]
bas 6, expnt(s) = [1.74475926]
bas 7, expnt(s) = [2.76357786]
bas 8, expnt(s) = [13.14860251]
bas 9, expnt(s) = [0.59963102]
CPU time:       442.01
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49498732e+03 8.91900241e+02 1.07826799e+02 8.45395748e+01
 4.26905931e+02 2.37281657e+02 5.13253962e-01 1.53201937e+00
 3.23298810e+01 3.42545372e+01 1.03705216e+01 1.46004243e+01
 1.74475926e+00 3.83545294e+00 2.76357786e+00 1.03949887e+01
 1.31486025e+01 7.30438891e+01 5.99631024e-01 1.53935757e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967028743448548
cond(S) = 76.19536193895222
E1 = -183.229831487057  E_coul = 55.00800951645001
init E= -128.221821970607
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742841550500393  LUMO = 2.27956845141316
  mo_energy =
[-3.25533326e+01 -1.85670119e+00 -7.42841551e-01 -7.42841551e-01
 -7.42841551e-01  2.27956845e+00  2.64946220e+00  2.64946220e+00
  2.64946220e+00  1.97219546e+01  1.97219546e+01  1.97219546e+01
  2.94002789e+01  1.71986979e+02  8.14551490e+02  4.67083150e+03]
E1 = -182.18559066393678  E_coul = 53.90770031005544
cycle= 1 E= -128.277890353881  delta_E= -0.0561  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269578
diis-c [-0.0726723  1.       ]
  HOMO = -0.809994470627966  LUMO = 2.2356403910757
  mo_energy =
[-3.28316165e+01 -1.92490036e+00 -8.09994471e-01 -8.09994471e-01
 -8.09994471e-01  2.23564039e+00  2.59350367e+00  2.59350367e+00
  2.59350367e+00  1.95280837e+01  1.95280837e+01  1.95280837e+01
  2.91927471e+01  1.71696709e+02  8.14212019e+02  4.67045003e+03]
E1 = -182.65900422535526  E_coul = 54.3794229123446
cycle= 2 E= -128.279581313011  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105783
diis-c [-2.21556512e-04  2.80105671e-01  7.19894329e-01]
  HOMO = -0.786718604360905  LUMO = 2.25313585142233
  mo_energy =
[-3.27554419e+01 -1.90082003e+00 -7.86718604e-01 -7.86718604e-01
 -7.86718604e-01  2.25313585e+00  2.61450322e+00  2.61450322e+00
  2.61450322e+00  1.95850542e+01  1.95850542e+01  1.95850542e+01
  2.92527211e+01  1.71775214e+02  8.14298305e+02  4.67054006e+03]
E1 = -182.52350984827999  E_coul = 54.24360934311826
cycle= 3 E= -128.279900505162  delta_E= -0.000319  |g|= 0.000519  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000733417
diis-c [-2.58571087e-08 -4.13896820e-03 -3.84455424e-03  1.00798352e+00]
  HOMO = -0.786913765016693  LUMO = 2.25299993990507
  mo_energy =
[-3.27559333e+01 -1.90103551e+00 -7.86913765e-01 -7.86913765e-01
 -7.86913765e-01  2.25299994e+00  2.61436524e+00  2.61436524e+00
  2.61436524e+00  1.95846641e+01  1.95846641e+01  1.95846641e+01
  2.92522803e+01  1.71774807e+02  8.14298029e+02  4.67053987e+03]
E1 = -182.52447679758492  E_coul = 54.244576276166455
cycle= 4 E= -128.279900521418  delta_E= -1.63e-08  |g|= 1.71e-05  |ddm|= 0.000146
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.91241e-05
diis-c [-7.94046527e-11  1.84960887e-04 -2.27020372e-04 -6.71039678e-02
  1.06714603e+00]
  HOMO = -0.786908165450657  LUMO = 2.25300156194495
  mo_energy =
[-3.27559189e+01 -1.90103277e+00 -7.86908165e-01 -7.86908165e-01
 -7.86908165e-01  2.25300156e+00  2.61436989e+00  2.61436989e+00
  2.61436989e+00  1.95846756e+01  1.95846756e+01  1.95846756e+01
  2.92522907e+01  1.71774824e+02  8.14298052e+02  4.67053989e+03]
E1 = -182.5244526655783  E_coul = 54.24455214413299
cycle= 5 E= -128.279900521445  delta_E= -2.68e-11  |g|= 1.41e-06  |ddm|= 6.07e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5244526655783  E_coul = 54.24455214413299
  HOMO = -0.786907801007665  LUMO = 2.25300156717011
  mo_energy =
[-3.27559180e+01 -1.90103274e+00 -7.86907801e-01 -7.86907801e-01
 -7.86907801e-01  2.25300157e+00  2.61437022e+00  2.61437022e+00
  2.61437022e+00  1.95846762e+01  1.95846762e+01  1.95846762e+01
  2.92522913e+01  1.71774825e+02  8.14298053e+02  4.67053990e+03]
E1 = -182.52445127527656  E_coul = 54.244550753831085
Extra cycle  E= -128.279900521445  delta_E= -1.71e-13  |g|= 3.37e-07  |ddm|= 7.73e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.49498732e+03 1.07826799e+02 4.26905931e+02 5.13253962e-01
 3.23298810e+01 1.03705216e+01 1.74475926e+00 2.76357786e+00
 1.31486025e+01 5.99631024e-01]
E = -128.27990052144548
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2494.98731837        1
[INPUT] 0    0    [1    /1   ]  107.826799114        1
[INPUT] 0    0    [1    /1   ]  426.905931463        1
[INPUT] 0    0    [1    /1   ]  0.513253962117       1
[INPUT] 0    0    [1    /1   ]  32.3298810434        1
[INPUT] 0    0    [1    /1   ]  10.370521636         1
[INPUT] 0    0    [1    /1   ]  1.74475925844        1
[INPUT] 1    0    [1    /1   ]  2.76357785858        1
[INPUT] 1    0    [1    /1   ]  13.1486025134        1
[INPUT] 1    0    [1    /1   ]  0.599631024065       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2494.9873183659784, 1.0]], [0, [107.82679911374612, 1.0]], [0, [426.9059314633363, 1.0]], [0, [0.5132539621174054, 1.0]], [0, [32.32988104342535, 1.0]], [0, [10.370521636017902, 1.0]], [0, [1.7447592584398415, 1.0]], [1, [2.763577858577272, 1.0]], [1, [13.148602513375158, 1.0]], [1, [0.5996310240645932, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2494.98731837]
bas 1, expnt(s) = [107.82679911]
bas 2, expnt(s) = [426.90593146]
bas 3, expnt(s) = [0.51325396]
bas 4, expnt(s) = [32.32988104]
bas 5, expnt(s) = [10.37052164]
bas 6, expnt(s) = [1.74475926]
bas 7, expnt(s) = [2.76357786]
bas 8, expnt(s) = [13.14860251]
bas 9, expnt(s) = [0.59963102]
CPU time:       443.58
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.49498732e+03 8.91900241e+02 1.07826799e+02 8.45395748e+01
 4.26905931e+02 2.37281657e+02 5.13253962e-01 1.53201937e+00
 3.23298810e+01 3.42545372e+01 1.03705216e+01 1.46004243e+01
 1.74475926e+00 3.83545294e+00 2.76357786e+00 1.03949887e+01
 1.31486025e+01 7.30438891e+01 5.99631024e-01 1.53935757e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967028743448548
cond(S) = 76.19536193895222
E1 = -183.229831487057  E_coul = 55.00800951645001
init E= -128.221821970607
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742841550500393  LUMO = 2.27956845141316
  mo_energy =
[-3.25533326e+01 -1.85670119e+00 -7.42841551e-01 -7.42841551e-01
 -7.42841551e-01  2.27956845e+00  2.64946220e+00  2.64946220e+00
  2.64946220e+00  1.97219546e+01  1.97219546e+01  1.97219546e+01
  2.94002789e+01  1.71986979e+02  8.14551490e+02  4.67083150e+03]
E1 = -182.18559066393678  E_coul = 53.90770031005544
cycle= 1 E= -128.277890353881  delta_E= -0.0561  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269578
diis-c [-0.0726723  1.       ]
  HOMO = -0.809994470627966  LUMO = 2.2356403910757
  mo_energy =
[-3.28316165e+01 -1.92490036e+00 -8.09994471e-01 -8.09994471e-01
 -8.09994471e-01  2.23564039e+00  2.59350367e+00  2.59350367e+00
  2.59350367e+00  1.95280837e+01  1.95280837e+01  1.95280837e+01
  2.91927471e+01  1.71696709e+02  8.14212019e+02  4.67045003e+03]
E1 = -182.65900422535526  E_coul = 54.3794229123446
cycle= 2 E= -128.279581313011  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105783
diis-c [-2.21556512e-04  2.80105671e-01  7.19894329e-01]
  HOMO = -0.786718604360905  LUMO = 2.25313585142233
  mo_energy =
[-3.27554419e+01 -1.90082003e+00 -7.86718604e-01 -7.86718604e-01
 -7.86718604e-01  2.25313585e+00  2.61450322e+00  2.61450322e+00
  2.61450322e+00  1.95850542e+01  1.95850542e+01  1.95850542e+01
  2.92527211e+01  1.71775214e+02  8.14298305e+02  4.67054006e+03]
E1 = -182.52350984827999  E_coul = 54.24360934311826
cycle= 3 E= -128.279900505162  delta_E= -0.000319  |g|= 0.000519  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000733417
diis-c [-2.58571087e-08 -4.13896820e-03 -3.84455424e-03  1.00798352e+00]
  HOMO = -0.786913765016693  LUMO = 2.25299993990507
  mo_energy =
[-3.27559333e+01 -1.90103551e+00 -7.86913765e-01 -7.86913765e-01
 -7.86913765e-01  2.25299994e+00  2.61436524e+00  2.61436524e+00
  2.61436524e+00  1.95846641e+01  1.95846641e+01  1.95846641e+01
  2.92522803e+01  1.71774807e+02  8.14298029e+02  4.67053987e+03]
E1 = -182.52447679758492  E_coul = 54.244576276166455
cycle= 4 E= -128.279900521418  delta_E= -1.63e-08  |g|= 1.71e-05  |ddm|= 0.000146
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.91241e-05
diis-c [-7.94046527e-11  1.84960887e-04 -2.27020372e-04 -6.71039678e-02
  1.06714603e+00]
  HOMO = -0.786908165450657  LUMO = 2.25300156194495
  mo_energy =
[-3.27559189e+01 -1.90103277e+00 -7.86908165e-01 -7.86908165e-01
 -7.86908165e-01  2.25300156e+00  2.61436989e+00  2.61436989e+00
  2.61436989e+00  1.95846756e+01  1.95846756e+01  1.95846756e+01
  2.92522907e+01  1.71774824e+02  8.14298052e+02  4.67053989e+03]
E1 = -182.5244526655783  E_coul = 54.24455214413299
cycle= 5 E= -128.279900521445  delta_E= -2.68e-11  |g|= 1.41e-06  |ddm|= 6.07e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5244526655783  E_coul = 54.24455214413299
  HOMO = -0.786907801007665  LUMO = 2.25300156717011
  mo_energy =
[-3.27559180e+01 -1.90103274e+00 -7.86907801e-01 -7.86907801e-01
 -7.86907801e-01  2.25300157e+00  2.61437022e+00  2.61437022e+00
  2.61437022e+00  1.95846762e+01  1.95846762e+01  1.95846762e+01
  2.92522913e+01  1.71774825e+02  8.14298053e+02  4.67053990e+03]
E1 = -182.52445127527656  E_coul = 54.244550753831085
Extra cycle  E= -128.279900521445  delta_E= -1.71e-13  |g|= 3.37e-07  |ddm|= 7.73e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 76.19536193895222
E1 = -182.52445127527656  E_coul = 54.244550753831085
init E= -128.279900521445
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786907879590091  LUMO = 2.25300145555853
  mo_energy =
[-3.27559184e+01 -1.90103289e+00 -7.86907880e-01 -7.86907880e-01
 -7.86907880e-01  2.25300146e+00  2.61437015e+00  2.61437015e+00
  2.61437015e+00  1.95846760e+01  1.95846760e+01  1.95846760e+01
  2.92522910e+01  1.71774824e+02  8.14298053e+02  4.67053990e+03]
E1 = -182.52445186844633  E_coul = 54.24455134700056
cycle= 1 E= -128.279900521446  delta_E= -2.84e-13  |g|= 8.97e-08  |ddm|= 1.97e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52445186844633  E_coul = 54.24455134700056
  HOMO = -0.786907835794933  LUMO = 2.25300147865983
  mo_energy =
[-3.27559182e+01 -1.90103286e+00 -7.86907836e-01 -7.86907836e-01
 -7.86907836e-01  2.25300148e+00  2.61437019e+00  2.61437019e+00
  2.61437019e+00  1.95846761e+01  1.95846761e+01  1.95846761e+01
  2.92522911e+01  1.71774824e+02  8.14298053e+02  4.67053990e+03]
E1 = -182.52445163922147  E_coul = 54.2445511177759
Extra cycle  E= -128.279900521446  delta_E= 1.99e-13  |g|= 3.34e-08  |ddm|= 3.42e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.49498732e+03 1.07826799e+02 4.26905931e+02 5.13253962e-01
 3.23298810e+01 1.03705216e+01 1.74475926e+00 2.76357786e+00
 1.31486025e+01 5.99631024e-01]
grad_E = [-9.34815128e-06 -1.35602295e-04 -7.86964550e-06 -2.70554640e-04
  1.09444454e-03 -2.05631228e-03 -7.49713867e-04  4.59126771e-03
 -1.51096366e-03  6.68611802e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2535.86822244        1
[INPUT] 0    0    [1    /1   ]  108.892770361        1
[INPUT] 0    0    [1    /1   ]  431.286760151        1
[INPUT] 0    0    [1    /1   ]  0.512836493739       1
[INPUT] 0    0    [1    /1   ]  32.6647294625        1
[INPUT] 0    0    [1    /1   ]  10.429310761         1
[INPUT] 0    0    [1    /1   ]  1.74271707381        1
[INPUT] 1    0    [1    /1   ]  2.76091207507        1
[INPUT] 1    0    [1    /1   ]  13.1060506364        1
[INPUT] 1    0    [1    /1   ]  0.599601834589       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2535.8682224418926, 1.0]], [0, [108.89277036095703, 1.0]], [0, [431.28676015052923, 1.0]], [0, [0.5128364937394179, 1.0]], [0, [32.66472946254831, 1.0]], [0, [10.42931076100486, 1.0]], [0, [1.7427170738115327, 1.0]], [1, [2.7609120750669867, 1.0]], [1, [13.106050636394622, 1.0]], [1, [0.5996018345891767, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2535.86822244]
bas 1, expnt(s) = [108.89277036]
bas 2, expnt(s) = [431.28676015]
bas 3, expnt(s) = [0.51283649]
bas 4, expnt(s) = [32.66472946]
bas 5, expnt(s) = [10.42931076]
bas 6, expnt(s) = [1.74271707]
bas 7, expnt(s) = [2.76091208]
bas 8, expnt(s) = [13.10605064]
bas 9, expnt(s) = [0.59960183]
CPU time:       446.84
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.53586822e+03 9.02838427e+02 1.08892770e+02 8.51656194e+01
 4.31286760e+02 2.39105529e+02 5.12836494e-01 1.53108470e+00
 3.26647295e+01 3.45202811e+01 1.04293108e+01 1.46624563e+01
 1.74271707e+00 3.83208549e+00 2.76091208e+00 1.03824563e+01
 1.31060506e+01 7.27485254e+01 5.99601835e-01 1.53926390e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967046164977017
cond(S) = 75.44278459550017
E1 = -183.23003727807588  E_coul = 55.008051601667994
init E= -128.221985676408
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742790231854792  LUMO = 2.27690264327956
  mo_energy =
[-3.25536035e+01 -1.85667561e+00 -7.42790232e-01 -7.42790232e-01
 -7.42790232e-01  2.27690264e+00  2.64856386e+00  2.64856386e+00
  2.64856386e+00  1.96693265e+01  1.96693265e+01  1.96693265e+01
  2.96498540e+01  1.73915260e+02  8.23803224e+02  4.74124126e+03]
E1 = -182.18636656605335  E_coul = 53.908247475951505
cycle= 1 E= -128.278119090102  delta_E= -0.0561  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269549
diis-c [-0.07265646  1.        ]
  HOMO = -0.809926298362788  LUMO = 2.23302002738167
  mo_energy =
[-3.28317311e+01 -1.92483013e+00 -8.09926298e-01 -8.09926298e-01
 -8.09926298e-01  2.23302003e+00  2.59265633e+00  2.59265633e+00
  2.59265633e+00  1.94757923e+01  1.94757923e+01  1.94757923e+01
  2.94416636e+01  1.73624672e+02  8.23463759e+02  4.74085987e+03]
E1 = -182.65966357088766  E_coul = 54.37985481344343
cycle= 2 E= -128.279808757444  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105745
diis-c [-2.22193143e-04  2.80047312e-01  7.19952688e-01]
  HOMO = -0.786652451396671  LUMO = 2.25050987654759
  mo_energy =
[-3.27555770e+01 -1.90075118e+00 -7.86652451e-01 -7.86652451e-01
 -7.86652451e-01  2.25050988e+00  2.61364215e+00  2.61364215e+00
  2.61364215e+00  1.95326816e+01  1.95326816e+01  1.95326816e+01
  2.95018070e+01  1.73703244e+02  8.23550043e+02  4.74094986e+03]
E1 = -182.5241788320374  E_coul = 54.244051036484585
cycle= 3 E= -128.280127795553  delta_E= -0.000319  |g|= 0.000521  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000744056
diis-c [-2.40252125e-08 -4.04183306e-03 -3.46936848e-03  1.00751120e+00]
  HOMO = -0.786850077572637  LUMO = 2.25037333715712
  mo_energy =
[-3.27560761e+01 -1.90096766e+00 -7.86850078e-01 -7.86850078e-01
 -7.86850078e-01  2.25037334e+00  2.61350194e+00  2.61350194e+00
  2.61350194e+00  1.95322859e+01  1.95322859e+01  1.95322859e+01
  2.95013603e+01  1.73702828e+02  8.23549755e+02  4.74094966e+03]
E1 = -182.52515849024687  E_coul = 54.24503067806396
cycle= 4 E= -128.280127812183  delta_E= -1.66e-08  |g|= 1.6e-05  |ddm|= 0.000147
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.73323e-05
diis-c [-6.79482165e-11  1.71397291e-04 -2.32889499e-04 -6.37873241e-02
  1.06384882e+00]
  HOMO = -0.786844811059916  LUMO = 2.25037493689043
  mo_energy =
[-3.27560625e+01 -1.90096498e+00 -7.86844811e-01 -7.86844811e-01
 -7.86844811e-01  2.25037494e+00  2.61350631e+00  2.61350631e+00
  2.61350631e+00  1.95322966e+01  1.95322966e+01  1.95322966e+01
  2.95013701e+01  1.73702844e+02  8.23549777e+02  4.74094969e+03]
E1 = -182.52513564895924  E_coul = 54.24500783675309
cycle= 5 E= -128.280127812206  delta_E= -2.32e-11  |g|= 1.32e-06  |ddm|= 5.5e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52513564895924  E_coul = 54.24500783675309
  HOMO = -0.78684446072248  LUMO = 2.25037495083901
  mo_energy =
[-3.27560617e+01 -1.90096494e+00 -7.86844461e-01 -7.86844461e-01
 -7.86844461e-01  2.25037495e+00  2.61350663e+00  2.61350663e+00
  2.61350663e+00  1.95322973e+01  1.95322973e+01  1.95322973e+01
  2.95013707e+01  1.73702845e+02  8.23549778e+02  4.74094969e+03]
E1 = -182.52513429579793  E_coul = 54.245006483591624
Extra cycle  E= -128.280127812206  delta_E= -1.42e-13  |g|= 3.18e-07  |ddm|= 7.15e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.53586822e+03 1.08892770e+02 4.31286760e+02 5.12836494e-01
 3.26647295e+01 1.04293108e+01 1.74271707e+00 2.76091208e+00
 1.31060506e+01 5.99601835e-01]
E = -128.2801278122063
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2535.86822244        1
[INPUT] 0    0    [1    /1   ]  108.892770361        1
[INPUT] 0    0    [1    /1   ]  431.286760151        1
[INPUT] 0    0    [1    /1   ]  0.512836493739       1
[INPUT] 0    0    [1    /1   ]  32.6647294625        1
[INPUT] 0    0    [1    /1   ]  10.429310761         1
[INPUT] 0    0    [1    /1   ]  1.74271707381        1
[INPUT] 1    0    [1    /1   ]  2.76091207507        1
[INPUT] 1    0    [1    /1   ]  13.1060506364        1
[INPUT] 1    0    [1    /1   ]  0.599601834589       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2535.8682224418926, 1.0]], [0, [108.89277036095703, 1.0]], [0, [431.28676015052923, 1.0]], [0, [0.5128364937394179, 1.0]], [0, [32.66472946254831, 1.0]], [0, [10.42931076100486, 1.0]], [0, [1.7427170738115327, 1.0]], [1, [2.7609120750669867, 1.0]], [1, [13.106050636394622, 1.0]], [1, [0.5996018345891767, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2535.86822244]
bas 1, expnt(s) = [108.89277036]
bas 2, expnt(s) = [431.28676015]
bas 3, expnt(s) = [0.51283649]
bas 4, expnt(s) = [32.66472946]
bas 5, expnt(s) = [10.42931076]
bas 6, expnt(s) = [1.74271707]
bas 7, expnt(s) = [2.76091208]
bas 8, expnt(s) = [13.10605064]
bas 9, expnt(s) = [0.59960183]
CPU time:       448.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.53586822e+03 9.02838427e+02 1.08892770e+02 8.51656194e+01
 4.31286760e+02 2.39105529e+02 5.12836494e-01 1.53108470e+00
 3.26647295e+01 3.45202811e+01 1.04293108e+01 1.46624563e+01
 1.74271707e+00 3.83208549e+00 2.76091208e+00 1.03824563e+01
 1.31060506e+01 7.27485254e+01 5.99601835e-01 1.53926390e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967046164977017
cond(S) = 75.44278459550017
E1 = -183.23003727807588  E_coul = 55.008051601667994
init E= -128.221985676408
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742790231854792  LUMO = 2.27690264327956
  mo_energy =
[-3.25536035e+01 -1.85667561e+00 -7.42790232e-01 -7.42790232e-01
 -7.42790232e-01  2.27690264e+00  2.64856386e+00  2.64856386e+00
  2.64856386e+00  1.96693265e+01  1.96693265e+01  1.96693265e+01
  2.96498540e+01  1.73915260e+02  8.23803224e+02  4.74124126e+03]
E1 = -182.18636656605335  E_coul = 53.908247475951505
cycle= 1 E= -128.278119090102  delta_E= -0.0561  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269549
diis-c [-0.07265646  1.        ]
  HOMO = -0.809926298362788  LUMO = 2.23302002738167
  mo_energy =
[-3.28317311e+01 -1.92483013e+00 -8.09926298e-01 -8.09926298e-01
 -8.09926298e-01  2.23302003e+00  2.59265633e+00  2.59265633e+00
  2.59265633e+00  1.94757923e+01  1.94757923e+01  1.94757923e+01
  2.94416636e+01  1.73624672e+02  8.23463759e+02  4.74085987e+03]
E1 = -182.65966357088766  E_coul = 54.37985481344343
cycle= 2 E= -128.279808757444  delta_E= -0.00169  |g|= 0.0641  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105745
diis-c [-2.22193143e-04  2.80047312e-01  7.19952688e-01]
  HOMO = -0.786652451396671  LUMO = 2.25050987654759
  mo_energy =
[-3.27555770e+01 -1.90075118e+00 -7.86652451e-01 -7.86652451e-01
 -7.86652451e-01  2.25050988e+00  2.61364215e+00  2.61364215e+00
  2.61364215e+00  1.95326816e+01  1.95326816e+01  1.95326816e+01
  2.95018070e+01  1.73703244e+02  8.23550043e+02  4.74094986e+03]
E1 = -182.5241788320374  E_coul = 54.244051036484585
cycle= 3 E= -128.280127795553  delta_E= -0.000319  |g|= 0.000521  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000744056
diis-c [-2.40252125e-08 -4.04183306e-03 -3.46936848e-03  1.00751120e+00]
  HOMO = -0.786850077572637  LUMO = 2.25037333715712
  mo_energy =
[-3.27560761e+01 -1.90096766e+00 -7.86850078e-01 -7.86850078e-01
 -7.86850078e-01  2.25037334e+00  2.61350194e+00  2.61350194e+00
  2.61350194e+00  1.95322859e+01  1.95322859e+01  1.95322859e+01
  2.95013603e+01  1.73702828e+02  8.23549755e+02  4.74094966e+03]
E1 = -182.52515849024687  E_coul = 54.24503067806396
cycle= 4 E= -128.280127812183  delta_E= -1.66e-08  |g|= 1.6e-05  |ddm|= 0.000147
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.73323e-05
diis-c [-6.79482165e-11  1.71397291e-04 -2.32889499e-04 -6.37873241e-02
  1.06384882e+00]
  HOMO = -0.786844811059916  LUMO = 2.25037493689043
  mo_energy =
[-3.27560625e+01 -1.90096498e+00 -7.86844811e-01 -7.86844811e-01
 -7.86844811e-01  2.25037494e+00  2.61350631e+00  2.61350631e+00
  2.61350631e+00  1.95322966e+01  1.95322966e+01  1.95322966e+01
  2.95013701e+01  1.73702844e+02  8.23549777e+02  4.74094969e+03]
E1 = -182.52513564895924  E_coul = 54.24500783675309
cycle= 5 E= -128.280127812206  delta_E= -2.32e-11  |g|= 1.32e-06  |ddm|= 5.5e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52513564895924  E_coul = 54.24500783675309
  HOMO = -0.78684446072248  LUMO = 2.25037495083901
  mo_energy =
[-3.27560617e+01 -1.90096494e+00 -7.86844461e-01 -7.86844461e-01
 -7.86844461e-01  2.25037495e+00  2.61350663e+00  2.61350663e+00
  2.61350663e+00  1.95322973e+01  1.95322973e+01  1.95322973e+01
  2.95013707e+01  1.73702845e+02  8.23549778e+02  4.74094969e+03]
E1 = -182.52513429579793  E_coul = 54.245006483591624
Extra cycle  E= -128.280127812206  delta_E= -1.42e-13  |g|= 3.18e-07  |ddm|= 7.15e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 75.44278459550017
E1 = -182.52513429579793  E_coul = 54.245006483591624
init E= -128.280127812206
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786844537953805  LUMO = 2.25037484408967
  mo_energy =
[-3.27560620e+01 -1.90096508e+00 -7.86844538e-01 -7.86844538e-01
 -7.86844538e-01  2.25037484e+00  2.61350656e+00  2.61350656e+00
  2.61350656e+00  1.95322971e+01  1.95322971e+01  1.95322971e+01
  2.95013705e+01  1.73702845e+02  8.23549778e+02  4.74094969e+03]
E1 = -182.52513487170137  E_coul = 54.24500705949501
cycle= 1 E= -128.280127812206  delta_E= -5.68e-14  |g|= 8.62e-08  |ddm|= 1.85e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.52513487170137  E_coul = 54.24500705949501
  HOMO = -0.786844495563635  LUMO = 2.25037486683905
  mo_energy =
[-3.27560618e+01 -1.90096505e+00 -7.86844496e-01 -7.86844496e-01
 -7.86844496e-01  2.25037487e+00  2.61350659e+00  2.61350659e+00
  2.61350659e+00  1.95322972e+01  1.95322972e+01  1.95322972e+01
  2.95013706e+01  1.73702845e+02  8.23549778e+02  4.74094969e+03]
E1 = -182.52513464885266  E_coul = 54.24500683664644
Extra cycle  E= -128.280127812206  delta_E= 1.42e-13  |g|= 3.23e-08  |ddm|= 3.26e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.53586822e+03 1.08892770e+02 4.31286760e+02 5.12836494e-01
 3.26647295e+01 1.04293108e+01 1.74271707e+00 2.76091208e+00
 1.31060506e+01 5.99601835e-01]
grad_E = [-8.53920000e-06 -1.71431565e-04 -8.88363190e-06 -3.41094904e-04
  1.38236505e-03 -2.59005784e-03 -9.42580092e-04  5.77428069e-03
 -1.90034430e-03  8.44150183e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2607.27701322        1
[INPUT] 0    0    [1    /1   ]  110.570699219        1
[INPUT] 0    0    [1    /1   ]  439.090026289        1
[INPUT] 0    0    [1    /1   ]  0.512606476346       1
[INPUT] 0    0    [1    /1   ]  33.1405548468        1
[INPUT] 0    0    [1    /1   ]  10.5153214416        1
[INPUT] 0    0    [1    /1   ]  1.74097726929        1
[INPUT] 1    0    [1    /1   ]  2.75814307467        1
[INPUT] 1    0    [1    /1   ]  13.0603178392        1
[INPUT] 1    0    [1    /1   ]  0.599600500971       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2607.2770132202418, 1.0]], [0, [110.5706992193128, 1.0]], [0, [439.0900262886603, 1.0]], [0, [0.5126064763455253, 1.0]], [0, [33.140554846789435, 1.0]], [0, [10.515321441612219, 1.0]], [0, [1.7409772692863537, 1.0]], [1, [2.758143074670853, 1.0]], [1, [13.060317839152281, 1.0]], [1, [0.5996005009706212, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2607.27701322]
bas 1, expnt(s) = [110.57069922]
bas 2, expnt(s) = [439.09002629]
bas 3, expnt(s) = [0.51260648]
bas 4, expnt(s) = [33.14055485]
bas 5, expnt(s) = [10.51532144]
bas 6, expnt(s) = [1.74097727]
bas 7, expnt(s) = [2.75814307]
bas 8, expnt(s) = [13.06031784]
bas 9, expnt(s) = [0.5996005]
CPU time:       451.66
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.60727701e+03 9.21839697e+02 1.10570699e+02 8.61479736e+01
 4.39090026e+02 2.42342846e+02 5.12606476e-01 1.53056963e+00
 3.31405548e+01 3.48967398e+01 1.05153214e+01 1.47530542e+01
 1.74097727e+00 3.82921587e+00 2.75814307e+00 1.03694419e+01
 1.30603178e+01 7.24313492e+01 5.99600501e-01 1.53925962e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967055340415847
cond(S) = 74.16555071069003
E1 = -183.23030890428944  E_coul = 55.00811387008551
init E= -128.222195034204
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742730381364776  LUMO = 2.27564416421741
  mo_energy =
[-3.25539682e+01 -1.85665321e+00 -7.42730381e-01 -7.42730381e-01
 -7.42730381e-01  2.27564416e+00  2.64776136e+00  2.64776136e+00
  2.64776136e+00  1.96132267e+01  1.96132267e+01  1.96132267e+01
  3.00202298e+01  1.76821825e+02  8.39161462e+02  4.86378200e+03]
E1 = -182.18768654292504  E_coul = 53.909172098335276
cycle= 1 E= -128.27851444459  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269415
diis-c [-0.07258454  1.        ]
  HOMO = -0.809825223980579  LUMO = 2.23178026011851
  mo_energy =
[-3.28318579e+01 -1.92474022e+00 -8.09825224e-01 -8.09825224e-01
 -8.09825224e-01  2.23178026e+00  2.59192784e+00  2.59192784e+00
  2.59192784e+00  1.94201067e+01  1.94201067e+01  1.94201067e+01
  2.98111116e+01  1.76530780e+02  8.38821941e+02  4.86340068e+03]
E1 = -182.66071970632981  E_coul = 54.380517824950196
cycle= 2 E= -128.28020188138  delta_E= -0.00169  |g|= 0.064  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105656
diis-c [-2.23438272e-04  2.79966055e-01  7.20033945e-01]
  HOMO = -0.786559745865496  LUMO = 2.24927213005164
  mo_energy =
[-3.27557461e+01 -1.90066910e+00 -7.86559746e-01 -7.86559746e-01
 -7.86559746e-01  2.24927213e+00  2.61289416e+00  2.61289416e+00
  2.61289416e+00  1.94768931e+01  1.94768931e+01  1.94768931e+01
  2.98714854e+01  1.76609442e+02  8.38908224e+02  4.86349063e+03]
E1 = -182.5252884888667  E_coul = 54.244767931247075
cycle= 3 E= -128.28052055762  delta_E= -0.000319  |g|= 0.000525  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00075629
diis-c [-2.22986400e-08 -3.92934337e-03 -3.03771687e-03  1.00696706e+00]
  HOMO = -0.786760150948623  LUMO = 2.24913452330835
  mo_energy =
[-3.27562544e+01 -1.90088703e+00 -7.86760151e-01 -7.86760151e-01
 -7.86760151e-01  2.24913452e+00  2.61275140e+00  2.61275140e+00
  2.61275140e+00  1.94764908e+01  1.94764908e+01  1.94764908e+01
  2.98710313e+01  1.76609016e+02  8.38907922e+02  4.86349041e+03]
E1 = -182.52628333291207  E_coul = 54.24576275818773
cycle= 4 E= -128.280520574724  delta_E= -1.71e-08  |g|= 1.5e-05  |ddm|= 0.000147
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.56468e-05
diis-c [-5.79131955e-11  1.58253542e-04 -2.40398078e-04 -6.06836326e-02
  1.06076578e+00]
  HOMO = -0.786755200025917  LUMO = 2.2491360975799
  mo_energy =
[-3.27562416e+01 -1.90088442e+00 -7.86755200e-01 -7.86755200e-01
 -7.86755200e-01  2.24913610e+00  2.61275550e+00  2.61275550e+00
  2.61275550e+00  1.94765009e+01  1.94765009e+01  1.94765009e+01
  2.98710407e+01  1.76609031e+02  8.38907943e+02  4.86349044e+03]
E1 = -182.52626172364236  E_coul = 54.245741148898084
cycle= 5 E= -128.280520574744  delta_E= -2e-11  |g|= 1.23e-06  |ddm|= 4.99e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52626172364236  E_coul = 54.245741148898084
  HOMO = -0.786754863490595  LUMO = 2.24913611969151
  mo_energy =
[-3.27562408e+01 -1.90088437e+00 -7.86754863e-01 -7.86754863e-01
 -7.86754863e-01  2.24913612e+00  2.61275581e+00  2.61275581e+00
  2.61275581e+00  1.94765016e+01  1.94765016e+01  1.94765016e+01
  2.98710413e+01  1.76609032e+02  8.38907944e+02  4.86349044e+03]
E1 = -182.5262604068822  E_coul = 54.24573983213788
Extra cycle  E= -128.280520574744  delta_E= -2.84e-14  |g|= 3e-07  |ddm|= 6.6e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.60727701e+03 1.10570699e+02 4.39090026e+02 5.12606476e-01
 3.31405548e+01 1.05153214e+01 1.74097727e+00 2.75814307e+00
 1.30603178e+01 5.99600501e-01]
E = -128.28052057474432
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2607.27701322        1
[INPUT] 0    0    [1    /1   ]  110.570699219        1
[INPUT] 0    0    [1    /1   ]  439.090026289        1
[INPUT] 0    0    [1    /1   ]  0.512606476346       1
[INPUT] 0    0    [1    /1   ]  33.1405548468        1
[INPUT] 0    0    [1    /1   ]  10.5153214416        1
[INPUT] 0    0    [1    /1   ]  1.74097726929        1
[INPUT] 1    0    [1    /1   ]  2.75814307467        1
[INPUT] 1    0    [1    /1   ]  13.0603178392        1
[INPUT] 1    0    [1    /1   ]  0.599600500971       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2607.2770132202418, 1.0]], [0, [110.5706992193128, 1.0]], [0, [439.0900262886603, 1.0]], [0, [0.5126064763455253, 1.0]], [0, [33.140554846789435, 1.0]], [0, [10.515321441612219, 1.0]], [0, [1.7409772692863537, 1.0]], [1, [2.758143074670853, 1.0]], [1, [13.060317839152281, 1.0]], [1, [0.5996005009706212, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2607.27701322]
bas 1, expnt(s) = [110.57069922]
bas 2, expnt(s) = [439.09002629]
bas 3, expnt(s) = [0.51260648]
bas 4, expnt(s) = [33.14055485]
bas 5, expnt(s) = [10.51532144]
bas 6, expnt(s) = [1.74097727]
bas 7, expnt(s) = [2.75814307]
bas 8, expnt(s) = [13.06031784]
bas 9, expnt(s) = [0.5996005]
CPU time:       453.21
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.60727701e+03 9.21839697e+02 1.10570699e+02 8.61479736e+01
 4.39090026e+02 2.42342846e+02 5.12606476e-01 1.53056963e+00
 3.31405548e+01 3.48967398e+01 1.05153214e+01 1.47530542e+01
 1.74097727e+00 3.82921587e+00 2.75814307e+00 1.03694419e+01
 1.30603178e+01 7.24313492e+01 5.99600501e-01 1.53925962e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967055340415847
cond(S) = 74.16555071069003
E1 = -183.23030890428944  E_coul = 55.00811387008551
init E= -128.222195034204
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742730381364776  LUMO = 2.27564416421741
  mo_energy =
[-3.25539682e+01 -1.85665321e+00 -7.42730381e-01 -7.42730381e-01
 -7.42730381e-01  2.27564416e+00  2.64776136e+00  2.64776136e+00
  2.64776136e+00  1.96132267e+01  1.96132267e+01  1.96132267e+01
  3.00202298e+01  1.76821825e+02  8.39161462e+02  4.86378200e+03]
E1 = -182.18768654292504  E_coul = 53.909172098335276
cycle= 1 E= -128.27851444459  delta_E= -0.0563  |g|= 0.167  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269415
diis-c [-0.07258454  1.        ]
  HOMO = -0.809825223980579  LUMO = 2.23178026011851
  mo_energy =
[-3.28318579e+01 -1.92474022e+00 -8.09825224e-01 -8.09825224e-01
 -8.09825224e-01  2.23178026e+00  2.59192784e+00  2.59192784e+00
  2.59192784e+00  1.94201067e+01  1.94201067e+01  1.94201067e+01
  2.98111116e+01  1.76530780e+02  8.38821941e+02  4.86340068e+03]
E1 = -182.66071970632981  E_coul = 54.380517824950196
cycle= 2 E= -128.28020188138  delta_E= -0.00169  |g|= 0.064  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.105656
diis-c [-2.23438272e-04  2.79966055e-01  7.20033945e-01]
  HOMO = -0.786559745865496  LUMO = 2.24927213005164
  mo_energy =
[-3.27557461e+01 -1.90066910e+00 -7.86559746e-01 -7.86559746e-01
 -7.86559746e-01  2.24927213e+00  2.61289416e+00  2.61289416e+00
  2.61289416e+00  1.94768931e+01  1.94768931e+01  1.94768931e+01
  2.98714854e+01  1.76609442e+02  8.38908224e+02  4.86349063e+03]
E1 = -182.5252884888667  E_coul = 54.244767931247075
cycle= 3 E= -128.28052055762  delta_E= -0.000319  |g|= 0.000525  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00075629
diis-c [-2.22986400e-08 -3.92934337e-03 -3.03771687e-03  1.00696706e+00]
  HOMO = -0.786760150948623  LUMO = 2.24913452330835
  mo_energy =
[-3.27562544e+01 -1.90088703e+00 -7.86760151e-01 -7.86760151e-01
 -7.86760151e-01  2.24913452e+00  2.61275140e+00  2.61275140e+00
  2.61275140e+00  1.94764908e+01  1.94764908e+01  1.94764908e+01
  2.98710313e+01  1.76609016e+02  8.38907922e+02  4.86349041e+03]
E1 = -182.52628333291207  E_coul = 54.24576275818773
cycle= 4 E= -128.280520574724  delta_E= -1.71e-08  |g|= 1.5e-05  |ddm|= 0.000147
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.56468e-05
diis-c [-5.79131955e-11  1.58253542e-04 -2.40398078e-04 -6.06836326e-02
  1.06076578e+00]
  HOMO = -0.786755200025917  LUMO = 2.2491360975799
  mo_energy =
[-3.27562416e+01 -1.90088442e+00 -7.86755200e-01 -7.86755200e-01
 -7.86755200e-01  2.24913610e+00  2.61275550e+00  2.61275550e+00
  2.61275550e+00  1.94765009e+01  1.94765009e+01  1.94765009e+01
  2.98710407e+01  1.76609031e+02  8.38907943e+02  4.86349044e+03]
E1 = -182.52626172364236  E_coul = 54.245741148898084
cycle= 5 E= -128.280520574744  delta_E= -2e-11  |g|= 1.23e-06  |ddm|= 4.99e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52626172364236  E_coul = 54.245741148898084
  HOMO = -0.786754863490595  LUMO = 2.24913611969151
  mo_energy =
[-3.27562408e+01 -1.90088437e+00 -7.86754863e-01 -7.86754863e-01
 -7.86754863e-01  2.24913612e+00  2.61275581e+00  2.61275581e+00
  2.61275581e+00  1.94765016e+01  1.94765016e+01  1.94765016e+01
  2.98710413e+01  1.76609032e+02  8.38907944e+02  4.86349044e+03]
E1 = -182.5262604068822  E_coul = 54.24573983213788
Extra cycle  E= -128.280520574744  delta_E= -2.84e-14  |g|= 3e-07  |ddm|= 6.6e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 74.16555071069003
E1 = -182.5262604068822  E_coul = 54.24573983213788
init E= -128.280520574744
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786754939379628  LUMO = 2.24913601757691
  mo_energy =
[-3.27562410e+01 -1.90088451e+00 -7.86754939e-01 -7.86754939e-01
 -7.86754939e-01  2.24913602e+00  2.61275574e+00  2.61275574e+00
  2.61275574e+00  1.94765013e+01  1.94765013e+01  1.94765013e+01
  2.98710410e+01  1.76609032e+02  8.38907944e+02  4.86349044e+03]
E1 = -182.5262609658036  E_coul = 54.2457403910594
cycle= 1 E= -128.280520574744  delta_E= 1.14e-13  |g|= 8.27e-08  |ddm|= 1.74e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5262609658036  E_coul = 54.2457403910594
  HOMO = -0.786754898367427  LUMO = 2.24913603998523
  mo_energy =
[-3.27562409e+01 -1.90088448e+00 -7.86754898e-01 -7.86754898e-01
 -7.86754898e-01  2.24913604e+00  2.61275578e+00  2.61275578e+00
  2.61275578e+00  1.94765014e+01  1.94765014e+01  1.94765014e+01
  2.98710411e+01  1.76609032e+02  8.38907944e+02  4.86349044e+03]
E1 = -182.52626074923222  E_coul = 54.24574017448787
Extra cycle  E= -128.280520574744  delta_E= -1.42e-13  |g|= 3.12e-08  |ddm|= 3.11e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.60727701e+03 1.10570699e+02 4.39090026e+02 5.12606476e-01
 3.31405548e+01 1.05153214e+01 1.74097727e+00 2.75814307e+00
 1.30603178e+01 5.99600501e-01]
grad_E = [-7.32711218e-06 -2.12250921e-04 -9.78692665e-06 -4.14998558e-04
  1.70796015e-03 -3.18325611e-03 -1.15674092e-03  7.07846883e-03
 -2.32956819e-03  1.04145578e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2732.74068399        1
[INPUT] 0    0    [1    /1   ]  113.193435702        1
[INPUT] 0    0    [1    /1   ]  452.846126575        1
[INPUT] 0    0    [1    /1   ]  0.512857613571       1
[INPUT] 0    0    [1    /1   ]  33.798412233         1
[INPUT] 0    0    [1    /1   ]  10.6367383817        1
[INPUT] 0    0    [1    /1   ]  1.74037242774        1
[INPUT] 1    0    [1    /1   ]  2.75579170647        1
[INPUT] 1    0    [1    /1   ]  13.0192236328        1
[INPUT] 1    0    [1    /1   ]  0.599642573334       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2732.7406839925475, 1.0]], [0, [113.1934357016341, 1.0]], [0, [452.8461265753763, 1.0]], [0, [0.5128576135709002, 1.0]], [0, [33.79841223297777, 1.0]], [0, [10.636738381738148, 1.0]], [0, [1.740372427743367, 1.0]], [1, [2.7557917064739237, 1.0]], [1, [13.01922363276003, 1.0]], [1, [0.5996425733341656, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2732.74068399]
bas 1, expnt(s) = [113.1934357]
bas 2, expnt(s) = [452.84612658]
bas 3, expnt(s) = [0.51285761]
bas 4, expnt(s) = [33.79841223]
bas 5, expnt(s) = [10.63673838]
bas 6, expnt(s) = [1.74037243]
bas 7, expnt(s) = [2.75579171]
bas 8, expnt(s) = [13.01922363]
bas 9, expnt(s) = [0.59964257]
CPU time:       456.49
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.73274068e+03 9.54913078e+02 1.13193436e+02 8.76760460e+01
 4.52846127e+02 2.48015040e+02 5.12857614e-01 1.53113199e+00
 3.37984122e+01 3.54150002e+01 1.06367384e+01 1.48806322e+01
 1.74037243e+00 3.82821808e+00 2.75579171e+00 1.03583929e+01
 1.30192236e+01 7.21465804e+01 5.99642573e-01 1.53939463e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967048123100742
cond(S) = 72.03636518610749
E1 = -183.23067857114782  E_coul = 55.00821460359378
init E= -128.222463967554
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74267001507202  LUMO = 2.27783027056778
  mo_energy =
[-3.25544345e+01 -1.85664291e+00 -7.42670015e-01 -7.42670015e-01
 -7.42670015e-01  2.27783027e+00  2.64727289e+00  2.64727289e+00
  2.64727289e+00  1.95634395e+01  1.95634395e+01  1.95634395e+01
  3.05556430e+01  1.81144312e+02  8.64567306e+02  5.07779053e+03]
E1 = -182.18980649543596  E_coul = 53.91062825464606
cycle= 1 E= -128.27917824079  delta_E= -0.0567  |g|= 0.166  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269101
diis-c [-0.0724151  1.       ]
  HOMO = -0.809686029562037  LUMO = 2.23391682423979
  mo_energy =
[-3.28319802e+01 -1.92463634e+00 -8.09686030e-01 -8.09686030e-01
 -8.09686030e-01  2.23391682e+00  2.59154143e+00  2.59154143e+00
  2.59154143e+00  1.93707874e+01  1.93707874e+01  1.93707874e+01
  3.03452556e+01  1.80852617e+02  8.64227587e+02  5.07740924e+03]
E1 = -182.66235433869284  E_coul = 54.38149220163407
cycle= 2 E= -128.280862137059  delta_E= -0.00168  |g|= 0.0639  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10549
diis-c [-2.25742736e-04  2.79860913e-01  7.20139087e-01]
  HOMO = -0.786439188813302  LUMO = 2.25142790676969
  mo_energy =
[-3.27559434e+01 -1.90058362e+00 -7.86439189e-01 -7.86439189e-01
 -7.86439189e-01  2.25142791e+00  2.61248146e+00  2.61248146e+00
  2.61248146e+00  1.94274534e+01  1.94274534e+01  1.94274534e+01
  3.04059330e+01  1.80931399e+02  8.64313875e+02  5.07749913e+03]
E1 = -182.52704801600208  E_coul = 54.245867878146775
cycle= 3 E= -128.281180137855  delta_E= -0.000318  |g|= 0.00053  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00076834
diis-c [-2.11247136e-08 -3.81049610e-03 -2.59183490e-03  1.00640233e+00]
  HOMO = -0.786642291659273  LUMO = 2.25128853861629
  mo_energy =
[-3.27564615e+01 -1.90080360e+00 -7.86642292e-01 -7.86642292e-01
 -7.86642292e-01  2.25128854e+00  2.61233615e+00  2.61233615e+00
  2.61233615e+00  1.94270441e+01  1.94270441e+01  1.94270441e+01
  3.04054704e+01  1.80930964e+02  8.64313561e+02  5.07749890e+03]
E1 = -182.52805942396432  E_coul = 54.24687926845567
cycle= 4 E= -128.281180155509  delta_E= -1.77e-08  |g|= 1.44e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.46892e-05
diis-c [-5.29398303e-11  1.49738469e-04 -2.52664746e-04 -5.91711831e-02
  1.05927411e+00]
  HOMO = -0.786637527140222  LUMO = 2.25129008610138
  mo_energy =
[-3.27564491e+01 -1.90080105e+00 -7.86637527e-01 -7.86637527e-01
 -7.86637527e-01  2.25129009e+00  2.61234010e+00  2.61234010e+00
  2.61234010e+00  1.94270539e+01  1.94270539e+01  1.94270539e+01
  3.04054795e+01  1.80930979e+02  8.64313581e+02  5.07749892e+03]
E1 = -182.52803856807083  E_coul = 54.24685841254418
cycle= 5 E= -128.281180155527  delta_E= -1.8e-11  |g|= 1.18e-06  |ddm|= 4.74e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52803856807083  E_coul = 54.24685841254418
  HOMO = -0.786637195383124  LUMO = 2.251290113859
  mo_energy =
[-3.27564483e+01 -1.90080100e+00 -7.86637195e-01 -7.86637195e-01
 -7.86637195e-01  2.25129011e+00  2.61234040e+00  2.61234040e+00
  2.61234040e+00  1.94270546e+01  1.94270546e+01  1.94270546e+01
  3.04054801e+01  1.80930980e+02  8.64313582e+02  5.07749892e+03]
E1 = -182.5280372565817  E_coul = 54.246857101054964
Extra cycle  E= -128.281180155527  delta_E= -1.14e-13  |g|= 2.92e-07  |ddm|= 6.32e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [2.73274068e+03 1.13193436e+02 4.52846127e+02 5.12857614e-01
 3.37984122e+01 1.06367384e+01 1.74037243e+00 2.75579171e+00
 1.30192236e+01 5.99642573e-01]
E = -128.28118015552676
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2732.74068399        1
[INPUT] 0    0    [1    /1   ]  113.193435702        1
[INPUT] 0    0    [1    /1   ]  452.846126575        1
[INPUT] 0    0    [1    /1   ]  0.512857613571       1
[INPUT] 0    0    [1    /1   ]  33.798412233         1
[INPUT] 0    0    [1    /1   ]  10.6367383817        1
[INPUT] 0    0    [1    /1   ]  1.74037242774        1
[INPUT] 1    0    [1    /1   ]  2.75579170647        1
[INPUT] 1    0    [1    /1   ]  13.0192236328        1
[INPUT] 1    0    [1    /1   ]  0.599642573334       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2732.7406839925475, 1.0]], [0, [113.1934357016341, 1.0]], [0, [452.8461265753763, 1.0]], [0, [0.5128576135709002, 1.0]], [0, [33.79841223297777, 1.0]], [0, [10.636738381738148, 1.0]], [0, [1.740372427743367, 1.0]], [1, [2.7557917064739237, 1.0]], [1, [13.01922363276003, 1.0]], [1, [0.5996425733341656, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2732.74068399]
bas 1, expnt(s) = [113.1934357]
bas 2, expnt(s) = [452.84612658]
bas 3, expnt(s) = [0.51285761]
bas 4, expnt(s) = [33.79841223]
bas 5, expnt(s) = [10.63673838]
bas 6, expnt(s) = [1.74037243]
bas 7, expnt(s) = [2.75579171]
bas 8, expnt(s) = [13.01922363]
bas 9, expnt(s) = [0.59964257]
CPU time:       458.07
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.73274068e+03 9.54913078e+02 1.13193436e+02 8.76760460e+01
 4.52846127e+02 2.48015040e+02 5.12857614e-01 1.53113199e+00
 3.37984122e+01 3.54150002e+01 1.06367384e+01 1.48806322e+01
 1.74037243e+00 3.82821808e+00 2.75579171e+00 1.03583929e+01
 1.30192236e+01 7.21465804e+01 5.99642573e-01 1.53939463e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967048123100742
cond(S) = 72.03636518610749
E1 = -183.23067857114782  E_coul = 55.00821460359378
init E= -128.222463967554
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74267001507202  LUMO = 2.27783027056778
  mo_energy =
[-3.25544345e+01 -1.85664291e+00 -7.42670015e-01 -7.42670015e-01
 -7.42670015e-01  2.27783027e+00  2.64727289e+00  2.64727289e+00
  2.64727289e+00  1.95634395e+01  1.95634395e+01  1.95634395e+01
  3.05556430e+01  1.81144312e+02  8.64567306e+02  5.07779053e+03]
E1 = -182.18980649543596  E_coul = 53.91062825464606
cycle= 1 E= -128.27917824079  delta_E= -0.0567  |g|= 0.166  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.269101
diis-c [-0.0724151  1.       ]
  HOMO = -0.809686029562037  LUMO = 2.23391682423979
  mo_energy =
[-3.28319802e+01 -1.92463634e+00 -8.09686030e-01 -8.09686030e-01
 -8.09686030e-01  2.23391682e+00  2.59154143e+00  2.59154143e+00
  2.59154143e+00  1.93707874e+01  1.93707874e+01  1.93707874e+01
  3.03452556e+01  1.80852617e+02  8.64227587e+02  5.07740924e+03]
E1 = -182.66235433869284  E_coul = 54.38149220163407
cycle= 2 E= -128.280862137059  delta_E= -0.00168  |g|= 0.0639  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10549
diis-c [-2.25742736e-04  2.79860913e-01  7.20139087e-01]
  HOMO = -0.786439188813302  LUMO = 2.25142790676969
  mo_energy =
[-3.27559434e+01 -1.90058362e+00 -7.86439189e-01 -7.86439189e-01
 -7.86439189e-01  2.25142791e+00  2.61248146e+00  2.61248146e+00
  2.61248146e+00  1.94274534e+01  1.94274534e+01  1.94274534e+01
  3.04059330e+01  1.80931399e+02  8.64313875e+02  5.07749913e+03]
E1 = -182.52704801600208  E_coul = 54.245867878146775
cycle= 3 E= -128.281180137855  delta_E= -0.000318  |g|= 0.00053  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00076834
diis-c [-2.11247136e-08 -3.81049610e-03 -2.59183490e-03  1.00640233e+00]
  HOMO = -0.786642291659273  LUMO = 2.25128853861629
  mo_energy =
[-3.27564615e+01 -1.90080360e+00 -7.86642292e-01 -7.86642292e-01
 -7.86642292e-01  2.25128854e+00  2.61233615e+00  2.61233615e+00
  2.61233615e+00  1.94270441e+01  1.94270441e+01  1.94270441e+01
  3.04054704e+01  1.80930964e+02  8.64313561e+02  5.07749890e+03]
E1 = -182.52805942396432  E_coul = 54.24687926845567
cycle= 4 E= -128.281180155509  delta_E= -1.77e-08  |g|= 1.44e-05  |ddm|= 0.000149
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.46892e-05
diis-c [-5.29398303e-11  1.49738469e-04 -2.52664746e-04 -5.91711831e-02
  1.05927411e+00]
  HOMO = -0.786637527140222  LUMO = 2.25129008610138
  mo_energy =
[-3.27564491e+01 -1.90080105e+00 -7.86637527e-01 -7.86637527e-01
 -7.86637527e-01  2.25129009e+00  2.61234010e+00  2.61234010e+00
  2.61234010e+00  1.94270539e+01  1.94270539e+01  1.94270539e+01
  3.04054795e+01  1.80930979e+02  8.64313581e+02  5.07749892e+03]
E1 = -182.52803856807083  E_coul = 54.24685841254418
cycle= 5 E= -128.281180155527  delta_E= -1.8e-11  |g|= 1.18e-06  |ddm|= 4.74e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.52803856807083  E_coul = 54.24685841254418
  HOMO = -0.786637195383124  LUMO = 2.251290113859
  mo_energy =
[-3.27564483e+01 -1.90080100e+00 -7.86637195e-01 -7.86637195e-01
 -7.86637195e-01  2.25129011e+00  2.61234040e+00  2.61234040e+00
  2.61234040e+00  1.94270546e+01  1.94270546e+01  1.94270546e+01
  3.04054801e+01  1.80930980e+02  8.64313582e+02  5.07749892e+03]
E1 = -182.5280372565817  E_coul = 54.246857101054964
Extra cycle  E= -128.281180155527  delta_E= -1.14e-13  |g|= 2.92e-07  |ddm|= 6.32e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 72.03636518610749
E1 = -182.5280372565817  E_coul = 54.246857101054964
init E= -128.281180155527
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786637271504238  LUMO = 2.25129001325545
  mo_energy =
[-3.27564486e+01 -1.90080114e+00 -7.86637272e-01 -7.86637272e-01
 -7.86637272e-01  2.25129001e+00  2.61234033e+00  2.61234033e+00
  2.61234033e+00  1.94270543e+01  1.94270543e+01  1.94270543e+01
  3.04054798e+01  1.80930979e+02  8.64313582e+02  5.07749892e+03]
E1 = -182.5280378120123  E_coul = 54.24685765648558
cycle= 1 E= -128.281180155527  delta_E= 5.68e-14  |g|= 8.16e-08  |ddm|= 1.68e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5280378120123  E_coul = 54.24685765648558
  HOMO = -0.786637230840741  LUMO = 2.25129003579579
  mo_energy =
[-3.27564485e+01 -1.90080110e+00 -7.86637231e-01 -7.86637231e-01
 -7.86637231e-01  2.25129004e+00  2.61234036e+00  2.61234036e+00
  2.61234036e+00  1.94270544e+01  1.94270544e+01  1.94270544e+01
  3.04054799e+01  1.80930979e+02  8.64313582e+02  5.07749892e+03]
E1 = -182.52803759657465  E_coul = 54.246857441047815
Extra cycle  E= -128.281180155527  delta_E= -1.42e-13  |g|= 3.09e-08  |ddm|= 3.05e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.73274068e+03 1.13193436e+02 4.52846127e+02 5.12857614e-01
 3.37984122e+01 1.06367384e+01 1.74037243e+00 2.75579171e+00
 1.30192236e+01 5.99642573e-01]
grad_E = [-5.59498511e-06 -2.53531045e-04 -1.01612863e-05 -4.54805821e-04
  2.03134438e-03 -3.74871422e-03 -1.36468234e-03  8.28689981e-03
 -2.72738438e-03  1.23293998e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2953.07094205        1
[INPUT] 0    0    [1    /1   ]  117.153623799        1
[INPUT] 0    0    [1    /1   ]  476.662911701        1
[INPUT] 0    0    [1    /1   ]  0.514138618368       1
[INPUT] 0    0    [1    /1   ]  34.6284731994        1
[INPUT] 0    0    [1    /1   ]  10.7905466857        1
[INPUT] 0    0    [1    /1   ]  1.74265112072        1
[INPUT] 1    0    [1    /1   ]  2.75501202585        1
[INPUT] 1    0    [1    /1   ]  13.0023351834        1
[INPUT] 1    0    [1    /1   ]  0.599721001329       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2953.0709420492885, 1.0]], [0, [117.15362379877058, 1.0]], [0, [476.6629117006237, 1.0]], [0, [0.5141386183678708, 1.0]], [0, [34.62847319938129, 1.0]], [0, [10.790546685743333, 1.0]], [0, [1.7426511207161017, 1.0]], [1, [2.7550120258465043, 1.0]], [1, [13.002335183426334, 1.0]], [1, [0.5997210013292927, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2953.07094205]
bas 1, expnt(s) = [117.1536238]
bas 2, expnt(s) = [476.6629117]
bas 3, expnt(s) = [0.51413862]
bas 4, expnt(s) = [34.6284732]
bas 5, expnt(s) = [10.79054669]
bas 6, expnt(s) = [1.74265112]
bas 7, expnt(s) = [2.75501203]
bas 8, expnt(s) = [13.00233518]
bas 9, expnt(s) = [0.599721]
CPU time:       461.37
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.95307094e+03 1.01209303e+03 1.17153624e+02 8.99667059e+01
 4.76662912e+02 2.57735087e+02 5.14138618e-01 1.53399941e+00
 3.46284732e+01 3.60653401e+01 1.07905467e+01 1.50417238e+01
 1.74265112e+00 3.83197672e+00 2.75501203e+00 1.03547297e+01
 1.30023352e+01 7.20296143e+01 5.99721001e-01 1.53964631e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967016619440084
cond(S) = 68.62855807873044
E1 = -183.23118260590158  E_coul = 55.00837407071443
init E= -128.222808535187
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.7426353907205  LUMO = 2.28720957198437
  mo_energy =
[-3.25549625e+01 -1.85666017e+00 -7.42635391e-01 -7.42635391e-01
 -7.42635391e-01  2.28720957e+00  2.64739722e+00  2.64739722e+00
  2.64739722e+00  1.95437691e+01  1.95437691e+01  1.95437691e+01
  3.12648522e+01  1.87229295e+02  9.05729004e+02  5.45012353e+03]
E1 = -182.19281129280665  E_coul = 53.91257201395718
cycle= 1 E= -128.280239278849  delta_E= -0.0574  |g|= 0.166  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.268525
diis-c [-0.07210582  1.        ]
  HOMO = -0.809530374566069  LUMO = 2.24309326800815
  mo_energy =
[-3.28320852e+01 -1.92455287e+00 -8.09530375e-01 -8.09530375e-01
 -8.09530375e-01  2.24309327e+00  2.59178554e+00  2.59178554e+00
  2.59178554e+00  1.93515125e+01  1.93515125e+01  1.93515125e+01
  3.10528667e+01  1.86936679e+02  9.05388734e+02  5.44974205e+03]
E1 = -182.66464546642953  E_coul = 54.38272697649215
cycle= 2 E= -128.281918489937  delta_E= -0.00168  |g|= 0.0638  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10523
diis-c [-2.29737503e-04  2.79752993e-01  7.20247007e-01]
  HOMO = -0.786314198149995  LUMO = 2.26065951465451
  mo_energy =
[-3.27561562e+01 -1.90053110e+00 -7.86314198e-01 -7.86314198e-01
 -7.86314198e-01  2.26065951e+00  2.61269570e+00  2.61269570e+00
  2.61269570e+00  1.94080712e+01  1.94080712e+01  1.94080712e+01
  3.11139103e+01  1.87015627e+02  9.05475062e+02  5.44983188e+03]
E1 = -182.5295493440484  E_coul = 54.24731385554669
cycle= 3 E= -128.282235488502  delta_E= -0.000317  |g|= 0.000534  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000774521
diis-c [-2.15217372e-08 -3.71416303e-03 -2.26728297e-03  1.00598145e+00]
  HOMO = -0.786518697415394  LUMO = 2.26051745144238
  mo_energy =
[-3.27566817e+01 -1.90075377e+00 -7.86518697e-01 -7.86518697e-01
 -7.86518697e-01  2.26051745e+00  2.61254891e+00  2.61254891e+00
  2.61254891e+00  1.94076567e+01  1.94076567e+01  1.94076567e+01
  3.11134401e+01  1.87015187e+02  9.05474743e+02  5.44983164e+03]
E1 = -182.53057403444345  E_coul = 54.24833852781294
cycle= 4 E= -128.282235506631  delta_E= -1.81e-08  |g|= 1.52e-05  |ddm|= 0.000152
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.5883e-05
diis-c [-6.12449084e-11  1.55327713e-04 -2.77680732e-04 -6.24597112e-02
  1.06258206e+00]
  HOMO = -0.786513733928345  LUMO = 2.26051897725548
  mo_energy =
[-3.27566688e+01 -1.90075126e+00 -7.86513734e-01 -7.86513734e-01
 -7.86513734e-01  2.26051898e+00  2.61255305e+00  2.61255305e+00
  2.61255305e+00  1.94076668e+01  1.94076668e+01  1.94076668e+01
  3.11134496e+01  1.87015202e+02  9.05474764e+02  5.44983166e+03]
E1 = -182.53055247870975  E_coul = 54.24831697205836
cycle= 5 E= -128.282235506651  delta_E= -2.09e-11  |g|= 1.28e-06  |ddm|= 5.23e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53055247870975  E_coul = 54.24831697205836
  HOMO = -0.786513379109953  LUMO = 2.26051900388406
  mo_energy =
[-3.27566679e+01 -1.90075121e+00 -7.86513379e-01 -7.86513379e-01
 -7.86513379e-01  2.26051900e+00  2.61255336e+00  2.61255336e+00
  2.61255336e+00  1.94076675e+01  1.94076675e+01  1.94076675e+01
  3.11134502e+01  1.87015203e+02  9.05474766e+02  5.44983167e+03]
E1 = -182.5305510752591  E_coul = 54.24831556860767
Extra cycle  E= -128.282235506651  delta_E= -5.68e-14  |g|= 3.14e-07  |ddm|= 6.83e-07
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [2.95307094e+03 1.17153624e+02 4.76662912e+02 5.14138618e-01
 3.46284732e+01 1.07905467e+01 1.74265112e+00 2.75501203e+00
 1.30023352e+01 5.99721001e-01]
E = -128.28223550665143
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  2953.07094205        1
[INPUT] 0    0    [1    /1   ]  117.153623799        1
[INPUT] 0    0    [1    /1   ]  476.662911701        1
[INPUT] 0    0    [1    /1   ]  0.514138618368       1
[INPUT] 0    0    [1    /1   ]  34.6284731994        1
[INPUT] 0    0    [1    /1   ]  10.7905466857        1
[INPUT] 0    0    [1    /1   ]  1.74265112072        1
[INPUT] 1    0    [1    /1   ]  2.75501202585        1
[INPUT] 1    0    [1    /1   ]  13.0023351834        1
[INPUT] 1    0    [1    /1   ]  0.599721001329       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [2953.0709420492885, 1.0]], [0, [117.15362379877058, 1.0]], [0, [476.6629117006237, 1.0]], [0, [0.5141386183678708, 1.0]], [0, [34.62847319938129, 1.0]], [0, [10.790546685743333, 1.0]], [0, [1.7426511207161017, 1.0]], [1, [2.7550120258465043, 1.0]], [1, [13.002335183426334, 1.0]], [1, [0.5997210013292927, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [2953.07094205]
bas 1, expnt(s) = [117.1536238]
bas 2, expnt(s) = [476.6629117]
bas 3, expnt(s) = [0.51413862]
bas 4, expnt(s) = [34.6284732]
bas 5, expnt(s) = [10.79054669]
bas 6, expnt(s) = [1.74265112]
bas 7, expnt(s) = [2.75501203]
bas 8, expnt(s) = [13.00233518]
bas 9, expnt(s) = [0.599721]
CPU time:       462.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 2.95307094e+03 1.01209303e+03 1.17153624e+02 8.99667059e+01
 4.76662912e+02 2.57735087e+02 5.14138618e-01 1.53399941e+00
 3.46284732e+01 3.60653401e+01 1.07905467e+01 1.50417238e+01
 1.74265112e+00 3.83197672e+00 2.75501203e+00 1.03547297e+01
 1.30023352e+01 7.20296143e+01 5.99721001e-01 1.53964631e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.967016619440084
cond(S) = 68.62855807873044
E1 = -183.23118260590158  E_coul = 55.00837407071443
init E= -128.222808535187
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.7426353907205  LUMO = 2.28720957198437
  mo_energy =
[-3.25549625e+01 -1.85666017e+00 -7.42635391e-01 -7.42635391e-01
 -7.42635391e-01  2.28720957e+00  2.64739722e+00  2.64739722e+00
  2.64739722e+00  1.95437691e+01  1.95437691e+01  1.95437691e+01
  3.12648522e+01  1.87229295e+02  9.05729004e+02  5.45012353e+03]
E1 = -182.19281129280665  E_coul = 53.91257201395718
cycle= 1 E= -128.280239278849  delta_E= -0.0574  |g|= 0.166  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.268525
diis-c [-0.07210582  1.        ]
  HOMO = -0.809530374566069  LUMO = 2.24309326800815
  mo_energy =
[-3.28320852e+01 -1.92455287e+00 -8.09530375e-01 -8.09530375e-01
 -8.09530375e-01  2.24309327e+00  2.59178554e+00  2.59178554e+00
  2.59178554e+00  1.93515125e+01  1.93515125e+01  1.93515125e+01
  3.10528667e+01  1.86936679e+02  9.05388734e+02  5.44974205e+03]
E1 = -182.66464546642953  E_coul = 54.38272697649215
cycle= 2 E= -128.281918489937  delta_E= -0.00168  |g|= 0.0638  |ddm|= 0.0642
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10523
diis-c [-2.29737503e-04  2.79752993e-01  7.20247007e-01]
  HOMO = -0.786314198149995  LUMO = 2.26065951465451
  mo_energy =
[-3.27561562e+01 -1.90053110e+00 -7.86314198e-01 -7.86314198e-01
 -7.86314198e-01  2.26065951e+00  2.61269570e+00  2.61269570e+00
  2.61269570e+00  1.94080712e+01  1.94080712e+01  1.94080712e+01
  3.11139103e+01  1.87015627e+02  9.05475062e+02  5.44983188e+03]
E1 = -182.5295493440484  E_coul = 54.24731385554669
cycle= 3 E= -128.282235488502  delta_E= -0.000317  |g|= 0.000534  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000774521
diis-c [-2.15217372e-08 -3.71416303e-03 -2.26728297e-03  1.00598145e+00]
  HOMO = -0.786518697415394  LUMO = 2.26051745144238
  mo_energy =
[-3.27566817e+01 -1.90075377e+00 -7.86518697e-01 -7.86518697e-01
 -7.86518697e-01  2.26051745e+00  2.61254891e+00  2.61254891e+00
  2.61254891e+00  1.94076567e+01  1.94076567e+01  1.94076567e+01
  3.11134401e+01  1.87015187e+02  9.05474743e+02  5.44983164e+03]
E1 = -182.53057403444345  E_coul = 54.24833852781294
cycle= 4 E= -128.282235506631  delta_E= -1.81e-08  |g|= 1.52e-05  |ddm|= 0.000152
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=2.5883e-05
diis-c [-6.12449084e-11  1.55327713e-04 -2.77680732e-04 -6.24597112e-02
  1.06258206e+00]
  HOMO = -0.786513733928345  LUMO = 2.26051897725548
  mo_energy =
[-3.27566688e+01 -1.90075126e+00 -7.86513734e-01 -7.86513734e-01
 -7.86513734e-01  2.26051898e+00  2.61255305e+00  2.61255305e+00
  2.61255305e+00  1.94076668e+01  1.94076668e+01  1.94076668e+01
  3.11134496e+01  1.87015202e+02  9.05474764e+02  5.44983166e+03]
E1 = -182.53055247870975  E_coul = 54.24831697205836
cycle= 5 E= -128.282235506651  delta_E= -2.09e-11  |g|= 1.28e-06  |ddm|= 5.23e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53055247870975  E_coul = 54.24831697205836
  HOMO = -0.786513379109953  LUMO = 2.26051900388406
  mo_energy =
[-3.27566679e+01 -1.90075121e+00 -7.86513379e-01 -7.86513379e-01
 -7.86513379e-01  2.26051900e+00  2.61255336e+00  2.61255336e+00
  2.61255336e+00  1.94076675e+01  1.94076675e+01  1.94076675e+01
  3.11134502e+01  1.87015203e+02  9.05474766e+02  5.44983167e+03]
E1 = -182.5305510752591  E_coul = 54.24831556860767
Extra cycle  E= -128.282235506651  delta_E= -5.68e-14  |g|= 3.14e-07  |ddm|= 6.83e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 68.62855807873044
E1 = -182.5305510752591  E_coul = 54.24831556860767
init E= -128.282235506651
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786513460456524  LUMO = 2.2605188953676
  mo_energy =
[-3.27566682e+01 -1.90075135e+00 -7.86513460e-01 -7.86513460e-01
 -7.86513460e-01  2.26051890e+00  2.61255329e+00  2.61255329e+00
  2.61255329e+00  1.94076673e+01  1.94076673e+01  1.94076673e+01
  3.11134499e+01  1.87015203e+02  9.05474765e+02  5.44983167e+03]
E1 = -182.53055166935633  E_coul = 54.24831616270473
cycle= 1 E= -128.282235506652  delta_E= -1.71e-13  |g|= 8.75e-08  |ddm|= 1.82e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53055166935633  E_coul = 54.24831616270473
  HOMO = -0.78651341693917  LUMO = 2.26051891952227
  mo_energy =
[-3.27566681e+01 -1.90075132e+00 -7.86513417e-01 -7.86513417e-01
 -7.86513417e-01  2.26051892e+00  2.61255333e+00  2.61255333e+00
  2.61255333e+00  1.94076674e+01  1.94076674e+01  1.94076674e+01
  3.11134500e+01  1.87015203e+02  9.05474766e+02  5.44983167e+03]
E1 = -182.53055143894284  E_coul = 54.24831593229127
Extra cycle  E= -128.282235506652  delta_E= 2.84e-14  |g|= 3.31e-08  |ddm|= 3.28e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [2.95307094e+03 1.17153624e+02 4.76662912e+02 5.14138618e-01
 3.46284732e+01 1.07905467e+01 1.74265112e+00 2.75501203e+00
 1.30023352e+01 5.99721001e-01]
grad_E = [-3.35632867e-06 -2.80669274e-04 -9.17144062e-06 -3.18034302e-04
  2.23063290e-03 -4.05388138e-03 -1.49717666e-03  8.81094332e-03
 -2.90129324e-03  1.33573456e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3311.64218692        1
[INPUT] 0    0    [1    /1   ]  122.346872813        1
[INPUT] 0    0    [1    /1   ]  514.124189542        1
[INPUT] 0    0    [1    /1   ]  0.517105168999       1
[INPUT] 0    0    [1    /1   ]  35.3904087668        1
[INPUT] 0    0    [1    /1   ]  10.9266389071        1
[INPUT] 0    0    [1    /1   ]  1.75056024297        1
[INPUT] 1    0    [1    /1   ]  2.75783132514        1
[INPUT] 1    0    [1    /1   ]  13.0483034411        1
[INPUT] 1    0    [1    /1   ]  0.599742386885       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3311.6421869240144, 1.0]], [0, [122.34687281274913, 1.0]], [0, [514.124189541723, 1.0]], [0, [0.5171051689989595, 1.0]], [0, [35.39040876681552, 1.0]], [0, [10.926638907097637, 1.0]], [0, [1.7505602429688072, 1.0]], [1, [2.7578313251423987, 1.0]], [1, [13.048303441059996, 1.0]], [1, [0.5997423868851521, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3311.64218692]
bas 1, expnt(s) = [122.34687281]
bas 2, expnt(s) = [514.12418954]
bas 3, expnt(s) = [0.51710517]
bas 4, expnt(s) = [35.39040877]
bas 5, expnt(s) = [10.92663891]
bas 6, expnt(s) = [1.75056024]
bas 7, expnt(s) = [2.75783133]
bas 8, expnt(s) = [13.04830344]
bas 9, expnt(s) = [0.59974239]
CPU time:       466.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.31164219e+03 1.10292906e+03 1.22346873e+02 9.29415004e+01
 5.14124190e+02 2.72782216e+02 5.17105169e-01 1.54063296e+00
 3.53904088e+01 3.66588814e+01 1.09266389e+01 1.51837823e+01
 1.75056024e+00 3.84501307e+00 2.75783133e+00 1.03679768e+01
 1.30483034e+01 7.23480704e+01 5.99742387e-01 1.53971493e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966966809348499
cond(S) = 63.88254128985834
E1 = -183.2317097667195  E_coul = 55.00853933593768
init E= -128.223170430782
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74268477021375  LUMO = 2.30830699721324
  mo_energy =
[-3.25553876e+01 -1.85672386e+00 -7.42684770e-01 -7.42684770e-01
 -7.42684770e-01  2.30830700e+00  2.64831293e+00  2.64831293e+00
  2.64831293e+00  1.96002501e+01  1.96002501e+01  1.96002501e+01
  3.19625642e+01  1.94258568e+02  9.65508066e+02  6.04802412e+03]
E1 = -182.19561657974958  E_coul = 53.913923441182135
cycle= 1 E= -128.281693138567  delta_E= -0.0585  |g|= 0.166  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.267764
diis-c [-0.07169768  1.        ]
  HOMO = -0.809470735245977  LUMO = 2.26370044023956
  mo_energy =
[-3.28322605e+01 -1.92460487e+00 -8.09470735e-01 -8.09470735e-01
 -8.09470735e-01  2.26370044e+00  2.59276613e+00  2.59276613e+00
  2.59276613e+00  1.94079261e+01  1.94079261e+01  1.94079261e+01
  3.17490013e+01  1.93964674e+02  9.65166395e+02  6.04764170e+03]
E1 = -182.66687503460855  E_coul = 54.38350577601584
cycle= 2 E= -128.283369258593  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104951
diis-c [-2.35634053e-04  2.79733425e-01  7.20266575e-01]
  HOMO = -0.786283564362187  LUMO = 2.28138533485377
  mo_energy =
[-3.27564169e+01 -1.90061291e+00 -7.86283564e-01 -7.86283564e-01
 -7.86283564e-01  2.28138533e+00  2.61366247e+00  2.61366247e+00
  2.61366247e+00  1.94644924e+01  1.94644924e+01  1.94644924e+01
  3.18103868e+01  1.94043861e+02  9.65252880e+02  6.04773157e+03]
E1 = -182.5319881771536  E_coul = 54.24830274748551
cycle= 3 E= -128.283685429668  delta_E= -0.000316  |g|= 0.000536  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000761423
diis-c [-2.59667036e-08 -3.71633870e-03 -2.41437652e-03  1.00613072e+00]
  HOMO = -0.78648516745852  LUMO = 2.28124013804373
  mo_energy =
[-3.27569386e+01 -1.90083794e+00 -7.86485167e-01 -7.86485167e-01
 -7.86485167e-01  2.28124014e+00  2.61351799e+00  2.61351799e+00
  2.61351799e+00  1.94640810e+01  1.94640810e+01  1.94640810e+01
  3.18099166e+01  1.94043431e+02  9.65252580e+02  6.04773135e+03]
E1 = -182.53300883191886  E_coul = 54.24932338411873
cycle= 4 E= -128.2836854478  delta_E= -1.81e-08  |g|= 1.89e-05  |ddm|= 0.000158
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.17457e-05
diis-c [-1.01284085e-10  1.91128956e-04 -3.21044848e-04 -7.56029118e-02
  1.07573283e+00]
  HOMO = -0.786479160430094  LUMO = 2.28124167015565
  mo_energy =
[-3.27569232e+01 -1.90083536e+00 -7.86479160e-01 -7.86479160e-01
 -7.86479160e-01  2.28124167e+00  2.61352304e+00  2.61352304e+00
  2.61352304e+00  1.94640931e+01  1.94640931e+01  1.94640931e+01
  3.18099279e+01  1.94043450e+02  9.65252606e+02  6.04773138e+03]
E1 = -182.53298332006128  E_coul = 54.24929787222618
cycle= 5 E= -128.283685447835  delta_E= -3.5e-11  |g|= 1.6e-06  |ddm|= 7.33e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53298332006128  E_coul = 54.24929787222618
  HOMO = -0.78647874426641  LUMO = 2.28124167745114
  mo_energy =
[-3.27569222e+01 -1.90083533e+00 -7.86478744e-01 -7.86478744e-01
 -7.86478744e-01  2.28124168e+00  2.61352342e+00  2.61352342e+00
  2.61352342e+00  1.94640938e+01  1.94640938e+01  1.94640938e+01
  3.18099287e+01  1.94043451e+02  9.65252607e+02  6.04773138e+03]
E1 = -182.53298170436724  E_coul = 54.249296256531764
Extra cycle  E= -128.283685447835  delta_E= -3.69e-13  |g|= 3.84e-07  |ddm|= 8.72e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.31164219e+03 1.22346873e+02 5.14124190e+02 5.17105169e-01
 3.53904088e+01 1.09266389e+01 1.75056024e+00 2.75783133e+00
 1.30483034e+01 5.99742387e-01]
E = -128.28368544783547
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3311.64218692        1
[INPUT] 0    0    [1    /1   ]  122.346872813        1
[INPUT] 0    0    [1    /1   ]  514.124189542        1
[INPUT] 0    0    [1    /1   ]  0.517105168999       1
[INPUT] 0    0    [1    /1   ]  35.3904087668        1
[INPUT] 0    0    [1    /1   ]  10.9266389071        1
[INPUT] 0    0    [1    /1   ]  1.75056024297        1
[INPUT] 1    0    [1    /1   ]  2.75783132514        1
[INPUT] 1    0    [1    /1   ]  13.0483034411        1
[INPUT] 1    0    [1    /1   ]  0.599742386885       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3311.6421869240144, 1.0]], [0, [122.34687281274913, 1.0]], [0, [514.124189541723, 1.0]], [0, [0.5171051689989595, 1.0]], [0, [35.39040876681552, 1.0]], [0, [10.926638907097637, 1.0]], [0, [1.7505602429688072, 1.0]], [1, [2.7578313251423987, 1.0]], [1, [13.048303441059996, 1.0]], [1, [0.5997423868851521, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3311.64218692]
bas 1, expnt(s) = [122.34687281]
bas 2, expnt(s) = [514.12418954]
bas 3, expnt(s) = [0.51710517]
bas 4, expnt(s) = [35.39040877]
bas 5, expnt(s) = [10.92663891]
bas 6, expnt(s) = [1.75056024]
bas 7, expnt(s) = [2.75783133]
bas 8, expnt(s) = [13.04830344]
bas 9, expnt(s) = [0.59974239]
CPU time:       467.96
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.31164219e+03 1.10292906e+03 1.22346873e+02 9.29415004e+01
 5.14124190e+02 2.72782216e+02 5.17105169e-01 1.54063296e+00
 3.53904088e+01 3.66588814e+01 1.09266389e+01 1.51837823e+01
 1.75056024e+00 3.84501307e+00 2.75783133e+00 1.03679768e+01
 1.30483034e+01 7.23480704e+01 5.99742387e-01 1.53971493e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966966809348499
cond(S) = 63.88254128985834
E1 = -183.2317097667195  E_coul = 55.00853933593768
init E= -128.223170430782
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74268477021375  LUMO = 2.30830699721324
  mo_energy =
[-3.25553876e+01 -1.85672386e+00 -7.42684770e-01 -7.42684770e-01
 -7.42684770e-01  2.30830700e+00  2.64831293e+00  2.64831293e+00
  2.64831293e+00  1.96002501e+01  1.96002501e+01  1.96002501e+01
  3.19625642e+01  1.94258568e+02  9.65508066e+02  6.04802412e+03]
E1 = -182.19561657974958  E_coul = 53.913923441182135
cycle= 1 E= -128.281693138567  delta_E= -0.0585  |g|= 0.166  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.267764
diis-c [-0.07169768  1.        ]
  HOMO = -0.809470735245977  LUMO = 2.26370044023956
  mo_energy =
[-3.28322605e+01 -1.92460487e+00 -8.09470735e-01 -8.09470735e-01
 -8.09470735e-01  2.26370044e+00  2.59276613e+00  2.59276613e+00
  2.59276613e+00  1.94079261e+01  1.94079261e+01  1.94079261e+01
  3.17490013e+01  1.93964674e+02  9.65166395e+02  6.04764170e+03]
E1 = -182.66687503460855  E_coul = 54.38350577601584
cycle= 2 E= -128.283369258593  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0643
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104951
diis-c [-2.35634053e-04  2.79733425e-01  7.20266575e-01]
  HOMO = -0.786283564362187  LUMO = 2.28138533485377
  mo_energy =
[-3.27564169e+01 -1.90061291e+00 -7.86283564e-01 -7.86283564e-01
 -7.86283564e-01  2.28138533e+00  2.61366247e+00  2.61366247e+00
  2.61366247e+00  1.94644924e+01  1.94644924e+01  1.94644924e+01
  3.18103868e+01  1.94043861e+02  9.65252880e+02  6.04773157e+03]
E1 = -182.5319881771536  E_coul = 54.24830274748551
cycle= 3 E= -128.283685429668  delta_E= -0.000316  |g|= 0.000536  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000761423
diis-c [-2.59667036e-08 -3.71633870e-03 -2.41437652e-03  1.00613072e+00]
  HOMO = -0.78648516745852  LUMO = 2.28124013804373
  mo_energy =
[-3.27569386e+01 -1.90083794e+00 -7.86485167e-01 -7.86485167e-01
 -7.86485167e-01  2.28124014e+00  2.61351799e+00  2.61351799e+00
  2.61351799e+00  1.94640810e+01  1.94640810e+01  1.94640810e+01
  3.18099166e+01  1.94043431e+02  9.65252580e+02  6.04773135e+03]
E1 = -182.53300883191886  E_coul = 54.24932338411873
cycle= 4 E= -128.2836854478  delta_E= -1.81e-08  |g|= 1.89e-05  |ddm|= 0.000158
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=3.17457e-05
diis-c [-1.01284085e-10  1.91128956e-04 -3.21044848e-04 -7.56029118e-02
  1.07573283e+00]
  HOMO = -0.786479160430094  LUMO = 2.28124167015565
  mo_energy =
[-3.27569232e+01 -1.90083536e+00 -7.86479160e-01 -7.86479160e-01
 -7.86479160e-01  2.28124167e+00  2.61352304e+00  2.61352304e+00
  2.61352304e+00  1.94640931e+01  1.94640931e+01  1.94640931e+01
  3.18099279e+01  1.94043450e+02  9.65252606e+02  6.04773138e+03]
E1 = -182.53298332006128  E_coul = 54.24929787222618
cycle= 5 E= -128.283685447835  delta_E= -3.5e-11  |g|= 1.6e-06  |ddm|= 7.33e-06
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53298332006128  E_coul = 54.24929787222618
  HOMO = -0.78647874426641  LUMO = 2.28124167745114
  mo_energy =
[-3.27569222e+01 -1.90083533e+00 -7.86478744e-01 -7.86478744e-01
 -7.86478744e-01  2.28124168e+00  2.61352342e+00  2.61352342e+00
  2.61352342e+00  1.94640938e+01  1.94640938e+01  1.94640938e+01
  3.18099287e+01  1.94043451e+02  9.65252607e+02  6.04773138e+03]
E1 = -182.53298170436724  E_coul = 54.249296256531764
Extra cycle  E= -128.283685447835  delta_E= -3.69e-13  |g|= 3.84e-07  |ddm|= 8.72e-07
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 63.88254128985834
E1 = -182.53298170436724  E_coul = 54.249296256531764
init E= -128.283685447835
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786478836279803  LUMO = 2.28124154715346
  mo_energy =
[-3.27569226e+01 -1.90083550e+00 -7.86478836e-01 -7.86478836e-01
 -7.86478836e-01  2.28124155e+00  2.61352333e+00  2.61352333e+00
  2.61352333e+00  1.94640936e+01  1.94640936e+01  1.94640936e+01
  3.18099284e+01  1.94043451e+02  9.65252607e+02  6.04773138e+03]
E1 = -182.53298239028817  E_coul = 54.24929694245277
cycle= 1 E= -128.283685447835  delta_E= 5.68e-14  |g|= 1.03e-07  |ddm|= 2.24e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53298239028817  E_coul = 54.24929694245277
  HOMO = -0.786478785743374  LUMO = 2.28124157450299
  mo_energy =
[-3.27569224e+01 -1.90083546e+00 -7.86478786e-01 -7.86478786e-01
 -7.86478786e-01  2.28124157e+00  2.61352338e+00  2.61352338e+00
  2.61352338e+00  1.94640937e+01  1.94640937e+01  1.94640937e+01
  3.18099285e+01  1.94043451e+02  9.65252607e+02  6.04773138e+03]
E1 = -182.53298212479373  E_coul = 54.24929667695828
Extra cycle  E= -128.283685447835  delta_E= -5.68e-14  |g|= 3.84e-08  |ddm|= 3.91e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.31164219e+03 1.22346873e+02 5.14124190e+02 5.17105169e-01
 3.53904088e+01 1.09266389e+01 1.75056024e+00 2.75783133e+00
 1.30483034e+01 5.99742387e-01]
grad_E = [-1.05386473e-06 -2.51194680e-04 -5.93048375e-06  2.96893815e-04
  1.97615044e-03 -3.57508663e-03 -1.39706814e-03  7.45093220e-03
 -2.46152908e-03  1.15352264e-02]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:35 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3641.75309239        1
[INPUT] 0    0    [1    /1   ]  125.921679061        1
[INPUT] 0    0    [1    /1   ]  547.106139513        1
[INPUT] 0    0    [1    /1   ]  0.520291967115       1
[INPUT] 0    0    [1    /1   ]  35.5417235673        1
[INPUT] 0    0    [1    /1   ]  10.9506546262        1
[INPUT] 0    0    [1    /1   ]  1.76133128172        1
[INPUT] 1    0    [1    /1   ]  2.76413512253        1
[INPUT] 1    0    [1    /1   ]  13.1564519158        1
[INPUT] 1    0    [1    /1   ]  0.599669900369       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3641.753092392776, 1.0]], [0, [125.92167906119083, 1.0]], [0, [547.1061395126015, 1.0]], [0, [0.5202919671149672, 1.0]], [0, [35.54172356726315, 1.0]], [0, [10.950654626247246, 1.0]], [0, [1.7613312817199125, 1.0]], [1, [2.7641351225281388, 1.0]], [1, [13.156451915767695, 1.0]], [1, [0.5996699003686647, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3641.75309239]
bas 1, expnt(s) = [125.92167906]
bas 2, expnt(s) = [547.10613951]
bas 3, expnt(s) = [0.52029197]
bas 4, expnt(s) = [35.54172357]
bas 5, expnt(s) = [10.95065463]
bas 6, expnt(s) = [1.76133128]
bas 7, expnt(s) = [2.76413512]
bas 8, expnt(s) = [13.15645192]
bas 9, expnt(s) = [0.5996699]
CPU time:       471.31
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.64175309e+03 1.18439863e+03 1.25921679e+02 9.49708672e+01
 5.47106140e+02 2.85804272e+02 5.20291967e-01 1.54774840e+00
 3.55417236e+01 3.67763723e+01 1.09506546e+01 1.52088048e+01
 1.76133128e+00 3.86274297e+00 2.76413512e+00 1.03976089e+01
 1.31564519e+01 7.30984000e+01 5.99669900e-01 1.53948232e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966921089553555
cond(S) = 60.31489532300862
E1 = -183.23161124875455  E_coul = 55.008559212930706
init E= -128.223052035824
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742814846765975  LUMO = 2.33159657142427
  mo_energy =
[-3.25553899e+01 -1.85681662e+00 -7.42814847e-01 -7.42814847e-01
 -7.42814847e-01  2.33159657e+00  2.64985417e+00  2.64985417e+00
  2.64985417e+00  1.97320179e+01  1.97320179e+01  1.97320179e+01
  3.21721707e+01  1.97967775e+02  1.01334167e+03  6.59009236e+03]
E1 = -182.19562200959214  E_coul = 53.912942542529194
cycle= 1 E= -128.282679467063  delta_E= -0.0596  |g|= 0.166  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.267299
diis-c [-0.07144883  1.        ]
  HOMO = -0.809626097038472  LUMO = 2.2863827823504
  mo_energy =
[-3.28325226e+01 -1.92486209e+00 -8.09626097e-01 -8.09626097e-01
 -8.09626097e-01  2.28638278e+00  2.59421041e+00  2.59421041e+00
  2.59421041e+00  1.95389310e+01  1.95389310e+01  1.95389310e+01
  3.19579534e+01  1.97672780e+02  1.01299806e+03  6.58970832e+03]
E1 = -182.6670720328  E_coul = 54.38271385940563
cycle= 2 E= -128.284358173394  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104865
diis-c [-2.40627653e-04  2.79878120e-01  7.20121880e-01]
  HOMO = -0.786437926581016  LUMO = 2.30420482882663
  mo_energy =
[-3.27566482e+01 -1.90086960e+00 -7.86437927e-01 -7.86437927e-01
 -7.86437927e-01  2.30420483e+00  2.61513379e+00  2.61513379e+00
  2.61513379e+00  1.95956886e+01  1.95956886e+01  1.95956886e+01
  3.20194594e+01  1.97752200e+02  1.01308481e+03  6.58979838e+03]
E1 = -182.53220197825001  E_coul = 54.247527405613
cycle= 3 E= -128.284674572637  delta_E= -0.000316  |g|= 0.000533  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000729112
diis-c [-3.46358965e-08 -3.87247837e-03 -3.20068258e-03  1.00707316e+00]
  HOMO = -0.786631994937718  LUMO = 2.30405868779858
  mo_energy =
[-3.27571508e+01 -1.90109404e+00 -7.86631995e-01 -7.86631995e-01
 -7.86631995e-01  2.30405869e+00  2.61499595e+00  2.61499595e+00
  2.61499595e+00  1.95952913e+01  1.95952913e+01  1.95952913e+01
  3.20190018e+01  1.97751799e+02  1.01308455e+03  6.58979820e+03]
E1 = -182.53319286926842  E_coul = 54.24851827914646
cycle= 4 E= -128.284674590122  delta_E= -1.75e-08  |g|= 2.42e-05  |ddm|= 0.000164
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.0074e-05
diis-c [-1.63039813e-10  2.36566895e-04 -3.43582120e-04 -8.99608371e-02
  1.09006785e+00]
  HOMO = -0.786624467322393  LUMO = 2.30406030146518
  mo_energy =
[-3.27571317e+01 -1.90109125e+00 -7.86624467e-01 -7.86624467e-01
 -7.86624467e-01  2.30406030e+00  2.61500233e+00  2.61500233e+00
  2.61500233e+00  1.95953064e+01  1.95953064e+01  1.95953064e+01
  3.20190158e+01  1.97751823e+02  1.01308458e+03  6.58979824e+03]
E1 = -182.5331613952915  E_coul = 54.248486805108854
cycle= 5 E= -128.284674590183  delta_E= -6.07e-11  |g|= 1.95e-06  |ddm|= 1.02e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5331613952915  E_coul = 54.248486805108854
  HOMO = -0.786624004026657  LUMO = 2.30406027413834
  mo_energy =
[-3.27571306e+01 -1.90109126e+00 -7.86624004e-01 -7.86624004e-01
 -7.86624004e-01  2.30406027e+00  2.61500274e+00  2.61500274e+00
  2.61500274e+00  1.95953072e+01  1.95953072e+01  1.95953072e+01
  3.20190166e+01  1.97751824e+02  1.01308459e+03  6.58979824e+03]
E1 = -182.53315964671737  E_coul = 54.2484850565343
Extra cycle  E= -128.284674590183  delta_E= -4.26e-13  |g|= 4.51e-07  |ddm|= 1.08e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.64175309e+03 1.25921679e+02 5.47106140e+02 5.20291967e-01
 3.55417236e+01 1.09506546e+01 1.76133128e+00 2.76413512e+00
 1.31564519e+01 5.99669900e-01]
E = -128.28467459018307
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3641.75309239        1
[INPUT] 0    0    [1    /1   ]  125.921679061        1
[INPUT] 0    0    [1    /1   ]  547.106139513        1
[INPUT] 0    0    [1    /1   ]  0.520291967115       1
[INPUT] 0    0    [1    /1   ]  35.5417235673        1
[INPUT] 0    0    [1    /1   ]  10.9506546262        1
[INPUT] 0    0    [1    /1   ]  1.76133128172        1
[INPUT] 1    0    [1    /1   ]  2.76413512253        1
[INPUT] 1    0    [1    /1   ]  13.1564519158        1
[INPUT] 1    0    [1    /1   ]  0.599669900369       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3641.753092392776, 1.0]], [0, [125.92167906119083, 1.0]], [0, [547.1061395126015, 1.0]], [0, [0.5202919671149672, 1.0]], [0, [35.54172356726315, 1.0]], [0, [10.950654626247246, 1.0]], [0, [1.7613312817199125, 1.0]], [1, [2.7641351225281388, 1.0]], [1, [13.156451915767695, 1.0]], [1, [0.5996699003686647, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3641.75309239]
bas 1, expnt(s) = [125.92167906]
bas 2, expnt(s) = [547.10613951]
bas 3, expnt(s) = [0.52029197]
bas 4, expnt(s) = [35.54172357]
bas 5, expnt(s) = [10.95065463]
bas 6, expnt(s) = [1.76133128]
bas 7, expnt(s) = [2.76413512]
bas 8, expnt(s) = [13.15645192]
bas 9, expnt(s) = [0.5996699]
CPU time:       472.96
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.64175309e+03 1.18439863e+03 1.25921679e+02 9.49708672e+01
 5.47106140e+02 2.85804272e+02 5.20291967e-01 1.54774840e+00
 3.55417236e+01 3.67763723e+01 1.09506546e+01 1.52088048e+01
 1.76133128e+00 3.86274297e+00 2.76413512e+00 1.03976089e+01
 1.31564519e+01 7.30984000e+01 5.99669900e-01 1.53948232e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966921089553555
cond(S) = 60.31489532300862
E1 = -183.23161124875455  E_coul = 55.008559212930706
init E= -128.223052035824
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742814846765975  LUMO = 2.33159657142427
  mo_energy =
[-3.25553899e+01 -1.85681662e+00 -7.42814847e-01 -7.42814847e-01
 -7.42814847e-01  2.33159657e+00  2.64985417e+00  2.64985417e+00
  2.64985417e+00  1.97320179e+01  1.97320179e+01  1.97320179e+01
  3.21721707e+01  1.97967775e+02  1.01334167e+03  6.59009236e+03]
E1 = -182.19562200959214  E_coul = 53.912942542529194
cycle= 1 E= -128.282679467063  delta_E= -0.0596  |g|= 0.166  |ddm|= 0.178
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.267299
diis-c [-0.07144883  1.        ]
  HOMO = -0.809626097038472  LUMO = 2.2863827823504
  mo_energy =
[-3.28325226e+01 -1.92486209e+00 -8.09626097e-01 -8.09626097e-01
 -8.09626097e-01  2.28638278e+00  2.59421041e+00  2.59421041e+00
  2.59421041e+00  1.95389310e+01  1.95389310e+01  1.95389310e+01
  3.19579534e+01  1.97672780e+02  1.01299806e+03  6.58970832e+03]
E1 = -182.6670720328  E_coul = 54.38271385940563
cycle= 2 E= -128.284358173394  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0644
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104865
diis-c [-2.40627653e-04  2.79878120e-01  7.20121880e-01]
  HOMO = -0.786437926581016  LUMO = 2.30420482882663
  mo_energy =
[-3.27566482e+01 -1.90086960e+00 -7.86437927e-01 -7.86437927e-01
 -7.86437927e-01  2.30420483e+00  2.61513379e+00  2.61513379e+00
  2.61513379e+00  1.95956886e+01  1.95956886e+01  1.95956886e+01
  3.20194594e+01  1.97752200e+02  1.01308481e+03  6.58979838e+03]
E1 = -182.53220197825001  E_coul = 54.247527405613
cycle= 3 E= -128.284674572637  delta_E= -0.000316  |g|= 0.000533  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000729112
diis-c [-3.46358965e-08 -3.87247837e-03 -3.20068258e-03  1.00707316e+00]
  HOMO = -0.786631994937718  LUMO = 2.30405868779858
  mo_energy =
[-3.27571508e+01 -1.90109404e+00 -7.86631995e-01 -7.86631995e-01
 -7.86631995e-01  2.30405869e+00  2.61499595e+00  2.61499595e+00
  2.61499595e+00  1.95952913e+01  1.95952913e+01  1.95952913e+01
  3.20190018e+01  1.97751799e+02  1.01308455e+03  6.58979820e+03]
E1 = -182.53319286926842  E_coul = 54.24851827914646
cycle= 4 E= -128.284674590122  delta_E= -1.75e-08  |g|= 2.42e-05  |ddm|= 0.000164
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.0074e-05
diis-c [-1.63039813e-10  2.36566895e-04 -3.43582120e-04 -8.99608371e-02
  1.09006785e+00]
  HOMO = -0.786624467322393  LUMO = 2.30406030146518
  mo_energy =
[-3.27571317e+01 -1.90109125e+00 -7.86624467e-01 -7.86624467e-01
 -7.86624467e-01  2.30406030e+00  2.61500233e+00  2.61500233e+00
  2.61500233e+00  1.95953064e+01  1.95953064e+01  1.95953064e+01
  3.20190158e+01  1.97751823e+02  1.01308458e+03  6.58979824e+03]
E1 = -182.5331613952915  E_coul = 54.248486805108854
cycle= 5 E= -128.284674590183  delta_E= -6.07e-11  |g|= 1.95e-06  |ddm|= 1.02e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5331613952915  E_coul = 54.248486805108854
  HOMO = -0.786624004026657  LUMO = 2.30406027413834
  mo_energy =
[-3.27571306e+01 -1.90109126e+00 -7.86624004e-01 -7.86624004e-01
 -7.86624004e-01  2.30406027e+00  2.61500274e+00  2.61500274e+00
  2.61500274e+00  1.95953072e+01  1.95953072e+01  1.95953072e+01
  3.20190166e+01  1.97751824e+02  1.01308459e+03  6.58979824e+03]
E1 = -182.53315964671737  E_coul = 54.2484850565343
Extra cycle  E= -128.284674590183  delta_E= -4.26e-13  |g|= 4.51e-07  |ddm|= 1.08e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 60.31489532300862
E1 = -182.53315964671737  E_coul = 54.2484850565343
init E= -128.284674590183
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786624101048081  LUMO = 2.30406012521673
  mo_energy =
[-3.27571310e+01 -1.90109145e+00 -7.86624101e-01 -7.86624101e-01
 -7.86624101e-01  2.30406013e+00  2.61500265e+00  2.61500265e+00
  2.61500265e+00  1.95953069e+01  1.95953069e+01  1.95953069e+01
  3.20190162e+01  1.97751823e+02  1.01308458e+03  6.58979824e+03]
E1 = -182.53316039227298  E_coul = 54.248485802089974
cycle= 1 E= -128.284674590183  delta_E= 8.53e-14  |g|= 1.16e-07  |ddm|= 2.66e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53316039227298  E_coul = 54.248485802089974
  HOMO = -0.786624045667647  LUMO = 2.30406015398104
  mo_energy =
[-3.27571308e+01 -1.90109141e+00 -7.86624046e-01 -7.86624046e-01
 -7.86624046e-01  2.30406015e+00  2.61500270e+00  2.61500270e+00
  2.61500270e+00  1.95953070e+01  1.95953070e+01  1.95953070e+01
  3.20190164e+01  1.97751824e+02  1.01308459e+03  6.58979824e+03]
E1 = -182.5331601044594  E_coul = 54.24848551427632
Extra cycle  E= -128.284674590183  delta_E= -8.53e-14  |g|= 4.22e-08  |ddm|= 4.48e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.64175309e+03 1.25921679e+02 5.47106140e+02 5.20291967e-01
 3.55417236e+01 1.09506546e+01 1.76133128e+00 2.76413512e+00
 1.31564519e+01 5.99669900e-01]
grad_E = [ 2.14023079e-07 -1.35032755e-04 -3.13209990e-06  6.56786582e-04
  1.06327013e-03 -2.02537065e-03 -9.21367894e-04  4.31634043e-03
 -1.43786095e-03  6.52054746e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:40 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3787.57435236        1
[INPUT] 0    0    [1    /1   ]  127.340150543        1
[INPUT] 0    0    [1    /1   ]  562.073850486        1
[INPUT] 0    0    [1    /1   ]  0.522443059033       1
[INPUT] 0    0    [1    /1   ]  35.4887874681        1
[INPUT] 0    0    [1    /1   ]  10.9550794563        1
[INPUT] 0    0    [1    /1   ]  1.77017400942        1
[INPUT] 1    0    [1    /1   ]  2.77122407108        1
[INPUT] 1    0    [1    /1   ]  13.2648544216        1
[INPUT] 1    0    [1    /1   ]  0.599816631859       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3787.5743523589354, 1.0]], [0, [127.34015054348693, 1.0]], [0, [562.0738504856222, 1.0]], [0, [0.5224430590326147, 1.0]], [0, [35.488787468093, 1.0]], [0, [10.955079456297762, 1.0]], [0, [1.7701740094237886, 1.0]], [1, [2.771224071075413, 1.0]], [1, [13.26485442164113, 1.0]], [1, [0.5998166318586261, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3787.57435236]
bas 1, expnt(s) = [127.34015054]
bas 2, expnt(s) = [562.07385049]
bas 3, expnt(s) = [0.52244306]
bas 4, expnt(s) = [35.48878747]
bas 5, expnt(s) = [10.95507946]
bas 6, expnt(s) = [1.77017401]
bas 7, expnt(s) = [2.77122407]
bas 8, expnt(s) = [13.26485442]
bas 9, expnt(s) = [0.59981663]
CPU time:       476.29
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.78757435e+03 1.21979233e+03 1.27340151e+02 9.57721073e+01
 5.62073850e+02 2.91648710e+02 5.22443059e-01 1.55254518e+00
 3.54887875e+01 3.67352834e+01 1.09550795e+01 1.52134136e+01
 1.77017401e+00 3.87727848e+00 2.77122407e+00 1.04309520e+01
 1.32648544e+01 7.38520411e+01 5.99816632e-01 1.53995320e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966837980502817
cond(S) = 59.007539647667286
E1 = -183.2310383130992  E_coul = 55.00862166767605
init E= -128.222416645423
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742922081651528  LUMO = 2.34889034429768
  mo_energy =
[-3.25550749e+01 -1.85689412e+00 -7.42922082e-01 -7.42922082e-01
 -7.42922082e-01  2.34889034e+00  2.65259328e+00  2.65259328e+00
  2.65259328e+00  1.98675995e+01  1.98675995e+01  1.98675995e+01
  3.22192952e+01  1.99150217e+02  1.03405049e+03  6.83060527e+03]
E1 = -182.19519060246347  E_coul = 53.912281367648326
cycle= 1 E= -128.282909234815  delta_E= -0.0605  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266963
diis-c [-0.07126937  1.        ]
  HOMO = -0.809752460312434  LUMO = 2.30324631959662
  mo_energy =
[-3.28324075e+01 -1.92504466e+00 -8.09752460e-01 -8.09752460e-01
 -8.09752460e-01  2.30324632e+00  2.59684227e+00  2.59684227e+00
  2.59684227e+00  1.96737927e+01  1.96737927e+01  1.96737927e+01
  3.20048897e+01  1.98854818e+02  1.03370589e+03  6.83022049e+03]
E1 = -182.66668533653805  E_coul = 54.38209549450142
cycle= 2 E= -128.284589842037  delta_E= -0.00168  |g|= 0.0638  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104797
diis-c [-2.43242404e-04  2.79977112e-01  7.20022888e-01]
  HOMO = -0.786569800952851  LUMO = 2.32116530780271
  mo_energy =
[-3.27565188e+01 -1.90105777e+00 -7.86569801e-01 -7.86569801e-01
 -7.86569801e-01  2.32116531e+00  2.61779349e+00  2.61779349e+00
  2.61779349e+00  1.97307269e+01  1.97307269e+01  1.97307269e+01
  3.20664020e+01  1.98934332e+02  1.03379278e+03  6.83031065e+03]
E1 = -182.53187331263183  E_coul = 54.24696704256519
cycle= 3 E= -128.284906270067  delta_E= -0.000316  |g|= 0.000531  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000704936
diis-c [-4.14688019e-08 -4.04461051e-03 -3.94826421e-03  1.00799287e+00]
  HOMO = -0.786757932200341  LUMO = 2.32101963015453
  mo_energy =
[-3.27570042e+01 -1.90128027e+00 -7.86757932e-01 -7.86757932e-01
 -7.86757932e-01  2.32101963e+00  2.61766090e+00  2.61766090e+00
  2.61766090e+00  1.97303423e+01  1.97303423e+01  1.97303423e+01
  3.20659562e+01  1.98933956e+02  1.03379256e+03  6.83031052e+03]
E1 = -182.5328366567399  E_coul = 54.247930369789415
cycle= 4 E= -128.284906286951  delta_E= -1.69e-08  |g|= 2.74e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.51983e-05
diis-c [-2.02566758e-10  2.58911536e-04 -3.38247608e-04 -9.53786084e-02
  1.09545794e+00]
  HOMO = -0.786749439186634  LUMO = 2.32102137220485
  mo_energy =
[-3.27569827e+01 -1.90127725e+00 -7.86749439e-01 -7.86749439e-01
 -7.86749439e-01  2.32102137e+00  2.61766812e+00  2.61766812e+00
  2.61766812e+00  1.97303593e+01  1.97303593e+01  1.97303593e+01
  3.20659719e+01  1.98933982e+02  1.03379260e+03  6.83031056e+03]
E1 = -182.53280123377846  E_coul = 54.24789494674913
cycle= 5 E= -128.284906287029  delta_E= -7.88e-11  |g|= 2.13e-06  |ddm|= 1.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53280123377846  E_coul = 54.24789494674913
  HOMO = -0.786748957947468  LUMO = 2.32102132111516
  mo_energy =
[-3.27569815e+01 -1.90127729e+00 -7.86748958e-01 -7.86748958e-01
 -7.86748958e-01  2.32102132e+00  2.61766855e+00  2.61766855e+00
  2.61766855e+00  1.97303602e+01  1.97303602e+01  1.97303602e+01
  3.20659727e+01  1.98933983e+02  1.03379260e+03  6.83031056e+03]
E1 = -182.532799448042  E_coul = 54.247893161012044
Extra cycle  E= -128.28490628703  delta_E= -6.25e-13  |g|= 4.85e-07  |ddm|= 1.19e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.78757435e+03 1.27340151e+02 5.62073850e+02 5.22443059e-01
 3.54887875e+01 1.09550795e+01 1.77017401e+00 2.77122407e+00
 1.32648544e+01 5.99816632e-01]
E = -128.28490628702997
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:41 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3787.57435236        1
[INPUT] 0    0    [1    /1   ]  127.340150543        1
[INPUT] 0    0    [1    /1   ]  562.073850486        1
[INPUT] 0    0    [1    /1   ]  0.522443059033       1
[INPUT] 0    0    [1    /1   ]  35.4887874681        1
[INPUT] 0    0    [1    /1   ]  10.9550794563        1
[INPUT] 0    0    [1    /1   ]  1.77017400942        1
[INPUT] 1    0    [1    /1   ]  2.77122407108        1
[INPUT] 1    0    [1    /1   ]  13.2648544216        1
[INPUT] 1    0    [1    /1   ]  0.599816631859       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3787.5743523589354, 1.0]], [0, [127.34015054348693, 1.0]], [0, [562.0738504856222, 1.0]], [0, [0.5224430590326147, 1.0]], [0, [35.488787468093, 1.0]], [0, [10.955079456297762, 1.0]], [0, [1.7701740094237886, 1.0]], [1, [2.771224071075413, 1.0]], [1, [13.26485442164113, 1.0]], [1, [0.5998166318586261, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3787.57435236]
bas 1, expnt(s) = [127.34015054]
bas 2, expnt(s) = [562.07385049]
bas 3, expnt(s) = [0.52244306]
bas 4, expnt(s) = [35.48878747]
bas 5, expnt(s) = [10.95507946]
bas 6, expnt(s) = [1.77017401]
bas 7, expnt(s) = [2.77122407]
bas 8, expnt(s) = [13.26485442]
bas 9, expnt(s) = [0.59981663]
CPU time:       477.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.78757435e+03 1.21979233e+03 1.27340151e+02 9.57721073e+01
 5.62073850e+02 2.91648710e+02 5.22443059e-01 1.55254518e+00
 3.54887875e+01 3.67352834e+01 1.09550795e+01 1.52134136e+01
 1.77017401e+00 3.87727848e+00 2.77122407e+00 1.04309520e+01
 1.32648544e+01 7.38520411e+01 5.99816632e-01 1.53995320e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966837980502817
cond(S) = 59.007539647667286
E1 = -183.2310383130992  E_coul = 55.00862166767605
init E= -128.222416645423
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742922081651528  LUMO = 2.34889034429768
  mo_energy =
[-3.25550749e+01 -1.85689412e+00 -7.42922082e-01 -7.42922082e-01
 -7.42922082e-01  2.34889034e+00  2.65259328e+00  2.65259328e+00
  2.65259328e+00  1.98675995e+01  1.98675995e+01  1.98675995e+01
  3.22192952e+01  1.99150217e+02  1.03405049e+03  6.83060527e+03]
E1 = -182.19519060246347  E_coul = 53.912281367648326
cycle= 1 E= -128.282909234815  delta_E= -0.0605  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266963
diis-c [-0.07126937  1.        ]
  HOMO = -0.809752460312434  LUMO = 2.30324631959662
  mo_energy =
[-3.28324075e+01 -1.92504466e+00 -8.09752460e-01 -8.09752460e-01
 -8.09752460e-01  2.30324632e+00  2.59684227e+00  2.59684227e+00
  2.59684227e+00  1.96737927e+01  1.96737927e+01  1.96737927e+01
  3.20048897e+01  1.98854818e+02  1.03370589e+03  6.83022049e+03]
E1 = -182.66668533653805  E_coul = 54.38209549450142
cycle= 2 E= -128.284589842037  delta_E= -0.00168  |g|= 0.0638  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104797
diis-c [-2.43242404e-04  2.79977112e-01  7.20022888e-01]
  HOMO = -0.786569800952851  LUMO = 2.32116530780271
  mo_energy =
[-3.27565188e+01 -1.90105777e+00 -7.86569801e-01 -7.86569801e-01
 -7.86569801e-01  2.32116531e+00  2.61779349e+00  2.61779349e+00
  2.61779349e+00  1.97307269e+01  1.97307269e+01  1.97307269e+01
  3.20664020e+01  1.98934332e+02  1.03379278e+03  6.83031065e+03]
E1 = -182.53187331263183  E_coul = 54.24696704256519
cycle= 3 E= -128.284906270067  delta_E= -0.000316  |g|= 0.000531  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000704936
diis-c [-4.14688019e-08 -4.04461051e-03 -3.94826421e-03  1.00799287e+00]
  HOMO = -0.786757932200341  LUMO = 2.32101963015453
  mo_energy =
[-3.27570042e+01 -1.90128027e+00 -7.86757932e-01 -7.86757932e-01
 -7.86757932e-01  2.32101963e+00  2.61766090e+00  2.61766090e+00
  2.61766090e+00  1.97303423e+01  1.97303423e+01  1.97303423e+01
  3.20659562e+01  1.98933956e+02  1.03379256e+03  6.83031052e+03]
E1 = -182.5328366567399  E_coul = 54.247930369789415
cycle= 4 E= -128.284906286951  delta_E= -1.69e-08  |g|= 2.74e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.51983e-05
diis-c [-2.02566758e-10  2.58911536e-04 -3.38247608e-04 -9.53786084e-02
  1.09545794e+00]
  HOMO = -0.786749439186634  LUMO = 2.32102137220485
  mo_energy =
[-3.27569827e+01 -1.90127725e+00 -7.86749439e-01 -7.86749439e-01
 -7.86749439e-01  2.32102137e+00  2.61766812e+00  2.61766812e+00
  2.61766812e+00  1.97303593e+01  1.97303593e+01  1.97303593e+01
  3.20659719e+01  1.98933982e+02  1.03379260e+03  6.83031056e+03]
E1 = -182.53280123377846  E_coul = 54.24789494674913
cycle= 5 E= -128.284906287029  delta_E= -7.88e-11  |g|= 2.13e-06  |ddm|= 1.18e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53280123377846  E_coul = 54.24789494674913
  HOMO = -0.786748957947468  LUMO = 2.32102132111516
  mo_energy =
[-3.27569815e+01 -1.90127729e+00 -7.86748958e-01 -7.86748958e-01
 -7.86748958e-01  2.32102132e+00  2.61766855e+00  2.61766855e+00
  2.61766855e+00  1.97303602e+01  1.97303602e+01  1.97303602e+01
  3.20659727e+01  1.98933983e+02  1.03379260e+03  6.83031056e+03]
E1 = -182.532799448042  E_coul = 54.247893161012044
Extra cycle  E= -128.28490628703  delta_E= -6.25e-13  |g|= 4.85e-07  |ddm|= 1.19e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.007539647667286
E1 = -182.532799448042  E_coul = 54.247893161012044
init E= -128.28490628703
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786749055381909  LUMO = 2.32102116377726
  mo_energy =
[-3.27569819e+01 -1.90127749e+00 -7.86749055e-01 -7.86749055e-01
 -7.86749055e-01  2.32102116e+00  2.61766846e+00  2.61766846e+00
  2.61766846e+00  1.97303599e+01  1.97303599e+01  1.97303599e+01
  3.20659724e+01  1.98933983e+02  1.03379260e+03  6.83031056e+03]
E1 = -182.5328002110094  E_coul = 54.24789392397934
cycle= 1 E= -128.28490628703  delta_E= -8.53e-14  |g|= 1.21e-07  |ddm|= 2.86e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5328002110094  E_coul = 54.24789392397934
  HOMO = -0.7867489984252  LUMO = 2.32102119260729
  mo_energy =
[-3.27569817e+01 -1.90127745e+00 -7.86748998e-01 -7.86748998e-01
 -7.86748998e-01  2.32102119e+00  2.61766852e+00  2.61766852e+00
  2.61766852e+00  1.97303600e+01  1.97303600e+01  1.97303600e+01
  3.20659725e+01  1.98933983e+02  1.03379260e+03  6.83031056e+03]
E1 = -182.53279991694524  E_coul = 54.24789362991528
Extra cycle  E= -128.28490628703  delta_E= 8.53e-14  |g|= 4.35e-08  |ddm|= 4.75e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.78757435e+03 1.27340151e+02 5.62073850e+02 5.22443059e-01
 3.54887875e+01 1.09550795e+01 1.77017401e+00 2.77122407e+00
 1.32648544e+01 5.99816632e-01]
grad_E = [ 5.54993430e-07 -3.10082947e-05 -2.45123089e-06 -1.67720343e-04
  2.52179187e-04 -4.77382327e-04 -2.59286767e-04  1.47245850e-03
 -4.88707546e-04  2.02549092e-03]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:45 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3779.62840203        1
[INPUT] 0    0    [1    /1   ]  127.260137373        1
[INPUT] 0    0    [1    /1   ]  562.092246557        1
[INPUT] 0    0    [1    /1   ]  0.523244204784       1
[INPUT] 0    0    [1    /1   ]  35.4237338988        1
[INPUT] 0    0    [1    /1   ]  10.9468770367        1
[INPUT] 0    0    [1    /1   ]  1.77344958737        1
[INPUT] 1    0    [1    /1   ]  2.77415149085        1
[INPUT] 1    0    [1    /1   ]  13.3054337138        1
[INPUT] 1    0    [1    /1   ]  0.599960115382       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3779.628402028521, 1.0]], [0, [127.26013737250847, 1.0]], [0, [562.092246556766, 1.0]], [0, [0.5232442047836973, 1.0]], [0, [35.423733898803405, 1.0]], [0, [10.946877036700585, 1.0]], [0, [1.773449587374629, 1.0]], [1, [2.7741514908453606, 1.0]], [1, [13.30543371382659, 1.0]], [1, [0.5999601153816325, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3779.62840203]
bas 1, expnt(s) = [127.26013737]
bas 2, expnt(s) = [562.09224656]
bas 3, expnt(s) = [0.5232442]
bas 4, expnt(s) = [35.4237339]
bas 5, expnt(s) = [10.94687704]
bas 6, expnt(s) = [1.77344959]
bas 7, expnt(s) = [2.77415149]
bas 8, expnt(s) = [13.30543371]
bas 9, expnt(s) = [0.59996012]
CPU time:       481.26
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.77962840e+03 1.21787258e+03 1.27260137e+02 9.57269705e+01
 5.62092247e+02 2.91655869e+02 5.23244205e-01 1.55433041e+00
 3.54237339e+01 3.66847680e+01 1.09468770e+01 1.52048697e+01
 1.77344959e+00 3.88265820e+00 2.77415149e+00 1.04447274e+01
 1.33054337e+01 7.41345554e+01 5.99960115e-01 1.54041368e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966790569545216
cond(S) = 59.06465688274814
E1 = -183.2309674394936  E_coul = 55.00862568294493
init E= -128.222341756549
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742958057378549  LUMO = 2.35510606083021
  mo_energy =
[-3.25549558e+01 -1.85691304e+00 -7.42958057e-01 -7.42958057e-01
 -7.42958057e-01  2.35510606e+00  2.65407291e+00  2.65407291e+00
  2.65407291e+00  1.99195794e+01  1.99195794e+01  1.99195794e+01
  3.21915514e+01  1.98896008e+02  1.03354672e+03  6.81991573e+03]
E1 = -182.1955295128505  E_coul = 53.91259761989597
cycle= 1 E= -128.282931892955  delta_E= -0.0606  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26681
diis-c [-0.07118745  1.        ]
  HOMO = -0.809746288725479  LUMO = 2.30936400861498
  mo_energy =
[-3.28322803e+01 -1.92504278e+00 -8.09746289e-01 -8.09746289e-01
 -8.09746289e-01  2.30936401e+00  2.59831686e+00  2.59831686e+00
  2.59831686e+00  1.97255690e+01  1.97255690e+01  1.97255690e+01
  3.19772810e+01  1.98600668e+02  1.03320207e+03  6.81953094e+03]
E1 = -182.6668116507328  E_coul = 54.38219978166173
cycle= 2 E= -128.284611869071  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.43137989e-04  2.79972047e-01  7.20027953e-01]
  HOMO = -0.786575944084538  LUMO = 2.32730727327723
  mo_energy =
[-3.27564172e+01 -1.90106864e+00 -7.86575944e-01 -7.86575944e-01
 -7.86575944e-01  2.32730727e+00  2.61927149e+00  2.61927149e+00
  2.61927149e+00  1.97825447e+01  1.97825447e+01  1.97825447e+01
  3.20387413e+01  1.98680151e+02  1.03328894e+03  6.81962109e+03]
E1 = -182.53209201825248  E_coul = 54.247164035278935
cycle= 3 E= -128.284927982974  delta_E= -0.000316  |g|= 0.00053  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000698911
diis-c [-4.33450935e-08 -4.10165642e-03 -4.17387700e-03  1.00827553e+00]
  HOMO = -0.786762525763057  LUMO = 2.32716154287606
  mo_energy =
[-3.27568980e+01 -1.90129074e+00 -7.86762526e-01 -7.86762526e-01
 -7.86762526e-01  2.32716154e+00  2.61914022e+00  2.61914022e+00
  2.61914022e+00  1.97821634e+01  1.97821634e+01  1.97821634e+01
  3.20382986e+01  1.98679781e+02  1.03328873e+03  6.81962097e+03]
E1 = -182.53304794614417  E_coul = 54.248119946421724
cycle= 4 E= -128.284927999722  delta_E= -1.67e-08  |g|= 2.82e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.66011e-05
diis-c [-2.13370456e-10  2.66939738e-04 -3.33918397e-04 -9.71838714e-02
  1.09725085e+00]
  HOMO = -0.78675376884453  LUMO = 2.3271633119203
  mo_energy =
[-3.27568758e+01 -1.90128766e+00 -7.86753769e-01 -7.86753769e-01
 -7.86753769e-01  2.32716331e+00  2.61914766e+00  2.61914766e+00
  2.61914766e+00  1.97821808e+01  1.97821808e+01  1.97821808e+01
  3.20383148e+01  1.98679808e+02  1.03328877e+03  6.81962101e+03]
E1 = -182.53301145284073  E_coul = 54.248083453033814
cycle= 5 E= -128.284927999807  delta_E= -8.45e-11  |g|= 2.17e-06  |ddm|= 1.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53301145284073  E_coul = 54.248083453033814
  HOMO = -0.786753287732121  LUMO = 2.32716325221921
  mo_energy =
[-3.27568747e+01 -1.90128771e+00 -7.86753288e-01 -7.86753288e-01
 -7.86753288e-01  2.32716325e+00  2.61914810e+00  2.61914810e+00
  2.61914810e+00  1.97821817e+01  1.97821817e+01  1.97821817e+01
  3.20383156e+01  1.98679810e+02  1.03328877e+03  6.81962101e+03]
E1 = -182.53300968045752  E_coul = 54.248081680650145
Extra cycle  E= -128.284927999807  delta_E= -4.83e-13  |g|= 4.91e-07  |ddm|= 1.21e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.77962840e+03 1.27260137e+02 5.62092247e+02 5.23244205e-01
 3.54237339e+01 1.09468770e+01 1.77344959e+00 2.77415149e+00
 1.33054337e+01 5.99960115e-01]
E = -128.2849279998074
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:46 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3779.62840203        1
[INPUT] 0    0    [1    /1   ]  127.260137373        1
[INPUT] 0    0    [1    /1   ]  562.092246557        1
[INPUT] 0    0    [1    /1   ]  0.523244204784       1
[INPUT] 0    0    [1    /1   ]  35.4237338988        1
[INPUT] 0    0    [1    /1   ]  10.9468770367        1
[INPUT] 0    0    [1    /1   ]  1.77344958737        1
[INPUT] 1    0    [1    /1   ]  2.77415149085        1
[INPUT] 1    0    [1    /1   ]  13.3054337138        1
[INPUT] 1    0    [1    /1   ]  0.599960115382       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3779.628402028521, 1.0]], [0, [127.26013737250847, 1.0]], [0, [562.092246556766, 1.0]], [0, [0.5232442047836973, 1.0]], [0, [35.423733898803405, 1.0]], [0, [10.946877036700585, 1.0]], [0, [1.773449587374629, 1.0]], [1, [2.7741514908453606, 1.0]], [1, [13.30543371382659, 1.0]], [1, [0.5999601153816325, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3779.62840203]
bas 1, expnt(s) = [127.26013737]
bas 2, expnt(s) = [562.09224656]
bas 3, expnt(s) = [0.5232442]
bas 4, expnt(s) = [35.4237339]
bas 5, expnt(s) = [10.94687704]
bas 6, expnt(s) = [1.77344959]
bas 7, expnt(s) = [2.77415149]
bas 8, expnt(s) = [13.30543371]
bas 9, expnt(s) = [0.59996012]
CPU time:       482.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.77962840e+03 1.21787258e+03 1.27260137e+02 9.57269705e+01
 5.62092247e+02 2.91655869e+02 5.23244205e-01 1.55433041e+00
 3.54237339e+01 3.66847680e+01 1.09468770e+01 1.52048697e+01
 1.77344959e+00 3.88265820e+00 2.77415149e+00 1.04447274e+01
 1.33054337e+01 7.41345554e+01 5.99960115e-01 1.54041368e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966790569545216
cond(S) = 59.06465688274814
E1 = -183.2309674394936  E_coul = 55.00862568294493
init E= -128.222341756549
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742958057378549  LUMO = 2.35510606083021
  mo_energy =
[-3.25549558e+01 -1.85691304e+00 -7.42958057e-01 -7.42958057e-01
 -7.42958057e-01  2.35510606e+00  2.65407291e+00  2.65407291e+00
  2.65407291e+00  1.99195794e+01  1.99195794e+01  1.99195794e+01
  3.21915514e+01  1.98896008e+02  1.03354672e+03  6.81991573e+03]
E1 = -182.1955295128505  E_coul = 53.91259761989597
cycle= 1 E= -128.282931892955  delta_E= -0.0606  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26681
diis-c [-0.07118745  1.        ]
  HOMO = -0.809746288725479  LUMO = 2.30936400861498
  mo_energy =
[-3.28322803e+01 -1.92504278e+00 -8.09746289e-01 -8.09746289e-01
 -8.09746289e-01  2.30936401e+00  2.59831686e+00  2.59831686e+00
  2.59831686e+00  1.97255690e+01  1.97255690e+01  1.97255690e+01
  3.19772810e+01  1.98600668e+02  1.03320207e+03  6.81953094e+03]
E1 = -182.6668116507328  E_coul = 54.38219978166173
cycle= 2 E= -128.284611869071  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.43137989e-04  2.79972047e-01  7.20027953e-01]
  HOMO = -0.786575944084538  LUMO = 2.32730727327723
  mo_energy =
[-3.27564172e+01 -1.90106864e+00 -7.86575944e-01 -7.86575944e-01
 -7.86575944e-01  2.32730727e+00  2.61927149e+00  2.61927149e+00
  2.61927149e+00  1.97825447e+01  1.97825447e+01  1.97825447e+01
  3.20387413e+01  1.98680151e+02  1.03328894e+03  6.81962109e+03]
E1 = -182.53209201825248  E_coul = 54.247164035278935
cycle= 3 E= -128.284927982974  delta_E= -0.000316  |g|= 0.00053  |ddm|= 0.0185
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000698911
diis-c [-4.33450935e-08 -4.10165642e-03 -4.17387700e-03  1.00827553e+00]
  HOMO = -0.786762525763057  LUMO = 2.32716154287606
  mo_energy =
[-3.27568980e+01 -1.90129074e+00 -7.86762526e-01 -7.86762526e-01
 -7.86762526e-01  2.32716154e+00  2.61914022e+00  2.61914022e+00
  2.61914022e+00  1.97821634e+01  1.97821634e+01  1.97821634e+01
  3.20382986e+01  1.98679781e+02  1.03328873e+03  6.81962097e+03]
E1 = -182.53304794614417  E_coul = 54.248119946421724
cycle= 4 E= -128.284927999722  delta_E= -1.67e-08  |g|= 2.82e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.66011e-05
diis-c [-2.13370456e-10  2.66939738e-04 -3.33918397e-04 -9.71838714e-02
  1.09725085e+00]
  HOMO = -0.78675376884453  LUMO = 2.3271633119203
  mo_energy =
[-3.27568758e+01 -1.90128766e+00 -7.86753769e-01 -7.86753769e-01
 -7.86753769e-01  2.32716331e+00  2.61914766e+00  2.61914766e+00
  2.61914766e+00  1.97821808e+01  1.97821808e+01  1.97821808e+01
  3.20383148e+01  1.98679808e+02  1.03328877e+03  6.81962101e+03]
E1 = -182.53301145284073  E_coul = 54.248083453033814
cycle= 5 E= -128.284927999807  delta_E= -8.45e-11  |g|= 2.17e-06  |ddm|= 1.22e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53301145284073  E_coul = 54.248083453033814
  HOMO = -0.786753287732121  LUMO = 2.32716325221921
  mo_energy =
[-3.27568747e+01 -1.90128771e+00 -7.86753288e-01 -7.86753288e-01
 -7.86753288e-01  2.32716325e+00  2.61914810e+00  2.61914810e+00
  2.61914810e+00  1.97821817e+01  1.97821817e+01  1.97821817e+01
  3.20383156e+01  1.98679810e+02  1.03328877e+03  6.81962101e+03]
E1 = -182.53300968045752  E_coul = 54.248081680650145
Extra cycle  E= -128.284927999807  delta_E= -4.83e-13  |g|= 4.91e-07  |ddm|= 1.21e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.06465688274814
E1 = -182.53300968045752  E_coul = 54.248081680650145
init E= -128.284927999807
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786753383774096  LUMO = 2.32716309401269
  mo_energy =
[-3.27568751e+01 -1.90128792e+00 -7.86753384e-01 -7.86753384e-01
 -7.86753384e-01  2.32716309e+00  2.61914801e+00  2.61914801e+00
  2.61914801e+00  1.97821814e+01  1.97821814e+01  1.97821814e+01
  3.20383152e+01  1.98679809e+02  1.03328877e+03  6.81962101e+03]
E1 = -182.53301043836788  E_coul = 54.24808243856025
cycle= 1 E= -128.284927999808  delta_E= -2.27e-13  |g|= 1.21e-07  |ddm|= 2.9e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53301043836788  E_coul = 54.24808243856025
  HOMO = -0.786753327081544  LUMO = 2.32716312239644
  mo_energy =
[-3.27568749e+01 -1.90128788e+00 -7.86753327e-01 -7.86753327e-01
 -7.86753327e-01  2.32716312e+00  2.61914806e+00  2.61914806e+00
  2.61914806e+00  1.97821815e+01  1.97821815e+01  1.97821815e+01
  3.20383154e+01  1.98679809e+02  1.03328877e+03  6.81962101e+03]
E1 = -182.53301014648213  E_coul = 54.24808214667466
Extra cycle  E= -128.284927999807  delta_E= 1.71e-13  |g|= 4.34e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.77962840e+03 1.27260137e+02 5.62092247e+02 5.23244205e-01
 3.54237339e+01 1.09468770e+01 1.77344959e+00 2.77415149e+00
 1.33054337e+01 5.99960115e-01]
grad_E = [ 4.62981295e-07 -9.75488441e-06 -2.18923300e-06 -2.17387011e-04
  9.58913991e-05 -1.85913811e-04 -3.26634253e-05  4.75135904e-04
 -1.55713080e-04  6.81875342e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:50 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3736.87924219        1
[INPUT] 0    0    [1    /1   ]  126.816292173        1
[INPUT] 0    0    [1    /1   ]  559.167096839        1
[INPUT] 0    0    [1    /1   ]  0.523652008975       1
[INPUT] 0    0    [1    /1   ]  35.3168150789        1
[INPUT] 0    0    [1    /1   ]  10.9313474779        1
[INPUT] 0    0    [1    /1   ]  1.77492748754        1
[INPUT] 1    0    [1    /1   ]  2.776060307          1
[INPUT] 1    0    [1    /1   ]  13.3311667921        1
[INPUT] 1    0    [1    /1   ]  0.600060345178       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3736.8792421944313, 1.0]], [0, [126.8162921727207, 1.0]], [0, [559.1670968390265, 1.0]], [0, [0.5236520089749745, 1.0]], [0, [35.316815078899005, 1.0]], [0, [10.93134747785403, 1.0]], [0, [1.7749274875399172, 1.0]], [1, [2.7760603069953036, 1.0]], [1, [13.331166792086773, 1.0]], [1, [0.6000603451779987, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3736.87924219]
bas 1, expnt(s) = [126.81629217]
bas 2, expnt(s) = [559.16709684]
bas 3, expnt(s) = [0.52365201]
bas 4, expnt(s) = [35.31681508]
bas 5, expnt(s) = [10.93134748]
bas 6, expnt(s) = [1.77492749]
bas 7, expnt(s) = [2.77606031]
bas 8, expnt(s) = [13.33116679]
bas 9, expnt(s) = [0.60006035]
CPU time:       486.20
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.73687924e+03 1.20752692e+03 1.26816292e+02 9.54764610e+01
 5.59167097e+02 2.90516786e+02 5.23652009e-01 1.55523888e+00
 3.53168151e+01 3.66016929e+01 1.09313475e+01 1.51886893e+01
 1.77492749e+00 3.88508465e+00 2.77606031e+00 1.04537116e+01
 1.33311668e+01 7.43138215e+01 6.00060345e-01 1.54073537e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966760693586608
cond(S) = 59.38546435304234
E1 = -183.23100818734025  E_coul = 55.00859351682828
init E= -128.222414670512
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74298121462739  LUMO = 2.35787955477057
  mo_energy =
[-3.25548927e+01 -1.85692786e+00 -7.42981215e-01 -7.42981215e-01
 -7.42981215e-01  2.35787955e+00  2.65507164e+00  2.65507164e+00
  2.65507164e+00  1.99527565e+01  1.99527565e+01  1.99527565e+01
  3.21186176e+01  1.98177900e+02  1.02847586e+03  6.75352595e+03]
E1 = -182.19581452228792  E_coul = 53.912869247444796
cycle= 1 E= -128.282945274843  delta_E= -0.0605  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.2667
diis-c [-0.07112885  1.        ]
  HOMO = -0.809733550665426  LUMO = 2.31211468634465
  mo_energy =
[-3.28321958e+01 -1.92503564e+00 -8.09733551e-01 -8.09733551e-01
 -8.09733551e-01  2.31211469e+00  2.59931909e+00  2.59931909e+00
  2.59931909e+00  1.97586322e+01  1.97586322e+01  1.97586322e+01
  3.19045920e+01  1.97882734e+02  1.02813131e+03  6.75314129e+03]
E1 = -182.6669182091637  E_coul = 54.38229364165023
cycle= 2 E= -128.284624567513  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104695
diis-c [-2.42468561e-04  2.79982242e-01  7.20017758e-01]
  HOMO = -0.786573528879316  LUMO = 2.3300618519162
  mo_energy =
[-3.27563572e+01 -1.90107264e+00 -7.86573529e-01 -7.86573529e-01
 -7.86573529e-01  2.33006185e+00  2.62027402e+00  2.62027402e+00
  2.62027402e+00  1.98156280e+01  1.98156280e+01  1.98156280e+01
  3.19659797e+01  1.97962166e+02  1.02821815e+03  6.75323142e+03]
E1 = -182.53227382876707  E_coul = 54.24733341036236
cycle= 3 E= -128.284940418405  delta_E= -0.000316  |g|= 0.000529  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00069314
diis-c [-4.47130908e-08 -4.15486351e-03 -4.38409262e-03  1.00853896e+00]
  HOMO = -0.786758579548766  LUMO = 2.32991644479247
  mo_energy =
[-3.27568333e+01 -1.90129411e+00 -7.86758580e-01 -7.86758580e-01
 -7.86758580e-01  2.32991644e+00  2.62014407e+00  2.62014407e+00
  2.62014407e+00  1.98152499e+01  1.98152499e+01  1.98152499e+01
  3.19655405e+01  1.97961801e+02  1.02821795e+03  6.75323130e+03]
E1 = -182.53322208992458  E_coul = 54.2482816549288
cycle= 4 E= -128.284940434996  delta_E= -1.66e-08  |g|= 2.89e-05  |ddm|= 0.000167
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.76606e-05
diis-c [-2.21922475e-10  2.74643190e-04 -3.26081383e-04 -9.87607078e-02
  1.09881215e+00]
  HOMO = -0.786749622312428  LUMO = 2.32991822488363
  mo_energy =
[-3.27568107e+01 -1.90129100e+00 -7.86749622e-01 -7.86749622e-01
 -7.86749622e-01  2.32991822e+00  2.62015169e+00  2.62015169e+00
  2.62015169e+00  1.98152678e+01  1.98152678e+01  1.98152678e+01
  3.19655570e+01  1.97961829e+02  1.02821798e+03  6.75323135e+03]
E1 = -182.5331848134562  E_coul = 54.248244378371716
cycle= 5 E= -128.284940435084  delta_E= -8.87e-11  |g|= 2.2e-06  |ddm|= 1.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5331848134562  E_coul = 54.248244378371716
  HOMO = -0.786749142980823  LUMO = 2.32991815791002
  mo_energy =
[-3.27568095e+01 -1.90129106e+00 -7.86749143e-01 -7.86749143e-01
 -7.86749143e-01  2.32991816e+00  2.62015212e+00  2.62015212e+00
  2.62015212e+00  1.98152686e+01  1.98152686e+01  1.98152686e+01
  3.19655578e+01  1.97961830e+02  1.02821799e+03  6.75323135e+03]
E1 = -182.5331830603506  E_coul = 54.24824262526533
Extra cycle  E= -128.284940435085  delta_E= -7.96e-13  |g|= 4.95e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.73687924e+03 1.26816292e+02 5.59167097e+02 5.23652009e-01
 3.53168151e+01 1.09313475e+01 1.77492749e+00 2.77606031e+00
 1.33311668e+01 6.00060345e-01]
E = -128.28494043508528
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:51 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3736.87924219        1
[INPUT] 0    0    [1    /1   ]  126.816292173        1
[INPUT] 0    0    [1    /1   ]  559.167096839        1
[INPUT] 0    0    [1    /1   ]  0.523652008975       1
[INPUT] 0    0    [1    /1   ]  35.3168150789        1
[INPUT] 0    0    [1    /1   ]  10.9313474779        1
[INPUT] 0    0    [1    /1   ]  1.77492748754        1
[INPUT] 1    0    [1    /1   ]  2.776060307          1
[INPUT] 1    0    [1    /1   ]  13.3311667921        1
[INPUT] 1    0    [1    /1   ]  0.600060345178       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3736.8792421944313, 1.0]], [0, [126.8162921727207, 1.0]], [0, [559.1670968390265, 1.0]], [0, [0.5236520089749745, 1.0]], [0, [35.316815078899005, 1.0]], [0, [10.93134747785403, 1.0]], [0, [1.7749274875399172, 1.0]], [1, [2.7760603069953036, 1.0]], [1, [13.331166792086773, 1.0]], [1, [0.6000603451779987, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3736.87924219]
bas 1, expnt(s) = [126.81629217]
bas 2, expnt(s) = [559.16709684]
bas 3, expnt(s) = [0.52365201]
bas 4, expnt(s) = [35.31681508]
bas 5, expnt(s) = [10.93134748]
bas 6, expnt(s) = [1.77492749]
bas 7, expnt(s) = [2.77606031]
bas 8, expnt(s) = [13.33116679]
bas 9, expnt(s) = [0.60006035]
CPU time:       487.85
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.73687924e+03 1.20752692e+03 1.26816292e+02 9.54764610e+01
 5.59167097e+02 2.90516786e+02 5.23652009e-01 1.55523888e+00
 3.53168151e+01 3.66016929e+01 1.09313475e+01 1.51886893e+01
 1.77492749e+00 3.88508465e+00 2.77606031e+00 1.04537116e+01
 1.33311668e+01 7.43138215e+01 6.00060345e-01 1.54073537e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966760693586608
cond(S) = 59.38546435304234
E1 = -183.23100818734025  E_coul = 55.00859351682828
init E= -128.222414670512
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74298121462739  LUMO = 2.35787955477057
  mo_energy =
[-3.25548927e+01 -1.85692786e+00 -7.42981215e-01 -7.42981215e-01
 -7.42981215e-01  2.35787955e+00  2.65507164e+00  2.65507164e+00
  2.65507164e+00  1.99527565e+01  1.99527565e+01  1.99527565e+01
  3.21186176e+01  1.98177900e+02  1.02847586e+03  6.75352595e+03]
E1 = -182.19581452228792  E_coul = 53.912869247444796
cycle= 1 E= -128.282945274843  delta_E= -0.0605  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.2667
diis-c [-0.07112885  1.        ]
  HOMO = -0.809733550665426  LUMO = 2.31211468634465
  mo_energy =
[-3.28321958e+01 -1.92503564e+00 -8.09733551e-01 -8.09733551e-01
 -8.09733551e-01  2.31211469e+00  2.59931909e+00  2.59931909e+00
  2.59931909e+00  1.97586322e+01  1.97586322e+01  1.97586322e+01
  3.19045920e+01  1.97882734e+02  1.02813131e+03  6.75314129e+03]
E1 = -182.6669182091637  E_coul = 54.38229364165023
cycle= 2 E= -128.284624567513  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104695
diis-c [-2.42468561e-04  2.79982242e-01  7.20017758e-01]
  HOMO = -0.786573528879316  LUMO = 2.3300618519162
  mo_energy =
[-3.27563572e+01 -1.90107264e+00 -7.86573529e-01 -7.86573529e-01
 -7.86573529e-01  2.33006185e+00  2.62027402e+00  2.62027402e+00
  2.62027402e+00  1.98156280e+01  1.98156280e+01  1.98156280e+01
  3.19659797e+01  1.97962166e+02  1.02821815e+03  6.75323142e+03]
E1 = -182.53227382876707  E_coul = 54.24733341036236
cycle= 3 E= -128.284940418405  delta_E= -0.000316  |g|= 0.000529  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00069314
diis-c [-4.47130908e-08 -4.15486351e-03 -4.38409262e-03  1.00853896e+00]
  HOMO = -0.786758579548766  LUMO = 2.32991644479247
  mo_energy =
[-3.27568333e+01 -1.90129411e+00 -7.86758580e-01 -7.86758580e-01
 -7.86758580e-01  2.32991644e+00  2.62014407e+00  2.62014407e+00
  2.62014407e+00  1.98152499e+01  1.98152499e+01  1.98152499e+01
  3.19655405e+01  1.97961801e+02  1.02821795e+03  6.75323130e+03]
E1 = -182.53322208992458  E_coul = 54.2482816549288
cycle= 4 E= -128.284940434996  delta_E= -1.66e-08  |g|= 2.89e-05  |ddm|= 0.000167
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.76606e-05
diis-c [-2.21922475e-10  2.74643190e-04 -3.26081383e-04 -9.87607078e-02
  1.09881215e+00]
  HOMO = -0.786749622312428  LUMO = 2.32991822488363
  mo_energy =
[-3.27568107e+01 -1.90129100e+00 -7.86749622e-01 -7.86749622e-01
 -7.86749622e-01  2.32991822e+00  2.62015169e+00  2.62015169e+00
  2.62015169e+00  1.98152678e+01  1.98152678e+01  1.98152678e+01
  3.19655570e+01  1.97961829e+02  1.02821798e+03  6.75323135e+03]
E1 = -182.5331848134562  E_coul = 54.248244378371716
cycle= 5 E= -128.284940435084  delta_E= -8.87e-11  |g|= 2.2e-06  |ddm|= 1.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5331848134562  E_coul = 54.248244378371716
  HOMO = -0.786749142980823  LUMO = 2.32991815791002
  mo_energy =
[-3.27568095e+01 -1.90129106e+00 -7.86749143e-01 -7.86749143e-01
 -7.86749143e-01  2.32991816e+00  2.62015212e+00  2.62015212e+00
  2.62015212e+00  1.98152686e+01  1.98152686e+01  1.98152686e+01
  3.19655578e+01  1.97961830e+02  1.02821799e+03  6.75323135e+03]
E1 = -182.5331830603506  E_coul = 54.24824262526533
Extra cycle  E= -128.284940435085  delta_E= -7.96e-13  |g|= 4.95e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.38546435304234
E1 = -182.5331830603506  E_coul = 54.24824262526533
init E= -128.284940435085
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786749237356909  LUMO = 2.32991799970076
  mo_energy =
[-3.27568099e+01 -1.90129126e+00 -7.86749237e-01 -7.86749237e-01
 -7.86749237e-01  2.32991800e+00  2.62015204e+00  2.62015204e+00
  2.62015204e+00  1.98152684e+01  1.98152684e+01  1.98152684e+01
  3.19655575e+01  1.97961830e+02  1.02821798e+03  6.75323135e+03]
E1 = -182.53318381091003  E_coul = 54.24824337582483
cycle= 1 E= -128.284940435085  delta_E= 5.68e-14  |g|= 1.21e-07  |ddm|= 2.93e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53318381091003  E_coul = 54.24824337582483
  HOMO = -0.78674918110668  LUMO = 2.32991802754498
  mo_energy =
[-3.27568098e+01 -1.90129122e+00 -7.86749181e-01 -7.86749181e-01
 -7.86749181e-01  2.32991803e+00  2.62015209e+00  2.62015209e+00
  2.62015209e+00  1.98152685e+01  1.98152685e+01  1.98152685e+01
  3.19655576e+01  1.97961830e+02  1.02821798e+03  6.75323135e+03]
E1 = -182.53318352209448  E_coul = 54.248243087009286
Extra cycle  E= -128.284940435085  delta_E= 2.84e-14  |g|= 4.31e-08  |ddm|= 4.81e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.73687924e+03 1.26816292e+02 5.59167097e+02 5.23652009e-01
 3.53168151e+01 1.09313475e+01 1.77492749e+00 2.77606031e+00
 1.33311668e+01 6.00060345e-01]
grad_E = [ 2.24472048e-07  3.55732830e-06 -1.47300704e-06 -3.80076219e-05
 -9.00405554e-06  2.39505171e-05  3.67532815e-05 -1.20830726e-04
  4.95376143e-05 -1.99009767e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:55 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3707.6822245         1
[INPUT] 0    0    [1    /1   ]  126.521316099        1
[INPUT] 0    0    [1    /1   ]  557.077391125        1
[INPUT] 0    0    [1    /1   ]  0.523563672385       1
[INPUT] 0    0    [1    /1   ]  35.2591947715        1
[INPUT] 0    0    [1    /1   ]  10.9206853946        1
[INPUT] 0    0    [1    /1   ]  1.77465902396        1
[INPUT] 1    0    [1    /1   ]  2.77594338092        1
[INPUT] 1    0    [1    /1   ]  13.3302760771        1
[INPUT] 1    0    [1    /1   ]  0.60004534833        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3707.682224500437, 1.0]], [0, [126.52131609901502, 1.0]], [0, [557.0773911248737, 1.0]], [0, [0.523563672384657, 1.0]], [0, [35.25919477153576, 1.0]], [0, [10.920685394642865, 1.0]], [0, [1.7746590239595605, 1.0]], [1, [2.7759433809220573, 1.0]], [1, [13.33027607710058, 1.0]], [1, [0.6000453483301055, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3707.6822245]
bas 1, expnt(s) = [126.5213161]
bas 2, expnt(s) = [557.07739112]
bas 3, expnt(s) = [0.52356367]
bas 4, expnt(s) = [35.25919477]
bas 5, expnt(s) = [10.92068539]
bas 6, expnt(s) = [1.77465902]
bas 7, expnt(s) = [2.77594338]
bas 8, expnt(s) = [13.33027608]
bas 9, expnt(s) = [0.60004535]
CPU time:       491.22
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70768222e+03 1.20044399e+03 1.26521316e+02 9.53098530e+01
 5.57077391e+02 2.89702120e+02 5.23563672e-01 1.55504211e+00
 3.52591948e+01 3.65568963e+01 1.09206854e+01 1.51775770e+01
 1.77465902e+00 3.88464392e+00 2.77594338e+00 1.04531612e+01
 1.33302761e+01 7.43076150e+01 6.00045348e-01 1.54068723e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966765725123174
cond(S) = 59.58565084717965
E1 = -183.23111179893036  E_coul = 55.00857464413793
init E= -128.222537154792
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742981653025588  LUMO = 2.3570968335353
  mo_energy =
[-3.25549024e+01 -1.85692794e+00 -7.42981653e-01 -7.42981653e-01
 -7.42981653e-01  2.35709683e+00  2.65496917e+00  2.65496917e+00
  2.65496917e+00  1.99514104e+01  1.99514104e+01  1.99514104e+01
  3.20682598e+01  1.97728002e+02  1.02498894e+03  6.70797961e+03]
E1 = -182.19570704568872  E_coul = 53.91275955159884
cycle= 1 E= -128.28294749409  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266726
diis-c [-0.07114269  1.        ]
  HOMO = -0.809739802527524  LUMO = 2.31134998259247
  mo_energy =
[-3.28322277e+01 -1.92504113e+00 -8.09739803e-01 -8.09739803e-01
 -8.09739803e-01  2.31134998e+00  2.59921312e+00  2.59921312e+00
  2.59921312e+00  1.97572761e+01  1.97572761e+01  1.97572761e+01
  3.18543463e+01  1.97432900e+02  1.02464445e+03  6.70759501e+03]
E1 = -182.66685104498973  E_coul = 54.38222402676785
cycle= 2 E= -128.284627018222  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104712
diis-c [-2.41874796e-04  2.80000347e-01  7.19999653e-01]
  HOMO = -0.786578322043699  LUMO = 2.32929187851785
  mo_energy =
[-3.27563846e+01 -1.90107678e+00 -7.86578322e-01 -7.86578322e-01
 -7.86578322e-01  2.32929188e+00  2.62016864e+00  2.62016864e+00
  2.62016864e+00  1.98142740e+01  1.98142740e+01  1.98142740e+01
  3.19157078e+01  1.97512319e+02  1.02473128e+03  6.70768514e+03]
E1 = -182.53219615673348  E_coul = 54.24725323164796
cycle= 3 E= -128.284942925086  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691438
diis-c [-4.46744117e-08 -4.16750908e-03 -4.43556126e-03  1.00860307e+00]
  HOMO = -0.786762932054804  LUMO = 2.32914686374274
  mo_energy =
[-3.27568592e+01 -1.90129779e+00 -7.86762932e-01 -7.86762932e-01
 -7.86762932e-01  2.32914686e+00  2.62003910e+00  2.62003910e+00
  2.62003910e+00  1.98138971e+01  1.98138971e+01  1.98138971e+01
  3.19152698e+01  1.97511956e+02  1.02473108e+03  6.70768502e+03]
E1 = -182.53314173018956  E_coul = 54.248198788596355
cycle= 4 E= -128.284942941593  delta_E= -1.65e-08  |g|= 2.89e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.76483e-05
diis-c [-2.21862658e-10  2.75934297e-04 -3.21241699e-04 -9.88625347e-02
  1.09890784e+00]
  HOMO = -0.786753975528689  LUMO = 2.32914864027993
  mo_energy =
[-3.27568366e+01 -1.90129468e+00 -7.86753976e-01 -7.86753976e-01
 -7.86753976e-01  2.32914864e+00  2.62004672e+00  2.62004672e+00
  2.62004672e+00  1.98139149e+01  1.98139149e+01  1.98139149e+01
  3.19152863e+01  1.97511983e+02  1.02473111e+03  6.70768507e+03]
E1 = -182.53310446935686  E_coul = 54.24816152767506
cycle= 5 E= -128.284942941682  delta_E= -8.86e-11  |g|= 2.19e-06  |ddm|= 1.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53310446935686  E_coul = 54.24816152767506
  HOMO = -0.786753497555213  LUMO = 2.32914857268941
  mo_energy =
[-3.27568355e+01 -1.90129475e+00 -7.86753498e-01 -7.86753498e-01
 -7.86753498e-01  2.32914857e+00  2.62004715e+00  2.62004715e+00
  2.62004715e+00  1.98139158e+01  1.98139158e+01  1.98139158e+01
  3.19152871e+01  1.97511985e+02  1.02473112e+03  6.70768507e+03]
E1 = -182.5331027232242  E_coul = 54.24815978154173
Extra cycle  E= -128.284942941682  delta_E= -6.54e-13  |g|= 4.94e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70768222e+03 1.26521316e+02 5.57077391e+02 5.23563672e-01
 3.52591948e+01 1.09206854e+01 1.77465902e+00 2.77594338e+00
 1.33302761e+01 6.00045348e-01]
E = -128.28494294168246
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:52:56 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3707.6822245         1
[INPUT] 0    0    [1    /1   ]  126.521316099        1
[INPUT] 0    0    [1    /1   ]  557.077391125        1
[INPUT] 0    0    [1    /1   ]  0.523563672385       1
[INPUT] 0    0    [1    /1   ]  35.2591947715        1
[INPUT] 0    0    [1    /1   ]  10.9206853946        1
[INPUT] 0    0    [1    /1   ]  1.77465902396        1
[INPUT] 1    0    [1    /1   ]  2.77594338092        1
[INPUT] 1    0    [1    /1   ]  13.3302760771        1
[INPUT] 1    0    [1    /1   ]  0.60004534833        1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3707.682224500437, 1.0]], [0, [126.52131609901502, 1.0]], [0, [557.0773911248737, 1.0]], [0, [0.523563672384657, 1.0]], [0, [35.25919477153576, 1.0]], [0, [10.920685394642865, 1.0]], [0, [1.7746590239595605, 1.0]], [1, [2.7759433809220573, 1.0]], [1, [13.33027607710058, 1.0]], [1, [0.6000453483301055, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3707.6822245]
bas 1, expnt(s) = [126.5213161]
bas 2, expnt(s) = [557.07739112]
bas 3, expnt(s) = [0.52356367]
bas 4, expnt(s) = [35.25919477]
bas 5, expnt(s) = [10.92068539]
bas 6, expnt(s) = [1.77465902]
bas 7, expnt(s) = [2.77594338]
bas 8, expnt(s) = [13.33027608]
bas 9, expnt(s) = [0.60004535]
CPU time:       492.89
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70768222e+03 1.20044399e+03 1.26521316e+02 9.53098530e+01
 5.57077391e+02 2.89702120e+02 5.23563672e-01 1.55504211e+00
 3.52591948e+01 3.65568963e+01 1.09206854e+01 1.51775770e+01
 1.77465902e+00 3.88464392e+00 2.77594338e+00 1.04531612e+01
 1.33302761e+01 7.43076150e+01 6.00045348e-01 1.54068723e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966765725123174
cond(S) = 59.58565084717965
E1 = -183.23111179893036  E_coul = 55.00857464413793
init E= -128.222537154792
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742981653025588  LUMO = 2.3570968335353
  mo_energy =
[-3.25549024e+01 -1.85692794e+00 -7.42981653e-01 -7.42981653e-01
 -7.42981653e-01  2.35709683e+00  2.65496917e+00  2.65496917e+00
  2.65496917e+00  1.99514104e+01  1.99514104e+01  1.99514104e+01
  3.20682598e+01  1.97728002e+02  1.02498894e+03  6.70797961e+03]
E1 = -182.19570704568872  E_coul = 53.91275955159884
cycle= 1 E= -128.28294749409  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266726
diis-c [-0.07114269  1.        ]
  HOMO = -0.809739802527524  LUMO = 2.31134998259247
  mo_energy =
[-3.28322277e+01 -1.92504113e+00 -8.09739803e-01 -8.09739803e-01
 -8.09739803e-01  2.31134998e+00  2.59921312e+00  2.59921312e+00
  2.59921312e+00  1.97572761e+01  1.97572761e+01  1.97572761e+01
  3.18543463e+01  1.97432900e+02  1.02464445e+03  6.70759501e+03]
E1 = -182.66685104498973  E_coul = 54.38222402676785
cycle= 2 E= -128.284627018222  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104712
diis-c [-2.41874796e-04  2.80000347e-01  7.19999653e-01]
  HOMO = -0.786578322043699  LUMO = 2.32929187851785
  mo_energy =
[-3.27563846e+01 -1.90107678e+00 -7.86578322e-01 -7.86578322e-01
 -7.86578322e-01  2.32929188e+00  2.62016864e+00  2.62016864e+00
  2.62016864e+00  1.98142740e+01  1.98142740e+01  1.98142740e+01
  3.19157078e+01  1.97512319e+02  1.02473128e+03  6.70768514e+03]
E1 = -182.53219615673348  E_coul = 54.24725323164796
cycle= 3 E= -128.284942925086  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691438
diis-c [-4.46744117e-08 -4.16750908e-03 -4.43556126e-03  1.00860307e+00]
  HOMO = -0.786762932054804  LUMO = 2.32914686374274
  mo_energy =
[-3.27568592e+01 -1.90129779e+00 -7.86762932e-01 -7.86762932e-01
 -7.86762932e-01  2.32914686e+00  2.62003910e+00  2.62003910e+00
  2.62003910e+00  1.98138971e+01  1.98138971e+01  1.98138971e+01
  3.19152698e+01  1.97511956e+02  1.02473108e+03  6.70768502e+03]
E1 = -182.53314173018956  E_coul = 54.248198788596355
cycle= 4 E= -128.284942941593  delta_E= -1.65e-08  |g|= 2.89e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.76483e-05
diis-c [-2.21862658e-10  2.75934297e-04 -3.21241699e-04 -9.88625347e-02
  1.09890784e+00]
  HOMO = -0.786753975528689  LUMO = 2.32914864027993
  mo_energy =
[-3.27568366e+01 -1.90129468e+00 -7.86753976e-01 -7.86753976e-01
 -7.86753976e-01  2.32914864e+00  2.62004672e+00  2.62004672e+00
  2.62004672e+00  1.98139149e+01  1.98139149e+01  1.98139149e+01
  3.19152863e+01  1.97511983e+02  1.02473111e+03  6.70768507e+03]
E1 = -182.53310446935686  E_coul = 54.24816152767506
cycle= 5 E= -128.284942941682  delta_E= -8.86e-11  |g|= 2.19e-06  |ddm|= 1.26e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53310446935686  E_coul = 54.24816152767506
  HOMO = -0.786753497555213  LUMO = 2.32914857268941
  mo_energy =
[-3.27568355e+01 -1.90129475e+00 -7.86753498e-01 -7.86753498e-01
 -7.86753498e-01  2.32914857e+00  2.62004715e+00  2.62004715e+00
  2.62004715e+00  1.98139158e+01  1.98139158e+01  1.98139158e+01
  3.19152871e+01  1.97511985e+02  1.02473112e+03  6.70768507e+03]
E1 = -182.5331027232242  E_coul = 54.24815978154173
Extra cycle  E= -128.284942941682  delta_E= -6.54e-13  |g|= 4.94e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.58565084717965
E1 = -182.5331027232242  E_coul = 54.24815978154173
init E= -128.284942941682
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786753591468062  LUMO = 2.32914841494343
  mo_energy =
[-3.27568359e+01 -1.90129495e+00 -7.86753591e-01 -7.86753591e-01
 -7.86753591e-01  2.32914841e+00  2.62004707e+00  2.62004707e+00
  2.62004707e+00  1.98139155e+01  1.98139155e+01  1.98139155e+01
  3.19152868e+01  1.97511984e+02  1.02473112e+03  6.70768507e+03]
E1 = -182.53310347104122  E_coul = 54.24816052935874
cycle= 1 E= -128.284942941682  delta_E=    0  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53310347104122  E_coul = 54.24816052935874
  HOMO = -0.78675353540764  LUMO = 2.32914844263821
  mo_energy =
[-3.27568357e+01 -1.90129491e+00 -7.86753535e-01 -7.86753535e-01
 -7.86753535e-01  2.32914844e+00  2.62004712e+00  2.62004712e+00
  2.62004712e+00  1.98139156e+01  1.98139156e+01  1.98139156e+01
  3.19152869e+01  1.97511984e+02  1.02473112e+03  6.70768507e+03]
E1 = -182.53310318331825  E_coul = 54.248160241635595
Extra cycle  E= -128.284942941683  delta_E= -1.99e-13  |g|= 4.29e-08  |ddm|= 4.8e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70768222e+03 1.26521316e+02 5.57077391e+02 5.23563672e-01
 3.52591948e+01 1.09206854e+01 1.77465902e+00 2.77594338e+00
 1.33302761e+01 6.00045348e-01]
grad_E = [ 5.63804088e-08  3.74801081e-06 -6.78875454e-07  3.30407760e-05
 -1.68430392e-05  2.80799476e-05  2.31255452e-05 -1.20823458e-04
  4.55586009e-05 -1.77956806e-04]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:00 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3702.39669213        1
[INPUT] 0    0    [1    /1   ]  126.493279131        1
[INPUT] 0    0    [1    /1   ]  556.810205897        1
[INPUT] 0    0    [1    /1   ]  0.523441680684       1
[INPUT] 0    0    [1    /1   ]  35.2580367109        1
[INPUT] 0    0    [1    /1   ]  10.9205187745        1
[INPUT] 0    0    [1    /1   ]  1.77423289567        1
[INPUT] 1    0    [1    /1   ]  2.77555094865        1
[INPUT] 1    0    [1    /1   ]  13.3254940903        1
[INPUT] 1    0    [1    /1   ]  0.600015977851       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3702.3966921307624, 1.0]], [0, [126.49327913074913, 1.0]], [0, [556.8102058968302, 1.0]], [0, [0.5234416806841232, 1.0]], [0, [35.25803671090749, 1.0]], [0, [10.920518774461137, 1.0]], [0, [1.774232895665988, 1.0]], [1, [2.7755509486526933, 1.0]], [1, [13.32549409032399, 1.0]], [1, [0.6000159778505053, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3702.39669213]
bas 1, expnt(s) = [126.49327913]
bas 2, expnt(s) = [556.8102059]
bas 3, expnt(s) = [0.52344168]
bas 4, expnt(s) = [35.25803671]
bas 5, expnt(s) = [10.92051877]
bas 6, expnt(s) = [1.7742329]
bas 7, expnt(s) = [2.77555095]
bas 8, expnt(s) = [13.32549409]
bas 9, expnt(s) = [0.60001598]
CPU time:       496.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70239669e+03 1.19916028e+03 1.26493279e+02 9.52940122e+01
 5.56810206e+02 2.89597904e+02 5.23441681e-01 1.55477035e+00
 3.52580367e+01 3.65559958e+01 1.09205188e+01 1.51774034e+01
 1.77423290e+00 3.88394431e+00 2.77555095e+00 1.04513140e+01
 1.33254941e+01 7.42742960e+01 6.00015978e-01 1.54059297e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966774036143951
cond(S) = 59.60924219247177
E1 = -183.2311506427295  E_coul = 55.008574585474165
init E= -128.222576057255
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742977904321176  LUMO = 2.35620702831704
  mo_energy =
[-3.25549156e+01 -1.85692653e+00 -7.42977904e-01 -7.42977904e-01
 -7.42977904e-01  2.35620703e+00  2.65472641e+00  2.65472641e+00
  2.65472641e+00  1.99450921e+01  1.99450921e+01  1.99450921e+01
  3.20648556e+01  1.97696577e+02  1.02458957e+03  6.70020898e+03]
E1 = -182.19556441471047  E_coul = 53.9126171356252
cycle= 1 E= -128.282947279085  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26676
diis-c [-0.07116069  1.        ]
  HOMO = -0.809749338065456  LUMO = 2.31046814677601
  mo_energy =
[-3.28322608e+01 -1.92505084e+00 -8.09749338e-01 -8.09749338e-01
 -8.09749338e-01  2.31046815e+00  2.59896467e+00  2.59896467e+00
  2.59896467e+00  1.97509669e+01  1.97509669e+01  1.97509669e+01
  3.18509257e+01  1.97401465e+02  1.02424508e+03  6.69982439e+03]
E1 = -182.66677732474898  E_coul = 54.38215018031733
cycle= 2 E= -128.284627144432  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10473
diis-c [-2.41742438e-04  2.80011230e-01  7.19988770e-01]
  HOMO = -0.786584546691049  LUMO = 2.32840770978199
  mo_energy =
[-3.27564089e+01 -1.90108303e+00 -7.86584547e-01 -7.86584547e-01
 -7.86584547e-01  2.32840771e+00  2.61992109e+00  2.61992109e+00
  2.61992109e+00  1.98079644e+01  1.98079644e+01  1.98079644e+01
  3.19122941e+01  1.97480891e+02  1.02433192e+03  6.69991452e+03]
E1 = -182.53209890214532  E_coul = 54.24715575248288
cycle= 3 E= -128.284943149662  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691303
diis-c [-4.44363765e-08 -4.16572348e-03 -4.43092172e-03  1.00859665e+00]
  HOMO = -0.786769130992285  LUMO = 2.32826288652159
  mo_energy =
[-3.27568833e+01 -1.90130386e+00 -7.86769131e-01 -7.86769131e-01
 -7.86769131e-01  2.32826289e+00  2.61979160e+00  2.61979160e+00
  2.61979160e+00  1.98075877e+01  1.98075877e+01  1.98075877e+01
  3.19118564e+01  1.97480528e+02  1.02433171e+03  6.69991441e+03]
E1 = -182.53304409892073  E_coul = 54.24810093277686
cycle= 4 E= -128.284943166144  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74706e-05
diis-c [-2.20423925e-10  2.75223674e-04 -3.19881661e-04 -9.86123804e-02
  1.09865704e+00]
  HOMO = -0.786760206530107  LUMO = 2.32826466136876
  mo_energy =
[-3.27568608e+01 -1.90130076e+00 -7.86760207e-01 -7.86760207e-01
 -7.86760207e-01  2.32826466e+00  2.61979919e+00  2.61979919e+00
  2.61979919e+00  1.98076054e+01  1.98076054e+01  1.98076054e+01
  3.19118729e+01  1.97480555e+02  1.02433175e+03  6.69991445e+03]
E1 = -182.53300696747786  E_coul = 54.24806380124588
cycle= 5 E= -128.284943166232  delta_E= -8.81e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53300696747786  E_coul = 54.24806380124588
  HOMO = -0.786759728679782  LUMO = 2.32826459475555
  mo_energy =
[-3.27568597e+01 -1.90130082e+00 -7.86759729e-01 -7.86759729e-01
 -7.86759729e-01  2.32826459e+00  2.61979962e+00  2.61979962e+00
  2.61979962e+00  1.98076063e+01  1.98076063e+01  1.98076063e+01
  3.19118737e+01  1.97480556e+02  1.02433175e+03  6.69991445e+03]
E1 = -182.53300522033885  E_coul = 54.24806205410636
Extra cycle  E= -128.284943166232  delta_E= -5.12e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70239669e+03 1.26493279e+02 5.56810206e+02 5.23441681e-01
 3.52580367e+01 1.09205188e+01 1.77423290e+00 2.77555095e+00
 1.33254941e+01 6.00015978e-01]
E = -128.2849431662325
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:01 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3702.39669213        1
[INPUT] 0    0    [1    /1   ]  126.493279131        1
[INPUT] 0    0    [1    /1   ]  556.810205897        1
[INPUT] 0    0    [1    /1   ]  0.523441680684       1
[INPUT] 0    0    [1    /1   ]  35.2580367109        1
[INPUT] 0    0    [1    /1   ]  10.9205187745        1
[INPUT] 0    0    [1    /1   ]  1.77423289567        1
[INPUT] 1    0    [1    /1   ]  2.77555094865        1
[INPUT] 1    0    [1    /1   ]  13.3254940903        1
[INPUT] 1    0    [1    /1   ]  0.600015977851       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3702.3966921307624, 1.0]], [0, [126.49327913074913, 1.0]], [0, [556.8102058968302, 1.0]], [0, [0.5234416806841232, 1.0]], [0, [35.25803671090749, 1.0]], [0, [10.920518774461137, 1.0]], [0, [1.774232895665988, 1.0]], [1, [2.7755509486526933, 1.0]], [1, [13.32549409032399, 1.0]], [1, [0.6000159778505053, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3702.39669213]
bas 1, expnt(s) = [126.49327913]
bas 2, expnt(s) = [556.8102059]
bas 3, expnt(s) = [0.52344168]
bas 4, expnt(s) = [35.25803671]
bas 5, expnt(s) = [10.92051877]
bas 6, expnt(s) = [1.7742329]
bas 7, expnt(s) = [2.77555095]
bas 8, expnt(s) = [13.32549409]
bas 9, expnt(s) = [0.60001598]
CPU time:       497.99
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70239669e+03 1.19916028e+03 1.26493279e+02 9.52940122e+01
 5.56810206e+02 2.89597904e+02 5.23441681e-01 1.55477035e+00
 3.52580367e+01 3.65559958e+01 1.09205188e+01 1.51774034e+01
 1.77423290e+00 3.88394431e+00 2.77555095e+00 1.04513140e+01
 1.33254941e+01 7.42742960e+01 6.00015978e-01 1.54059297e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966774036143951
cond(S) = 59.60924219247177
E1 = -183.2311506427295  E_coul = 55.008574585474165
init E= -128.222576057255
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742977904321176  LUMO = 2.35620702831704
  mo_energy =
[-3.25549156e+01 -1.85692653e+00 -7.42977904e-01 -7.42977904e-01
 -7.42977904e-01  2.35620703e+00  2.65472641e+00  2.65472641e+00
  2.65472641e+00  1.99450921e+01  1.99450921e+01  1.99450921e+01
  3.20648556e+01  1.97696577e+02  1.02458957e+03  6.70020898e+03]
E1 = -182.19556441471047  E_coul = 53.9126171356252
cycle= 1 E= -128.282947279085  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26676
diis-c [-0.07116069  1.        ]
  HOMO = -0.809749338065456  LUMO = 2.31046814677601
  mo_energy =
[-3.28322608e+01 -1.92505084e+00 -8.09749338e-01 -8.09749338e-01
 -8.09749338e-01  2.31046815e+00  2.59896467e+00  2.59896467e+00
  2.59896467e+00  1.97509669e+01  1.97509669e+01  1.97509669e+01
  3.18509257e+01  1.97401465e+02  1.02424508e+03  6.69982439e+03]
E1 = -182.66677732474898  E_coul = 54.38215018031733
cycle= 2 E= -128.284627144432  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.10473
diis-c [-2.41742438e-04  2.80011230e-01  7.19988770e-01]
  HOMO = -0.786584546691049  LUMO = 2.32840770978199
  mo_energy =
[-3.27564089e+01 -1.90108303e+00 -7.86584547e-01 -7.86584547e-01
 -7.86584547e-01  2.32840771e+00  2.61992109e+00  2.61992109e+00
  2.61992109e+00  1.98079644e+01  1.98079644e+01  1.98079644e+01
  3.19122941e+01  1.97480891e+02  1.02433192e+03  6.69991452e+03]
E1 = -182.53209890214532  E_coul = 54.24715575248288
cycle= 3 E= -128.284943149662  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691303
diis-c [-4.44363765e-08 -4.16572348e-03 -4.43092172e-03  1.00859665e+00]
  HOMO = -0.786769130992285  LUMO = 2.32826288652159
  mo_energy =
[-3.27568833e+01 -1.90130386e+00 -7.86769131e-01 -7.86769131e-01
 -7.86769131e-01  2.32826289e+00  2.61979160e+00  2.61979160e+00
  2.61979160e+00  1.98075877e+01  1.98075877e+01  1.98075877e+01
  3.19118564e+01  1.97480528e+02  1.02433171e+03  6.69991441e+03]
E1 = -182.53304409892073  E_coul = 54.24810093277686
cycle= 4 E= -128.284943166144  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74706e-05
diis-c [-2.20423925e-10  2.75223674e-04 -3.19881661e-04 -9.86123804e-02
  1.09865704e+00]
  HOMO = -0.786760206530107  LUMO = 2.32826466136876
  mo_energy =
[-3.27568608e+01 -1.90130076e+00 -7.86760207e-01 -7.86760207e-01
 -7.86760207e-01  2.32826466e+00  2.61979919e+00  2.61979919e+00
  2.61979919e+00  1.98076054e+01  1.98076054e+01  1.98076054e+01
  3.19118729e+01  1.97480555e+02  1.02433175e+03  6.69991445e+03]
E1 = -182.53300696747786  E_coul = 54.24806380124588
cycle= 5 E= -128.284943166232  delta_E= -8.81e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53300696747786  E_coul = 54.24806380124588
  HOMO = -0.786759728679782  LUMO = 2.32826459475555
  mo_energy =
[-3.27568597e+01 -1.90130082e+00 -7.86759729e-01 -7.86759729e-01
 -7.86759729e-01  2.32826459e+00  2.61979962e+00  2.61979962e+00
  2.61979962e+00  1.98076063e+01  1.98076063e+01  1.98076063e+01
  3.19118737e+01  1.97480556e+02  1.02433175e+03  6.69991445e+03]
E1 = -182.53300522033885  E_coul = 54.24806205410636
Extra cycle  E= -128.284943166232  delta_E= -5.12e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.60924219247177
E1 = -182.53300522033885  E_coul = 54.24806205410636
init E= -128.284943166232
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786759822719013  LUMO = 2.3282644371527
  mo_energy =
[-3.27568601e+01 -1.90130102e+00 -7.86759823e-01 -7.86759823e-01
 -7.86759823e-01  2.32826444e+00  2.61979953e+00  2.61979953e+00
  2.61979953e+00  1.98076060e+01  1.98076060e+01  1.98076060e+01
  3.19118733e+01  1.97480556e+02  1.02433175e+03  6.69991445e+03]
E1 = -182.53300596854018  E_coul = 54.24806280230779
cycle= 1 E= -128.284943166232  delta_E= 1.14e-13  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53300596854018  E_coul = 54.24806280230779
  HOMO = -0.786759766641929  LUMO = 2.32826446488794
  mo_energy =
[-3.27568599e+01 -1.90130098e+00 -7.86759767e-01 -7.86759767e-01
 -7.86759767e-01  2.32826446e+00  2.61979958e+00  2.61979958e+00
  2.61979958e+00  1.98076061e+01  1.98076061e+01  1.98076061e+01
  3.19118734e+01  1.97480556e+02  1.02433175e+03  6.69991445e+03]
E1 = -182.53300568064176  E_coul = 54.24806251440912
Extra cycle  E= -128.284943166233  delta_E= -2.56e-13  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70239669e+03 1.26493279e+02 5.56810206e+02 5.23441681e-01
 3.52580367e+01 1.09205188e+01 1.77423290e+00 2.77555095e+00
 1.33254941e+01 6.00015978e-01]
grad_E = [ 1.22698078e-08  1.49812313e-06 -2.89274596e-07 -2.34702303e-06
 -6.48199673e-06  1.44224397e-05  4.67031487e-06 -1.99973314e-05
  9.61547065e-06 -4.80512268e-05]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3702.74347671        1
[INPUT] 0    0    [1    /1   ]  126.507888077        1
[INPUT] 0    0    [1    /1   ]  556.921864958        1
[INPUT] 0    0    [1    /1   ]  0.523418884392       1
[INPUT] 0    0    [1    /1   ]  35.2605339495        1
[INPUT] 0    0    [1    /1   ]  10.9204969263        1
[INPUT] 0    0    [1    /1   ]  1.77415784136        1
[INPUT] 1    0    [1    /1   ]  2.77541467119        1
[INPUT] 1    0    [1    /1   ]  13.3239813857        1
[INPUT] 1    0    [1    /1   ]  0.600004858798       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3702.743476705276, 1.0]], [0, [126.50788807680725, 1.0]], [0, [556.9218649580142, 1.0]], [0, [0.5234188843916182, 1.0]], [0, [35.26053394946741, 1.0]], [0, [10.920496926271358, 1.0]], [0, [1.7741578413633898, 1.0]], [1, [2.775414671186782, 1.0]], [1, [13.323981385737413, 1.0]], [1, [0.6000048587980213, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3702.74347671]
bas 1, expnt(s) = [126.50788808]
bas 2, expnt(s) = [556.92186496]
bas 3, expnt(s) = [0.52341888]
bas 4, expnt(s) = [35.26053395]
bas 5, expnt(s) = [10.92049693]
bas 6, expnt(s) = [1.77415784]
bas 7, expnt(s) = [2.77541467]
bas 8, expnt(s) = [13.32398139]
bas 9, expnt(s) = [0.60000486]
CPU time:       501.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70274348e+03 1.19924452e+03 1.26507888e+02 9.53022663e+01
 5.56921865e+02 2.89641459e+02 5.23418884e-01 1.55471957e+00
 3.52605339e+01 3.65579376e+01 1.09204969e+01 1.51773806e+01
 1.77415784e+00 3.88382109e+00 2.77541467e+00 1.04506726e+01
 1.33239814e+01 7.42637566e+01 6.00004859e-01 1.54055728e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96677689219169
cond(S) = 59.59657249953738
E1 = -183.23116272285733  E_coul = 55.008573749184904
init E= -128.222588973672
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976833410964  LUMO = 2.35604439407806
  mo_energy =
[-3.25549204e+01 -1.85692554e+00 -7.42976833e-01 -7.42976833e-01
 -7.42976833e-01  2.35604439e+00  2.65463684e+00  2.65463684e+00
  2.65463684e+00  1.99430501e+01  1.99430501e+01  1.99430501e+01
  3.20655712e+01  1.97715043e+02  1.02476221e+03  6.70106919e+03]
E1 = -182.1955147352612  E_coul = 53.91256759557117
cycle= 1 E= -128.28294713969  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266771
diis-c [-0.07116675  1.        ]
  HOMO = -0.809752256087497  LUMO = 2.31030552291783
  mo_energy =
[-3.28322743e+01 -1.92505346e+00 -8.09752256e-01 -8.09752256e-01
 -8.09752256e-01  2.31030552e+00  2.59887363e+00  2.59887363e+00
  2.59887363e+00  1.97489263e+01  1.97489263e+01  1.97489263e+01
  3.18516304e+01  1.97419917e+02  1.02441770e+03  6.70068457e+03]
E1 = -182.66675172048764  E_coul = 54.38212459052081
cycle= 2 E= -128.284627129967  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104736
diis-c [-2.41703935e-04  2.80014132e-01  7.19985868e-01]
  HOMO = -0.78658629139239  LUMO = 2.32824515141772
  mo_energy =
[-3.27564192e+01 -1.90108441e+00 -7.86586291e-01 -7.86586291e-01
 -7.86586291e-01  2.32824515e+00  2.61983035e+00  2.61983035e+00
  2.61983035e+00  1.98059240e+01  1.98059240e+01  1.98059240e+01
  3.19130024e+01  1.97499346e+02  1.02450455e+03  6.70077471e+03]
E1 = -182.53206520010397  E_coul = 54.24712203085097
cycle= 3 E= -128.284943169253  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691297
diis-c [-4.43638392e-08 -4.16437627e-03 -4.42702541e-03  1.00859140e+00]
  HOMO = -0.786770877738998  LUMO = 2.32810036563333
  mo_energy =
[-3.27568936e+01 -1.90130521e+00 -7.86770878e-01 -7.86770878e-01
 -7.86770878e-01  2.32810037e+00  2.61970086e+00  2.61970086e+00
  2.61970086e+00  1.98055473e+01  1.98055473e+01  1.98055473e+01
  3.19125647e+01  1.97498983e+02  1.02450434e+03  6.70077460e+03]
E1 = -182.53301036271662  E_coul = 54.248067176986794
cycle= 4 E= -128.28494318573  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74241e-05
diis-c [-2.20030714e-10  2.75092374e-04 -3.19626363e-04 -9.85794244e-02
  1.09862396e+00]
  HOMO = -0.786761962058077  LUMO = 2.32810213905081
  mo_energy =
[-3.27568711e+01 -1.90130210e+00 -7.86761962e-01 -7.86761962e-01
 -7.86761962e-01  2.32810214e+00  2.61970845e+00  2.61970845e+00
  2.61970845e+00  1.98055651e+01  1.98055651e+01  1.98055651e+01
  3.19125811e+01  1.97499010e+02  1.02450438e+03  6.70077464e+03]
E1 = -182.53297326758684  E_coul = 54.24803008176909
cycle= 5 E= -128.284943185818  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297326758684  E_coul = 54.24803008176909
  HOMO = -0.78676148433507  LUMO = 2.32810207268024
  mo_energy =
[-3.27568699e+01 -1.90130216e+00 -7.86761484e-01 -7.86761484e-01
 -7.86761484e-01  2.32810207e+00  2.61970888e+00  2.61970888e+00
  2.61970888e+00  1.98055659e+01  1.98055659e+01  1.98055659e+01
  3.19125819e+01  1.97499012e+02  1.02450438e+03  6.70077464e+03]
E1 = -182.5329715205174  E_coul = 54.24802833469896
Extra cycle  E= -128.284943185818  delta_E= -7.11e-13  |g|= 4.93e-07  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70274348e+03 1.26507888e+02 5.56921865e+02 5.23418884e-01
 3.52605339e+01 1.09204969e+01 1.77415784e+00 2.77541467e+00
 1.33239814e+01 6.00004859e-01]
E = -128.28494318581846
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:07 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3702.74347671        1
[INPUT] 0    0    [1    /1   ]  126.507888077        1
[INPUT] 0    0    [1    /1   ]  556.921864958        1
[INPUT] 0    0    [1    /1   ]  0.523418884392       1
[INPUT] 0    0    [1    /1   ]  35.2605339495        1
[INPUT] 0    0    [1    /1   ]  10.9204969263        1
[INPUT] 0    0    [1    /1   ]  1.77415784136        1
[INPUT] 1    0    [1    /1   ]  2.77541467119        1
[INPUT] 1    0    [1    /1   ]  13.3239813857        1
[INPUT] 1    0    [1    /1   ]  0.600004858798       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3702.743476705276, 1.0]], [0, [126.50788807680725, 1.0]], [0, [556.9218649580142, 1.0]], [0, [0.5234188843916182, 1.0]], [0, [35.26053394946741, 1.0]], [0, [10.920496926271358, 1.0]], [0, [1.7741578413633898, 1.0]], [1, [2.775414671186782, 1.0]], [1, [13.323981385737413, 1.0]], [1, [0.6000048587980213, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3702.74347671]
bas 1, expnt(s) = [126.50788808]
bas 2, expnt(s) = [556.92186496]
bas 3, expnt(s) = [0.52341888]
bas 4, expnt(s) = [35.26053395]
bas 5, expnt(s) = [10.92049693]
bas 6, expnt(s) = [1.77415784]
bas 7, expnt(s) = [2.77541467]
bas 8, expnt(s) = [13.32398139]
bas 9, expnt(s) = [0.60000486]
CPU time:       503.10
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70274348e+03 1.19924452e+03 1.26507888e+02 9.53022663e+01
 5.56921865e+02 2.89641459e+02 5.23418884e-01 1.55471957e+00
 3.52605339e+01 3.65579376e+01 1.09204969e+01 1.51773806e+01
 1.77415784e+00 3.88382109e+00 2.77541467e+00 1.04506726e+01
 1.33239814e+01 7.42637566e+01 6.00004859e-01 1.54055728e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96677689219169
cond(S) = 59.59657249953738
E1 = -183.23116272285733  E_coul = 55.008573749184904
init E= -128.222588973672
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976833410964  LUMO = 2.35604439407806
  mo_energy =
[-3.25549204e+01 -1.85692554e+00 -7.42976833e-01 -7.42976833e-01
 -7.42976833e-01  2.35604439e+00  2.65463684e+00  2.65463684e+00
  2.65463684e+00  1.99430501e+01  1.99430501e+01  1.99430501e+01
  3.20655712e+01  1.97715043e+02  1.02476221e+03  6.70106919e+03]
E1 = -182.1955147352612  E_coul = 53.91256759557117
cycle= 1 E= -128.28294713969  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266771
diis-c [-0.07116675  1.        ]
  HOMO = -0.809752256087497  LUMO = 2.31030552291783
  mo_energy =
[-3.28322743e+01 -1.92505346e+00 -8.09752256e-01 -8.09752256e-01
 -8.09752256e-01  2.31030552e+00  2.59887363e+00  2.59887363e+00
  2.59887363e+00  1.97489263e+01  1.97489263e+01  1.97489263e+01
  3.18516304e+01  1.97419917e+02  1.02441770e+03  6.70068457e+03]
E1 = -182.66675172048764  E_coul = 54.38212459052081
cycle= 2 E= -128.284627129967  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104736
diis-c [-2.41703935e-04  2.80014132e-01  7.19985868e-01]
  HOMO = -0.78658629139239  LUMO = 2.32824515141772
  mo_energy =
[-3.27564192e+01 -1.90108441e+00 -7.86586291e-01 -7.86586291e-01
 -7.86586291e-01  2.32824515e+00  2.61983035e+00  2.61983035e+00
  2.61983035e+00  1.98059240e+01  1.98059240e+01  1.98059240e+01
  3.19130024e+01  1.97499346e+02  1.02450455e+03  6.70077471e+03]
E1 = -182.53206520010397  E_coul = 54.24712203085097
cycle= 3 E= -128.284943169253  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691297
diis-c [-4.43638392e-08 -4.16437627e-03 -4.42702541e-03  1.00859140e+00]
  HOMO = -0.786770877738998  LUMO = 2.32810036563333
  mo_energy =
[-3.27568936e+01 -1.90130521e+00 -7.86770878e-01 -7.86770878e-01
 -7.86770878e-01  2.32810037e+00  2.61970086e+00  2.61970086e+00
  2.61970086e+00  1.98055473e+01  1.98055473e+01  1.98055473e+01
  3.19125647e+01  1.97498983e+02  1.02450434e+03  6.70077460e+03]
E1 = -182.53301036271662  E_coul = 54.248067176986794
cycle= 4 E= -128.28494318573  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74241e-05
diis-c [-2.20030714e-10  2.75092374e-04 -3.19626363e-04 -9.85794244e-02
  1.09862396e+00]
  HOMO = -0.786761962058077  LUMO = 2.32810213905081
  mo_energy =
[-3.27568711e+01 -1.90130210e+00 -7.86761962e-01 -7.86761962e-01
 -7.86761962e-01  2.32810214e+00  2.61970845e+00  2.61970845e+00
  2.61970845e+00  1.98055651e+01  1.98055651e+01  1.98055651e+01
  3.19125811e+01  1.97499010e+02  1.02450438e+03  6.70077464e+03]
E1 = -182.53297326758684  E_coul = 54.24803008176909
cycle= 5 E= -128.284943185818  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297326758684  E_coul = 54.24803008176909
  HOMO = -0.78676148433507  LUMO = 2.32810207268024
  mo_energy =
[-3.27568699e+01 -1.90130216e+00 -7.86761484e-01 -7.86761484e-01
 -7.86761484e-01  2.32810207e+00  2.61970888e+00  2.61970888e+00
  2.61970888e+00  1.98055659e+01  1.98055659e+01  1.98055659e+01
  3.19125819e+01  1.97499012e+02  1.02450438e+03  6.70077464e+03]
E1 = -182.5329715205174  E_coul = 54.24802833469896
Extra cycle  E= -128.284943185818  delta_E= -7.11e-13  |g|= 4.93e-07  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.59657249953738
E1 = -182.5329715205174  E_coul = 54.24802833469896
init E= -128.284943185818
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786761578388776  LUMO = 2.32810191513695
  mo_energy =
[-3.27568703e+01 -1.90130237e+00 -7.86761578e-01 -7.86761578e-01
 -7.86761578e-01  2.32810192e+00  2.61970879e+00  2.61970879e+00
  2.61970879e+00  1.98055656e+01  1.98055656e+01  1.98055656e+01
  3.19125815e+01  1.97499011e+02  1.02450438e+03  6.70077464e+03]
E1 = -182.53297226867178  E_coul = 54.24802908285333
cycle= 1 E= -128.284943185818  delta_E=    0  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53297226867178  E_coul = 54.24802908285333
  HOMO = -0.786761522318214  LUMO = 2.32810194287735
  mo_energy =
[-3.27568702e+01 -1.90130233e+00 -7.86761522e-01 -7.86761522e-01
 -7.86761522e-01  2.32810194e+00  2.61970884e+00  2.61970884e+00
  2.61970884e+00  1.98055657e+01  1.98055657e+01  1.98055657e+01
  3.19125817e+01  1.97499011e+02  1.02450438e+03  6.70077464e+03]
E1 = -182.5329719807823  E_coul = 54.24802879496387
Extra cycle  E= -128.284943185818  delta_E= 5.68e-14  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [3.70274348e+03 1.26507888e+02 5.56921865e+02 5.23418884e-01
 3.52605339e+01 1.09204969e+01 1.77415784e+00 2.77541467e+00
 1.33239814e+01 6.00004859e-01]
grad_E = [ 3.53469623e-09  4.02325238e-07 -9.98095262e-08 -2.64472747e-06
 -6.57143323e-07 -1.13873342e-06  1.10634700e-06  4.33233993e-06
 -8.96638988e-07  1.24171876e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.22593779        1
[INPUT] 0    0    [1    /1   ]  126.520987303        1
[INPUT] 0    0    [1    /1   ]  557.007337782        1
[INPUT] 0    0    [1    /1   ]  0.523420159959       1
[INPUT] 0    0    [1    /1   ]  35.2635320846        1
[INPUT] 0    0    [1    /1   ]  10.9211941167        1
[INPUT] 0    0    [1    /1   ]  1.77415219131        1
[INPUT] 1    0    [1    /1   ]  2.77540430911        1
[INPUT] 1    0    [1    /1   ]  13.3238884972        1
[INPUT] 1    0    [1    /1   ]  0.600003717035       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.2259377922437, 1.0]], [0, [126.52098730324701, 1.0]], [0, [557.0073377820988, 1.0]], [0, [0.5234201599592014, 1.0]], [0, [35.26353208463967, 1.0]], [0, [10.921194116713938, 1.0]], [0, [1.7741521913079645, 1.0]], [1, [2.7754043091092364, 1.0]], [1, [13.323888497191389, 1.0]], [1, [0.6000037170349009, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.22593779]
bas 1, expnt(s) = [126.5209873]
bas 2, expnt(s) = [557.00733778]
bas 3, expnt(s) = [0.52342016]
bas 4, expnt(s) = [35.26353208]
bas 5, expnt(s) = [10.92119412]
bas 6, expnt(s) = [1.77415219]
bas 7, expnt(s) = [2.77540431]
bas 8, expnt(s) = [13.3238885]
bas 9, expnt(s) = [0.60000372]
CPU time:       506.52
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70322594e+03 1.19936171e+03 1.26520987e+02 9.53096673e+01
 5.57007338e+02 2.89674797e+02 5.23420160e-01 1.55472241e+00
 3.52635321e+01 3.65602689e+01 1.09211941e+01 1.51781073e+01
 1.77415219e+00 3.88381181e+00 2.77540431e+00 1.04506238e+01
 1.33238885e+01 7.42631095e+01 6.00003717e-01 1.54055362e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96677707404428
cond(S) = 59.590108354057534
E1 = -183.23116377909196  E_coul = 55.00857475574108
init E= -128.222589023351
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976705041216  LUMO = 2.35605527843728
  mo_energy =
[-3.25549202e+01 -1.85692562e+00 -7.42976705e-01 -7.42976705e-01
 -7.42976705e-01  2.35605528e+00  2.65462886e+00  2.65462886e+00
  2.65462886e+00  1.99429172e+01  1.99429172e+01  1.99429172e+01
  3.20683769e+01  1.97736588e+02  1.02490774e+03  6.70201977e+03]
E1 = -182.195512484294  E_coul = 53.912565352378266
cycle= 1 E= -128.282947131916  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26677
diis-c [-0.07116624  1.        ]
  HOMO = -0.809752519437822  LUMO = 2.31031534535795
  mo_energy =
[-3.28322740e+01 -1.92505406e+00 -8.09752519e-01 -8.09752519e-01
 -8.09752519e-01  2.31031535e+00  2.59886551e+00  2.59886551e+00
  2.59886551e+00  1.97487938e+01  1.97487938e+01  1.97487938e+01
  3.18544285e+01  1.97441459e+02  1.02456323e+03  6.70163516e+03]
E1 = -182.6667511430847  E_coul = 54.38212401307873
cycle= 2 E= -128.284627130006  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104736
diis-c [-2.41708911e-04  2.80014914e-01  7.19985086e-01]
  HOMO = -0.786586486232394  LUMO = 2.32825519913706
  mo_energy =
[-3.27564188e+01 -1.90108494e+00 -7.86586486e-01 -7.86586486e-01
 -7.86586486e-01  2.32825520e+00  2.61982223e+00  2.61982223e+00
  2.61982223e+00  1.98057915e+01  1.98057915e+01  1.98057915e+01
  3.19158023e+01  1.97520889e+02  1.02465008e+03  6.70172529e+03]
E1 = -182.53206416686095  E_coul = 54.24712099528698
cycle= 3 E= -128.284943171574  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00069122
diis-c [-4.43657837e-08 -4.16462552e-03 -4.42848912e-03  1.00859311e+00]
  HOMO = -0.786771052312317  LUMO = 2.32811042479684
  mo_energy =
[-3.27568931e+01 -1.90130572e+00 -7.86771052e-01 -7.86771052e-01
 -7.86771052e-01  2.32811042e+00  2.61969276e+00  2.61969276e+00
  2.61969276e+00  1.98054148e+01  1.98054148e+01  1.98054148e+01
  3.19153646e+01  1.97520526e+02  1.02464987e+03  6.70172518e+03]
E1 = -182.53300923384182  E_coul = 54.24806604579379
cycle= 4 E= -128.284943188048  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.7429e-05
diis-c [-2.20057603e-10  2.75148538e-04 -3.19507396e-04 -9.85889974e-02
  1.09863336e+00]
  HOMO = -0.786762135594943  LUMO = 2.32811219836802
  mo_energy =
[-3.27568706e+01 -1.90130261e+00 -7.86762136e-01 -7.86762136e-01
 -7.86762136e-01  2.32811220e+00  2.61970035e+00  2.61970035e+00
  2.61970035e+00  1.98054326e+01  1.98054326e+01  1.98054326e+01
  3.19153811e+01  1.97520554e+02  1.02464991e+03  6.70172523e+03]
E1 = -182.532972134726  E_coul = 54.24802894659005
cycle= 5 E= -128.284943188136  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.532972134726  E_coul = 54.24802894659005
  HOMO = -0.786761657883335  LUMO = 2.32811213197061
  mo_energy =
[-3.27568695e+01 -1.90130267e+00 -7.86761658e-01 -7.86761658e-01
 -7.86761658e-01  2.32811213e+00  2.61970078e+00  2.61970078e+00
  2.61970078e+00  1.98054334e+01  1.98054334e+01  1.98054334e+01
  3.19153819e+01  1.97520555e+02  1.02464991e+03  6.70172523e+03]
E1 = -182.53297038770017  E_coul = 54.24802719956361
Extra cycle  E= -128.284943188137  delta_E= -5.97e-13  |g|= 4.93e-07  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70322594e+03 1.26520987e+02 5.57007338e+02 5.23420160e-01
 3.52635321e+01 1.09211941e+01 1.77415219e+00 2.77540431e+00
 1.33238885e+01 6.00003717e-01]
E = -128.28494318813657
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.22593779        1
[INPUT] 0    0    [1    /1   ]  126.520987303        1
[INPUT] 0    0    [1    /1   ]  557.007337782        1
[INPUT] 0    0    [1    /1   ]  0.523420159959       1
[INPUT] 0    0    [1    /1   ]  35.2635320846        1
[INPUT] 0    0    [1    /1   ]  10.9211941167        1
[INPUT] 0    0    [1    /1   ]  1.77415219131        1
[INPUT] 1    0    [1    /1   ]  2.77540430911        1
[INPUT] 1    0    [1    /1   ]  13.3238884972        1
[INPUT] 1    0    [1    /1   ]  0.600003717035       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.2259377922437, 1.0]], [0, [126.52098730324701, 1.0]], [0, [557.0073377820988, 1.0]], [0, [0.5234201599592014, 1.0]], [0, [35.26353208463967, 1.0]], [0, [10.921194116713938, 1.0]], [0, [1.7741521913079645, 1.0]], [1, [2.7754043091092364, 1.0]], [1, [13.323888497191389, 1.0]], [1, [0.6000037170349009, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.22593779]
bas 1, expnt(s) = [126.5209873]
bas 2, expnt(s) = [557.00733778]
bas 3, expnt(s) = [0.52342016]
bas 4, expnt(s) = [35.26353208]
bas 5, expnt(s) = [10.92119412]
bas 6, expnt(s) = [1.77415219]
bas 7, expnt(s) = [2.77540431]
bas 8, expnt(s) = [13.3238885]
bas 9, expnt(s) = [0.60000372]
CPU time:       508.19
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70322594e+03 1.19936171e+03 1.26520987e+02 9.53096673e+01
 5.57007338e+02 2.89674797e+02 5.23420160e-01 1.55472241e+00
 3.52635321e+01 3.65602689e+01 1.09211941e+01 1.51781073e+01
 1.77415219e+00 3.88381181e+00 2.77540431e+00 1.04506238e+01
 1.33238885e+01 7.42631095e+01 6.00003717e-01 1.54055362e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96677707404428
cond(S) = 59.590108354057534
E1 = -183.23116377909196  E_coul = 55.00857475574108
init E= -128.222589023351
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976705041216  LUMO = 2.35605527843728
  mo_energy =
[-3.25549202e+01 -1.85692562e+00 -7.42976705e-01 -7.42976705e-01
 -7.42976705e-01  2.35605528e+00  2.65462886e+00  2.65462886e+00
  2.65462886e+00  1.99429172e+01  1.99429172e+01  1.99429172e+01
  3.20683769e+01  1.97736588e+02  1.02490774e+03  6.70201977e+03]
E1 = -182.195512484294  E_coul = 53.912565352378266
cycle= 1 E= -128.282947131916  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.26677
diis-c [-0.07116624  1.        ]
  HOMO = -0.809752519437822  LUMO = 2.31031534535795
  mo_energy =
[-3.28322740e+01 -1.92505406e+00 -8.09752519e-01 -8.09752519e-01
 -8.09752519e-01  2.31031535e+00  2.59886551e+00  2.59886551e+00
  2.59886551e+00  1.97487938e+01  1.97487938e+01  1.97487938e+01
  3.18544285e+01  1.97441459e+02  1.02456323e+03  6.70163516e+03]
E1 = -182.6667511430847  E_coul = 54.38212401307873
cycle= 2 E= -128.284627130006  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104736
diis-c [-2.41708911e-04  2.80014914e-01  7.19985086e-01]
  HOMO = -0.786586486232394  LUMO = 2.32825519913706
  mo_energy =
[-3.27564188e+01 -1.90108494e+00 -7.86586486e-01 -7.86586486e-01
 -7.86586486e-01  2.32825520e+00  2.61982223e+00  2.61982223e+00
  2.61982223e+00  1.98057915e+01  1.98057915e+01  1.98057915e+01
  3.19158023e+01  1.97520889e+02  1.02465008e+03  6.70172529e+03]
E1 = -182.53206416686095  E_coul = 54.24712099528698
cycle= 3 E= -128.284943171574  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.00069122
diis-c [-4.43657837e-08 -4.16462552e-03 -4.42848912e-03  1.00859311e+00]
  HOMO = -0.786771052312317  LUMO = 2.32811042479684
  mo_energy =
[-3.27568931e+01 -1.90130572e+00 -7.86771052e-01 -7.86771052e-01
 -7.86771052e-01  2.32811042e+00  2.61969276e+00  2.61969276e+00
  2.61969276e+00  1.98054148e+01  1.98054148e+01  1.98054148e+01
  3.19153646e+01  1.97520526e+02  1.02464987e+03  6.70172518e+03]
E1 = -182.53300923384182  E_coul = 54.24806604579379
cycle= 4 E= -128.284943188048  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.7429e-05
diis-c [-2.20057603e-10  2.75148538e-04 -3.19507396e-04 -9.85889974e-02
  1.09863336e+00]
  HOMO = -0.786762135594943  LUMO = 2.32811219836802
  mo_energy =
[-3.27568706e+01 -1.90130261e+00 -7.86762136e-01 -7.86762136e-01
 -7.86762136e-01  2.32811220e+00  2.61970035e+00  2.61970035e+00
  2.61970035e+00  1.98054326e+01  1.98054326e+01  1.98054326e+01
  3.19153811e+01  1.97520554e+02  1.02464991e+03  6.70172523e+03]
E1 = -182.532972134726  E_coul = 54.24802894659005
cycle= 5 E= -128.284943188136  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.532972134726  E_coul = 54.24802894659005
  HOMO = -0.786761657883335  LUMO = 2.32811213197061
  mo_energy =
[-3.27568695e+01 -1.90130267e+00 -7.86761658e-01 -7.86761658e-01
 -7.86761658e-01  2.32811213e+00  2.61970078e+00  2.61970078e+00
  2.61970078e+00  1.98054334e+01  1.98054334e+01  1.98054334e+01
  3.19153819e+01  1.97520555e+02  1.02464991e+03  6.70172523e+03]
E1 = -182.53297038770017  E_coul = 54.24802719956361
Extra cycle  E= -128.284943188137  delta_E= -5.97e-13  |g|= 4.93e-07  |ddm|= 1.22e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.590108354057534
E1 = -182.53297038770017  E_coul = 54.24802719956361
init E= -128.284943188137
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786761751933046  LUMO = 2.32811197442486
  mo_energy =
[-3.27568699e+01 -1.90130288e+00 -7.86761752e-01 -7.86761752e-01
 -7.86761752e-01  2.32811197e+00  2.61970069e+00  2.61970069e+00
  2.61970069e+00  1.98054331e+01  1.98054331e+01  1.98054331e+01
  3.19153815e+01  1.97520554e+02  1.02464991e+03  6.70172523e+03]
E1 = -182.53297113583807  E_coul = 54.248027947701566
cycle= 1 E= -128.284943188137  delta_E= 5.68e-14  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53297113583807  E_coul = 54.248027947701566
  HOMO = -0.786761695863372  LUMO = 2.3281120021641
  mo_energy =
[-3.27568697e+01 -1.90130284e+00 -7.86761696e-01 -7.86761696e-01
 -7.86761696e-01  2.32811200e+00  2.61970074e+00  2.61970074e+00
  2.61970074e+00  1.98054333e+01  1.98054333e+01  1.98054333e+01
  3.19153816e+01  1.97520555e+02  1.02464991e+03  6.70172523e+03]
E1 = -182.532970847955  E_coul = 54.24802765981841
Extra cycle  E= -128.284943188137  delta_E= -8.53e-14  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70322594e+03 1.26520987e+02 5.57007338e+02 5.23420160e-01
 3.52635321e+01 1.09211941e+01 1.77415219e+00 2.77540431e+00
 1.33238885e+01 6.00003717e-01]
grad_E = [ 6.76260621e-10  5.56717854e-08 -2.29197032e-08 -6.55677491e-06
 -1.37466372e-08  7.66178324e-07  9.69070655e-08  5.06016185e-06
 -1.41711087e-06  3.56367868e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:15 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.36209124        1
[INPUT] 0    0    [1    /1   ]  126.52275073         1
[INPUT] 0    0    [1    /1   ]  557.028061661        1
[INPUT] 0    0    [1    /1   ]  0.523426294892       1
[INPUT] 0    0    [1    /1   ]  35.2635101684        1
[INPUT] 0    0    [1    /1   ]  10.9211243081        1
[INPUT] 0    0    [1    /1   ]  1.77417006303        1
[INPUT] 1    0    [1    /1   ]  2.7754115253         1
[INPUT] 1    0    [1    /1   ]  13.3240139422        1
[INPUT] 1    0    [1    /1   ]  0.600003930326       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.362091240609, 1.0]], [0, [126.52275073047142, 1.0]], [0, [557.0280616607829, 1.0]], [0, [0.523426294891643, 1.0]], [0, [35.26351016837169, 1.0]], [0, [10.921124308128968, 1.0]], [0, [1.7741700630261619, 1.0]], [1, [2.7754115253028657, 1.0]], [1, [13.3240139421837, 1.0]], [1, [0.6000039303263369, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.36209124]
bas 1, expnt(s) = [126.52275073]
bas 2, expnt(s) = [557.02806166]
bas 3, expnt(s) = [0.52342629]
bas 4, expnt(s) = [35.26351017]
bas 5, expnt(s) = [10.92112431]
bas 6, expnt(s) = [1.77417006]
bas 7, expnt(s) = [2.77541153]
bas 8, expnt(s) = [13.32401394]
bas 9, expnt(s) = [0.60000393]
CPU time:       511.63
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70336209e+03 1.19939479e+03 1.26522751e+02 9.53106636e+01
 5.57028062e+02 2.89682880e+02 5.23426295e-01 1.55473608e+00
 3.52635102e+01 3.65602519e+01 1.09211243e+01 1.51780345e+01
 1.77417006e+00 3.88384115e+00 2.77541153e+00 1.04506578e+01
 1.33240139e+01 7.42639834e+01 6.00003930e-01 1.54055430e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776953531827
cond(S) = 59.58826367998848
E1 = -183.23116409003148  E_coul = 55.008574243439625
init E= -128.222589846592
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976844068268  LUMO = 2.35609471550932
  mo_energy =
[-3.25549201e+01 -1.85692559e+00 -7.42976844e-01 -7.42976844e-01
 -7.42976844e-01  2.35609472e+00  2.65463167e+00  2.65463167e+00
  2.65463167e+00  1.99430715e+01  1.99430715e+01  1.99430715e+01
  3.20683440e+01  1.97737919e+02  1.02493547e+03  6.70226722e+03]
E1 = -182.19551531352377  E_coul = 53.912568172761155
cycle= 1 E= -128.282947140763  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116573  1.        ]
  HOMO = -0.809752224331567  LUMO = 2.3103542938353
  mo_energy =
[-3.28322738e+01 -1.92505378e+00 -8.09752224e-01 -8.09752224e-01
 -8.09752224e-01  2.31035429e+00  2.59886858e+00  2.59886858e+00
  2.59886858e+00  1.97489477e+01  1.97489477e+01  1.97489477e+01
  3.18543962e+01  1.97442789e+02  1.02459095e+03  6.70188261e+03]
E1 = -182.66675253332545  E_coul = 54.38212540091007
cycle= 2 E= -128.284627132415  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41705991e-04  2.80014865e-01  7.19985135e-01]
  HOMO = -0.786586266574644  LUMO = 2.32829428560031
  mo_energy =
[-3.27564187e+01 -1.90108473e+00 -7.86586267e-01 -7.86586267e-01
 -7.86586267e-01  2.32829429e+00  2.61982526e+00  2.61982526e+00
  2.61982526e+00  1.98059454e+01  1.98059454e+01  1.98059454e+01
  3.19157697e+01  1.97522219e+02  1.02467780e+03  6.70197275e+03]
E1 = -182.53206613219905  E_coul = 54.24712296036878
cycle= 3 E= -128.28494317183  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691188
diis-c [-4.43772821e-08 -4.16481815e-03 -4.42941245e-03  1.00859423e+00]
  HOMO = -0.786770823583451  LUMO = 2.32814950751366
  mo_energy =
[-3.27568931e+01 -1.90130552e+00 -7.86770824e-01 -7.86770824e-01
 -7.86770824e-01  2.32814951e+00  2.61969581e+00  2.61969581e+00
  2.61969581e+00  1.98055687e+01  1.98055687e+01  1.98055687e+01
  3.19153321e+01  1.97521856e+02  1.02467759e+03  6.70197263e+03]
E1 = -182.53301116668715  E_coul = 54.248067978382515
cycle= 4 E= -128.284943188305  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74405e-05
diis-c [-2.20149864e-10  2.75243385e-04 -3.19492752e-04 -9.86163119e-02
  1.09866056e+00]
  HOMO = -0.786761904820794  LUMO = 2.32815128086244
  mo_energy =
[-3.27568705e+01 -1.90130241e+00 -7.86761905e-01 -7.86761905e-01
 -7.86761905e-01  2.32815128e+00  2.61970339e+00  2.61970339e+00
  2.61970339e+00  1.98055865e+01  1.98055865e+01  1.98055865e+01
  3.19153485e+01  1.97521883e+02  1.02467763e+03  6.70197268e+03]
E1 = -182.5329740599993  E_coul = 54.24803087160695
cycle= 5 E= -128.284943188392  delta_E= -8.77e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329740599993  E_coul = 54.24803087160695
  HOMO = -0.786761427145634  LUMO = 2.32815121438758
  mo_energy =
[-3.27568694e+01 -1.90130247e+00 -7.86761427e-01 -7.86761427e-01
 -7.86761427e-01  2.32815121e+00  2.61970382e+00  2.61970382e+00
  2.61970382e+00  1.98055873e+01  1.98055873e+01  1.98055873e+01
  3.19153493e+01  1.97521885e+02  1.02467763e+03  6.70197268e+03]
E1 = -182.53297231323478  E_coul = 54.24802912484178
Extra cycle  E= -128.284943188393  delta_E= -6.54e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70336209e+03 1.26522751e+02 5.57028062e+02 5.23426295e-01
 3.52635102e+01 1.09211243e+01 1.77417006e+00 2.77541153e+00
 1.33240139e+01 6.00003930e-01]
E = -128.28494318839302
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:17 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.36209124        1
[INPUT] 0    0    [1    /1   ]  126.52275073         1
[INPUT] 0    0    [1    /1   ]  557.028061661        1
[INPUT] 0    0    [1    /1   ]  0.523426294892       1
[INPUT] 0    0    [1    /1   ]  35.2635101684        1
[INPUT] 0    0    [1    /1   ]  10.9211243081        1
[INPUT] 0    0    [1    /1   ]  1.77417006303        1
[INPUT] 1    0    [1    /1   ]  2.7754115253         1
[INPUT] 1    0    [1    /1   ]  13.3240139422        1
[INPUT] 1    0    [1    /1   ]  0.600003930326       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.362091240609, 1.0]], [0, [126.52275073047142, 1.0]], [0, [557.0280616607829, 1.0]], [0, [0.523426294891643, 1.0]], [0, [35.26351016837169, 1.0]], [0, [10.921124308128968, 1.0]], [0, [1.7741700630261619, 1.0]], [1, [2.7754115253028657, 1.0]], [1, [13.3240139421837, 1.0]], [1, [0.6000039303263369, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.36209124]
bas 1, expnt(s) = [126.52275073]
bas 2, expnt(s) = [557.02806166]
bas 3, expnt(s) = [0.52342629]
bas 4, expnt(s) = [35.26351017]
bas 5, expnt(s) = [10.92112431]
bas 6, expnt(s) = [1.77417006]
bas 7, expnt(s) = [2.77541153]
bas 8, expnt(s) = [13.32401394]
bas 9, expnt(s) = [0.60000393]
CPU time:       513.35
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70336209e+03 1.19939479e+03 1.26522751e+02 9.53106636e+01
 5.57028062e+02 2.89682880e+02 5.23426295e-01 1.55473608e+00
 3.52635102e+01 3.65602519e+01 1.09211243e+01 1.51780345e+01
 1.77417006e+00 3.88384115e+00 2.77541153e+00 1.04506578e+01
 1.33240139e+01 7.42639834e+01 6.00003930e-01 1.54055430e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776953531827
cond(S) = 59.58826367998848
E1 = -183.23116409003148  E_coul = 55.008574243439625
init E= -128.222589846592
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976844068268  LUMO = 2.35609471550932
  mo_energy =
[-3.25549201e+01 -1.85692559e+00 -7.42976844e-01 -7.42976844e-01
 -7.42976844e-01  2.35609472e+00  2.65463167e+00  2.65463167e+00
  2.65463167e+00  1.99430715e+01  1.99430715e+01  1.99430715e+01
  3.20683440e+01  1.97737919e+02  1.02493547e+03  6.70226722e+03]
E1 = -182.19551531352377  E_coul = 53.912568172761155
cycle= 1 E= -128.282947140763  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116573  1.        ]
  HOMO = -0.809752224331567  LUMO = 2.3103542938353
  mo_energy =
[-3.28322738e+01 -1.92505378e+00 -8.09752224e-01 -8.09752224e-01
 -8.09752224e-01  2.31035429e+00  2.59886858e+00  2.59886858e+00
  2.59886858e+00  1.97489477e+01  1.97489477e+01  1.97489477e+01
  3.18543962e+01  1.97442789e+02  1.02459095e+03  6.70188261e+03]
E1 = -182.66675253332545  E_coul = 54.38212540091007
cycle= 2 E= -128.284627132415  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41705991e-04  2.80014865e-01  7.19985135e-01]
  HOMO = -0.786586266574644  LUMO = 2.32829428560031
  mo_energy =
[-3.27564187e+01 -1.90108473e+00 -7.86586267e-01 -7.86586267e-01
 -7.86586267e-01  2.32829429e+00  2.61982526e+00  2.61982526e+00
  2.61982526e+00  1.98059454e+01  1.98059454e+01  1.98059454e+01
  3.19157697e+01  1.97522219e+02  1.02467780e+03  6.70197275e+03]
E1 = -182.53206613219905  E_coul = 54.24712296036878
cycle= 3 E= -128.28494317183  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691188
diis-c [-4.43772821e-08 -4.16481815e-03 -4.42941245e-03  1.00859423e+00]
  HOMO = -0.786770823583451  LUMO = 2.32814950751366
  mo_energy =
[-3.27568931e+01 -1.90130552e+00 -7.86770824e-01 -7.86770824e-01
 -7.86770824e-01  2.32814951e+00  2.61969581e+00  2.61969581e+00
  2.61969581e+00  1.98055687e+01  1.98055687e+01  1.98055687e+01
  3.19153321e+01  1.97521856e+02  1.02467759e+03  6.70197263e+03]
E1 = -182.53301116668715  E_coul = 54.248067978382515
cycle= 4 E= -128.284943188305  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74405e-05
diis-c [-2.20149864e-10  2.75243385e-04 -3.19492752e-04 -9.86163119e-02
  1.09866056e+00]
  HOMO = -0.786761904820794  LUMO = 2.32815128086244
  mo_energy =
[-3.27568705e+01 -1.90130241e+00 -7.86761905e-01 -7.86761905e-01
 -7.86761905e-01  2.32815128e+00  2.61970339e+00  2.61970339e+00
  2.61970339e+00  1.98055865e+01  1.98055865e+01  1.98055865e+01
  3.19153485e+01  1.97521883e+02  1.02467763e+03  6.70197268e+03]
E1 = -182.5329740599993  E_coul = 54.24803087160695
cycle= 5 E= -128.284943188392  delta_E= -8.77e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329740599993  E_coul = 54.24803087160695
  HOMO = -0.786761427145634  LUMO = 2.32815121438758
  mo_energy =
[-3.27568694e+01 -1.90130247e+00 -7.86761427e-01 -7.86761427e-01
 -7.86761427e-01  2.32815121e+00  2.61970382e+00  2.61970382e+00
  2.61970382e+00  1.98055873e+01  1.98055873e+01  1.98055873e+01
  3.19153493e+01  1.97521885e+02  1.02467763e+03  6.70197268e+03]
E1 = -182.53297231323478  E_coul = 54.24802912484178
Extra cycle  E= -128.284943188393  delta_E= -6.54e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.58826367998848
E1 = -182.53297231323478  E_coul = 54.24802912484178
init E= -128.284943188393
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.78676152117473  LUMO = 2.328151056846
  mo_energy =
[-3.27568698e+01 -1.90130267e+00 -7.86761521e-01 -7.86761521e-01
 -7.86761521e-01  2.32815106e+00  2.61970373e+00  2.61970373e+00
  2.61970373e+00  1.98055871e+01  1.98055871e+01  1.98055871e+01
  3.19153490e+01  1.97521884e+02  1.02467763e+03  6.70197268e+03]
E1 = -182.53297306126964  E_coul = 54.24802987287653
cycle= 1 E= -128.284943188393  delta_E= -1.14e-13  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53297306126964  E_coul = 54.24802987287653
  HOMO = -0.786761465111646  LUMO = 2.32815108457863
  mo_energy =
[-3.27568696e+01 -1.90130264e+00 -7.86761465e-01 -7.86761465e-01
 -7.86761465e-01  2.32815108e+00  2.61970378e+00  2.61970378e+00
  2.61970378e+00  1.98055872e+01  1.98055872e+01  1.98055872e+01
  3.19153491e+01  1.97521884e+02  1.02467763e+03  6.70197268e+03]
E1 = -182.53297277342833  E_coul = 54.24802958503513
Extra cycle  E= -128.284943188393  delta_E= -5.68e-14  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70336209e+03 1.26522751e+02 5.57028062e+02 5.23426295e-01
 3.52635102e+01 1.09211243e+01 1.77417006e+00 2.77541153e+00
 1.33240139e+01 6.00003930e-01]
grad_E = [ 2.00206571e-11 -5.46079167e-09  4.74614231e-10 -5.46624033e-07
  1.10705310e-07 -4.66590317e-07  8.31876132e-08  7.53550960e-07
 -2.64113130e-07  1.13147952e-06]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:20 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35012634        1
[INPUT] 0    0    [1    /1   ]  126.522568394        1
[INPUT] 0    0    [1    /1   ]  557.026756644        1
[INPUT] 0    0    [1    /1   ]  0.523427125118       1
[INPUT] 0    0    [1    /1   ]  35.2635069457        1
[INPUT] 0    0    [1    /1   ]  10.9211432473        1
[INPUT] 0    0    [1    /1   ]  1.77417179682        1
[INPUT] 1    0    [1    /1   ]  2.77541419058        1
[INPUT] 1    0    [1    /1   ]  13.3240472884        1
[INPUT] 1    0    [1    /1   ]  0.600004100623       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3501263423127, 1.0]], [0, [126.52256839359912, 1.0]], [0, [557.0267566443015, 1.0]], [0, [0.5234271251179231, 1.0]], [0, [35.26350694567495, 1.0]], [0, [10.921143247265213, 1.0]], [0, [1.774171796818352, 1.0]], [1, [2.775414190578405, 1.0]], [1, [13.324047288412885, 1.0]], [1, [0.6000041006232935, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35012634]
bas 1, expnt(s) = [126.52256839]
bas 2, expnt(s) = [557.02675664]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350695]
bas 5, expnt(s) = [10.92114325]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404729]
bas 9, expnt(s) = [0.6000041]
CPU time:       516.80
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335013e+03 1.19939188e+03 1.26522568e+02 9.53105606e+01
 5.57026757e+02 2.89682371e+02 5.23427125e-01 1.55473793e+00
 3.52635069e+01 3.65602494e+01 1.09211432e+01 1.51780543e+01
 1.77417180e+00 3.88384400e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642158e+01 6.00004101e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901671329
cond(S) = 59.58853803729759
E1 = -183.2311638918979  E_coul = 55.00857425065739
init E= -128.222589641241
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868521556  LUMO = 2.35609989047888
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609989e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683921e+01  1.97737835e+02  1.02493354e+03  6.70224706e+03]
E1 = -182.19551639151365  E_coul = 53.91256924732765
cycle= 1 E= -128.282947144186  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182334  LUMO = 2.31035941555706
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544444e+01  1.97442704e+02  1.02458903e+03  6.70186245e+03]
E1 = -182.666753101933  E_coul = 54.382125968780166
cycle= 2 E= -128.284627133153  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41706999e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227522259  LUMO = 2.32829941504308
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158179e+01  1.97522135e+02  1.02467587e+03  6.70195259e+03]
E1 = -182.53206688249517  E_coul = 54.2471237106565
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802474e-08 -4.16488683e-03 -4.42968107e-03  1.00859457e+00]
  HOMO = -0.786770782600819  LUMO = 2.3281546365292
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815464e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153802e+01  1.97521772e+02  1.02467567e+03  6.70195248e+03]
E1 = -182.53301190973008  E_coul = 54.24806872141724
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169382e-10  2.75257213e-04 -3.19490535e-04 -9.86197532e-02
  1.09866399e+00]
  HOMO = -0.78676186340011  LUMO = 2.32815640989686
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815641e+00  2.61970497e+00  2.61970497e+00
  2.61970497e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153967e+01  1.97521799e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.5329748013408  E_coul = 54.248031612940125
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329748013408  E_coul = 54.248031612940125
  HOMO = -0.786761385723822  LUMO = 2.3281563434086
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815634e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056310e+01  1.98056310e+01  1.98056310e+01
  3.19153975e+01  1.97521800e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.53297305459304  E_coul = 54.248029866191786
Extra cycle  E= -128.284943188401  delta_E= -5.68e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70335013e+03 1.26522568e+02 5.57026757e+02 5.23427125e-01
 3.52635069e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004101e-01]
E = -128.28494318840126
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:22 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35012634        1
[INPUT] 0    0    [1    /1   ]  126.522568394        1
[INPUT] 0    0    [1    /1   ]  557.026756644        1
[INPUT] 0    0    [1    /1   ]  0.523427125118       1
[INPUT] 0    0    [1    /1   ]  35.2635069457        1
[INPUT] 0    0    [1    /1   ]  10.9211432473        1
[INPUT] 0    0    [1    /1   ]  1.77417179682        1
[INPUT] 1    0    [1    /1   ]  2.77541419058        1
[INPUT] 1    0    [1    /1   ]  13.3240472884        1
[INPUT] 1    0    [1    /1   ]  0.600004100623       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3501263423127, 1.0]], [0, [126.52256839359912, 1.0]], [0, [557.0267566443015, 1.0]], [0, [0.5234271251179231, 1.0]], [0, [35.26350694567495, 1.0]], [0, [10.921143247265213, 1.0]], [0, [1.774171796818352, 1.0]], [1, [2.775414190578405, 1.0]], [1, [13.324047288412885, 1.0]], [1, [0.6000041006232935, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35012634]
bas 1, expnt(s) = [126.52256839]
bas 2, expnt(s) = [557.02675664]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350695]
bas 5, expnt(s) = [10.92114325]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404729]
bas 9, expnt(s) = [0.6000041]
CPU time:       518.48
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335013e+03 1.19939188e+03 1.26522568e+02 9.53105606e+01
 5.57026757e+02 2.89682371e+02 5.23427125e-01 1.55473793e+00
 3.52635069e+01 3.65602494e+01 1.09211432e+01 1.51780543e+01
 1.77417180e+00 3.88384400e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642158e+01 6.00004101e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901671329
cond(S) = 59.58853803729759
E1 = -183.2311638918979  E_coul = 55.00857425065739
init E= -128.222589641241
    CPU time for initialize scf      0.03 sec, wall time      0.03 sec
  HOMO = -0.742976868521556  LUMO = 2.35609989047888
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609989e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683921e+01  1.97737835e+02  1.02493354e+03  6.70224706e+03]
E1 = -182.19551639151365  E_coul = 53.91256924732765
cycle= 1 E= -128.282947144186  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182334  LUMO = 2.31035941555706
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544444e+01  1.97442704e+02  1.02458903e+03  6.70186245e+03]
E1 = -182.666753101933  E_coul = 54.382125968780166
cycle= 2 E= -128.284627133153  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41706999e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227522259  LUMO = 2.32829941504308
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158179e+01  1.97522135e+02  1.02467587e+03  6.70195259e+03]
E1 = -182.53206688249517  E_coul = 54.2471237106565
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.02 sec, wall time      0.02 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802474e-08 -4.16488683e-03 -4.42968107e-03  1.00859457e+00]
  HOMO = -0.786770782600819  LUMO = 2.3281546365292
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815464e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153802e+01  1.97521772e+02  1.02467567e+03  6.70195248e+03]
E1 = -182.53301190973008  E_coul = 54.24806872141724
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169382e-10  2.75257213e-04 -3.19490535e-04 -9.86197532e-02
  1.09866399e+00]
  HOMO = -0.78676186340011  LUMO = 2.32815640989686
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815641e+00  2.61970497e+00  2.61970497e+00
  2.61970497e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153967e+01  1.97521799e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.5329748013408  E_coul = 54.248031612940125
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329748013408  E_coul = 54.248031612940125
  HOMO = -0.786761385723822  LUMO = 2.3281563434086
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815634e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056310e+01  1.98056310e+01  1.98056310e+01
  3.19153975e+01  1.97521800e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.53297305459304  E_coul = 54.248029866191786
Extra cycle  E= -128.284943188401  delta_E= -5.68e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.11 sec, wall time      0.11 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.58853803729759
E1 = -182.53297305459304  E_coul = 54.248029866191786
init E= -128.284943188401
    CPU time for initialize scf      0.07 sec, wall time      0.07 sec
  HOMO = -0.786761479750955  LUMO = 2.32815618586553
  mo_energy =
[-3.27568696e+01 -1.90130267e+00 -7.86761480e-01 -7.86761480e-01
 -7.86761480e-01  2.32815619e+00  2.61970531e+00  2.61970531e+00
  2.61970531e+00  1.98056308e+01  1.98056308e+01  1.98056308e+01
  3.19153971e+01  1.97521800e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.532973802622  E_coul = 54.24803061422067
cycle= 1 E= -128.284943188401  delta_E= -5.68e-14  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.02 sec
E1 = -182.532973802622  E_coul = 54.24803061422067
  HOMO = -0.786761423688105  LUMO = 2.32815621359751
  mo_energy =
[-3.27568694e+01 -1.90130263e+00 -7.86761424e-01 -7.86761424e-01
 -7.86761424e-01  2.32815621e+00  2.61970536e+00  2.61970536e+00
  2.61970536e+00  1.98056309e+01  1.98056309e+01  1.98056309e+01
  3.19153972e+01  1.97521800e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.53297351478346  E_coul = 54.248030326382114
Extra cycle  E= -128.284943188401  delta_E= -2.84e-14  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.13 sec, wall time      0.13 sec
exp = [3.70335013e+03 1.26522568e+02 5.57026757e+02 5.23427125e-01
 3.52635069e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004101e-01]
grad_E = [ 2.79703202e-13  1.51856680e-09 -4.93653894e-11 -1.55311668e-07
 -3.12544002e-09  6.14421591e-09  2.56384087e-08  7.35710124e-08
 -1.08810989e-08 -1.74358448e-08]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:26 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34756353        1
[INPUT] 0    0    [1    /1   ]  126.522494832        1
[INPUT] 0    0    [1    /1   ]  557.026380398        1
[INPUT] 0    0    [1    /1   ]  0.523427189058       1
[INPUT] 0    0    [1    /1   ]  35.2634929311        1
[INPUT] 0    0    [1    /1   ]  10.92114073          1
[INPUT] 0    0    [1    /1   ]  1.7741718859         1
[INPUT] 1    0    [1    /1   ]  2.77541413253        1
[INPUT] 1    0    [1    /1   ]  13.3240477865        1
[INPUT] 1    0    [1    /1   ]  0.600004084556       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.347563533214, 1.0]], [0, [126.5224948320328, 1.0]], [0, [557.0263803983102, 1.0]], [0, [0.5234271890581065, 1.0]], [0, [35.26349293112287, 1.0]], [0, [10.921140730042383, 1.0]], [0, [1.7741718859005136, 1.0]], [1, [2.7754141325345394, 1.0]], [1, [13.324047786525629, 1.0]], [1, [0.6000040845562433, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34756353]
bas 1, expnt(s) = [126.52249483]
bas 2, expnt(s) = [557.0263804]
bas 3, expnt(s) = [0.52342719]
bas 4, expnt(s) = [35.26349293]
bas 5, expnt(s) = [10.92114073]
bas 6, expnt(s) = [1.77417189]
bas 7, expnt(s) = [2.77541413]
bas 8, expnt(s) = [13.32404779]
bas 9, expnt(s) = [0.60000408]
CPU time:       522.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334756e+03 1.19939126e+03 1.26522495e+02 9.53105190e+01
 5.57026380e+02 2.89682225e+02 5.23427189e-01 1.55473807e+00
 3.52634929e+01 3.65602385e+01 1.09211407e+01 1.51780517e+01
 1.77417189e+00 3.88384415e+00 2.77541413e+00 1.04506701e+01
 1.33240478e+01 7.42642192e+01 6.00004085e-01 1.54055480e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776904571685
cond(S) = 59.58857795761376
E1 = -183.23116389054215  E_coul = 55.008574237569626
init E= -128.222589652973
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976869878723  LUMO = 2.35610016923529
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976870e-01 -7.42976870e-01
 -7.42976870e-01  2.35610017e+00  2.65463312e+00  2.65463312e+00
  2.65463312e+00  1.99431155e+01  1.99431155e+01  1.99431155e+01
  3.20683811e+01  1.97737727e+02  1.02493285e+03  6.70224226e+03]
E1 = -182.19551636177601  E_coul = 53.912569217670594
cycle= 1 E= -128.282947144105  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159181546  LUMO = 2.31035968925094
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035969e+00  2.59887008e+00  2.59887008e+00
  2.59887008e+00  1.97489917e+01  1.97489917e+01  1.97489917e+01
  3.18544334e+01  1.97442597e+02  1.02458834e+03  6.70185765e+03]
E1 = -182.66675308256518  E_coul = 54.3821259494241
cycle= 2 E= -128.284627133141  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707039e-04  2.80014858e-01  7.19985142e-01]
  HOMO = -0.786586227121137  LUMO = 2.32829968971298
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829969e+00  2.61982675e+00  2.61982675e+00
  2.61982675e+00  1.98059893e+01  1.98059893e+01  1.98059893e+01
  3.19158070e+01  1.97522027e+02  1.02467518e+03  6.70194778e+03]
E1 = -182.53206686131534  E_coul = 54.247123689476695
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43805421e-08 -4.16489129e-03 -4.42970170e-03  1.00859459e+00]
  HOMO = -0.786770782006152  LUMO = 2.32815491114829
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770782e-01 -7.86770782e-01
 -7.86770782e-01  2.32815491e+00  2.61969729e+00  2.61969729e+00
  2.61969729e+00  1.98056127e+01  1.98056127e+01  1.98056127e+01
  3.19153693e+01  1.97521665e+02  1.02467498e+03  6.70194767e+03]
E1 = -182.5330118879156  E_coul = 54.24806869960269
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74431e-05
diis-c [-2.20171556e-10  2.75259325e-04 -3.19489843e-04 -9.86203155e-02
  1.09866455e+00]
  HOMO = -0.786761862760444  LUMO = 2.32815668451065
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815668e+00  2.61970488e+00  2.61970488e+00
  2.61970488e+00  1.98056305e+01  1.98056305e+01  1.98056305e+01
  3.19153858e+01  1.97521692e+02  1.02467502e+03  6.70194772e+03]
E1 = -182.53297477936258  E_coul = 54.24803159096216
cycle= 5 E= -128.2849431884  delta_E= -8.75e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297477936258  E_coul = 54.24803159096216
  HOMO = -0.786761385084711  LUMO = 2.32815661802067
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761385e-01 -7.86761385e-01
 -7.86761385e-01  2.32815662e+00  2.61970531e+00  2.61970531e+00
  2.61970531e+00  1.98056313e+01  1.98056313e+01  1.98056313e+01
  3.19153865e+01  1.97521693e+02  1.02467502e+03  6.70194772e+03]
E1 = -182.53297303262  E_coul = 54.24802984421891
Extra cycle  E= -128.284943188401  delta_E= -6.82e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70334756e+03 1.26522495e+02 5.57026380e+02 5.23427189e-01
 3.52634929e+01 1.09211407e+01 1.77417189e+00 2.77541413e+00
 1.33240478e+01 6.00004085e-01]
E = -128.2849431884011
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34756353        1
[INPUT] 0    0    [1    /1   ]  126.522494832        1
[INPUT] 0    0    [1    /1   ]  557.026380398        1
[INPUT] 0    0    [1    /1   ]  0.523427189058       1
[INPUT] 0    0    [1    /1   ]  35.2634929311        1
[INPUT] 0    0    [1    /1   ]  10.92114073          1
[INPUT] 0    0    [1    /1   ]  1.7741718859         1
[INPUT] 1    0    [1    /1   ]  2.77541413253        1
[INPUT] 1    0    [1    /1   ]  13.3240477865        1
[INPUT] 1    0    [1    /1   ]  0.600004084556       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.347563533214, 1.0]], [0, [126.5224948320328, 1.0]], [0, [557.0263803983102, 1.0]], [0, [0.5234271890581065, 1.0]], [0, [35.26349293112287, 1.0]], [0, [10.921140730042383, 1.0]], [0, [1.7741718859005136, 1.0]], [1, [2.7754141325345394, 1.0]], [1, [13.324047786525629, 1.0]], [1, [0.6000040845562433, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34756353]
bas 1, expnt(s) = [126.52249483]
bas 2, expnt(s) = [557.0263804]
bas 3, expnt(s) = [0.52342719]
bas 4, expnt(s) = [35.26349293]
bas 5, expnt(s) = [10.92114073]
bas 6, expnt(s) = [1.77417189]
bas 7, expnt(s) = [2.77541413]
bas 8, expnt(s) = [13.32404779]
bas 9, expnt(s) = [0.60000408]
CPU time:       524.00
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334756e+03 1.19939126e+03 1.26522495e+02 9.53105190e+01
 5.57026380e+02 2.89682225e+02 5.23427189e-01 1.55473807e+00
 3.52634929e+01 3.65602385e+01 1.09211407e+01 1.51780517e+01
 1.77417189e+00 3.88384415e+00 2.77541413e+00 1.04506701e+01
 1.33240478e+01 7.42642192e+01 6.00004085e-01 1.54055480e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776904571685
cond(S) = 59.58857795761376
E1 = -183.23116389054215  E_coul = 55.008574237569626
init E= -128.222589652973
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976869878723  LUMO = 2.35610016923529
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976870e-01 -7.42976870e-01
 -7.42976870e-01  2.35610017e+00  2.65463312e+00  2.65463312e+00
  2.65463312e+00  1.99431155e+01  1.99431155e+01  1.99431155e+01
  3.20683811e+01  1.97737727e+02  1.02493285e+03  6.70224226e+03]
E1 = -182.19551636177601  E_coul = 53.912569217670594
cycle= 1 E= -128.282947144105  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159181546  LUMO = 2.31035968925094
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035969e+00  2.59887008e+00  2.59887008e+00
  2.59887008e+00  1.97489917e+01  1.97489917e+01  1.97489917e+01
  3.18544334e+01  1.97442597e+02  1.02458834e+03  6.70185765e+03]
E1 = -182.66675308256518  E_coul = 54.3821259494241
cycle= 2 E= -128.284627133141  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707039e-04  2.80014858e-01  7.19985142e-01]
  HOMO = -0.786586227121137  LUMO = 2.32829968971298
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829969e+00  2.61982675e+00  2.61982675e+00
  2.61982675e+00  1.98059893e+01  1.98059893e+01  1.98059893e+01
  3.19158070e+01  1.97522027e+02  1.02467518e+03  6.70194778e+03]
E1 = -182.53206686131534  E_coul = 54.247123689476695
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43805421e-08 -4.16489129e-03 -4.42970170e-03  1.00859459e+00]
  HOMO = -0.786770782006152  LUMO = 2.32815491114829
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770782e-01 -7.86770782e-01
 -7.86770782e-01  2.32815491e+00  2.61969729e+00  2.61969729e+00
  2.61969729e+00  1.98056127e+01  1.98056127e+01  1.98056127e+01
  3.19153693e+01  1.97521665e+02  1.02467498e+03  6.70194767e+03]
E1 = -182.5330118879156  E_coul = 54.24806869960269
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74431e-05
diis-c [-2.20171556e-10  2.75259325e-04 -3.19489843e-04 -9.86203155e-02
  1.09866455e+00]
  HOMO = -0.786761862760444  LUMO = 2.32815668451065
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815668e+00  2.61970488e+00  2.61970488e+00
  2.61970488e+00  1.98056305e+01  1.98056305e+01  1.98056305e+01
  3.19153858e+01  1.97521692e+02  1.02467502e+03  6.70194772e+03]
E1 = -182.53297477936258  E_coul = 54.24803159096216
cycle= 5 E= -128.2849431884  delta_E= -8.75e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297477936258  E_coul = 54.24803159096216
  HOMO = -0.786761385084711  LUMO = 2.32815661802067
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761385e-01 -7.86761385e-01
 -7.86761385e-01  2.32815662e+00  2.61970531e+00  2.61970531e+00
  2.61970531e+00  1.98056313e+01  1.98056313e+01  1.98056313e+01
  3.19153865e+01  1.97521693e+02  1.02467502e+03  6.70194772e+03]
E1 = -182.53297303262  E_coul = 54.24802984421891
Extra cycle  E= -128.284943188401  delta_E= -6.82e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.58857795761376
E1 = -182.53297303262  E_coul = 54.24802984421891
init E= -128.284943188401
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.78676147911142  LUMO = 2.32815646047765
  mo_energy =
[-3.27568696e+01 -1.90130267e+00 -7.86761479e-01 -7.86761479e-01
 -7.86761479e-01  2.32815646e+00  2.61970522e+00  2.61970522e+00
  2.61970522e+00  1.98056310e+01  1.98056310e+01  1.98056310e+01
  3.19153862e+01  1.97521693e+02  1.02467502e+03  6.70194772e+03]
E1 = -182.53297378064727  E_coul = 54.24803059224599
cycle= 1 E= -128.284943188401  delta_E= -1.99e-13  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53297378064727  E_coul = 54.24803059224599
  HOMO = -0.786761423048702  LUMO = 2.32815648820952
  mo_energy =
[-3.27568694e+01 -1.90130264e+00 -7.86761423e-01 -7.86761423e-01
 -7.86761423e-01  2.32815649e+00  2.61970527e+00  2.61970527e+00
  2.61970527e+00  1.98056312e+01  1.98056312e+01  1.98056312e+01
  3.19153863e+01  1.97521693e+02  1.02467502e+03  6.70194772e+03]
E1 = -182.53297349280933  E_coul = 54.24803030440805
Extra cycle  E= -128.284943188401  delta_E=    0  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [3.70334756e+03 1.26522495e+02 5.57026380e+02 5.23427189e-01
 3.52634929e+01 1.09211407e+01 1.77417189e+00 2.77541413e+00
 1.33240478e+01 6.00004085e-01]
grad_E = [ 1.49472015e-13  5.63696159e-10 -4.30352151e-11 -2.51060044e-08
 -1.68419989e-09  2.09664053e-09  5.74273429e-09  1.37255292e-08
 -5.98598726e-10 -1.44762993e-08]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:31 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34996215        1
[INPUT] 0    0    [1    /1   ]  126.522563681        1
[INPUT] 0    0    [1    /1   ]  557.026732539        1
[INPUT] 0    0    [1    /1   ]  0.523427129214       1
[INPUT] 0    0    [1    /1   ]  35.2635060478        1
[INPUT] 0    0    [1    /1   ]  10.921143086         1
[INPUT] 0    0    [1    /1   ]  1.77417180253        1
[INPUT] 1    0    [1    /1   ]  2.77541418686        1
[INPUT] 1    0    [1    /1   ]  13.3240473203        1
[INPUT] 1    0    [1    /1   ]  0.600004099594       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.349962148962, 1.0]], [0, [126.52256368067685, 1.0]], [0, [557.0267325390764, 1.0]], [0, [0.5234271292144252, 1.0]], [0, [35.263506047794465, 1.0]], [0, [10.92114308599247, 1.0]], [0, [1.7741718025256434, 1.0]], [1, [2.7754141868596665, 1.0]], [1, [13.324047320325835, 1.0]], [1, [0.6000040995939141, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34996215]
bas 1, expnt(s) = [126.52256368]
bas 2, expnt(s) = [557.02673254]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350605]
bas 5, expnt(s) = [10.92114309]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404732]
bas 9, expnt(s) = [0.6000041]
CPU time:       527.66
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334996e+03 1.19939184e+03 1.26522564e+02 9.53105579e+01
 5.57026733e+02 2.89682362e+02 5.23427129e-01 1.55473794e+00
 3.52635060e+01 3.65602487e+01 1.09211431e+01 1.51780541e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642160e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901857147
cond(S) = 59.58854059489975
E1 = -183.23116389181106  E_coul = 55.00857424981881
init E= -128.222589641992
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868608503  LUMO = 2.35609990833816
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609991e+00  2.65463320e+00  2.65463320e+00
  2.65463320e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683914e+01  1.97737828e+02  1.02493350e+03  6.70224676e+03]
E1 = -182.19551638960826  E_coul = 53.91256924542765
cycle= 1 E= -128.282947144181  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182273  LUMO = 2.31035943309201
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035943e+00  2.59887016e+00  2.59887016e+00
  2.59887016e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544437e+01  1.97442698e+02  1.02458898e+03  6.70186214e+03]
E1 = -182.66675310069198  E_coul = 54.382125967540105
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707001e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227496564  LUMO = 2.32829943264052
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829943e+00  2.61982683e+00  2.61982683e+00
  2.61982683e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158172e+01  1.97522128e+02  1.02467583e+03  6.70195228e+03]
E1 = -182.53206688113798  E_coul = 54.24712370929946
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802668e-08 -4.16488706e-03 -4.42968225e-03  1.00859457e+00]
  HOMO = -0.786770782562662  LUMO = 2.32815465412353
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153795e+01  1.97521765e+02  1.02467563e+03  6.70195217e+03]
E1 = -182.5330119083318  E_coul = 54.24806872001907
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169528e-10  2.75257370e-04 -3.19490449e-04 -9.86197923e-02
  1.09866403e+00]
  HOMO = -0.786761863359082  LUMO = 2.32815642749074
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815643e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153960e+01  1.97521792e+02  1.02467566e+03  6.70195221e+03]
E1 = -182.53297479993262  E_coul = 54.248031611531935
cycle= 5 E= -128.284943188401  delta_E= -8.8e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297479993262  E_coul = 54.248031611531935
  HOMO = -0.786761385682884  LUMO = 2.32815636100231
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815636e+00  2.61970539e+00  2.61970539e+00
  2.61970539e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153968e+01  1.97521794e+02  1.02467566e+03  6.70195221e+03]
E1 = -182.53297305318515  E_coul = 54.24802986478411
Extra cycle  E= -128.284943188401  delta_E= -3.41e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70334996e+03 1.26522564e+02 5.57026733e+02 5.23427129e-01
 3.52635060e+01 1.09211431e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
E = -128.28494318840103
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:33 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34996215        1
[INPUT] 0    0    [1    /1   ]  126.522563681        1
[INPUT] 0    0    [1    /1   ]  557.026732539        1
[INPUT] 0    0    [1    /1   ]  0.523427129214       1
[INPUT] 0    0    [1    /1   ]  35.2635060478        1
[INPUT] 0    0    [1    /1   ]  10.921143086         1
[INPUT] 0    0    [1    /1   ]  1.77417180253        1
[INPUT] 1    0    [1    /1   ]  2.77541418686        1
[INPUT] 1    0    [1    /1   ]  13.3240473203        1
[INPUT] 1    0    [1    /1   ]  0.600004099594       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.349962148962, 1.0]], [0, [126.52256368067685, 1.0]], [0, [557.0267325390764, 1.0]], [0, [0.5234271292144252, 1.0]], [0, [35.263506047794465, 1.0]], [0, [10.92114308599247, 1.0]], [0, [1.7741718025256434, 1.0]], [1, [2.7754141868596665, 1.0]], [1, [13.324047320325835, 1.0]], [1, [0.6000040995939141, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34996215]
bas 1, expnt(s) = [126.52256368]
bas 2, expnt(s) = [557.02673254]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350605]
bas 5, expnt(s) = [10.92114309]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404732]
bas 9, expnt(s) = [0.6000041]
CPU time:       529.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334996e+03 1.19939184e+03 1.26522564e+02 9.53105579e+01
 5.57026733e+02 2.89682362e+02 5.23427129e-01 1.55473794e+00
 3.52635060e+01 3.65602487e+01 1.09211431e+01 1.51780541e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642160e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901857147
cond(S) = 59.58854059489975
E1 = -183.23116389181106  E_coul = 55.00857424981881
init E= -128.222589641992
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868608503  LUMO = 2.35609990833816
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609991e+00  2.65463320e+00  2.65463320e+00
  2.65463320e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683914e+01  1.97737828e+02  1.02493350e+03  6.70224676e+03]
E1 = -182.19551638960826  E_coul = 53.91256924542765
cycle= 1 E= -128.282947144181  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182273  LUMO = 2.31035943309201
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035943e+00  2.59887016e+00  2.59887016e+00
  2.59887016e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544437e+01  1.97442698e+02  1.02458898e+03  6.70186214e+03]
E1 = -182.66675310069198  E_coul = 54.382125967540105
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707001e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227496564  LUMO = 2.32829943264052
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829943e+00  2.61982683e+00  2.61982683e+00
  2.61982683e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158172e+01  1.97522128e+02  1.02467583e+03  6.70195228e+03]
E1 = -182.53206688113798  E_coul = 54.24712370929946
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802668e-08 -4.16488706e-03 -4.42968225e-03  1.00859457e+00]
  HOMO = -0.786770782562662  LUMO = 2.32815465412353
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153795e+01  1.97521765e+02  1.02467563e+03  6.70195217e+03]
E1 = -182.5330119083318  E_coul = 54.24806872001907
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169528e-10  2.75257370e-04 -3.19490449e-04 -9.86197923e-02
  1.09866403e+00]
  HOMO = -0.786761863359082  LUMO = 2.32815642749074
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815643e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153960e+01  1.97521792e+02  1.02467566e+03  6.70195221e+03]
E1 = -182.53297479993262  E_coul = 54.248031611531935
cycle= 5 E= -128.284943188401  delta_E= -8.8e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297479993262  E_coul = 54.248031611531935
  HOMO = -0.786761385682884  LUMO = 2.32815636100231
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815636e+00  2.61970539e+00  2.61970539e+00
  2.61970539e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153968e+01  1.97521794e+02  1.02467566e+03  6.70195221e+03]
E1 = -182.53297305318515  E_coul = 54.24802986478411
Extra cycle  E= -128.284943188401  delta_E= -3.41e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.58854059489975
E1 = -182.53297305318515  E_coul = 54.24802986478411
init E= -128.284943188401
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786761479709977  LUMO = 2.3281562034593
  mo_energy =
[-3.27568696e+01 -1.90130267e+00 -7.86761480e-01 -7.86761480e-01
 -7.86761480e-01  2.32815620e+00  2.61970531e+00  2.61970531e+00
  2.61970531e+00  1.98056308e+01  1.98056308e+01  1.98056308e+01
  3.19153964e+01  1.97521793e+02  1.02467566e+03  6.70195221e+03]
E1 = -182.53297380121413  E_coul = 54.248030612812784
cycle= 1 E= -128.284943188401  delta_E= -3.13e-13  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53297380121413  E_coul = 54.248030612812784
  HOMO = -0.786761423647151  LUMO = 2.32815623119124
  mo_energy =
[-3.27568694e+01 -1.90130263e+00 -7.86761424e-01 -7.86761424e-01
 -7.86761424e-01  2.32815623e+00  2.61970536e+00  2.61970536e+00
  2.61970536e+00  1.98056309e+01  1.98056309e+01  1.98056309e+01
  3.19153965e+01  1.97521793e+02  1.02467566e+03  6.70195221e+03]
E1 = -182.53297351337534  E_coul = 54.248030324974195
Extra cycle  E= -128.284943188401  delta_E= 1.99e-13  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70334996e+03 1.26522564e+02 5.57026733e+02 5.23427129e-01
 3.52635060e+01 1.09211431e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
grad_E = [ 2.71359880e-13  1.45739081e-09 -4.89598375e-11 -1.46969594e-07
 -3.03310410e-09  5.88489690e-09  2.43637412e-08  6.97368527e-08
 -1.02223281e-08 -1.72465064e-08]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35012572        1
[INPUT] 0    0    [1    /1   ]  126.522568376        1
[INPUT] 0    0    [1    /1   ]  557.026756553        1
[INPUT] 0    0    [1    /1   ]  0.523427125134       1
[INPUT] 0    0    [1    /1   ]  35.2635069423        1
[INPUT] 0    0    [1    /1   ]  10.9211432467        1
[INPUT] 0    0    [1    /1   ]  1.77417179684        1
[INPUT] 1    0    [1    /1   ]  2.77541419056        1
[INPUT] 1    0    [1    /1   ]  13.3240472885        1
[INPUT] 1    0    [1    /1   ]  0.600004100619       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3501257174335, 1.0]], [0, [126.5225683756629, 1.0]], [0, [557.026756552563, 1.0]], [0, [0.5234271251335134, 1.0]], [0, [35.263506942257834, 1.0]], [0, [10.92114324665145, 1.0]], [0, [1.7741717968400725, 1.0]], [1, [2.7754141905642524, 1.0]], [1, [13.324047288534338, 1.0]], [1, [0.6000041006193759, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35012572]
bas 1, expnt(s) = [126.52256838]
bas 2, expnt(s) = [557.02675655]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350694]
bas 5, expnt(s) = [10.92114325]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404729]
bas 9, expnt(s) = [0.6000041]
CPU time:       532.87
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335013e+03 1.19939188e+03 1.26522568e+02 9.53105606e+01
 5.57026757e+02 2.89682371e+02 5.23427125e-01 1.55473793e+00
 3.52635069e+01 3.65602494e+01 1.09211432e+01 1.51780543e+01
 1.77417180e+00 3.88384400e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642158e+01 6.00004101e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901672036
cond(S) = 59.58853804703142
E1 = -183.23116389189738  E_coul = 55.00857425065411
init E= -128.222589641243
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868521893  LUMO = 2.35609989054675
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609989e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683921e+01  1.97737835e+02  1.02493354e+03  6.70224706e+03]
E1 = -182.19551639150603  E_coul = 53.91256924732042
cycle= 1 E= -128.282947144186  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.80975215918233  LUMO = 2.31035941562377
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544444e+01  1.97442704e+02  1.02458903e+03  6.70186245e+03]
E1 = -182.66675310192852  E_coul = 54.382125968775654
cycle= 2 E= -128.284627133153  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41706999e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227522167  LUMO = 2.32829941511002
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158179e+01  1.97522135e+02  1.02467587e+03  6.70195259e+03]
E1 = -182.53206688248994  E_coul = 54.24712371065135
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802478e-08 -4.16488682e-03 -4.42968103e-03  1.00859457e+00]
  HOMO = -0.786770782600649  LUMO = 2.32815463659619
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815464e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153802e+01  1.97521772e+02  1.02467567e+03  6.70195248e+03]
E1 = -182.53301190972448  E_coul = 54.24806872141177
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169391e-10  2.75257212e-04 -3.19490537e-04 -9.86197534e-02
  1.09866399e+00]
  HOMO = -0.786761863399942  LUMO = 2.32815640996379
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815641e+00  2.61970497e+00  2.61970497e+00
  2.61970497e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153967e+01  1.97521799e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.5329748013353  E_coul = 54.248031612934696
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329748013353  E_coul = 54.248031612934696
  HOMO = -0.786761385723672  LUMO = 2.32815634347555
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815634e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056310e+01  1.98056310e+01  1.98056310e+01
  3.19153975e+01  1.97521800e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.5329730545878  E_coul = 54.248029866186506
Extra cycle  E= -128.284943188401  delta_E= -6.82e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70335013e+03 1.26522568e+02 5.57026757e+02 5.23427125e-01
 3.52635069e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004101e-01]
E = -128.28494318840131
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35012572        1
[INPUT] 0    0    [1    /1   ]  126.522568376        1
[INPUT] 0    0    [1    /1   ]  557.026756553        1
[INPUT] 0    0    [1    /1   ]  0.523427125134       1
[INPUT] 0    0    [1    /1   ]  35.2635069423        1
[INPUT] 0    0    [1    /1   ]  10.9211432467        1
[INPUT] 0    0    [1    /1   ]  1.77417179684        1
[INPUT] 1    0    [1    /1   ]  2.77541419056        1
[INPUT] 1    0    [1    /1   ]  13.3240472885        1
[INPUT] 1    0    [1    /1   ]  0.600004100619       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3501257174335, 1.0]], [0, [126.5225683756629, 1.0]], [0, [557.026756552563, 1.0]], [0, [0.5234271251335134, 1.0]], [0, [35.263506942257834, 1.0]], [0, [10.92114324665145, 1.0]], [0, [1.7741717968400725, 1.0]], [1, [2.7754141905642524, 1.0]], [1, [13.324047288534338, 1.0]], [1, [0.6000041006193759, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35012572]
bas 1, expnt(s) = [126.52256838]
bas 2, expnt(s) = [557.02675655]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350694]
bas 5, expnt(s) = [10.92114325]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404729]
bas 9, expnt(s) = [0.6000041]
CPU time:       534.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335013e+03 1.19939188e+03 1.26522568e+02 9.53105606e+01
 5.57026757e+02 2.89682371e+02 5.23427125e-01 1.55473793e+00
 3.52635069e+01 3.65602494e+01 1.09211432e+01 1.51780543e+01
 1.77417180e+00 3.88384400e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642158e+01 6.00004101e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901672036
cond(S) = 59.58853804703142
E1 = -183.23116389189738  E_coul = 55.00857425065411
init E= -128.222589641243
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868521893  LUMO = 2.35609989054675
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609989e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683921e+01  1.97737835e+02  1.02493354e+03  6.70224706e+03]
E1 = -182.19551639150603  E_coul = 53.91256924732042
cycle= 1 E= -128.282947144186  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.80975215918233  LUMO = 2.31035941562377
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544444e+01  1.97442704e+02  1.02458903e+03  6.70186245e+03]
E1 = -182.66675310192852  E_coul = 54.382125968775654
cycle= 2 E= -128.284627133153  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41706999e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227522167  LUMO = 2.32829941511002
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158179e+01  1.97522135e+02  1.02467587e+03  6.70195259e+03]
E1 = -182.53206688248994  E_coul = 54.24712371065135
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802478e-08 -4.16488682e-03 -4.42968103e-03  1.00859457e+00]
  HOMO = -0.786770782600649  LUMO = 2.32815463659619
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815464e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153802e+01  1.97521772e+02  1.02467567e+03  6.70195248e+03]
E1 = -182.53301190972448  E_coul = 54.24806872141177
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169391e-10  2.75257212e-04 -3.19490537e-04 -9.86197534e-02
  1.09866399e+00]
  HOMO = -0.786761863399942  LUMO = 2.32815640996379
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815641e+00  2.61970497e+00  2.61970497e+00
  2.61970497e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153967e+01  1.97521799e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.5329748013353  E_coul = 54.248031612934696
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329748013353  E_coul = 54.248031612934696
  HOMO = -0.786761385723672  LUMO = 2.32815634347555
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815634e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056310e+01  1.98056310e+01  1.98056310e+01
  3.19153975e+01  1.97521800e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.5329730545878  E_coul = 54.248029866186506
Extra cycle  E= -128.284943188401  delta_E= -6.82e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.58853804703142
E1 = -182.5329730545878  E_coul = 54.248029866186506
init E= -128.284943188401
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786761479750796  LUMO = 2.32815618593248
  mo_energy =
[-3.27568696e+01 -1.90130267e+00 -7.86761480e-01 -7.86761480e-01
 -7.86761480e-01  2.32815619e+00  2.61970531e+00  2.61970531e+00
  2.61970531e+00  1.98056308e+01  1.98056308e+01  1.98056308e+01
  3.19153971e+01  1.97521800e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.53297380261694  E_coul = 54.2480306142155
cycle= 1 E= -128.284943188401  delta_E= -1.14e-13  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53297380261694  E_coul = 54.2480306142155
  HOMO = -0.786761423687953  LUMO = 2.32815621366446
  mo_energy =
[-3.27568694e+01 -1.90130263e+00 -7.86761424e-01 -7.86761424e-01
 -7.86761424e-01  2.32815621e+00  2.61970536e+00  2.61970536e+00
  2.61970536e+00  1.98056309e+01  1.98056309e+01  1.98056309e+01
  3.19153972e+01  1.97521800e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.53297351477818  E_coul = 54.24803032637678
Extra cycle  E= -128.284943188401  delta_E= 2.84e-14  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70335013e+03 1.26522568e+02 5.57026757e+02 5.23427125e-01
 3.52635069e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004101e-01]
grad_E = [ 2.79671848e-13  1.51833382e-09 -4.93638511e-11 -1.55279910e-07
 -3.12508952e-09  6.14322304e-09  2.56335557e-08  7.35563788e-08
 -1.08785927e-08 -1.74352124e-08]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:42 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35012572        1
[INPUT] 0    0    [1    /1   ]  126.522568376        1
[INPUT] 0    0    [1    /1   ]  557.026756553        1
[INPUT] 0    0    [1    /1   ]  0.523427125134       1
[INPUT] 0    0    [1    /1   ]  35.2635069423        1
[INPUT] 0    0    [1    /1   ]  10.9211432467        1
[INPUT] 0    0    [1    /1   ]  1.77417179684        1
[INPUT] 1    0    [1    /1   ]  2.77541419056        1
[INPUT] 1    0    [1    /1   ]  13.3240472885        1
[INPUT] 1    0    [1    /1   ]  0.600004100619       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3501257173966, 1.0]], [0, [126.52256837566185, 1.0]], [0, [557.0267565525576, 1.0]], [0, [0.5234271251335143, 1.0]], [0, [35.263506942257635, 1.0]], [0, [10.921143246651413, 1.0]], [0, [1.7741717968400736, 1.0]], [1, [2.7754141905642515, 1.0]], [1, [13.324047288534345, 1.0]], [1, [0.6000041006193757, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35012572]
bas 1, expnt(s) = [126.52256838]
bas 2, expnt(s) = [557.02675655]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350694]
bas 5, expnt(s) = [10.92114325]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404729]
bas 9, expnt(s) = [0.6000041]
CPU time:       538.10
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335013e+03 1.19939188e+03 1.26522568e+02 9.53105606e+01
 5.57026757e+02 2.89682371e+02 5.23427125e-01 1.55473793e+00
 3.52635069e+01 3.65602494e+01 1.09211432e+01 1.51780543e+01
 1.77417180e+00 3.88384400e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642158e+01 6.00004101e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901672038
cond(S) = 59.58853804703182
E1 = -183.23116389189744  E_coul = 55.00857425065414
init E= -128.222589641243
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868521882  LUMO = 2.35609989054684
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609989e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683921e+01  1.97737835e+02  1.02493354e+03  6.70224706e+03]
E1 = -182.1955163915061  E_coul = 53.91256924732034
cycle= 1 E= -128.282947144186  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182327  LUMO = 2.31035941562377
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544444e+01  1.97442704e+02  1.02458903e+03  6.70186245e+03]
E1 = -182.6667531019284  E_coul = 54.38212596877551
cycle= 2 E= -128.284627133153  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41706999e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227522201  LUMO = 2.32829941511004
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158179e+01  1.97522135e+02  1.02467587e+03  6.70195259e+03]
E1 = -182.5320668824899  E_coul = 54.247123710651366
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802475e-08 -4.16488685e-03 -4.42968112e-03  1.00859457e+00]
  HOMO = -0.786770782600639  LUMO = 2.32815463659623
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815464e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153802e+01  1.97521772e+02  1.02467567e+03  6.70195248e+03]
E1 = -182.5330119097245  E_coul = 54.24806872141159
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169376e-10  2.75257316e-04 -3.19490328e-04 -9.86197621e-02
  1.09866400e+00]
  HOMO = -0.786761863399839  LUMO = 2.32815640996381
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815641e+00  2.61970497e+00  2.61970497e+00
  2.61970497e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153967e+01  1.97521799e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.53297480133517  E_coul = 54.2480316129344
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297480133517  E_coul = 54.2480316129344
  HOMO = -0.786761385723692  LUMO = 2.3281563434755
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815634e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056310e+01  1.98056310e+01  1.98056310e+01
  3.19153975e+01  1.97521800e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.53297305458813  E_coul = 54.24802986618675
Extra cycle  E= -128.284943188401  delta_E= -5.97e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70335013e+03 1.26522568e+02 5.57026757e+02 5.23427125e-01
 3.52635069e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004101e-01]
E = -128.28494318840137
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:43 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35012572        1
[INPUT] 0    0    [1    /1   ]  126.522568376        1
[INPUT] 0    0    [1    /1   ]  557.026756553        1
[INPUT] 0    0    [1    /1   ]  0.523427125134       1
[INPUT] 0    0    [1    /1   ]  35.2635069423        1
[INPUT] 0    0    [1    /1   ]  10.9211432467        1
[INPUT] 0    0    [1    /1   ]  1.77417179684        1
[INPUT] 1    0    [1    /1   ]  2.77541419056        1
[INPUT] 1    0    [1    /1   ]  13.3240472885        1
[INPUT] 1    0    [1    /1   ]  0.600004100619       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3501257173966, 1.0]], [0, [126.52256837566185, 1.0]], [0, [557.0267565525576, 1.0]], [0, [0.5234271251335143, 1.0]], [0, [35.263506942257635, 1.0]], [0, [10.921143246651413, 1.0]], [0, [1.7741717968400736, 1.0]], [1, [2.7754141905642515, 1.0]], [1, [13.324047288534345, 1.0]], [1, [0.6000041006193757, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35012572]
bas 1, expnt(s) = [126.52256838]
bas 2, expnt(s) = [557.02675655]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350694]
bas 5, expnt(s) = [10.92114325]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404729]
bas 9, expnt(s) = [0.6000041]
CPU time:       539.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335013e+03 1.19939188e+03 1.26522568e+02 9.53105606e+01
 5.57026757e+02 2.89682371e+02 5.23427125e-01 1.55473793e+00
 3.52635069e+01 3.65602494e+01 1.09211432e+01 1.51780543e+01
 1.77417180e+00 3.88384400e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642158e+01 6.00004101e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901672038
cond(S) = 59.58853804703182
E1 = -183.23116389189744  E_coul = 55.00857425065414
init E= -128.222589641243
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868521882  LUMO = 2.35609989054684
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609989e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683921e+01  1.97737835e+02  1.02493354e+03  6.70224706e+03]
E1 = -182.1955163915061  E_coul = 53.91256924732034
cycle= 1 E= -128.282947144186  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182327  LUMO = 2.31035941562377
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544444e+01  1.97442704e+02  1.02458903e+03  6.70186245e+03]
E1 = -182.6667531019284  E_coul = 54.38212596877551
cycle= 2 E= -128.284627133153  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41706999e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227522201  LUMO = 2.32829941511004
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158179e+01  1.97522135e+02  1.02467587e+03  6.70195259e+03]
E1 = -182.5320668824899  E_coul = 54.247123710651366
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802475e-08 -4.16488685e-03 -4.42968112e-03  1.00859457e+00]
  HOMO = -0.786770782600639  LUMO = 2.32815463659623
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815464e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153802e+01  1.97521772e+02  1.02467567e+03  6.70195248e+03]
E1 = -182.5330119097245  E_coul = 54.24806872141159
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169376e-10  2.75257316e-04 -3.19490328e-04 -9.86197621e-02
  1.09866400e+00]
  HOMO = -0.786761863399839  LUMO = 2.32815640996381
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815641e+00  2.61970497e+00  2.61970497e+00
  2.61970497e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153967e+01  1.97521799e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.53297480133517  E_coul = 54.2480316129344
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297480133517  E_coul = 54.2480316129344
  HOMO = -0.786761385723692  LUMO = 2.3281563434755
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815634e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056310e+01  1.98056310e+01  1.98056310e+01
  3.19153975e+01  1.97521800e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.53297305458813  E_coul = 54.24802986618675
Extra cycle  E= -128.284943188401  delta_E= -5.97e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.58853804703182
E1 = -182.53297305458813  E_coul = 54.24802986618675
init E= -128.284943188401
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786761479750778  LUMO = 2.32815618593256
  mo_energy =
[-3.27568696e+01 -1.90130267e+00 -7.86761480e-01 -7.86761480e-01
 -7.86761480e-01  2.32815619e+00  2.61970531e+00  2.61970531e+00
  2.61970531e+00  1.98056308e+01  1.98056308e+01  1.98056308e+01
  3.19153971e+01  1.97521800e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.53297380261657  E_coul = 54.248030614215196
cycle= 1 E= -128.284943188401  delta_E=    0  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53297380261657  E_coul = 54.248030614215196
  HOMO = -0.78676142368797  LUMO = 2.32815621366449
  mo_energy =
[-3.27568694e+01 -1.90130263e+00 -7.86761424e-01 -7.86761424e-01
 -7.86761424e-01  2.32815621e+00  2.61970536e+00  2.61970536e+00
  2.61970536e+00  1.98056309e+01  1.98056309e+01  1.98056309e+01
  3.19153972e+01  1.97521800e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.53297351477812  E_coul = 54.24803032637677
Extra cycle  E= -128.284943188401  delta_E= 2.84e-14  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70335013e+03 1.26522568e+02 5.57026757e+02 5.23427125e-01
 3.52635069e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004101e-01]
grad_E = [ 2.79671431e-13  1.51833415e-09 -4.93638450e-11 -1.55279903e-07
 -3.12509107e-09  6.14322138e-09  2.56335451e-08  7.35563823e-08
 -1.08785920e-08 -1.74352195e-08]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:47 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35004393        1
[INPUT] 0    0    [1    /1   ]  126.522566028        1
[INPUT] 0    0    [1    /1   ]  557.026744546        1
[INPUT] 0    0    [1    /1   ]  0.523427127174       1
[INPUT] 0    0    [1    /1   ]  35.263506495         1
[INPUT] 0    0    [1    /1   ]  10.9211431663        1
[INPUT] 0    0    [1    /1   ]  1.77417179968        1
[INPUT] 1    0    [1    /1   ]  2.77541418871        1
[INPUT] 1    0    [1    /1   ]  13.3240473044        1
[INPUT] 1    0    [1    /1   ]  0.600004100107       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.350043933179, 1.0]], [0, [126.52256602816935, 1.0]], [0, [557.026744545817, 1.0]], [0, [0.5234271271739698, 1.0]], [0, [35.26350649502605, 1.0]], [0, [10.921143166321942, 1.0]], [0, [1.7741717996828585, 1.0]], [1, [2.775414188711959, 1.0]], [1, [13.32404730443009, 1.0]], [1, [0.6000041001066448, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35004393]
bas 1, expnt(s) = [126.52256603]
bas 2, expnt(s) = [557.02674455]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.2635065]
bas 5, expnt(s) = [10.92114317]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.3240473]
bas 9, expnt(s) = [0.6000041]
CPU time:       543.45
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335004e+03 1.19939186e+03 1.26522566e+02 9.53105592e+01
 5.57026745e+02 2.89682367e+02 5.23427127e-01 1.55473793e+00
 3.52635065e+01 3.65602491e+01 1.09211432e+01 1.51780542e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642159e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901764593
cond(S) = 59.588539320965886
E1 = -183.23116389185407  E_coul = 55.00857425023648
init E= -128.222589641618
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868565205  LUMO = 2.35609989944255
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609990e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683917e+01  1.97737831e+02  1.02493352e+03  6.70224691e+03]
E1 = -182.19551639055723  E_coul = 53.91256924637396
cycle= 1 E= -128.282947144183  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182304  LUMO = 2.31035942435794
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544440e+01  1.97442701e+02  1.02458901e+03  6.70186230e+03]
E1 = -182.66675310131026  E_coul = 54.38212596815789
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707000e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227509381  LUMO = 2.32829942387531
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158175e+01  1.97522131e+02  1.02467585e+03  6.70195243e+03]
E1 = -182.53206688181388  E_coul = 54.24712370997536
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802572e-08 -4.16488698e-03 -4.42968175e-03  1.00859457e+00]
  HOMO = -0.786770782581647  LUMO = 2.32815464535983
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153799e+01  1.97521768e+02  1.02467565e+03  6.70195232e+03]
E1 = -182.53301190902815  E_coul = 54.24806872071542
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169435e-10  2.75257378e-04 -3.19490325e-04 -9.86197804e-02
  1.09866401e+00]
  HOMO = -0.786761863379452  LUMO = 2.32815641872731
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815642e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153963e+01  1.97521796e+02  1.02467568e+03  6.70195237e+03]
E1 = -182.5329748006337  E_coul = 54.24803161223304
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329748006337  E_coul = 54.24803161223304
  HOMO = -0.786761385703298  LUMO = 2.32815635223892
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815635e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153971e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.5329730538868  E_coul = 54.248029865485364
Extra cycle  E= -128.284943188401  delta_E= -7.67e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70335004e+03 1.26522566e+02 5.57026745e+02 5.23427127e-01
 3.52635065e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
E = -128.28494318840143
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:49 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35004393        1
[INPUT] 0    0    [1    /1   ]  126.522566028        1
[INPUT] 0    0    [1    /1   ]  557.026744546        1
[INPUT] 0    0    [1    /1   ]  0.523427127174       1
[INPUT] 0    0    [1    /1   ]  35.263506495         1
[INPUT] 0    0    [1    /1   ]  10.9211431663        1
[INPUT] 0    0    [1    /1   ]  1.77417179968        1
[INPUT] 1    0    [1    /1   ]  2.77541418871        1
[INPUT] 1    0    [1    /1   ]  13.3240473044        1
[INPUT] 1    0    [1    /1   ]  0.600004100107       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.350043933179, 1.0]], [0, [126.52256602816935, 1.0]], [0, [557.026744545817, 1.0]], [0, [0.5234271271739698, 1.0]], [0, [35.26350649502605, 1.0]], [0, [10.921143166321942, 1.0]], [0, [1.7741717996828585, 1.0]], [1, [2.775414188711959, 1.0]], [1, [13.32404730443009, 1.0]], [1, [0.6000041001066448, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35004393]
bas 1, expnt(s) = [126.52256603]
bas 2, expnt(s) = [557.02674455]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.2635065]
bas 5, expnt(s) = [10.92114317]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.3240473]
bas 9, expnt(s) = [0.6000041]
CPU time:       545.14
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335004e+03 1.19939186e+03 1.26522566e+02 9.53105592e+01
 5.57026745e+02 2.89682367e+02 5.23427127e-01 1.55473793e+00
 3.52635065e+01 3.65602491e+01 1.09211432e+01 1.51780542e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642159e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901764593
cond(S) = 59.588539320965886
E1 = -183.23116389185407  E_coul = 55.00857425023648
init E= -128.222589641618
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868565205  LUMO = 2.35609989944255
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609990e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683917e+01  1.97737831e+02  1.02493352e+03  6.70224691e+03]
E1 = -182.19551639055723  E_coul = 53.91256924637396
cycle= 1 E= -128.282947144183  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182304  LUMO = 2.31035942435794
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544440e+01  1.97442701e+02  1.02458901e+03  6.70186230e+03]
E1 = -182.66675310131026  E_coul = 54.38212596815789
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707000e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227509381  LUMO = 2.32829942387531
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158175e+01  1.97522131e+02  1.02467585e+03  6.70195243e+03]
E1 = -182.53206688181388  E_coul = 54.24712370997536
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802572e-08 -4.16488698e-03 -4.42968175e-03  1.00859457e+00]
  HOMO = -0.786770782581647  LUMO = 2.32815464535983
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153799e+01  1.97521768e+02  1.02467565e+03  6.70195232e+03]
E1 = -182.53301190902815  E_coul = 54.24806872071542
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169435e-10  2.75257378e-04 -3.19490325e-04 -9.86197804e-02
  1.09866401e+00]
  HOMO = -0.786761863379452  LUMO = 2.32815641872731
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815642e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153963e+01  1.97521796e+02  1.02467568e+03  6.70195237e+03]
E1 = -182.5329748006337  E_coul = 54.24803161223304
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329748006337  E_coul = 54.24803161223304
  HOMO = -0.786761385703298  LUMO = 2.32815635223892
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815635e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153971e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.5329730538868  E_coul = 54.248029865485364
Extra cycle  E= -128.284943188401  delta_E= -7.67e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.588539320965886
E1 = -182.5329730538868  E_coul = 54.248029865485364
init E= -128.284943188401
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786761479730378  LUMO = 2.32815619469595
  mo_energy =
[-3.27568696e+01 -1.90130267e+00 -7.86761480e-01 -7.86761480e-01
 -7.86761480e-01  2.32815619e+00  2.61970531e+00  2.61970531e+00
  2.61970531e+00  1.98056308e+01  1.98056308e+01  1.98056308e+01
  3.19153968e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.5329738019155  E_coul = 54.24803061351406
cycle= 1 E= -128.284943188401  delta_E=    0  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5329738019155  E_coul = 54.24803061351406
  HOMO = -0.786761423667555  LUMO = 2.32815622242787
  mo_energy =
[-3.27568694e+01 -1.90130263e+00 -7.86761424e-01 -7.86761424e-01
 -7.86761424e-01  2.32815622e+00  2.61970536e+00  2.61970536e+00
  2.61970536e+00  1.98056309e+01  1.98056309e+01  1.98056309e+01
  3.19153969e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.5329735140769  E_coul = 54.2480303256756
Extra cycle  E= -128.284943188401  delta_E= 1.14e-13  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70335004e+03 1.26522566e+02 5.57026745e+02 5.23427127e-01
 3.52635065e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
grad_E = [ 2.75515481e-13  1.48786217e-09 -4.91618495e-11 -1.51124734e-07
 -3.07909864e-09  6.01405803e-09  2.49986751e-08  7.16465927e-08
 -1.05504603e-08 -1.73407813e-08]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:52 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.3500433         1
[INPUT] 0    0    [1    /1   ]  126.52256601         1
[INPUT] 0    0    [1    /1   ]  557.026744452        1
[INPUT] 0    0    [1    /1   ]  0.52342712719        1
[INPUT] 0    0    [1    /1   ]  35.2635064915        1
[INPUT] 0    0    [1    /1   ]  10.9211431657        1
[INPUT] 0    0    [1    /1   ]  1.77417179971        1
[INPUT] 1    0    [1    /1   ]  2.7754141887         1
[INPUT] 1    0    [1    /1   ]  13.3240473046        1
[INPUT] 1    0    [1    /1   ]  0.600004100103       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3500432950755, 1.0]], [0, [126.52256600985353, 1.0]], [0, [557.026744452137, 1.0]], [0, [0.52342712718989, 1.0]], [0, [35.263506491536624, 1.0]], [0, [10.921143165695188, 1.0]], [0, [1.7741717997050388, 1.0]], [1, [2.775414188697507, 1.0]], [1, [13.324047304554114, 1.0]], [1, [0.6000041001026444, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.3500433]
bas 1, expnt(s) = [126.52256601]
bas 2, expnt(s) = [557.02674445]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350649]
bas 5, expnt(s) = [10.92114317]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.3240473]
bas 9, expnt(s) = [0.6000041]
CPU time:       548.64
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335004e+03 1.19939186e+03 1.26522566e+02 9.53105592e+01
 5.57026744e+02 2.89682367e+02 5.23427127e-01 1.55473793e+00
 3.52635065e+01 3.65602490e+01 1.09211432e+01 1.51780542e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642159e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901765313
cond(S) = 59.58853933090541
E1 = -183.23116389185373  E_coul = 55.00857425023324
init E= -128.22258964162
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868565539  LUMO = 2.35609989951192
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609990e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683917e+01  1.97737831e+02  1.02493352e+03  6.70224691e+03]
E1 = -182.19551639054995  E_coul = 53.9125692463666
cycle= 1 E= -128.282947144183  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182309  LUMO = 2.31035942442601
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544440e+01  1.97442701e+02  1.02458901e+03  6.70186229e+03]
E1 = -182.66675310130552  E_coul = 54.38212596815317
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707000e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227509288  LUMO = 2.32829942394372
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158175e+01  1.97522131e+02  1.02467585e+03  6.70195243e+03]
E1 = -182.53206688180873  E_coul = 54.24712370997014
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802574e-08 -4.16488693e-03 -4.42968162e-03  1.00859457e+00]
  HOMO = -0.786770782581455  LUMO = 2.3281546454283
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153799e+01  1.97521768e+02  1.02467565e+03  6.70195232e+03]
E1 = -182.53301190902275  E_coul = 54.248068720709846
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169401e-10  2.75257464e-04 -3.19490166e-04 -9.86197899e-02
  1.09866402e+00]
  HOMO = -0.786761863379195  LUMO = 2.32815641879571
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815642e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153963e+01  1.97521796e+02  1.02467568e+03  6.70195236e+03]
E1 = -182.53297480062784  E_coul = 54.24803161222727
cycle= 5 E= -128.284943188401  delta_E= -8.77e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297480062784  E_coul = 54.24803161222727
  HOMO = -0.786761385703154  LUMO = 2.32815635230731
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815635e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153971e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.53297305388125  E_coul = 54.24802986548004
Extra cycle  E= -128.284943188401  delta_E= -6.25e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.07 sec, wall time      0.07 sec
exp = [3.70335004e+03 1.26522566e+02 5.57026744e+02 5.23427127e-01
 3.52635065e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
E = -128.2849431884012
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:54 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.3500433         1
[INPUT] 0    0    [1    /1   ]  126.52256601         1
[INPUT] 0    0    [1    /1   ]  557.026744452        1
[INPUT] 0    0    [1    /1   ]  0.52342712719        1
[INPUT] 0    0    [1    /1   ]  35.2635064915        1
[INPUT] 0    0    [1    /1   ]  10.9211431657        1
[INPUT] 0    0    [1    /1   ]  1.77417179971        1
[INPUT] 1    0    [1    /1   ]  2.7754141887         1
[INPUT] 1    0    [1    /1   ]  13.3240473046        1
[INPUT] 1    0    [1    /1   ]  0.600004100103       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3500432950755, 1.0]], [0, [126.52256600985353, 1.0]], [0, [557.026744452137, 1.0]], [0, [0.52342712718989, 1.0]], [0, [35.263506491536624, 1.0]], [0, [10.921143165695188, 1.0]], [0, [1.7741717997050388, 1.0]], [1, [2.775414188697507, 1.0]], [1, [13.324047304554114, 1.0]], [1, [0.6000041001026444, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.3500433]
bas 1, expnt(s) = [126.52256601]
bas 2, expnt(s) = [557.02674445]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350649]
bas 5, expnt(s) = [10.92114317]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.3240473]
bas 9, expnt(s) = [0.6000041]
CPU time:       550.40
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335004e+03 1.19939186e+03 1.26522566e+02 9.53105592e+01
 5.57026744e+02 2.89682367e+02 5.23427127e-01 1.55473793e+00
 3.52635065e+01 3.65602490e+01 1.09211432e+01 1.51780542e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642159e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901765313
cond(S) = 59.58853933090541
E1 = -183.23116389185373  E_coul = 55.00857425023324
init E= -128.22258964162
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868565539  LUMO = 2.35609989951192
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609990e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683917e+01  1.97737831e+02  1.02493352e+03  6.70224691e+03]
E1 = -182.19551639054995  E_coul = 53.9125692463666
cycle= 1 E= -128.282947144183  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182309  LUMO = 2.31035942442601
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544440e+01  1.97442701e+02  1.02458901e+03  6.70186229e+03]
E1 = -182.66675310130552  E_coul = 54.38212596815317
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707000e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227509288  LUMO = 2.32829942394372
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158175e+01  1.97522131e+02  1.02467585e+03  6.70195243e+03]
E1 = -182.53206688180873  E_coul = 54.24712370997014
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802574e-08 -4.16488693e-03 -4.42968162e-03  1.00859457e+00]
  HOMO = -0.786770782581455  LUMO = 2.3281546454283
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153799e+01  1.97521768e+02  1.02467565e+03  6.70195232e+03]
E1 = -182.53301190902275  E_coul = 54.248068720709846
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169401e-10  2.75257464e-04 -3.19490166e-04 -9.86197899e-02
  1.09866402e+00]
  HOMO = -0.786761863379195  LUMO = 2.32815641879571
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815642e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153963e+01  1.97521796e+02  1.02467568e+03  6.70195236e+03]
E1 = -182.53297480062784  E_coul = 54.24803161222727
cycle= 5 E= -128.284943188401  delta_E= -8.77e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297480062784  E_coul = 54.24803161222727
  HOMO = -0.786761385703154  LUMO = 2.32815635230731
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815635e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153971e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.53297305388125  E_coul = 54.24802986548004
Extra cycle  E= -128.284943188401  delta_E= -6.25e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.58853933090541
E1 = -182.53297305388125  E_coul = 54.24802986548004
init E= -128.284943188401
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786761479730211  LUMO = 2.32815619476433
  mo_energy =
[-3.27568696e+01 -1.90130267e+00 -7.86761480e-01 -7.86761480e-01
 -7.86761480e-01  2.32815619e+00  2.61970531e+00  2.61970531e+00
  2.61970531e+00  1.98056308e+01  1.98056308e+01  1.98056308e+01
  3.19153968e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.53297380190975  E_coul = 54.248030613508476
cycle= 1 E= -128.284943188401  delta_E= -5.68e-14  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53297380190975  E_coul = 54.248030613508476
  HOMO = -0.786761423667406  LUMO = 2.3281562224963
  mo_energy =
[-3.27568694e+01 -1.90130263e+00 -7.86761424e-01 -7.86761424e-01
 -7.86761424e-01  2.32815622e+00  2.61970536e+00  2.61970536e+00
  2.61970536e+00  1.98056309e+01  1.98056309e+01  1.98056309e+01
  3.19153969e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.5329735140715  E_coul = 54.24803032567005
Extra cycle  E= -128.284943188401  delta_E= -1.99e-13  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.10 sec, wall time      0.10 sec
exp = [3.70335004e+03 1.26522566e+02 5.57026744e+02 5.23427127e-01
 3.52635065e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
grad_E = [ 2.75483128e-13  1.48762447e-09 -4.91602466e-11 -1.51092358e-07
 -3.07873937e-09  6.01305161e-09  2.49937315e-08  7.16318098e-08
 -1.05478999e-08 -1.73400636e-08]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:58 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35004393        1
[INPUT] 0    0    [1    /1   ]  126.522566028        1
[INPUT] 0    0    [1    /1   ]  557.026744546        1
[INPUT] 0    0    [1    /1   ]  0.523427127174       1
[INPUT] 0    0    [1    /1   ]  35.263506495         1
[INPUT] 0    0    [1    /1   ]  10.9211431663        1
[INPUT] 0    0    [1    /1   ]  1.77417179968        1
[INPUT] 1    0    [1    /1   ]  2.77541418871        1
[INPUT] 1    0    [1    /1   ]  13.3240473044        1
[INPUT] 1    0    [1    /1   ]  0.600004100107       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.35004393317, 1.0]], [0, [126.52256602816908, 1.0]], [0, [557.0267445458156, 1.0]], [0, [0.52342712717397, 1.0]], [0, [35.263506495026, 1.0]], [0, [10.921143166321933, 1.0]], [0, [1.774171799682859, 1.0]], [1, [2.775414188711959, 1.0]], [1, [13.324047304430092, 1.0]], [1, [0.6000041001066448, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35004393]
bas 1, expnt(s) = [126.52256603]
bas 2, expnt(s) = [557.02674455]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.2635065]
bas 5, expnt(s) = [10.92114317]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.3240473]
bas 9, expnt(s) = [0.6000041]
CPU time:       554.11
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335004e+03 1.19939186e+03 1.26522566e+02 9.53105592e+01
 5.57026745e+02 2.89682367e+02 5.23427127e-01 1.55473793e+00
 3.52635065e+01 3.65602491e+01 1.09211432e+01 1.51780542e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642159e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901764593
cond(S) = 59.588539320966056
E1 = -183.23116389185407  E_coul = 55.00857425023652
init E= -128.222589641618
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868565203  LUMO = 2.35609989944256
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609990e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683917e+01  1.97737831e+02  1.02493352e+03  6.70224691e+03]
E1 = -182.19551639055706  E_coul = 53.91256924637387
cycle= 1 E= -128.282947144183  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182311  LUMO = 2.3103594243579
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544440e+01  1.97442701e+02  1.02458901e+03  6.70186230e+03]
E1 = -182.6667531013103  E_coul = 54.38212596815797
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707000e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227509367  LUMO = 2.32829942387528
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158175e+01  1.97522131e+02  1.02467585e+03  6.70195243e+03]
E1 = -182.53206688181388  E_coul = 54.24712370997535
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802565e-08 -4.16488701e-03 -4.42968182e-03  1.00859457e+00]
  HOMO = -0.786770782581666  LUMO = 2.32815464535985
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153799e+01  1.97521768e+02  1.02467565e+03  6.70195232e+03]
E1 = -182.5330119090279  E_coul = 54.24806872071528
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169474e-10  2.75257265e-04 -3.19490551e-04 -9.86197726e-02
  1.09866401e+00]
  HOMO = -0.78676186337947  LUMO = 2.32815641872737
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815642e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153963e+01  1.97521796e+02  1.02467568e+03  6.70195237e+03]
E1 = -182.53297480063344  E_coul = 54.248031612232886
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297480063344  E_coul = 54.248031612232886
  HOMO = -0.786761385703308  LUMO = 2.32815635223898
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815635e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153971e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.53297305388674  E_coul = 54.248029865485364
Extra cycle  E= -128.284943188401  delta_E= -8.24e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70335004e+03 1.26522566e+02 5.57026745e+02 5.23427127e-01
 3.52635065e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
E = -128.28494318840137
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:53:59 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35004393        1
[INPUT] 0    0    [1    /1   ]  126.522566028        1
[INPUT] 0    0    [1    /1   ]  557.026744546        1
[INPUT] 0    0    [1    /1   ]  0.523427127174       1
[INPUT] 0    0    [1    /1   ]  35.263506495         1
[INPUT] 0    0    [1    /1   ]  10.9211431663        1
[INPUT] 0    0    [1    /1   ]  1.77417179968        1
[INPUT] 1    0    [1    /1   ]  2.77541418871        1
[INPUT] 1    0    [1    /1   ]  13.3240473044        1
[INPUT] 1    0    [1    /1   ]  0.600004100107       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.35004393317, 1.0]], [0, [126.52256602816908, 1.0]], [0, [557.0267445458156, 1.0]], [0, [0.52342712717397, 1.0]], [0, [35.263506495026, 1.0]], [0, [10.921143166321933, 1.0]], [0, [1.774171799682859, 1.0]], [1, [2.775414188711959, 1.0]], [1, [13.324047304430092, 1.0]], [1, [0.6000041001066448, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35004393]
bas 1, expnt(s) = [126.52256603]
bas 2, expnt(s) = [557.02674455]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.2635065]
bas 5, expnt(s) = [10.92114317]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.3240473]
bas 9, expnt(s) = [0.6000041]
CPU time:       555.91
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335004e+03 1.19939186e+03 1.26522566e+02 9.53105592e+01
 5.57026745e+02 2.89682367e+02 5.23427127e-01 1.55473793e+00
 3.52635065e+01 3.65602491e+01 1.09211432e+01 1.51780542e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642159e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901764593
cond(S) = 59.588539320966056
E1 = -183.23116389185407  E_coul = 55.00857425023652
init E= -128.222589641618
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868565203  LUMO = 2.35609989944256
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609990e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683917e+01  1.97737831e+02  1.02493352e+03  6.70224691e+03]
E1 = -182.19551639055706  E_coul = 53.91256924637387
cycle= 1 E= -128.282947144183  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182311  LUMO = 2.3103594243579
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544440e+01  1.97442701e+02  1.02458901e+03  6.70186230e+03]
E1 = -182.6667531013103  E_coul = 54.38212596815797
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707000e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227509367  LUMO = 2.32829942387528
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158175e+01  1.97522131e+02  1.02467585e+03  6.70195243e+03]
E1 = -182.53206688181388  E_coul = 54.24712370997535
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802565e-08 -4.16488701e-03 -4.42968182e-03  1.00859457e+00]
  HOMO = -0.786770782581666  LUMO = 2.32815464535985
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153799e+01  1.97521768e+02  1.02467565e+03  6.70195232e+03]
E1 = -182.5330119090279  E_coul = 54.24806872071528
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169474e-10  2.75257265e-04 -3.19490551e-04 -9.86197726e-02
  1.09866401e+00]
  HOMO = -0.78676186337947  LUMO = 2.32815641872737
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815642e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153963e+01  1.97521796e+02  1.02467568e+03  6.70195237e+03]
E1 = -182.53297480063344  E_coul = 54.248031612232886
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297480063344  E_coul = 54.248031612232886
  HOMO = -0.786761385703308  LUMO = 2.32815635223898
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815635e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153971e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.53297305388674  E_coul = 54.248029865485364
Extra cycle  E= -128.284943188401  delta_E= -8.24e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.588539320966056
E1 = -182.53297305388674  E_coul = 54.248029865485364
init E= -128.284943188401
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786761479730377  LUMO = 2.32815619469594
  mo_energy =
[-3.27568696e+01 -1.90130267e+00 -7.86761480e-01 -7.86761480e-01
 -7.86761480e-01  2.32815619e+00  2.61970531e+00  2.61970531e+00
  2.61970531e+00  1.98056308e+01  1.98056308e+01  1.98056308e+01
  3.19153968e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.53297380191543  E_coul = 54.24803061351407
cycle= 1 E= -128.284943188401  delta_E=    0  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53297380191543  E_coul = 54.24803061351407
  HOMO = -0.786761423667549  LUMO = 2.3281562224279
  mo_energy =
[-3.27568694e+01 -1.90130263e+00 -7.86761424e-01 -7.86761424e-01
 -7.86761424e-01  2.32815622e+00  2.61970536e+00  2.61970536e+00
  2.61970536e+00  1.98056309e+01  1.98056309e+01  1.98056309e+01
  3.19153969e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.5329735140767  E_coul = 54.24803032567542
Extra cycle  E= -128.284943188401  delta_E= 8.53e-14  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70335004e+03 1.26522566e+02 5.57026745e+02 5.23427127e-01
 3.52635065e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
grad_E = [ 2.75515230e-13  1.48786228e-09 -4.91618309e-11 -1.51124780e-07
 -3.07909709e-09  6.01405870e-09  2.49986751e-08  7.16465891e-08
 -1.05504592e-08 -1.73407884e-08]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:03 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35004393        1
[INPUT] 0    0    [1    /1   ]  126.522566028        1
[INPUT] 0    0    [1    /1   ]  557.026744546        1
[INPUT] 0    0    [1    /1   ]  0.523427127174       1
[INPUT] 0    0    [1    /1   ]  35.263506495         1
[INPUT] 0    0    [1    /1   ]  10.9211431663        1
[INPUT] 0    0    [1    /1   ]  1.77417179968        1
[INPUT] 1    0    [1    /1   ]  2.77541418871        1
[INPUT] 1    0    [1    /1   ]  13.3240473044        1
[INPUT] 1    0    [1    /1   ]  0.600004100107       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.350043933179, 1.0]], [0, [126.52256602816935, 1.0]], [0, [557.026744545817, 1.0]], [0, [0.5234271271739698, 1.0]], [0, [35.26350649502605, 1.0]], [0, [10.921143166321942, 1.0]], [0, [1.7741717996828585, 1.0]], [1, [2.775414188711959, 1.0]], [1, [13.32404730443009, 1.0]], [1, [0.6000041001066448, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35004393]
bas 1, expnt(s) = [126.52256603]
bas 2, expnt(s) = [557.02674455]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.2635065]
bas 5, expnt(s) = [10.92114317]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.3240473]
bas 9, expnt(s) = [0.6000041]
CPU time:       559.49
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335004e+03 1.19939186e+03 1.26522566e+02 9.53105592e+01
 5.57026745e+02 2.89682367e+02 5.23427127e-01 1.55473793e+00
 3.52635065e+01 3.65602491e+01 1.09211432e+01 1.51780542e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642159e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901764593
cond(S) = 59.588539320965886
E1 = -183.23116389185407  E_coul = 55.00857425023648
init E= -128.222589641618
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868565205  LUMO = 2.35609989944255
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609990e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683917e+01  1.97737831e+02  1.02493352e+03  6.70224691e+03]
E1 = -182.19551639055723  E_coul = 53.91256924637396
cycle= 1 E= -128.282947144183  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182304  LUMO = 2.31035942435794
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544440e+01  1.97442701e+02  1.02458901e+03  6.70186230e+03]
E1 = -182.66675310131026  E_coul = 54.38212596815789
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707000e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227509381  LUMO = 2.32829942387531
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158175e+01  1.97522131e+02  1.02467585e+03  6.70195243e+03]
E1 = -182.53206688181388  E_coul = 54.24712370997536
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802572e-08 -4.16488698e-03 -4.42968175e-03  1.00859457e+00]
  HOMO = -0.786770782581647  LUMO = 2.32815464535983
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153799e+01  1.97521768e+02  1.02467565e+03  6.70195232e+03]
E1 = -182.53301190902815  E_coul = 54.24806872071542
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169435e-10  2.75257378e-04 -3.19490325e-04 -9.86197804e-02
  1.09866401e+00]
  HOMO = -0.786761863379452  LUMO = 2.32815641872731
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815642e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153963e+01  1.97521796e+02  1.02467568e+03  6.70195237e+03]
E1 = -182.5329748006337  E_coul = 54.24803161223304
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329748006337  E_coul = 54.24803161223304
  HOMO = -0.786761385703298  LUMO = 2.32815635223892
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815635e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153971e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.5329730538868  E_coul = 54.248029865485364
Extra cycle  E= -128.284943188401  delta_E= -7.67e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.09 sec
exp = [3.70335004e+03 1.26522566e+02 5.57026745e+02 5.23427127e-01
 3.52635065e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
E = -128.28494318840143
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:05 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35004393        1
[INPUT] 0    0    [1    /1   ]  126.522566028        1
[INPUT] 0    0    [1    /1   ]  557.026744546        1
[INPUT] 0    0    [1    /1   ]  0.523427127174       1
[INPUT] 0    0    [1    /1   ]  35.263506495         1
[INPUT] 0    0    [1    /1   ]  10.9211431663        1
[INPUT] 0    0    [1    /1   ]  1.77417179968        1
[INPUT] 1    0    [1    /1   ]  2.77541418871        1
[INPUT] 1    0    [1    /1   ]  13.3240473044        1
[INPUT] 1    0    [1    /1   ]  0.600004100107       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.350043933179, 1.0]], [0, [126.52256602816935, 1.0]], [0, [557.026744545817, 1.0]], [0, [0.5234271271739698, 1.0]], [0, [35.26350649502605, 1.0]], [0, [10.921143166321942, 1.0]], [0, [1.7741717996828585, 1.0]], [1, [2.775414188711959, 1.0]], [1, [13.32404730443009, 1.0]], [1, [0.6000041001066448, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35004393]
bas 1, expnt(s) = [126.52256603]
bas 2, expnt(s) = [557.02674455]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.2635065]
bas 5, expnt(s) = [10.92114317]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.3240473]
bas 9, expnt(s) = [0.6000041]
CPU time:       561.28
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335004e+03 1.19939186e+03 1.26522566e+02 9.53105592e+01
 5.57026745e+02 2.89682367e+02 5.23427127e-01 1.55473793e+00
 3.52635065e+01 3.65602491e+01 1.09211432e+01 1.51780542e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642159e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901764593
cond(S) = 59.588539320965886
E1 = -183.23116389185407  E_coul = 55.00857425023648
init E= -128.222589641618
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868565205  LUMO = 2.35609989944255
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609990e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683917e+01  1.97737831e+02  1.02493352e+03  6.70224691e+03]
E1 = -182.19551639055723  E_coul = 53.91256924637396
cycle= 1 E= -128.282947144183  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182304  LUMO = 2.31035942435794
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544440e+01  1.97442701e+02  1.02458901e+03  6.70186230e+03]
E1 = -182.66675310131026  E_coul = 54.38212596815789
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707000e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227509381  LUMO = 2.32829942387531
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158175e+01  1.97522131e+02  1.02467585e+03  6.70195243e+03]
E1 = -182.53206688181388  E_coul = 54.24712370997536
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802572e-08 -4.16488698e-03 -4.42968175e-03  1.00859457e+00]
  HOMO = -0.786770782581647  LUMO = 2.32815464535983
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153799e+01  1.97521768e+02  1.02467565e+03  6.70195232e+03]
E1 = -182.53301190902815  E_coul = 54.24806872071542
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169435e-10  2.75257378e-04 -3.19490325e-04 -9.86197804e-02
  1.09866401e+00]
  HOMO = -0.786761863379452  LUMO = 2.32815641872731
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815642e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153963e+01  1.97521796e+02  1.02467568e+03  6.70195237e+03]
E1 = -182.5329748006337  E_coul = 54.24803161223304
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329748006337  E_coul = 54.24803161223304
  HOMO = -0.786761385703298  LUMO = 2.32815635223892
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815635e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153971e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.5329730538868  E_coul = 54.248029865485364
Extra cycle  E= -128.284943188401  delta_E= -7.67e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.588539320965886
E1 = -182.5329730538868  E_coul = 54.248029865485364
init E= -128.284943188401
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786761479730378  LUMO = 2.32815619469595
  mo_energy =
[-3.27568696e+01 -1.90130267e+00 -7.86761480e-01 -7.86761480e-01
 -7.86761480e-01  2.32815619e+00  2.61970531e+00  2.61970531e+00
  2.61970531e+00  1.98056308e+01  1.98056308e+01  1.98056308e+01
  3.19153968e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.5329738019155  E_coul = 54.24803061351406
cycle= 1 E= -128.284943188401  delta_E=    0  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5329738019155  E_coul = 54.24803061351406
  HOMO = -0.786761423667555  LUMO = 2.32815622242787
  mo_energy =
[-3.27568694e+01 -1.90130263e+00 -7.86761424e-01 -7.86761424e-01
 -7.86761424e-01  2.32815622e+00  2.61970536e+00  2.61970536e+00
  2.61970536e+00  1.98056309e+01  1.98056309e+01  1.98056309e+01
  3.19153969e+01  1.97521797e+02  1.02467569e+03  6.70195237e+03]
E1 = -182.5329735140769  E_coul = 54.2480303256756
Extra cycle  E= -128.284943188401  delta_E= 1.14e-13  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70335004e+03 1.26522566e+02 5.57026745e+02 5.23427127e-01
 3.52635065e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
grad_E = [ 2.75515481e-13  1.48786217e-09 -4.91618495e-11 -1.51124734e-07
 -3.07909864e-09  6.01405803e-09  2.49986751e-08  7.16465927e-08
 -1.05504603e-08 -1.73407813e-08]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:09 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34756353        1
[INPUT] 0    0    [1    /1   ]  126.522494832        1
[INPUT] 0    0    [1    /1   ]  557.026380398        1
[INPUT] 0    0    [1    /1   ]  0.523427189058       1
[INPUT] 0    0    [1    /1   ]  35.2634929311        1
[INPUT] 0    0    [1    /1   ]  10.92114073          1
[INPUT] 0    0    [1    /1   ]  1.7741718859         1
[INPUT] 1    0    [1    /1   ]  2.77541413253        1
[INPUT] 1    0    [1    /1   ]  13.3240477865        1
[INPUT] 1    0    [1    /1   ]  0.600004084556       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.347563533214, 1.0]], [0, [126.5224948320328, 1.0]], [0, [557.0263803983102, 1.0]], [0, [0.5234271890581065, 1.0]], [0, [35.26349293112287, 1.0]], [0, [10.921140730042383, 1.0]], [0, [1.7741718859005136, 1.0]], [1, [2.7754141325345394, 1.0]], [1, [13.324047786525629, 1.0]], [1, [0.6000040845562433, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34756353]
bas 1, expnt(s) = [126.52249483]
bas 2, expnt(s) = [557.0263804]
bas 3, expnt(s) = [0.52342719]
bas 4, expnt(s) = [35.26349293]
bas 5, expnt(s) = [10.92114073]
bas 6, expnt(s) = [1.77417189]
bas 7, expnt(s) = [2.77541413]
bas 8, expnt(s) = [13.32404779]
bas 9, expnt(s) = [0.60000408]
CPU time:       564.98
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334756e+03 1.19939126e+03 1.26522495e+02 9.53105190e+01
 5.57026380e+02 2.89682225e+02 5.23427189e-01 1.55473807e+00
 3.52634929e+01 3.65602385e+01 1.09211407e+01 1.51780517e+01
 1.77417189e+00 3.88384415e+00 2.77541413e+00 1.04506701e+01
 1.33240478e+01 7.42642192e+01 6.00004085e-01 1.54055480e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776904571685
cond(S) = 59.58857795761376
E1 = -183.23116389054215  E_coul = 55.008574237569626
init E= -128.222589652973
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976869878723  LUMO = 2.35610016923529
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976870e-01 -7.42976870e-01
 -7.42976870e-01  2.35610017e+00  2.65463312e+00  2.65463312e+00
  2.65463312e+00  1.99431155e+01  1.99431155e+01  1.99431155e+01
  3.20683811e+01  1.97737727e+02  1.02493285e+03  6.70224226e+03]
E1 = -182.19551636177601  E_coul = 53.912569217670594
cycle= 1 E= -128.282947144105  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159181546  LUMO = 2.31035968925094
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035969e+00  2.59887008e+00  2.59887008e+00
  2.59887008e+00  1.97489917e+01  1.97489917e+01  1.97489917e+01
  3.18544334e+01  1.97442597e+02  1.02458834e+03  6.70185765e+03]
E1 = -182.66675308256518  E_coul = 54.3821259494241
cycle= 2 E= -128.284627133141  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707039e-04  2.80014858e-01  7.19985142e-01]
  HOMO = -0.786586227121137  LUMO = 2.32829968971298
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829969e+00  2.61982675e+00  2.61982675e+00
  2.61982675e+00  1.98059893e+01  1.98059893e+01  1.98059893e+01
  3.19158070e+01  1.97522027e+02  1.02467518e+03  6.70194778e+03]
E1 = -182.53206686131534  E_coul = 54.247123689476695
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43805421e-08 -4.16489129e-03 -4.42970170e-03  1.00859459e+00]
  HOMO = -0.786770782006152  LUMO = 2.32815491114829
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770782e-01 -7.86770782e-01
 -7.86770782e-01  2.32815491e+00  2.61969729e+00  2.61969729e+00
  2.61969729e+00  1.98056127e+01  1.98056127e+01  1.98056127e+01
  3.19153693e+01  1.97521665e+02  1.02467498e+03  6.70194767e+03]
E1 = -182.5330118879156  E_coul = 54.24806869960269
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74431e-05
diis-c [-2.20171556e-10  2.75259325e-04 -3.19489843e-04 -9.86203155e-02
  1.09866455e+00]
  HOMO = -0.786761862760444  LUMO = 2.32815668451065
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815668e+00  2.61970488e+00  2.61970488e+00
  2.61970488e+00  1.98056305e+01  1.98056305e+01  1.98056305e+01
  3.19153858e+01  1.97521692e+02  1.02467502e+03  6.70194772e+03]
E1 = -182.53297477936258  E_coul = 54.24803159096216
cycle= 5 E= -128.2849431884  delta_E= -8.75e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297477936258  E_coul = 54.24803159096216
  HOMO = -0.786761385084711  LUMO = 2.32815661802067
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761385e-01 -7.86761385e-01
 -7.86761385e-01  2.32815662e+00  2.61970531e+00  2.61970531e+00
  2.61970531e+00  1.98056313e+01  1.98056313e+01  1.98056313e+01
  3.19153865e+01  1.97521693e+02  1.02467502e+03  6.70194772e+03]
E1 = -182.53297303262  E_coul = 54.24802984421891
Extra cycle  E= -128.284943188401  delta_E= -6.82e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70334756e+03 1.26522495e+02 5.57026380e+02 5.23427189e-01
 3.52634929e+01 1.09211407e+01 1.77417189e+00 2.77541413e+00
 1.33240478e+01 6.00004085e-01]
E = -128.2849431884011
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:10 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34970829        1
[INPUT] 0    0    [1    /1   ]  126.522556394        1
[INPUT] 0    0    [1    /1   ]  557.026695271        1
[INPUT] 0    0    [1    /1   ]  0.523427135548       1
[INPUT] 0    0    [1    /1   ]  35.2635046596        1
[INPUT] 0    0    [1    /1   ]  10.9211428367        1
[INPUT] 0    0    [1    /1   ]  1.77417181135        1
[INPUT] 1    0    [1    /1   ]  2.77541418111        1
[INPUT] 1    0    [1    /1   ]  13.3240473697        1
[INPUT] 1    0    [1    /1   ]  0.600004098002       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3497082934914, 1.0]], [0, [126.52255639413879, 1.0]], [0, [557.026695270556, 1.0]], [0, [0.5234271355479306, 1.0]], [0, [35.26350465960262, 1.0]], [0, [10.921142836652484, 1.0]], [0, [1.7741718113495524, 1.0]], [1, [2.7754141811102127, 1.0]], [1, [13.324047369665697, 1.0]], [1, [0.6000040980024149, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34970829]
bas 1, expnt(s) = [126.52255639]
bas 2, expnt(s) = [557.02669527]
bas 3, expnt(s) = [0.52342714]
bas 4, expnt(s) = [35.26350466]
bas 5, expnt(s) = [10.92114284]
bas 6, expnt(s) = [1.77417181]
bas 7, expnt(s) = [2.77541418]
bas 8, expnt(s) = [13.32404737]
bas 9, expnt(s) = [0.6000041]
CPU time:       566.79
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334971e+03 1.19939178e+03 1.26522556e+02 9.53105538e+01
 5.57026695e+02 2.89682347e+02 5.23427136e-01 1.55473795e+00
 3.52635047e+01 3.65602476e+01 1.09211428e+01 1.51780539e+01
 1.77417181e+00 3.88384402e+00 2.77541418e+00 1.04506703e+01
 1.33240474e+01 7.42642163e+01 6.00004098e-01 1.54055484e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776902144435
cond(S) = 59.58854454914803
E1 = -183.2311638916767  E_coul = 55.008574248522436
init E= -128.222589643154
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74297686874293  LUMO = 2.35609993595002
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609994e+00  2.65463319e+00  2.65463319e+00
  2.65463319e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683903e+01  1.97737817e+02  1.02493343e+03  6.70224628e+03]
E1 = -182.19551638666286  E_coul = 53.912569242489994
cycle= 1 E= -128.282947144173  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182199  LUMO = 2.31035946020237
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035946e+00  2.59887016e+00  2.59887016e+00
  2.59887016e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544426e+01  1.97442687e+02  1.02458892e+03  6.70186167e+03]
E1 = -182.66675309877385  E_coul = 54.382125965622855
cycle= 2 E= -128.284627133151  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707005e-04  2.80014855e-01  7.19985145e-01]
  HOMO = -0.786586227456852  LUMO = 2.32829945984756
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829946e+00  2.61982683e+00  2.61982683e+00
  2.61982683e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158161e+01  1.97522117e+02  1.02467576e+03  6.70195180e+03]
E1 = -182.5320668790403  E_coul = 54.24712370720164
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802955e-08 -4.16488756e-03 -4.42968443e-03  1.00859457e+00]
  HOMO = -0.786770782503785  LUMO = 2.3281546813255
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815468e+00  2.61969737e+00  2.61969737e+00
  2.61969737e+00  1.98056125e+01  1.98056125e+01  1.98056125e+01
  3.19153785e+01  1.97521754e+02  1.02467556e+03  6.70195169e+03]
E1 = -182.53301190617134  E_coul = 54.248068717858494
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169722e-10  2.75257629e-04 -3.19490301e-04 -9.86198551e-02
  1.09866409e+00]
  HOMO = -0.786761863295657  LUMO = 2.3281564546922
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815645e+00  2.61970495e+00  2.61970495e+00
  2.61970495e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153949e+01  1.97521782e+02  1.02467559e+03  6.70195174e+03]
E1 = -182.53297479775532  E_coul = 54.24803160935469
cycle= 5 E= -128.284943188401  delta_E= -8.78e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297479775532  E_coul = 54.24803160935469
  HOMO = -0.78676138561959  LUMO = 2.32815638820367
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815639e+00  2.61970538e+00  2.61970538e+00
  2.61970538e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153957e+01  1.97521783e+02  1.02467560e+03  6.70195174e+03]
E1 = -182.53297305100892  E_coul = 54.2480298626077
Extra cycle  E= -128.284943188401  delta_E= -5.97e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70334971e+03 1.26522556e+02 5.57026695e+02 5.23427136e-01
 3.52635047e+01 1.09211428e+01 1.77417181e+00 2.77541418e+00
 1.33240474e+01 6.00004098e-01]
E = -128.28494318840123
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:12 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35005913        1
[INPUT] 0    0    [1    /1   ]  126.522566464        1
[INPUT] 0    0    [1    /1   ]  557.026746777        1
[INPUT] 0    0    [1    /1   ]  0.523427126795       1
[INPUT] 0    0    [1    /1   ]  35.2635065781        1
[INPUT] 0    0    [1    /1   ]  10.9211431813        1
[INPUT] 0    0    [1    /1   ]  1.77417179915        1
[INPUT] 1    0    [1    /1   ]  2.77541418906        1
[INPUT] 1    0    [1    /1   ]  13.3240473015        1
[INPUT] 1    0    [1    /1   ]  0.600004100202       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3500591338147, 1.0]], [0, [126.52256646448065, 1.0]], [0, [557.0267467774222, 1.0]], [0, [0.5234271267947253, 1.0]], [0, [35.26350657814972, 1.0]], [0, [10.921143181252194, 1.0]], [0, [1.774171799154491, 1.0]], [1, [2.775414189056231, 1.0]], [1, [13.324047301475664, 1.0]], [1, [0.6000041002019424, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35005913]
bas 1, expnt(s) = [126.52256646]
bas 2, expnt(s) = [557.02674678]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350658]
bas 5, expnt(s) = [10.92114318]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.3240473]
bas 9, expnt(s) = [0.6000041]
CPU time:       568.62
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335006e+03 1.19939186e+03 1.26522566e+02 9.53105595e+01
 5.57026747e+02 2.89682367e+02 5.23427127e-01 1.55473793e+00
 3.52635066e+01 3.65602491e+01 1.09211432e+01 1.51780542e+01
 1.77417180e+00 3.88384400e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642159e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901747387
cond(S) = 59.58853908418869
E1 = -183.23116389186214  E_coul = 55.00857425031408
init E= -128.222589641548
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868557147  LUMO = 2.35609989778911
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609990e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683918e+01  1.97737832e+02  1.02493352e+03  6.70224694e+03]
E1 = -182.19551639073364  E_coul = 53.91256924654993
cycle= 1 E= -128.282947144184  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182307  LUMO = 2.31035942273459
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544441e+01  1.97442702e+02  1.02458901e+03  6.70186232e+03]
E1 = -182.66675310142492  E_coul = 54.382125968272575
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707000e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227511744  LUMO = 2.32829942224623
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158176e+01  1.97522132e+02  1.02467586e+03  6.70195246e+03]
E1 = -182.53206688193916  E_coul = 54.24712371010085
cycle= 3 E= -128.284943171838  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802552e-08 -4.16488698e-03 -4.42968167e-03  1.00859457e+00]
  HOMO = -0.786770782585158  LUMO = 2.32815464373099
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815464e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153800e+01  1.97521769e+02  1.02467565e+03  6.70195235e+03]
E1 = -182.5330119091576  E_coul = 54.24806872084471
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169417e-10  2.75257339e-04 -3.19490384e-04 -9.86197754e-02
  1.09866401e+00]
  HOMO = -0.786761863383261  LUMO = 2.32815641709848
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815642e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153964e+01  1.97521796e+02  1.02467569e+03  6.70195239e+03]
E1 = -182.53297480076412  E_coul = 54.248031612363526
cycle= 5 E= -128.284943188401  delta_E= -8.77e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297480076412  E_coul = 54.248031612363526
  HOMO = -0.78676138570707  LUMO = 2.32815635061017
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815635e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056310e+01  1.98056310e+01  1.98056310e+01
  3.19153972e+01  1.97521798e+02  1.02467569e+03  6.70195240e+03]
E1 = -182.53297305401688  E_coul = 54.24802986561551
Extra cycle  E= -128.284943188401  delta_E= -7.67e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70335006e+03 1.26522566e+02 5.57026747e+02 5.23427127e-01
 3.52635066e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
E = -128.28494318840137
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:14 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35005913        1
[INPUT] 0    0    [1    /1   ]  126.522566464        1
[INPUT] 0    0    [1    /1   ]  557.026746777        1
[INPUT] 0    0    [1    /1   ]  0.523427126795       1
[INPUT] 0    0    [1    /1   ]  35.2635065781        1
[INPUT] 0    0    [1    /1   ]  10.9211431813        1
[INPUT] 0    0    [1    /1   ]  1.77417179915        1
[INPUT] 1    0    [1    /1   ]  2.77541418906        1
[INPUT] 1    0    [1    /1   ]  13.3240473015        1
[INPUT] 1    0    [1    /1   ]  0.600004100202       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3500591338147, 1.0]], [0, [126.52256646448065, 1.0]], [0, [557.0267467774222, 1.0]], [0, [0.5234271267947253, 1.0]], [0, [35.26350657814972, 1.0]], [0, [10.921143181252194, 1.0]], [0, [1.774171799154491, 1.0]], [1, [2.775414189056231, 1.0]], [1, [13.324047301475664, 1.0]], [1, [0.6000041002019424, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35005913]
bas 1, expnt(s) = [126.52256646]
bas 2, expnt(s) = [557.02674678]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350658]
bas 5, expnt(s) = [10.92114318]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.3240473]
bas 9, expnt(s) = [0.6000041]
CPU time:       570.41
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335006e+03 1.19939186e+03 1.26522566e+02 9.53105595e+01
 5.57026747e+02 2.89682367e+02 5.23427127e-01 1.55473793e+00
 3.52635066e+01 3.65602491e+01 1.09211432e+01 1.51780542e+01
 1.77417180e+00 3.88384400e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642159e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901747387
cond(S) = 59.58853908418869
E1 = -183.23116389186214  E_coul = 55.00857425031408
init E= -128.222589641548
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868557147  LUMO = 2.35609989778911
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609990e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683918e+01  1.97737832e+02  1.02493352e+03  6.70224694e+03]
E1 = -182.19551639073364  E_coul = 53.91256924654993
cycle= 1 E= -128.282947144184  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182307  LUMO = 2.31035942273459
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544441e+01  1.97442702e+02  1.02458901e+03  6.70186232e+03]
E1 = -182.66675310142492  E_coul = 54.382125968272575
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707000e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227511744  LUMO = 2.32829942224623
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158176e+01  1.97522132e+02  1.02467586e+03  6.70195246e+03]
E1 = -182.53206688193916  E_coul = 54.24712371010085
cycle= 3 E= -128.284943171838  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802552e-08 -4.16488698e-03 -4.42968167e-03  1.00859457e+00]
  HOMO = -0.786770782585158  LUMO = 2.32815464373099
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815464e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153800e+01  1.97521769e+02  1.02467565e+03  6.70195235e+03]
E1 = -182.5330119091576  E_coul = 54.24806872084471
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169417e-10  2.75257339e-04 -3.19490384e-04 -9.86197754e-02
  1.09866401e+00]
  HOMO = -0.786761863383261  LUMO = 2.32815641709848
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815642e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153964e+01  1.97521796e+02  1.02467569e+03  6.70195239e+03]
E1 = -182.53297480076412  E_coul = 54.248031612363526
cycle= 5 E= -128.284943188401  delta_E= -8.77e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297480076412  E_coul = 54.248031612363526
  HOMO = -0.78676138570707  LUMO = 2.32815635061017
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815635e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056310e+01  1.98056310e+01  1.98056310e+01
  3.19153972e+01  1.97521798e+02  1.02467569e+03  6.70195240e+03]
E1 = -182.53297305401688  E_coul = 54.24802986561551
Extra cycle  E= -128.284943188401  delta_E= -7.67e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.58853908418869
E1 = -182.53297305401688  E_coul = 54.24802986561551
init E= -128.284943188401
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786761479734184  LUMO = 2.32815619306705
  mo_energy =
[-3.27568696e+01 -1.90130267e+00 -7.86761480e-01 -7.86761480e-01
 -7.86761480e-01  2.32815619e+00  2.61970531e+00  2.61970531e+00
  2.61970531e+00  1.98056308e+01  1.98056308e+01  1.98056308e+01
  3.19153968e+01  1.97521797e+02  1.02467569e+03  6.70195240e+03]
E1 = -182.5329738020458  E_coul = 54.24803061364452
cycle= 1 E= -128.284943188401  delta_E= 8.53e-14  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.5329738020458  E_coul = 54.24803061364452
  HOMO = -0.786761423671336  LUMO = 2.32815622079912
  mo_energy =
[-3.27568694e+01 -1.90130263e+00 -7.86761424e-01 -7.86761424e-01
 -7.86761424e-01  2.32815622e+00  2.61970536e+00  2.61970536e+00
  2.61970536e+00  1.98056309e+01  1.98056309e+01  1.98056309e+01
  3.19153970e+01  1.97521797e+02  1.02467569e+03  6.70195240e+03]
E1 = -182.53297351420696  E_coul = 54.24803032580569
Extra cycle  E= -128.284943188401  delta_E= 2.84e-14  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70335006e+03 1.26522566e+02 5.57026747e+02 5.23427127e-01
 3.52635066e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
grad_E = [ 2.76287805e-13  1.49352603e-09 -4.91993850e-11 -1.51897048e-07
 -3.08764481e-09  6.03806827e-09  2.51166750e-08  7.20016011e-08
 -1.06114431e-08 -1.73582251e-08]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:18 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34988371        1
[INPUT] 0    0    [1    /1   ]  126.522561429        1
[INPUT] 0    0    [1    /1   ]  557.026721024        1
[INPUT] 0    0    [1    /1   ]  0.523427131171       1
[INPUT] 0    0    [1    /1   ]  35.2635056189        1
[INPUT] 0    0    [1    /1   ]  10.921143009         1
[INPUT] 0    0    [1    /1   ]  1.77417180525        1
[INPUT] 1    0    [1    /1   ]  2.77541418508        1
[INPUT] 1    0    [1    /1   ]  13.3240473356        1
[INPUT] 1    0    [1    /1   ]  0.600004099102       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.349883713653, 1.0]], [0, [126.52256142930972, 1.0]], [0, [557.0267210239891, 1.0]], [0, [0.523427131171328, 1.0]], [0, [35.26350561887617, 1.0]], [0, [10.92114300895234, 1.0]], [0, [1.7741718052520217, 1.0]], [1, [2.775414185083222, 1.0]], [1, [13.32404733557068, 1.0]], [1, [0.6000040991021787, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34988371]
bas 1, expnt(s) = [126.52256143]
bas 2, expnt(s) = [557.02672102]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350562]
bas 5, expnt(s) = [10.92114301]
bas 6, expnt(s) = [1.77417181]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404734]
bas 9, expnt(s) = [0.6000041]
CPU time:       573.94
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334988e+03 1.19939182e+03 1.26522561e+02 9.53105566e+01
 5.57026721e+02 2.89682357e+02 5.23427131e-01 1.55473794e+00
 3.52635056e+01 3.65602484e+01 1.09211430e+01 1.51780540e+01
 1.77417181e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642161e+01 6.00004099e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901945916
cond(S) = 59.58854181666813
E1 = -183.23116389176948  E_coul = 55.00857424941831
init E= -128.222589642351
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868650045  LUMO = 2.3560999168696
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609992e+00  2.65463320e+00  2.65463320e+00
  2.65463320e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683910e+01  1.97737824e+02  1.02493348e+03  6.70224661e+03]
E1 = -182.19551638869808  E_coul = 53.91256924451998
cycle= 1 E= -128.282947144178  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182254  LUMO = 2.31035944146847
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035944e+00  2.59887016e+00  2.59887016e+00
  2.59887016e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544433e+01  1.97442694e+02  1.02458896e+03  6.70186200e+03]
E1 = -182.6667531000996  E_coul = 54.382125966947825
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707003e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227484319  LUMO = 2.32829944104688
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829944e+00  2.61982683e+00  2.61982683e+00
  2.61982683e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158168e+01  1.97522125e+02  1.02467581e+03  6.70195213e+03]
E1 = -182.53206688049016  E_coul = 54.24712370865144
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802757e-08 -4.16488724e-03 -4.42968298e-03  1.00859457e+00]
  HOMO = -0.786770782544474  LUMO = 2.32815466252825
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815466e+00  2.61969737e+00  2.61969737e+00
  2.61969737e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153792e+01  1.97521762e+02  1.02467560e+03  6.70195202e+03]
E1 = -182.53301190766445  E_coul = 54.248068719351664
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169609e-10  2.75257395e-04 -3.19490497e-04 -9.86198044e-02
  1.09866404e+00]
  HOMO = -0.786761863339554  LUMO = 2.32815643589535
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815644e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153957e+01  1.97521789e+02  1.02467564e+03  6.70195207e+03]
E1 = -182.53297479926  E_coul = 54.248031610859414
cycle= 5 E= -128.284943188401  delta_E= -8.78e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297479926  E_coul = 54.248031610859414
  HOMO = -0.786761385663313  LUMO = 2.32815636940691
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815637e+00  2.61970539e+00  2.61970539e+00
  2.61970539e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153964e+01  1.97521790e+02  1.02467564e+03  6.70195207e+03]
E1 = -182.53297305251263  E_coul = 54.248029864111516
Extra cycle  E= -128.284943188401  delta_E= -5.4e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70334988e+03 1.26522561e+02 5.57026721e+02 5.23427131e-01
 3.52635056e+01 1.09211430e+01 1.77417181e+00 2.77541419e+00
 1.33240473e+01 6.00004099e-01]
E = -128.28494318840112
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:19 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34997142        1
[INPUT] 0    0    [1    /1   ]  126.522563947        1
[INPUT] 0    0    [1    /1   ]  557.026733901        1
[INPUT] 0    0    [1    /1   ]  0.523427128983       1
[INPUT] 0    0    [1    /1   ]  35.2635060985        1
[INPUT] 0    0    [1    /1   ]  10.9211430951        1
[INPUT] 0    0    [1    /1   ]  1.7741718022         1
[INPUT] 1    0    [1    /1   ]  2.77541418707        1
[INPUT] 1    0    [1    /1   ]  13.3240473185        1
[INPUT] 1    0    [1    /1   ]  0.600004099652       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3499714237337, 1.0]], [0, [126.52256394689518, 1.0]], [0, [557.0267339007057, 1.0]], [0, [0.5234271289830266, 1.0]], [0, [35.26350609851294, 1.0]], [0, [10.921143095102266, 1.0]], [0, [1.7741718022032562, 1.0]], [1, [2.7754141870697264, 1.0]], [1, [13.324047318523172, 1.0]], [1, [0.6000040996520606, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34997142]
bas 1, expnt(s) = [126.52256395]
bas 2, expnt(s) = [557.0267339]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.2635061]
bas 5, expnt(s) = [10.9211431]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404732]
bas 9, expnt(s) = [0.6000041]
CPU time:       575.77
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334997e+03 1.19939184e+03 1.26522564e+02 9.53105581e+01
 5.57026734e+02 2.89682362e+02 5.23427129e-01 1.55473794e+00
 3.52635061e+01 3.65602487e+01 1.09211431e+01 1.51780541e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642160e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901846654
cond(S) = 59.5885404504287
E1 = -183.23116389181573  E_coul = 55.00857424986617
init E= -128.22258964195
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868603599  LUMO = 2.35609990732939
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609991e+00  2.65463320e+00  2.65463320e+00
  2.65463320e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683914e+01  1.97737828e+02  1.02493350e+03  6.70224677e+03]
E1 = -182.19551638971583  E_coul = 53.91256924553491
cycle= 1 E= -128.282947144181  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182282  LUMO = 2.31035943210154
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035943e+00  2.59887016e+00  2.59887016e+00
  2.59887016e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544437e+01  1.97442698e+02  1.02458899e+03  6.70186216e+03]
E1 = -182.6667531007624  E_coul = 54.38212596761021
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707001e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227498025  LUMO = 2.3282994316466
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829943e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158172e+01  1.97522128e+02  1.02467583e+03  6.70195230e+03]
E1 = -182.5320668812144  E_coul = 54.24712370937586
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802657e-08 -4.16488707e-03 -4.42968222e-03  1.00859457e+00]
  HOMO = -0.786770782564729  LUMO = 2.32815465312965
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153796e+01  1.97521765e+02  1.02467563e+03  6.70195219e+03]
E1 = -182.53301190841054  E_coul = 54.24806872009779
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169459e-10  2.75257486e-04 -3.19490217e-04 -9.86198018e-02
  1.09866403e+00]
  HOMO = -0.78676186336135  LUMO = 2.32815642649694
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815643e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153960e+01  1.97521793e+02  1.02467567e+03  6.70195223e+03]
E1 = -182.53297480001186  E_coul = 54.248031611611275
cycle= 5 E= -128.284943188401  delta_E= -8.78e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297480001186  E_coul = 54.248031611611275
  HOMO = -0.786761385685206  LUMO = 2.32815636000853
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815636e+00  2.61970539e+00  2.61970539e+00
  2.61970539e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153968e+01  1.97521794e+02  1.02467567e+03  6.70195223e+03]
E1 = -182.53297305326512  E_coul = 54.24802986486362
Extra cycle  E= -128.284943188402  delta_E= -9.38e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70334997e+03 1.26522564e+02 5.57026734e+02 5.23427129e-01
 3.52635061e+01 1.09211431e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
E = -128.2849431884015
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:21 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34997142        1
[INPUT] 0    0    [1    /1   ]  126.522563947        1
[INPUT] 0    0    [1    /1   ]  557.026733901        1
[INPUT] 0    0    [1    /1   ]  0.523427128983       1
[INPUT] 0    0    [1    /1   ]  35.2635060985        1
[INPUT] 0    0    [1    /1   ]  10.9211430951        1
[INPUT] 0    0    [1    /1   ]  1.7741718022         1
[INPUT] 1    0    [1    /1   ]  2.77541418707        1
[INPUT] 1    0    [1    /1   ]  13.3240473185        1
[INPUT] 1    0    [1    /1   ]  0.600004099652       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3499714237337, 1.0]], [0, [126.52256394689518, 1.0]], [0, [557.0267339007057, 1.0]], [0, [0.5234271289830266, 1.0]], [0, [35.26350609851294, 1.0]], [0, [10.921143095102266, 1.0]], [0, [1.7741718022032562, 1.0]], [1, [2.7754141870697264, 1.0]], [1, [13.324047318523172, 1.0]], [1, [0.6000040996520606, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34997142]
bas 1, expnt(s) = [126.52256395]
bas 2, expnt(s) = [557.0267339]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.2635061]
bas 5, expnt(s) = [10.9211431]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404732]
bas 9, expnt(s) = [0.6000041]
CPU time:       577.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334997e+03 1.19939184e+03 1.26522564e+02 9.53105581e+01
 5.57026734e+02 2.89682362e+02 5.23427129e-01 1.55473794e+00
 3.52635061e+01 3.65602487e+01 1.09211431e+01 1.51780541e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642160e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901846654
cond(S) = 59.5885404504287
E1 = -183.23116389181573  E_coul = 55.00857424986617
init E= -128.22258964195
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868603599  LUMO = 2.35609990732939
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609991e+00  2.65463320e+00  2.65463320e+00
  2.65463320e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683914e+01  1.97737828e+02  1.02493350e+03  6.70224677e+03]
E1 = -182.19551638971583  E_coul = 53.91256924553491
cycle= 1 E= -128.282947144181  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182282  LUMO = 2.31035943210154
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035943e+00  2.59887016e+00  2.59887016e+00
  2.59887016e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544437e+01  1.97442698e+02  1.02458899e+03  6.70186216e+03]
E1 = -182.6667531007624  E_coul = 54.38212596761021
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707001e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227498025  LUMO = 2.3282994316466
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829943e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158172e+01  1.97522128e+02  1.02467583e+03  6.70195230e+03]
E1 = -182.5320668812144  E_coul = 54.24712370937586
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802657e-08 -4.16488707e-03 -4.42968222e-03  1.00859457e+00]
  HOMO = -0.786770782564729  LUMO = 2.32815465312965
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153796e+01  1.97521765e+02  1.02467563e+03  6.70195219e+03]
E1 = -182.53301190841054  E_coul = 54.24806872009779
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169459e-10  2.75257486e-04 -3.19490217e-04 -9.86198018e-02
  1.09866403e+00]
  HOMO = -0.78676186336135  LUMO = 2.32815642649694
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815643e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153960e+01  1.97521793e+02  1.02467567e+03  6.70195223e+03]
E1 = -182.53297480001186  E_coul = 54.248031611611275
cycle= 5 E= -128.284943188401  delta_E= -8.78e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297480001186  E_coul = 54.248031611611275
  HOMO = -0.786761385685206  LUMO = 2.32815636000853
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815636e+00  2.61970539e+00  2.61970539e+00
  2.61970539e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153968e+01  1.97521794e+02  1.02467567e+03  6.70195223e+03]
E1 = -182.53297305326512  E_coul = 54.24802986486362
Extra cycle  E= -128.284943188402  delta_E= -9.38e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
Set gradient conv threshold to 3.16228e-05
cond(S) = 59.5885404504287
E1 = -182.53297305326512  E_coul = 54.24802986486362
init E= -128.284943188402
    CPU time for initialize scf      0.05 sec, wall time      0.05 sec
  HOMO = -0.786761479712285  LUMO = 2.3281562024655
  mo_energy =
[-3.27568696e+01 -1.90130267e+00 -7.86761480e-01 -7.86761480e-01
 -7.86761480e-01  2.32815620e+00  2.61970531e+00  2.61970531e+00
  2.61970531e+00  1.98056308e+01  1.98056308e+01  1.98056308e+01
  3.19153965e+01  1.97521794e+02  1.02467567e+03  6.70195223e+03]
E1 = -182.53297380129348  E_coul = 54.248030612892265
cycle= 1 E= -128.284943188401  delta_E= 3.13e-13  |g|= 1.21e-07  |ddm|= 2.92e-07
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
E1 = -182.53297380129348  E_coul = 54.248030612892265
  HOMO = -0.786761423649467  LUMO = 2.32815623019752
  mo_energy =
[-3.27568694e+01 -1.90130263e+00 -7.86761424e-01 -7.86761424e-01
 -7.86761424e-01  2.32815623e+00  2.61970536e+00  2.61970536e+00
  2.61970536e+00  1.98056309e+01  1.98056309e+01  1.98056309e+01
  3.19153966e+01  1.97521794e+02  1.02467567e+03  6.70195223e+03]
E1 = -182.532973513455  E_coul = 54.248030325053676
Extra cycle  E= -128.284943188401  delta_E= -1.14e-13  |g|= 4.29e-08  |ddm|= 4.79e-08
    CPU time for scf_cycle      0.09 sec, wall time      0.09 sec
exp = [3.70334997e+03 1.26522564e+02 5.57026734e+02 5.23427129e-01
 3.52635061e+01 1.09211431e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
grad_E = [ 2.71830596e-13  1.46084625e-09 -4.89827189e-11 -1.47440865e-07
 -3.03831971e-09  5.89954718e-09  2.44357761e-08  6.99534262e-08
 -1.02595357e-08 -1.72570438e-08]
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:25 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34992757        1
[INPUT] 0    0    [1    /1   ]  126.522562688        1
[INPUT] 0    0    [1    /1   ]  557.026727462        1
[INPUT] 0    0    [1    /1   ]  0.523427130077       1
[INPUT] 0    0    [1    /1   ]  35.2635058587        1
[INPUT] 0    0    [1    /1   ]  10.921143052         1
[INPUT] 0    0    [1    /1   ]  1.77417180373        1
[INPUT] 1    0    [1    /1   ]  2.77541418608        1
[INPUT] 1    0    [1    /1   ]  13.324047327         1
[INPUT] 1    0    [1    /1   ]  0.600004099377       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3499275686936, 1.0]], [0, [126.52256268810245, 1.0]], [0, [557.0267274623474, 1.0]], [0, [0.5234271300771772, 1.0]], [0, [35.26350585869456, 1.0]], [0, [10.921143052027304, 1.0]], [0, [1.774171803727639, 1.0]], [1, [2.7754141860764743, 1.0]], [1, [13.324047327046927, 1.0]], [1, [0.6000040993771196, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34992757]
bas 1, expnt(s) = [126.52256269]
bas 2, expnt(s) = [557.02672746]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350586]
bas 5, expnt(s) = [10.92114305]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404733]
bas 9, expnt(s) = [0.6000041]
CPU time:       581.05
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334993e+03 1.19939183e+03 1.26522563e+02 9.53105573e+01
 5.57026727e+02 2.89682360e+02 5.23427130e-01 1.55473794e+00
 3.52635059e+01 3.65602486e+01 1.09211431e+01 1.51780541e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642160e+01 6.00004099e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901896283
cond(S) = 59.58854113354841
E1 = -183.23116389179262  E_coul = 55.00857424964226
init E= -128.22258964215
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868626822  LUMO = 2.35609991209946
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609991e+00  2.65463320e+00  2.65463320e+00
  2.65463320e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683912e+01  1.97737826e+02  1.02493349e+03  6.70224669e+03]
E1 = -182.195516389207  E_coul = 53.912569245027335
cycle= 1 E= -128.28294714418  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182266  LUMO = 2.31035943678496
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035944e+00  2.59887016e+00  2.59887016e+00
  2.59887016e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544435e+01  1.97442696e+02  1.02458897e+03  6.70186208e+03]
E1 = -182.66675310043078  E_coul = 54.382125967278995
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707002e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227491207  LUMO = 2.3282994363466
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829944e+00  2.61982683e+00  2.61982683e+00
  2.61982683e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158170e+01  1.97522126e+02  1.02467582e+03  6.70195222e+03]
E1 = -182.53206688085257  E_coul = 54.24712370901402
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802710e-08 -4.16488712e-03 -4.42968252e-03  1.00859457e+00]
  HOMO = -0.786770782554693  LUMO = 2.32815465782889
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815466e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153794e+01  1.97521764e+02  1.02467562e+03  6.70195210e+03]
E1 = -182.53301190803805  E_coul = 54.24806871972521
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169521e-10  2.75257388e-04 -3.19490480e-04 -9.86198008e-02
  1.09866403e+00]
  HOMO = -0.786761863350479  LUMO = 2.32815643119611
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815643e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153958e+01  1.97521791e+02  1.02467565e+03  6.70195215e+03]
E1 = -182.5329747996361  E_coul = 54.24803161123543
cycle= 5 E= -128.284943188401  delta_E= -8.78e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329747996361  E_coul = 54.24803161123543
  HOMO = -0.786761385674251  LUMO = 2.32815636470773
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815636e+00  2.61970539e+00  2.61970539e+00
  2.61970539e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153966e+01  1.97521792e+02  1.02467565e+03  6.70195215e+03]
E1 = -182.53297305288876  E_coul = 54.24802986448754
Extra cycle  E= -128.284943188401  delta_E= -5.68e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70334993e+03 1.26522563e+02 5.57026727e+02 5.23427130e-01
 3.52635059e+01 1.09211431e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004099e-01]
E = -128.28494318840123
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:27 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.3499495         1
[INPUT] 0    0    [1    /1   ]  126.522563317        1
[INPUT] 0    0    [1    /1   ]  557.026730682        1
[INPUT] 0    0    [1    /1   ]  0.52342712953        1
[INPUT] 0    0    [1    /1   ]  35.2635059786        1
[INPUT] 0    0    [1    /1   ]  10.9211430736        1
[INPUT] 0    0    [1    /1   ]  1.77417180297        1
[INPUT] 1    0    [1    /1   ]  2.77541418657        1
[INPUT] 1    0    [1    /1   ]  13.3240473228        1
[INPUT] 1    0    [1    /1   ]  0.600004099515       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.349949496214, 1.0]], [0, [126.52256331749881, 1.0]], [0, [557.0267306815265, 1.0]], [0, [0.523427129530102, 1.0]], [0, [35.26350597860375, 1.0]], [0, [10.921143073564785, 1.0]], [0, [1.7741718029654476, 1.0]], [1, [2.7754141865731006, 1.0]], [1, [13.324047322785049, 1.0]], [1, [0.6000040995145901, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.3499495]
bas 1, expnt(s) = [126.52256332]
bas 2, expnt(s) = [557.02673068]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350598]
bas 5, expnt(s) = [10.92114307]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404732]
bas 9, expnt(s) = [0.6000041]
CPU time:       582.90
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334995e+03 1.19939184e+03 1.26522563e+02 9.53105577e+01
 5.57026731e+02 2.89682361e+02 5.23427130e-01 1.55473794e+00
 3.52635060e+01 3.65602486e+01 1.09211431e+01 1.51780541e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642160e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96677690187147
cond(S) = 59.588540791988436
E1 = -183.23116389180439  E_coul = 55.00857424975422
init E= -128.22258964205
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868615207  LUMO = 2.35609990971439
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609991e+00  2.65463320e+00  2.65463320e+00
  2.65463320e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683913e+01  1.97737827e+02  1.02493349e+03  6.70224673e+03]
E1 = -182.19551638946172  E_coul = 53.9125692452813
cycle= 1 E= -128.28294714418  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182268  LUMO = 2.31035943444328
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035943e+00  2.59887016e+00  2.59887016e+00
  2.59887016e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544436e+01  1.97442697e+02  1.02458898e+03  6.70186212e+03]
E1 = -182.66675310059662  E_coul = 54.382125967444644
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707001e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227494608  LUMO = 2.3282994339966
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829943e+00  2.61982683e+00  2.61982683e+00
  2.61982683e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158171e+01  1.97522127e+02  1.02467583e+03  6.70195226e+03]
E1 = -182.53206688103361  E_coul = 54.24712370919501
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802681e-08 -4.16488715e-03 -4.42968252e-03  1.00859457e+00]
  HOMO = -0.786770782559744  LUMO = 2.32815465547928
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815466e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153795e+01  1.97521764e+02  1.02467562e+03  6.70195214e+03]
E1 = -182.5330119082242  E_coul = 54.2480687199115
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169517e-10  2.75257563e-04 -3.19490085e-04 -9.86198111e-02
  1.09866404e+00]
  HOMO = -0.786761863355739  LUMO = 2.32815642884663
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815643e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153959e+01  1.97521792e+02  1.02467566e+03  6.70195219e+03]
E1 = -182.5329747998233  E_coul = 54.2480316114226
cycle= 5 E= -128.284943188401  delta_E= -8.8e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329747998233  E_coul = 54.2480316114226
  HOMO = -0.786761385679777  LUMO = 2.32815636235811
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815636e+00  2.61970539e+00  2.61970539e+00
  2.61970539e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153967e+01  1.97521793e+02  1.02467566e+03  6.70195219e+03]
E1 = -182.53297305307737  E_coul = 54.24802986467592
Extra cycle  E= -128.284943188401  delta_E= -7.39e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70334995e+03 1.26522563e+02 5.57026731e+02 5.23427130e-01
 3.52635060e+01 1.09211431e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
E = -128.28494318840146
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:28 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34996046        1
[INPUT] 0    0    [1    /1   ]  126.522563632        1
[INPUT] 0    0    [1    /1   ]  557.026732291        1
[INPUT] 0    0    [1    /1   ]  0.523427129257       1
[INPUT] 0    0    [1    /1   ]  35.2635060386        1
[INPUT] 0    0    [1    /1   ]  10.9211430843        1
[INPUT] 0    0    [1    /1   ]  1.77417180258        1
[INPUT] 1    0    [1    /1   ]  2.77541418682        1
[INPUT] 1    0    [1    /1   ]  13.3240473207        1
[INPUT] 1    0    [1    /1   ]  0.600004099583       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3499604599738, 1.0]], [0, [126.52256363219699, 1.0]], [0, [557.0267322911161, 1.0]], [0, [0.5234271292565642, 1.0]], [0, [35.26350603855835, 1.0]], [0, [10.921143084333526, 1.0]], [0, [1.774171802584352, 1.0]], [1, [2.7754141868214135, 1.0]], [1, [13.324047320654111, 1.0]], [1, [0.6000040995833253, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34996046]
bas 1, expnt(s) = [126.52256363]
bas 2, expnt(s) = [557.02673229]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350604]
bas 5, expnt(s) = [10.92114308]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404732]
bas 9, expnt(s) = [0.6000041]
CPU time:       584.75
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334996e+03 1.19939184e+03 1.26522564e+02 9.53105579e+01
 5.57026732e+02 2.89682362e+02 5.23427129e-01 1.55473794e+00
 3.52635060e+01 3.65602487e+01 1.09211431e+01 1.51780541e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642160e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.96677690185906
cond(S) = 59.588540621208566
E1 = -183.23116389180979  E_coul = 55.00857424981021
init E= -128.222589642
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868609409  LUMO = 2.35609990852185
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609991e+00  2.65463320e+00  2.65463320e+00
  2.65463320e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683914e+01  1.97737828e+02  1.02493350e+03  6.70224675e+03]
E1 = -182.1955163895885  E_coul = 53.91256924540802
cycle= 1 E= -128.28294714418  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182277  LUMO = 2.31035943327238
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035943e+00  2.59887016e+00  2.59887016e+00
  2.59887016e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544437e+01  1.97442698e+02  1.02458898e+03  6.70186214e+03]
E1 = -182.6667531006795  E_coul = 54.38212596752745
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707001e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227496305  LUMO = 2.3282994328216
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829943e+00  2.61982683e+00  2.61982683e+00
  2.61982683e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158172e+01  1.97522128e+02  1.02467583e+03  6.70195228e+03]
E1 = -182.53206688112374  E_coul = 54.24712370928534
cycle= 3 E= -128.284943171838  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802665e-08 -4.16488715e-03 -4.42968246e-03  1.00859457e+00]
  HOMO = -0.786770782562269  LUMO = 2.3281546543045
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153795e+01  1.97521765e+02  1.02467562e+03  6.70195217e+03]
E1 = -182.53301190831752  E_coul = 54.248068720004746
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169552e-10  2.75257406e-04 -3.19490359e-04 -9.86197926e-02
  1.09866403e+00]
  HOMO = -0.786761863358639  LUMO = 2.32815642767172
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815643e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153960e+01  1.97521792e+02  1.02467566e+03  6.70195221e+03]
E1 = -182.53297479991787  E_coul = 54.2480316115172
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297479991787  E_coul = 54.2480316115172
  HOMO = -0.786761385682474  LUMO = 2.32815636118328
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815636e+00  2.61970539e+00  2.61970539e+00
  2.61970539e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153968e+01  1.97521794e+02  1.02467566e+03  6.70195221e+03]
E1 = -182.53297305317085  E_coul = 54.248029864769684
Extra cycle  E= -128.284943188401  delta_E= -5.12e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70334996e+03 1.26522564e+02 5.57026732e+02 5.23427129e-01
 3.52635060e+01 1.09211431e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
E = -128.28494318840117
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:30 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34996594        1
[INPUT] 0    0    [1    /1   ]  126.52256379         1
[INPUT] 0    0    [1    /1   ]  557.026733096        1
[INPUT] 0    0    [1    /1   ]  0.52342712912        1
[INPUT] 0    0    [1    /1   ]  35.2635060685        1
[INPUT] 0    0    [1    /1   ]  10.9211430897        1
[INPUT] 0    0    [1    /1   ]  1.77417180239        1
[INPUT] 1    0    [1    /1   ]  2.77541418695        1
[INPUT] 1    0    [1    /1   ]  13.3240473196        1
[INPUT] 1    0    [1    /1   ]  0.600004099618       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.349965941854, 1.0]], [0, [126.52256378954608, 1.0]], [0, [557.0267330959109, 1.0]], [0, [0.5234271291197954, 1.0]], [0, [35.26350606853565, 1.0]], [0, [10.921143089717896, 1.0]], [0, [1.774171802393804, 1.0]], [1, [2.77541418694557, 1.0]], [1, [13.324047319588642, 1.0]], [1, [0.600004099617693, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34996594]
bas 1, expnt(s) = [126.52256379]
bas 2, expnt(s) = [557.0267331]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350607]
bas 5, expnt(s) = [10.92114309]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404732]
bas 9, expnt(s) = [0.6000041]
CPU time:       586.59
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334997e+03 1.19939184e+03 1.26522564e+02 9.53105580e+01
 5.57026733e+02 2.89682362e+02 5.23427129e-01 1.55473794e+00
 3.52635061e+01 3.65602487e+01 1.09211431e+01 1.51780541e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642160e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901852857
cond(S) = 59.588540535818495
E1 = -183.23116389181277  E_coul = 55.008574249838226
init E= -128.222589641975
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868606505  LUMO = 2.35609990792565
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609991e+00  2.65463320e+00  2.65463320e+00
  2.65463320e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683914e+01  1.97737828e+02  1.02493350e+03  6.70224676e+03]
E1 = -182.19551638965234  E_coul = 53.91256924547145
cycle= 1 E= -128.282947144181  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182279  LUMO = 2.31035943268696
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035943e+00  2.59887016e+00  2.59887016e+00
  2.59887016e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544437e+01  1.97442698e+02  1.02458899e+03  6.70186215e+03]
E1 = -182.6667531007208  E_coul = 54.382125967568804
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707001e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227497183  LUMO = 2.32829943223406
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829943e+00  2.61982683e+00  2.61982683e+00
  2.61982683e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158172e+01  1.97522128e+02  1.02467583e+03  6.70195229e+03]
E1 = -182.53206688116953  E_coul = 54.24712370933082
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802662e-08 -4.16488710e-03 -4.42968234e-03  1.00859457e+00]
  HOMO = -0.786770782563528  LUMO = 2.32815465371704
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153796e+01  1.97521765e+02  1.02467563e+03  6.70195218e+03]
E1 = -182.53301190836416  E_coul = 54.24806872005141
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169495e-10  2.75257465e-04 -3.19490257e-04 -9.86197998e-02
  1.09866403e+00]
  HOMO = -0.78676186335997  LUMO = 2.32815642708435
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815643e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153960e+01  1.97521793e+02  1.02467566e+03  6.70195222e+03]
E1 = -182.5329747999648  E_coul = 54.24803161156419
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329747999648  E_coul = 54.24803161156419
  HOMO = -0.786761385683846  LUMO = 2.32815636059593
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815636e+00  2.61970539e+00  2.61970539e+00
  2.61970539e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153968e+01  1.97521794e+02  1.02467567e+03  6.70195222e+03]
E1 = -182.53297305321775  E_coul = 54.24802986481658
Extra cycle  E= -128.284943188401  delta_E= -5.68e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70334997e+03 1.26522564e+02 5.57026733e+02 5.23427129e-01
 3.52635061e+01 1.09211431e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
E = -128.28494318840117
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:32 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34996868        1
[INPUT] 0    0    [1    /1   ]  126.522563868        1
[INPUT] 0    0    [1    /1   ]  557.026733498        1
[INPUT] 0    0    [1    /1   ]  0.523427129051       1
[INPUT] 0    0    [1    /1   ]  35.2635060835        1
[INPUT] 0    0    [1    /1   ]  10.9211430924        1
[INPUT] 0    0    [1    /1   ]  1.7741718023         1
[INPUT] 1    0    [1    /1   ]  2.77541418701        1
[INPUT] 1    0    [1    /1   ]  13.3240473191        1
[INPUT] 1    0    [1    /1   ]  0.600004099635       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.349968682794, 1.0]], [0, [126.52256386822063, 1.0]], [0, [557.0267334983083, 1.0]], [0, [0.523427129051411, 1.0]], [0, [35.2635060835243, 1.0]], [0, [10.921143092410082, 1.0]], [0, [1.7741718022985302, 1.0]], [1, [2.7754141870076485, 1.0]], [1, [13.324047319055907, 1.0]], [1, [0.6000040996348768, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34996868]
bas 1, expnt(s) = [126.52256387]
bas 2, expnt(s) = [557.0267335]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350608]
bas 5, expnt(s) = [10.92114309]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404732]
bas 9, expnt(s) = [0.6000041]
CPU time:       588.43
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334997e+03 1.19939184e+03 1.26522564e+02 9.53105580e+01
 5.57026733e+02 2.89682362e+02 5.23427129e-01 1.55473794e+00
 3.52635061e+01 3.65602487e+01 1.09211431e+01 1.51780541e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642160e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901849752
cond(S) = 59.58854049312365
E1 = -183.23116389181433  E_coul = 55.00857424985221
init E= -128.222589641962
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.74297686860505  LUMO = 2.35609990762751
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609991e+00  2.65463320e+00  2.65463320e+00
  2.65463320e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683914e+01  1.97737828e+02  1.02493350e+03  6.70224677e+03]
E1 = -182.19551638968403  E_coul = 53.912569245503114
cycle= 1 E= -128.282947144181  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182283  LUMO = 2.31035943239419
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035943e+00  2.59887016e+00  2.59887016e+00
  2.59887016e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544437e+01  1.97442698e+02  1.02458899e+03  6.70186215e+03]
E1 = -182.6667531007417  E_coul = 54.38212596758947
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707001e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227497594  LUMO = 2.3282994319403
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829943e+00  2.61982683e+00  2.61982683e+00
  2.61982683e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158172e+01  1.97522128e+02  1.02467583e+03  6.70195229e+03]
E1 = -182.53206688119198  E_coul = 54.24712370935336
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802657e-08 -4.16488710e-03 -4.42968232e-03  1.00859457e+00]
  HOMO = -0.786770782564178  LUMO = 2.32815465342334
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153796e+01  1.97521765e+02  1.02467563e+03  6.70195218e+03]
E1 = -182.53301190838738  E_coul = 54.24806872007479
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169494e-10  2.75257366e-04 -3.19490463e-04 -9.86197929e-02
  1.09866403e+00]
  HOMO = -0.786761863360708  LUMO = 2.32815642679062
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815643e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153960e+01  1.97521793e+02  1.02467566e+03  6.70195222e+03]
E1 = -182.53297479998855  E_coul = 54.24803161158789
cycle= 5 E= -128.284943188401  delta_E= -8.81e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297479998855  E_coul = 54.24803161158789
  HOMO = -0.786761385684512  LUMO = 2.32815636030219
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815636e+00  2.61970539e+00  2.61970539e+00
  2.61970539e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153968e+01  1.97521794e+02  1.02467567e+03  6.70195223e+03]
E1 = -182.5329730532415  E_coul = 54.24802986484017
Extra cycle  E= -128.284943188401  delta_E= -6.82e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70334997e+03 1.26522564e+02 5.57026733e+02 5.23427129e-01
 3.52635061e+01 1.09211431e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
E = -128.28494318840134
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:34 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34997005        1
[INPUT] 0    0    [1    /1   ]  126.522563908        1
[INPUT] 0    0    [1    /1   ]  557.0267337          1
[INPUT] 0    0    [1    /1   ]  0.523427129017       1
[INPUT] 0    0    [1    /1   ]  35.263506091         1
[INPUT] 0    0    [1    /1   ]  10.9211430938        1
[INPUT] 0    0    [1    /1   ]  1.77417180225        1
[INPUT] 1    0    [1    /1   ]  2.77541418704        1
[INPUT] 1    0    [1    /1   ]  13.3240473188        1
[INPUT] 1    0    [1    /1   ]  0.600004099643       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.349970053264, 1.0]], [0, [126.52256390755791, 1.0]], [0, [557.026733699507, 1.0]], [0, [0.5234271290172188, 1.0]], [0, [35.26350609101862, 1.0]], [0, [10.921143093756175, 1.0]], [0, [1.7741718022508932, 1.0]], [1, [2.7754141870386873, 1.0]], [1, [13.324047318789539, 1.0]], [1, [0.6000040996434687, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34997005]
bas 1, expnt(s) = [126.52256391]
bas 2, expnt(s) = [557.0267337]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350609]
bas 5, expnt(s) = [10.92114309]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404732]
bas 9, expnt(s) = [0.6000041]
CPU time:       590.23
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334997e+03 1.19939184e+03 1.26522564e+02 9.53105580e+01
 5.57026734e+02 2.89682362e+02 5.23427129e-01 1.55473794e+00
 3.52635061e+01 3.65602487e+01 1.09211431e+01 1.51780541e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642160e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901848203
cond(S) = 59.588540471775694
E1 = -183.23116389181502  E_coul = 55.00857424985919
init E= -128.222589641956
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868604322  LUMO = 2.35609990747846
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609991e+00  2.65463320e+00  2.65463320e+00
  2.65463320e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683914e+01  1.97737828e+02  1.02493350e+03  6.70224677e+03]
E1 = -182.19551638969983  E_coul = 53.91256924551905
cycle= 1 E= -128.282947144181  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182287  LUMO = 2.31035943224788
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035943e+00  2.59887016e+00  2.59887016e+00
  2.59887016e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544437e+01  1.97442698e+02  1.02458899e+03  6.70186216e+03]
E1 = -182.66675310075195  E_coul = 54.38212596759997
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707001e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.78658622749782  LUMO = 2.32829943179342
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829943e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158172e+01  1.97522128e+02  1.02467583e+03  6.70195230e+03]
E1 = -182.53206688120324  E_coul = 54.247123709364764
cycle= 3 E= -128.284943171838  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802657e-08 -4.16488709e-03 -4.42968227e-03  1.00859457e+00]
  HOMO = -0.786770782564463  LUMO = 2.32815465327648
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153796e+01  1.97521765e+02  1.02467563e+03  6.70195218e+03]
E1 = -182.53301190839915  E_coul = 54.24806872008632
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169519e-10  2.75257574e-04 -3.19490017e-04 -9.86198063e-02
  1.09866404e+00]
  HOMO = -0.786761863360852  LUMO = 2.32815642664382
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815643e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153960e+01  1.97521793e+02  1.02467566e+03  6.70195223e+03]
E1 = -182.53297479999944  E_coul = 54.248031611598805
cycle= 5 E= -128.284943188401  delta_E= -8.78e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297479999944  E_coul = 54.248031611598805
  HOMO = -0.786761385684916  LUMO = 2.32815636015532
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815636e+00  2.61970539e+00  2.61970539e+00
  2.61970539e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153968e+01  1.97521794e+02  1.02467567e+03  6.70195223e+03]
E1 = -182.5329730532535  E_coul = 54.24802986485222
Extra cycle  E= -128.284943188401  delta_E= -6.54e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70334997e+03 1.26522564e+02 5.57026734e+02 5.23427129e-01
 3.52635061e+01 1.09211431e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
E = -128.2849431884013
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:36 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.34997074        1
[INPUT] 0    0    [1    /1   ]  126.522563927        1
[INPUT] 0    0    [1    /1   ]  557.0267338          1
[INPUT] 0    0    [1    /1   ]  0.523427129          1
[INPUT] 0    0    [1    /1   ]  35.2635060948        1
[INPUT] 0    0    [1    /1   ]  10.9211430944        1
[INPUT] 0    0    [1    /1   ]  1.77417180223        1
[INPUT] 1    0    [1    /1   ]  2.77541418705        1
[INPUT] 1    0    [1    /1   ]  13.3240473187        1
[INPUT] 1    0    [1    /1   ]  0.600004099648       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.349970738499, 1.0]], [0, [126.52256392722654, 1.0]], [0, [557.0267338001063, 1.0]], [0, [0.5234271290001227, 1.0]], [0, [35.26350609476578, 1.0]], [0, [10.92114309442922, 1.0]], [0, [1.7741718022270747, 1.0]], [1, [2.775414187054207, 1.0]], [1, [13.324047318656357, 1.0]], [1, [0.6000040996477646, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.34997074]
bas 1, expnt(s) = [126.52256393]
bas 2, expnt(s) = [557.0267338]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350609]
bas 5, expnt(s) = [10.92114309]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404732]
bas 9, expnt(s) = [0.6000041]
CPU time:       592.04
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70334997e+03 1.19939184e+03 1.26522564e+02 9.53105580e+01
 5.57026734e+02 2.89682362e+02 5.23427129e-01 1.55473794e+00
 3.52635061e+01 3.65602487e+01 1.09211431e+01 1.51780541e+01
 1.77417180e+00 3.88384401e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642160e+01 6.00004100e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901847423
cond(S) = 59.58854046110248
E1 = -183.2311638918155  E_coul = 55.00857424986269
init E= -128.222589641953
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868603967  LUMO = 2.35609990740393
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609991e+00  2.65463320e+00  2.65463320e+00
  2.65463320e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683914e+01  1.97737828e+02  1.02493350e+03  6.70224677e+03]
E1 = -182.195516389708  E_coul = 53.91256924552702
cycle= 1 E= -128.282947144181  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182277  LUMO = 2.31035943217469
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035943e+00  2.59887016e+00  2.59887016e+00
  2.59887016e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544437e+01  1.97442698e+02  1.02458899e+03  6.70186216e+03]
E1 = -182.66675310075715  E_coul = 54.38212596760517
cycle= 2 E= -128.284627133152  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41707001e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227497977  LUMO = 2.32829943171989
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586227e-01 -7.86586227e-01
 -7.86586227e-01  2.32829943e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158172e+01  1.97522128e+02  1.02467583e+03  6.70195230e+03]
E1 = -182.53206688120943  E_coul = 54.247123709370825
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802651e-08 -4.16488714e-03 -4.42968240e-03  1.00859457e+00]
  HOMO = -0.786770782564675  LUMO = 2.32815465320306
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815465e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153796e+01  1.97521765e+02  1.02467563e+03  6.70195218e+03]
E1 = -182.53301190840523  E_coul = 54.24806872009243
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169517e-10  2.75257392e-04 -3.19490399e-04 -9.86197931e-02
  1.09866403e+00]
  HOMO = -0.786761863361218  LUMO = 2.32815642657038
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815643e+00  2.61970496e+00  2.61970496e+00
  2.61970496e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153960e+01  1.97521793e+02  1.02467566e+03  6.70195223e+03]
E1 = -182.53297480000603  E_coul = 54.24803161160552
cycle= 5 E= -128.284943188401  delta_E= -8.77e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.53297480000603  E_coul = 54.24803161160552
  HOMO = -0.786761385685018  LUMO = 2.32815636008196
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815636e+00  2.61970539e+00  2.61970539e+00
  2.61970539e+00  1.98056311e+01  1.98056311e+01  1.98056311e+01
  3.19153968e+01  1.97521794e+02  1.02467567e+03  6.70195223e+03]
E1 = -182.5329730532589  E_coul = 54.24802986485775
Extra cycle  E= -128.284943188401  delta_E= -6.25e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70334997e+03 1.26522564e+02 5.57026734e+02 5.23427129e-01
 3.52635061e+01 1.09211431e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004100e-01]
E = -128.28494318840114
  message: Desired error not necessarily achieved due to precision loss.
  success: False
   status: 2
      fun: -128.28494318840126
        x: [ 3.703e+03  1.265e+02  5.570e+02  5.234e-01  3.526e+01
             1.092e+01  1.774e+00  2.775e+00  1.332e+01  6.000e-01]
      nit: 134
      jac: [ 2.797e-13  1.519e-09 -4.937e-11 -1.553e-07 -3.125e-09
             6.144e-09  2.564e-08  7.357e-08 -1.088e-08 -1.744e-08]
 hess_inv: [[ 2.534e+08  3.221e+06 ... -1.627e+03 -2.216e+01]
            [ 3.221e+06  8.908e+04 ... -7.053e+01 -2.527e+00]
            ...
            [-1.627e+03 -7.053e+01 ...  2.319e+02  4.490e+00]
            [-2.216e+01 -2.527e+00 ...  4.490e+00  2.631e-01]]
     nfev: 160
     njev: 150
#INFO: **** input file is /Users/deyanmihaylov/Documents/Work/pyscf_basis_opt/Ne_energies.py ****
import pyscf
from pyscfad import gto, scf
import numpy as np
import re

from scipy import optimize

VERBOSITY = 9

def parse_basis_str(slug):
    numbers_and_letters = re.findall(r'[A-Za-z]+|\d+', slug)
    numbers_with_letters = [
        [int(numbers_and_letters[i]), numbers_and_letters[i+1].capitalize()]
        for i in range(0, len(numbers_and_letters), 2)
    ]
    return numbers_with_letters

def decaying_nums(n):
    return np.array([0.5 * (n - i) for i in range(n)])

def get_basis_substring(exponent, orbital):
    substring = f'''
    Ne  {orbital}
        {exponent}              1.0'''
    return substring

def get_basis_string(basis_str, exponents, exp_array=None):
    basis_set = parse_basis_str(basis_str)
    basis_nums = [num for [num, _] in basis_set]
    basis_cum_nums = np.cumsum(basis_nums)

    if exp_array is None:
        exp_array = np.zeros((exponents.size, 2))

    exp_array[np.where(exp_array[:, 1] == 0), 0] = exponents[np.where(exp_array[:, 1] == 0)]

    basis_string = ''.join([''.join([
        get_basis_substring(exp_array[i, 0], orbital) if j == 0 else
        get_basis_substring(exp_array[i + basis_cum_nums[j-1], 0], orbital)
        for i in range(num)
    ]) for j, [num, orbital] in enumerate(basis_set)])

    return basis_string

def atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}

    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    e = mf.kernel()

    print(f"exp = {exponents}")
    print(f"E = {e}")

    return e

def grad_atomic_energy(exponents, basis_str, exp_array=None):
    mol = gto.Mole()
    mol.atom = 'Ne 0 0 0'  # in Angstrom

    basis_string = get_basis_string(basis_str, exponents, exp_array)
    mol.basis = {'Ne': pyscf.gto.basis.parse(basis_string)}
    
    mol.verbose = VERBOSITY
    mol.build()

    mf = scf.RHF(mol)
    mf.kernel()
    jac = mf.energy_grad()

    print(f"exp = {exponents}")
    print(f"grad_E = {jac.exp}")

    grad_E = np.array(jac.exp)

    return grad_E

def minimize_energy(basis_str, exp_array=None):
    x0 = exp_array[:, 0]
    bnds = ((1e-9, None) for _ in range(exp_array.shape[0]))

    res = optimize.minimize(
        atomic_energy,
        x0,
        args=(basis_str, exp_array),
        method="BFGS",
        jac=grad_atomic_energy,
        hess=None,
        hessp=None,
        bounds=bnds,
        tol=1e-9,
        callback=None,
        options={"maxfev": 10000, "ftol": 1e-9},
    )
    
    print(res)
    print(f"E = {atomic_energy(res.x, basis_str)}")
    print(f"exp = [{','.join(['{:.16e}'.format(x) for x in res.x])}]")
    
basis_sets = {}
basis_sets["4s2p"] = [4.5398395053083368e+02,6.8374215800814909e+01,1.4824528322712155e+01,9.5386069633618320e-01,5.3157298879503436e+00,8.9651820980835084e-01]
basis_sets["5s2p"] = [9.4993989429303671e-01,1.2984457744638726e+03,1.9596774133621710e+02,4.4213036846502206e+01,1.1962991572315653e+01,5.3273260527405908e+00,8.9870373821517113e-01]
basis_sets["5s3p"] = [1.2953445749613716e+03,9.4582001859477927e-01,1.9549033482445452e+02,4.4096082735534537e+01,1.1909666084068769e+01,1.3328279381532866e+01,2.7778022574311008e+00,6.0258778151146430e-01]
basis_sets["6s2p"] = [1.4479024060856398e+03,6.0284375013985525e-01,2.1823060711082172e+02,4.9087193005270791e+01,1.3225669380688197e+01,2.0236207188626363e+00,5.2845084192636911e+00,8.9148787033495847e-01]
basis_sets["6s3p"] = [2.1545844455359133e+02,1.4294610280386537e+03,5.6771737890499074e-01,4.8458597305366460e+01,1.3032833613337074e+01,1.9022406562127316e+00,2.7776042679910673e+00,1.3331913307732490e+01,6.0057470745225527e-01]

basis = "7s3p"
exps = np.zeros((10, 2))
exps[1:, 0] = basis_sets["6s3p"][:]
exps[0, 0] = 4.5 * np.max(basis_sets["6s3p"][:])

minimize_energy(basis, exps)

#INFO: ******************** input file end ********************


System: uname_result(system='Darwin', node='Deyans-MacBook-Pro-Home.local', release='22.1.0', version='Darwin Kernel Version 22.1.0: Sun Oct  9 20:14:54 PDT 2022; root:xnu-8792.41.9~2/RELEASE_X86_64', machine='x86_64', processor='i386')  Threads 1
Python 3.8.16 (default, Mar  1 2023, 21:19:10) 
[Clang 14.0.6 ]
numpy 1.24.2  scipy 1.10.1
Date: Wed Mar  8 11:54:38 2023
PySCF version 2.1.1
PySCF path  /Users/deyanmihaylov/opt/anaconda3/envs/pyscfad_env/lib/python3.8/site-packages/pyscf

[CONFIG] DEBUG = False
[CONFIG] MAX_MEMORY = 4000
[CONFIG] TMPDIR = /var/folders/v7/w4c0kx6d5bq1lvxw1rnqy7br0000gp/T/
[CONFIG] UNIT = angstrom
[CONFIG] VERBOSE = 3
[CONFIG] conf_file = /Users/deyanmihaylov/.pyscf_conf.py
[CONFIG] pyscf_numpy_backend = jax
[CONFIG] pyscf_scipy_backend = jax
[CONFIG] pyscf_scipy_linalg_backend = pyscfad
[CONFIG] pyscfad = True
[CONFIG] pyscfad_ccsd_implicit_diff = True
[CONFIG] pyscfad_scf_implicit_diff = True
[INPUT] verbose = 9
[INPUT] max_memory = 4000 
[INPUT] num. atoms = 1
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 Ne     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT] ---------------- BASIS SET ---------------- 
[INPUT] l, kappa, [nprim/nctr], expnt,             c_1 c_2 ...
[INPUT] Ne
[INPUT] 0    0    [1    /1   ]  3703.35012634        1
[INPUT] 0    0    [1    /1   ]  126.522568394        1
[INPUT] 0    0    [1    /1   ]  557.026756644        1
[INPUT] 0    0    [1    /1   ]  0.523427125118       1
[INPUT] 0    0    [1    /1   ]  35.2635069457        1
[INPUT] 0    0    [1    /1   ]  10.9211432473        1
[INPUT] 0    0    [1    /1   ]  1.77417179682        1
[INPUT] 1    0    [1    /1   ]  2.77541419058        1
[INPUT] 1    0    [1    /1   ]  13.3240472884        1
[INPUT] 1    0    [1    /1   ]  0.600004100623       1

nuclear repulsion = 0
number of shells = 10
number of NR pGTOs = 16
number of NR cGTOs = 16
basis = {'Ne': [[0, [3703.3501263423127, 1.0]], [0, [126.52256839359912, 1.0]], [0, [557.0267566443015, 1.0]], [0, [0.5234271251179231, 1.0]], [0, [35.26350694567495, 1.0]], [0, [10.921143247265213, 1.0]], [0, [1.774171796818352, 1.0]], [1, [2.775414190578405, 1.0]], [1, [13.324047288412885, 1.0]], [1, [0.6000041006232935, 1.0]]]}
ecp = {}
bas 0, expnt(s) = [3703.35012634]
bas 1, expnt(s) = [126.52256839]
bas 2, expnt(s) = [557.02675664]
bas 3, expnt(s) = [0.52342713]
bas 4, expnt(s) = [35.26350695]
bas 5, expnt(s) = [10.92114325]
bas 6, expnt(s) = [1.7741718]
bas 7, expnt(s) = [2.77541419]
bas 8, expnt(s) = [13.32404729]
bas 9, expnt(s) = [0.6000041]
CPU time:       593.88
arg.atm = [[10 20  1 23  0  0]]
arg.bas = [[ 0  0  1  1  0 24 25  0]
 [ 0  0  1  1  0 26 27  0]
 [ 0  0  1  1  0 28 29  0]
 [ 0  0  1  1  0 30 31  0]
 [ 0  0  1  1  0 32 33  0]
 [ 0  0  1  1  0 34 35  0]
 [ 0  0  1  1  0 36 37  0]
 [ 0  1  1  1  0 38 39  0]
 [ 0  1  1  1  0 40 41  0]
 [ 0  1  1  1  0 42 43  0]]
arg.env = [0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 0.00000000e+00 0.00000000e+00 0.00000000e+00 0.00000000e+00
 3.70335013e+03 1.19939188e+03 1.26522568e+02 9.53105606e+01
 5.57026757e+02 2.89682371e+02 5.23427125e-01 1.55473793e+00
 3.52635069e+01 3.65602494e+01 1.09211432e+01 1.51780543e+01
 1.77417180e+00 3.88384400e+00 2.77541419e+00 1.04506703e+01
 1.33240473e+01 7.42642158e+01 6.00004101e-01 1.54055485e+00]
ecpbas  = []
Set gradient conv threshold to 3.16228e-05
Nelec from initial guess = 9.966776901671329
cond(S) = 59.58853803729759
E1 = -183.2311638918979  E_coul = 55.00857425065739
init E= -128.222589641241
    CPU time for initialize scf      0.02 sec, wall time      0.02 sec
  HOMO = -0.742976868521556  LUMO = 2.35609989047888
  mo_energy =
[-3.25549200e+01 -1.85692562e+00 -7.42976869e-01 -7.42976869e-01
 -7.42976869e-01  2.35609989e+00  2.65463321e+00  2.65463321e+00
  2.65463321e+00  1.99431153e+01  1.99431153e+01  1.99431153e+01
  3.20683921e+01  1.97737835e+02  1.02493354e+03  6.70224706e+03]
E1 = -182.19551639151365  E_coul = 53.91256924732765
cycle= 1 E= -128.282947144186  delta_E= -0.0604  |g|= 0.167  |ddm|= 0.179
    CPU time for cycle= 1      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.266769
diis-c [-0.07116555  1.        ]
  HOMO = -0.809752159182334  LUMO = 2.31035941555706
  mo_energy =
[-3.28322735e+01 -1.92505375e+00 -8.09752159e-01 -8.09752159e-01
 -8.09752159e-01  2.31035942e+00  2.59887017e+00  2.59887017e+00
  2.59887017e+00  1.97489914e+01  1.97489914e+01  1.97489914e+01
  3.18544444e+01  1.97442704e+02  1.02458903e+03  6.70186245e+03]
E1 = -182.666753101933  E_coul = 54.382125968780166
cycle= 2 E= -128.284627133153  delta_E= -0.00168  |g|= 0.0637  |ddm|= 0.0645
    CPU time for cycle= 2      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.104735
diis-c [-2.41706999e-04  2.80014854e-01  7.19985146e-01]
  HOMO = -0.786586227522259  LUMO = 2.32829941504308
  mo_energy =
[-3.27564185e+01 -1.90108473e+00 -7.86586228e-01 -7.86586228e-01
 -7.86586228e-01  2.32829942e+00  2.61982684e+00  2.61982684e+00
  2.61982684e+00  1.98059891e+01  1.98059891e+01  1.98059891e+01
  3.19158179e+01  1.97522135e+02  1.02467587e+03  6.70195259e+03]
E1 = -182.53206688249517  E_coul = 54.2471237106565
cycle= 3 E= -128.284943171839  delta_E= -0.000316  |g|= 0.000528  |ddm|= 0.0184
    CPU time for cycle= 3      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=0.000691181
diis-c [-4.43802474e-08 -4.16488683e-03 -4.42968107e-03  1.00859457e+00]
  HOMO = -0.786770782600819  LUMO = 2.3281546365292
  mo_energy =
[-3.27568928e+01 -1.90130551e+00 -7.86770783e-01 -7.86770783e-01
 -7.86770783e-01  2.32815464e+00  2.61969738e+00  2.61969738e+00
  2.61969738e+00  1.98056124e+01  1.98056124e+01  1.98056124e+01
  3.19153802e+01  1.97521772e+02  1.02467567e+03  6.70195248e+03]
E1 = -182.53301190973008  E_coul = 54.24806872141724
cycle= 4 E= -128.284943188313  delta_E= -1.65e-08  |g|= 2.88e-05  |ddm|= 0.000166
    CPU time for cycle= 4      0.01 sec, wall time      0.01 sec
diis-norm(errvec)=4.74429e-05
diis-c [-2.20169382e-10  2.75257213e-04 -3.19490535e-04 -9.86197532e-02
  1.09866399e+00]
  HOMO = -0.78676186340011  LUMO = 2.32815640989686
  mo_energy =
[-3.27568703e+01 -1.90130241e+00 -7.86761863e-01 -7.86761863e-01
 -7.86761863e-01  2.32815641e+00  2.61970497e+00  2.61970497e+00
  2.61970497e+00  1.98056302e+01  1.98056302e+01  1.98056302e+01
  3.19153967e+01  1.97521799e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.5329748013408  E_coul = 54.248031612940125
cycle= 5 E= -128.284943188401  delta_E= -8.79e-11  |g|= 2.19e-06  |ddm|= 1.25e-05
    CPU time for cycle= 5      0.01 sec, wall time      0.01 sec
E1 = -182.5329748013408  E_coul = 54.248031612940125
  HOMO = -0.786761385723822  LUMO = 2.3281563434086
  mo_energy =
[-3.27568692e+01 -1.90130247e+00 -7.86761386e-01 -7.86761386e-01
 -7.86761386e-01  2.32815634e+00  2.61970540e+00  2.61970540e+00
  2.61970540e+00  1.98056310e+01  1.98056310e+01  1.98056310e+01
  3.19153975e+01  1.97521800e+02  1.02467571e+03  6.70195252e+03]
E1 = -182.53297305459304  E_coul = 54.248029866191786
Extra cycle  E= -128.284943188401  delta_E= -5.68e-13  |g|= 4.93e-07  |ddm|= 1.23e-06
    CPU time for scf_cycle      0.08 sec, wall time      0.08 sec
exp = [3.70335013e+03 1.26522568e+02 5.57026757e+02 5.23427125e-01
 3.52635069e+01 1.09211432e+01 1.77417180e+00 2.77541419e+00
 1.33240473e+01 6.00004101e-01]
E = -128.28494318840126
E = -128.28494318840126
exp = [3.7033501263423127e+03,1.2652256839359912e+02,5.5702675664430149e+02,5.2342712511792311e-01,3.5263506945674948e+01,1.0921143247265213e+01,1.7741717968183519e+00,2.7754141905784051e+00,1.3324047288412885e+01,6.0000410062329346e-01]
